<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.92.2">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E7%94%A8%E6%88%B7%E7%B3%BB%E7%BB%9F/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>用户认证 | infilos.com</title><meta property="og:title" content="用户认证">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E7%94%A8%E6%88%B7%E7%B3%BB%E7%BB%9F/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="用户认证">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="用户认证">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E7%94%A8%E6%88%B7%E7%B3%BB%E7%BB%9F/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>用户认证</h1>
<ul>
<li>1: <a href=#pg-8d3ba1e33da079cead82e764af80ae6d>认证方法</a></li>
<li>2: <a href=#pg-efcbd19b995731f9bc6c49c40442a460>Token 多平台认证</a></li>
</ul>
<div class=content>
<h2 id=working-in-progress>Working In Progress</h2>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/tumblr_o68i2aVvlE1s9f4joo1_500.gif style=display:block;width:70% alt=NAME align=center>
</div>
</div>
</div>
<div class=td-content>
<h1 id=pg-8d3ba1e33da079cead82e764af80ae6d>1 - 认证方法</h1>
<div class="pageinfo pageinfo-primary">
<p><a href=https://www.infoq.cn/article/xeirmzbscwxjoyc3hflv>原文连接：https://www.infoq.cn/article/xeirmzbscwxjoyc3hflv</a></p>
</div>
<h2 id=身份验证与授权>身份验证与授权</h2>
<p>身份验证（Authentication）是具备权限的系统验证尝试访问系统的用户或设备所用凭据的过程。相比之下，授权（Authorization）是给定系统验证是否允许用户或设备在系统上执行某些任务的过程。</p>
<p>简单地说：</p>
<ol>
<li>身份验证：你是谁？</li>
<li>授权：你能做什么？</li>
</ol>
<p>身份验证先于授权。也就是说，用户必须先处于合法状态，然后才能根据其授权级别被授予对资源的访问权限。验证用户身份的最常见方法是用户名和密码的组合。用户通过身份验证后，系统将为他们分配不同的角色，例如管理员、主持人等，从而为他们授予一些特殊的系统权限。</p>
<p>接下来，我们来看一下用于用户身份验证的各种方法。</p>
<h2 id=http-基本验证>HTTP 基本验证</h2>
<p>HTTP 协议中内置的基本身份验证（Basic auth）是最基本的身份验证形式。使用它时，登录凭据随每个请求一起发送到请求标头中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&#34;Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=&#34; your-website.com
</code></pre></div><p>这里的用户名和密码未加密，而是使用一个<code>:</code>符号将用户名和密码串联在一起，形成单个字符串：<code>username:password</code>，再使用 base64 编码这个字符串。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&gt;&gt;&gt; import base64
&gt;&gt;&gt;
&gt;&gt;&gt; auth = &#34;username:password&#34;
&gt;&gt;&gt; auth_bytes = auth.encode(&#39;ascii&#39;) # convert to bytes
&gt;&gt;&gt; auth_bytes
b&#39;username:password&#39;
&gt;&gt;&gt;
&gt;&gt;&gt; encoded = base64.b64encode(auth_bytes) # base64 encode
&gt;&gt;&gt; encoded
b&#39;dXNlcm5hbWU6cGFzc3dvcmQ=&#39;
&gt;&gt;&gt; base64.b64decode(encoded) # base64 decode
b&#39;username:password&#39;
</code></pre></div><p>这种方法是无状态的，因此客户端必须为每个请求提供凭据。它适用于 API 调用以及不需要持久会话的简单身份验证工作流。</p>
<h3 id=流程>流程</h3>
<ol>
<li>未经身份验证的客户端请求受限制的资源</li>
<li>返回的 HTTP401Unauthorized 带有标头<code>WWW-Authenticate</code>，其值为 Basic。</li>
<li><code>WWW-Authenticate:Basic</code>标头使浏览器显示用户名和密码输入框</li>
<li>输入你的凭据后，它们随每个请求一起发送到标头中：<code>Authorization: Basic dcdvcmQ=</code></li>
</ol>
<div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220214215049.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220214215049></div>
<h3 id=优点>优点</h3>
<ul>
<li>由于执行的操作不多，因此使用该方法可以快速完成身份验证。</li>
<li>易于实现。</li>
<li>所有主要浏览器均支持。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>Base64 不是加密。这只是表示数据的另一种方式。由于 base64 编码的字符串以纯文本格式发送，因此可以轻松解码。这么差的安全性很容易招致多种类型的攻击。因此，HTTPS/SSL 是绝对必要的。</li>
<li>凭据必须随每个请求一起发送。</li>
<li>只能使用无效的凭据重写凭据来注销用户。</li>
</ul>
<h3 id=代码>代码</h3>
<p>使用 Flask-HTTP 包，可以轻松地在 Flask 中完成基本的 HTTP 身份验证。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Flask</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask_httpauth</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>HTTPBasicAuth</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>werkzeug.security</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>generate_password_hash</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>check_password_hash</span>

<span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__name__</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>auth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HTTPBasicAuth</span><span style=color:#000;font-weight:700>()</span>

<span style=color:#000>users</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>generate_password_hash</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#000;font-weight:700>),</span>
<span style=color:#000;font-weight:700>}</span>


<span style=color:#5c35cc;font-weight:700>@auth</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>verify_password</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>verify_password</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>password</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>username</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>users</span> <span style=color:#204a87;font-weight:700>and</span> <span style=color:#000>check_password_hash</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>password</span><span style=color:#000;font-weight:700>):</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>username</span>


<span style=color:#5c35cc;font-weight:700>@app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@auth</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>login_required</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>index</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;You have successfully logged in, </span><span style=color:#4e9a06>{</span><span style=color:#000>auth</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>current_user</span><span style=color:#000;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>


<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h2 id=http-摘要验证>HTTP 摘要验证</h2>
<p>HTTP Digest Auth（或 Digest Access Auth）是 HTTP 基本验证的一种更安全的形式。主要区别在于 HTTP 摘要验证的密码是以 MD5 哈希形式代替纯文本形式发送的，因此它比基本身份验证更安全。</p>
<h3 id=流程-1>流程</h3>
<ol>
<li>未经身份验证的客户端请求受限制的资源</li>
<li>服务器生成一个随机值（称为随机数，nonce），并发回一个 HTTP 401 未验证状态，带有一个<code>WWW-Authenticate</code>标头（其值为<code>Digest</code>）以及随机数：<code>WWW-Authenticate:Digestnonce="44f0437004157342f50f935906ad46fc"</code></li>
<li><code>WWW-Authenticate:Basic</code>标头使浏览器显示用户名和密码输入框</li>
<li>输入你的凭据后，系统将对密码进行哈希处理，然后与每个请求的随机数一起在标头中发送：<code>Authorization: Digest username="username",</code> <code>nonce="16e30069e45a7f47b4e2606aeeb7ab62", response="89549b93e13d438cd0946c6d93321c52"</code></li>
<li>服务器使用用户名获取密码，将其与随机数一起哈希，然后验证哈希是否相同</li>
</ol>
<div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220214215134.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220214215134></div>
<h3 id=优点-1>优点</h3>
<ul>
<li>由于密码不是以纯文本形式发送的，因此比基本身份验证更安全。</li>
<li>易于实现。</li>
<li>所有主要浏览器均支持。</li>
</ul>
<h3 id=缺点-1>缺点</h3>
<ul>
<li>凭据必须随每个请求一起发送。</li>
<li>只能使用无效的凭据重写凭据来注销用户。</li>
<li>与基本身份验证相比，由于无法使用 bcrypt，因此密码在服务器上的安全性较低。</li>
<li>容易受到中间人攻击。</li>
</ul>
<h3 id=代码-1>代码</h3>
<p>Flask-HTTP 包也支持摘要 HTTP 验证。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Flask</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask_httpauth</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>HTTPDigestAuth</span>

<span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__name__</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;SECRET_KEY&#34;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;change me&#34;</span>
<span style=color:#000>auth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HTTPDigestAuth</span><span style=color:#000;font-weight:700>()</span>

<span style=color:#000>users</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;password&#34;</span>
<span style=color:#000;font-weight:700>}</span>


<span style=color:#5c35cc;font-weight:700>@auth</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_password</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get_user</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>username</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>users</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#000;font-weight:700>)</span>


<span style=color:#5c35cc;font-weight:700>@app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@auth</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>login_required</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>index</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;You have successfully logged in, </span><span style=color:#4e9a06>{</span><span style=color:#000>auth</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>current_user</span><span style=color:#000;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>


<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h2 id=基于会话的验证>基于会话的验证</h2>
<p>使用基于会话的身份验证（或称会话 cookie 验证、基于 cookie 的验证）时，用户状态存储在服务器上。它不需要用户在每个请求中提供用户名或密码，而是在登录后由服务器验证凭据。如果凭据有效，它将生成一个会话，并将其存储在一个会话存储中，然后将其会话 ID 发送回浏览器。浏览器将这个会话 ID 存储为 cookie，该 cookie 可以在向服务器发出请求时随时发送。</p>
<p>基于会话的身份验证是有状态的。每次客户端请求服务器时，服务器必须将会话放在内存中，以便将会话 ID 绑定到关联的用户。</p>
<h3 id=流程-2>流程</h3>
<div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220214215255.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220214215255></div>
<h3 id=优点-2>优点</h3>
<ul>
<li>后续登录速度更快，因为不需要凭据。</li>
<li>改善用户体验。</li>
<li>相当容易实现。许多框架（例如 Django）都是开箱即用的。</li>
</ul>
<h3 id=缺点-2>缺点</h3>
<ul>
<li>它是有状态的。服务器要在服务端跟踪每个会话。用于存储用户会话信息的会话存储需要在多个服务之间共享以启用身份验证。因此，由于 REST 是无状态协议，它不适用于 RESTful 服务。</li>
<li>即使不需要验证，Cookie 也会随每个请求一起发送</li>
<li>易受 CSRF 攻击。在<a href=https://testdriven.io/blog/csrf-flask/>这里</a>阅读更多关于 CSRF 以及如何在 Flask 中防御它的信息。</li>
</ul>
<h3 id=代码-2>代码</h3>
<p>Flask-Login 非常适合基于会话的身份验证。这个包负责登录和注销，并可以在一段时间内记住用户。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>request</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask_login</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
    <span style=color:#000>LoginManager</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>UserMixin</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>current_user</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>login_required</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>login_user</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>werkzeug.security</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>generate_password_hash</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>check_password_hash</span>


<span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__name__</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>update</span><span style=color:#000;font-weight:700>(</span>
    <span style=color:#000>SECRET_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;change_this_key&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#000>login_manager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoginManager</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000>login_manager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>init_app</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>app</span><span style=color:#000;font-weight:700>)</span>


<span style=color:#000>users</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>generate_password_hash</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#000;font-weight:700>),</span>
<span style=color:#000;font-weight:700>}</span>


<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>UserMixin</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#ce5c00;font-weight:700>...</span>


<span style=color:#5c35cc;font-weight:700>@login_manager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user_loader</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>user_loader</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>str</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>username</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>users</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#000>user_model</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>User</span><span style=color:#000;font-weight:700>()</span>
        <span style=color:#000>user_model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>username</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user_model</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>None</span>


<span style=color:#5c35cc;font-weight:700>@app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/login&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;POST&#34;</span><span style=color:#000;font-weight:700>])</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>login_page</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get_json</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>password</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>username</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>users</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>check_password_hash</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>password</span><span style=color:#000;font-weight:700>):</span>
            <span style=color:#000>user_model</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>User</span><span style=color:#000;font-weight:700>()</span>
            <span style=color:#000>user_model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>username</span>
            <span style=color:#000>login_user</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>user_model</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>else</span><span style=color:#000;font-weight:700>:</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Wrong credentials&#34;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;logged in&#34;</span>


<span style=color:#5c35cc;font-weight:700>@app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@login_required</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>protected</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Current user: </span><span style=color:#4e9a06>{</span><span style=color:#000>current_user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>


<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h2 id=基于令牌的身份验证>基于令牌的身份验证</h2>
<p>这种方法使用令牌而不是 cookie 来验证用户。用户使用有效的凭据验证身份，服务器返回签名的令牌。这个令牌可用于后续请求。</p>
<p>最常用的令牌是 JSON Web Token（JWT）。JWT 包含三个部分：</p>
<ul>
<li>标头（包括令牌类型和使用的哈希算法）</li>
<li>负载（包括声明，是关于主题的陈述）</li>
<li>签名（用于验证消息在此过程中未被更改）</li>
</ul>
<p>这三部分都是 base64 编码的，并使用一个<code>.</code>串联并做哈希。由于它们已编码，因此任何人都可以解码和读取消息。但是，只有验证的用户才能生成有效的签名令牌。令牌使用签名来验证，签名用的是一个私钥。</p>
<blockquote>
<p>JSON Web Token（JWT）是一种紧凑的、URL 安全的方法，用于表示要在两方之间转移的声明。JWT 中的声明被编码为一个 JSON 对象，用作一个 JSON Web Signature（JWS）结构的负载，或一个 JSON Web Encryption（JWE）结构的纯文本，从而使声明可以进行数字签名，或使用一个消息验证码 Message Authentication Code（MAC）来做完整性保护和/或加密。——IETF</p>
</blockquote>
<p>令牌不必保存在服务端。只需使用它们的签名即可验证它们。近年来，由于 RESTfulAPI 和单页应用（SPA）的出现，令牌的使用量有所增加。</p>
<h3 id=流程-3>流程</h3>
<div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220214215353.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220214215353></div>
<h3 id=优点-3>优点</h3>
<ul>
<li>它是无状态的。服务器不需要存储令牌，因为可以使用签名对其进行验证。由于不需要数据库查找，因此可以让请求更快。</li>
<li>适用于微服务架构，其中有多个服务需要验证。我们只需在每一端配置如何处理令牌和令牌密钥即可。</li>
</ul>
<h3 id=缺点-3>缺点</h3>
<ul>
<li>根据令牌在客户端上的保存方式，它可能导致 XSS（通过 localStorage）或 CSRF（通过 cookie）攻击。</li>
<li>令牌无法被删除。它们只能过期。这意味着如果令牌泄漏，则攻击者可以滥用令牌直到其到期。因此，将令牌过期时间设置为非常小的值（例如 15 分钟）是非常重要的。</li>
<li>需要设置令牌刷新以在到期时自动发行令牌。</li>
<li>删除令牌的一种方法是创建一个将令牌列入黑名单的数据库。这为微服务架构增加了额外的开销并引入了状态。</li>
</ul>
<h3 id=代码-3>代码</h3>
<p>Flask-JWT-Extended 包为处理 JWT 提供了很多可能性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jsonify</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask_jwt_extended</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
    <span style=color:#000>JWTManager</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>jwt_required</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>create_access_token</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>get_jwt_identity</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>werkzeug.security</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>check_password_hash</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>generate_password_hash</span>

<span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__name__</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>update</span><span style=color:#000;font-weight:700>(</span>
    <span style=color:#000>JWT_SECRET_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;please_change_this&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#000>jwt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JWTManager</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>app</span><span style=color:#000;font-weight:700>)</span>

<span style=color:#000>users</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>generate_password_hash</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#000;font-weight:700>),</span>
<span style=color:#000;font-weight:700>}</span>


<span style=color:#5c35cc;font-weight:700>@app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/login&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;POST&#34;</span><span style=color:#000;font-weight:700>])</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>login_page</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>json</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;username&#34;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>password</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>json</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#000;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>username</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>users</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>check_password_hash</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>password</span><span style=color:#000;font-weight:700>):</span>
            <span style=color:#000>access_token</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>create_access_token</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>identity</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>username</span><span style=color:#000;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>jsonify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>access_token</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>access_token</span><span style=color:#000;font-weight:700>),</span> <span style=color:#0000cf;font-weight:700>200</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Wrong credentials&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>400</span>


<span style=color:#5c35cc;font-weight:700>@app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@jwt_required</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>protected</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>jsonify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>logged_in_as</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>get_jwt_identity</span><span style=color:#000;font-weight:700>()),</span> <span style=color:#0000cf;font-weight:700>200</span>


<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h2 id=一次性密码>一次性密码</h2>
<p>一次性密码（One Time Password，OTP）通常用作身份验证的确认。OTP 是随机生成的代码，可用于验证用户是否是他们声称的身份。它通常用在启用双因素身份验证的应用中，在用户凭据确认后使用。</p>
<p>要使用 OTP，必须存在一个受信任的系统。这个受信任的系统可以是经过验证的电子邮件或手机号码。</p>
<p>现代 OTP 是无状态的。可以使用多种方法来验证它们。尽管有几种不同类型的 OTP，但基于时间的 OTP（TOTP）可以说是最常见的类型。它们生成后会在一段时间后过期。</p>
<p>由于 OTP 让你获得了额外的一层安全保护，因此建议将 OTP 用于涉及高度敏感数据的应用，例如在线银行和其他金融服务。</p>
<h3 id=流程-4>流程</h3>
<p>实现 OTP 的传统方式：</p>
<ul>
<li>客户端发送用户名和密码</li>
<li>经过凭据验证后，服务器会生成一个随机代码，将其存储在服务端，然后将代码发送到受信任的系统</li>
<li>用户在受信任的系统上获取代码，然后在 Web 应用上重新输入它</li>
<li>服务器对照存储的代码验证输入的代码，并相应地授予访问权限</li>
</ul>
<p>TOTP 如何工作：</p>
<ul>
<li>客户端发送用户名和密码</li>
<li>经过凭据验证后，服务器会使用随机生成的种子生成随机代码，并将种子存储在服务端，然后将代码发送到受信任的系统</li>
<li>用户在受信任的系统上获取代码，然后将其输入回 Web 应用</li>
<li>服务器使用存储的种子验证代码，确保其未过期，并相应地授予访问权限</li>
</ul>
<p>谷歌身份验证器、微软身份验证器和 FreeOTP 等 OTP 代理如何工作：</p>
<ul>
<li>注册双因素身份验证（2FA）后，服务器会生成一个随机种子值，并将该种子以唯一 QR 码的形式发送给用户</li>
<li>用户使用其 2FA 应用程序扫描 QR 码以验证受信任的设备</li>
<li>每当需要 OTP 时，用户都会在其设备上检查代码，然后在 Web 应用中输入该代码</li>
<li>服务器验证代码并相应地授予访问权限</li>
</ul>
<h3 id=优点-4>优点</h3>
<ul>
<li>添加了一层额外的保护</li>
<li>不会有被盗密码在实现 OTP 的多个站点或服务上通过验证的危险</li>
</ul>
<h3 id=缺点-4>缺点</h3>
<ul>
<li>你需要存储用于生成 OTP 的种子。</li>
<li>像谷歌验证器这样的 OTP 代理中，如果你丢失了恢复代码，则很难再次设置 OTP 代理</li>
<li>当受信任的设备不可用时（电池耗尽，网络错误等）会出现问题。因此通常需要一个备用设备，这个设备会引入一个额外的攻击媒介。</li>
</ul>
<h3 id=代码-4>代码</h3>
<p>PyOTP 包提供了基于时间和基于计数器的 OTP。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>time</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sleep</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>pyotp</span>

<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>otp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pyotp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>TOTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pyotp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>random_base32</span><span style=color:#000;font-weight:700>())</span>
    <span style=color:#000>code</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>otp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;OTP generated: </span><span style=color:#4e9a06>{</span><span style=color:#000>code</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Verify OTP: </span><span style=color:#4e9a06>{</span><span style=color:#000>otp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>verify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>code</span><span style=color:#000;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>sleep</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Verify after 30s: </span><span style=color:#4e9a06>{</span><span style=color:#000>otp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>verify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>code</span><span style=color:#000;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>OTP generated: 474771
Verify OTP: True
Verify after 30s: False
</code></pre></div><h2 id=oauth-和-openid>OAuth 和 OpenID</h2>
<p>OAuth/OAuth2 和 OpenID 分别是授权和身份验证的流行形式。它们用于实现社交登录，一种单点登录（SSO）形式。社交登录使用来自诸如 Facebook、Twitter 或谷歌等社交网络服务的现有信息登录到第三方网站，而不是创建一个专用于该网站的新登录帐户。</p>
<p>当你需要高度安全的身份验证时，可以使用这种身份验证和授权方法。这些提供者中有一些拥有足够的资源来增强身份验证能力。利用经过反复考验的身份验证系统，可以让你的应用程序更加安全。</p>
<p>这种方法通常与基于会话的身份验证结合使用。</p>
<h3 id=流程-5>流程</h3>
<p>你访问的网站需要登录。你转到登录页面，然后看到一个名为“使用谷歌登录”的按钮。单击该按钮，它将带你到谷歌登录页面。通过身份验证后，你将被重定向回自动登录的网站。这是使用 OpenID 进行身份验证的示例。它让你可以使用现有帐户（通过一个 OpenID 提供程序）进行身份验证，而无需创建新帐户。</p>
<p>最著名的 OpenID 提供方有谷歌、Facebook、Twitter 和 GitHub。</p>
<p>登录后，你可以转到网站上的下载服务，该服务可让你直接将大文件下载到谷歌云端硬盘。网站如何访问你的 Google 云端硬盘？这里就会用到 OAuth。你可以授予访问另一个网站上资源的权限。在这里，你授予的就是写入谷歌云端硬盘的访问权限。</p>
<h3 id=优点-5>优点</h3>
<ul>
<li>提高安全性。</li>
<li>由于无需创建和记住用户名或密码，因此登录流程更加轻松快捷。</li>
<li>如果发生安全漏洞，由于身份验证是无密码的，因此不会对第三方造成损害。</li>
</ul>
<h3 id=缺点-5>缺点</h3>
<ul>
<li>现在，你的应用程序依赖于你无法控制的另一个应用。如果 OpenID 系统关闭，则用户将无法登录。</li>
<li>人们通常倾向于忽略 OAuth 应用程序请求的权限。</li>
<li>在你配置的 OpenID 提供方上没有帐户的用户将无法访问你的应用程序。最好的方法是同时实现多种途径。例如用户名和密码以及 OpenID，并让用户自行选择。</li>
</ul>
<h3 id=代码-5>代码</h3>
<p>你可以使用 Flask-Dance 实现 GitHub 社交身份验证。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>url_for</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>redirect</span>
<span style=color:#204a87;font-weight:700>from</span> <span style=color:#000>flask_dance.contrib.github</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>make_github_blueprint</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>github</span>

<span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Flask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>__name__</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>secret_key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;change me&#34;</span>
<span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;GITHUB_OAUTH_CLIENT_ID&#34;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1aaf1bf583d5e425dc8b&#34;</span>
<span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;GITHUB_OAUTH_CLIENT_SECRET&#34;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;dee0c5bc7e0acfb71791b21ca459c008be992d7c&#34;</span>

<span style=color:#000>github_blueprint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>make_github_blueprint</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>register_blueprint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>github_blueprint</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>url_prefix</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/login&#34;</span><span style=color:#000;font-weight:700>)</span>


<span style=color:#5c35cc;font-weight:700>@app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>index</span><span style=color:#000;font-weight:700>():</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>authorized</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>redirect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>url_for</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;github.login&#34;</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>resp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>github</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>resp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ok</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;You have successfully logged in, </span><span style=color:#4e9a06>{</span><span style=color:#000>resp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>json</span><span style=color:#000;font-weight:700>()[</span><span style=color:#4e9a06>&#39;login&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>


<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>__name__</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;__main__&#34;</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>run</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h2 id=总结>总结</h2>
<p>在本文中，我们研究了许多不同的 Web 身份验证方法，它们都有各自的优缺点。</p>
<p>你什么时候应该使用哪种方法？具体情况要具体分析。一些基本的经验法则：</p>
<ol>
<li>对于利用服务端模板的 Web 应用程序，通过用户名和密码进行基于会话的身份验证通常是最合适的。你也可以添加 OAuth 和 OpenID。</li>
<li>对于 RESTful API，建议使用基于令牌的身份验证，因为它是无状态的。</li>
<li>如果必须处理高度敏感的数据，则你可能需要将 OTP 添加到身份验证流中。</li>
</ol>
<p>最后请记住，本文的示例仅仅是简单的演示。生产环境需要进一步的配置。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-efcbd19b995731f9bc6c49c40442a460>2 - Token 多平台认证</h1>
<h2 id=概述>概述</h2>
<p>在存在账号体系的信息系统中，对身份的鉴定是非常重要的事情。随着移动互联网时代到来，客户端的类型越来越多， 逐渐出现了 一个服务器，N 个客户端的格局 。</p>
<div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220220221550.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220220221550></div>
<p>不同的客户端产生了不同的用户使用场景，这些场景：</p>
<ul>
<li>有不同的环境安全威胁</li>
<li>不同的会话生存周期</li>
<li>不同的用户权限控制体系</li>
<li>不同级别的接口调用方式</li>
</ul>
<p>综上所述，它们的身份认证方式也存在一定的区别。</p>
<h2 id=应用场景>应用场景</h2>
<p>下面是一些在 IT 服务常见的一些使用场景:</p>
<ul>
<li>用户在web浏览器端登录系统,使用系统服务</li>
<li>用户在手机端（Android/iOS）登录系统,使用系统服务</li>
<li>用户使用开放接口登录系统,调用系统服务</li>
<li>用户在PC处理登录状态时通过手机扫码授权手机登录（使用得比较少）</li>
<li>用户在手机处理登录状态进通过手机扫码授权PC进行登录（比较常见）</li>
</ul>
<p>通过对场景的细分,得到如下不同的认证token类别：</p>
<ol>
<li>原始账户密码
<ol>
<li>用户名和密码</li>
<li>API 应用 ID/KEY</li>
</ol>
</li>
<li>会话 ID
<ol>
<li>浏览器端 token</li>
<li>移动端 token</li>
<li>API 应用 token</li>
</ol>
</li>
<li>接口调用
<ol>
<li>接口访问 token</li>
<li>身份授权</li>
<li>PC 和移动端相互授权的 token</li>
</ol>
</li>
</ol>
<h2 id=token-的类别>Token 的类别</h2>
<p>不同场景的 token 进行如下几个维度的对比：</p>
<h3 id=天然属性对比>天然属性对比</h3>
<ul>
<li>
<p>使用成本：本认证方式在使用的时候,造成的不便性。比如:</p>
<ul>
<li>
<p>账号密码需要用户打开页面然后逐个键入</p>
</li>
<li>
<p>二维码需要用户掏出手机进行扫码操作</p>
</li>
</ul>
</li>
<li>
<p>变化成本：本认证方式,token发生变化时,用户需要做出的相应更改的成本:</p>
<ul>
<li>
<p>用户名和密码发生变化时,用户需要额外记忆和重新键入新密码</p>
</li>
<li>
<p>API应用ID/KEY发生变化时,第三方应用需要重新在代码中修改并部署</p>
</li>
<li>
<p>授权二维码发生变化时,需要用户重新打开手机应用进行扫码</p>
</li>
</ul>
</li>
<li>
<p>环境风险</p>
<ul>
<li>
<p>被偷窥的风险</p>
</li>
<li>
<p>被抓包的风险</p>
</li>
<li>
<p>被伪造的风险</p>
</li>
</ul>
</li>
</ul>
<h3 id=可控属性对比>可控属性对比</h3>
<ul>
<li>使用频率
<ul>
<li>在网路中传送的频率。</li>
</ul>
</li>
<li>有效时间
<ul>
<li>此token从创建到终结的生存时间</li>
</ul>
</li>
</ul>
<h3 id=最终目标安全和影响>最终目标：安全和影响</h3>
<p>安全和隐私性主要体现在:</p>
<ul>
<li>token 不容易被窃取和盗用（通过对传送频率控制）</li>
<li>token 即使被窃取,产生的影响也是可控的（通过对有效时间控制）</li>
</ul>
<p>关于隐私及隐私破坏后的后果,有如下的基本结论:</p>
<ul>
<li>曝光频率高的容易被截获</li>
<li>生存周期长的在被截获后产生的影响更严重和深远</li>
</ul>
<p>遵守如下原则:</p>
<ul>
<li>变化成本高的token不要轻易变化</li>
<li>不轻易变化的token要减少曝光频率（网络传输次数）</li>
<li>曝光频率高的token的生存周期要尽量短</li>
</ul>
<p>将各类token的固有特点及可控属性进行调控后, 对每个指标进行量化评分（1~5分），我们可以得到如下的对比表：</p>
<div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220220222115.png style=display:block;margin-left:auto;margin-right:auto;width:80% alt=20220220222115></div>
<blockquote>
<p>备注：user_name/passwd 和 app_id/app_key 是等价的效果</p>
</blockquote>
<h2 id=token-的层级关系>Token 的层级关系</h2>
<p>参考上一节的对比表，可以很容易对这些不同用途的token进行分层，主要可以分为4层：</p>
<ul>
<li>密码层：最传统的用户和系统之间约定的数字身份认证方式</li>
<li>会话层：用户登录后的会话生命周期的会话认证</li>
<li>调用层：用户在会话期间对应用程序接口的调用认证</li>
<li>应用层：用户获取了接口访问调用权限后的一些场景或者身份认证应用</li>
</ul>
<p>Token 的分层图如下：</p>
<div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220220222208.png style=display:block;margin-left:auto;margin-right:auto;width:80% alt=20220220222208></div>
<p>在一个多客户端的信息系统里面,这些token的产生及应用的内在联系如下:</p>
<ul>
<li>用户输入用户名和用户口令进行一次性认证</li>
<li>在 不同 的终端里面生成拥有 不同 生命周期的会话token</li>
<li>客户端会话token从服务端交换生命周期短但曝光 频繁 的接口访问token</li>
<li>会话token可以生成和刷新延长 access_token 的生存时间</li>
<li>access_token可以生成生存周期最短的用于授权的二维码的token</li>
</ul>
<p>使用如上的架构有如下的好处：</p>
<ul>
<li>良好的统一性：可以解决不同平台上认证token的生存周期的 归一化 问题</li>
<li>良好的解耦性：核心接口调用服务器的认证 access_token 可以完成独立的实现和部署</li>
<li>良好的层次性：不同平台的可以有完全不同的用户权限控制系统，这个控制可以在 会话层 中各平台解决掉</li>
</ul>
<h3 id=账户密码>账户密码</h3>
<p>广义的 账号/密码 有如下的呈现方式:</p>
<ul>
<li>传统的注册用户名和密码</li>
<li>应用程序的app_id/app_key</li>
</ul>
<p>它们的特点如下：</p>
<ul>
<li>会有特别的意义
<ul>
<li>比如：用户自己为了方便记忆，会设置有一定含义的账号和密码。</li>
</ul>
</li>
<li>不常修改
<ul>
<li>账号密码对用户有特别含义，一般没有特殊情况不会愿意修改。而app_id/app_key则会写在应用程序中，修改会意味着重新发布上线的成本。</li>
</ul>
</li>
<li><strong>一旦泄露影响深远</strong>
<ul>
<li>正因为不常修改，只要泄露了基本相当于用户的网络身份被泄露，而且只要没被察觉这种身份盗用就会一直存在。</li>
<li>所以在认证系统中应该尽量减少传输的机会，避免泄露。</li>
</ul>
</li>
</ul>
<h3 id=客户端会话-token>客户端会话 Token</h3>
<p><strong>功能</strong>：充当着session的角色，不同的客户端有不同的生命周期。</p>
<p>使用步骤：用户使用账号密码，换取会话token。</p>
<p>不同的平台的 token 有不同的特点：</p>
<ul>
<li>Web 平台生存周期短，主要原因是：
<ul>
<li>环境安全性：由于web登录环境一般很可能是公共环境，被他人盗取的风险值较大。</li>
<li>输入便捷性：在PC上使用键盘输入会比较便捷。</li>
</ul>
</li>
<li><strong>移动端生存周期长，主要原因是</strong>：
<ul>
<li>环境安全性：移动端平台是个人用户极其私密的平台，它人接触的机会不大。</li>
<li>输入便捷性：在移动端上使用手指在小屏幕上触摸输入体验差，输入成本高。</li>
</ul>
</li>
</ul>
<h3 id=access_token>access_token</h3>
<p>**功能：**服务端应用程序api接口访问和调用的凭证。</p>
<p>**使用步骤：**使用具有较长生命周期的会话token来换取此接口访问token。</p>
<p>其曝光频率直接和接口调用频率有关，属于高频使用的凭证。为了照顾到隐私性，尽量减少其生命周期，即使被截取了，也不至于产生严重的后果。</p>
<blockquote>
<p>注意：在客户端token之下还加上一个access_token， 主要是为了让具有不同生命周期的客户端token最后在调用 API 的时候， 能够具有统一的认证方式。</p>
</blockquote>
<h3 id=pam_token>pam_token</h3>
<p>**功能：**由已经登录和认证的PC端生成的二维码的原始串号（Pc Auth Mobile）。</p>
<p><strong>主要步骤如下：</strong></p>
<ol>
<li>PC上用户已经完成认证，登录了系统</li>
<li>PC端生成一组和此用户相关联的pam_token</li>
<li>PC端将此pam_token的使用链接生成二维码</li>
<li>移动端扫码后，请求服务器，并和用户信息关联</li>
<li>移动端获取refresh_token(长时效的会话)</li>
<li>根据 refresh_token 获取 access_token</li>
<li>完成正常的接口调用工作</li>
</ol>
<blockquote>
<p>备注:</p>
<ul>
<li>生存周期为2分钟,2分钟后过期删除</li>
<li>没有被使用时,每1分钟变一次</li>
<li>被使用后,立刻删除掉</li>
<li>此种认证模式一般不会被使用到</li>
</ul>
</blockquote>
<h3 id=map_token>map_token</h3>
<p>**功能：**由已经登录的移动app来扫码认证PC端系统，并完成PC端系统的登录（Mobile Auth Pc）。</p>
<p><strong>主要步骤：</strong></p>
<ol>
<li>移动端完成用户身份的认证登录app</li>
<li>未登录的PC生成匿名的 map_token</li>
<li>移动端扫码后在db中生成 map_token 和用户关联（完成签名）</li>
<li>db同时针对此用户生成 web_token</li>
<li>PC端一直以 map_token 为参数查找此命名用户的 web_token</li>
<li>PC端根据 web_token 去获取 access_token</li>
<li>后续正常的调用接口调用工作</li>
</ol>
<blockquote>
<p>备注:</p>
<ul>
<li>生存周期为2分钟,2分钟后过期删除</li>
<li>没有被使用时,每1分钟变一次</li>
<li>被使用后,立刻删除掉</li>
</ul>
</blockquote>
<h2 id=总结>总结</h2>
<p>本文所设计的基于token的身份认证系统，主要解决了如下的问题：</p>
<ul>
<li>token的分类问题</li>
<li>token的隐私性参数设置问题</li>
<li>token的使用场景问题</li>
<li>不同生命周期的token分层转化关系</li>
</ul>
<p>本文中提到的设计方法，在 应用层 中可以适用于且不限于如下场景中：</p>
<ul>
<li>用户登录</li>
<li>有时效的优惠券发放</li>
<li>有时效的邀请码发放</li>
<li>有时效的二维码授权</li>
<li>具有时效 手机/邮件 验证码</li>
<li>多个不同平台调用同一套API接口</li>
<li>多个平台使用同一个身份认证中心</li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>