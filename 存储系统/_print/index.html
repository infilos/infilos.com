<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>存储系统 | infilos.com</title><meta property="og:title" content="存储系统">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="存储系统">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="存储系统">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>存储系统</h1>
<ul>
<li>1: <a href=#pg-7710d6805fed4e0175c70d82d7258c0e>RDBMS</a></li>
<ul>
<li>1.1: <a href=#pg-c5780ac44a15b29613233ec776da4b55>CH01-工作方式</a></li>
<li>1.2: <a href=#pg-5f440bea0444e267ba103fefcd6501d8>CH02-设计理论</a></li>
<li>1.3: <a href=#pg-a9b9d58ba7418e7426e97d813794b4a4>CH03-设计流程</a></li>
<li>1.4: <a href=#pg-17a8347e6e10342607180b4d34ede039>CH04-核心知识</a></li>
</ul>
<li>2: <a href=#pg-52b3784f2c0fc27209a7dfce796a520a>SQL</a></li>
<ul>
<li>2.1: <a href=#pg-6b3f5552bcb7e8d7e392d0c4f28a8929>CH01-语法基础</a></li>
<li>2.2: <a href=#pg-3a7e7b2f0ca69ac47bbbc3c0d6b38685>CH02-查询练习</a></li>
<li>2.3: <a href=#pg-737e18886ba6621c88d9e916998f72b7>CH03-查询进阶</a></li>
<li>2.4: <a href=#pg-141228844e3202b20692d12c3ddf6e9d>CH04-查询优化</a></li>
</ul>
<li>3: <a href=#pg-90906b5d575a42bc40411c9bf01bcfb6>MySQL</a></li>
<ul>
<li>3.1: <a href=#pg-90adba63667076abecda8b645b08e594>CH01-数据类型</a></li>
<li>3.2: <a href=#pg-87823f5c8c995312533c60e735d79427>CH02-存储引擎</a></li>
<li>3.3: <a href=#pg-e59a8b6bc16ee47aa4e9119f76c58aa2>CH03-索引B+树</a></li>
<li>3.4: <a href=#pg-e153ee081a2e00565371b72f637f2039>CH04-性能优化</a></li>
<li>3.5: <a href=#pg-29d040819faa80f395ba725e176690a3>CH05-分库分表</a></li>
<li>3.6: <a href=#pg-18dd619a88421627df2c9f215cacaecc>CH06-复制分离</a></li>
<li>3.7: <a href=#pg-280203572e4e446020b171753e2c2a12>CH07-执行过程</a></li>
</ul>
<li>4: <a href=#pg-c98eb4e5d30b0012286d2018ebc8246d>MySQL 实战</a></li>
<ul>
<li>4.1: <a href=#pg-763a4cb19f42bf3fcb7e0895e1f01027>CH01-基础架构</a></li>
<li>4.2: <a href=#pg-1b4b5a489c633646179898f8f72f66d8>MySQL</a></li>
<li>4.3: <a href=#pg-557271842e3f9b6b61f8f0a1bbe2a7ca>MySQL</a></li>
<li>4.4: <a href=#pg-b26ced95223bb69a1c58b680a8a4194b>MySQL</a></li>
<li>4.5: <a href=#pg-8e6aafa223e735459e0969042de4d54f>MySQL</a></li>
<li>4.6: <a href=#pg-5a6f17ddd74c080d6a6db2bc41956240>MySQL</a></li>
<li>4.7: <a href=#pg-b3a9aaf767396fa16fcdb3ef3e2418e2>MySQL</a></li>
<li>4.8: <a href=#pg-f15574a70dd70677547f9af779af61e7>MySQL</a></li>
<li>4.9: <a href=#pg-d94c10e940f788e4706645fab4ee4d18>CH02-日志系统</a></li>
<li>4.10: <a href=#pg-1fed0fae3032d08ee3c0cb9fd99595b3>CH03-事务隔离</a></li>
</ul>
<li>5: <a href=#pg-9653d45f3d65839c479cbf585b3db5c7>Redis</a></li>
<ul>
<li>5.1: <a href=#pg-15dc494595c2bd4672f094c19c69802f>CH01-基本类型</a></li>
<li>5.2: <a href=#pg-74fbd382412792c903e2f596fdcce9b7>CH02-高级类型</a></li>
<li>5.3: <a href=#pg-fa602568c373b012706150061f875875>CH03-Stream</a></li>
<li>5.4: <a href=#pg-f39b5b7bdbb59acf255fb62ce2763d03>CH04-对象机制</a></li>
<li>5.5: <a href=#pg-d6ad1d4083c795b0ad006b6fb71ea3c7>CH05-底层结构</a></li>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-7710d6805fed4e0175c70d82d7258c0e>1 - RDBMS</h1>
</div>
<div class=td-content>
<h1 id=pg-c5780ac44a15b29613233ec776da4b55>1.1 - CH01-工作方式</h1>
<h2 id=相关算法>相关算法</h2>
<h3 id=时间复杂度>时间复杂度</h3>
<blockquote>
<p>对于数据库而言，重要的不是数据量，而是解决数据量增加时引起的运算量问题。</p>
</blockquote>
<p>时间复杂度用来检验某个算法处理一定量的数据要花多长时间，时间复杂度不会给出确切的运算次数，但是给出的是一种理念。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503150549.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>
<p>绿：O(1)或者叫常数阶复杂度，保持为常数（要不人家就不会叫常数阶复杂度了）。</p>
</li>
<li>
<p>红：O(log(n))对数阶复杂度，即使在十亿级数据量时也很低。</p>
</li>
<li>
<p>粉：最糟糕的复杂度是 O(n^2)，平方阶复杂度，运算数快速膨胀。</p>
</li>
<li>
<p>黑和蓝：另外两种复杂度（的运算数也是）快速增长。</p>
</li>
</ul>
<p>假设要处理2000条元素：</p>
<ul>
<li>O(1) 算法会消耗 1 次运算</li>
<li>O(log(n)) 算法会消耗 7 次运算</li>
<li>O(n) 算法会消耗 2000 次运算</li>
<li>O(n*log(n)) 算法会消耗 14,000 次运算</li>
<li>O(n^2) 算法会消耗 4,000,000 次运算</li>
</ul>
<h3 id=归并排序>归并排序</h3>
<p>归并排序是把问题拆分为小问题，通过解决小问题来解决最初的问题，即分治法。</p>
<p>什么是归并排序：</p>
<ul>
<li>你可以更改算法，以便于节省内存空间，方法是不创建新的序列而是直接修改输入序列。注：这种算法叫『<strong>原地算法</strong>』(in-place algorithm)</li>
<li>你可以更改算法，以便于同时使用磁盘空间和少量内存而避免巨量磁盘 I/O。方法是只向内存中加载当前处理的部分。在仅仅100MB的内存缓冲区内排序一个几个GB的表时，这是个很重要的技巧。注：这种算法叫『<strong>外部排序</strong>』(external sorting)。</li>
<li>你可以更改算法，以便于在 多处理器/多线程/多服务器 上运行。比如，分布式合并排序是 <strong>Hadoop</strong> 的关键组件之一。</li>
</ul>
<h3 id=二叉树搜索>二叉树搜索</h3>
<blockquote>
<p>数据库中查询的时间复杂度，使我们无法使用矩阵，转而使用二叉搜索树(BST)。</p>
</blockquote>
<ul>
<li>二叉搜索树只需 log(N) 次运算，而如果直接使用阵列则需要 N 次运算。</li>
</ul>
<h3 id=b树索引>B+树索引</h3>
<blockquote>
<ul>
<li>
<p>为什么引入 B+ 树？</p>
<p>查找一个特定值这个树挺好用，但是当你需要<strong>查找两个值之间的多个元素</strong>时，就会有大麻烦了。你的成本将是 O(N)，因为你必须查找树的每一个节点，以判断它是否处于那 2 个值之间（例如，对树使用中序遍历）。而且这个操作不是磁盘I/O有利的，因为你必须读取整个树。我们需要找到高效的范围查询方法。</p>
</li>
</ul>
</blockquote>
<p>如果在数据库中增加或删除一行，对 B+ 树来说：</p>
<ul>
<li>你必须在B+树中的节点之间保持顺序，否则节点会变得一团糟，你无法从中找到想要的节点。</li>
<li>你必须尽可能降低B+树的层数，否则 O(log(N)) 复杂度会变成 O(N)。</li>
</ul>
<p>B+树需要自我整理和自我平衡。但是这样也带来了成本：在B+树中，插入和删除操作是 O(log(N)) 复杂度。所以有些人听到过使用太多索引不是个好主意这类说法。没错，你减慢了快速插入/更新/删除表中的一个行的操作，因为数据库需要以代价高昂的每索引 O(log(N)) 运算来更新表的索引。再者，增加索引意味着给事务管理器带来更多的工作负荷（在本文结尾我们会探讨这个管理器）。</p>
<h3 id=哈希表>哈希表</h3>
<blockquote>
<p>当你想快速查找值时，哈希表是非常有用的。而且，理解哈希表会帮助我们接下来理解一个数据库常见的联接操作，叫做『哈希联接』。这个<strong>数据结构也被数据库用来保存一些内部的东西</strong>（比如<strong>锁表</strong>或者<strong>缓冲池</strong>，我们在下文会研究这两个概念）</p>
</blockquote>
<p>为什么不用阵列？</p>
<ul>
<li>如果有了好的哈希函数，在哈希表里搜索的时间复杂度是 O(1)。</li>
<li><strong>一个哈希表可以只装载一半到内存，剩下的哈希桶可以留在硬盘上</strong>。</li>
<li>用阵列的话，你需要一个连续内存空间。如果你加载一个大表，很难分配足够的连续内存空间。</li>
</ul>
<h2 id=全局概览>全局概览</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503151253.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=核心组件>核心组件</h3>
<ul>
<li>
<p><strong>进程管理器（process manager）</strong>：很多数据库具备一个需要妥善管理的进程/线程池。再者，为了实现纳秒级操作，一些现代数据库使用自己的线程而不是操作系统线程。</p>
</li>
<li>
<p><strong>网络管理器（network manager）</strong>：网路I/O是个大问题，尤其是对于分布式数据库。所以一些数据库具备自己的网络管理器。</p>
</li>
<li>
<p><strong>文件系统管理器（File system manager）</strong>：磁盘I/O是数据库的首要瓶颈。具备一个文件系统管理器来完美地处理OS文件系统甚至取代OS文件系统，是非常重要的。</p>
</li>
<li>
<p><strong>内存管理器（memory manager）</strong>：为了避免磁盘I/O带来的性能损失，需要大量的内存。但是如果你要处理大容量内存你需要高效的内存管理器，尤其是你有很多查询同时使用内存的时候。</p>
</li>
<li>
<p><strong>安全管理器（Security Manager）</strong>：用于对用户的验证和授权。</p>
</li>
<li>
<p><strong>客户端管理器（Client manager）</strong>：用于管理客户端连接。</p>
</li>
</ul>
<h3 id=工具>工具</h3>
<ul>
<li><strong>备份管理器（Backup manager）</strong>：用于保存和恢复数据。</li>
<li><strong>恢复管理器（Recovery manager</strong>）：用于崩溃后重启数据库到一个一致状态。</li>
<li><strong>监控管理器（Monitor manager）</strong>：用于记录数据库活动信息和提供监控数据库的工具。</li>
<li><strong>管理员管理器（Administration manager）</strong>：用于保存元数据（比如表的名称和结构），提供管理数据库、模式、表空间的工具。</li>
</ul>
<h3 id=查询管理器>查询管理器</h3>
<ul>
<li><strong>查询解析器（Query parser）</strong>：用于检查查询是否合法</li>
<li><strong>查询重写器（Query rewriter）</strong>：用于预优化查询</li>
<li><strong>查询优化器（Query optimizer）</strong>：用于优化查询</li>
<li><strong>查询执行器（Query executor）</strong>：用于编译和执行查询</li>
</ul>
<h3 id=数据管理器>数据管理器：</h3>
<ul>
<li><strong>事务管理器（Transaction manager）</strong>：用于处理事务</li>
<li><strong>缓存管理器（Cache manager）</strong>：数据被使用之前置于内存，或者数据写入磁盘之前置于内存</li>
<li><strong>数据访问管理器（Data access manager）</strong>：访问磁盘中的数据</li>
</ul>
<h2 id=查询流程>查询流程</h2>
<p>主要介绍数据库如何通过如下进程来管理 SQL 查询：</p>
<ul>
<li>客户端管理器</li>
<li>查询管理器</li>
<li>数据管理器（含恢复管理器）</li>
<li>客户端管理器</li>
</ul>
<h2 id=客户端管理器>客户端管理器</h2>
<blockquote>
<p>客户端管理器是处理客户端通信的。客户端可以是一个（网站）服务器或者一个最终用户或最终应用。客户端管理器通过一系列知名的API（JDBC, ODBC, OLE-DB …）提供不同的方式来访问数据库。客户端管理器也提供专有的数据库访问API。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503151620.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>当你连接到数据库时</strong>：</p>
<ul>
<li>管理器首先检查你的验证信息（用户名和密码），然后检查你是否有访问数据库的授权。这些权限由DBA分配。</li>
<li>然后，管理器检查是否有空闲进程（或线程）来处理你对查询。</li>
<li>管理器还会检查数据库是否负载很重。</li>
<li>管理器可能会等待一会儿来获取需要的资源。如果等待时间达到超时时间，它会关闭连接并给出一个可读的错误信息。</li>
<li>然后管理器会把你的查询送给查询管理器来处理。</li>
<li>因为查询处理进程不是『不全则无』的，一旦它从查询管理器得到数据，它会把部分结果保存到一个缓冲区并且开始给你发送。</li>
<li>如果遇到问题，管理器关闭连接，向你发送可读的解释信息，然后释放资源。</li>
</ul>
<h2 id=查询管理器-1>查询管理器</h2>
<blockquote>
<p>数据库的关键，在这部分里，一个写得糟糕的查询可以转换成一个快速执行的代码，代码执行的结果被送到客户端管理器。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503151752.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这个多步骤操作过程如下：</p>
<ul>
<li>查询首先被<strong>解析</strong>并判断是否合法</li>
<li>然后被<strong>重写</strong>，去除了无用的操作并且加入<strong>预优化</strong>部分</li>
<li>接着被<strong>优化</strong>以便提升性能，并被<strong>转换为可执行代码</strong>和<strong>数据访问计划</strong>。</li>
<li>然后计划被<strong>编译</strong></li>
<li>最后，被<strong>执行</strong></li>
</ul>
<h3 id=查询解析器>查询解析器</h3>
<blockquote>
<p>每一条SQL语句都要送到解析器来检查语法，如果你的查询有错，解析器将拒绝该查询。比如，如果你写成”SLECT …” 而不是 “SELECT …”，那就没有下文了。</p>
</blockquote>
<ul>
<li>
<p>解析器还会检查关键字是否使用正确的顺序，比如 WHERE 写在 SELECT 之前会被拒绝。</p>
</li>
<li>
<p>然后，解析器要分析查询中的表和字段，使用数据库元数据来检查：</p>
<ul>
<li>表是否存在</li>
<li>表的字段是否存在</li>
<li>对某类型字段的 运算 是否 可能（比如，你不能将整数和字符串进行比较，你不能对一个整数使用 substring() 函数）</li>
</ul>
</li>
<li>
<p>接着，解析器检查在查询中你是否有权限来读取（或写入）表。再强调一次：这些权限由DBA分配。</p>
</li>
<li>
<p>在解析过程中，SQL 查询被转换为内部表示（通常是一个树）。</p>
</li>
<li>
<p>如果一切正常，内部表示被送到查询重写器。</p>
</li>
</ul>
<h3 id=查询重写器>查询重写器</h3>
<p>在这一步，我们已经有了查询的内部表示，重写器的目标是：</p>
<ul>
<li>预优化查询</li>
<li>避免不必要的运算</li>
<li>帮助优化器找到合理的最佳解决方案</li>
</ul>
<p>重写器按照一系列已知的规则对查询执行检测。如果查询匹配一种模式的规则，查询就会按照这条规则来重写。下面是（可选）规则的非详尽的列表：</p>
<ul>
<li><strong>视图合并</strong>：如果你在查询中使用视图，视图就会转换为它的 SQL 代码。</li>
<li><strong>子查询扁平化</strong>：子查询是很难优化的，因此重写器会尝试移除子查询</li>
<li><strong>去除不必要的运算符</strong>：比如，如果你用了 DISTINCT，而其实你有 UNIQUE 约束（这本身就防止了数据出现重复），那么 DISTINCT 关键字就被去掉了。</li>
<li><strong>排除冗余的联接</strong>：如果相同的 JOIN 条件出现两次，比如隐藏在视图中的 JOIN 条件，或者由于传递性产生的无用 JOIN，都会被消除。</li>
<li><strong>常数计算赋值</strong>：如果你的查询需要计算，那么在重写过程中计算会执行一次。比如 WHERE AGE > 10+2 会转换为 WHERE AGE > 12 ， TODATE(“日期字符串”) 会转换为 datetime 格式的日期值。</li>
<li><strong>（高级）分区裁剪（Partition Pruning）</strong>：如果你用了分区表，重写器能够找到需要使用的分区。</li>
<li><strong>（高级）物化视图重写（Materialized view rewrite）</strong>：如果你有个物化视图匹配查询谓词的一个子集，重写器将检查视图是否最新并修改查询，令查询使用物化视图而不是原始表。</li>
<li><strong>（高级）自定义规则</strong>：如果你有自定义规则来修改查询（就像 Oracle policy），重写器就会执行这些规则。</li>
<li><strong>（高级）OLAP转换</strong>：分析/加窗 函数，星形联接，ROLLUP 函数……都会发生转换（但我不确定这是由重写器还是优化器来完成，因为两个进程联系很紧，必须看是什么数据库）。</li>
</ul>
<h3 id=统计信息>统计信息</h3>
<p>数据库和操作系统是如何保存数据的？两者使用的最小单位叫做页或块（默认 4 或 8 KB）。这就是说如果你仅需要 1KB，也会占用一个页。要是页的大小为 8KB，你就浪费了 7KB。</p>
<p>当你要求数据库收集统计信息，数据库会计算下列值：</p>
<ul>
<li>表中行和页的数量</li>
<li>表中每个列中的：
<ul>
<li>唯一值</li>
<li>数据长度（最小，最大，平均）</li>
<li>数据范围（最小，最大，平均）</li>
</ul>
</li>
<li>表的索引信息</li>
</ul>
<p><strong>这些统计信息会帮助优化器估计查询所需的磁盘 I/O、CPU、和内存使用</strong>。</p>
<p>对每个列的统计非常重要。比如，如果一个表 PERSON 需要联接 2 个列： LAST_NAME, FIRST_NAME。根据统计信息，数据库知道FIRST_NAME只有 1,000 个不同的值，LAST_NAME 有 1,000,000 个不同的值。因此，数据库就会按照 LAST_NAME, FIRST_NAME 联接。因为 LAST_NAME 不大可能重复，多数情况下比较 LAST_NAME 的头 2 、 3 个字符就够了，这将大大减少比较的次数。</p>
<p>不过，这些只是基本的统计。你可以让数据库做一种高级统计，叫直方图。直方图是列值分布情况的统计信息。例如：</p>
<ul>
<li>出现最频繁的值</li>
<li>分位数(quantiles)</li>
<li>…</li>
</ul>
<p>这些额外的统计会帮助数据库找到更佳的查询计划，尤其是对于等式谓词（例如： WHERE AGE = 18 ）或范围谓词（例如： WHERE AGE > 10 and AGE &lt; 40），因为数据库可以更好的了解这些谓词相关的数字类型数据行（注：这个概念的技术名称叫选择率）。</p>
<p>统计信息保存在数据库元数据内，例如（非分区）表的统计信息位置：</p>
<ul>
<li>Oracle： USER / ALL / DBA_TABLES 和 USER / ALL / DBA_TAB_COLUMNS</li>
<li>DB2： SYSCAT.TABLES 和 SYSCAT.COLUMNS</li>
</ul>
<p><strong>统计信息必须及时更新</strong>。如果一个表有 1,000,000 行而数据库认为它只有 500 行，没有比这更糟糕的了。统计唯一的不利之处是需要时间来计算，这就是为什么数据库大多默认情况下不会自动计算统计信息。数据达到百万级时统计会变得困难，这时候，你可以选择仅做基本统计或者在一个数据库样本上执行统计。</p>
<p>举个例子，我参与的一个项目需要处理每表上亿条数据的库，我选择只统计10%，结果造成了巨大的时间消耗。本例证明这是个糟糕的决定，因为有时候 Oracle 10G 从特定表的特定列中选出的 10% 跟全部 100% 有很大不同（对于拥有一亿行数据的表，这种情况极少发生）。这次错误的统计导致了一个本应 30 秒完成的查询最后执行了 8 个小时，查找这个现象根源的过程简直是个噩梦。这个例子显示了统计的重要性。</p>
<h3 id=查询优化器>查询优化器</h3>
<blockquote>
<p>所有的现代数据库都在用<strong>基于成本的优化</strong>（即CBO）来优化查询。道理是针对每个运算设置一个成本，通过应用成本最低廉的一系列运算，来找到最佳的降低查询成本的方法。</p>
</blockquote>
<p>为了理解成本优化器的原理，我觉得最好用个例子来『感受』一下这个任务背后的复杂性。这里我将给出联接 2 个表的 3 个方法，我们很快就能看到即便一个简单的联接查询对于优化器来说都是个噩梦。之后，我们会了解真正的优化器是怎么做的。</p>
<p><strong>对于这些联接操作，我会专注于它们的时间复杂度，但是，数据库优化器计算的是它们的 CPU 成本、磁盘 I/O 成本、和内存需求</strong>。时间复杂度和 CPU 成本的区别是，时间成本是个近似值（给我这样的懒家伙准备的）。而 CPU 成本，我这里包括了所有的运算，比如：加法、条件判断、乘法、迭代……还有呢：</p>
<ul>
<li>
<p>每一个高级代码运算都要特定数量的低级 CPU 运算。</p>
</li>
<li>
<p>对于 Intel Core i7、Intel Pentium 4、AMD Opteron…等，（就 CPU 周期而言）CPU 的运算成本是不同的，也就是说它取决于 CPU 的架构。</p>
</li>
</ul>
<p>使用时间复杂度就容易多了（至少对我来说），用它我也能了解到 CBO 的概念。由于磁盘 I/O 是个重要的概念，我偶尔也会提到它。请牢记，<strong>大多数时候瓶颈在于磁盘 I/O 而不是 CPU 使用</strong>。</p>
<h4 id=索引>索引</h4>
<blockquote>
<p>在研究 B+树的时候我们谈到了索引，要记住一点，索引都是已经排了序的。</p>
</blockquote>
<p>仅供参考：还有其他类型的索引，比如位图索引，在 CPU、磁盘I/O、和内存方面与B+树索引的成本并不相同。</p>
<p>另外，很多现代数据库为了改善执行计划的成本，可以仅为当前查询动态地生成临时索引。</p>
<h4 id=存取路径>存取路径</h4>
<p>在应用联接运算符（join operators）之前，你首先需要获得数据。以下就是获得数据的方法。</p>
<p>注：由于所有存取路径的真正问题是磁盘 I/O，我不会过多探讨时间复杂度。</p>
<ul>
<li>
<p>全扫描</p>
<p>如果你读过执行计划，一定看到过『全扫描』（或只是『扫描』）一词。简单的说全扫描就是数据库完整的读一个表或索引。就磁盘 I/O 而言，很明显全表扫描的成本比索引全扫描要高昂。</p>
</li>
<li>
<p>范围扫描</p>
<p>其他类型的扫描有索引范围扫描，比如当你使用谓词 ” WHERE AGE > 20 AND AGE &lt; 40 ” 的时候它就会发生。</p>
<p>当然，你需要在 AGE 字段上有索引才能用到索引范围扫描。</p>
<p>在第一部分我们已经知道，范围查询的时间成本大约是 log(N)+M，这里 N 是索引的数据量，M 是范围内估测的行数。多亏有了统计我们才能知道 N 和 M 的值（注： M 是谓词 “ AGE > 20 AND AGE &lt; 40 ” 的选择率）。另外范围扫描时，你不需要读取整个索引，因此在磁盘 I/O 方面没有全扫描那么昂贵。</p>
</li>
<li>
<p>唯一扫描</p>
<p>如果你只需要从索引中取一个值你可以用唯一扫描。</p>
</li>
<li>
<p>根据 ROW ID 存取</p>
<p>多数情况下，如果数据库使用索引，它就必须查找与索引相关的行，这样就会用到根据 ROW ID 存取的方式。</p>
</li>
<li>
<p>其它路径</p>
<p>我没有列举所有的存取路径，如果你感兴趣可以读一读 Oracle文档。其它数据库里也许叫法不同但背后的概念是一样的。</p>
</li>
</ul>
<h4 id=联结运算符>联结运算符</h4>
<p>我要展现的是3个个常用联接运算符：合并联接（Merge join），哈希联接（Hash Join）和嵌套循环联接（Nested Loop Join）。但是在此之前，我需要引入新词汇了：内关系和外关系（ inner relation and outer relation）这里的关系可以是：</p>
<ul>
<li>一个表</li>
<li>一个索引</li>
<li>上一个运算的中间结果（比如上一个联接运算的结果）</li>
</ul>
<p>当你联接两个关系时，联接算法对两个关系的处理是不同的。在本文剩余部分，我将假定：</p>
<ul>
<li>外关系是左侧数据集</li>
<li>内关系是右侧数据集</li>
</ul>
<p>比如， A JOIN B 是 A 和 B 的联接，这里 A 是外关系，B 是内关系。</p>
<p>多数情况下， <strong>A JOIN B 的成本跟 B JOIN A 的成本是不同的</strong>。</p>
<p>在这一部分，我还将假定外关系有 N 个元素，内关系有 M 个元素。要记住，真实的优化器通过统计知道 N 和 M 的值。</p>
<p>注：N 和 M 是关系的基数。</p>
<h5 id=嵌套循环查询>嵌套循环查询</h5>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503152955.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>针对外关系的每一行，查看内关系里的所有行来寻找匹配的行。</li>
</ul>
<p>伪代码的形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>nested_loop_join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span> <span style=color:#000>outer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span> <span style=color:#000>inner</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>each</span> <span style=color:#000>row</span> <span style=color:#000>a</span> <span style=color:#000>in</span> <span style=color:#000>outer</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>each</span> <span style=color:#000>row</span> <span style=color:#000>b</span> <span style=color:#000>in</span> <span style=color:#000>inner</span>
      <span style=color:#000>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match_join_condition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#000>write_result_in_output</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>if</span>
    <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>for</span>
   <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>for</span>
</code></pre></div><p>由于这是个双迭代，<strong>时间复杂度是 O(N*M)</strong>。</p>
<p>在磁盘 I/O 方面， 针对 N 行外关系的每一行，内部循环需要从内关系读取 M 行。这个算法需要从磁盘读取 N+ N*M 行。但是，如果内关系足够小，你可以把它读入内存，那么就只剩下 M + N 次读取。这样修改之后，内关系必须是最小的，因为它有更大机会装入内存。</p>
<p>在CPU成本方面没有什么区别，但是在磁盘 I/O 方面，最好最好的，是每个关系只读取一次。</p>
<p>当然，内关系可以由索引代替，对磁盘 I/O 更有利。</p>
<p>由于这个算法非常简单，下面这个版本在内关系太大无法装入内存时，对磁盘 I/O 更加有利。原因如下：</p>
<ul>
<li>为了避免逐行读取两个关系，</li>
<li>你可以成簇读取，把（两个关系里读到的）两簇数据行保存在内存里，</li>
<li>比较两簇数据，保留匹配的，</li>
<li>然后从磁盘加载新的数据簇来继续比较</li>
<li>直到加载了所有数据。</li>
</ul>
<p>可能的算法如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// improved version to reduce the disk I/O.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>nested_loop_join_v2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span> <span style=color:#000>outer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>file</span> <span style=color:#000>inner</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>each</span> <span style=color:#000>bunch</span> <span style=color:#000>ba</span> <span style=color:#000>in</span> <span style=color:#000>outer</span>
  <span style=color:#8f5902;font-style:italic>// ba is now in memory
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>each</span> <span style=color:#000>bunch</span> <span style=color:#000>bb</span> <span style=color:#000>in</span> <span style=color:#000>inner</span>
        <span style=color:#8f5902;font-style:italic>// bb is now in memory
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>each</span> <span style=color:#000>row</span> <span style=color:#000>a</span> <span style=color:#000>in</span> <span style=color:#000>ba</span>
          <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>each</span> <span style=color:#000>row</span> <span style=color:#000>b</span> <span style=color:#000>in</span> <span style=color:#000>bb</span>
            <span style=color:#000>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match_join_condition</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>))</span>
              <span style=color:#000>write_result_in_output</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>if</span>
          <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>for</span>
       <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>for</span>
    <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>for</span>
   <span style=color:#000>end</span> <span style=color:#204a87;font-weight:700>for</span>
</code></pre></div><p><strong>使用这个版本，时间复杂度没有变化，但是磁盘访问降低了</strong>：</p>
<ul>
<li>用前一个版本，算法需要 N + N*M 次访问（每次访问读取一行）。</li>
<li>用新版本，磁盘访问变为 外关系的数据簇数量 + 外关系的数据簇数量 * 内关系的数据簇数量。</li>
<li>增加数据簇的尺寸，可以降低磁盘访问。</li>
</ul>
<h5 id=哈希连接>哈希连接</h5>
<p>哈希联接更复杂，不过在很多场合比嵌套循环联接成本低。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503153546.png style=display:block;width:50% alt=NAME align=center> </div>
<p>哈希联接的原理是：</p>
<ul>
<li>读取内关系的所有元素</li>
<li>在内存里建一个哈希表</li>
<li>逐条读取外关系的所有元素 +（用哈希表的哈希函数）计算每个元素的哈希值，来查找内关系里相关的哈希桶内</li>
<li>是否与外关系的元素匹配。</li>
</ul>
<p>在时间复杂度方面我需要做些假设来简化问题：</p>
<ul>
<li>内关系被划分成 X 个哈希桶</li>
<li>哈希函数几乎均匀地分布每个关系内数据的哈希值，就是说哈希桶大小一致。</li>
<li>外关系的元素与哈希桶内的所有元素的匹配，成本是哈希桶内元素的数量。</li>
</ul>
<p>时间复杂度是 (M/X) * N + 创建哈希表的成本(M) + 哈希函数的成本 * N 。如果哈希函数创建了足够小规模的哈希桶，那么复杂度就是 O(M+N)。</p>
<p>还有个哈希联接的版本，对内存有利但是对磁盘 I/O 不够有利。 这回是这样的：</p>
<ul>
<li>计算内关系和外关系双方的哈希表</li>
<li>保存哈希表到磁盘</li>
<li>然后逐个哈希桶比较（其中一个读入内存，另一个逐行读取）。</li>
</ul>
<h5 id=合并连接>合并连接</h5>
<blockquote>
<p>合并联接是唯一产生排序的联接算法。</p>
</blockquote>
<p>注：这个简化的合并联接不区分内表或外表；两个表扮演同样的角色。但是真实的实现方式是不同的，比如当处理重复值时。</p>
<ul>
<li>1.（可选）排序联接运算：两个输入源都按照联接关键字排序。</li>
<li>2.合并联接运算：排序后的输入源合并到一起。</li>
<li><strong>排序</strong></li>
</ul>
<p>我们已经谈到过合并排序，在这里合并排序是个很好的算法（但是并非最好的，如果内存足够用的话，还是哈希联接更好）。</p>
<p>然而有时数据集已经排序了，比如：</p>
<ul>
<li>如果表内部就是有序的，比如联接条件里一个索引组织表(index-organized table)</li>
<li>如果关系是联接条件里的一个索引</li>
<li>如果联接应用在一个查询中已经排序的中间结果</li>
<li><strong>合并联接</strong></li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503153852.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这部分与我们研究过的合并排序中的合并运算非常相似。不过这一次呢，我们不是从两个关系里挑选所有元素，而是只挑选相同的元素。道理如下：</p>
<ul>
<li>在两个关系中，比较当前元素（当前=头一次出现的第一个）</li>
<li>如果相同，就把两个元素都放入结果，再比较两个关系里的下一个元素</li>
<li>如果不同，就去带有最小元素的关系里找下一个元素（因为下一个元素可能会匹配）</li>
<li>重复 1、2、3步骤直到其中一个关系的最后一个元素。</li>
</ul>
<p>因为两个关系都是已排序的，你不需要『回头去找』，所以这个方法是有效的。</p>
<p>该算法是个简化版，因为它没有处理两个序列中相同数据出现多次的情况（即多重匹配）。真实版本『仅仅』针对本例就更加复杂，所以我才选择简化版。</p>
<ul>
<li>
<p>如果两个关系都已经排序，时间复杂度是 O(N+M)</p>
</li>
<li>
<p>如果两个关系需要排序，时间复杂度是对两个关系排序的成本：O(N<em>Log(N) + M</em>Log(M))</p>
</li>
</ul>
<h5 id=最优算法>最优算法</h5>
<p>如果有最好的，就没必要弄那么多种类型了。这个问题很难，因为很多因素都要考虑，比如：</p>
<ul>
<li><strong>空闲内存</strong>：没有足够的内存的话就跟强大的哈希联接拜拜吧（至少是完全内存中哈希联接）。</li>
<li><strong>两个数据集的大小</strong>。比如，如果一个大表联接一个很小的表，那么嵌套循环联接就比哈希联接快，因为后者有创建哈希的高昂成本；如果两个表都非常大，那么嵌套循环联接CPU成本就很高昂。</li>
<li><strong>是否有索引</strong>：有两个 B+树索引的话，聪明的选择似乎是合并联接。</li>
<li><strong>结果是否需要排序</strong>：即使你用到的是未排序的数据集，你也可能想用成本较高的合并联接（带排序的），因为最终得到排序的结果后，你可以把它和另一个合并联接串起来（或者也许因为查询用 ORDER BY/GROUP BY/DISTINCT 等操作符隐式或显式地要求一个排序结果）。</li>
<li><strong>关系是否已经排序</strong>：这时候合并联接是最好的候选项。</li>
<li><strong>联接的类型</strong>：是等值联接（比如 tableA.col1 = tableB.col2 ）？ 还是内联接？外联接？笛卡尔乘积？或者自联接？有些联接在特定环境下是无法工作的。</li>
<li><strong>数据的分布</strong>：如果联接条件的数据是倾斜的（比如根据姓氏来联接人，但是很多人同姓），用哈希联接将是个灾难，原因是哈希函数将产生分布极不均匀的哈希桶。</li>
<li>如果你希望联接操作使用<strong>多线程或多进程</strong>。</li>
</ul>
<p>想要更详细的信息，可以阅读DB2, ORACLE 或 SQL Server)的文档。</p>
<h5 id=应用实例>应用实例</h5>
<p>我们已经研究了 3 种类型的联接操作。现在，比如说我们要联接 5 个表，来获得一个人的全部信息。一个人可以有：</p>
<ul>
<li>多个手机号（MOBILES）</li>
<li>多个邮箱（MAILS）</li>
<li>多个地址（ADRESSES）</li>
<li>多个银行账号（BANK_ACCOUNTS）</li>
</ul>
<p>换句话说，我们需要用下面的查询快速得到答案：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PERSON</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MOBILES</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MAILS</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>ADRESSES</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BANK_ACCOUNTS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>PERSON</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MOBILES</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PERSON</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MAILS</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PERSON</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ADRESSES</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PERSON</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BANK_ACCOUNTS</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PERSON_ID</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>作为一个查询优化器，我必须找到处理数据最好的方法。但有 2 个问题：</p>
<ul>
<li>每个联接使用那种类型？
<ul>
<li>我有 3 种可选（哈希、合并、嵌套），同时可能用到 0, 1 或 2 个索引（不必说还有多种类型的索引）。</li>
</ul>
</li>
<li>按什么顺序执行联接？</li>
</ul>
<p>比如，下图显示了针对 4 个表仅仅 3 次联接，可能采用的执行计划：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503154121.png style=display:block;width:50% alt=NAME align=center> </div>
<p>现实世界的查询还会有其他关系运算符，像 OUTER JOIN, CROSS JOIN, GROUP BY, ORDER BY, PROJECTION, UNION, INTERSECT, DISTINCT … 这意味着更多的可能性。</p>
<p><strong>那么，数据库是如何处理的呢</strong>？</p>
<ul>
<li>动态规划</li>
<li>贪心算法</li>
<li>启发算法</li>
</ul>
<p>关系型数据库会尝试我刚刚提到的多种方法，<strong>优化器真正的工作是在有限时间里找到一个好的解决方案</strong>。但多数时候，优化器找到的不是最佳的方案，而是一个『不错』的。</p>
<h5 id=动态规划>动态规划</h5>
<blockquote>
<p>对于小规模的查询，采取粗暴的方式是有可能的。但是为了让中等规模的查询也能采取粗暴的方式，我们有办法避免不必要的计算，这就是动态规划。</p>
</blockquote>
<p>这几个字背后的理念是，很多执行计划是非常相似的。看看下图这几种计划：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503154314.png style=display:block;width:50% alt=NAME align=center> </div>
<p>它们都有相同的子树（A JOIN B），所以，不必在每个计划中计算这个子树的成本，计算一次，保存结果，当再遇到这个子树时重用。用更正规的说法，我们面对的是个重叠问题。为了避免对部分结果的重复计算，我们使用记忆法。</p>
<p>应用这一技术，我们不再有 (2*N)!/(N+1)! 的复杂度，而是“只有” 3^N。在之前 4 个JOIN 的例子里，这意味着将 336 次排序降为 81 次。如果是大一些的查询，比如 8 个 JOIN （其实也不是很大啦），就是将 57,657,600 次降为 6551 次。</p>
<p>针对大规模查询，你也可以用动态规划方法，但是要附加额外的规则（或者称为启发式算法）来减少可能性。</p>
<ul>
<li>
<p>如果我们仅分析一个特定类型的计划（例如左深树 left-deep tree，参考)，我们得到 n*2^n 而不是 3^n。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503154348.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
<li>
<p>如果我们加上逻辑规则来避免一些模式的计划（像『如果一个表有针对指定谓词的索引，就不要对表尝试合并联接，要对索引』），就会在不给最佳方案造成过多伤害的前提下，减少可能性的数量。【译者注：原文应该是有两处笔误： as=has, to=too】</p>
</li>
<li>
<p>如果我们在流程里增加规则（像『联接运算先于其他所有的关系运算』），也能减少大量的可能性。</p>
</li>
</ul>
<h5 id=贪心算法>贪心算法</h5>
<blockquote>
<p>但是，优化器面对一个非常大的查询，或者为了尽快找到答案（然而查询速度就快不起来了），会应用另一种算法，叫贪婪算法。</p>
</blockquote>
<p>原理是按照一个规则（或启发）以渐进的方式制定查询计划。在这个规则下，贪婪算法逐步寻找最佳算法，先处理一条JOIN，接着每一步按照同样规则加一条新的JOIN。</p>
<p>我们来看个简单的例子。比如一个针对5张表（A,B,C,D,E）4次JOIN 的查询，为了简化我们把嵌套JOIN作为可能的联接方式，按照『使用最低成本的联接』规则。</p>
<ul>
<li>直接从 5 个表里选一个开始（比如 A）</li>
<li>计算每一个与 A 的联接（A 作为内关系或外关系）</li>
<li>发现 “A JOIN B” 成本最低</li>
<li>计算每一个与 “A JOIN B” 的结果联接的成本（“A JOIN B” 作为内关系或外关系）</li>
<li>发现 “(A JOIN B) JOIN C” 成本最低</li>
<li>计算每一个与 “(A JOIN B) JOIN C” 的结果联接的成本</li>
<li>……</li>
<li>最后确定执行计划 “( ( (A JOIN B) JOIN C) JOIN D ) JOIN E )”</li>
</ul>
<p>因为我们是武断地从表 A 开始，我们可以把同样的算法用在 B，然后 C，然后 D, 然后 E。最后保留成本最低的执行计划。</p>
<p>顺便说一句，这个算法有个名字，叫『最近邻居算法』。</p>
<p>抛开细节不谈，只需一个良好的模型和一个 N<em>log(N) 复杂度的排序，问题就轻松解决了。这个算法的复杂度是 O(N</em>log(N)) ，对比一下完全动态规划的 O(3^N)。如果你有个20个联接的大型查询，这意味着 26 vs 3,486,784,401 ，天壤之别！</p>
<p>这个算法的问题是，我们做的假设是：找到 2 个表的最佳联接方法，保留这个联接结果，再联接下一个表，就能得到最低的成本。但是：</p>
<ul>
<li>即使在 A, B, C 之间，A JOIN B 可得最低成本</li>
<li>(A JOIN C) JOIN B 也许比 (A JOIN B) JOIN C 更好。</li>
</ul>
<p>为了改善这一状况，你可以多次使用基于不同规则的贪心算法，并保留最佳的执行计划。</p>
<h5 id=查询计划缓存>查询计划缓存</h5>
<p>由于创建查询计划是耗时的，大多数据库把计划保存在查询计划缓存，来避免重复计算。这个话题比较大，因为数据库需要知道什么时候更新过时的计划。办法是设置一个上限，如果一个表的统计变化超过了上限，关于该表的查询计划就从缓存中清除。</p>
<h3 id=查询执行器>查询执行器</h3>
<p>在这个阶段，我们有了一个优化的执行计划，再编译为可执行代码。然后，如果有足够资源（内存，CPU），查询执行器就会执行它。计划中的操作符 (JOIN, SORT BY …) 可以顺序或并行执行，这取决于执行器。为了获得和写入数据，查询执行器与数据管理器交互，本文下一部分来讨论数据管理器。</p>
<h2 id=数据管理器-1>数据管理器</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503154627.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在这一步，查询管理器执行了查询，需要从表和索引获取数据，于是向数据管理器提出请求。但是有 2 个问题：</p>
<ul>
<li>关系型数据库使用事务模型，所以，当其他人在同一时刻使用或修改数据时，你无法得到这部分数据。</li>
<li>数据提取是数据库中速度最慢的操作，所以数据管理器需要足够聪明地获得数据并保存在内存缓冲区内。</li>
</ul>
<p>在这一部分，我们看看关系型数据库是如何处理这两个问题的。</p>
<h3 id=缓存管理器>缓存管理器</h3>
<p>前文已经说过，数据库的主要瓶颈是磁盘 I/O。为了提高性能，现代数据库使用缓存管理器。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503154658.png style=display:block;width:50% alt=NAME align=center> </div>
<p>查询执行器不会直接从文件系统拿数据，而是向缓存管理器要。缓存管理器有一个内存缓存区，叫做缓冲池，从内存读取数据显著地提升数据库性能。对此很难给出一个数量级，因为这取决于你需要的是哪种操作：</p>
<ul>
<li>顺序访问（比如：全扫描） vs 随机访问（比如：按照row id访问）</li>
<li>读还是写</li>
</ul>
<p>以及数据库使用的磁盘类型：</p>
<ul>
<li>7.2k/10k/15k rpm的硬盘</li>
<li>SSD</li>
<li>RAID 1/5/…</li>
</ul>
<p>要我说，内存比磁盘要快100到10万倍。然而，这导致了另一个问题（数据库总是这样…)，缓存管理器需要在查询执行器使用数据之前得到数据，否则查询管理器不得不等待数据从缓慢的磁盘中读出来。</p>
<h4 id=预读>预读</h4>
<p>这个问题叫预读。查询执行器知道它将需要什么数据，因为它了解整个查询流，而且通过统计也了解磁盘上的数据。过程是这样的：</p>
<ul>
<li>当查询执行器处理它的第一批数据时，会告诉缓存管理器预先装载第二批数据</li>
<li>当开始处理第二批数据时，告诉缓存管理器预先装载第三批数据，并且告诉缓存管理器第一批可以从缓存里清掉了。</li>
<li>……</li>
</ul>
<p>缓存管理器在缓冲池里保存所有的这些数据。为了确定一条数据是否有用，缓存管理器给缓存的数据添加了额外的信息（叫闩锁）。</p>
<p>有时查询执行器不知道它需要什么数据，有的数据库也不提供这个功能。相反，它们使用一种推测预读法（比如：如果查询执行器想要数据1、3、5，它不久后很可能会要 7、9、11），或者顺序预读法（这时候缓存管理器只是读取一批数据后简单地从磁盘加载下一批连续数据）。</p>
<p>为了监控预读的工作状况，现代数据库引入了一个度量叫缓冲/缓存命中率，用来显示请求的数据在缓存中找到而不是从磁盘读取的频率。</p>
<p>注：糟糕的缓存命中率不总是意味着缓存工作状态不佳。</p>
<p>缓冲只是容量有限的内存空间，因此，为了加载新的数据，它需要移除一些数据。加载和清除缓存需要一些磁盘和网络I/O的成本。如果你有个经常执行的查询，那么每次都把查询结果加载然后清除，效率就太低了。现代数据库用缓冲区置换策略来解决这个问题。</p>
<h4 id=缓冲区置换>缓冲区置换</h4>
<blockquote>
<p>多数现代数据库(至少 SQL Server, MySQL, Oracle 和 DB2)使用 LRU 算法。</p>
</blockquote>
<p>LRU代表最近最少使用（Least Recently Used）算法，背后的原理是：在缓存里保留的数据是最近使用的，所以更有可能再次使用。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503154947.png style=display:block;width:50% alt=NAME align=center> </div>
<p>为了更好的理解，我假设缓冲区里的数据没有被闩锁锁住（就是说是可以被移除的）。在这个简单的例子里，缓冲区可以保存 3 个元素：</p>
<ul>
<li>1：缓存管理器（简称CM）使用数据1，把它放入空的缓冲区</li>
<li>2：CM使用数据4，把它放入半载的缓冲区</li>
<li>3：CM使用数据3，把它放入半载的缓冲区</li>
<li>4：CM使用数据9，缓冲区满了，所以数据1被清除，因为它是最后一个最近使用的，数据9加入到缓冲区</li>
<li>5：CM使用数据4，数据4已经在缓冲区了，所以它再次成为第一个最近使用的。</li>
<li>6：CM使用数据1，缓冲区满了，所以数据9被清除，因为它是最后一个最近使用的，数据1加入到缓冲区</li>
<li>……</li>
</ul>
<p>这个算法效果很好，但是有些限制。<strong>如果对一个大表执行全表扫描怎么办</strong>？换句话说，当表/索引的大小超出缓冲区会发生什么？使用这个算法会清除之前缓存内所有的数据，而且全扫描的数据很可能只使用一次。</p>
<h4 id=缓冲区置换改进>缓冲区置换：改进</h4>
<p>为了防止这个现象，有些数据库增加了特殊的规则，比如Oracle文档中的描述：</p>
<blockquote>
<p>『对非常大的表来说，数据库通常使用直接路径来读取，即直接加载区块，来避免填满缓冲区。对于中等大小的表，数据库可以使用直接读取或缓存读取。如果选择缓存读取，数据库把区块置于LRU的尾部，防止清空当前缓冲区。』</p>
</blockquote>
<p>还有一些可能，比如使用高级版本的LRU，叫做 LRU-K。例如，SQL Server 使用 LRU-2。</p>
<p>这个算法的原理是把更多的历史记录考虑进来。简单LRU（也就是 LRU-1），只考虑最后一次使用的数据。LRU-K呢：</p>
<ul>
<li>考虑数据最后第K次使用的情况</li>
<li>数据使用的次数加进了权重</li>
<li>一批新数据加载进入缓存，旧的但是经常使用的数据不会被清除（因为权重更高）</li>
<li>但是这个算法不会保留缓存中不再使用的数据</li>
<li>所以数据如果不再使用，权重值随着时间推移而降低</li>
</ul>
<p>计算权重是需要成本的，所以SQL Server只是使用 K=2，这个值性能不错而且额外开销可以接受。</p>
<h4 id=其他算法>其他算法</h4>
<p>当然还有其他管理缓存的算法，比如：</p>
<ul>
<li>2Q（类LRU-K算法）</li>
<li>CLOCK（类LRU-K算法）</li>
<li>MRU（最新使用的算法，用LRU同样的逻辑但不同的规则）</li>
<li>LRFU（Least Recently and Frequently Used，最近最少使用最近最不常用）</li>
<li>……</li>
</ul>
<h4 id=写缓冲区>写缓冲区</h4>
<p>我只探讨了读缓存 —— 在使用之前预先加载数据。用来保存数据、成批刷入磁盘，而不是逐条写入数据从而造成很多单次磁盘访问。</p>
<p>要记住，<strong>缓冲区保存的是页（最小的数据单位）而不是行（逻辑上/人类习惯的观察数据的方式）</strong>。缓冲池内的页如果被修改了但还没有写入磁盘，就是脏页。有很多算法来决定写入脏页的最佳时机，但这个问题与事务的概念高度关联，下面我们就谈谈事务。</p>
<h3 id=事务管理器>事务管理器</h3>
<p>最后但同样重要的，是事务管理器，我们将看到这个进程是如何保证每个查询在自己的事务内执行的。但开始之前，我们需要理解ACID事务的概念。</p>
<p>一个ACID事务是一个工作单元，它要保证4个属性：</p>
<ul>
<li>原子性（Atomicity）: 事务『要么全部完成，要么全部取消』，即使它持续运行10个小时。如果事务崩溃，状态回到事务之前（事务回滚）。</li>
<li>一致性（Consistency）: 只有合法的数据（依照关系约束和函数约束）能写入数据库，一致性与原子性和隔离性有关。</li>
<li>隔离性（Isolation）: 如果2个事务 A 和 B 同时运行，事务 A 和 B 最终的结果是相同的，不管 A 是结束于 B 之前/之后/运行期间。</li>
<li>持久性（Durability）: 一旦事务提交（也就是成功执行）,不管发生什么（崩溃或者出错），数据要保存在数据库中。</li>
</ul>
<p>在同一个事务内，你可以运行多个SQL查询来读取、创建、更新和删除数据。当两个事务使用相同的数据，麻烦就来了。经典的例子是从账户A到账户B的汇款。假设有2个事务：</p>
<ul>
<li>事务1（T1）从账户A取出100美元给账户B</li>
<li>事务2（T2）从账户A取出50美元给账户B</li>
</ul>
<p>我们回来看看ACID属性：</p>
<ul>
<li>原子性确保不管 T1 期间发生什么（服务器崩溃、网络中断…），你不能出现账户A 取走了100美元但没有给账户B 的现象（这就是数据不一致状态）。</li>
<li>隔离性确保如果 T1 和 T2 同时发生，最终A将减少150美元，B将得到150美元，而不是其他结果，比如因为 T2 部分抹除了 T1 的行为，A减少150美元而B只得到50美元（这也是不一致状态）。</li>
<li>持久性确保如果 T1 刚刚提交，数据库就发生崩溃，T1 不会消失得无影无踪。</li>
<li>一致性确保钱不会在系统内生成或灭失。</li>
</ul>
<h3 id=并发控制>并发控制</h3>
<p>确保隔离性、一致性和原子性的真正问题是<strong>对相同数据的写操作（增、更、删）</strong>：</p>
<ul>
<li>如果所有事务只是读取数据，它们可以同时工作，不会更改另一个事务的行为。</li>
<li>如果（至少）有一个事务在修改其他事务读取的数据，数据库需要找个办法对其它事务隐藏这种修改。而且，它还需要确保这个修改操作不会被另一个看不到这些数据修改的事务擦除。</li>
</ul>
<p>这个问题叫<strong>并发控制</strong>。</p>
<p>最简单的解决办法是依次执行每个事务（即顺序执行），但这样就完全没有伸缩性了，在一个多处理器/多核服务器上只有一个核心在工作，效率很低。</p>
<ul>
<li>理想的办法是，每次一个事务创建或取消时：</li>
<li>监控所有事务的所有操作</li>
<li>检查是否2个（或更多）事务的部分操作因为读取/修改相同的数据而存在冲突</li>
<li>重新编排冲突事务中的操作来减少冲突的部分</li>
<li>按照一定的顺序执行冲突的部分（同时非冲突事务仍然在并发运行）</li>
<li>考虑事务有可能被取消</li>
</ul>
<p>用更正规的说法，这是对冲突的调度问题。更具体点儿说，这是个非常困难而且CPU开销很大的优化问题。企业级数据库无法承担等待几个小时，来寻找每个新事务活动最好的调度，因此就使用不那么理想的方式以避免更多的时间浪费在解决冲突上。</p>
<h3 id=锁管理器>锁管理器</h3>
<blockquote>
<p>为了解决这个问题，多数数据库使用<strong>锁</strong>和/或<strong>数据版本控制</strong>。这是个很大的话题，我会集中探讨锁，和一点点数据版本控制。</p>
</blockquote>
<h4 id=悲观锁>悲观锁</h4>
<h4 id=悲观锁-1>悲观锁</h4>
<p>原理是：</p>
<ul>
<li>如果一个事务需要一条数据,它就把数据锁住</li>
<li>如果另一个事务也需要这条数据, 它就必须要等第一个事务释放这条数据</li>
</ul>
<p>这个锁叫<strong>排他锁</strong>。</p>
<p>但是对一个仅仅读取数据的事务使用排他锁非常昂贵，因为这会迫使其它只需要读取相同数据的事务等待。因此就有了另一种锁，<strong>共享锁</strong>。</p>
<p><strong>共享锁是这样的</strong>：</p>
<ul>
<li>如果一个事务只需要读取数据A, 它会给数据A加上『共享锁』并读取</li>
<li>如果第二个事务也需要仅仅读取数据A, 它会给数据A加上『共享锁』并读取</li>
<li>如果第三个事务需要修改数据A, 它会给数据A加上『排他锁』，但是必须等待另外两个事务释放它们的共享锁。</li>
</ul>
<p>同样的，如果一块数据被加上排他锁，一个只需要读取该数据的事务必须等待排他锁释放才能给该数据加上共享锁。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503155723.png style=display:block;width:50% alt=NAME align=center> </div>
<p>锁管理器是添加和释放锁的进程，在内部用一个哈希表保存锁信息（关键字是被锁的数据），并且了解每一块数据是：</p>
<ul>
<li>被哪个事务加的锁</li>
<li>哪个事务在等待数据解锁</li>
</ul>
<h4 id=死锁>死锁</h4>
<p>但是使用锁会导致一种情况，2个事务永远在等待一块数据：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503155747.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在本图中：</p>
<ul>
<li>事务A 给 数据1 加上排他锁并且等待获取数据2</li>
<li>事务B 给 数据2 加上排他锁并且等待获取数据1</li>
</ul>
<p>这叫<strong>死锁</strong>。</p>
<p>在死锁发生时，锁管理器要选择取消（回滚）一个事务，以便消除死锁。这可是个艰难的决定：</p>
<ul>
<li>杀死数据修改量最少的事务（这样能减少回滚的成本）？</li>
<li>杀死持续时间最短的事务，因为其它事务的用户等的时间更长？</li>
<li>杀死能用更少时间结束的事务（避免可能的资源饥荒）？</li>
<li>一旦发生回滚，有多少事务会受到回滚的影响？</li>
</ul>
<p>在作出选择之前，锁管理器需要检查是否有死锁存在。</p>
<p>哈希表可以看作是个图表（见上文图），图中出现循环就说明有死锁。由于检查循环是昂贵的（所有锁组成的图表是很庞大的），经常会通过简单的途径解决：<strong>使用超时设定</strong>。如果一个锁在超时时间内没有加上，那事务就进入死锁状态。</p>
<p>锁管理器也可以在加锁之前检查该锁会不会变成死锁，但是想要完美的做到这一点还是很昂贵的。因此这些预检经常设置一些基本规则。</p>
<h4 id=两段锁>两段锁</h4>
<blockquote>
<p>实现纯粹的隔离最简单的方法是：事务开始时获取锁，结束时释放锁。就是说，事务开始前必须等待确保自己能加上所有的锁，当事务结束时释放自己持有的锁。这是行得通的，但是为了等待所有的锁，大量的时间被浪费了。</p>
</blockquote>
<p>更快的方法是<strong>两段锁协议</strong>（Two-Phase Locking Protocol，2PC，由 DB2 和 SQL Server使用），在这里，事务分为两个阶段：</p>
<ul>
<li><strong>成长阶段</strong>：事务可以获得锁，但不能释放锁。</li>
<li><strong>收缩阶段</strong>：事务可以释放锁（对于已经处理完而且不会再次处理的数据），但不能获得新锁。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503155901.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这两条简单规则背后的过程是：</p>
<ul>
<li>释放不再使用的锁，来降低其它事务的等待时间</li>
<li>防止发生这类情况：事务最初获得的数据，在事务开始后被修改，当事务重新读取该数据时发生不一致。</li>
</ul>
<p>这个规则可以很好地工作，但有个例外：如果修改了一条数据、释放了关联的锁后，事务被取消（回滚），而另一个事务读到了修改后的值，但最后这个值却被回滚。为了避免这个问题，<strong>所有独占锁必须在事务结束时释放</strong>。</p>
<h4 id=版本控制>版本控制</h4>
<blockquote>
<p>当然了，真实的数据库使用更复杂的系统，涉及到更多类型的锁（比如意向锁，intention locks）和更多的粒度（行级锁、页级锁、分区锁、表锁、表空间锁），但是思路是相同的。</p>
</blockquote>
<p>我只探讨纯粹基于锁的方法，<strong>数据版本控制是解决这个问题的另一个方法</strong>。</p>
<p>版本控制是这样的：</p>
<ul>
<li>每个事务可以在相同时刻修改相同的数据</li>
<li>每个事务有自己的数据拷贝（或者叫版本）</li>
<li>如果2个事务修改相同的数据，只接受一个修改，另一个将被拒绝，相关的事务回滚（或重新运行）</li>
</ul>
<p>这将提高性能，因为：</p>
<ul>
<li>读事务不会阻塞写事务</li>
<li>写事务不会阻塞读</li>
<li>没有『臃肿缓慢』的锁管理器带来的额外开销</li>
</ul>
<p>除了两个事务写相同数据的时候，数据版本控制各个方面都比锁表现得更好。只不过，你很快就会发现磁盘空间消耗巨大。</p>
<p><strong>数据版本控制和锁机制是两种不同的见解</strong>：乐观锁和悲观锁。两者各有利弊，完全取决于使用场景（读多还是写多）。</p>
<blockquote>
<p>一些数据库，比如DB2（直到版本 9.7）和 SQL Server（不含快照隔离）仅使用锁机制。其他的像PostgreSQL, MySQL 和 Oracle 使用锁和鼠标版本控制混合机制。</p>
</blockquote>
<h3 id=日志管理器>日志管理器</h3>
<p>我们已经知道，为了提升性能，数据库把数据保存在内存缓冲区内。但如果当事务提交时服务器崩溃，崩溃时还在内存里的数据会丢失，这破坏了事务的持久性。你可以把所有数据都写在磁盘上，但是如果服务器崩溃，最终数据可能只有部分写入磁盘，这破坏了事务的原子性。</p>
<p><strong>事务作出的任何修改必须是或者撤销，或者完成</strong>。</p>
<p>有 2 个办法解决这个问题：</p>
<ul>
<li><strong>影子副本/页（Shadow copies/pages）</strong>：每个事务创建自己的数据库副本（或部分数据库的副本），并基于这个副本来工作。一旦出错，这个副本就被移除；一旦成功，数据库立即使用文件系统的一个把戏，把副本替换到数据中，然后删掉『旧』数据。</li>
<li><strong>事务日志（Transaction log）</strong>：事务日志是一个存储空间，在每次写盘之前，数据库在事务日志中写入一些信息，这样当事务崩溃或回滚，数据库知道如何移除或完成尚未完成的事务。</li>
</ul>
<h4 id=wal预写式日志>WAL（预写式日志）</h4>
<blockquote>
<p>影子副本/页在运行较多事务的大型数据库时制造了大量磁盘开销，所以现代数据库使用<strong>事务日志</strong>。事务日志必须保存在<strong>稳定的存储</strong>上，我不会深挖存储技术，但至少RAID磁盘是必须的，以防磁盘故障。</p>
</blockquote>
<p>多数数据库（至少是Oracle,SQL Server,DB2,PostgreSQL, MySQL 和SQLite) 使用预写日志协议（Write-Ahead Logging protocol ，WAL）来处理事务日志。WAL协议有 3 个规则：</p>
<ul>
<li>每个对数据库的修改都产生一条日志记录，在数据写入磁盘之前日志记录必须写入事务日志。</li>
<li>日志记录必须按顺序写入；记录 A 发生在记录 B 之前，则 A 必须写在 B 之前。</li>
<li>当一个事务提交时，在事务成功之前，提交顺序必须写入到事务日志。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503160352.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这个工作由日志管理器完成。简单的理解就是，日志管理器处于缓存管理器（cache manager）和数据访问管理器（data access manager，负责把数据写入磁盘）之间，每个 update / delete / create / commit / rollback 操作在写入磁盘之前先写入事务日志。这个过程并不简单，原因在于<strong>如何找到写日志的同时保持良好的性能的方法</strong>，如果事务日志写得太慢，整体都会慢下来。</p>
<h4 id=aries>ARIES</h4>
<blockquote>
<p>1992年，IBM 研究人员『发明』了WAL的增强版，叫 ARIES。ARIES 或多或少地在现代数据库中使用，逻辑未必相同，但AIRES背后的概念无处不在。ARIES 代表『数据库恢复原型算法』（Algorithms forRecovery andIsolationExploitingSemantics）。</p>
</blockquote>
<p>这个技术要达到一个双重目标：</p>
<ul>
<li>写日志的同时保持良好性能</li>
<li>快速和可靠的数据恢复</li>
</ul>
<p>有多个原因让数据库不得不回滚事务：</p>
<ul>
<li>因为用户取消</li>
<li>因为服务器或网络故障</li>
<li>因为事务破坏了数据库完整性（比如一个列有唯一性约束而事务添加了重复值）</li>
<li>因为死锁</li>
</ul>
<h4 id=日志内容>日志内容</h4>
<blockquote>
<p>有时候（比如网络出现故障），数据库可以恢复事务。这怎么可能呢？为了回答这个问题，我们需要了解日志里保存的信息。</p>
</blockquote>
<p>事务的<strong>每一个操作（增/删/改）产生一条日志</strong>，由如下内容组成：</p>
<ul>
<li>LSN：一个唯一的日志序列号（Log Sequence Number）。LSN是按时间顺序分配的，这意味着如果操作 A 先于操作 B，log A 的 LSN 要比 log B 的 LSN 小。</li>
<li>TransID：产生操作的事务ID。</li>
<li>PageID：被修改的数据在磁盘上的位置。磁盘数据的最小单位是页，所以数据的位置就是它所处页的位置。</li>
<li>PrevLSN：同一个事务产生的上一条日志记录的链接。</li>
<li>UNDO：取消本次操作的方法。比如，如果操作是一次更新，UNDO将或者保存元素更新前的值/状态（物理UNDO），或者回到原来状态的反向操作（<strong>逻辑UNDO</strong>, 只使用逻辑UNDO，因为处理物理UNDO太过混乱了)。</li>
<li>REDO：重复本次操作的方法。 同样的，有 2 种方法：或者保存操作后的元素值/状态，或者保存操作本身以便重复。</li>
<li>…：（供您参考，一个 ARIES 日志还有 2 个字段：UndoNxtLSN 和 Type）。</li>
</ul>
<p>磁盘上每个页（保存数据的，不是保存日志的）都记录着最后一个修改该数据操作的LSN。</p>
<blockquote>
<p>注：据我所知，只有 PostgreSQL 没有使用UNDO，而是用一个垃圾回收服务来删除旧版本的数据。这个跟 PostgreSQL 对数据版本控制的实现有关。</p>
</blockquote>
<p>为了更好的说明这一点，这有一个简单的日志记录演示图，是由查询 “<code>UPDATE FROM PERSON SET AGE = 18;</code>” 产生的:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503160551.png style=display:block;width:50% alt=NAME align=center> </div>
<p>每条日志都有一个唯一的LSN，链接在一起的日志属于同一个事务。日志按照时间顺序链接（链接列表的最后一条日志是最后一个操作产生的）。</p>
<h4 id=日志缓冲区>日志缓冲区</h4>
<blockquote>
<p>为了防止写日志成为主要的瓶颈，数据库使用了日志缓冲区。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503160636.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当查询执行器要求做一次修改：</p>
<ol>
<li>
<p>缓存管理器将修改存入自己的缓冲区；</p>
</li>
<li>
<p>日志管理器将相关的日志存入自己的缓冲区；</p>
</li>
<li>
<p>到了这一步，查询执行器认为操作完成了（因此可以请求做另一次修改）；</p>
</li>
<li>
<p>接着（不久以后）日志管理器把日志写入事务日志，什么时候写日志由某算法来决定。</p>
</li>
<li>
<p>接着（不久以后）缓存管理器把修改写入磁盘，什么时候写盘由某算法来决定。</p>
</li>
</ol>
<p><strong>当事务提交，意味着事务每一个操作的5个步骤都完成了</strong>。写事务日志是很快的，因为它只是『在事务日志某处增加一条日志』；而数据写盘就更复杂了，因为要用『能够快速读取的方式写入数据』。</p>
<h4 id=steal-和-force-策略>STEAL 和 FORCE 策略</h4>
<blockquote>
<p>出于性能方面的原因，<strong>第 5 步有可能在提交之后完成</strong>，因为一旦发生崩溃，还有可能用REDO日志恢复事务。这叫做 <strong>NO-FORCE策略</strong>。</p>
</blockquote>
<p>数据库可以选择FORCE策略（比如第 5 步在提交之前必须完成）来降低恢复时的负载。</p>
<p>另一个问题是，<strong>要选择数据是一步步的写入（STEAL策略），还是缓冲管理器需要等待提交命令来一次性全部写入（NO-STEAL策略）</strong>。选择STEAL还是NO-STEAL取决于你想要什么：快速写入但是从 UNDO 日志恢复缓慢，还是快速恢复。</p>
<p>下面是这些策略对恢复的影响：</p>
<ul>
<li><strong>STEAL/NO-FORCE 需要 UNDO 和 REDO: 性能高</strong>，但是日志和恢复过程更复杂 (比如 ARIES)。多数数据库选择这个策略。 注：这是我从多个学术论文和教程里看到的，但并没有看到官方文档里显式说明这一点。</li>
<li>STEAL/ FORCE 只需要 UNDO.</li>
<li>NO-STEAL/NO-FORCE 只需要 REDO.</li>
<li>NO-STEAL/FORCE 什么也不需要: 性能最差，而且需要巨大的内存。</li>
</ul>
<h4 id=关于恢复>关于恢复</h4>
<blockquote>
<p>Ok，有了不错的日志，我们来用用它们！</p>
</blockquote>
<p>假设新来的实习生让数据库崩溃了，你重启了数据库，恢复过程开始了。</p>
<p>ARIES从崩溃中恢复有三个阶段：</p>
<ul>
<li>
<ol>
<li><strong>分析阶段</strong>：恢复进程读取全部事务日志，来重建崩溃过程中所发生事情的时间线，决定哪个事务要回滚（所有未提交的事务都要回滚）、崩溃时哪些数据需要写盘。</li>
</ol>
</li>
<li>
<ol start=2>
<li><strong>Redo阶段</strong>：这一关从分析中选中的一条日志记录开始，使用 REDO 来将数据库恢复到崩溃之前的状态。</li>
</ol>
<ul>
<li>在REDO阶段，REDO日志按照时间顺序处理（使用LSN）。</li>
<li>对每一条日志，恢复进程需要读取包含数据的磁盘页LSN。</li>
<li>如果LSN（磁盘页）>= LSN（日志记录），说明数据已经在崩溃前写到磁盘（但是值已经被日志之后、崩溃之前的某个操作覆盖），所以不需要做什么。</li>
<li>如果LSN（磁盘页）&lt; LSN（日志记录），那么磁盘上的页将被更新。</li>
<li>即使将被回滚的事务，REDO也是要做的，因为这样简化了恢复过程（但是我相信现代数据库不会这么做的）。</li>
</ul>
</li>
<li>
<ol start=3>
<li><strong>Undo阶段</strong>：这一阶段回滚所有崩溃时未完成的事务。回滚从每个事务的最后一条日志开始，并且按照时间倒序处理UNDO日志（使用日志记录的PrevLSN）。</li>
</ol>
</li>
</ul>
<p>恢复过程中，事务日志必须留意恢复过程的操作，以便写入磁盘的数据与事务日志相一致。一个解决办法是移除被取消的事务产生的日志记录，但是这个太困难了。相反，ARIES在事务日志中记录补偿日志，来逻辑上删除被取消的事务的日志记录。</p>
<p>当事务被『手工』取消，或者被锁管理器取消（为了消除死锁），或仅仅因为网络故障而取消，那么分析阶段就不需要了。对于哪些需要 REDO 哪些需要 UNDO 的信息在 2 个内存表中：</p>
<ul>
<li>事务表（保存当前所有事务的状态）</li>
<li>脏页表（保存哪些数据需要写入磁盘）</li>
</ul>
<p>当新的事务产生时，这两个表由缓存管理器和事务管理器更新。因为是在内存中，当数据库崩溃时它们也被破坏掉了。</p>
<p>分析阶段的任务就是在崩溃之后，用事务日志中的信息重建上述的两个表。为了加快分析阶段，ARIES提出了一个概念：<strong>检查点（check point）</strong>，就是不时地把事务表和脏页表的内容，还有此时最后一条LSN写入磁盘。那么在分析阶段当中，只需要分析这个LSN之后的日志即可。</p>
<h2 id=最后>最后</h2>
<p>如果你想很好地了解数据库，我推荐这篇研究论文：<a href=https://dsf.berkeley.edu/papers/fntdb07-architecture.pdf>Architecture of a Database System</a>，对数据库有很好的介绍（共110页），而且非计算机专业人士也能读懂。</p>
<p>所以，当你不得不在问题多多的 NoSQL数据库和坚如磐石的关系型数据库之间抉择的时候，要三思而行。不要误会，某些 NoSQL数据库是很棒的，但是它们毕竟还年轻，只是解决了少量应用关注的一些特定问题。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5f440bea0444e267ba103fefcd6501d8>1.2 - CH02-设计理论</h1>
<blockquote>
<p>本节介绍如何将一个<strong>关系模型</strong>（基于表的数据模型）合理的转化为<strong>数据表</strong>和<strong>关系表</strong>，以及确定<strong>主外健</strong>的。这便是数据库设计理论基础，包括术语，函数依赖，范式等理论基础。</p>
</blockquote>
<h2 id=术语>术语</h2>
<p>关系模型是一种基于表的数据模型，以下为关系学生信息，该表有很多不足之处，本文研究内容就是如何改进它。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503161015.png style=display:block;width:50% alt=NAME align=center> </div>
<p>下面是一些重要术语：</p>
<ul>
<li><strong>属性（attribute）</strong>：列的名字，上图有学号、姓名、班级、兴趣爱好、班主任、课程、授课主任、分数。</li>
<li><strong>依赖（relation）</strong>：列属性间存在的某种联系。</li>
<li><strong>元组（tuple）</strong>：每一个行，如第二行 （1301，小明，13班，篮球，王老师，英语，赵英，70） 就是一个元组</li>
<li><strong>表（table）</strong>：由多个属性，以及众多元组所表示的各个实例组成。</li>
<li><strong>模式（schema）</strong>：这里我们指逻辑结构，如 学生信息（学号，姓名，班级，兴趣爱好，班主任，课程，授课主任，分数） 的笼统表述。</li>
<li><strong>域（domain）</strong>：数据类型，如string、integer等，上图中每一个属性都有它的数据类型（即域）。</li>
<li><strong>键（key）</strong>：由关系的一个或多个属性组成，任意两个键相同的元组，所有属性都相同。需要保证表示键的属性最少。一个关系可以存在好几种键，工程中一般从这些候选键中选出一个作为<strong>主键（primary key）</strong>。</li>
<li><strong>候选键（prime attribute）</strong>：由关系的一个或多个属性组成，候选键都具备键的特征，都有资格成为主键。</li>
<li><strong>超键（super key）</strong>：包含键的属性集合，无需保证属性集的最小化。每个键也是超键。可以认为是<strong>键的超集</strong>。</li>
<li><strong>外键（foreign key）</strong>：如果某一个关系A中的一个（组）属性是另一个关系B的键，则该（组）属性在A中称为外键。</li>
<li><strong>主属性（prime attribute）</strong>：所有候选键所包含的属性都是主属性。</li>
<li><strong>投影（projection）</strong>：选取特定的列，如将关系学生信息投影为学号、姓名即得到上表中仅包含学号、姓名的列</li>
<li><strong>选择（selection）</strong>：按照一定条件选取特定元组，如选择上表中分数>80的元组。</li>
<li><strong>笛卡儿积（交叉连接Cross join）</strong>：第一个关系每一行分别与第二个关系的每一行组合。</li>
<li><strong>自然连接（natural join）</strong>：第一个关系中每一行与第二个关系的每一行进行匹配，如果得到有交叉部分则合并，若无交叉部分则舍弃。</li>
<li><strong>连接（theta join）</strong>：即加上约束条件的笛卡儿积，先得到笛卡儿积，然后根据约束条件删除不满足的元组。</li>
<li><strong>外连接（outer join）</strong>：执行自然连接后，将舍弃的部分也加入，并且匹配失败处的属性用NULL代替。</li>
<li><strong>除法运算（division）</strong>：关系R除以关系S的结果为T，则T包含所有在R但不在S中的属性，且T的元组与S的元组的所有组合在R中。</li>
</ul>
<h2 id=函数依赖>函数依赖</h2>
<blockquote>
<p>通过函数依赖关系，来帮助你确定表中的合理主外健等；这里只是简介，有这么个概念就可以了，因为大多数情况你不用那些所谓的推倒关系，你也是可以凭借<strong>直觉</strong>设计出来的。</p>
</blockquote>
<p>记 A->B 表示 A 函数决定 B，也可以说 B 函数依赖于 A。</p>
<p>如果 {A1，A2，&mldr; ，An} 是关系的一个或多个属性的集合，该集合函数决定了关系的其它所有属性并且是最小的，那么该集合就称为键码。</p>
<p>对于 A->B，如果能找到 A 的真子集 A'，使得 A'-> B，那么 A->B 就是部分函数依赖，否则就是完全函数依赖。</p>
<p>对于 A->B，B->C，则 A->C 是一个传递函数依赖。</p>
<h2 id=异常>异常</h2>
<blockquote>
<p>不符合范式的关系，会产生很多异常，为了引出<strong>范式</strong>的内容。</p>
</blockquote>
<p>以下的学生课程关系的函数依赖为 Sno, Cname -> Sname, Sdept, Mname, Grade，键码为 {Sno, Cname}。也就是说，确定学生和课程之后，就能确定其它信息。</p>
<table>
<thead>
<tr>
<th style=text-align:center>Sno</th>
<th style=text-align:center>Sname</th>
<th style=text-align:center>Sdept</th>
<th style=text-align:center>Mname</th>
<th style=text-align:center>Cname</th>
<th style=text-align:center>Grade</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>学生-1</td>
<td style=text-align:center>学院-1</td>
<td style=text-align:center>院长-1</td>
<td style=text-align:center>课程-1</td>
<td style=text-align:center>90</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>学生-2</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
<td style=text-align:center>课程-2</td>
<td style=text-align:center>80</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>学生-2</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
<td style=text-align:center>课程-1</td>
<td style=text-align:center>100</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>学生-3</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
<td style=text-align:center>课程-2</td>
<td style=text-align:center>95</td>
</tr>
</tbody>
</table>
<p>不符合范式的关系，会产生很多异常，主要有以下四种异常:</p>
<ul>
<li>冗余数据: 例如 <code>学生-2</code> 出现了两次。</li>
<li>修改异常: 修改了一个记录中的信息，但是另一个记录中相同的信息却没有被修改。</li>
<li>删除异常: 删除一个信息，那么也会丢失其它信息。例如删除了 <code>课程-1</code> 需要删除第一行和第三行，那么 <code>学生-1</code> 的信息就会丢失。</li>
<li>插入异常: 例如想要插入一个学生的信息，如果这个学生还没选课，那么就无法插入。</li>
</ul>
<h2 id=范式>范式</h2>
<blockquote>
<p>范式理论是为了解决以上提到四种异常。</p>
</blockquote>
<p>高级别范式的依赖于低级别的范式，1NF 是最低级别的范式。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503161210.png style=display:block;width:50% alt=NAME align=center> </div>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/sql/sql-db-theory-concept.html</p>
<h3 id=1-第一范式-1nf>1. 第一范式 (1NF)</h3>
<p>属性不可分。</p>
<h3 id=2-第二范式-2nf>2. 第二范式 (2NF)</h3>
<p>每个非主属性完全函数依赖于键码。</p>
<p>可以通过分解来满足。</p>
<p><strong>分解前</strong></p>
<table>
<thead>
<tr>
<th style=text-align:center>Sno</th>
<th style=text-align:center>Sname</th>
<th style=text-align:center>Sdept</th>
<th style=text-align:center>Mname</th>
<th style=text-align:center>Cname</th>
<th style=text-align:center>Grade</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>学生-1</td>
<td style=text-align:center>学院-1</td>
<td style=text-align:center>院长-1</td>
<td style=text-align:center>课程-1</td>
<td style=text-align:center>90</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>学生-2</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
<td style=text-align:center>课程-2</td>
<td style=text-align:center>80</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>学生-2</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
<td style=text-align:center>课程-1</td>
<td style=text-align:center>100</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>学生-3</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
<td style=text-align:center>课程-2</td>
<td style=text-align:center>95</td>
</tr>
</tbody>
</table>
<p>以上学生课程关系中，{Sno, Cname} 为键码，有如下函数依赖:</p>
<ul>
<li>Sno -> Sname, Sdept</li>
<li>Sdept -> Mname</li>
<li>Sno, Cname-> Grade</li>
</ul>
<p>Grade 完全函数依赖于键码，它没有任何冗余数据，每个学生的每门课都有特定的成绩。</p>
<p>Sname, Sdept 和 Mname 都部分依赖于键码，当一个学生选修了多门课时，这些数据就会出现多次，造成大量冗余数据。</p>
<p><strong>分解后</strong></p>
<p>关系-1</p>
<table>
<thead>
<tr>
<th style=text-align:center>Sno</th>
<th style=text-align:center>Sname</th>
<th style=text-align:center>Sdept</th>
<th style=text-align:center>Mname</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>学生-1</td>
<td style=text-align:center>学院-1</td>
<td style=text-align:center>院长-1</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>学生-2</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>学生-3</td>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
</tr>
</tbody>
</table>
<p>有以下函数依赖:</p>
<ul>
<li>Sno -> Sname, Sdept</li>
<li>Sdept -> Mname</li>
</ul>
<p>关系-2</p>
<table>
<thead>
<tr>
<th style=text-align:center>Sno</th>
<th style=text-align:center>Cname</th>
<th style=text-align:center>Grade</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>课程-1</td>
<td style=text-align:center>90</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>课程-2</td>
<td style=text-align:center>80</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>课程-1</td>
<td style=text-align:center>100</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>课程-2</td>
<td style=text-align:center>95</td>
</tr>
</tbody>
</table>
<p>有以下函数依赖:</p>
<ul>
<li>Sno, Cname -> Grade</li>
</ul>
<h3 id=3-第三范式-3nf>3. 第三范式 (3NF)</h3>
<p>非主属性不传递函数依赖于键码。</p>
<p>上面的 关系-1 中存在以下传递函数依赖:</p>
<ul>
<li>Sno -> Sdept -> Mname</li>
</ul>
<p>可以进行以下分解:</p>
<p>关系-11</p>
<table>
<thead>
<tr>
<th style=text-align:center>Sno</th>
<th style=text-align:center>Sname</th>
<th style=text-align:center>Sdept</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>学生-1</td>
<td style=text-align:center>学院-1</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>学生-2</td>
<td style=text-align:center>学院-2</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>学生-3</td>
<td style=text-align:center>学院-2</td>
</tr>
</tbody>
</table>
<p>关系-12</p>
<table>
<thead>
<tr>
<th style=text-align:center>Sdept</th>
<th style=text-align:center>Mname</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>学院-1</td>
<td style=text-align:center>院长-1</td>
</tr>
<tr>
<td style=text-align:center>学院-2</td>
<td style=text-align:center>院长-2</td>
</tr>
</tbody>
</table>
<blockquote>
<p>更多细节：<a href=https://blog.csdn.net/calcular/article/details/79332453>关系数据库设计理论</a></p>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a9b9d58ba7418e7426e97d813794b4a4>1.3 - CH03-设计流程</h1>
<blockquote>
<p><a href=https://www.pdai.tech/md/db/sql/sql-db-theory-design.html>https://www.pdai.tech/md/db/sql/sql-db-theory-design.html</a></p>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-17a8347e6e10342607180b4d34ede039>1.4 - CH04-核心知识</h1>
<h2 id=事务>事务</h2>
<h3 id=概念>概念</h3>
<p>事务指的是满足 ACID 特性的一组操作，可以通过 Commit 提交一个事务，也可以使用 Rollback 进行回滚。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503161528.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=acid>ACID</h3>
<ul>
<li>原子性：Atomicity
<ul>
<li>事务被视为不可分割的最小单元，事务的所有操作要么全部提交成功，要么全部失败回滚。</li>
<li>回滚可以用日志来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</li>
</ul>
</li>
<li>一致性：Consistency
<ul>
<li>数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。</li>
</ul>
</li>
<li>隔离性：Isolation
<ul>
<li>一个事务所做的修改在最终提交以前，对其它事务是不可见的。</li>
</ul>
</li>
<li>持久性：Durability
<ul>
<li>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</li>
<li>可以通过数据库备份和恢复来实现，在系统发生崩溃时，使用备份的数据库进行数据恢复。</li>
</ul>
</li>
</ul>
<p>事务的 ACID 特性概念简单，但不是很好理解，主要是因为这几个特性不是一种平级关系:</p>
<ul>
<li>只有满足一致性，事务的执行结果才是正确的。</li>
<li>在无并发的情况下，事务串行执行，隔离性一定能够满足。此时只要能满足原子性，就一定能满足一致性。</li>
<li>在并发的情况下，多个事务并行执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。</li>
<li>事务满足持久化是为了能应对数据库崩溃的情况。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503161752.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=autocommit>AUTOCOMMIT</h3>
<p>MySQL 默认采用自动提交模式。也就是说，如果不显式使用<code>START TRANSACTION</code>语句来开始一个事务，那么每个查询都会被当做一个事务自动提交。</p>
<h2 id=并发一致性>并发一致性</h2>
<p>在并发环境下，事务的隔离性很难保证，因此会出现很多并发一致性问题。</p>
<ul>
<li>
<p>产生并发不一致性问题主要原因是破坏了事务的隔离性，解决方法是通过并发控制来保证隔离性。</p>
</li>
<li>
<p>并发控制可以通过封锁来实现，但是封锁操作需要用户自己控制，相当复杂。</p>
</li>
<li>
<p>数据库管理系统提供了事务的隔离级别，让用户以一种更轻松的方式处理并发一致性问题。</p>
</li>
</ul>
<h3 id=丢失修改>丢失修改</h3>
<p>T1 和 T2 两个事务都对一个数据进行修改，T1 先修改，T2 随后修改，T2 的修改覆盖了 T1 的修改。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503161851.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=脏读>脏读</h3>
<p>T1 修改一个数据，T2 随后读取这个数据。如果 T1 撤销了这次修改，那么 T2 读取的数据是脏数据。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503161930.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=不可重复读>不可重复读</h3>
<p>T2 读取一个数据，T1 对该数据做了修改。如果 T2 再次读取这个数据，此时读取的结果和第一次读取的结果不同。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503161952.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=幻读>幻读</h3>
<p>T1 读取某个范围的数据，T2 在这个范围内插入新的数据，T1 再次读取这个范围的数据，此时读取的结果和和第一次读取的结果不同。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503162018.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=封锁>封锁</h2>
<h3 id=封锁粒度>封锁粒度</h3>
<p>MySQL 中提供了两种封锁粒度: <strong>行级锁以及表级锁</strong>。</p>
<ul>
<li>
<p>应该尽量只锁定需要修改的那部分数据，而不是所有的资源。</p>
<ul>
<li>锁定的数据量越少，发生锁争用的可能就越小，系统的并发程度就越高。</li>
</ul>
</li>
<li>
<p>但是加锁需要消耗资源，锁的各种操作(包括获取锁、释放锁、以及检查锁状态)都会增加系统开销。</p>
<ul>
<li>因此封锁粒度越小，系统开销就越大。</li>
</ul>
</li>
</ul>
<p>在选择封锁粒度时，需要在锁开销和并发程度之间做一个权衡。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503162201.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=封锁类型>封锁类型</h3>
<h4 id=读写锁>读写锁</h4>
<ul>
<li>排它锁(Exclusive)，简写为 X 锁，又称写锁。</li>
<li>共享锁(Shared)，简写为 S 锁，又称读锁。</li>
</ul>
<p>有以下两个规定:</p>
<ul>
<li>一个事务对数据对象 A 加了 X 锁，就可以对 A 进行读取和更新。加锁期间其它事务不能对 A 加任何锁。</li>
<li>一个事务对数据对象 A 加了 S 锁，可以对 A 进行读取操作，但是不能进行更新操作。加锁期间其它事务能对 A 加 S 锁，但是不能加 X 锁。</li>
</ul>
<p>锁的兼容关系如下:</p>
<table>
<thead>
<tr>
<th style=text-align:center>-</th>
<th style=text-align:center>X</th>
<th style=text-align:center>S</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>X</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
</tr>
<tr>
<td style=text-align:center>S</td>
<td style=text-align:center>×</td>
<td style=text-align:center>√</td>
</tr>
</tbody>
</table>
<h4 id=意向锁>意向锁</h4>
<p>使用意向锁(Intention Locks)可以更容易地支持多粒度封锁。</p>
<p>在存在行级锁和表级锁的情况下，事务 T 想要对表 A 加 X 锁，就需要先检测是否有其它事务对表 A 或者表 A 中的任意一行加了锁，那么就需要对表 A 的每一行都检测一次，这是非常耗时的。</p>
<p>意向锁在原来的 X/S 锁之上引入了 IX/IS，IX/IS 都是表锁，用来表示一个事务想要在表中的某个数据行上加 X 锁或 S 锁。有以下两个规定:</p>
<ul>
<li>一个事务在获得某个数据行对象的 S 锁之前，必须先获得表的 IS 锁或者更强的锁；</li>
<li>一个事务在获得某个数据行对象的 X 锁之前，必须先获得表的 IX 锁。</li>
</ul>
<p>通过引入意向锁，事务 T 想要对表 A 加 X 锁，只需要先检测是否有其它事务对表 A 加了 X/IX/S/IS 锁，如果加了就表示有其它事务正在使用这个表或者表中某一行的锁，因此事务 T 加 X 锁失败。</p>
<p>各种锁的兼容关系如下:</p>
<table>
<thead>
<tr>
<th style=text-align:center>-</th>
<th style=text-align:center>X</th>
<th style=text-align:center>IX</th>
<th style=text-align:center>S</th>
<th style=text-align:center>IS</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>X</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
</tr>
<tr>
<td style=text-align:center>IX</td>
<td style=text-align:center>×</td>
<td style=text-align:center>√</td>
<td style=text-align:center>×</td>
<td style=text-align:center>√</td>
</tr>
<tr>
<td style=text-align:center>S</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
<td style=text-align:center>√</td>
<td style=text-align:center>√</td>
</tr>
<tr>
<td style=text-align:center>IS</td>
<td style=text-align:center>×</td>
<td style=text-align:center>√</td>
<td style=text-align:center>√</td>
<td style=text-align:center>√</td>
</tr>
</tbody>
</table>
<p>解释如下:</p>
<ul>
<li>任意 IS/IX 锁之间都是兼容的，因为它们只是表示想要对表加锁，而不是真正加锁；</li>
<li>S 锁只与 S 锁和 IS 锁兼容，也就是说事务 T 想要对数据行加 S 锁，其它事务可以已经获得对表或者表中的行的 S 锁。</li>
</ul>
<h3 id=封锁协议>封锁协议</h3>
<h4 id=三级封锁协议>三级封锁协议</h4>
<p><strong>一级封锁协议</strong></p>
<p>事务 T 要修改数据 A 时必须加 X 锁，直到 T 结束才释放锁。</p>
<p>可以解决丢失修改问题，因为不能同时有两个事务对同一个数据进行修改，那么事务的修改就不会被覆盖。</p>
<table>
<thead>
<tr>
<th style=text-align:center>T1</th>
<th style=text-align:center>T2</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>lock-x(A)</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>read A=20</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>lock-x(A)</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>wait</td>
</tr>
<tr>
<td style=text-align:center>write A=19</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center>commit</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center>unlock-x(A)</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>obtain</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>read A=19</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>write A=21</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>commit</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>unlock-x(A)</td>
</tr>
</tbody>
</table>
<p><strong>二级封锁协议</strong></p>
<p>在一级的基础上，要求读取数据 A 时必须加 S 锁，读取完马上释放 S 锁。</p>
<p>可以解决读脏数据问题，因为如果一个事务在对数据 A 进行修改，根据 1 级封锁协议，会加 X 锁，那么就不能再加 S 锁了，也就是不会读入数据。</p>
<table>
<thead>
<tr>
<th style=text-align:center>T1</th>
<th style=text-align:center>T2</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>lock-x(A)</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>read A=20</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>write A=19</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>lock-s(A)</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>wait</td>
</tr>
<tr>
<td style=text-align:center>rollback</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center>A=20</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center>unlock-x(A)</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>obtain</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>read A=20</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>commit</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>unlock-s(A)</td>
</tr>
</tbody>
</table>
<p><strong>三级封锁协议</strong></p>
<p>在二级的基础上，要求读取数据 A 时必须加 S 锁，直到事务结束了才能释放 S 锁。</p>
<p>可以解决不可重复读的问题，因为读 A 时，其它事务不能对 A 加 X 锁，从而避免了在读的期间数据发生改变。</p>
<table>
<thead>
<tr>
<th style=text-align:center>T1</th>
<th style=text-align:center>T2</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>lock-s(A)</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center>read A=20</td>
<td style=text-align:center></td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>lock-x(A)</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>wait</td>
</tr>
<tr>
<td style=text-align:center>read A=20</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center>commit</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center>unlock-s(A)</td>
<td style=text-align:center>.</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>obtain</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>read A=20</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>write A=19</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>commit</td>
</tr>
<tr>
<td style=text-align:center></td>
<td style=text-align:center>unlock-X(A)</td>
</tr>
</tbody>
</table>
<h4 id=两段锁协议>两段锁协议</h4>
<p>加锁和解锁分为两个阶段进行。</p>
<p>可串行化调度是指，通过并发控制，使得并发执行的事务结果与某个串行执行的事务结果相同。</p>
<p>事务遵循两段锁协议是保证可串行化调度的充分条件。例如以下操作满足两段锁协议，它是可串行化调度。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>lock-x(A)...lock-s(B)...lock-s(C)...unlock(A)...unlock(C)...unlock(B)
</code></pre></div><p>但不是必要条件，例如以下操作不满足两段锁协议，但是它还是可串行化调度。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>lock-x(A)...unlock(A)...lock-s(B)...unlock(B)...lock-s(C)...unlock(C)
</code></pre></div><h3 id=mysql隐式显式锁定>MySQL：隐式/显式锁定</h3>
<p>MySQL 的 InnoDB 存储引擎采用两段锁协议，会根据隔离级别在需要的时候自动加锁，并且所有的锁都是在同一时刻被释放，这被称为隐式锁定。</p>
<p>InnoDB 也可以使用特定的语句进行显示锁定:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>In</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SHARE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MODE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=隔离级别>隔离级别</h2>
<ul>
<li>未提交读：Read Uncommitted
<ul>
<li>事务中的修改，即使没有提交，对其它事务也是可见的。</li>
</ul>
</li>
<li>提交读：Read Committed
<ul>
<li>一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。</li>
</ul>
</li>
<li>可重复读：Repeatable Read
<ul>
<li>保证在同一个事务中多次读取同样数据的结果是一样的。</li>
</ul>
</li>
<li>可串行化：Serializable
<ul>
<li>强制事务串行执行。</li>
</ul>
</li>
</ul>
<hr>
<table>
<thead>
<tr>
<th style=text-align:center>隔离级别</th>
<th style=text-align:center>脏读</th>
<th style=text-align:center>不可重复读</th>
<th style=text-align:center>幻影读</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>未提交读</td>
<td style=text-align:center>√</td>
<td style=text-align:center>√</td>
<td style=text-align:center>√</td>
</tr>
<tr>
<td style=text-align:center>提交读</td>
<td style=text-align:center>×</td>
<td style=text-align:center>√</td>
<td style=text-align:center>√</td>
</tr>
<tr>
<td style=text-align:center>可重复读</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
<td style=text-align:center>√</td>
</tr>
<tr>
<td style=text-align:center>可串行化</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
<td style=text-align:center>×</td>
</tr>
</tbody>
</table>
<h2 id=多版本并发控制>多版本并发控制</h2>
<p>多版本并发控制(Multi-Version Concurrency Control, MVCC)是 MySQL 的 InnoDB 存储引擎实现隔离级别的一种具体方式，用于实现提交读和可重复读这两种隔离级别。而未提交读隔离级别总是读取最新的数据行，无需使用 MVCC。可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。</p>
<h3 id=版本号>版本号</h3>
<ul>
<li>系统版本号: 是一个递增的数字，每开始一个新的事务，系统版本号就会自动递增。</li>
<li>事务版本号: 事务开始时的系统版本号。</li>
</ul>
<h3 id=隐藏的列>隐藏的列</h3>
<p>MVCC 在每行记录后面都保存着两个隐藏的列，用来存储两个版本号:</p>
<ul>
<li>创建版本号: 指示创建一个数据行的快照时的系统版本号；</li>
<li>删除版本号: 如果该快照的删除版本号大于当前事务版本号表示该快照有效，否则表示该快照已经被删除了。</li>
</ul>
<h3 id=undo-日志>Undo 日志</h3>
<p>MVCC 使用到的快照存储在 Undo 日志中，该日志通过回滚指针把一个数据行(Record)的所有快照连接起来。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503162944.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=实现过程>实现过程</h3>
<p>以下实现过程针对可重复读隔离级别。</p>
<p>当开始新一个事务时，该事务的版本号肯定会大于当前所有数据行快照的创建版本号，理解这一点很关键。</p>
<h4 id=1-select>1. SELECT</h4>
<p>多个事务必须读取到同一个数据行的快照，并且这个快照是距离现在最近的一个有效快照。但是也有例外，如果有一个事务正在修改该数据行，那么它可以读取事务本身所做的修改，而不用和其它事务的读取结果一致。</p>
<p>把没有对一个数据行做修改的事务称为 T，T 所要读取的数据行快照的创建版本号必须小于 T 的版本号，因为如果大于或者等于 T 的版本号，那么表示该数据行快照是其它事务的最新修改，因此不能去读取它。除此之外，T 所要读取的数据行快照的删除版本号必须大于 T 的版本号，因为如果小于等于 T 的版本号，那么表示该数据行快照是已经被删除的，不应该去读取它。</p>
<h4 id=2-insert>2. INSERT</h4>
<p>将当前系统版本号作为数据行快照的创建版本号。</p>
<h4 id=3-delete>3. DELETE</h4>
<p>将当前系统版本号作为数据行快照的删除版本号。</p>
<h4 id=4-update>4. UPDATE</h4>
<p>将当前系统版本号作为更新前的数据行快照的删除版本号，并将当前系统版本号作为更新后的数据行快照的创建版本号。可以理解为先执行 DELETE 后执行 INSERT。</p>
<h3 id=快照读与当前读>快照读与当前读</h3>
<h4 id=1-快照读>1. 快照读</h4>
<p>使用 MVCC 读取的是快照中的数据，这样可以减少加锁所带来的开销。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=2-当前读>2. 当前读</h4>
<p>读取的是最新的数据，需要加锁。以下第一个语句需要加 S 锁，其它都需要加 X 锁。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>lock</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>share</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mode</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>update</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>update</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=next-key-locks>Next-Key Locks</h2>
<p>Next-Key Locks 是 MySQL 的 InnoDB 存储引擎的一种锁实现。</p>
<p>MVCC 不能解决幻读的问题，Next-Key Locks 就是为了解决这个问题而存在的。在可重复读(REPEATABLE READ)隔离级别下，使用 MVCC + Next-Key Locks 可以解决幻读问题。</p>
<h3 id=record-locks>Record Locks</h3>
<p>锁定一个记录上的索引，而不是记录本身。</p>
<p>如果表没有设置索引，InnoDB 会自动在主键上创建隐藏的聚簇索引，因此 Record Locks 依然可以使用。</p>
<h3 id=gap-locks>Gap Locks</h3>
<p>锁定索引之间的间隙，但是不包含索引本身。例如当一个事务执行以下语句，其它事务就不能在 t.c 中插入 15。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>t</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BETWEEN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=next-key-locks-1>Next-Key Locks</h3>
<p>它是 Record Locks 和 Gap Locks 的结合，不仅锁定一个记录上的索引，也锁定索引之间的间隙。例如一个索引包含以下值: 10, 11, 13, and 20，那么就需要锁定以下区间:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000;font-weight:700>(</span><span style=color:#000>negative</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>infinity</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>positive</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>infinity</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-52b3784f2c0fc27209a7dfce796a520a>2 - SQL</h1>
</div>
<div class=td-content>
<h1 id=pg-6b3f5552bcb7e8d7e392d0c4f28a8929>2.1 - CH01-语法基础</h1>
<h2 id=开始>开始</h2>
<p>Schema 定义了数据如何存储、存储什么样的数据以及数据如何分解等信息，数据库和表都有模式。</p>
<p>主键的值不允许修改，也不允许复用(不能使用已经删除的主键值赋给新数据行的主键)。</p>
<p>SQL(Structured Query Language)，标准 SQL 由 ANSI 标准委员会管理，从而称为 ANSI SQL。各个 DBMS 都有自己的实现，如 PL/SQL、Transact-SQL 等。</p>
<p>SQL 语句不区分大小写，但是数据库表名、列名和值是否区分依赖于具体的 DBMS 以及配置。</p>
<p>SQL 支持以下三种注释:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>注释</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- 注释
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>/* 注释1
</span><span style=color:#8f5902;font-style:italic>   注释2 */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>数据库创建与使用:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>USE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=创建表>创建表</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>INT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUTO_INCREMENT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>col1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>INT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>col2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>VARCHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>col3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>DATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=修改表>修改表</h2>
<p>添加列</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ADD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>CHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>删除列</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLUMN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>删除表</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=插入>插入</h2>
<p>普通插入</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>val1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val2</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>插入检索出来的数据</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable1</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>将一个表的内容插入到一个新表</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>newtable</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=更新>更新</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=删除>删除</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>DELETE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>TRUNCATE TABLE</strong> 可以清空表，也就是删除所有行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>TRUNCATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>使用更新和删除操作时一定要用 WHERE 子句，不然会把整张表的数据都破坏。可以先用 SELECT 语句进行测试，防止错误删除。</p>
<h2 id=查询>查询</h2>
<h3 id=distinct>DISTINCT</h3>
<p>相同值只会出现一次。它作用于所有列，也就是说所有列的值都相同才算相同。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=limit>LIMIT</h3>
<p>限制返回的行数。可以有两个参数，第一个参数为起始行，从 0 开始；第二个参数为返回的总行数。</p>
<p>返回前 5 行:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>返回第 3 ~ 5 行:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=排序>排序</h2>
<ul>
<li><strong>ASC</strong> : 升序(默认)</li>
<li><strong>DESC</strong> : 降序</li>
</ul>
<p>可以按多个列进行排序，并且为每个列指定不同的排序方式:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ASC</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=过滤>过滤</h2>
<p>不进行过滤的数据非常大，导致通过网络传输了多余的数据，从而浪费了网络带宽。因此尽量使用 SQL 语句来过滤不必要的数据，而不是传输所有的数据到客户端中然后由客户端进行过滤。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>下表显示了 WHERE 子句可用的操作符</p>
<table>
<thead>
<tr>
<th style=text-align:center>操作符</th>
<th style=text-align:center>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>=</td>
<td style=text-align:center>等于</td>
</tr>
<tr>
<td style=text-align:center>&lt;</td>
<td style=text-align:center>小于</td>
</tr>
<tr>
<td style=text-align:center>></td>
<td style=text-align:center>大于</td>
</tr>
<tr>
<td style=text-align:center>&lt;> !=</td>
<td style=text-align:center>不等于</td>
</tr>
<tr>
<td style=text-align:center>&lt;= !></td>
<td style=text-align:center>小于等于</td>
</tr>
<tr>
<td style=text-align:center>>= !&lt;</td>
<td style=text-align:center>大于等于</td>
</tr>
<tr>
<td style=text-align:center>BETWEEN</td>
<td style=text-align:center>在两个值之间</td>
</tr>
<tr>
<td style=text-align:center>IS NULL</td>
<td style=text-align:center>为 NULL 值</td>
</tr>
</tbody>
</table>
<p>应该注意到，NULL 与 0、空字符串都不同。</p>
<p><strong>AND 和 OR</strong> 用于连接多个过滤条件。优先处理 AND，当一个过滤表达式涉及到多个 AND 和 OR 时，可以使用 () 来决定优先级，使得优先级关系更清晰。</p>
<p><strong>IN</strong> 操作符用于匹配一组值，其后也可以接一个 SELECT 子句，从而匹配子查询得到的一组值。</p>
<p><strong>NOT</strong> 操作符用于否定一个条件。</p>
<h2 id=通配符>通配符</h2>
<p>通配符也是用在过滤语句中，但它只能用于文本字段。</p>
<ul>
<li><strong>%</strong> 匹配 >=0 个任意字符；</li>
<li><strong>_</strong> 匹配 ==1 个任意字符；</li>
<li><strong><input disabled type=checkbox> </strong> 可以匹配集合内的字符，例如 <code>[ab]</code> 将匹配字符 a 或者 b。用脱字符 ^ 可以对其进行否定，也就是不匹配集合内的字符。</li>
</ul>
<p>使用 Like 来进行通配符匹配。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[^AB]%&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- 不以 A 和 B 开头的任意文本
</span></code></pre></div><p>不要滥用通配符，通配符位于开头处匹配会非常慢。</p>
<h2 id=计算字段>计算字段</h2>
<p>在数据库服务器上完成数据的转换和格式化的工作往往比客户端上快得多，并且转换和格式化后的数据量更少的话可以减少网络通信量。</p>
<p>计算字段通常需要使用 <strong>AS</strong> 来取别名，否则输出的时候字段名为计算表达式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>alias</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>CONCAT()</strong> 用于连接两个字段。许多数据库会使用空格把一个值填充为列宽，因此连接的结果会出现一些不必要的空格，使用 <strong>TRIM()</strong> 可以去除首尾空格。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CONCAT</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>TRIM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;(&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TRIM</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col2</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;)&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat_col</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=函数>函数</h2>
<p>各个 DBMS 的函数都是不相同的，因此不可移植，以下主要是 MySQL 的函数。</p>
<h3 id=汇总>汇总</h3>
<table>
<thead>
<tr>
<th style=text-align:center>函 数</th>
<th style=text-align:center>说 明</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>AVG()</td>
<td style=text-align:center>返回某列的平均值</td>
</tr>
<tr>
<td style=text-align:center>COUNT()</td>
<td style=text-align:center>返回某列的行数</td>
</tr>
<tr>
<td style=text-align:center>MAX()</td>
<td style=text-align:center>返回某列的最大值</td>
</tr>
<tr>
<td style=text-align:center>MIN()</td>
<td style=text-align:center>返回某列的最小值</td>
</tr>
<tr>
<td style=text-align:center>SUM()</td>
<td style=text-align:center>返回某列值之和</td>
</tr>
</tbody>
</table>
<p>AVG() 会忽略 NULL 行。</p>
<p>使用 DISTINCT 可以让汇总函数值汇总不同的值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AVG</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>avg_col</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=文本处理>文本处理</h3>
<table>
<thead>
<tr>
<th style=text-align:center>函数</th>
<th style=text-align:center>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>LEFT()</td>
<td style=text-align:center>左边的字符</td>
</tr>
<tr>
<td style=text-align:center>RIGHT()</td>
<td style=text-align:center>右边的字符</td>
</tr>
<tr>
<td style=text-align:center>LOWER()</td>
<td style=text-align:center>转换为小写字符</td>
</tr>
<tr>
<td style=text-align:center>UPPER()</td>
<td style=text-align:center>转换为大写字符</td>
</tr>
<tr>
<td style=text-align:center>LTRIM()</td>
<td style=text-align:center>去除左边的空格</td>
</tr>
<tr>
<td style=text-align:center>RTRIM()</td>
<td style=text-align:center>去除右边的空格</td>
</tr>
<tr>
<td style=text-align:center>LENGTH()</td>
<td style=text-align:center>长度</td>
</tr>
<tr>
<td style=text-align:center>SOUNDEX()</td>
<td style=text-align:center>转换为语音值</td>
</tr>
</tbody>
</table>
<p>其中， <strong>SOUNDEX()</strong> 可以将一个字符串转换为描述其语音表示的字母数字模式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SOUNDEX</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SOUNDEX</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;apple&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=日期和时间处理>日期和时间处理</h3>
<ul>
<li>日期格式: <code>YYYY-MM-DD</code></li>
<li>时间格式: <code>HH:MM:SS</code></li>
</ul>
<table>
<thead>
<tr>
<th style=text-align:center>函 数</th>
<th style=text-align:center>说 明</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>AddDate()</td>
<td style=text-align:center>增加一个日期(天、周等)</td>
</tr>
<tr>
<td style=text-align:center>AddTime()</td>
<td style=text-align:center>增加一个时间(时、分等)</td>
</tr>
<tr>
<td style=text-align:center>CurDate()</td>
<td style=text-align:center>返回当前日期</td>
</tr>
<tr>
<td style=text-align:center>CurTime()</td>
<td style=text-align:center>返回当前时间</td>
</tr>
<tr>
<td style=text-align:center>Date()</td>
<td style=text-align:center>返回日期时间的日期部分</td>
</tr>
<tr>
<td style=text-align:center>DateDiff()</td>
<td style=text-align:center>计算两个日期之差</td>
</tr>
<tr>
<td style=text-align:center>Date_Add()</td>
<td style=text-align:center>高度灵活的日期运算函数</td>
</tr>
<tr>
<td style=text-align:center>Date_Format()</td>
<td style=text-align:center>返回一个格式化的日期或时间串</td>
</tr>
<tr>
<td style=text-align:center>Day()</td>
<td style=text-align:center>返回一个日期的天数部分</td>
</tr>
<tr>
<td style=text-align:center>DayOfWeek()</td>
<td style=text-align:center>对于一个日期，返回对应的星期几</td>
</tr>
<tr>
<td style=text-align:center>Hour()</td>
<td style=text-align:center>返回一个时间的小时部分</td>
</tr>
<tr>
<td style=text-align:center>Minute()</td>
<td style=text-align:center>返回一个时间的分钟部分</td>
</tr>
<tr>
<td style=text-align:center>Month()</td>
<td style=text-align:center>返回一个日期的月份部分</td>
</tr>
<tr>
<td style=text-align:center>Now()</td>
<td style=text-align:center>返回当前日期和时间</td>
</tr>
<tr>
<td style=text-align:center>Second()</td>
<td style=text-align:center>返回一个时间的秒部分</td>
</tr>
<tr>
<td style=text-align:center>Time()</td>
<td style=text-align:center>返回一个日期时间的时间部分</td>
</tr>
<tr>
<td style=text-align:center>Year()</td>
<td style=text-align:center>返回一个日期的年份部分</td>
</tr>
</tbody>
</table>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>mysql</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NOW</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>2018-4-14 20:25:11
</code></pre></div><h3 id=数值处理>数值处理</h3>
<table>
<thead>
<tr>
<th style=text-align:center>函数</th>
<th style=text-align:center>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>SIN()</td>
<td style=text-align:center>正弦</td>
</tr>
<tr>
<td style=text-align:center>COS()</td>
<td style=text-align:center>余弦</td>
</tr>
<tr>
<td style=text-align:center>TAN()</td>
<td style=text-align:center>正切</td>
</tr>
<tr>
<td style=text-align:center>ABS()</td>
<td style=text-align:center>绝对值</td>
</tr>
<tr>
<td style=text-align:center>SQRT()</td>
<td style=text-align:center>平方根</td>
</tr>
<tr>
<td style=text-align:center>MOD()</td>
<td style=text-align:center>余数</td>
</tr>
<tr>
<td style=text-align:center>EXP()</td>
<td style=text-align:center>指数</td>
</tr>
<tr>
<td style=text-align:center>PI()</td>
<td style=text-align:center>圆周率</td>
</tr>
<tr>
<td style=text-align:center>RAND()</td>
<td style=text-align:center>随机数</td>
</tr>
</tbody>
</table>
<h2 id=分组>分组</h2>
<p>分组就是把具有相同的数据值的行放在同一组中。</p>
<p>可以对同一分组数据使用汇总函数进行处理，例如求分组数据的平均值等。</p>
<p>指定的分组字段除了能按该字段进行分组，也会自动按该字段进行排序。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>GROUP BY 自动按分组字段进行排序，ORDER BY 也可以按汇总字段来进行排序。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>WHERE 过滤行，HAVING 过滤分组，行过滤应当先于分组过滤。</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>num</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>分组规定:</p>
<ul>
<li>GROUP BY 子句出现在 WHERE 子句之后，ORDER BY 子句之前；</li>
<li>除了汇总字段外，SELECT 语句中的每一字段都必须在 GROUP BY 子句中给出；</li>
<li>NULL 的行会单独分为一组；</li>
<li>大多数 SQL 实现不支持 GROUP BY 列具有可变长度的数据类型。</li>
</ul>
<h2 id=子查询>子查询</h2>
<p>子查询中只能返回一个字段的数据。</p>
<p>可以将子查询的结果作为 WHRER 语句的过滤条件:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable2</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>下面的语句可以检索出客户的订单数量，子查询语句会对第一个查询检索出的每个客户执行一次:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cust_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Orders</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Orders</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cust_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Customers</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cust_id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>orders_num</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Customers</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cust_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=连接>连接</h2>
<p>连接用于连接多个表，使用 JOIN 关键字，并且条件语句使用 ON 而不是 WHERE。</p>
<p>连接可以替换子查询，并且比子查询的效率一般会更快。</p>
<p>可以用 AS 给列名、计算字段和表名取别名，给表名取别名是为了简化 SQL 语句以及连接相同表。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503212822.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=内连接>内连接</h3>
<p>内连接又称等值连接，使用 INNER JOIN 关键字。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tablea</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INNER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tableb</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>可以不明确使用 INNER JOIN，而使用普通查询并在 WHERE 中将两个表中要连接的列用等值方法连接起来。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tablea</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tableb</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>在没有条件语句的情况下返回笛卡尔积。</p>
<h3 id=自连接>自连接</h3>
<p>自连接可以看成内连接的一种，只是连接的表是自身而已。</p>
<p>一张员工表，包含员工姓名和员工所属部门，要找出与 Jim 处在同一部门的所有员工姓名。</p>
<p>子查询版本</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>employee</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>department</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>employee</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Jim&#34;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>自连接版本</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>employee</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INNER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>employee</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>department</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>department</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>e2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Jim&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=自然连接>自然连接</h3>
<p>自然连接是把同名列通过等值测试连接起来的，同名列可以有多个。</p>
<p>内连接和自然连接的区别: 内连接提供连接的列，而自然连接自动连接所有同名列。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tablea</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NATURAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tableb</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=外连接>外连接</h3>
<p>外连接保留了没有关联的那些行。分为左外连接，右外连接以及全外连接，左外连接就是保留左表没有关联的行。</p>
<p>检索所有顾客的订单信息，包括还没有订单信息的顾客。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Customers</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cust_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Orders</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>order_num</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Customers</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OUTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Orders</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Customers</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cust_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Orders</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cust_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>customers 表:</p>
<table>
<thead>
<tr>
<th style=text-align:center>cust_id</th>
<th style=text-align:center>cust_name</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>a</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>b</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>c</td>
</tr>
</tbody>
</table>
<p>orders 表:</p>
<table>
<thead>
<tr>
<th style=text-align:center>order_id</th>
<th style=text-align:center>cust_id</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>1</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>1</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>3</td>
</tr>
<tr>
<td style=text-align:center>4</td>
<td style=text-align:center>3</td>
</tr>
</tbody>
</table>
<p>结果:</p>
<table>
<thead>
<tr>
<th style=text-align:center>cust_id</th>
<th style=text-align:center>cust_name</th>
<th style=text-align:center>order_id</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>a</td>
<td style=text-align:center>1</td>
</tr>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>a</td>
<td style=text-align:center>2</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>c</td>
<td style=text-align:center>3</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>c</td>
<td style=text-align:center>4</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>b</td>
<td style=text-align:center>Null</td>
</tr>
</tbody>
</table>
<h2 id=组合查询>组合查询</h2>
<p>使用 <strong>UNION</strong> 来组合两个查询，如果第一个查询返回 M 行，第二个查询返回 N 行，那么组合查询的结果一般为 M+N 行。</p>
<p>每个查询必须包含相同的列、表达式和聚集函数。</p>
<p>默认会去除相同行，如果需要保留相同行，使用 UNION ALL。</p>
<p>只能包含一个 ORDER BY 子句，并且必须位于语句的最后。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>UNION</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=视图>视图</h2>
<p>视图是虚拟的表，本身不包含数据，也就不能对其进行索引操作。</p>
<p>对视图的操作和对普通表的操作一样。</p>
<p>视图具有如下好处:</p>
<ul>
<li>简化复杂的 SQL 操作，比如复杂的连接；</li>
<li>只使用实际表的一部分数据；</li>
<li>通过只给用户访问视图的权限，保证数据的安全性；</li>
<li>更改数据格式和表示。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myview</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Concat</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>concat_col</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col3</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>col4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>compute_col</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>val</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=存储过程>存储过程</h2>
<p>存储过程可以看成是对一系列 SQL 操作的批处理。</p>
<p>使用存储过程的好处:</p>
<ul>
<li>代码封装，保证了一定的安全性；</li>
<li>代码复用；</li>
<li>由于是预先编译，因此具有很高的性能。</li>
</ul>
<p>命令行中创建存储过程需要自定义分隔符，因为命令行是以 ; 为结束符，而存储过程中也包含了分号，因此会错误把这部分分号当成是结束符，造成语法错误。</p>
<p>包含 in、out 和 inout 三种参数。</p>
<p>给变量赋值都需要用 select into 语句。</p>
<p>每次只能给一个变量赋值，不支持集合的操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>delimiter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>procedure</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myprocedure</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>out</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>begin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>declare</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>y</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>y</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>y</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>end</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>delimiter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>call</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myprocedure</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>@</span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>@</span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=游标>游标</h2>
<p>在存储过程中使用游标可以对一个结果集进行移动遍历。</p>
<p>游标主要用于交互式应用，其中用户需要对数据集中的任意行进行浏览和修改。</p>
<p>使用游标的四个步骤:</p>
<ol>
<li>声明游标，这个过程没有实际检索出数据；</li>
<li>打开游标；</li>
<li>取出数据；</li>
<li>关闭游标；</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>delimiter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>procedure</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myprocedure</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>out</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>begin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>declare</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>done</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>boolean</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>declare</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mycursor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cursor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#ce5c00;font-weight:700>#</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>定义了一个</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>continue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>handler</span><span style=color:#a40000>，当</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sqlstate</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;02000&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>这个条件出现时，会执行</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>done</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>declare</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>continue</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>handler</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>sqlstate</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;02000&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>done</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>open</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mycursor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>repeat</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>fetch</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mycursor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ret</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>until</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>done</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>end</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>repeat</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>close</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mycursor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>end</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delimiter</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=触发器>触发器</h2>
<p>触发器会在某个表执行以下语句时而自动执行: DELETE、INSERT、UPDATE。</p>
<p>触发器必须指定在语句执行之前还是之后自动执行，之前执行使用 BEFORE 关键字，之后执行使用 AFTER 关键字。BEFORE 用于数据验证和净化，AFTER 用于审计跟踪，将修改记录到另外一张表中。</p>
<p>INSERT 触发器包含一个名为 NEW 的虚拟表。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TRIGGER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytrigger</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AFTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ROW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NEW</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>@</span><span style=color:#204a87;font-weight:700>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>@</span><span style=color:#204a87;font-weight:700>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>-- 获取结果
</span></code></pre></div><p>DELETE 触发器包含一个名为 OLD 的虚拟表，并且是只读的。</p>
<p>UPDATE 触发器包含一个名为 NEW 和一个名为 OLD 的虚拟表，其中 NEW 是可以被修改的，而 OLD 是只读的。</p>
<p>MySQL 不允许在触发器中使用 CALL 语句，也就是不能调用存储过程。</p>
<h2 id=事务管理>事务管理</h2>
<p>基本术语:</p>
<ul>
<li>事务(transaction)指一组 SQL 语句；</li>
<li>回退(rollback)指撤销指定 SQL 语句的过程；</li>
<li>提交(commit)指将未存储的 SQL 语句结果写入数据库表；</li>
<li>保留点(savepoint)指事务处理中设置的临时占位符(placeholder)，你可以对它发布回退(与回退整个事务处理不同)。</li>
</ul>
<p>不能回退 SELECT 语句，回退 SELECT 语句也没意义；也不能回退 CREATE 和 DROP 语句。</p>
<p>MySQL 的事务提交默认是隐式提交，每执行一条语句就把这条语句当成一个事务然后进行提交。当出现 START TRANSACTION 语句时，会关闭隐式提交；当 COMMIT 或 ROLLBACK 语句执行后，事务会自动关闭，重新恢复隐式提交。</p>
<p>通过设置 autocommit 为 0 可以取消自动提交；autocommit 标记是针对每个连接而不是针对服务器的。</p>
<p>如果没有设置保留点，ROLLBACK 会回退到 START TRANSACTION 语句处；如果设置了保留点，并且在 ROLLBACK 中指定该保留点，则会回退到该保留点。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>START</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TRANSACTION</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>SAVEPOINT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>delete1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ROLLBACK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>delete1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>COMMIT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=字符集>字符集</h2>
<p>基本术语:</p>
<ul>
<li>字符集为字母和符号的集合；</li>
<li>编码为某个字符集成员的内部表示；</li>
<li>校对字符指定如何比较，主要用于排序和分组。</li>
</ul>
<p>除了给表指定字符集和校对外，也可以给列指定:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>VARCHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>CHARACTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>latin</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLLATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>latin1_general_ci</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>CHARACTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hebrew</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLLATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hebrew_general_ci</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>可以在排序、分组时指定校对:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mytable</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>col</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COLLATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>latin1_general_ci</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=权限管理>权限管理</h2>
<p>MySQL 的账户信息保存在 mysql 这个数据库中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>USE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mysql</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>创建账户</strong></p>
<p>新创建的账户没有任何权限。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myuser</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>IDENTIFIED</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;mypassword&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>修改账户名</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myuser</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>newuser</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>删除账户</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myuser</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>查看权限</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRANTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myuser</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>授予权限</strong></p>
<p>账户用 username@host 的形式定义，username@% 使用的是默认主机名。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydatabase</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myuser</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>删除权限</strong></p>
<p>GRANT 和 REVOKE 可在几个层次上控制访问权限:</p>
<ul>
<li>整个服务器，使用 GRANT ALL 和 REVOKE ALL；</li>
<li>整个数据库，使用 ON database.*；</li>
<li>特定的表，使用 ON database.table；</li>
<li>特定的列；</li>
<li>特定的存储过程。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>REVOKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>mydatabase</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myuser</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p><strong>更改密码</strong></p>
<p>必须使用 Password() 函数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PASSWROD</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>myuser</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Password</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;new_password&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3a7e7b2f0ca69ac47bbbc3c0d6b38685>2.2 - CH02-查询练习</h1>
<h2 id=建表>建表</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503213629.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=插入数据>插入数据</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#8f5902;font-style:italic>-- MySQL dump 10.13  Distrib 5.7.17, for macos10.12 (x86_64)
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Host: localhost    Database: learn_sql_pdai_tech
</span><span style=color:#8f5902;font-style:italic>-- ------------------------------------------------------
</span><span style=color:#8f5902;font-style:italic>-- Server version	5.7.28
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET NAMES utf8 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40103 SET TIME_ZONE=&#39;+00:00&#39; */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#39;NO_AUTO_VALUE_ON_ZERO&#39; */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Table structure for table `COURSE`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>COURSE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = utf8 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>COURSE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CNO</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CNAME</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TNO</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = @saved_cs_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Dumping data for table `COURSE`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>COURSE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WRITE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `COURSE` DISABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>COURSE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;计算机导论&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;825&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;3-245&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;操作系统&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;804&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;6-166&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;数据电路&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;856&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;9-888&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;高等数学&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;100&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `COURSE` ENABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>UNLOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Table structure for table `SCORE`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SCORE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = utf8 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SCORE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SNO</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>CNO</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>DEGREE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>decimal</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = @saved_cs_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Dumping data for table `SCORE`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SCORE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WRITE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `SCORE` DISABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SCORE</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;103&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-245&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-245&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>75</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;109&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-245&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>68</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;103&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>92</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>88</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;109&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>76</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;101&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;107&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>91</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;101&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;6-166&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>85</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;107&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;6-106&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>79</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;108&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>78</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;108&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;6-166&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>81</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `SCORE` ENABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>UNLOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Table structure for table `STUDENT`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>STUDENT</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = utf8 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>STUDENT</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SNO</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SNAME</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SSEX</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>SBIRTHDAY</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>datetime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = @saved_cs_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Dumping data for table `STUDENT`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>STUDENT</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WRITE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `STUDENT` DISABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>STUDENT</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;108&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;曾华&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1977-09-01 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;95033&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;105&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;匡明&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1975-10-02 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;95031&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;107&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;王丽&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;女&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1976-01-23 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;95033&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;101&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;李军&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1976-02-20 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;95033&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;109&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;王芳&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;女&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1975-02-10 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;95031&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;103&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;陆君&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1974-06-03 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;95031&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `STUDENT` ENABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>UNLOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Table structure for table `TEACHER`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TEACHER</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET @saved_cs_client     = @@character_set_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = utf8 */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TEACHER</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TNO</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TNAME</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TSEX</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TBIRTHDAY</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>datetime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>PROF</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>DEPART</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>varchar</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENGINE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>InnoDB</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CHARSET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>utf8</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET character_set_client = @saved_cs_client */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic>-- Dumping data for table `TEACHER`
</span><span style=color:#8f5902;font-style:italic>--
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>LOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TEACHER</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WRITE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `TEACHER` DISABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#000>TEACHER</span><span style=color:#ce5c00;font-weight:700>`</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;804&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;李诚&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1958-12-02 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;副教授&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;计算机系&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;856&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;张旭&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1969-03-12 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;讲师&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;电子工程系&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;825&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;王萍&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;女&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1972-05-05 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;助教&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;计算机系&#39;</span><span style=color:#000;font-weight:700>),(</span><span style=color:#4e9a06>&#39;831&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;刘冰&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;女&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1977-08-14 00:00:00&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;助教&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;电子工程系&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40000 ALTER TABLE `TEACHER` ENABLE KEYS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>UNLOCK</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- Dump completed on 2020-02-06 18:18:25
</span></code></pre></div><h2 id=相关练习>相关练习</h2>
<ol>
<li>
<p>查询 Student 中所有记录的 Sname、Ssex、Class 列：</p>
<p><code>SELECT SNAME,SSEX,CLASS FROM STUDENT;</code></p>
</li>
<li>
<p>查询教师所有的单位即不重复的Depart列：</p>
<p><code>SELECT DISTINCT DEPART FORM TEACHER;</code></p>
</li>
<li>
<p>查询Student表的所有记录：</p>
<p><code>SELECT * FROM STUDENT;</code></p>
</li>
<li>
<p>查询Score表中成绩在60到80之间的所有记录：</p>
<p><code>SELECT * FROM SCORE WHERE DEGREE > 60 AND DEGREE &lt; 80;</code></p>
</li>
<li>
<p>查询Score表中成绩为85，86或88的记录：</p>
<p><code>SELECT * FROM SCORE WHERE DEGREE=85 OR DEGREE=86 OR DEGREE=88;</code></p>
</li>
<li>
<p>查询Student表中“95031”班或性别为“女”的同学记录：</p>
<p><code>SELECT * FROM STUDENT WHERE CLASS='95031' OR SSEX='女';</code></p>
</li>
<li>
<p>以Class降序查询Student表的所有记录：</p>
<p><code>SELECT * FROM STUDENT ORDER BY CLASS DESC;</code></p>
</li>
<li>
<p>以Cno升序、Degree降序查询Score表的所有记录：</p>
<p><code>SELECT * FROM SCORE ORDER BY CNO ASC, DEGREE DESC;</code></p>
</li>
<li>
<p>查询“95031”班的学生人数：</p>
<p><code>SELECT COUNT(*) FROM STUDENT WHERE CLASS='95031';</code></p>
</li>
<li>
<p>查询Score表中的最高分的学生学号和课程号：</p>
<p><code>SELECT SNO,CNO FROM SCORE WHERE DEGREE=(SELECT MAX(DEGREE) FROM SCORE);</code></p>
</li>
<li>
<p>查询‘3-105’号课程的平均分：</p>
<p><code>SELECT AVG(DEGREE) FROM SCROE WHERE CNO='3-105';</code></p>
</li>
<li>
<p>查询Score表中至少有5名学生选修的并以3开头的课程的平均分数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#204a87;font-weight:700>AVG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>COUNT</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询最低分大于70，最高分小于90的Sno列：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>HAVING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MIN</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>70</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MAX</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有学生的Sname、Cno和Degree列：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>SNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SCORE</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有学生的Sno、Cname和Degree列：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>SCORE</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SCORE</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有学生的Sname、Cname和Degree列：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#204a87;font-weight:700>C</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>C</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>C</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>C</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询“95033”班所选课程的平均分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AVG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;95033&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>假设使用如下命令建立了一个grade表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>low</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>numeric</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>upp</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>numeric</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>rank</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>char</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;A&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>89</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;B&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>70</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>79</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;C&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>69</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;D&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>into</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>59</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;E&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>现查询所有同学的Sno、Cno和rank列：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RANK</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRADE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BETWEEN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LOW</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UPP</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RANK</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询选修“3-105”课程的成绩高于“109”号同学成绩的所有同学的记录：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;109&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询score中选学一门以上课程的同学中分数为非最高分成绩的学生记录：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;109&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询和学号为108的同学同年出生的所有学生的Sno、Sname和Sbirthday列：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SBIRTHDAY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SBIRTHDAY</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SBIRTHDAY</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;108&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询“张旭“教师任课的学生成绩：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cno</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>inner</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>join</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TNAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;张旭&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询选修某课程的同学人数多于5人的教师姓名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TNAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#204a87;font-weight:700>having</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询95033班和95031班全体学生的记录：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;95033&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;95031&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询存在有85分以上成绩的课程Cno：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cno</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>having</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MAX</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>85</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询出“计算机系“教师所教课程的成绩表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEPART</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;计算机系&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询“计算机系”与“电子工程系“不同职称的教师的Tname和Prof：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>tname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>prof</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>depart</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;计算机系&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>prof</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>prof</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>depart</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;电子工程系&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询选修编号为“3-105“课程且成绩至少高于选修编号为“3-245”的同学的Cno、Sno和Degree,并按Degree从高到低次序排序：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3-105&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>any</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3-245&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询选修编号为“3-105”且成绩高于选修编号为“3-245”课程的同学的Cno、Sno和Degree：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;3-245&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有教师和同学的name、sex和birthday：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TNAME</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TSEX</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>sex</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TBIRTHDAY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>birthday</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>union</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>sname</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SSEX</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>sex</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SBIRTHDAY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>birthday</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有“女”教师和“女”同学的name、sex和birthday：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TNAME</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TSEX</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>sex</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TBIRTHDAY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>birthday</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;女&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>union</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>sname</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SSEX</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>sex</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SBIRTHDAY</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>birthday</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SSEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;女&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询成绩比该课程平均成绩低的同学的成绩表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AVG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>A</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>B</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有任课教师的Tname和Depart：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>DEPART</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>exists</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有未讲课的教师的Tname和Depart：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>TNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>DEPART</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>a</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tno</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tno</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询至少有2名男生的班号：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SSEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>having</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SSEX</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询Student表中不姓“王”的同学记录：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;王%&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询Student表中每个学生的姓名和年龄：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>SNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SBIRTHDAY</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询Student表中最大和最小的Sbirthday日期值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>min</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SBIRTHDAY</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>birthday</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>union</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SBIRTHDAY</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>birthday</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>以班号和年龄从大到小的顺序查询Student表中的全部记录：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>order</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>by</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>year</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SBIRTHDAY</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询“男”教师及其所上的课程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TSEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TEACHER</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TNO</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询最高分同学的Sno、Cno和Degree列：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>sno</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询和“李军”同性别的所有同学的Sname：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sname</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SSEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SSEX</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;李军&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询和“李军”同性别并同班的同学Sname：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sname</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SSEX</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                         </span><span style=color:#000>SSEX</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                         </span><span style=color:#204a87;font-weight:700>CLASS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                       </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>                       </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SNAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;李军&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>查询所有选修“计算机导论”课程的“男”同学的成绩表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SSEX</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;男&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CNAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;计算机导论&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>使用游标方式来同时查询每位同学的名字，他所选课程及成绩：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>declare</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cursor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_cursor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>is</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>S</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>C</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNAME</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>SC</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DEGREE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STUDENT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COURSE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>C</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SCORE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SC</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>S</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SC</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SC</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>C</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNO</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>student_row</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_cursor</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#000>ROWTYPE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>begin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>open</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_cursor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>loop</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fetch</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_cursor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_row</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>exit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>when</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_cursor</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#000>NOTFOUND</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#000>dbms_output</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>put_line</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_row</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>student_row</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SNAME</span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_row</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CNAME</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>student_row</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DEGREE</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>end</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>loop</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>close</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student_cursor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></code></pre></div></li>
<li>
<p>声明触发器指令，每当有同学转换班级时执行触发器显示当前和之前所在班级：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TRIGGER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>display_class_changes</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>AFTER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>DELETE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EACH</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ROW</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>NEW</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sno</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>BEGIN</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>dbms_output</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>put_line</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Old class: &#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>OLD</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>class</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>dbms_output</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>put_line</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;New class: &#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>:</span><span style=color:#204a87;font-weight:700>NEW</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>class</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>Update</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>student</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>95031</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sno</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>109</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
<li>
<p>删除已设置的触发器指令：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>TRIGGER</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>display_class_changes</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-737e18886ba6621c88d9e916998f72b7>2.3 - CH03-查询进阶</h1>
<blockquote>
<p><a href=https://www.pdai.tech/md/db/sql-lan/sql-lan-leetcode.html>https://www.pdai.tech/md/db/sql-lan/sql-lan-leetcode.html</a></p>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-141228844e3202b20692d12c3ddf6e9d>2.4 - CH04-查询优化</h1>
<h2 id=负向查询不能使用索引>负向查询不能使用索引</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>应该修改为:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>select name from user where id in (2,5,6);
</code></pre></div><h2 id=前导模糊查询不能使用索引>前导模糊查询不能使用索引</h2>
<p>如:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;%zhangsan&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>非前导则可以:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;zhangsan%&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>建议可以考虑使用 <code>Lucene</code> 等全文索引工具来代替频繁的模糊查询。</p>
<h2 id=数据区分不明显的不建议创建索引>数据区分不明显的不建议创建索引</h2>
<p>如 user 表中的性别字段，可以明显区分的才建议创建索引，如身份证等字段。</p>
<h2 id=字段的默认值不要为-null>字段的默认值不要为 null</h2>
<p>这样会带来和预期不一致的查询结果。</p>
<h2 id=在字段上进行计算不能命中索引>在字段上进行计算不能命中索引</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FROM_UNIXTIME</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>create_time</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CURDATE</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>应该修改为:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>create_time</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FROM_UNIXTIME</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CURDATE</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/sql-lan/sql-lan-optimize.html</p>
<h2 id=最左前缀问题>最左前缀问题</h2>
<p>如果给 user 表中的 username pwd 字段创建了复合索引那么使用以下SQL 都是可以命中索引:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;zhangsan&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pwd</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;axsedf1sd&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pwd</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;axsedf1sd&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;zhangsan&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;zhangsan&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>但是使用</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pwd</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;axsedf1sd&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>是不能命中索引的。</p>
<h2 id=如果明确知道只有一条记录返回>如果明确知道只有一条记录返回</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;zhangsan&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>可以提高效率，可以让数据库停止游标移动。</p>
<h2 id=不要让数据库帮我们做强制类型转换>不要让数据库帮我们做强制类型转换</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>select</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>where</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>telno</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>18722222222</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>这样虽然可以查出数据，但是会导致全表扫描。</p>
<p>需要修改为</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>select name from user where telno=&#39;18722222222&#39;
</code></pre></div><h2 id=如果需要进行-join-的字段两表的字段类型要相同>如果需要进行 join 的字段两表的字段类型要相同</h2>
<p>不然也不会命中索引。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-90906b5d575a42bc40411c9bf01bcfb6>3 - MySQL</h1>
</div>
<div class=td-content>
<h1 id=pg-90adba63667076abecda8b645b08e594>3.1 - CH01-数据类型</h1>
<h2 id=字段类型>字段类型</h2>
<h3 id=整型>整型</h3>
<p>TINYINT, SMALLINT, MEDIUMINT, INT, BIGINT 分别使用 8, 16, 24, 32, 64 位存储空间，一般情况下越小的列越好。</p>
<p>INT(11) 中的数字只是规定了交互工具显示字符的个数，对于存储和计算来说是没有意义的。</p>
<h3 id=浮点数>浮点数</h3>
<p>FLOAT 和 DOUBLE 为浮点类型，DECIMAL 为高精度小数类型。CPU 原生支持浮点运算，但是不支持 DECIMAl 类型的计算，因此 DECIMAL 的计算比浮点类型需要更高的代价。</p>
<p>FLOAT、DOUBLE 和 DECIMAL 都可以指定列宽，例如 DECIMAL(18, 9) 表示总共 18 位，取 9 位存储小数部分，剩下 9 位存储整数部分。</p>
<h3 id=字符串>字符串</h3>
<p>主要有 CHAR 和 VARCHAR 两种类型，一种是定长的，一种是变长的。</p>
<p>VARCHAR 这种变长类型能够节省空间，因为只需要存储必要的内容。但是在执行 UPDATE 时可能会使行变得比原来长，当超出一个页所能容纳的大小时，就要执行额外的操作。MyISAM 会将行拆成不同的片段存储，而 InnoDB 则需要分裂页来使行放进页内。</p>
<p>VARCHAR 会保留字符串末尾的空格，而 CHAR 会删除。</p>
<h3 id=时间和日期>时间和日期</h3>
<p>MySQL 提供了两种相似的日期时间类型: DATETIME 和 TIMESTAMP。</p>
<h4 id=1-datetime>1. DATETIME</h4>
<p>能够保存从 1001 年到 9999 年的日期和时间，精度为秒，使用 8 字节的存储空间。</p>
<p>它与时区无关。</p>
<p>默认情况下，MySQL 以一种可排序的、无歧义的格式显示 DATETIME 值，例如“2008-01-16 22:37:08”，这是 ANSI 标准定义的日期和时间表示方法。</p>
<h4 id=2-timestamp>2. TIMESTAMP</h4>
<p>和 UNIX 时间戳相同，保存从 1970 年 1 月 1 日午夜(格林威治时间)以来的秒数，使用 4 个字节，只能表示从 1970 年 到 2038 年。</p>
<p>它和时区有关，也就是说一个时间戳在不同的时区所代表的具体时间是不同的。</p>
<p>MySQL 提供了 FROM_UNIXTIME() 函数把 UNIX 时间戳转换为日期，并提供了 UNIX_TIMESTAMP() 函数把日期转换为 UNIX 时间戳。</p>
<p>默认情况下，如果插入时没有指定 TIMESTAMP 列的值，会将这个值设置为当前时间。</p>
<p>应该尽量使用 TIMESTAMP，因为它比 DATETIME 空间效率更高。</p>
<h2 id=选择优化的数据类型>选择优化的数据类型</h2>
<ul>
<li>更小的通常更好；更小的数据类型通常更快，因为它们占用更少的磁盘、内存和CPU缓存，并且处理时需要的CPU周期也更少；</li>
<li>简单就好；例如，整形比字符串操作代价更低；使用内建类型而不是字符串来存储日期和时间；用整形存储IP地址等；</li>
<li>尽量避免NULL；如果查询中包含可为NULL的列，对MySQL来说更难优化，因为可为NULL 的列使得索引、索引统计和值比较都更复杂。尽管把可为NULL的列改为NOT NULL带来的性能提升比较小，但如果计划在列上创建索引，就应该尽量避免设计成可为NULL的列；</li>
</ul>
<h3 id=字符串类型>字符串类型</h3>
<h4 id=varchar-和-char>VARCHAR 和 CHAR</h4>
<p>VARCHAR是最常见的字符串类型。VARCHAR节省了存储空间，所以对性能也有帮助。但是，由于行是可变的，在UPDATE时可能使行变得比原来更长，这就导致需要做额外的工作。如果一个行占用的空间增长，并且在页内没有更多的空间可以存储，MyISAM会将行拆成不同的片段存储；InnoDB则需要分裂页来使行可以放进页内。</p>
<p>下面这些情况使用VARCHAR是合适的：字符串的最大长度比平均长度大很多；列的更新很少，所以碎片不是问题；使用了像UTF-8这样复杂的字符集，每个字符都使用不同的字节数进行存储。</p>
<p>当存储CHAR值时，MySQL会删除所有的末尾空格。CHAR值会根据需要采用空格进行填充以方便比较。</p>
<p>CHAR适合存储很短的字符串，或者所有值都接近同一个长度，如密码的MD5值。对于经常变更的数据，CHAR也比VARCHAR更好，因为CHAR不容易产生碎片（行间碎片？）。</p>
<h4 id=varchar5和varchar200>VARCHAR(5)和VARCHAR(200)</h4>
<blockquote>
<p>使用VARCHAR(5)和VARCHAR(200)存储"hello"的空间开销是一样的。那么使用更短的列有什么优势吗？</p>
</blockquote>
<p>事实证明有很大的优势。更长的列会消耗更多的内存，因为MySQL通常会分配固定大小的内存块来保存内部值。尤其是使用内存临时表进行排序或其他操作时会特别糟糕。在利用磁盘临时表进行排序时也同样糟糕。</p>
<p>所以最好的策略是只分配真正需要的空间。</p>
<h4 id=blob-和-text>BLOB 和 TEXT</h4>
<p>BLOB和TEXT都是为存储很大的数据而设计的数据类型，分别采用二进制和字符方式存储。</p>
<p>与其他类型不同，MySQL把每个BLOB和TEXT值当做一个独立的对象去处理。当BLOB和TEXT值太大时，InnoDB会使用专门的“外部”存储区域来进行存储，此时每个值在行内需要1~4个字节存储一个指针，然后在外部存储区域存储实际的值。</p>
<p>MySQL对BLOB和TEXT列进行排序与其他类型是不同的：它只对每个列的最前max_sort_length个字节而不是整个字符串做排序。同样的，MySQL也不能将BLOB或TEXT列全部长度的字符串进行索引。</p>
<h3 id=选择标识符identifier>选择标识符（identifier）</h3>
<p>整数类型通常是标识列的最佳选择，因为它们很快并且可以使用AUTO_INCREMENT。 如果可能，应该避免使用字符串类型作为标识列，因为它们很耗空间，并且比数字类型慢。 对于完全随机的字符串也需要多加注意，例如MD5(),SHA1()或者UUID()产生的字符串。这些函数生成的新值会任意分布在很大的空间内，这会导致INSERT以及一些SELECT语句变得很慢：</p>
<ul>
<li>因为插入值会随机的写入到索引的不同位置，所以使得INSERT语句更慢。这会导致叶分裂、磁盘随机访问。</li>
<li>SELECT语句会变的更慢，因为逻辑上相邻的行会分布在磁盘和内存的不同地方。</li>
<li>随机值导致缓存对所有类型的查询语句效果都很差，因为会使得缓存赖以工作的局部性原理失效。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-87823f5c8c995312533c60e735d79427>3.2 - CH02-存储引擎</h1>
<h2 id=innodb>InnoDB</h2>
<p>是 MySQL 默认的事务型存储引擎，<strong>只有在需要它不支持的特性时，才考虑使用其它存储引擎</strong>。</p>
<p>实现了四个标准的隔离级别，默认级别是可重复读(REPEATABLE READ)。在可重复读隔离级别下，通过多版本并发控制(MVCC)+ 间隙锁(Next-Key Locking)防止幻读。</p>
<p>主索引是聚簇索引，在索引中保存了数据，从而避免直接读取磁盘，因此对查询性能有很大的提升。</p>
<p>内部做了很多优化，包括从磁盘读取数据时采用的可预测性读、能够加快读操作并且自动创建的自适应哈希索引、能够加速插入操作的插入缓冲区等。</p>
<p>支持真正的在线热备份。其它存储引擎不支持在线热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合场景中，停止写入可能也意味着停止读取。</p>
<h2 id=myisam>MyISAM</h2>
<p>设计简单，数据以紧密格式存储。对于只读数据，或者表比较小、可以容忍修复操作，则依然可以使用它。</p>
<p>提供了大量的特性，包括压缩表、空间数据索引等。</p>
<p><strong>不支持事务</strong>。</p>
<p>不支持行级锁，只能对整张表加锁，读取时会对需要读到的所有表加共享锁，写入时则对表加排它锁。但在表有读取操作的同时，也可以往表中插入新的记录，这被称为并发插入(CONCURRENT INSERT)。</p>
<p>可以手工或者自动执行检查和修复操作，但是和事务恢复以及崩溃恢复不同，可能导致一些数据丢失，而且修复操作是非常慢的。</p>
<p>如果指定了 DELAY_KEY_WRITE 选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。</p>
<h2 id=对比>对比</h2>
<ul>
<li>事务: InnoDB 是事务型的，可以使用 Commit 和 Rollback 语句。</li>
<li>并发: MyISAM 只支持表级锁，而 InnoDB 还支持行级锁。</li>
<li>外键: InnoDB 支持外键。</li>
<li>备份: InnoDB 支持在线热备份。</li>
<li>崩溃恢复: MyISAM 崩溃后发生损坏的概率比 InnoDB 高很多，而且恢复的速度也更慢。</li>
<li>其它特性: MyISAM 支持压缩表和空间数据索引。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e59a8b6bc16ee47aa4e9119f76c58aa2>3.3 - CH03-索引B+树</h1>
<h2 id=b-tree-原理>B+ Tree 原理</h2>
<h3 id=1-数据结构>1. 数据结构</h3>
<p>B Tree 指的是 Balance Tree，也就是平衡树。平衡树是一颗查找树，并且所有叶子节点位于同一层。</p>
<p>B+ Tree 是基于 B Tree 和叶子节点顺序访问指针进行实现，它具有 B Tree 的平衡性，并且通过顺序访问指针来提高区间查询的性能。</p>
<p>在 B+ Tree 中，一个节点中的 key 从左到右非递减排列，如果某个指针的左右相邻 key 分别是 key i 和 key i+1，且不为 null，则该指针指向节点的所有 key 大于等于 key i 且小于等于 key i+1。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503192121.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=2-操作>2. 操作</h3>
<p>进行查找操作时，首先在根节点进行二分查找，找到一个 key 所在的指针，然后递归地在指针所指向的节点进行查找。直到查找到叶子节点，然后在叶子节点上进行二分查找，找出 key 所对应的 data。</p>
<p>插入删除操作记录会破坏平衡树的平衡性，因此在插入删除操作之后，需要对树进行一个分裂、合并、旋转等操作来维护平衡性。</p>
<h3 id=3-与红黑树的比较>3. 与红黑树的比较</h3>
<p>红黑树等平衡树也可以用来实现索引，但是文件系统及数据库系统普遍采用 B+ Tree 作为索引结构，主要有以下两个原因:</p>
<p>(一)更少的查找次数</p>
<p>平衡树查找操作的时间复杂度等于树高 h，而树高大致为 O(h)=O(logdN)，其中 d 为每个节点的出度。</p>
<p>红黑树的出度为 2，而 B+ Tree 的出度一般都非常大，所以红黑树的树高 h 很明显比 B+ Tree 大非常多，检索的次数也就更多。</p>
<p>(二)利用计算机预读特性</p>
<p>为了减少磁盘 I/O，磁盘往往不是严格按需读取，而是每次都会预读。预读过程中，磁盘进行顺序读取，顺序读取不需要进行磁盘寻道，并且只需要很短的旋转时间，因此速度会非常快。</p>
<p>操作系统一般将内存和磁盘分割成固态大小的块，每一块称为一页，内存与磁盘以页为单位交换数据。数据库系统将索引的一个节点的大小设置为页的大小，使得一次 I/O 就能完全载入一个节点，并且可以利用预读特性，相邻的节点也能够被预先载入。</p>
<h2 id=mysql-索引>MySQL 索引</h2>
<p>索引是在存储引擎层实现的，而不是在服务器层实现的，所以不同存储引擎具有不同的索引类型和实现。</p>
<h3 id=1-btree-索引>1. B+Tree 索引</h3>
<p>是大多数 MySQL 存储引擎的默认索引类型。</p>
<p>因为不再需要进行全表扫描，只需要对树进行搜索即可，因此查找速度快很多。除了用于查找，还可以用于排序和分组。</p>
<p>可以指定多个列作为索引列，多个索引列共同组成键。</p>
<p>适用于全键值、键值范围和键前缀查找，其中键前缀查找只适用于最左前缀查找。如果不是按照索引列的顺序进行查找，则无法使用索引。</p>
<p>InnoDB 的 B+Tree 索引分为主索引和辅助索引。</p>
<p>主索引的叶子节点 data 域记录着完整的数据记录，这种索引方式被称为聚簇索引。因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503192439.png style=display:block;width:50% alt=NAME align=center> </div>
<p>辅助索引的叶子节点的 data 域记录着主键的值，因此在使用辅助索引进行查找时，需要先查找到主键值，然后再到主索引中进行查找。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503192458.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=2-哈希索引>2. 哈希索引</h3>
<p>哈希索引能以 O(1) 时间进行查找，但是失去了有序性，它具有以下限制:</p>
<ul>
<li>无法用于排序与分组；</li>
<li>只支持精确查找，无法用于部分查找和范围查找。</li>
</ul>
<p>InnoDB 存储引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用的非常频繁时，会在 B+Tree 索引之上再创建一个哈希索引，这样就让 B+Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。</p>
<h3 id=3-全文索引>3. 全文索引</h3>
<p>MyISAM 存储引擎支持全文索引，用于查找文本中的关键词，而不是直接比较是否相等。查找条件使用 MATCH AGAINST，而不是普通的 WHERE。</p>
<p>全文索引一般使用倒排索引实现，它记录着关键词到其所在文档的映射。</p>
<p>InnoDB 存储引擎在 MySQL 5.6.4 版本中也开始支持全文索引。</p>
<h3 id=4-空间数据索引>4. 空间数据索引</h3>
<p>MyISAM 存储引擎支持空间数据索引(R-Tree)，可以用于地理数据存储。空间数据索引会从所有维度来索引数据，可以有效地使用任意维度来进行组合查询。</p>
<p>必须使用 GIS 相关的函数来维护数据。</p>
<h2 id=索引优化>索引优化</h2>
<h3 id=1-独立的列>1. 独立的列</h3>
<p>在进行查询时，索引列不能是表达式的一部分，也不能是函数的参数，否则无法使用索引。</p>
<p>例如下面的查询不能使用 actor_id 列的索引:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sakila</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>actor</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=2-多列索引>2. 多列索引</h3>
<p>在需要使用多个列作为条件进行查询时，使用多列索引比使用多个单列索引性能更好。例如下面的语句中，最好把 actor_id 和 film_id 设置为多列索引。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>film_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>sakila</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>film_actor</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>actor_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>film_id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=3-索引列的顺序>3. 索引列的顺序</h3>
<p>让选择性最强的索引列放在前面，索引的选择性是指: 不重复的索引值和记录总数的比值。最大值为 1，此时每个记录都有唯一的索引与其对应。选择性越高，查询效率也越高。</p>
<h4 id=4-前缀索引>4. 前缀索引</h4>
<p>对于 BLOB、TEXT 和 VARCHAR 类型的列，必须使用前缀索引，只索引开始的部分字符。</p>
<p>对于前缀长度的选取需要根据索引选择性来确定。</p>
<h4 id=5-覆盖索引>5. 覆盖索引</h4>
<p>索引包含所有需要查询的字段的值。</p>
<p>具有以下优点:</p>
<ul>
<li>索引通常远小于数据行的大小，只读取索引能大大减少数据访问量。</li>
<li>一些存储引擎(例如 MyISAM)在内存中只缓存索引，而数据依赖于操作系统来缓存。因此，只访问索引可以不使用系统调用(通常比较费时)。</li>
<li>对于 InnoDB 引擎，若辅助索引能够覆盖查询，则无需访问主索引。</li>
</ul>
<h2 id=索引的有点>索引的有点</h2>
<p>大大减少了服务器需要扫描的数据行数。</p>
<p>帮助服务器避免进行排序和分组，也就不需要创建临时表(B+Tree 索引是有序的，可以用于 ORDER BY 和 GROUP BY 操作。临时表主要是在排序和分组过程中创建，因为不需要排序和分组，也就不需要创建临时表)。</p>
<p>将随机 I/O 变为顺序 I/O(B+Tree 索引是有序的，也就将相邻的数据都存储在一起)。</p>
<h3 id=索引的使用场景>索引的使用场景</h3>
<ul>
<li>对于非常小的表、大部分情况下简单的全表扫描比建立索引更高效。</li>
<li>对于中到大型的表，索引就非常有效。</li>
<li>但是对于特大型的表，建立和维护索引的代价将会随之增长。这种情况下，需要用到一种技术可以直接区分出需要查询的一组数据，而不是一条记录一条记录地匹配，例如可以使用分区技术。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e153ee081a2e00565371b72f637f2039>3.4 - CH04-性能优化</h1>
<h2 id=使用-explain-进行分析>使用 Explain 进行分析</h2>
<p>Explain 用来分析 SELECT 查询语句，开发人员可以通过分析 Explain 结果来优化查询语句。</p>
<p>比较重要的字段有:</p>
<ul>
<li>select_type : 查询类型，有简单查询、联合查询、子查询等</li>
<li>key : 使用的索引</li>
<li>rows : 扫描的行数</li>
</ul>
<h2 id=优化数据访问>优化数据访问</h2>
<h3 id=1-减少请求的数据量>1. 减少请求的数据量</h3>
<ul>
<li>只返回必要的列: 最好不要使用 SELECT * 语句。</li>
<li>只返回必要的行: 使用 LIMIT 语句来限制返回的数据。</li>
<li>缓存重复查询的数据: 使用缓存可以避免在数据库中进行查询，特别在要查询的数据经常被重复查询时，缓存带来的查询性能提升将会是非常明显的。</li>
</ul>
<h3 id=2-减少服务器端扫描的行数>2. 减少服务器端扫描的行数</h3>
<p>最有效的方式是使用索引来覆盖查询。</p>
<h2 id=重构查询方式>重构查询方式</h2>
<h3 id=1-切分大查询>1. 切分大查询</h3>
<p>一个大查询如果一次性执行的话，可能一次锁住很多数据、占满整个事务日志、耗尽系统资源、阻塞很多小的但重要的查询。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>DELEFT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>messages</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DATE_SUB</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>NOW</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>MONTH</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000>rows_affected</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>do</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>rows_affected</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>do_query</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000&#34;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>}</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>while</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rows_affected</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=2-分解大连接查询>2. 分解大连接查询</h3>
<p>将一个大连接查询分解成对每一个表进行一次单表查询，然后将结果在应用程序中进行关联，这样做的好处有:</p>
<ul>
<li>让缓存更高效。对于连接查询，如果其中一个表发生变化，那么整个查询缓存就无法使用。而分解后的多个查询，即使其中一个表发生变化，对其它表的查询缓存依然可以使用。</li>
<li>分解成多个单表查询，这些单表查询的缓存结果更可能被其它查询使用到，从而减少冗余记录的查询。</li>
<li>减少锁竞争；</li>
<li>在应用层进行连接，可以更容易对数据库进行拆分，从而更容易做到高性能和可伸缩。</li>
<li>查询本身效率也可能会有所提升。例如下面的例子中，使用 IN() 代替连接查询，可以让 MySQL 按照 ID 顺序进行查询，这可能比随机的连接要更高效。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tab</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag_post</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag_post</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tag_id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>tag</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>post</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag_post</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>post_id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>post</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;mysql&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;mysql&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag_post</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tag_id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1234</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>post</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>post</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>123</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>456</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>567</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>9098</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>8904</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-29d040819faa80f395ba725e176690a3>3.5 - CH05-分库分表</h1>
<h2 id=水平切分>水平切分</h2>
<p>水平切分又称为 Sharding，它是将同一个表中的记录拆分到多个结构相同的表中。</p>
<p>当一个表的数据不断增多时，Sharding 是必然的选择，它可以将数据分布到集群的不同节点上，从而缓存单个数据库的压力。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503194243.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=垂直切分>垂直切分</h2>
<p>垂直切分是将一张表按列切分成多个表，通常是按照列的关系密集程度进行切分，也可以利用垂直切分将经常被使用的列和不经常被使用的列切分到不同的表中。</p>
<p>在数据库的层面使用垂直切分将按数据库中表的密集程度部署到不同的库中，例如将原来的电商数据库垂直切分成商品数据库、用户数据库等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503194255.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=sharding-策略>Sharding 策略</h2>
<ul>
<li>哈希取模: hash(key) % NUM_DB</li>
<li>范围: 可以是 ID 范围也可以是时间范围</li>
<li>映射表: 使用单独的一个数据库来存储映射关系</li>
</ul>
<h2 id=sharding-存在的问题及解决方案>Sharding 存在的问题及解决方案</h2>
<h3 id=1-事务问题>1. 事务问题</h3>
<p>使用分布式事务来解决，比如 XA 接口。</p>
<h3 id=2-链接>2. 链接</h3>
<p>可以将原来的 JOIN 分解成多个单表查询，然后在用户程序中进行 JOIN。</p>
<h3 id=3-id-唯一性>3. ID 唯一性</h3>
<ul>
<li>使用全局唯一 ID: GUID</li>
<li>为每个分片指定一个 ID 范围</li>
<li>分布式 ID 生成器 (如 Twitter 的 Snowflake 算法)</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-18dd619a88421627df2c9f215cacaecc>3.6 - CH06-复制分离</h1>
<h2 id=主从复制>主从复制</h2>
<p>主要涉及三个线程: binlog 线程、I/O 线程和 SQL 线程。</p>
<ul>
<li><strong>binlog 线程</strong> : 负责将主服务器上的数据更改写入二进制日志中。</li>
<li><strong>I/O 线程</strong> : 负责从主服务器上读取二进制日志，并写入从服务器的中继日志中。</li>
<li><strong>SQL 线程</strong> : 负责读取中继日志并重放其中的 SQL 语句。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503194809.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=读写分离>读写分离</h2>
<p>主服务器处理写操作以及实时性要求比较高的读操作，而从服务器处理读操作。</p>
<p>读写分离能提高性能的原因在于:</p>
<ul>
<li>主从服务器负责各自的读和写，极大程度缓解了锁的争用；</li>
<li>从服务器可以使用 MyISAM，提升查询性能以及节约系统开销；</li>
<li>增加冗余，提高可用性。</li>
</ul>
<p>读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503194848.png style=display:block;width:50% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-280203572e4e446020b171753e2c2a12>3.7 - CH07-执行过程</h1>
<h2 id=前言>前言</h2>
<p>天天和数据库打交道，一天能写上几十条 SQL 语句，但你知道我们的系统是如何和数据库交互的吗？MySQL 如何帮我们存储数据、又是如何帮我们管理事务？&mldr;.是不是感觉真的除了写几个 「select * from dual」外基本脑子一片空白？这篇文章就将带你走进 MySQL 的世界，让你彻底了解系统到底是如何和 MySQL 交互的，MySQL 在接受到我们发送的 SQL 语句时又分别做了哪些事情。</p>
<h2 id=mysql-驱动>MySQL 驱动</h2>
<p>我们的系统在和 MySQL 数据库进行通信的时候，总不可能是平白无故的就能接收和发送请求，就算是你没有做什么操作，那总该是有其他的“人”帮我们做了一些事情，基本上使用过 MySQL 数据库的程序员多多少少都会知道 MySQL 驱动这个概念的。就是这个 MySQL 驱动在底层帮我们做了对数据库的连接，只有建立了连接了，才能够有后面的交互。看下图表示</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195039.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这样的话，在系统和 MySQL 进行交互之前，MySQL 驱动会帮我们建立好连接，然后我们只需要发送 SQL 语句就可以执行 CRUD 了。一次 SQL 请求就会建立一个连接，多个请求就会建立多个连接，那么问题来了，我们系统肯定不是一个人在使用的，换句话说肯定是存在多个请求同时去争抢连接的情况。我们的 web 系统一般都是部署在 tomcat 容器中的，而 tomcat 是可以并发处理多个请求的，这就会导致多个请求会去建立多个连接，然后使用完再都去关闭，这样会有什么问题呢？如下图</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195111.png style=display:block;width:50% alt=NAME align=center> </div>
<p>java 系统在通过 MySQL 驱动和 MySQL 数据库连接的时候是基于 TCP/IP 协议的，所以如果每个请求都是新建连接和销毁连接，那这样势必会造成不必要的浪费和性能的下降，也就说上面的多线程请求的时候频繁的创建和销毁连接显然是不合理的。必然会大大降低我们系统的性能，但是如果给你提供一些固定的用来连接的线程，这样是不是不需要反复的创建和销毁连接了呢？相信懂行的朋友会会心一笑，没错，说的就是数据库连接池。</p>
<p><strong>数据库连接池</strong>：维护一定的连接数，方便系统获取连接，使用就去池子中获取，用完放回去就可以了，我们不需要关心连接的创建与销毁，也不需要关心线程池是怎么去维护这些连接的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195148.png style=display:block;width:50% alt=NAME align=center> </div>
<p>常见的数据库连接池有 HakariCP、Druid、C3P0、DBCP，连接池实现原理在这里就不深入讨论了，采用连接池大大节省了不断创建与销毁线程的开销，这就是有名的「池化」思想，不管是线程池还是 HTTP 连接池，都能看到它的身影。</p>
<h2 id=数据库连接池>数据库连接池</h2>
<p>到这里，我们已经知道的是我们的系统在访问 MySQL 数据库的时候，建立的连接并不是每次请求都会去创建的，而是从数据库连接池中去获取，这样就解决了因为反复的创建和销毁连接而带来的性能损耗问题了。不过这里有个小问题，业务系统是并发的，而 MySQL 接受请求的线程呢，只有一个？</p>
<p>其实 MySQL 的架构体系中也已经提供了这样的一个池子，也是数据库连池。双方都是通过数据库连接池来管理各个连接的，这样一方面线程之前不需要是争抢连接，更重要的是不需要反复的创建的销毁连接。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195232.png style=display:block;width:50% alt=NAME align=center> </div>
<p>至此系统和 MySQL 数据库之间的连接问题已经说明清楚了。那么 MySQL 数据库中的这些连接是怎么来处理的，又是谁来处理呢？</p>
<h2 id=网络连接必须由线程来处理>网络连接必须由线程来处理</h2>
<p>对计算基础稍微有一点了解的的同学都是知道的，网络中的连接都是由线程来处理的，所谓网络连接说白了就是一次请求，每次请求都会有相应的线程去处理的。也就是说对于 SQL 语句的请求在 MySQL 中是由一个个的线程去处理的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195303.png style=display:block;width:50% alt=NAME align=center> </div>
<p>那这些线程会怎么去处理这些请求？会做哪些事情？</p>
<h2 id=sql-接口>SQL 接口</h2>
<p>MySQL 中处理请求的线程在获取到请求以后获取 SQL 语句去交给 SQL 接口去处理。</p>
<h2 id=查询解析器>查询解析器</h2>
<p>假如现在有这样的一个 SQL</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>stuName</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>age</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>sex</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>students</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>但是这个 SQL 是写给我们人看的，机器哪里知道你在说什么？这个时候解析器就上场了。他会将 SQL 接口传递过来的 SQL 语句进行解析，翻译成 MySQL 自己能认识的语言，至于怎么解析的就不需要在深究了，无非是自己一套相关的规则。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195353.png style=display:block;width:50% alt=NAME align=center> </div>
<p>现在 SQL 已经被解析成 MySQL 认识的样子的，那下一步是不是就是执行吗？理论上是这样子的，但是 MySQL 的强大远不止于此，他还会帮我们选择最优的查询路径。</p>
<p>什么叫最优查询路径？就是 MySQL 会按照自己认为的效率最高的方式去执行查询.</p>
<p>具体是怎么做到的呢？这就要说到 MySQL 的查询优化器了</p>
<h2 id=mysql-查询优化器>MySQL 查询优化器</h2>
<p>查询优化器内部具体怎么实现的我们不需要是关心，我需要知道的是 MySQL 会帮我去使用他自己认为的最好的方式去优化这条 SQL 语句，并生成一条条的执行计划，比如你创建了多个索引，MySQL 会依据成本最小原则来选择使用对应的索引，这里的成本主要包括两个方面, IO 成本和 CPU 成本</p>
<p><strong>IO 成本</strong>: 即从磁盘把数据加载到内存的成本，默认情况下，读取数据页的 IO 成本是 1，MySQL 是以页的形式读取数据的，即当用到某个数据时，并不会只读取这个数据，而会把这个数据相邻的数据也一起读到内存中，这就是有名的程序局部性原理，所以 MySQL 每次会读取一整页，一页的成本就是 1。所以 IO 的成本主要和页的大小有关</p>
<p><strong>CPU 成本</strong>：将数据读入内存后，还要检测数据是否满足条件和排序等 CPU 操作的成本，显然它与行数有关，默认情况下，检测记录的成本是 0.2。</p>
<p>MySQL 优化器 会计算 「IO 成本 + CPU」 成本最小的那个索引来执行</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195422.png style=display:block;width:50% alt=NAME align=center> </div>
<p>优化器执行选出最优索引等步骤后，会去调用存储引擎接口，开始去执行被 MySQL 解析过和优化过的 SQL 语句</p>
<h2 id=存储引擎>存储引擎</h2>
<p>查询优化器会调用存储引擎的接口，去执行 SQL，也就是说真正执行 SQL 的动作是在存储引擎中完成的。数据是被存放在内存或者是磁盘中的（存储引擎是一个非常重要的组件，后面会详细介绍）</p>
<h2 id=执行器>执行器</h2>
<p>执行器是一个非常重要的组件，因为前面那些组件的操作最终必须通过执行器去调用存储引擎接口才能被执行。执行器最终最根据一系列的执行计划去调用存储引擎的接口去完成 SQL 的执行</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195448.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=初识存储引擎>初识存储引擎</h2>
<p>我们以一个更新的SQL语句来说明，SQL 如下</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>students</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>stuName</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;小强&#39;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>当我们系统发出这样的查询去交给 MySQL 的时候，MySQL 会按照我们上面介绍的一系列的流程最终通过执行器调用存储引擎去执行，流程图就是上面那个。在执行这个 SQL 的时候 SQL 语句对应的数据要么是在内存中，要么是在磁盘中，如果直接在磁盘中操作，那这样的随机IO读写的速度肯定让人无法接受的，所以每次在执行 SQL 的时候都会将其数据加载到内存中，这块内存就是 InnoDB 中一个非常重要的组件：<strong>缓冲池 Buffer Pool</strong></p>
<h2 id=buffer-pool>Buffer Pool</h2>
<p>Buffer Pool （缓冲池）是 InnoDB 存储引擎中非常重要的内存结构，顾名思义，缓冲池其实就是类似 Redis 一样的作用，起到一个缓存的作用，因为我们都知道 MySQL 的数据最终是存储在磁盘中的，如果没有这个 Buffer Pool 那么我们每次的数据库请求都会磁盘中查找，这样必然会存在 IO 操作，这肯定是无法接受的。但是有了 Buffer Pool 就是我们第一次在查询的时候会将查询的结果存到 Buffer Pool 中，这样后面再有请求的时候就会先从缓冲池中去查询，如果没有再去磁盘中查找，然后在放到 Buffer Pool 中，如下图</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195538.png style=display:block;width:50% alt=NAME align=center> </div>
<p>按照上面的那幅图，这条 SQL 语句的执行步骤大致是这样子的</p>
<ul>
<li>innodb 存储引擎会在缓冲池中查找 id=1 的这条数据是否存在</li>
<li>发现不存在，那么就会去磁盘中加载，并将其存放在缓冲池中</li>
<li>该条记录会被加上一个独占锁（总不能你在修改的时候别人也在修改吧，这个机制本篇文章不重点介绍，以后会专门写文章来详细讲解）</li>
</ul>
<h2 id=undo-日志文件记录数据被修改前的样子>undo 日志文件：记录数据被修改前的样子</h2>
<p>undo 顾名思义，就是没有做，没发生的意思。undo log 就是没有发生事情（原本事情是什么）的一些日志</p>
<p>我们刚刚已经说了，在准备更新一条语句的时候，该条语句已经被加载到 Buffer pool 中了，实际上这里还有这样的操作，就是在将该条语句加载到 Buffer Pool 中的时候同时会往 undo 日志文件中插入一条日志，也就是将 id=1 的这条记录的原来的值记录下来。</p>
<p><strong>这样做的目的是什么</strong>？</p>
<p>Innodb 存储引擎的最大特点就是支持事务，如果本次更新失败，也就是事务提交失败，那么该事务中的所有的操作都必须回滚到执行前的样子，也就是说当事务失败的时候，也不会对原始数据有影响，看图说话</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195600.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这里说句额外话，其实 MySQL 也是一个系统，就好比我们平时开发的 java 的功能系统一样，MySQL 使用的是自己相应的语言开发出来的一套系统而已，它根据自己需要的功能去设计对应的功能，它即然能做到哪些事情，那么必然是设计者们当初这么定义或者是根据实际的场景变更演化而来的。所以大家放平心态，把 MySQL 当作一个系统去了解熟悉他。</p>
<p>到这一步，我们的执行的 SQL 语句已经被加载到 Buffer Pool 中了，然后开始更新这条语句，更新的操作实际是在Buffer Pool中执行的，那问题来了，按照我们平时开发的一套理论缓冲池中的数据和数据库中的数据不一致时候，我们就认为缓存中的数据是脏数据，那此时 Buffer Pool 中的数据岂不是成了脏数据？没错，目前这条数据就是脏数据，Buffer Pool 中的记录是小强 数据库中的记录是旺财 ，这种情况 MySQL是怎么处理的呢，继续往下看</p>
<h2 id=redo-日志文件记录数据被修改后的样子>redo 日志文件：记录数据被修改后的样子</h2>
<p>除了从磁盘中加载文件和将操作前的记录保存到 undo 日志文件中，其他的操作是在内存中完成的，内存中的数据的特点就是：断电丢失。如果此时 MySQL 所在的服务器宕机了，那么 Buffer Pool 中的数据会全部丢失的。这个时候 redo 日志文件就需要来大显神通了</p>
<p><strong>画外音：redo 日志文件是 InnoDB 特有的，他是存储引擎级别的，不是 MySQL 级别的</strong></p>
<p>redo 记录的是数据修改之后的值，不管事务是否提交都会记录下来，例如，此时将要做的是update students set stuName=&lsquo;小强&rsquo; where id=1; 那么这条操作就会被记录到 redo log buffer 中，啥？怎么又出来一个 redo log buffer ,很简单，MySQL 为了提高效率，所以将这些操作都先放在内存中去完成，然后会在某个时机将其持久化到磁盘中。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195621.png style=display:block;width:50% alt=NAME align=center> </div>
<p>截至目前，我们应该都熟悉了 MySQL 的执行器调用存储引擎是怎么将一条 SQL 加载到缓冲池和记录哪些日志的，流程如下：</p>
<ul>
<li>准备更新一条 SQL 语句</li>
<li>MySQL（innodb）会先去缓冲池（BufferPool）中去查找这条数据，没找到就会去磁盘中查找，如果查找到就会将这条数据加载到缓冲池（BufferPool）中</li>
<li>在加载到 Buffer Pool 的同时，会将这条数据的原始记录保存到 undo 日志文件中</li>
<li>innodb 会在 Buffer Pool 中执行更新操作</li>
<li>更新后的数据会记录在 redo log buffer 中</li>
</ul>
<p>上面说的步骤都是在正常情况下的操作，但是程序的设计和优化并不仅是为了这些正常情况而去做的，也是为了<strong>那些临界区和极端情况下出现的问题去优化</strong>设计的</p>
<p>这个时候如果服务器宕机了，那么缓存中的数据还是丢失了。真烦，竟然数据总是丢失，那能不能不要放在内存中，直接保存到磁盘呢？很显然不行，因为在上面也已经介绍了，在内存中的操作目的是为了提高效率。</p>
<p>此时，如果 MySQL 真的宕机了，那么没关系的，因为 MySQL 会认为本次事务是失败的，所以数据依旧是更新前的样子，并不会有任何的影响。</p>
<p>好了，语句也更新好了那么需要将更新的值提交啊，也就是需要提交本次的事务了，因为只要事务成功提交了，才会将最后的变更保存到数据库，在提交事务前仍然会具有相关的其他操作</p>
<p>将 redo Log Buffer 中的数据持久化到磁盘中，就是将 redo log buffer 中的数据写入到 redo log 磁盘文件中，一般情况下，redo log Buffer 数据写入磁盘的策略是立即刷入磁盘（具体策略情况在下面小总结出会详细介绍）,上图</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195634.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如果 redo log Buffer 刷入磁盘后，数据库服务器宕机了，那我们更新的数据怎么办？此时数据是在内存中，数据岂不是丢失了？不，这次数据就不会丢失了，因为 redo log buffer 中的数据已经被写入到磁盘了，已经被持久化了，就算数据库宕机了，在下次重启的时候 MySQL 也会将 redo 日志文件内容恢复到 Buffer Pool 中（这边我的理解是和 Redis 的持久化机制是差不多的，在 Redis 启动的时候会检查 rdb 或者是 aof 或者是两者都检查，根据持久化的文件来将数据恢复到内存中）</p>
<p>到此为止，<strong>从执行器开始调用存储引擎接口做了哪些事情呢</strong>？</p>
<ul>
<li>准备更新一条 SQL 语句</li>
<li>MySQL（innodb）会先去缓冲池（BufferPool）中去查找这条数据，没找到就会去磁盘中查找，如果查找到就会将这条数据加载</li>
<li>到缓冲池（BufferPool）中 3.在加载到 Buffer Pool 的同时，会将这条数据的原始记录保存到 undo 日志文件中</li>
<li>innodb 会在 Buffer Pool 中执行更新操作</li>
<li>更新后的数据会记录在 redo log buffer 中</li>
<li>MySQL 提交事务的时候，会将 redo log buffer 中的数据写入到 redo 日志文件中 刷磁盘可以通过 innodb_flush_log_at_trx_commit 参数来设置
<ul>
<li>值为 0 表示不刷入磁盘</li>
<li>值为 1 表示立即刷入磁盘</li>
<li>值为 2 表示先刷到 os cache</li>
</ul>
</li>
<li>myslq 重启的时候会将 redo 日志恢复到缓冲池中</li>
</ul>
<p>截止到目前位置，MySQL 的执行器调用存储引擎的接口去执行【执行计划】提供的 SQL 的时候 InnoDB 做了哪些事情也就基本差不多了，但是这还没完。下面还需要介绍下 MySQL 级别的日志文件 bin log</p>
<h2 id=bin-log-日志文件记录整个操作过程>bin log 日志文件：记录整个操作过程</h2>
<p>上面介绍到的redo log是 InnoDB 存储引擎特有的日志文件，而bin log属于是 MySQL 级别的日志。redo log记录的东西是偏向于物理性质的，如：“对什么数据，做了什么修改”。bin log是偏向于逻辑性质的，类似于：“对 students 表中的 id 为 1 的记录做了更新操作” 两者的主要特点总结如下:</p>
<table>
<thead>
<tr>
<th>性质</th>
<th>redo Log</th>
<th>bin Log</th>
</tr>
</thead>
<tbody>
<tr>
<td>文件大小</td>
<td>redo log 的大小是固定的（配置中也可以设置，一般默认的就足够了）</td>
<td>bin log 可通过配置参数max_bin log_size设置每个bin log文件的大小（但是一般不建议修改）。</td>
</tr>
<tr>
<td>实现方式</td>
<td>redo log是InnoDB引擎层实现的（也就是说是 Innodb 存储引起过独有的）</td>
<td>bin log是 MySQL 层实现的，所有引擎都可以使用 bin log日志</td>
</tr>
<tr>
<td>记录方式</td>
<td>redo log 采用循环写的方式记录，当写到结尾时，会回到开头循环写日志。</td>
<td>bin log 通过追加的方式记录，当文件大小大于给定值后，后续的日志会记录到新的文件上</td>
</tr>
<tr>
<td>使用场景</td>
<td>redo log适用于崩溃恢复(crash-safe)（这一点其实非常类似与 Redis 的持久化特征）</td>
<td>bin log 适用于主从复制和数据恢复</td>
</tr>
</tbody>
</table>
<p><strong>bin log文件是如何刷入磁盘的</strong>?</p>
<p>bin log 的刷盘是有相关的策略的，策略可以通过sync_bin log来修改，默认为 0，表示先写入 os cache，也就是说在提交事务的时候，数据不会直接到磁盘中，这样如果宕机bin log数据仍然会丢失。所以建议将sync_bin log设置为 1 表示直接将数据写入到磁盘文件中。</p>
<p>刷入 bin log 有以下几种模式</p>
<ul>
<li><strong>STATMENT</strong></li>
</ul>
<p>基于 SQL 语句的复制(statement-based replication, SBR)，每一条会修改数据的 SQL 语句会记录到 bin log 中</p>
<p>【优点】：不需要记录每一行的变化，减少了 bin log 日志量，节约了 IO , 从而提高了性能</p>
<p>【缺点】：在某些情况下会导致主从数据不一致，比如执行sysdate()、slepp()等</p>
<ul>
<li><strong>ROW</strong></li>
</ul>
<p>基于行的复制(row-based replication, RBR)，不记录每条SQL语句的上下文信息，仅需记录哪条数据被修改了</p>
<p>【优点】：不会出现某些特定情况下的存储过程、或 function、或 trigger 的调用和触发无法被正确复制的问题</p>
<p>【缺点】：会产生大量的日志，尤其是 alter table 的时候会让日志暴涨</p>
<ul>
<li><strong>MIXED</strong></li>
</ul>
<p>基于 STATMENT 和 ROW 两种模式的混合复制( mixed-based replication, MBR )，一般的复制使用 STATEMENT 模式保存 bin log ，对于 STATEMENT 模式无法复制的操作使用 ROW 模式保存 bin log</p>
<p>那既然bin log也是日志文件，那它是在什么记录数据的呢？</p>
<p>其实 MySQL 在提交事务的时候，不仅仅会将 redo log buffer 中的数据写入到redo log 文件中，同时也会将本次修改的数据记录到 bin log文件中，同时会将本次修改的bin log文件名和修改的内容在bin log中的位置记录到redo log中，最后还会在redo log最后写入 commit 标记，这样就表示本次事务被成功的提交了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195659.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如果在数据被写入到bin log文件的时候，刚写完，数据库宕机了，数据会丢失吗？</p>
<p>首先可以确定的是，只要redo log最后没有 commit 标记，说明本次的事务一定是失败的。但是数据是没有丢失了，因为已经被记录到redo log的磁盘文件中了。在 MySQL 重启的时候，就会将 redo log 中的数据恢复（加载）到Buffer Pool中。</p>
<p>好了，到目前为止，一个更新操作我们基本介绍得差不多，但是你有没有感觉少了哪件事情还没有做？是不是你也发现这个时候被更新记录仅仅是在内存中执行的，哪怕是宕机又恢复了也仅仅是将更新后的记录加载到Buffer Pool中，这个时候 MySQL 数据库中的这条记录依旧是旧值，也就是说内存中的数据在我们看来依旧是脏数据，那这个时候怎么办呢？</p>
<p>其实 MySQL 会有一个后台线程，它会在某个时机将我们Buffer Pool中的脏数据刷到 MySQL 数据库中，这样就将内存和数据库的数据保持统一了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503195713.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=本文总结>本文总结</h2>
<p>到此，关于Buffer Pool、Redo Log Buffer 和undo log、redo log、bin log 概念以及关系就基本差不多了。</p>
<p>我们再回顾下</p>
<ul>
<li>Buffer Pool 是 MySQL 的一个非常重要的组件，因为针对数据库的增删改操作都是在 Buffer Pool 中完成的</li>
<li>Undo log 记录的是数据操作前的样子</li>
<li>redo log 记录的是数据被操作后的样子（redo log 是 Innodb 存储引擎特有）</li>
<li>bin log 记录的是整个操作记录（这个对于主从复制具有非常重要的意义）</li>
</ul>
<p>从准备更新一条数据到事务的提交的流程描述</p>
<ul>
<li>首先执行器根据 MySQL 的执行计划来查询数据，先是从缓存池中查询数据，如果没有就会去数据库中查询，如果查询到了就将其放到缓存池中</li>
<li>在数据被缓存到缓存池的同时，会写入 undo log 日志文件</li>
<li>更新的动作是在 BufferPool 中完成的，同时会将更新后的数据添加到 redo log buffer 中</li>
<li>完成以后就可以提交事务，在提交的同时会做以下三件事
<ul>
<li>将redo log buffer中的数据刷入到 redo log 文件中</li>
<li>将本次操作记录写入到 bin log文件中</li>
<li>将 bin log 文件名字和更新内容在 bin log 中的位置记录到redo log中，同时在 redo log 最后添加 commit 标记</li>
</ul>
</li>
</ul>
<p>至此表示整个更新事务已经完成</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c98eb4e5d30b0012286d2018ebc8246d>4 - MySQL 实战</h1>
</div>
<div class=td-content>
<h1 id=pg-763a4cb19f42bf3fcb7e0895e1f01027>4.1 - CH01-基础架构</h1>
<h2 id=架构概览>架构概览</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211025222340.png style=display:block;width:80% alt=NAME align=center> </div>
<ul>
<li>服务层：
<ul>
<li>包括连接器、查询缓存、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。</li>
</ul>
</li>
<li>存储层：
<ul>
<li>负责数据的存储和提取。其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎。现在最常用的存储引擎是InnoDB，它从MySQL 5.5.5版本开始成为了默认存储引擎。</li>
</ul>
</li>
</ul>
<h2 id=连接器>连接器</h2>
<p>第一步，你会先连接到这个数据库上，这时候接待你的就是连接器。连接器负责跟客户端建立连接、获取权限、维持和管理连接。连接命令一般是这么写的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql -h<span style=color:#000>$ip</span> -P<span style=color:#000>$port</span> -u<span style=color:#000>$user</span> -p
<span style=color:#8f5902;font-style:italic># 输入密码</span>
</code></pre></div><p>虽然密码也可以直接跟在-p后面写在命令行中，但这样可能会导致你的密码泄露。如果你连的是生产服务器，强烈建议你不要这么做。</p>
<p>连接命令中的mysql是客户端工具，用来跟服务端建立连接。在完成经典的TCP握手后，连接器就要开始认证你的身份，这个时候用的就是你输入的用户名和密码。</p>
<ul>
<li>如果用户名或密码不对，你就会收到一个"Access denied for user"的错误，然后客户端程序结束执行。</li>
<li>如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。</li>
</ul>
<p>这就意味着，一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。</p>
<p>连接完成后，如果你没有后续的动作，这个连接就处于空闲状态，你可以在show processlist命令中看到它。文本中这个图是show processlist的结果，其中的Command列显示为“Sleep”的这一行，就表示现在系统里面有一个空闲连接。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211025222719.png style=display:block;width:80% alt=NAME align=center> </div>
<p>客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数wait_timeout控制的，默认值是8小时。</p>
<p>如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒： Lost connection to MySQL server during query。这时候如果你要继续，就需要重连，然后再执行请求了。</p>
<p>数据库里面，长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。</p>
<p>建立连接的过程通常是比较复杂的，所以我建议你在使用中要尽量减少建立连接的动作，也就是尽量使用长连接。</p>
<p>但是全部使用长连接后，你可能会发现，有些时候MySQL占用内存涨得特别快，这是因为MySQL在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是MySQL异常重启了。</p>
<p>怎么解决这个问题呢？你可以考虑以下两种方案。</p>
<ol>
<li>定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。</li>
<li>如果你用的是MySQL 5.7或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。</li>
</ol>
<h2 id=查询缓存>查询缓存</h2>
<p>连接建立完成后，你就可以执行select语句了。执行逻辑就会来到第二步：查询缓存。</p>
<p>MySQL拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以key-value对的形式，被直接缓存在内存中。key是查询的语句，value是查询的结果。如果你的查询能够直接在这个缓存中找到key，那么这个value就会被直接返回给客户端。</p>
<p>如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。你可以看到，如果查询命中缓存，MySQL不需要执行后面的复杂操作，就可以直接返回结果，这个效率会很高。</p>
<p><strong>但是大多数情况下我会建议你不要使用查询缓存，为什么呢？因为查询缓存往往弊大于利。</strong></p>
<p><strong>查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空</strong>。因此很可能你费劲地把结果存起来，还没使用呢，就被一个更新全清空了。对于更新压力大的数据库来说，查询缓存的命中率会非常低。除非你的业务就是有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。</p>
<p>好在MySQL也提供了这种“按需使用”的方式。你可以将参数<strong>query_cache_type设置成DEMAND</strong>，这样对于默认的SQL语句都不使用查询缓存。而对于你确定要使用查询缓存的语句，可以用SQL_CACHE显式指定，像下面这个语句一样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; <span style=color:#204a87;font-weight:700>select</span> SQL_CACHE * from T where <span style=color:#000>ID</span><span style=color:#ce5c00;font-weight:700>=</span>10；
</code></pre></div><p>需要注意的是，MySQL 8.0版本直接将查询缓存的整块功能删掉了，也就是说8.0开始彻底没有这个功能了。</p>
<h2 id=分析器>分析器</h2>
<p>如果没有命中查询缓存，就要开始真正执行语句了。首先，MySQL需要知道你要做什么，因此需要对SQL语句做解析。</p>
<p>分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条SQL语句，MySQL需要识别出里面的字符串分别是什么，代表什么。</p>
<p>MySQL从你输入的"select"这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名T”，把字符串“ID”识别成“列ID”。</p>
<p>做完了这些识别以后，就要做“语法分析”。根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个SQL语句是否满足MySQL语法。</p>
<p>如果你的语句不对，就会收到“You have an error in your SQL syntax”的错误提醒，比如下面这个语句select少打了开头的字母“s”。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; elect * from t where <span style=color:#000>ID</span><span style=color:#ce5c00;font-weight:700>=</span>1<span style=color:#000;font-weight:700>;</span>

ERROR <span style=color:#0000cf;font-weight:700>1064</span> <span style=color:#ce5c00;font-weight:700>(</span>42000<span style=color:#ce5c00;font-weight:700>)</span>: You have an error in your SQL syntax<span style=color:#000;font-weight:700>;</span> check the manual that corresponds to your MySQL server version <span style=color:#204a87;font-weight:700>for</span> the right syntax to use near <span style=color:#4e9a06>&#39;elect * from t where ID=1&#39;</span> at line <span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><p>一般语法错误会提示第一个出现错误的位置，所以你要关注的是紧接“<strong>use near</strong>”的内容。</p>
<h2 id=优化器>优化器</h2>
<p>经过了分析器，MySQL就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。</p>
<p>优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。比如你执行下面这样的语句，这个语句是执行两个表的join：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; <span style=color:#204a87;font-weight:700>select</span> * from t1 join t2 using<span style=color:#ce5c00;font-weight:700>(</span>ID<span style=color:#ce5c00;font-weight:700>)</span>  where t1.c<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span> and t2.d<span style=color:#ce5c00;font-weight:700>=</span>20<span style=color:#000;font-weight:700>;</span>
</code></pre></div><ul>
<li>既可以先从表t1里面取出c=10的记录的ID值，再根据ID值关联到表t2，再判断t2里面d的值是否等于20。</li>
<li>也可以先从表t2里面取出d=20的记录的ID值，再根据ID值关联到t1，再判断t1里面c的值是否等于10。</li>
</ul>
<p>这两种执行方法的逻辑结果是一样的，但是执行的效率会有不同，而优化器的作用就是决定选择使用哪一个方案。</p>
<p>优化器阶段完成后，这个语句的执行方案就确定下来了，然后进入执行器阶段。</p>
<h2 id=执行器>执行器</h2>
<p>MySQL通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。</p>
<p>开始执行的时候，<strong>要先判断一下你对这个表T有没有执行查询的权限</strong>，如果没有，就会返回没有权限的错误，如下所示(在工程实现上，如果命中查询缓存，会在查询缓存放回结果的时候，做权限验证。查询也会在优化器之前调用precheck验证权限)。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; <span style=color:#204a87;font-weight:700>select</span> * from T where <span style=color:#000>ID</span><span style=color:#ce5c00;font-weight:700>=</span>10<span style=color:#000;font-weight:700>;</span>

ERROR <span style=color:#0000cf;font-weight:700>1142</span> <span style=color:#ce5c00;font-weight:700>(</span>42000<span style=color:#ce5c00;font-weight:700>)</span>: SELECT <span style=color:#204a87>command</span> denied to user <span style=color:#4e9a06>&#39;b&#39;</span>@<span style=color:#4e9a06>&#39;localhost&#39;</span> <span style=color:#204a87;font-weight:700>for</span> table <span style=color:#4e9a06>&#39;T&#39;</span>
</code></pre></div><p>如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口。</p>
<p>比如我们这个例子中的表T中，ID字段没有索引，那么执行器的执行流程是这样的：</p>
<ol>
<li>调用InnoDB引擎接口取这个表的第一行，判断ID值是不是10，如果不是则跳过，如果是则将这行存在结果集中；</li>
<li>调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</li>
<li>执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</li>
</ol>
<p>至此，这个语句就执行完成了。</p>
<p>对于有索引的表，执行的逻辑也差不多。第一次调用的是“取满足条件的第一行”这个接口，之后循环取“满足条件的下一行”这个接口，这些接口都是引擎中已经定义好的。</p>
<p>你会在数据库的慢查询日志中看到一个rows_examined的字段，表示这个语句执行过程中扫描了多少行。这个值就是在执行器每次调用引擎获取数据行的时候累加的。</p>
<p>在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此<strong>引擎扫描行数跟rows_examined并不是完全相同的。</strong></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1b4b5a489c633646179898f8f72f66d8>4.2 - MySQL</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-557271842e3f9b6b61f8f0a1bbe2a7ca>4.3 - MySQL</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b26ced95223bb69a1c58b680a8a4194b>4.4 - MySQL</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8e6aafa223e735459e0969042de4d54f>4.5 - MySQL</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5a6f17ddd74c080d6a6db2bc41956240>4.6 - MySQL</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b3a9aaf767396fa16fcdb3ef3e2418e2>4.7 - MySQL</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f15574a70dd70677547f9af779af61e7>4.8 - MySQL</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d94c10e940f788e4706645fab4ee4d18>4.9 - CH02-日志系统</h1>
<p>我们从一个表的一条更新语句说起，下面是这个表的创建语句，这个表有一个主键ID和一个整型字段c：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mysql&gt; create table T(ID int primary key, c int);
</code></pre></div><p>如果要将ID=2这一行的值加1，SQL语句就会这么写：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mysql&gt; update T set c=c+1 where ID=2;
</code></pre></div><p>前面我有跟你介绍过SQL语句基本的执行链路，这里我再把那张图拿过来，你也可以先简单看看这个图回顾下。首先，可以确定的说，查询语句的那一套流程，更新语句也是同样会走一遍。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211025224933.png style=display:block;width:80% alt=NAME align=center> </div>
<p>执行语句前要先连接数据库，这是连接器的工作。</p>
<p>前面我们说过，在一个表上有更新的时候，跟这个表有关的查询缓存会失效，所以这条语句就会把表T上所有缓存结果都清空。这也就是我们一般不建议使用查询缓存的原因。</p>
<p>接下来，分析器会通过词法和语法解析知道这是一条更新语句。优化器决定要使用ID这个索引。然后，执行器负责具体执行，找到这一行，然后更新。</p>
<p>与查询流程不一样的是，更新流程还涉及两个重要的日志模块，它们正是我们今天要讨论的主角：<strong>redo log（重做日志）和 binlog（归档日志）</strong>。如果接触MySQL，那这两个词肯定是绕不过的，我后面的内容里也会不断地和你强调。不过话说回来，redo log和binlog在设计上有很多有意思的地方，这些设计思路也可以用到你自己的程序里。</p>
<h2 id=redo-log>redo log</h2>
<p>不知道你还记不记得《孔乙己》这篇文章，酒店掌柜有一个粉板，专门用来记录客人的赊账记录。如果赊账的人不多，那么他可以把顾客名和账目写在板上。但如果赊账的人多了，粉板总会有记不下的时候，这个时候掌柜一定还有一个专门记录赊账的账本。</p>
<p>如果有人要赊账或者还账的话，掌柜一般有两种做法：</p>
<ul>
<li>一种做法是直接把账本翻出来，把这次赊的账加上去或者扣除掉；</li>
<li>另一种做法是先在粉板上记下这次的账，等打烊以后再把账本翻出来核算。</li>
</ul>
<p>在生意红火柜台很忙时，掌柜一定会选择后者，因为前者操作实在是太麻烦了。首先，你得找到这个人的赊账总额那条记录。你想想，密密麻麻几十页，掌柜要找到那个名字，可能还得带上老花镜慢慢找，找到之后再拿出算盘计算，最后再将结果写回到账本上。</p>
<p>这整个过程想想都麻烦。相比之下，还是先在粉板上记一下方便。你想想，如果掌柜没有粉板的帮助，每次记账都得翻账本，效率是不是低得让人难以忍受？</p>
<p>同样，在MySQL里也有这个问题，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程IO成本、查找成本都很高。为了解决这个问题，MySQL的设计者就用了类似酒店掌柜粉板的思路来提升更新效率。</p>
<p><strong>而粉板和账本配合的整个过程，其实就是MySQL里经常说到的WAL技术，WAL的全称是Write-Ahead Logging，它的关键点就是先写日志，再写磁盘，也就是先写粉板，等不忙的时候再写账本。</strong></p>
<p><strong>具体来说，当有一条记录需要更新的时候，InnoDB引擎就会先把记录写到redo log（粉板）里面，并更新内存，这个时候更新就算完成了。同时，InnoDB引擎会在适当的时候，将这个操作记录更新到磁盘里面，而这个更新往往是在系统比较空闲的时候做，这就像打烊以后掌柜做的事。</strong></p>
<p>如果今天赊账的不多，掌柜可以等打烊后再整理。但如果某天赊账的特别多，粉板写满了，又怎么办呢？这个时候掌柜只好放下手中的活儿，把粉板中的一部分赊账记录更新到账本中，然后把这些记录从粉板上擦掉，为记新账腾出空间。</p>
<p>与此类似，InnoDB的redo log是固定大小的，比如可以配置为一组4个文件，每个文件的大小是1GB，那么这块“粉板”总共就可以记录4GB的操作。从头开始写，写到末尾就又回到开头循环写，如下面这个图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211025225326.png style=display:block;width:80% alt=NAME align=center> </div>
<p>write pos是当前记录的位置，一边写一边后移，写到第3号文件末尾后就回到0号文件开头。checkpoint是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件。</p>
<p>write pos和checkpoint之间的是“粉板”上还空着的部分，可以用来记录新的操作。如果write pos追上checkpoint，表示“粉板”满了，这时候不能再执行新的更新，得停下来先擦掉一些记录，把checkpoint推进一下。</p>
<p>有了redo log，InnoDB就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，这个能力称为<strong>crash-safe</strong>。</p>
<p>要理解crash-safe这个概念，可以想想我们前面赊账记录的例子。只要赊账记录记在了粉板上或写在了账本上，之后即使掌柜忘记了，比如突然停业几天，恢复生意后依然可以通过账本和粉板上的数据明确赊账账目。</p>
<h2 id=binlog>binlog</h2>
<p>前面我们讲过，MySQL整体来看，其实就有两块：一块是Server层，它主要做的是MySQL功能层面的事情；还有一块是引擎层，负责存储相关的具体事宜。上面我们聊到的粉板redo log是InnoDB引擎特有的日志，而Server层也有自己的日志，称为binlog（归档日志）。</p>
<p>我想你肯定会问，为什么会有两份日志呢？</p>
<p>因为最开始MySQL里并没有InnoDB引擎。MySQL自带的引擎是MyISAM，但是MyISAM没有crash-safe的能力，binlog日志只能用于归档。而InnoDB是另一个公司以插件形式引入MySQL的，既然只依靠binlog是没有crash-safe能力的，所以InnoDB使用另外一套日志系统——也就是redo log来实现crash-safe能力。</p>
<p>这两种日志有以下三点不同。</p>
<ol>
<li>redo log是InnoDB引擎特有的；binlog是MySQL的Server层实现的，所有引擎都可以使用。</li>
<li>redo log是物理日志，记录的是“在某个数据页上做了什么修改”；binlog是逻辑日志，记录的是这个语句的原始逻辑，比如“给ID=2这一行的c字段加1 ”。</li>
<li>redo log是循环写的，空间固定会用完；binlog是可以追加写入的。“追加写”是指binlog文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。</li>
</ol>
<p>有了对这两个日志的概念性理解，我们再来看执行器和InnoDB引擎在执行这个简单的update语句时的内部流程。</p>
<ol>
<li>执行器先找引擎取ID=2这一行。ID是主键，引擎直接用树搜索找到这一行。如果ID=2这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回。</li>
<li>执行器拿到引擎给的行数据，把这个值加上1，比如原来是N，现在就是N+1，得到新的一行数据，再调用引擎接口写入这行新数据。</li>
<li>引擎将这行新数据更新到内存中，同时将这个更新操作记录到redo log里面，此时redo log处于prepare状态。然后告知执行器执行完成了，随时可以提交事务。</li>
<li>执行器生成这个操作的binlog，并把binlog写入磁盘。</li>
<li>执行器调用引擎的提交事务接口，引擎把刚刚写入的redo log改成提交（commit）状态，更新完成。</li>
</ol>
<p>这里我给出这个update语句的执行流程图，图中浅色框表示是在InnoDB内部执行的，深色框表示是在执行器中执行的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211025225717.png style=display:block;width:80% alt=NAME align=center> </div>
<p>你可能注意到了，最后三步看上去有点“绕”，将redo log的写入拆成了两个步骤：prepare和commit，这就是"两阶段提交"。</p>
<h2 id=两阶段提交>两阶段提交</h2>
<p>为什么必须有“两阶段提交”呢？这是为了让两份日志之间的逻辑一致。要说明这个问题，我们得从文章开头的那个问题说起：<strong>怎样让数据库恢复到半个月内任意一秒的状态？</strong></p>
<p>前面我们说过了，binlog会记录所有的逻辑操作，并且是采用“追加写”的形式。如果你的DBA承诺说半个月内可以恢复，那么备份系统中一定会保存最近半个月的所有binlog，同时系统会定期做整库备份。这里的“定期”取决于系统的重要性，可以是一天一备，也可以是一周一备。</p>
<p>当需要恢复到指定的某一秒时，比如某天下午两点发现中午十二点有一次误删表，需要找回数据，那你可以这么做：</p>
<ul>
<li>首先，找到最近的一次全量备份，如果你运气好，可能就是昨天晚上的一个备份，从这个备份恢复到临时库；</li>
<li>然后，从备份的时间点开始，将备份的binlog依次取出来，重放到中午误删表之前的那个时刻。</li>
</ul>
<p>这样你的临时库就跟误删之前的线上库一样了，然后你可以把表数据从临时库取出来，按需要恢复到线上库去。</p>
<p>好了，说完了数据恢复过程，我们回来说说，为什么日志需要“两阶段提交”。这里不妨用反证法来进行解释。</p>
<p>由于redo log和binlog是两个独立的逻辑，如果不用两阶段提交，要么就是先写完redo log再写binlog，或者采用反过来的顺序。我们看看这两种方式会有什么问题。</p>
<p>仍然用前面的update语句来做例子。假设当前ID=2的行，字段c的值是0，再假设执行update语句过程中在写完第一个日志后，第二个日志还没有写完期间发生了crash，会出现什么情况呢？</p>
<ol>
<li><strong>先写redo log后写binlog</strong>。假设在redo log写完，binlog还没有写完的时候，MySQL进程异常重启。由于我们前面说过的，redo log写完之后，系统即使崩溃，仍然能够把数据恢复回来，所以恢复后这一行c的值是1。
但是由于binlog没写完就crash了，这时候binlog里面就没有记录这个语句。因此，之后备份日志的时候，存起来的binlog里面就没有这条语句。
然后你会发现，如果需要用这个binlog来恢复临时库的话，由于这个语句的binlog丢失，这个临时库就会少了这一次更新，恢复出来的这一行c的值就是0，与原库的值不同。</li>
<li><strong>先写binlog后写redo log</strong>。如果在binlog写完之后crash，由于redo log还没写，崩溃恢复以后这个事务无效，所以这一行c的值是0。但是binlog里面已经记录了“把c从0改成1”这个日志。所以，在之后用binlog来恢复的时候就多了一个事务出来，恢复出来的这一行c的值就是1，与原库的值不同。</li>
</ol>
<p>可以看到，如果不使用“两阶段提交”，那么数据库的状态就有可能和用它的日志恢复出来的库的状态不一致。</p>
<p>你可能会说，这个概率是不是很低，平时也没有什么动不动就需要恢复临时库的场景呀？</p>
<p>其实不是的，不只是误操作后需要用这个过程来恢复数据。当你需要扩容的时候，也就是需要再多搭建一些备库来增加系统的读能力的时候，现在常见的做法也是用全量备份加上应用binlog来实现的，这个“不一致”就会导致你的线上出现主从数据库不一致的情况。</p>
<p>简单说，redo log和binlog都可以用于表示事务的提交状态，而两阶段提交就是让这两个状态保持逻辑上的一致。</p>
<h2 id=总结>总结</h2>
<p>物理日志redo log和逻辑日志binlog。</p>
<p>redo log用于保证crash-safe能力。innodb_flush_log_at_trx_commit这个参数设置成1的时候，表示每次事务的redo log都直接持久化到磁盘。这个参数我建议你设置成1，这样可以保证MySQL异常重启之后数据不丢失。</p>
<p>sync_binlog这个参数设置成1的时候，表示每次事务的binlog都持久化到磁盘。这个参数我也建议你设置成1，这样可以保证MySQL异常重启之后binlog不丢失。</p>
<p>两阶段提交是跨系统维持数据逻辑一致性时常用的一个方案，即使你不做数据库内核开发，日常开发中也有可能会用到。</p>
<blockquote>
<p>redo是物理的，binlog是逻辑的；现在由于redo是属于InnoDB引擎，所以必须要有binlog，因为你可以使用别的引擎。
保证数据库的一致性，必须要保证2份日志一致，使用的2阶段式提交；类似事务，不是成功就是失败，不能让中间环节出现，也就是一个成功，一个失败。</p>
</blockquote>
<h2 id=流程>流程</h2>
<ol>
<li>首先客户端通过tcp/ip发送一条sql语句到server层的SQL interface</li>
<li>SQL interface接到该请求后，先对该条语句进行解析，验证权限是否匹配</li>
<li>验证通过以后，分析器会对该语句分析,是否语法有错误等</li>
<li>接下来是优化器器生成相应的执行计划，选择最优的执行计划</li>
<li>之后会是执行器根据执行计划执行这条语句。在这一步会去open table,如果该table上有MDL，则等待。
如果没有，则加在该表上加短暂的MDL(S)
(如果opend_table太大,表明open_table_cache太小。需要不停的去打开frm文件)</li>
<li>进入到引擎层，首先会去innodb_buffer_pool里的data dictionary(元数据信息)得到表信息</li>
<li>通过元数据信息,去lock info里查出是否会有相关的锁信息，并把这条update语句需要的
锁信息写入到lock info里(锁这里还有待补充)</li>
<li>然后涉及到的老数据通过快照的方式存储到innodb_buffer_pool里的undo page里,并且记录undo log修改的redo
(如果data page里有就直接载入到undo page里，如果没有，则需要去磁盘里取出相应page的数据，载入到undo page里)</li>
<li>在innodb_buffer_pool的data page做update操作。并把操作的物理数据页修改记录到redo log buffer里
由于update这个事务会涉及到多个页面的修改，所以redo log buffer里会记录多条页面的修改信息。
因为group commit的原因，这次事务所产生的redo log buffer可能会跟随其它事务一同flush并且sync到磁盘上</li>
<li>同时修改的信息，会按照event的格式,记录到binlog_cache中。(这里注意binlog_cache_size是transaction级别的,不是session级别的参数,
一旦commit之后，dump线程会从binlog_cache里把event主动发送给slave的I/O线程)</li>
<li>之后把这条sql,需要在二级索引上做的修改，写入到change buffer page，等到下次有其他sql需要读取该二级索引时，再去与二级索引做merge
(随机I/O变为顺序I/O,但是由于现在的磁盘都是SSD,所以对于寻址来说,随机I/O和顺序I/O差距不大)</li>
<li>此时update语句已经完成，需要commit或者rollback。这里讨论commit的情况，并且双1</li>
<li>commit操作，由于存储引擎层与server层之间采用的是内部XA(保证两个事务的一致性,这里主要保证redo log和binlog的原子性),
所以提交分为prepare阶段与commit阶段</li>
<li>prepare阶段,将事务的xid写入，将binlog_cache里的进行flush以及sync操作(大事务的话这步非常耗时)</li>
<li>commit阶段，由于之前该事务产生的redo log已经sync到磁盘了。所以这步只是在redo log里标记commit</li>
<li>当binlog和redo log都已经落盘以后，如果触发了刷新脏页的操作，先把该脏页复制到doublewrite buffer里，把doublewrite buffer里的刷新到共享表空间，然后才是通过page cleaner线程把脏页写入到磁盘中</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1fed0fae3032d08ee3c0cb9fd99595b3>4.10 - CH03-事务隔离</h1>
<p>和数据库打交道的时候，我们总是会用到事务。最经典的例子就是转账，你要给朋友小王转100块钱，而此时你的银行卡只有100块钱。</p>
<p>转账过程具体到程序里会有一系列的操作，比如查询余额、做加减法、更新余额等，这些操作必须保证是一体的，不然等程序查完之后，还没做减法之前，你这100块钱，完全可以借着这个时间差再查一次，然后再给另外一个朋友转账，如果银行这么整，不就乱了么？这时就要用到“事务”这个概念了。</p>
<p>简单来说，事务就是要保证一组数据库操作，要么全部成功，要么全部失败。在MySQL中，事务支持是在引擎层实现的。你现在知道，MySQL是一个支持多引擎的系统，但并不是所有的引擎都支持事务。<strong>比如MySQL原生的MyISAM引擎就不支持事务，这也是MyISAM被InnoDB取代的重要原因之一。</strong></p>
<p>今天的文章里，我将会以InnoDB为例，剖析MySQL在事务支持方面的特定实现，并基于原理给出相应的实践建议，希望这些案例能加深你对MySQL事务原理的理解。</p>
<h2 id=隔离性与隔离级别>隔离性与隔离级别</h2>
<p>提到事务，你肯定会想到<strong>ACID（Atomicity、Consistency、Isolation、Durability</strong>，即原子性、一致性、隔离性、持久性），今天我们就来说说其中I，也就是“隔离性”。</p>
<p>当数据库上有多个事务同时执行的时候，就可能出现**脏读（dirty read）、不可重复读（non-repeatable read）、幻读（phantom read）**的问题，为了解决这些问题，就有了“<strong>隔离级别</strong>”的概念。</p>
<p>在谈隔离级别之前，你首先要知道，你隔离得越严实，效率就会越低。因此很多时候，我们都要在二者之间寻找一个平衡点。SQL标准的事务隔离级别包括：读未提交（read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（serializable ）。下面我逐一为你解释：</p>
<ul>
<li><strong>读未提交是指</strong>，一个事务还没提交时，它做的变更就能被别的事务看到。</li>
<li><strong>读提交是指</strong>，一个事务提交之后，它做的变更才会被其他事务看到。</li>
<li><strong>可重复读是指</strong>，一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的。当然在可重复读隔离级别下，未提交变更对其他事务也是不可见的。</li>
<li><strong>串行化</strong>，顾名思义是对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。</li>
</ul>
<p>其中“读提交”和“可重复读”比较难理解，所以我用一个例子说明这几种隔离级别。假设数据表T中只有一列，其中一行的值为1，下面是按照时间顺序执行两个事务的行为。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql&gt; create table T<span style=color:#ce5c00;font-weight:700>(</span>c int<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span>InnoDB<span style=color:#000;font-weight:700>;</span>
insert into T<span style=color:#ce5c00;font-weight:700>(</span>c<span style=color:#ce5c00;font-weight:700>)</span> values<span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211025233032.png style=display:block;width:60% alt=NAME align=center> </div>
<p>我们来看看在不同的隔离级别下，事务A会有哪些不同的返回结果，也就是图里面V1、V2、V3的返回值分别是什么。</p>
<ul>
<li>若隔离级别是“<strong>读未提交</strong>”， 则V1的值就是2。这时候事务B虽然还没有提交，但是结果已经被A看到了。因此，V2、V3也都是2。</li>
<li>若隔离级别是“<strong>读提交</strong>”，则V1是1，V2的值是2。事务B的更新在提交后才能被A看到。所以， V3的值也是2。</li>
<li>若隔离级别是“<strong>可重复读</strong>”，则V1、V2是1，V3是2。之所以V2还是1，遵循的就是这个要求：事务在执行期间看到的数据前后必须是一致的。</li>
<li>若隔离级别是“<strong>串行化</strong>”，则在事务B执行“将1改成2”的时候，会被锁住。直到事务A提交后，事务B才可以继续执行。所以从A的角度看， V1、V2值是1，V3的值是2。</li>
</ul>
<blockquote>
<p>可见性是相对的，要区分我的事务、别人的事务：</p>
<ul>
<li>读未提交：别人改数据的事务尚未提交，我在我的事务中也能读到。</li>
<li>读已提交：别人改数据的事务已经提交，我在我的事务中才能读到。</li>
<li>可重复读：别人改数据的事务已经提交，我在我的事务中也不去读。</li>
<li>串行：我的事务尚未提交，别人就别想改数据。</li>
</ul>
<p>这4种隔离级别，并行性能依次降低，安全性依次提高。</p>
</blockquote>
<p>在实现上，数据库里面会创建一个视图，访问的时候以视图的逻辑结果为准。</p>
<ul>
<li>在“<strong>可重复读</strong>”隔离级别下，这个视图是在事务启动时创建的，整个事务存在期间都用这个视图。</li>
<li>在“<strong>读提交</strong>”隔离级别下，这个视图是在每个SQL语句开始执行的时候创建的。</li>
<li>这里需要注意的是，“<strong>读未提交</strong>”隔离级别下直接返回记录上的最新值，没有视图概念；</li>
<li>而“串行化”隔离级别下直接用加锁的方式来避免并行访问。</li>
</ul>
<p>我们可以看到在不同的隔离级别下，数据库行为是有所不同的。Oracle数据库的默认隔离级别其实就是“读提交”，因此对于一些从Oracle迁移到MySQL的应用，为保证数据库隔离级别的一致，你一定要记得将MySQL的隔离级别设置为“读提交”。</p>
<p>配置的方式是，将启动参数transaction-isolation的值设置成READ-COMMITTED。你可以用show variables来查看当前的值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mysql&gt; show variables like &#39;transaction_isolation&#39;;

+-----------------------+----------------+

| Variable_name | Value |

+-----------------------+----------------+

| transaction_isolation | READ-COMMITTED |

+-----------------------+----------------+
</code></pre></div><p>总结来说，存在即合理，哪个隔离级别都有它自己的使用场景，你要根据自己的业务情况来定。我想<strong>你可能会问那什么时候需要“可重复读”的场景呢</strong>？我们来看一个数据校对逻辑的案例。</p>
<p>假设你在管理一个个人银行账户表。一个表存了每个月月底的余额，一个表存了账单明细。这时候你要做数据校对，也就是判断上个月的余额和当前余额的差额，是否与本月的账单明细一致。你一定希望在校对过程中，即使有用户发生了一笔新的交易，也不影响你的校对结果。</p>
<p>这时候使用“可重复读”隔离级别就很方便。事务启动时的视图可以认为是静态的，不受其他事务更新的影响。</p>
<h2 id=事务隔离的实现>事务隔离的实现</h2>
<p>理解了事务的隔离级别，我们再来看看事务隔离具体是怎么实现的。这里我们展开说明“可重复读”。</p>
<p>在MySQL中，实际上每条记录在更新的时候都会同时记录一条回滚操作。记录上的最新值，通过回滚操作，都可以得到前一个状态的值。</p>
<p>假设一个值从1被按顺序改成了2、3、4，在回滚日志里面就会有类似下面的记录。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211025233532.png style=display:block;width:80% alt=NAME align=center> </div>
<p>当前值是4，但是在查询这条记录的时候，不同时刻启动的事务会有不同的read-view。如图中看到的，在视图A、B、C里面，这一个记录的值分别是1、2、4，<strong>同一条记录在系统中可以存在多个版本，就是数据库的多版本并发控制（MVCC）</strong>。对于read-view A，要得到1，就必须将当前值依次执行图中所有的回滚操作得到。</p>
<p>同时你会发现，即使现在有另外一个事务正在将4改成5，这个事务跟read-view A、B、C对应的事务是不会冲突的。</p>
<p>你一定会问，回滚日志总不能一直保留吧，什么时候删除呢？答案是，在不需要的时候才删除。也就是说，系统会判断，当没有事务再需要用到这些回滚日志时，回滚日志会被删除。</p>
<p>什么时候才不需要了呢？就是<strong>当系统里没有比这个回滚日志更早的read-view的时候。</strong></p>
<p>基于上面的说明，我们来讨论一下为什么建议你尽量不要使用长事务。</p>
<p>长事务意味着系统里面会存在很老的事务视图。由于这些事务随时可能访问数据库里面的任何数据，所以这个事务提交之前，数据库里面它可能用到的回滚记录都必须保留，这就会导致大量占用存储空间。</p>
<p>在MySQL 5.5及以前的版本，回滚日志是跟数据字典一起放在ibdata文件里的，即使长事务最终提交，回滚段被清理，文件也不会变小。我见过数据只有20GB，而回滚段有200GB的库。最终只好为了清理回滚段，重建整个库。</p>
<p>除了对回滚段的影响，长事务还占用锁资源，也可能拖垮整个库，这个我们会在后面讲锁的时候展开。</p>
<h2 id=事务的启动方式>事务的启动方式</h2>
<p>如前面所述，长事务有这些潜在风险，我当然是建议你尽量避免。其实很多时候业务开发同学并不是有意使用长事务，通常是由于误用所致。MySQL的事务启动方式有以下几种：</p>
<ol>
<li>显式启动事务语句， begin 或 start transaction。配套的提交语句是commit，回滚语句是rollback。</li>
<li>set autocommit=0，这个命令会将这个线程的自动提交关掉。意味着如果你只执行一个select语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行commit 或 rollback 语句，或者断开连接。</li>
</ol>
<p>有些客户端连接框架会默认连接成功后先执行一个set autocommit=0的命令。这就导致接下来的查询都在事务中，如果是长连接，就导致了意外的长事务。</p>
<p>因此，我会建议你总是使用set autocommit=1, 通过显式语句的方式来启动事务。</p>
<p>但是有的开发同学会纠结“多一次交互”的问题。对于一个需要频繁使用事务的业务，第二种方式每个事务在开始时都不需要主动执行一次 “begin”，减少了语句的交互次数。如果你也有这个顾虑，我建议你使用commit work and chain语法。</p>
<p>在autocommit为1的情况下，用begin显式启动的事务，如果执行commit则提交事务。如果执行 commit work and chain，则是提交事务并自动启动下一个事务，这样也省去了再次执行begin语句的开销。同时带来的好处是从程序开发的角度明确地知道每个语句是否处于事务中。</p>
<p>你可以在information_schema库的innodb_trx这个表中查询长事务，比如下面这个语句，用于查找持续时间超过60s的事务。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87;font-weight:700>select</span> * from information_schema.innodb_trx where TIME_TO_SEC<span style=color:#ce5c00;font-weight:700>(</span>timediff<span style=color:#ce5c00;font-weight:700>(</span>now<span style=color:#ce5c00;font-weight:700>()</span>,trx_started<span style=color:#ce5c00;font-weight:700>))</span>&gt;60
</code></pre></div><h2 id=问题汇总>问题汇总</h2>
<ol>
<li>务的特性：原子性、一致性、隔离性、持久性</li>
<li>多事务同时执行的时候，可能会出现的问题：脏读、不可重复读、幻读</li>
<li>事务隔离级别：读未提交、读提交、可重复读、串行化</li>
<li>不同事务隔离级别的区别：
读未提交：一个事务还未提交，它所做的变更就可以被别的事务看到
读提交：一个事务提交之后，它所做的变更才可以被别的事务看到
可重复读：一个事务执行过程中看到的数据是一致的。未提交的更改对其他事务是不可见的
串行化：对应一个记录会加读写锁，出现冲突的时候，后访问的事务必须等前一个事务执行完成才能继续执行</li>
<li>配置方法：启动参数transaction-isolation</li>
<li>事务隔离的实现：每条记录在更新的时候都会同时记录一条回滚操作。同一条记录在系统中可以存在多个版本，这就是数据库的多版本并发控制（MVCC）。</li>
<li>回滚日志什么时候删除？系统会判断当没有事务需要用到这些回滚日志的时候，回滚日志会被删除。</li>
<li>什么时候不需要了？当系统里么有比这个回滚日志更早的read-view的时候。</li>
<li>为什么尽量不要使用长事务。长事务意味着系统里面会存在很老的事务视图，在这个事务提交之前，回滚记录都要保留，这会导致大量占用存储空间。除此之外，长事务还占用锁资源，可能会拖垮库。</li>
<li>事务启动方式：一、显式启动事务语句，begin或者start transaction,提交commit，回滚rollback；二、set autocommit=0，该命令会把这个线程的自动提交关掉。这样只要执行一个select语句，事务就启动，并不会自动提交，直到主动执行commit或rollback或断开连接。</li>
<li>建议使用方法一，如果考虑多一次交互问题，可以使用commit work and chain语法。在autocommit=1的情况下用begin显式启动事务，如果执行commit则提交事务。如果执行commit work and chain则提交事务并自动启动下一个事务。</li>
</ol>
<hr>
<ol>
<li>事务的概念是什么?</li>
<li>mysql的事务隔离级别读未提交, 读已提交, 可重复读, 串行各是什么意思?</li>
<li>读已提交, 可重复读是怎么通过视图构建实现的?</li>
<li>可重复读的使用场景举例? 对账的时候应该很有用?</li>
<li>事务隔离是怎么通过read-view(读视图)实现的?</li>
<li>并发版本控制(MCVV)的概念是什么, 是怎么实现的?</li>
<li>使用长事务的弊病? 为什么使用常事务可能拖垮整个库?</li>
<li>事务的启动方式有哪几种?</li>
<li>commit work and chain的语法是做什么用的?</li>
<li>怎么查询各个表中的长事务?</li>
<li>如何避免长事务的出现?</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9653d45f3d65839c479cbf585b3db5c7>5 - Redis</h1>
</div>
<div class=td-content>
<h1 id=pg-15dc494595c2bd4672f094c19c69802f>5.1 - CH01-基本类型</h1>
<h2 id=概览>概览</h2>
<p>Redis 中所有的 Key 都是字符串。我们在谈基础数据结构时，讨论的是存储值的数据类型，主要包括常见的5种数据类型，分别是：String、List、Set、Zset、Hash。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504125755.png style=display:block;width:50% alt=NAME align=center> </div>
<table>
<thead>
<tr>
<th>结构类型</th>
<th>值的形式</th>
<th>读写能力</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>String</strong></td>
<td>字符串、整数、浮点数</td>
<td>对整个字符串或字符串的一部分进行操作；对整数或浮点数进行自增或自减操作；</td>
</tr>
<tr>
<td><strong>List</strong></td>
<td>由字符串构造的链表</td>
<td>对链表的两端进行push和pop操作，读取单个或多个元素；根据值查找或删除元素；</td>
</tr>
<tr>
<td><strong>Set</strong></td>
<td>由无重复字符串构成的集合</td>
<td>字符串的集合，包含基础的方法有看是否存在添加、获取、删除；还包含计算交集、并集、差集等</td>
</tr>
<tr>
<td><strong>Hash</strong></td>
<td>由键值对构成的无序散列表</td>
<td>包含方法有添加、获取、删除单个元素</td>
</tr>
<tr>
<td><strong>Zset</strong></td>
<td>由键值对构成的有序集合</td>
<td>字符串成员与浮点数分数之间的有序映射；元素的排列顺序由分数的大小决定；包含方法有添加、获取、删除单个元素以及根据分值范围或成员来获取元素</td>
</tr>
</tbody>
</table>
<h2 id=string>String</h2>
<p>String是redis中最基本的数据类型，一个key对应一个value。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504130432.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=常用命令>常用命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>获取存储在给定键中的值</td>
<td>GET name</td>
</tr>
<tr>
<td>SET</td>
<td>设置存储在给定键中的值</td>
<td>SET name value</td>
</tr>
<tr>
<td>DEL</td>
<td>删除存储在给定键中的值</td>
<td>DEL name</td>
</tr>
<tr>
<td>INCR</td>
<td>将键存储的值加1</td>
<td>INCR key</td>
</tr>
<tr>
<td>DECR</td>
<td>将键存储的值减1</td>
<td>DECR key</td>
</tr>
<tr>
<td>INCRBY</td>
<td>将键存储的值加上整数</td>
<td>INCRBY key amount</td>
</tr>
<tr>
<td>DECRBY</td>
<td>将键存储的值减去整数</td>
<td>DECRBY key amount</td>
</tr>
</tbody>
</table>
<h3 id=应用场景>应用场景</h3>
<ul>
<li>
<p><strong>缓存</strong>： 经典使用场景，把常用信息，字符串，图片或者视频等信息放到redis中，redis作为缓存层，mysql做持久化层，降低mysql的读写压力。</p>
</li>
<li>
<p><strong>计数器</strong>：redis是单线程模型，一个命令执行完才会执行下一个，同时数据可以一步落地到其他的数据源。</p>
</li>
<li>
<p><strong>session</strong>：常见方案spring session + redis实现session共享</p>
</li>
</ul>
<h2 id=list>List</h2>
<p>Redis中的List其实就是链表（Redis用双端链表实现List）。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504130444.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=常用命令-1>常用命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>RPUSH</td>
<td>将给定值推入到列表右端</td>
<td>RPUSH key value</td>
</tr>
<tr>
<td>LPUSH</td>
<td>将给定值推入到列表左端</td>
<td>LPUSH key value</td>
</tr>
<tr>
<td>RPOP</td>
<td>从列表的右端弹出一个值，并返回被弹出的值</td>
<td>RPOP key</td>
</tr>
<tr>
<td>LPOP</td>
<td>从列表的左端弹出一个值，并返回被弹出的值</td>
<td>LPOP key</td>
</tr>
<tr>
<td>LRANGE</td>
<td>获取列表在给定范围上的所有值</td>
<td>LRANGE key 0 -1</td>
</tr>
<tr>
<td>LINDEX</td>
<td>通过索引获取列表中的元素。你也可以使用负数下标，以 -1 表示列表的最后一个元素， -2 表示列表的倒数第二个元素，以此类推。</td>
<td>LINEX key index</td>
</tr>
</tbody>
</table>
<h3 id=应用场景-1>应用场景</h3>
<ul>
<li><strong>微博TimeLine</strong>: 有人发布微博，用lpush加入时间轴，展示新的列表信息。</li>
<li><strong>消息队列</strong></li>
</ul>
<h2 id=set>Set</h2>
<p>Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。</p>
<p>Redis 中集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是 O(1)。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504130624.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=常用命令-2>常用命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>SADD</td>
<td>向集合添加一个或多个成员</td>
<td>SADD key value</td>
</tr>
<tr>
<td>SCARD</td>
<td>获取集合的成员数</td>
<td>SCARD key</td>
</tr>
<tr>
<td>SMEMBER</td>
<td>返回集合中的所有成员</td>
<td>SMEMBER key member</td>
</tr>
<tr>
<td>SISMEMBER</td>
<td>判断 member 元素是否是集合 key 的成员</td>
<td>SISMEMBER key member</td>
</tr>
</tbody>
</table>
<h3 id=应用场景-2>应用场景</h3>
<p><strong>实战场景</strong></p>
<ul>
<li><strong>标签</strong>（tag）,给用户添加标签，或者用户给消息添加标签，这样有同一标签或者类似标签的可以给推荐关注的事或者关注的人。</li>
<li><strong>点赞，或点踩，收藏等</strong>，可以放到set中实现</li>
</ul>
<h2 id=hash>Hash</h2>
<p>Redis hash 是一个 string 类型的 field（字段） 和 value（值） 的映射表，hash 特别适合用于存储对象。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504130731.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=常用命令-3>常用命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>HSET</td>
<td>添加键值对</td>
<td>HSET hash-key sub-key1 value1</td>
</tr>
<tr>
<td>HGET</td>
<td>获取指定散列键的值</td>
<td>HGET hash-key key1</td>
</tr>
<tr>
<td>HGETALL</td>
<td>获取散列中包含的所有键值对</td>
<td>HGETALL hash-key</td>
</tr>
<tr>
<td>HDEL</td>
<td>如果给定键存在于散列中，那么就移除这个键</td>
<td>HDEL hash-key sub-key1</td>
</tr>
</tbody>
</table>
<h3 id=应用场景-3>应用场景</h3>
<ul>
<li><strong>缓存</strong>： 能直观，相比string更节省空间，的维护缓存信息，如用户信息，视频信息等。</li>
</ul>
<h2 id=zset>ZSet</h2>
<p>Redis 有序集合和集合一样也是 string 类型元素的集合,且不允许重复的成员。不同的是每个元素都会关联一个 double 类型的分数。redis 正是通过分数来为集合中的成员进行从小到大的排序。</p>
<p>有序集合的成员是唯一的,但分数(score)却可以重复。集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是 O(1)。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504130854.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=常用命令-4>常用命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody>
<tr>
<td>ZADD</td>
<td>将一个带有给定分值的成员添加到哦有序集合里面</td>
<td>ZADD zset-key 178 member1</td>
</tr>
<tr>
<td>ZRANGE</td>
<td>根据元素在有序集合中所处的位置，从有序集合中获取多个元素</td>
<td>ZRANGE zset-key 0-1 withccores</td>
</tr>
<tr>
<td>ZREM</td>
<td>如果给定元素成员存在于有序集合中，那么就移除这个元素</td>
<td>ZREM zset-key member1</td>
</tr>
</tbody>
</table>
<h3 id=应用场景-4>应用场景</h3>
<ul>
<li><strong>排行榜</strong>：有序集合经典使用场景。例如小说视频等网站需要对用户上传的小说视频做排行榜，榜单可以按照用户关注数，更新时间，字数等打分，做排行。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-74fbd382412792c903e2f596fdcce9b7>5.2 - CH02-高级类型</h1>
<h2 id=hyperloglogs基数>HyperLogLogs：基数</h2>
<h3 id=什么是基数>什么是基数</h3>
<p>举个例子，A = {1, 2, 3, 4, 5}， B = {3, 5, 6, 7, 9}；那么基数（不重复的元素）= 1, 2, 4, 6, 7, 9； （允许容错，即可以接受一定误差）</p>
<h3 id=基本用途>基本用途</h3>
<p>这个结构可以非常省内存的去统计各种计数，比如注册 IP 数、每日访问 IP 数、页面实时UV、在线用户数，共同好友数等。</p>
<h3 id=结构优点>结构优点</h3>
<p>一个大型的网站，每天 IP 比如有 100 万，粗算一个 IP 消耗 15 字节，那么 100 万个 IP 就是 15M。而 HyperLogLog 在 Redis 中每个键占用的内容都是 12K，理论存储近似接近 2^64 个值，不管存储的内容是什么，它一个基于基数估算的算法，只能比较准确的估算出基数，可以使用少量固定的内存去存储并识别集合中的唯一元素。而且这个估算的基数并不一定准确，是一个带有 0.81% 标准错误的近似值（对于可以接受一定容错的业务场景，比如IP数统计，UV等，是可以忽略不计的）。</p>
<h3 id=操作命令>操作命令</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; pfadd key1 a b c d e f g h i	<span style=color:#8f5902;font-style:italic># 创建第一组元素</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>
127.0.0.1:6379&gt; pfcount key1					<span style=color:#8f5902;font-style:italic># 统计元素的基数数量</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>9</span>
127.0.0.1:6379&gt; pfadd key2 c j k l m e g a		<span style=color:#8f5902;font-style:italic># 创建第二组元素</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>
127.0.0.1:6379&gt; pfcount key2
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>8</span>
127.0.0.1:6379&gt; pfmerge key3 key1 key2			<span style=color:#8f5902;font-style:italic># 合并两组：key1 key2 -&gt; key3 并集</span>
OK
127.0.0.1:6379&gt; pfcount key3
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>13</span>
</code></pre></div><h2 id=bitmap位图>Bitmap：位图</h2>
<p>Bitmap 即位图数据结构，都是操作二进制位来进行记录，只有0 和 1 两个状态。</p>
<h3 id=基本用途-1>基本用途</h3>
<p>比如：统计用户信息，活跃，不活跃！ 登录，未登录！ 打卡，不打卡！ <strong>两个状态的，都可以使用 Bitmaps</strong>！</p>
<p>如果存储一年的打卡状态需要多少内存呢？ 365 天 = 365 bit 1字节 = 8bit 46 个字节左右！</p>
<h3 id=操作命令-1>操作命令</h3>
<p>使用bitmap 来记录 周一到周日的打卡！ 周一：1 周二：0 周三：0 周四：1 &mldr;&mldr;</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; setbit sign <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
127.0.0.1:6379&gt; setbit sign <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
127.0.0.1:6379&gt; setbit sign <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
127.0.0.1:6379&gt; setbit sign <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
127.0.0.1:6379&gt; setbit sign <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
127.0.0.1:6379&gt; setbit sign <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
127.0.0.1:6379&gt; setbit sign <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
</code></pre></div><p>查看某一天是否有打卡！</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; getbit sign <span style=color:#0000cf;font-weight:700>3</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>
127.0.0.1:6379&gt; getbit sign <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span>
</code></pre></div><p>统计操作，统计 打卡的天数！</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; bitcount sign <span style=color:#8f5902;font-style:italic># 统计这周的打卡记录，就可以看到是否有全勤！</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>3</span>
</code></pre></div><h2 id=geospatial地理位置>Geospatial：地理位置</h2>
<p>用于地理位置坐标的存储与计算。</p>
<h3 id=添加地理位置>添加地理位置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; geoadd china:city 118.76 32.04 manjing 112.55 37.86 taiyuan 123.43 41.80 shenyang
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>3</span>
127.0.0.1:6379&gt; geoadd china:city 144.05 22.52 shengzhen 120.16 30.24 hangzhou 108.96 34.26 xian
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>3</span>
</code></pre></div><h3 id=获取地理位置>获取地理位置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; geopos china:city taiyuan manjing
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;112.54999905824661255&#34;</span>
   1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;37.86000073876942196&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;118.75999957323074341&#34;</span>
   1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;32.03999960287850968&#34;</span>
</code></pre></div><h3 id=计算距离>计算距离</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; geodist china:city taiyuan shenyang m
<span style=color:#4e9a06>&#34;1026439.1070&#34;</span>
127.0.0.1:6379&gt; geodist china:city taiyuan shenyang km
<span style=color:#4e9a06>&#34;1026.4391&#34;</span>
</code></pre></div><h3 id=范围查找>范围查找</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8f5902;font-style:italic># 以 100,30 这个坐标为中心, 寻找半径为1000km的城市</span>
127.0.0.1:6379&gt; georadius china:city <span style=color:#0000cf;font-weight:700>110</span> <span style=color:#0000cf;font-weight:700>30</span> <span style=color:#0000cf;font-weight:700>1000</span> km
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;hangzhou&#34;</span>
3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;manjing&#34;</span>
4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;taiyuan&#34;</span>
127.0.0.1:6379&gt; georadius china:city <span style=color:#0000cf;font-weight:700>110</span> <span style=color:#0000cf;font-weight:700>30</span> <span style=color:#0000cf;font-weight:700>500</span> km
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
127.0.0.1:6379&gt; georadius china:city <span style=color:#0000cf;font-weight:700>110</span> <span style=color:#0000cf;font-weight:700>30</span> <span style=color:#0000cf;font-weight:700>500</span> km withdist
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;483.8340&#34;</span>
127.0.0.1:6379&gt; georadius china:city <span style=color:#0000cf;font-weight:700>110</span> <span style=color:#0000cf;font-weight:700>30</span> <span style=color:#0000cf;font-weight:700>1000</span> km withcoord withdist count <span style=color:#0000cf;font-weight:700>2</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;483.8340&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;108.96000176668167114&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;34.25999964418929977&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;manjing&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;864.9816&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;118.75999957323074341&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;32.03999960287850968&#34;</span>
</code></pre></div><p>参数：key 经度 纬度 半径 单位 显示结果的经度和纬度 显示结果的距离 显示的结果的数量</p>
<h3 id=范围相交>范围相交</h3>
<p>显示与指定成员一定半径范围内的其他成员：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; georadiusbymember china:city taiyuan <span style=color:#0000cf;font-weight:700>1000</span> km
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;manjing&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;taiyuan&#34;</span>
3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
127.0.0.1:6379&gt; georadiusbymember china:city taiyuan <span style=color:#0000cf;font-weight:700>1000</span> km withcoord withdist count <span style=color:#0000cf;font-weight:700>2</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;taiyuan&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;0.0000&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;112.54999905824661255&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;37.86000073876942196&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;514.2264&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;108.96000176668167114&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;34.25999964418929977&#34;</span>
</code></pre></div><h3 id=取-hash-值>取 Hash 值</h3>
<p>将二维的经纬度转换为一维的字符串, 如果两个字符串越接近, 则距离越近</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; geohash china:city taiyuan shenyang
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;ww8p3hhqmp0&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;wxrvb9qyxk0&#34;</span>
</code></pre></div><h3 id=底层实现>底层实现</h3>
<p>geo底层的实现原理实际上就是Zset, 我们可以通过Zset命令来操作geo：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; <span style=color:#204a87>type</span> china:city
zset
</code></pre></div><p>查看全部元素 删除指定的元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; zrange china:city <span style=color:#0000cf;font-weight:700>0</span> -1 withscores
 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
 2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;4040115445396757&#34;</span>
 3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;hangzhou&#34;</span>
 4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;4054133997236782&#34;</span>
 5<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;manjing&#34;</span>
 6<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;4066006694128997&#34;</span>
 7<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;taiyuan&#34;</span>
 8<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;4068216047500484&#34;</span>
 9<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;shenyang&#34;</span>
1<span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#4e9a06>&#34;4072519231994779&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#4e9a06>&#34;shengzhen&#34;</span>
3<span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#4e9a06>&#34;4154606886655324&#34;</span>
127.0.0.1:6379&gt; zrem china:city manjing
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>
127.0.0.1:6379&gt; zrange china:city <span style=color:#0000cf;font-weight:700>0</span> -1
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xian&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;hangzhou&#34;</span>
3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;taiyuan&#34;</span>
4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;shenyang&#34;</span>
5<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;shengzhen&#34;</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-fa602568c373b012706150061f875875>5.3 - CH03-Stream</h1>
<h2 id=概览>概览</h2>
<p>Redis5.0 中还增加了一个数据结构Stream，从字面上看是流类型，但其实从功能上看，应该是Redis对消息队列（MQ，Message Queue）的完善实现。</p>
<p>用过Redis做消息队列的都了解，基于Reids的消息队列实现有很多种，例如：</p>
<ul>
<li>PUB/SUB，订阅/发布模式：
<ul>
<li>但是发布订阅模式是无法持久化的，如果出现网络断开、Redis 宕机等，消息就会被丢弃；</li>
</ul>
</li>
<li>基于 List LPUSH+BRPOP 或者基于Sorted-Set 的实现：
<ul>
<li>支持了持久化，但是不支持多播，分组消费等</li>
</ul>
</li>
</ul>
<p>为什么上面的结构无法满足广泛的MQ场景？ 这里便引出一个核心的问题：如果我们期望设计一种数据结构来实现消息队列，最重要的就是要理解<strong>设计一个消息队列需要考虑什么</strong>？初步的我们很容易想到</p>
<ul>
<li>消息的生产</li>
<li>消息的消费
<ul>
<li>单播和多播（多对多）</li>
<li>阻塞和非阻塞读取</li>
</ul>
</li>
<li>消息有序性</li>
<li>消息的持久化</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504132556.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=基本结构>基本结构</h2>
<p>每个 Stream 都有唯一的名称，它就是 Redis 的 key，在我们首次使用 xadd 指令追加消息时自动创建。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504132658.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图解析：</p>
<ul>
<li><code>Consumer Group</code> ：消费组，使用 XGROUP CREATE 命令创建，一个消费组有多个消费者(Consumer), 这些消费者之间是竞争关系。</li>
<li><code>last_delivered_id</code> ：游标，每个消费组会有个游标 last_delivered_id，任意一个消费者读取了消息都会使游标 last_delivered_id 往前移动。</li>
<li><code>pending_ids</code> ：消费者(Consumer)的状态变量，作用是维护消费者的未确认的 id。 pending_ids 记录了当前已经被客户端读取的消息，但是还没有 <code>ack</code> (Acknowledge character：确认字符）。如果客户端没有ack，这个变量里面的消息ID会越来越多，一旦某个消息被ack，它就开始减少。这个pending_ids变量在Redis官方被称之为PEL，也就是Pending Entries List，这是一个很核心的数据结构，它用来确保客户端至少消费了消息一次，而不会在网络传输的中途丢失了没处理。</li>
</ul>
<p>此外我们还需要理解两点：</p>
<ul>
<li><code>消息ID</code>: 消息ID的形式是timestampInMillis-sequence，例如1527846880572-5，它表示当前的消息在毫米时间戳1527846880572时产生，并且是该毫秒内产生的第5条消息。消息ID可以由服务器自动生成，也可以由客户端自己指定，但是形式必须是整数-整数，而且必须是后面加入的消息的ID要大于前面的消息ID。</li>
<li><code>消息内容</code>: 消息内容就是键值对，形如hash结构的键值对，这没什么特别之处。</li>
</ul>
<h2 id=基本操作>基本操作</h2>
<p>消息队列相关命令：</p>
<ul>
<li>XADD - 添加消息到末尾</li>
<li>XTRIM - 对流进行修剪，限制长度</li>
<li>XDEL - 删除消息</li>
<li>XLEN - 获取流包含的元素数量，即消息长度</li>
<li>XRANGE - 获取消息列表，会自动过滤已经删除的消息</li>
<li>XREVRANGE - 反向获取消息列表，ID 从大到小</li>
<li>XREAD - 以阻塞或非阻塞方式获取消息列表</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8f5902;font-style:italic># *号表示服务器自动生成ID，后面顺序跟着一堆key/value</span>
127.0.0.1:6379&gt; xadd codehole * name laoqian age <span style=color:#0000cf;font-weight:700>30</span>  <span style=color:#8f5902;font-style:italic>#  名字叫laoqian，年龄30岁</span>
1527849609889-0  <span style=color:#8f5902;font-style:italic># 生成的消息ID</span>
127.0.0.1:6379&gt; xadd codehole * name xiaoyu age <span style=color:#0000cf;font-weight:700>29</span>
1527849629172-0
127.0.0.1:6379&gt; xadd codehole * name xiaoqian age <span style=color:#0000cf;font-weight:700>1</span>
1527849637634-0
127.0.0.1:6379&gt; xlen codehole
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>3</span>
127.0.0.1:6379&gt; xrange codehole - +  <span style=color:#8f5902;font-style:italic># -表示最小值, +表示最大值</span>
127.0.0.1:6379&gt; xrange codehole - +
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849609889-0
   1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;laoqian&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;30&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849629172-0
   1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xiaoyu&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;29&#34;</span>
3<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849637634-0
   1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xiaoqian&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>
127.0.0.1:6379&gt; xrange codehole 1527849629172-0 +  <span style=color:#8f5902;font-style:italic># 指定最小消息ID的列表</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849629172-0
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xiaoyu&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;29&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849637634-0
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xiaoqian&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>
127.0.0.1:6379&gt; xrange codehole - 1527849629172-0  <span style=color:#8f5902;font-style:italic># 指定最大消息ID的列表</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849609889-0
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;laoqian&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;30&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849629172-0
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xiaoyu&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;29&#34;</span>
127.0.0.1:6379&gt; xdel codehole 1527849609889-0
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>
127.0.0.1:6379&gt; xlen codehole  <span style=color:#8f5902;font-style:italic># 长度不受影响</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>3</span>
127.0.0.1:6379&gt; xrange codehole - +  <span style=color:#8f5902;font-style:italic># 被删除的消息没了</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849629172-0
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xiaoyu&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;29&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527849637634-0
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;xiaoqian&#34;</span>
      3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
      4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>
127.0.0.1:6379&gt; del codehole  <span style=color:#8f5902;font-style:italic># 删除整个Stream</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><h2 id=独立消费>独立消费</h2>
<p>我们可以在不定义消费组的情况下进行Stream消息的独立消费，当Stream没有新消息时，甚至可以阻塞等待。Redis设计了一个单独的消费指令xread，可以将Stream当成普通的消息队列(list)来使用。使用xread时，我们可以完全忽略消费组(Consumer Group)的存在，就好比Stream就是一个普通的列表(list)。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 从Stream头部读取两条消息</span>
127.0.0.1:6379&gt; xread count <span style=color:#0000cf;font-weight:700>2</span> streams codehole 0-0
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;codehole&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527851486781-0
         2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
            2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;laoqian&#34;</span>
            3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
            4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;30&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527851493405-0
         2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
            2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;yurui&#34;</span>
            3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
            4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;29&#34;</span>
<span style=color:#8f5902;font-style:italic># 从Stream尾部读取一条消息，毫无疑问，这里不会返回任何消息</span>
127.0.0.1:6379&gt; xread count <span style=color:#0000cf;font-weight:700>1</span> streams codehole $
<span style=color:#ce5c00;font-weight:700>(</span>nil<span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic># 从尾部阻塞等待新消息到来，下面的指令会堵住，直到新消息到来</span>
127.0.0.1:6379&gt; xread block <span style=color:#0000cf;font-weight:700>0</span> count <span style=color:#0000cf;font-weight:700>1</span> streams codehole $
<span style=color:#8f5902;font-style:italic># 我们从新打开一个窗口，在这个窗口往Stream里塞消息</span>
127.0.0.1:6379&gt; xadd codehole * name youming age <span style=color:#0000cf;font-weight:700>60</span>
1527852774092-0
<span style=color:#8f5902;font-style:italic># 再切换到前面的窗口，我们可以看到阻塞解除了，返回了新的消息内容</span>
<span style=color:#8f5902;font-style:italic># 而且还显示了一个等待时间，这里我们等待了93s</span>
127.0.0.1:6379&gt; xread block <span style=color:#0000cf;font-weight:700>0</span> count <span style=color:#0000cf;font-weight:700>1</span> streams codehole $
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;codehole&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1527852774092-0
         2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;name&#34;</span>
            2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;youming&#34;</span>
            3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;age&#34;</span>
            4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;60&#34;</span>
<span style=color:#ce5c00;font-weight:700>(</span>93.11s<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>客户端如果想要使用xread进行顺序消费，一定要记住当前消费到哪里了，也就是返回的消息ID。下次继续调用xread时，将上次返回的最后一个消息ID作为参数传递进去，就可以继续消费后续的消息。</p>
<p>block 0表示永远阻塞，直到消息到来，block 1000表示阻塞1s，如果1s内没有任何消息到来，就返回nil</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>127.0.0.1:6379&gt; xread block <span style=color:#0000cf;font-weight:700>1000</span> count <span style=color:#0000cf;font-weight:700>1</span> streams codehole $
<span style=color:#ce5c00;font-weight:700>(</span>nil<span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>(</span>1.07s<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=按组消费>按组消费</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504133052.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=相关命令>相关命令</h3>
<ul>
<li>XGROUP CREATE - 创建消费者组</li>
<li>XREADGROUP GROUP - 读取消费者组中的消息</li>
<li>XACK - 将消息标记为"已处理"</li>
<li>XGROUP SETID - 为消费者组设置新的最后递送消息ID</li>
<li>XGROUP DELCONSUMER - 删除消费者</li>
<li>XGROUP DESTROY - 删除消费者组</li>
<li>XPENDING - 显示待处理消息的相关信息</li>
<li>XCLAIM - 转移消息的归属权</li>
<li>XINFO - 查看流和消费者组的相关信息；</li>
<li>XINFO GROUPS - 打印消费者组的信息；</li>
<li>XINFO STREAM - 打印流信息</li>
</ul>
<p>Stream通过xgroup create指令创建消费组(Consumer Group)，需要传递起始消息ID参数用来初始化last_delivered_id变量。</p>
<p>Stream提供了xreadgroup指令可以进行消费组的组内消费，需要提供消费组名称、消费者名称和起始消息ID。它同xread一样，也可以阻塞等待新消息。读到新消息后，对应的消息ID就会进入消费者的PEL(正在处理的消息)结构里，客户端处理完毕后使用xack指令通知服务器，本条消息已经处理完毕，该消息ID就会从PEL中移除。</p>
<h3 id=信息监控>信息监控</h3>
<p>Stream提供了XINFO来实现对服务器信息的监控，可以查询：</p>
<ul>
<li>查看队列信息</li>
<li>消费组信息</li>
<li>消费者组成员信息</li>
</ul>
<h3 id=应用场景>应用场景</h3>
<p>可用作时通信等，大数据分析，异地数据备份等</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504135014.png style=display:block;width:50% alt=NAME align=center> </div>
<p>客户端可以平滑扩展，提高处理能力</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504135029.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=消息id的设计是否考虑了时间回拨的问题>消息ID的设计是否考虑了时间回拨的问题</h3>
<p>XADD生成的1553439850328-0，就是Redis生成的消息ID，由两部分组成:<strong>时间戳-序号</strong>。时间戳是毫秒级单位，是生成消息的Redis服务器时间，它是个64位整型（int64）。序号是在这个毫秒时间点内的消息序号，它也是个64位整型。</p>
<p>可以通过multi批处理，来验证序号的递增：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; XADD memberMessage * msg one
QUEUED
127.0.0.1:6379&gt; XADD memberMessage * msg two
QUEUED
127.0.0.1:6379&gt; XADD memberMessage * msg three
QUEUED
127.0.0.1:6379&gt; XADD memberMessage * msg four
QUEUED
127.0.0.1:6379&gt; XADD memberMessage * msg five
QUEUED
127.0.0.1:6379&gt; EXEC
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553441006884-0&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553441006884-1&#34;</span>
3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553441006884-2&#34;</span>
4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553441006884-3&#34;</span>
5<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553441006884-4&#34;</span>
</code></pre></div><p>由于一个redis命令的执行很快，所以可以看到在同一时间戳内，是通过序号递增来表示消息的。</p>
<p>为了保证消息是有序的，因此Redis生成的ID是单调递增有序的。由于ID中包含时间戳部分，为了避免服务器时间错误而带来的问题（例如服务器时间延后了），Redis的每个Stream类型数据都维护一个latest_generated_id属性，用于记录最后一个消息的ID。<strong>若发现当前时间戳退后（小于latest_generated_id所记录的），则采用时间戳不变而序号递增的方案来作为新消息ID</strong>（这也是序号为什么使用int64的原因，保证有足够多的的序号），从而保证ID的单调递增性质。</p>
<p>强烈建议使用Redis的方案生成消息ID，因为这种时间戳+序号的单调递增的ID方案，几乎可以满足你全部的需求。但同时，记住ID是支持自定义的，别忘了！</p>
<h3 id=消费者崩溃带来的会不会消息丢失问题>消费者崩溃带来的会不会消息丢失问题</h3>
<p>为了解决组内消息读取但处理期间消费者崩溃带来的消息丢失问题，STREAM 设计了 Pending 列表，用于记录读取但并未处理完毕的消息。命令XPENDIING 用来获消费组或消费内消费者的未处理完毕的消息。演示如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; XPENDING mq mqGroup <span style=color:#8f5902;font-style:italic># mpGroup的Pending情况</span>
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#8f5902;font-style:italic># 5个已读取但未处理的消息</span>
2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-0&#34;</span> <span style=color:#8f5902;font-style:italic># 起始ID</span>
3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-4&#34;</span> <span style=color:#8f5902;font-style:italic># 结束ID</span>
4<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerA&#34;</span> <span style=color:#8f5902;font-style:italic># 消费者A有3个</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;3&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerB&#34;</span> <span style=color:#8f5902;font-style:italic># 消费者B有1个</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerC&#34;</span> <span style=color:#8f5902;font-style:italic># 消费者C有1个</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>

127.0.0.1:6379&gt; XPENDING mq mqGroup - + <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#8f5902;font-style:italic># 使用 start end count 选项可以获取详细信息</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-0&#34;</span> <span style=color:#8f5902;font-style:italic># 消息ID</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerA&#34;</span> <span style=color:#8f5902;font-style:italic># 消费者</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1654355</span> <span style=color:#8f5902;font-style:italic># 从读取到现在经历了1654355ms，IDLE</span>
   4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#8f5902;font-style:italic># 消息被读取了5次，delivery counter</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-1&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerA&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1654355</span>
   4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>4</span>
<span style=color:#8f5902;font-style:italic># 共5个，余下3个省略 ...</span>

127.0.0.1:6379&gt; XPENDING mq mqGroup - + <span style=color:#0000cf;font-weight:700>10</span> consumerA <span style=color:#8f5902;font-style:italic># 在加上消费者参数，获取具体某个消费者的Pending列表</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-0&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerA&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1641083</span>
   4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#8f5902;font-style:italic># 共3个，余下2个省略 ...</span>
</code></pre></div><p>每个Pending的消息有4个属性：</p>
<ul>
<li>消息ID</li>
<li>所属消费者</li>
<li>IDLE，已读取时长</li>
<li>delivery counter，消息被读取次数</li>
</ul>
<p>上面的结果我们可以看到，我们之前读取的消息，都被记录在Pending列表中，说明全部读到的消息都没有处理，仅仅是读取了。那如何表示消费者处理完毕了消息呢？使用命令 XACK 完成告知消息处理完成，演示如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>127.0.0.1:6379&gt; XACK mq mqGroup 1553585533795-0 <span style=color:#8f5902;font-style:italic># 通知消息处理结束，用消息ID标识</span>
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>

127.0.0.1:6379&gt; XPENDING mq mqGroup <span style=color:#8f5902;font-style:italic># 再次查看Pending列表</span>
1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#8f5902;font-style:italic># 已读取但未处理的消息已经变为4个</span>
2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-1&#34;</span>
3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-4&#34;</span>
4<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerA&#34;</span> <span style=color:#8f5902;font-style:italic># 消费者A，还有2个消息处理</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;2&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerB&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerC&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>
127.0.0.1:6379&gt;
</code></pre></div><p>有了这样一个Pending机制，就意味着在某个消费者读取消息但未处理后，消息是不会丢失的。等待消费者再次上线后，可以读取该Pending列表，就可以继续处理该消息了，保证消息的有序和不丢失。</p>
<h3 id=消费者彻底宕机后如何转移给其它消费者处理>消费者彻底宕机后如何转移给其它消费者处理</h3>
<blockquote>
<p>还有一个问题，就是若某个消费者宕机之后，没有办法再上线了，那么就需要将该消费者Pending的消息，转移给其他的消费者处理，就是消息转移。</p>
</blockquote>
<p>消息转移的操作时将某个消息转移到自己的Pending列表中。使用语法XCLAIM来实现，需要设置组、转移的目标消费者和消息ID，同时需要提供IDLE（已被读取时长），只有超过这个时长，才能被转移。演示如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 当前属于消费者A的消息1553585533795-1，已经15907,787ms未处理了</span>
127.0.0.1:6379&gt; XPENDING mq mqGroup - + <span style=color:#0000cf;font-weight:700>10</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-1&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerA&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>15907787</span>
   4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>4</span>

<span style=color:#8f5902;font-style:italic># 转移超过3600s的消息1553585533795-1到消费者B的Pending列表</span>
127.0.0.1:6379&gt; XCLAIM mq mqGroup consumerB <span style=color:#0000cf;font-weight:700>3600000</span> 1553585533795-1
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-1&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;msg&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;2&#34;</span>

<span style=color:#8f5902;font-style:italic># 消息1553585533795-1已经转移到消费者B的Pending中。</span>
127.0.0.1:6379&gt; XPENDING mq mqGroup - + <span style=color:#0000cf;font-weight:700>10</span>
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-1&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;consumerB&#34;</span>
   3<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>84404</span> <span style=color:#8f5902;font-style:italic># 注意IDLE，被重置了</span>
   4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#8f5902;font-style:italic># 注意，读取次数也累加了1次</span>
</code></pre></div><p>以上代码，完成了一次消息转移。转移除了要指定ID外，还需要指定IDLE，保证是长时间未处理的才被转移。被转移的消息的IDLE会被重置，用以保证不会被重复转移，以为可能会出现将过期的消息同时转移给多个消费者的并发操作，设置了IDLE，则可以避免后面的转移不会成功，因为IDLE不满足条件。例如下面的连续两条转移，第二条不会成功。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>127.0.0.1:6379&gt; XCLAIM mq mqGroup consumerB <span style=color:#0000cf;font-weight:700>3600000</span> 1553585533795-1
127.0.0.1:6379&gt; XCLAIM mq mqGroup consumerC <span style=color:#0000cf;font-weight:700>3600000</span> 1553585533795-1
</code></pre></div><p>这就是消息转移。至此我们使用了一个Pending消息的ID，所属消费者和IDLE的属性，还有一个属性就是消息被读取次数，delivery counter，该属性的作用由于统计消息被读取的次数，包括被转移也算。这个属性主要用在判定是否为错误数据上。</p>
<h3 id=坏消息问题dead-letter死信问题>坏消息问题，Dead Letter，死信问题</h3>
<p>正如上面所说，如果某个消息，不能被消费者处理，也就是不能被XACK，这是要长时间处于Pending列表中，即使被反复的转移给各个消费者也是如此。此时该消息的delivery counter就会累加（上一节的例子可以看到），当累加到某个我们预设的临界值时，我们就认为是坏消息（也叫死信，DeadLetter，无法投递的消息），由于有了判定条件，我们将坏消息处理掉即可，删除即可。删除一个消息，使用XDEL语法，演示如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 删除队列中的消息</span>
127.0.0.1:6379&gt; XDEL mq 1553585533795-1
<span style=color:#ce5c00;font-weight:700>(</span>integer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#8f5902;font-style:italic># 查看队列中再无此消息</span>
127.0.0.1:6379&gt; XRANGE mq - +
1<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-0&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;msg&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1&#34;</span>
2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;1553585533795-2&#34;</span>
   2<span style=color:#ce5c00;font-weight:700>)</span> 1<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;msg&#34;</span>
      2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;3&#34;</span>
</code></pre></div><p>注意本例中，并没有删除Pending中的消息因此你查看Pending，消息还会在。可以执行XACK标识其处理完毕！</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f39b5b7bdbb59acf255fb62ce2763d03>5.4 - CH04-对象机制</h1>
<h2 id=结构概览>结构概览</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504135719.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图反映了Redis的每种对象其实都由<strong>对象结构(redisObject)</strong> 与 <strong>对应编码的数据结构</strong>组合而成，而每种对象类型对应若干编码方式，不同的编码方式所对应的底层数据结构是不同的。</p>
<p>所以，我们需要从几个个角度来着手底层研究：</p>
<ul>
<li><strong>对象设计机制</strong>: 对象结构(redisObject)</li>
<li><strong>编码类型和底层数据结构</strong>: 对应编码的数据结构</li>
</ul>
<h2 id=redisobject>RedisObject</h2>
<p>在redis的命令中，用于对键进行处理的命令占了很大一部分，而对于键所保存的值的类型，键能执行的命令又各不相同。如： <code>LPUSH</code> 和 <code>LLEN</code> 只能用于列表键, 而 <code>SADD</code> 和 <code>SRANDMEMBER</code> 只能用于集合键; 另外一些命令, 比如 <code>DEL</code>、 <code>TTL</code> 和 <code>TYPE</code>, 可以用于任何类型的键；但是要正确实现这些命令, 必须为不同类型的键设置不同的处理方式: 比如说, 删除一个列表键和删除一个字符串键的操作过程就不太一样。</p>
<p>以上的描述说明, <strong>Redis 必须让每个键都带有类型信息, 使得程序可以检查键的类型, 并为它选择合适的处理方式</strong>.</p>
<p>比如说， 集合类型就可以由字典和整数集合两种不同的数据结构实现， 但是， 当用户执行 ZADD 命令时，应该不必关心集合使用的是什么编码， 只要 Redis 能按照 ZADD 命令的指示， 将新元素添加到集合就可以了。</p>
<p>这说明, <strong>操作数据类型的命令除了要对键的类型进行检查之外, 还需要根据数据类型的不同编码进行多态处理</strong>.</p>
<p>为了解决以上问题, <strong>Redis 构建了自己的类型系统</strong>, 这个系统的主要功能包括:</p>
<ul>
<li>redisObject 对象.</li>
<li>基于 redisObject 对象的类型检查.</li>
<li>基于 redisObject 对象的显式多态函数.</li>
<li>对 redisObject 进行分配、共享和销毁的机制.</li>
</ul>
<h3 id=数据结构>数据结构</h3>
<p>redisObject 是 Redis 类型系统的核心, 数据库中的每个键、值, 以及 Redis 本身处理的参数, 都表示为这种数据类型。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic> * Redis 对象
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>redisObject</span> <span style=color:#000;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#f57900>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 编码方式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#f57900>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// LRU - 24位, 记录最末一次访问时间（相对于lru_clock）; 或者 LFU（最少使用的数据：8位频率，16位访问时间）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#f57900>lru</span><span style=color:#000;font-weight:700>:</span><span style=color:#000>LRU_BITS</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// LRU_BITS: 24
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 引用计数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>refcount</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 指向底层数据结构实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ptr</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000;font-weight:700>}</span> <span style=color:#000>robj</span><span style=color:#000;font-weight:700>;</span>
</code></pre></div><p>下图对应上面的结构：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504140122.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>其中type、encoding和ptr是最重要的三个属性</strong>。</p>
<ul>
<li><strong>type记录了对象所保存的值的类型</strong>，它的值可能是以下常量中的一个：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>* 对象类型
</span><span style=color:#8f5902;font-style:italic>*/</span>
<span style=color:#8f5902;font-style:italic>#define OBJ_STRING 0 </span><span style=color:#8f5902;font-style:italic>// 字符串
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#define OBJ_LIST 1 </span><span style=color:#8f5902;font-style:italic>// 列表
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#define OBJ_SET 2 </span><span style=color:#8f5902;font-style:italic>// 集合
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#define OBJ_ZSET 3 </span><span style=color:#8f5902;font-style:italic>// 有序集
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#define OBJ_HASH 4 </span><span style=color:#8f5902;font-style:italic>// 哈希表
</span></code></pre></div><ul>
<li><strong>encoding记录了对象所保存的值的编码</strong>，它的值可能是以下常量中的一个：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>* 对象编码
</span><span style=color:#8f5902;font-style:italic>*/</span>
<span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_RAW 0     </span><span style=color:#8f5902;font-style:italic>/* Raw representation */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_INT 1     </span><span style=color:#8f5902;font-style:italic>/* Encoded as integer */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_HT 2      </span><span style=color:#8f5902;font-style:italic>/* Encoded as hash table */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_ZIPMAP 3  </span><span style=color:#8f5902;font-style:italic>/* 注意：版本2.6后不再使用. */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_LINKEDLIST 4 </span><span style=color:#8f5902;font-style:italic>/* 注意：不再使用了，旧版本2.x中String的底层之一. */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_ZIPLIST 5 </span><span style=color:#8f5902;font-style:italic>/* Encoded as ziplist */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_INTSET 6  </span><span style=color:#8f5902;font-style:italic>/* Encoded as intset */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_SKIPLIST 7  </span><span style=color:#8f5902;font-style:italic>/* Encoded as skiplist */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_EMBSTR 8  </span><span style=color:#8f5902;font-style:italic>/* Embedded sds string encoding */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_QUICKLIST 9 </span><span style=color:#8f5902;font-style:italic>/* Encoded as linked list of ziplists */</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#define OBJ_ENCODING_STREAM 10 </span><span style=color:#8f5902;font-style:italic>/* Encoded as a radix tree of listpacks */</span><span style=color:#8f5902;font-style:italic>
</span></code></pre></div><ul>
<li>
<p><strong>ptr是一个指针，指向实际保存值的数据结构</strong>，这个数据结构由type和encoding属性决定。举个例子， 如果一个redisObject 的type 属性为<code>OBJ_LIST</code> ， encoding 属性为<code>OBJ_ENCODING_QUICKLIST</code> ，那么这个对象就是一个Redis 列表（List)，它的值保存在一个QuickList的数据结构内，而ptr 指针就指向quicklist的对象；</p>
</li>
<li>
<p><strong>lru属性: 记录了对象最后一次被命令程序访问的时间</strong></p>
</li>
</ul>
<p><strong>空转时长</strong>：当前时间减去键的值对象的lru时间，就是该键的空转时长。Object idletime命令可以打印出给定键的空转时长</p>
<p>如果服务器打开了maxmemory选项，并且服务器用于回收内存的算法为volatile-lru或者allkeys-lru，那么当服务器占用的内存数超过了maxmemory选项所设置的上限值时，空转时长较高的那部分键会优先被服务器释放，从而回收内存。</p>
<h2 id=命令的类型检查与多态>命令的类型检查与多态</h2>
<p><strong>当执行一个处理数据类型命令的时候，redis执行以下步骤</strong></p>
<ul>
<li>根据给定的key，在数据库字典中查找和他相对应的redisObject，如果没找到，就返回NULL；</li>
<li>检查redisObject的type属性和执行命令所需的类型是否相符，如果不相符，返回类型错误；</li>
<li>根据redisObject的encoding属性所指定的编码，选择合适的操作函数来处理底层的数据结构；</li>
<li>返回数据结构的操作结果作为命令的返回值。</li>
</ul>
<p>比如现在执行LPOP命令：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504140457.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=对象共享>对象共享</h2>
<blockquote>
<p>redis一般会把一些常见的值放到一个共享对象中，这样可使程序避免了重复分配的麻烦，也节约了一些CPU时间。</p>
</blockquote>
<p><strong>redis预分配的值对象如下</strong>：</p>
<ul>
<li>各种命令的返回值，比如成功时返回的OK，错误时返回的ERROR，命令入队事务时返回的QUEUE，等等</li>
<li>包括0 在内，小于REDIS_SHARED_INTEGERS的所有整数（REDIS_SHARED_INTEGERS的默认值是10000）</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504140534.png style=display:block;width:50% alt=NAME align=center> </div>
<blockquote>
<p>注意：共享对象只能被字典和双向链表这类能带有指针的数据结构使用。像整数集合和压缩列表这些只能保存字符串、整数等字面值的内存数据结构。</p>
</blockquote>
<p><strong>为什么redis不共享列表对象、哈希对象、集合对象、有序集合对象，只共享字符串对象</strong>？</p>
<ul>
<li>列表对象、哈希对象、集合对象、有序集合对象，本身可以包含字符串对象，复杂度较高。</li>
<li>如果共享对象是保存字符串对象，那么验证操作的复杂度为O(1)</li>
<li>如果共享对象是保存字符串值的字符串对象，那么验证操作的复杂度为O(N)</li>
<li>如果共享对象是包含多个值的对象，其中值本身又是字符串对象，即其它对象中嵌套了字符串对象，比如列表对象、哈希对象，那么验证操作的复杂度将会是O(N的平方)</li>
</ul>
<p>如果对复杂度较高的对象创建共享对象，需要消耗很大的CPU，用这种消耗去换取内存空间，是不合适的。</p>
<h2 id=引用计数以及对象的消毁>引用计数以及对象的消毁</h2>
<blockquote>
<p>redisObject中有refcount属性，是对象的引用计数，显然计数0那么就是可以回收。</p>
</blockquote>
<ul>
<li>每个redisObject结构都带有一个refcount属性，指示这个对象被引用了多少次；</li>
<li>当新创建一个对象时，它的refcount属性被设置为1；</li>
<li>当对一个对象进行共享时，redis将这个对象的refcount加一；</li>
<li>当使用完一个对象后，或者消除对一个对象的引用之后，程序将对象的refcount减一；</li>
<li>当对象的refcount降至0 时，这个RedisObject结构，以及它引用的数据结构的内存都会被释放。</li>
</ul>
<h2 id=总结>总结</h2>
<ul>
<li>
<p>redis使用自己实现的对象机制（redisObject)来实现类型判断、命令多态和基于引用次数的垃圾回收；</p>
</li>
<li>
<p>redis会预分配一些常用的数据对象，并通过共享这些对象来减少内存占用，和避免频繁的为小对象分配内存。</p>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d6ad1d4083c795b0ad006b6fb71ea3c7>5.5 - CH05-底层结构</h1>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504140959.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=简单动态字符串sds>简单动态字符串：SDS</h2>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<blockquote>
<p>Redis 是用 C 语言写的，但是对于Redis的字符串，却不是 C 语言中的字符串（即以空字符’\0’结尾的字符数组），它是自己构建了一种名为 <strong>简单动态字符串（simple dynamic string,SDS</strong>）的抽象类型，并将 SDS 作为 Redis的默认字符串表示。</p>
</blockquote>
<h3 id=定义>定义</h3>
<blockquote>
<p>这是一种用于存储二进制数据的一种结构, 具有动态扩容的特点. 其实现位于src/sds.h与src/sds.c中。</p>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504141111.png style=display:block;width:50% alt=NAME align=center> </div>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p>其中<code>sdshdr</code>是头部, <code>buf</code>是真实存储用户数据的地方. 另外注意, 从命名上能看出来, 这个数据结构除了能存储二进制数据, 显然是用于设计作为字符串使用的, 所以在buf中, 用户数据后总跟着一个\0. 即图中 <code>"数据" + "\0"</code>是为所谓的buf。</p>
<p>SDS有五种不同的头部. 其中sdshdr5实际并未使用到. 所以实际上有四种不同的头部, 分别如下:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504145202.png style=display:block;width:50% alt=NAME align=center> </div>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p>其中：</p>
<ul>
<li><code>len</code> 保存了SDS保存字符串的长度</li>
<li><code>buf[]</code> 数组用来保存字符串的每个元素</li>
<li><code>alloc</code>分别以uint8, uint16, uint32, uint64表示整个SDS, 除过头部与末尾的\0, 剩余的字节数.</li>
<li><code>flags</code> 始终为一字节, 以低三位标示着头部的类型, 高5位未使用.</li>
</ul>
<h3 id=为什么使用sds>为什么使用SDS</h3>
<blockquote>
<p><strong>为什么不使用C语言字符串实现，而是使用 SDS呢</strong>？这样实现有什么好处？</p>
</blockquote>
<ul>
<li>
<p><strong>常数复杂度获取字符串长度</strong></p>
<p>由于 len 属性的存在，我们获取 SDS 字符串的长度只需要读取 len 属性，时间复杂度为 O(1)。而对于 C 语言，获取字符串的长度通常是经过遍历计数来实现的，时间复杂度为 O(n)。通过 <code>strlen key</code> 命令可以获取 key 的字符串长度。</p>
</li>
<li>
<p><strong>杜绝缓冲区溢出</strong></p>
<p>我们知道在 C 语言中使用 <code>strcat</code> 函数来进行两个字符串的拼接，一旦没有分配足够长度的内存空间，就会造成缓冲区溢出。而对于 SDS 数据类型，在进行字符修改的时候，<strong>会首先根据记录的 len 属性检查内存空间是否满足需求</strong>，如果不满足，会进行相应的空间扩展，然后在进行修改操作，所以不会出现缓冲区溢出。</p>
</li>
<li>
<p><strong>减少修改字符串的内存重新分配次数</strong></p>
<p>C语言由于不记录字符串的长度，所以如果要修改字符串，必须要重新分配内存（先释放再申请），因为如果没有重新分配，字符串长度增大时会造成内存缓冲区溢出，字符串长度减小时会造成内存泄露。</p>
<p>而对于SDS，由于<code>len</code>属性和<code>alloc</code>属性的存在，对于修改字符串SDS实现了<strong>空间预分配</strong>和<strong>惰性空间释放</strong>两种策略：</p>
<ul>
<li>
<p><code>空间预分配</code>：对字符串进行空间扩展的时候，扩展的内存比实际需要的多，这样可以减少连续执行字符串增长操作所需的内存重分配次数。</p>
</li>
<li>
<p><code>惰性空间释放</code>：对字符串进行缩短操作时，程序不立即使用内存重新分配来回收缩短后多余的字节，而是使用 <code>alloc</code> 属性将这些字节的数量记录下来，等待后续使用。（当然SDS也提供了相应的API，当我们有需要时，也可以手动释放这些未使用的空间。）</p>
</li>
</ul>
</li>
<li>
<p><strong>二进制安全</strong></p>
<p>因为C字符串以空字符作为字符串结束的标识，而对于一些二进制文件（如图片等），内容可能包括空字符串，因此C字符串无法正确存取；而所有 SDS 的API 都是以处理二进制的方式来处理 <code>buf</code> 里面的元素，并且 SDS 不是以空字符串来判断是否结束，而是以 len 属性表示的长度来判断字符串是否结束。</p>
</li>
<li>
<p><strong>兼容部分 C 字符串函数</strong></p>
<p>虽然 SDS 是二进制安全的，但是一样遵从每个字符串都是以空字符串结尾的惯例，这样可以重用 C 语言库<code>&lt;string.h></code> 中的一部分函数。</p>
</li>
</ul>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<h3 id=空间预分配补进一步理解>空间预分配补进一步理解</h3>
<p>当执行追加操作时，比如现在给<code>key=‘Hello World’</code>的字符串后追加<code>‘ again!’</code>则这时的len=18，free由0变成了18，此时的<code>buf='Hello World again!\0....................'</code>(.表示空格)，也就是buf的内存空间是18+18+1=37个字节，其中‘\0’占1个字节redis给字符串多分配了18个字节的预分配空间，所以下次还有append追加的时候，如果预分配空间足够，就无须在进行空间分配了。在当前版本中，当新字符串的长度小于1M时，redis会分配他们所需大小一倍的空间，当大于1M的时候，就为他们额外多分配1M的空间。</p>
<p>思考：<strong>这种分配策略会浪费内存资源吗</strong>？</p>
<p>答：执行过APPEND 命令的字符串会带有额外的预分配空间，这些预分配空间不会被释放，除非该字符串所对应的键被删除，或者等到关闭Redis 之后，再次启动时重新载入的字符串对象将不会有预分配空间。因为执行APPEND 命令的字符串键数量通常并不多，占用内存的体积通常也不大，所以这一般并不算什么问题。另一方面，如果执行APPEND 操作的键很多，而字符串的体积又很大的话，那可能就需要修改Redis 服务器，让它定时释放一些字符串键的预分配空间，从而更有效地使用内存。</p>
<h3 id=小结>小结</h3>
<p>redis的字符串表示为sds，而不是C字符串（以\0结尾的char*）， 它是Redis 底层所使用的字符串表示，它被用在几乎所有的Redis 模块中。可以看如下对比：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504145607.png style=display:block;width:50% alt=NAME align=center> </div>
<p>一般来说，SDS 除了保存数据库中的字符串值以外，SDS 还可以作为缓冲区（buffer）：包括 AOF 模块中的AOF缓冲区以及客户端状态中的输入缓冲区</p>
<h2 id=压缩列表ziplist>压缩列表：ZipList</h2>
<blockquote>
<p>ziplist是为了提高存储效率而设计的一种特殊编码的双向链表。它可以存储字符串或者整数，存储整数时是采用整数的二进制而不是字符串形式存储。他能在O(1)的时间复杂度下完成list两端的push和pop操作。但是因为每次操作都需要重新分配ziplist的内存，所以实际复杂度和ziplist的内存使用量相关。</p>
</blockquote>
<h3 id=ziplist-结构>ZipList 结构</h3>
<p>整个ziplist在内存中的存储格式如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504145727.png style=display:block;width:50% alt=NAME align=center> </div>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<ul>
<li>
<p><code>zlbytes</code>字段的类型是uint32_t, 这个字段中存储的是整个ziplist所占用的内存的字节数</p>
</li>
<li>
<p><code>zltail</code>字段的类型是uint32_t, 它指的是ziplist中最后一个entry的偏移量. 用于快速定位最后一个entry, 以快速完成pop等操作</p>
</li>
<li>
<p><code>zllen</code>字段的类型是uint16_t, 它指的是整个ziplit中entry的数量. 这个值只占2bytes（16位）: 如果ziplist中entry的数目小于65535(2的16次方), 那么该字段中存储的就是实际entry的值. 若等于或超过65535, 那么该字段的值固定为65535, 但实际数量需要一个个entry的去遍历所有entry才能得到.</p>
</li>
<li>
<p><code>zlend</code>是一个终止字节, 其值为全F, 即0xff. ziplist保证任何情况下, 一个entry的首字节都不会是255</p>
</li>
</ul>
<h3 id=entry-结构>Entry 结构</h3>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p><strong>第一种情况</strong>：一般结构 <code>&lt;prevlen> &lt;encoding> &lt;entry-data></code></p>
<p><code>prevlen</code>：前一个entry的大小，编码方式见下文；</p>
<p><code>encoding</code>：不同的情况下值不同，用于表示当前entry的类型和长度；</p>
<p><code>entry-data</code>：真是用于存储entry表示的数据；</p>
<p><strong>第二种情况</strong>：在entry中存储的是int类型时，encoding和entry-data会合并在encoding中表示，此时没有entry-data字段；</p>
<p>redis中，在存储数据时，会先尝试将string转换成int存储，节省空间；</p>
<p>此时entry结构：<code>&lt;prevlen> &lt;encoding></code></p>
<ul>
<li><strong>prevlen编码</strong></li>
</ul>
<p>当前一个元素长度小于254（255用于zlend）的时候，prevlen长度为1个字节，值即为前一个entry的长度，如果长度大于等于254的时候，prevlen用5个字节表示，第一字节设置为254，后面4个字节存储一个小端的无符号整型，表示前一个entry的长度；</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&lt;prevlen from <span style=color:#0000cf;font-weight:700>0</span> to 253&gt; &lt;encoding&gt; &lt;entry&gt;      //长度小于254结构
0xFE &lt;<span style=color:#0000cf;font-weight:700>4</span> bytes unsigned little endian prevlen&gt; &lt;encoding&gt; &lt;entry&gt;   //长度大于等于254
</code></pre></div><ul>
<li><strong>encoding编码</strong></li>
</ul>
<p>encoding的长度和值根据保存的是int还是string，还有数据的长度而定；</p>
<p>前两位用来表示类型，当为“11”时，表示entry存储的是int类型，其他表示存储的是string；</p>
<p><strong>存储string时</strong>：</p>
<p><code>|00pppppp|</code> ：此时encoding长度为1个字节，该字节的后六位表示entry中存储的string长度，因为是6位，所以entry中存储的string长度不能超过63；</p>
<p><code>|01pppppp|qqqqqqqq|</code> 此时encoding长度为两个字节；此时encoding的后14位用来存储string长度，长度不能超过16383；</p>
<p><code>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|ttttttt|</code> 此时encoding长度为5个字节，后面的4个字节用来表示encoding中存储的字符串长度，长度不能超过2^32 - 1;</p>
<p><strong>存储int时</strong>：</p>
<p><code>|11000000|</code> encoding为3个字节，后2个字节表示一个int16；</p>
<p><code>|11010000|</code> encoding为5个字节，后4个字节表示一个int32;</p>
<p><code>|11100000|</code> encoding 为9个字节，后8字节表示一个int64;</p>
<p><code>|11110000|</code> encoding为4个字节，后3个字节表示一个有符号整型；</p>
<p><code>|11111110|</code> encoding为2字节，后1个字节表示一个有符号整型；</p>
<p><code>|1111xxxx|</code> encoding长度就只有1个字节，xxxx表示一个0 - 12的整数值；</p>
<p><code>|11111111|</code> 还记得zlend么？</p>
<ul>
<li><strong>源码中数据结构支撑</strong></li>
</ul>
<p>你可以看到为了操作上的简易实际还增加了几个属性</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/* We use this function to receive information about a ziplist entry.
</span><span style=color:#8f5902;font-style:italic> * Note that this is not how the data is actually encoded, is just what we
</span><span style=color:#8f5902;font-style:italic> * get filled by a function in order to operate more easily. */</span>
<span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>zlentry</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>prevrawlensize</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>/* Bytes used to encode the previous entry len*/</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>prevrawlen</span><span style=color:#000;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>/* Previous entry len. */</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lensize</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>/* Bytes used to encode this entry type/len.
</span><span style=color:#8f5902;font-style:italic>                                    For example strings have a 1, 2 or 5 bytes
</span><span style=color:#8f5902;font-style:italic>                                    header. Integers always use a single byte.*/</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#000;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>/* Bytes used to represent the actual entry.
</span><span style=color:#8f5902;font-style:italic>                                    For strings this is just the string length
</span><span style=color:#8f5902;font-style:italic>                                    while for integers it is 1, 2, 3, 4, 8 or
</span><span style=color:#8f5902;font-style:italic>                                    0 (for 4 bit immediate) depending on the
</span><span style=color:#8f5902;font-style:italic>                                    number range. */</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>headersize</span><span style=color:#000;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>/* prevrawlensize + lensize. */</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>encoding</span><span style=color:#000;font-weight:700>;</span>      <span style=color:#8f5902;font-style:italic>/* Set to ZIP_STR_* or ZIP_INT_* depending on
</span><span style=color:#8f5902;font-style:italic>                                    the entry encoding. However for 4 bits
</span><span style=color:#8f5902;font-style:italic>                                    immediate integers this can assume a range
</span><span style=color:#8f5902;font-style:italic>                                    of values and must be range-checked. */</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>p</span><span style=color:#000;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>/* Pointer to the very start of the entry, that
</span><span style=color:#8f5902;font-style:italic>                                    is, this points to prev-entry-len field. */</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#000>zlentry</span><span style=color:#000;font-weight:700>;</span>
</code></pre></div><ul>
<li><code>prevrawlensize</code>表示 previous_entry_length字段的长度</li>
<li><code>prevrawlen</code>表示 previous_entry_length字段存储的内容</li>
<li><code>lensize</code>表示 encoding字段的长度</li>
<li><code>len</code>表示数据内容长度</li>
<li><code>headersize</code> 表示当前元素的首部长度，即previous_entry_length字段长度与encoding字段长度之和</li>
<li><code>encoding</code>表示数据类型</li>
<li><code>p</code>表示当前元素首地址</li>
</ul>
<h3 id=为什么ziplist特别省内存>为什么ZipList特别省内存</h3>
<ul>
<li>ziplist节省内存是相对于普通的list来说的，如果是普通的数组，那么它每个元素占用的内存是一样的且取决于最大的那个元素（很明显它是需要预留空间的）；</li>
<li>所以ziplist在设计时就很容易想到要尽量让每个元素按照实际的内容大小存储，<strong>所以增加encoding字段</strong>，针对不同的encoding来细化存储大小；</li>
<li>这时候还需要解决的一个问题是遍历元素时如何定位下一个元素呢？在普通数组中每个元素定长，所以不需要考虑这个问题；但是ziplist中每个data占据的内存不一样，所以为了解决遍历，需要增加记录上一个元素的length，<strong>所以增加了prelen字段</strong>。</li>
</ul>
<p><strong>为什么我们去研究ziplist特别节省内存的数据结构</strong>？ 在实际应用中，大量存储字符串的优化是需要你对底层的数据结构有一定的理解的，而ziplist在场景优化的时候也被考虑采用的首选。</p>
<h3 id=缺点>缺点</h3>
<ul>
<li>ziplist也不预留内存空间, 并且在移除结点后, 也是立即缩容, 这代表每次写操作都会进行内存分配操作.</li>
<li>结点如果扩容, 导致结点占用的内存增长, 并且超过254字节的话, 可能会导致链式反应: 其后一个结点的entry.prevlen需要从一字节扩容至五字节.
<ul>
<li><strong>最坏情况下, 第一个结点的扩容, 会导致整个ziplist表中的后续所有结点的entry.prevlen字段扩容</strong>.</li>
<li>虽然这个内存重分配的操作依然只会发生一次, 但代码中的时间复杂度是o(N)级别, 因为链式扩容只能一步一步的计算.</li>
<li>但这种情况的概率十分的小, 一般情况下链式扩容能连锁反映五六次就很不幸了.</li>
<li>这样的坏场景下, 其实时间复杂度并不高: 依次计算每个entry新的空间占用, 也就是o(N), 总体占用计算出来后, 只执行一次内存重分配, 与对应的memmove操作, 就可以了.</li>
</ul>
</li>
</ul>
<h2 id=快表quicklist>快表：QuickList</h2>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<blockquote>
<p>quicklist这个结构是Redis在3.2版本后新加的, 之前的版本是list(即linkedlist)， 用于String数据类型中。</p>
</blockquote>
<p>它是一种以ziplist为结点的双端链表结构. 宏观上, quicklist是一个链表, 微观上, 链表中的每个结点都是一个ziplist。</p>
<h3 id=quicklist-结构>QuickList 结构</h3>
<p>内部定义了6个结构体:</p>
<ul>
<li><code>quicklistNode</code>, 宏观上, quicklist是一个链表, 这个结构描述的就是链表中的结点. 它通过zl字段持有底层的ziplist. 简单来讲, 它描述了一个ziplist实例</li>
<li><code>quicklistLZF</code>, ziplist是一段连续的内存, 用LZ4算法压缩后, 就可以包装成一个quicklistLZF结构. 是否压缩quicklist中的每个ziplist实例是一个可配置项. 若这个配置项是开启的, 那么quicklistNode.zl字段指向的就不是一个ziplist实例, 而是一个压缩后的quicklistLZF实例</li>
<li><code>quicklistBookmark</code>, 在quicklist尾部增加的一个书签，它只有在大量节点的多余内存使用量可以忽略不计的情况且确实需要分批迭代它们，才会被使用。当不使用它们时，它们不会增加任何内存开销。</li>
<li><code>quicklist</code>. 这就是一个双链表的定义. head, tail分别指向头尾指针. len代表链表中的结点. count指的是整个quicklist中的所有ziplist中的entry的数目. fill字段影响着每个链表结点中ziplist的最大占用空间, compress影响着是否要对每个ziplist以LZ4算法进行进一步压缩以更节省内存空间.</li>
<li><code>quicklistIter</code>是一个迭代器</li>
<li><code>quicklistEntry</code>是对ziplist中的entry概念的封装. quicklist作为一个封装良好的数据结构, 不希望使用者感知到其内部的实现, 所以需要把ziplist.entry的概念重新包装一下.</li>
</ul>
<h3 id=内存布局图>内存布局图</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504150301.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=更多信息>更多信息</h3>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p>下面是有关quicklist的更多额外信息:</p>
<ul>
<li>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>quicklist.fill
</code></pre></div><p>的值影响着每个链表结点中, ziplist的长度.</p>
<ol>
<li>当数值为负数时, 代表以字节数限制单个ziplist的最大长度. 具体为:</li>
<li>-1 不超过4kb</li>
<li>-2 不超过 8kb</li>
<li>-3 不超过 16kb</li>
<li>-4 不超过 32kb</li>
<li>-5 不超过 64kb</li>
<li>当数值为正数时, 代表以entry数目限制单个ziplist的长度. 值即为数目. 由于该字段仅占16位, 所以以entry数目限制ziplist的容量时, 最大值为2^15个</li>
</ol>
</li>
<li>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>quicklist.compress
</code></pre></div><p>的值影响着quicklistNode.zl字段指向的是原生的ziplist, 还是经过压缩包装后的quicklistLZF</p>
<ol>
<li>0 表示不压缩, zl字段直接指向ziplist</li>
<li>1 表示quicklist的链表头尾结点不压缩, 其余结点的zl字段指向的是经过压缩后的quicklistLZF</li>
<li>2 表示quicklist的链表头两个, 与末两个结点不压缩, 其余结点的zl字段指向的是经过压缩后的quicklistLZF</li>
<li>以此类推, 最大值为2^16</li>
</ol>
</li>
<li>
<p><code>quicklistNode.encoding</code>字段, 以指示本链表结点所持有的ziplist是否经过了压缩. 1代表未压缩, 持有的是原生的ziplist, 2代表压缩过</p>
</li>
<li>
<p><code>quicklistNode.container</code>字段指示的是每个链表结点所持有的数据类型是什么. 默认的实现是ziplist, 对应的该字段的值是2, 目前Redis没有提供其它实现. 所以实际上, 该字段的值恒为2</p>
</li>
<li>
<p><code>quicklistNode.recompress</code>字段指示的是当前结点所持有的ziplist是否经过了解压. 如果该字段为1即代表之前被解压过, 且需要在下一次操作时重新压缩.</p>
</li>
</ul>
<p>quicklist的具体实现代码篇幅很长, 这里就不贴代码片断了, 从内存布局上也能看出来, 由于每个结点持有的ziplist是有上限长度的, 所以在与操作时要考虑的分支情况比较多。</p>
<p>quicklist有自己的优点, 也有缺点, 对于使用者来说, 其使用体验类似于线性数据结构, list作为最传统的双链表, 结点通过指针持有数据, 指针字段会耗费大量内存. ziplist解决了耗费内存这个问题. 但引入了新的问题: 每次写操作整个ziplist的内存都需要重分配. quicklist在两者之间做了一个平衡. 并且使用者可以通过自定义<code>quicklist.fill</code>, 根据实际业务情况, 经验主义调参.</p>
<h2 id=字典dict>字典：Dict</h2>
<h3 id=数据结构>数据结构</h3>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p><strong>哈希表结构定义</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>dictht</span><span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//哈希表数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>dictEntry</span> <span style=color:#ce5c00;font-weight:700>**</span><span style=color:#000>table</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//哈希表大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//哈希表大小掩码，用于计算索引值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//总是等于 size-1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>sizemask</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//该哈希表已有节点的数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>used</span><span style=color:#000;font-weight:700>;</span>
 
<span style=color:#000;font-weight:700>}</span><span style=color:#000>dictht</span>
</code></pre></div><p>哈希表是由数组 table 组成，table 中每个元素都是指向 dict.h/dictEntry 结构，dictEntry 结构定义如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>dictEntry</span><span style=color:#000;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>//键
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>key</span><span style=color:#000;font-weight:700>;</span>
     <span style=color:#8f5902;font-style:italic>//值
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>union</span><span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>val</span><span style=color:#000;font-weight:700>;</span>
          <span style=color:#000>uint64_tu64</span><span style=color:#000;font-weight:700>;</span>
          <span style=color:#000>int64_ts64</span><span style=color:#000;font-weight:700>;</span>
     <span style=color:#000;font-weight:700>}</span><span style=color:#000>v</span><span style=color:#000;font-weight:700>;</span>
 
     <span style=color:#8f5902;font-style:italic>//指向下一个哈希表节点，形成链表
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>dictEntry</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>next</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span><span style=color:#000>dictEntry</span>
</code></pre></div><p>key 用来保存键，val 属性用来保存值，值可以是一个指针，也可以是uint64_t整数，也可以是int64_t整数。</p>
<p>注意这里还有一个指向下一个哈希表节点的指针，我们知道哈希表最大的问题是存在哈希冲突，如何解决哈希冲突，有开放地址法和链地址法。这里采用的便是链地址法，通过next这个指针可以将多个哈希值相同的键值对连接在一起，用来<strong>解决哈希冲突</strong>。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504150508.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=要点理解>要点理解</h3>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<ul>
<li><strong>哈希算法</strong>：Redis计算哈希值和索引值方法如下：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic>#1、使用字典设置的哈希函数，计算键 key 的哈希值</span>
<span style=color:#204a87>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> dict-&gt;type-&gt;hashFunction<span style=color:#ce5c00;font-weight:700>(</span>key<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>#2、使用哈希表的sizemask属性和第一步得到的哈希值，计算索引值</span>
<span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>hash</span> <span style=color:#000;font-weight:700>&amp;</span> dict-&gt;ht<span style=color:#ce5c00;font-weight:700>[</span>x<span style=color:#ce5c00;font-weight:700>]</span>.sizemask<span style=color:#000;font-weight:700>;</span>
</code></pre></div><ul>
<li>
<p><strong>解决哈希冲突</strong>：这个问题上面我们介绍了，方法是链地址法。通过字典里面的 *next 指针指向下一个具有相同索引值的哈希表节点。</p>
</li>
<li>
<p><strong>扩容和收缩</strong>：当哈希表保存的键值对太多或者太少时，就要通过 rerehash(重新散列）来对哈希表进行相应的扩展或者收缩。具体步骤：</p>
<ul>
<li>
<p>1、如果执行扩展操作，会基于原哈希表创建一个大小等于 <code>ht[0].used*2n</code> 的哈希表（也就是每次扩展都是根据原哈希表已使用的空间扩大一倍创建另一个哈希表）。相反如果执行的是收缩操作，每次收缩是根据已使用空间缩小一倍创建一个新的哈希表。</p>
</li>
<li>
<p>2、重新利用上面的哈希算法，计算索引值，然后将键值对放到新的哈希表位置上。</p>
</li>
<li>
<p>3、所有键值对都迁徙完毕后，释放原哈希表的内存空间。</p>
</li>
</ul>
</li>
<li>
<p><strong>触发扩容的条件</strong>：</p>
<ul>
<li>
<p>1、服务器目前没有执行 BGSAVE 命令或者 BGREWRITEAOF 命令，并且负载因子大于等于1。</p>
</li>
<li>
<p>2、服务器目前正在执行 BGSAVE 命令或者 BGREWRITEAOF 命令，并且负载因子大于等于5。</p>
</li>
<li>
<p>ps：负载因子 = 哈希表已保存节点数量 / 哈希表大小。</p>
</li>
</ul>
</li>
<li>
<p><strong>渐近式 rehash</strong></p>
<ul>
<li>什么叫渐进式 rehash？也就是说扩容和收缩操作不是一次性、集中式完成的，而是分多次、渐进式完成的。如果保存在Redis中的键值对只有几个几十个，那么 rehash 操作可以瞬间完成，但是如果键值对有几百万，几千万甚至几亿，那么要一次性的进行 rehash，势必会造成Redis一段时间内不能进行别的操作。所以Redis采用渐进式 rehash,这样在进行渐进式rehash期间，字典的删除查找更新等操作可能会在两个哈希表上进行，第一个哈希表没有找到，就会去第二个哈希表上进行查找。但是进行 增加操作，一定是在新的哈希表上进行的。</li>
</ul>
</li>
</ul>
<h2 id=整数集intset>整数集：IntSet</h2>
<blockquote>
<p>整数集合（intset）是集合类型的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis 就会使用整数集合作为集合键的底层实现。</p>
</blockquote>
<h3 id=结构>结构</h3>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p>首先看源码结构</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>intset</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>uint32_t</span> <span style=color:#000>encoding</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>uint32_t</span> <span style=color:#000>length</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int8_t</span> <span style=color:#000>contents</span><span style=color:#000;font-weight:700>[];</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#000>intset</span><span style=color:#000;font-weight:700>;</span>
</code></pre></div><ul>
<li>
<p><code>encoding</code> 表示编码方式，的取值有三个：INTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64</p>
</li>
<li>
<p><code>length</code> 代表其中存储的整数的个数</p>
</li>
<li>
<p><code>contents</code> 指向实际存储数值的连续内存区域, 就是一个数组；整数集合的每个元素都是 contents 数组的一个数组项（item），各个项在数组中按值得大小<strong>从小到大有序排序</strong>，且数组中不包含任何重复项。（虽然 intset 结构将 contents 属性声明为 int8_t 类型的数组，但实际上 contents 数组并不保存任何 int8_t 类型的值，contents 数组的真正类型取决于 encoding 属性的值）</p>
</li>
</ul>
<h3 id=内存布局>内存布局</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504150750.png style=display:block;width:50% alt=NAME align=center> </div>
<p>content数组里面每个元素的数据类型是由encoding来决定的，那么如果原来的数据类型是int16, 当我们再插入一个int32类型的数据时怎么办呢？这就是下面要说的intset的升级。</p>
<h3 id=升级>升级</h3>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p>当在一个int16类型的整数集合中插入一个int32类型的值，整个集合的所有元素都会转换成32类型。 整个过程有三步：</p>
<ul>
<li>根据新元素的类型（比如int32），扩展整数集合底层数组的空间大小，并为新元素分配空间。</li>
<li>将底层数组现有的所有元素都转换成与新元素相同的类型， 并将类型转换后的元素放置到正确的位上， 而且在放置元素的过程中， 需要继续维持底层数组的有序性质不变。</li>
<li>最后改变encoding的值，length+1。</li>
</ul>
<p><strong>那么如果我们删除掉刚加入的int32类型时，会不会做一个降级操作呢</strong>？</p>
<p>不会。主要还是减少开销的权衡。</p>
<h2 id=跳表zskiplist>跳表：ZSkipList</h2>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<blockquote>
<p>跳跃表结构在 Redis 中的运用场景只有一个，那就是作为有序列表 (Zset) 的使用。跳跃表的性能可以保证在查找，删除，添加等操作的时候在对数期望时间内完成，这个性能是可以和平衡树来相比较的，而且在实现方面比平衡树要优雅，这就是跳跃表的长处。</p>
<p>跳跃表的缺点就是需要的存储空间比较大，属于利用空间来换取时间的数据结构。</p>
</blockquote>
<h3 id=跳跃表>跳跃表</h3>
<p>对于于一个单链表来讲，即便链表中存储的数据是有序的，如果我们要想在其中查找某个数据，也只能从头到尾遍历链表。这样查找效率就会很低，时间复杂度会很高，是 O(n)。比如查找12，需要7次查找：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504150943.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如果我们增加如下两级索引，那么它搜索次数就变成了3次：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504151003.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=redis-跳跃表>Redis 跳跃表</h3>
<p>redis跳跃表并没有在单独的类（比如skplist.c)中定义，而是其定义在server.h中, 如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#8f5902;font-style:italic>/* ZSETs use a specialized version of Skiplists */</span>
<span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>zskiplistNode</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>sds</span> <span style=color:#000>ele</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>score</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>zskiplistNode</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>backward</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>zskiplistLevel</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>zskiplistNode</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>forward</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>span</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span> <span style=color:#000>level</span><span style=color:#000;font-weight:700>[];</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#000>zskiplistNode</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>zskiplist</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>zskiplistNode</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>header</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>tail</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>length</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>level</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#000>zskiplist</span><span style=color:#000;font-weight:700>;</span>
</code></pre></div><p>内存布局：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210504151129.png style=display:block;width:50% alt=NAME align=center> </div>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</p>
<p><strong>zskiplist的核心设计要点</strong></p>
<ul>
<li>
<p><strong>头结点</strong>不持有任何数据, 且其level[]的长度为32</p>
</li>
<li>
<p>每个结点</p>
<ul>
<li>
<p><code>ele</code>字段，持有数据，是sds类型</p>
</li>
<li>
<p><code>score</code>字段, 其标示着结点的得分, 结点之间凭借得分来判断先后顺序, 跳跃表中的结点按结点的得分升序排列.</p>
</li>
<li>
<p><code>backward</code>指针, 这是原版跳跃表中所没有的. 该指针指向结点的前一个紧邻结点.</p>
</li>
<li>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>level
</code></pre></div><p>字段, 用以记录所有结点(除过头结点外)；每个结点中最多持有32个zskiplistLevel结构. 实际数量在结点创建时, 按幂次定律随机生成(不超过32). 每个zskiplistLevel中有两个字段</p>
<ul>
<li><code>forward</code>字段指向比自己得分高的某个结点(不一定是紧邻的), 并且, 若当前zskiplistLevel实例在level[]中的索引为X, 则其forward字段指向的结点, 其level[]字段的容量至少是X+1. 这也是上图中, 为什么forward指针总是画的水平的原因.</li>
<li><code>span</code>字段代表forward字段指向的结点, 距离当前结点的距离. 紧邻的两个结点之间的距离定义为1.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id=为什么不选择平衡树或哈希表>为什么不选择平衡树或哈希表</h3>
<p>作者：</p>
<blockquote>
<p>There are a few reasons:</p>
<p>They are not very memory intensive. It&rsquo;s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.
A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.</p>
<p>They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.</p>
<p>About the Append Only durability & speed, I don&rsquo;t think it is a good idea to optimize Redis at cost of more code and more complexity for a use case that IMHO should be rare for the Redis target (fsync() at every command). Almost no one is using this feature even with ACID SQL databases, as the performance hint is big anyway.
About threads: our experience shows that Redis is mostly I/O bound. I&rsquo;m using threads to serve things from Virtual Memory. The long term solution to exploit all the cores, assuming your link is so fast that you can saturate a single core, is running multiple instances of Redis (no locks, almost fully scalable linearly with number of cores), and using the &ldquo;Redis Cluster&rdquo; solution that I plan to develop in the future.</p>
</blockquote>
<p>简而言之就是实现简单且达到了类似效果。</p>
<p>skiplist和各种平衡树（如AVL、红黑树等）的元素是有序排列的，而哈希表不是有序的。因此，在哈希表上只能做单个key的查找，不适宜做范围查找。所谓范围查找，指的是查找那些大小在指定的两个值之间的所有节点。</p>
<p>在做范围查找的时候，平衡树比skiplist操作要复杂。在平衡树上，我们找到指定范围的小值之后，还需要以中序遍历的顺序继续寻找其它不超过大值的节点。如果不对平衡树进行一定的改造，这里的中序遍历并不容易实现。而在skiplist上进行范围查找就非常简单，只需要在找到小值之后，对第1层链表进行若干步的遍历就可以实现。</p>
<p>平衡树的插入和删除操作可能引发子树的调整，逻辑复杂，而skiplist的插入和删除只需要修改相邻节点的指针，操作简单又快速。</p>
<p>从内存占用上来说，skiplist比平衡树更灵活一些。一般来说，平衡树每个节点包含2个指针（分别指向左右子树），而skiplist每个节点包含的指针数目平均为1/(1-p)，具体取决于参数p的大小。如果像Redis里的实现一样，取p=1/4，那么平均每个节点包含1.33个指针，比平衡树更有优势。</p>
<p>查找单个key，skiplist和平衡树的时间复杂度都为O(log n)，大体相当；而哈希表在保持较低的哈希值冲突概率的前提下，查找时间复杂度接近O(1)，性能更高一些。所以我们平常使用的各种Map或dictionary结构，大都是基于哈希表实现的。</p>
<p>从算法实现难度上来比较，skiplist比平衡树要简单得多。</p>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>