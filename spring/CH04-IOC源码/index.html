
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Infilos's persional workspace.">
      
      
      
        <meta name="author" content="infilos">
      
      
        <link rel="canonical" href="https://www.infilos.com/spring/CH04-IOC%E6%BA%90%E7%A0%81/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>CH04-IOC源码 - Infilos Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Ubuntu";--md-code-font-family:"Ubuntu Mono"}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-123062585-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  
  
    
  
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Infilos Workspace - CH04-IOC源码">
  <meta property="og:description" content="Infilos's persional workspace.">
  <meta property="og:url" content="https://www.infilos.com/spring/CH04-IOC%E6%BA%90%E7%A0%81/">
  <meta property="og:image" content="https://www.infilos.comassets/images/banner.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1080">
  <meta property="og:image:height" content="568">
  <link rel="stylesheet" href="../../assets/stylesheets/main.4ea92eb1.min.css">

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ch04-ioc" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-announce">
          <div class="md-announce__inner md-grid md-typeset">
            

          </div>
        </aside>
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Infilos Workspace" class="md-header__button md-logo" aria-label="Infilos Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Infilos Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              CH04-IOC源码
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/infilos/infilos.com" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    infilos/infilos.com
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../os/" class="md-tabs__link">
        Basic
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../java-base/CH01-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="md-tabs__link">
        Language
      </a>
    </li>
  

  

  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../CH01-IOC/" class="md-tabs__link md-tabs__link--active">
        Project
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../rdbms/CH01-%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F/" class="md-tabs__link">
        Architect
      </a>
    </li>
  

  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../ds/CH01-%E6%95%B0%E7%BB%84-%E9%93%BE%E8%A1%A8/" class="md-tabs__link">
        Interview
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../open-source/" class="md-tabs__link">
      Open Source
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../wip/" class="md-tabs__link">
      Blog
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../wip/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Infilos Workspace" class="md-nav__button md-logo" aria-label="Infilos Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Infilos Workspace
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/infilos/infilos.com" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    infilos/infilos.com
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        操作系统
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="操作系统" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          操作系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/" class="md-nav__link">
        CH00-概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH02-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D/" class="md-nav__link">
        CH02-操作系统介绍
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH04-%E6%8A%BD%E8%B1%A1-%E8%BF%9B%E7%A8%8B/" class="md-nav__link">
        CH04-抽象-进程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH05-%E6%8F%92%E5%8F%99-%E8%BF%9B%E7%A8%8B%20API/" class="md-nav__link">
        CH05-插叙-进程 API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH06-%E6%9C%BA%E5%88%B6-%E5%8F%97%E9%99%90%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C/" class="md-nav__link">
        CH06-机制-受限直接执行
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH07-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/" class="md-nav__link">
        CH07-进程调度
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH08-%E8%B0%83%E5%BA%A6-%E5%A4%9A%E7%BA%A7%E5%8F%8D%E9%A6%88%E9%98%9F%E5%88%97/" class="md-nav__link">
        CH08-调度-多级反馈队列
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH09-%E8%B0%83%E5%BA%A6-%E6%AF%94%E4%BE%8B%E4%BB%BD%E9%A2%9D/" class="md-nav__link">
        CH09-调度-比例份额
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH10-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E8%B0%83%E5%BA%A6/" class="md-nav__link">
        CH10-多处理器调度
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH13-%E6%8A%BD%E8%B1%A1-%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" class="md-nav__link">
        CH13-抽象-地址空间
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH14-%E5%86%85%E5%AD%98%E6%8E%A5%E5%8F%A3/" class="md-nav__link">
        CH14-内存接口
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH15-%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2/" class="md-nav__link">
        CH15-地址转换
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH16-%E5%88%86%E6%AE%B5/" class="md-nav__link">
        CH16-分段
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        操作系统-性能之殇
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="操作系统-性能之殇" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          操作系统-性能之殇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/" class="md-nav__link">
        CH00-概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH01-%E5%86%AF%E8%AF%BA%E4%BE%9D%E6%9B%BC%E7%93%B6%E9%A2%88/" class="md-nav__link">
        CH01-冯诺依曼瓶颈
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH02-CPU%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        CH02-CPU实现
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH03-%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8/" class="md-nav__link">
        CH03-事件驱动
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH04-Unix%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH04-Unix进程模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH05-DPDK-SDN-%E5%A4%A7%E9%A1%B5%E5%86%85%E5%AD%98/" class="md-nav__link">
        CH05-DPDK-SDN-大页内存
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH06-%E5%B1%80%E9%83%A8%E6%80%A7%E4%B8%8E%E4%B9%90%E8%A7%82/" class="md-nav__link">
        CH06-局部性与乐观
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH07-%E5%85%B1%E5%90%8C%E7%9A%84%E7%93%B6%E9%A2%88/" class="md-nav__link">
        CH07-共同的瓶颈
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        I/O 模型
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="I/O 模型" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          I/O 模型
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH01-IO%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH01-Linux IO/线程 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH02-IO%E9%9B%B6%E6%8B%B7%E8%B4%9D/" class="md-nav__link">
        CH02-Linux IO 零拷贝
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH03-Netty%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH03-Netty IO 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH04-Redis%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH04-Redis IO 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH05-Nginx%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH05-Nginx IO 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH06-MySQL%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH06-MySQL模型
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      <label class="md-nav__link" for="__nav_2_4">
        Network
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Network" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Network
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH01-%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82/" class="md-nav__link">
        CH01-网络分层
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH02-IP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH02-IP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH03-TCP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH03-TCP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH04-UDP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH04-UDP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH05-HTTP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH05-HTTP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH06-WebSocket/" class="md-nav__link">
        CH06-WebSocket
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH07-DNS%E6%9C%8D%E5%8A%A1/" class="md-nav__link">
        CH07-DNS服务
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH08-%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%87%E7%A8%8B/" class="md-nav__link">
        CH08-浏览器过程
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      <label class="md-nav__link" for="__nav_2_5">
        TCP/IP
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="TCP/IP" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          TCP/IP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tcpip/CH01-%E6%8F%A1%E6%89%8B%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH01-握手机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tcpip/CH02-%E5%8D%8F%E8%AE%AE%E6%A0%88%E7%B2%BE%E8%A6%81/" class="md-nav__link">
        CH02-协议栈精要
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tcpip/CH03-%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/" class="md-nav__link">
        CH03-调优参数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tcpip/CH04-%E7%90%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E6%A0%88/" class="md-nav__link">
        CH04-理解网络栈
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tcpip/CH05-RFC-1180/" class="md-nav__link">
        CH05-RFC-1180
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tcpip/CH06-%E5%8F%AF%E9%9D%A0%E6%80%A7%E7%96%91%E9%97%AE/" class="md-nav__link">
        CH06-可靠性疑问
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      <label class="md-nav__link" for="__nav_2_6">
        HTTP
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="HTTP" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          HTTP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH01-%E6%A6%82%E8%BF%B0/" class="md-nav__link">
        CH01-HTTP 概述
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH02-URL%E4%B8%8E%E8%B5%84%E6%BA%90/" class="md-nav__link">
        CH02-URL与资源
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH03-HTTP%E6%8A%A5%E6%96%87/" class="md-nav__link">
        CH03-HTTP报文
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH04-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/" class="md-nav__link">
        CH04-连接管理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH99-%E6%80%A7%E8%83%BD%E6%8E%A2%E7%B4%A2/" class="md-nav__link">
        CH99-性能探索
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Language
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Language" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Java
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_1" type="checkbox" id="__nav_3_1_1" >
      
      <label class="md-nav__link" for="__nav_3_1_1">
        Java 基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 基础" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_1">
          <span class="md-nav__icon md-icon"></span>
          Java 基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH01-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="md-nav__link">
        CH01-面向对象
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH02-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" class="md-nav__link">
        CH02-基本知识
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH03-%E5%9F%BA%E6%9C%AC%E5%9B%BE%E8%B0%B1/" class="md-nav__link">
        CH03-基本图谱
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH04-%E6%B3%9B%E5%9E%8B%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH04-泛型机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH05-%E6%B3%A8%E8%A7%A3%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH05-注解机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH06-%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH06-异常机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH07-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH07-反射机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH08-SPI%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH08-SPI机制
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_2" type="checkbox" id="__nav_3_1_2" >
      
      <label class="md-nav__link" for="__nav_3_1_2">
        Java 集合
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 集合" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_2">
          <span class="md-nav__icon md-icon"></span>
          Java 集合
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH01-%E9%9B%86%E5%90%88%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH01-集合结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH02-ArrayList/" class="md-nav__link">
        CH02-ArrayList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH03-LinkedList/" class="md-nav__link">
        CH03-LinkedList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH04-Stack-Queue/" class="md-nav__link">
        CH04-Stack-Queue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH05-PriorityQueue/" class="md-nav__link">
        CH05-PriorityQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH06-HashSet-Map/" class="md-nav__link">
        CH06-HashSet-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH07-LinkedHashSet-Map/" class="md-nav__link">
        CH07-LinkedHashSet-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH08-TreeSet-Map/" class="md-nav__link">
        CH08-TreeSet-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH09-WeakHashMap/" class="md-nav__link">
        CH09-WeakHashMap
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3" type="checkbox" id="__nav_3_1_3" >
      
      <label class="md-nav__link" for="__nav_3_1_3">
        Java 并发
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 并发" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_3">
          <span class="md-nav__icon md-icon"></span>
          Java 并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_1" type="checkbox" id="__nav_3_1_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1_3_1">
        基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="基础" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_1">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH01-%E5%B9%B6%E5%8F%91%E4%BD%93%E7%B3%BB/" class="md-nav__link">
        CH01-并发体系
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH02-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        CH02-理论基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH03-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-1/" class="md-nav__link">
        CH03-线程基础-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH04-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-2/" class="md-nav__link">
        CH04-线程基础-2
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_2" type="checkbox" id="__nav_3_1_3_2" >
      
      <label class="md-nav__link" for="__nav_3_1_3_2">
        关键字
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="关键字" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_2">
          <span class="md-nav__icon md-icon"></span>
          关键字
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH05-Synchronized/" class="md-nav__link">
        CH05-Synchronized
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH06-Volatile/" class="md-nav__link">
        CH06-Volatile
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH07-Final/" class="md-nav__link">
        CH07-Final
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_3" type="checkbox" id="__nav_3_1_3_3" >
      
      <label class="md-nav__link" for="__nav_3_1_3_3">
        锁
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="锁" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_3">
          <span class="md-nav__icon md-icon"></span>
          锁
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH08-%E5%B9%B6%E5%8F%91%E6%A6%82%E8%A7%88/" class="md-nav__link">
        CH08-并发概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH09-%E5%BA%95%E5%B1%82%E6%94%AF%E6%92%91/" class="md-nav__link">
        CH09-底层支撑
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH10-LockSupport/" class="md-nav__link">
        CH10-LockSupport
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH11-AQS-1/" class="md-nav__link">
        CH11-AQS-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH12-AQS-2/" class="md-nav__link">
        CH12-AQS-2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH13-AQS-3/" class="md-nav__link">
        CH13-AQS-3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH14-AQS-4/" class="md-nav__link">
        CH14-AQS-4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH15-ReentrantLock/" class="md-nav__link">
        CH15-ReentrantLock
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH16-ReentrantReadWriteLock/" class="md-nav__link">
        CH16-ReentrantReadWriteLock
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_4" type="checkbox" id="__nav_3_1_3_4" >
      
      <label class="md-nav__link" for="__nav_3_1_3_4">
        集合
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="集合" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_4">
          <span class="md-nav__icon md-icon"></span>
          集合
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH17-ConcurrentHashMap/" class="md-nav__link">
        CH17-ConcurrentHashMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH18-ConcurrentLinkedQueue/" class="md-nav__link">
        CH18-ConcurrentLinkedQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH19-BlockingQueue/" class="md-nav__link">
        CH19-BlockingQueue
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_5" type="checkbox" id="__nav_3_1_3_5" >
      
      <label class="md-nav__link" for="__nav_3_1_3_5">
        线程池
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="线程池" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_5">
          <span class="md-nav__icon md-icon"></span>
          线程池
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH20-FutureTask/" class="md-nav__link">
        CH20-FutureTask
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH21-ThreadPoolExecutor/" class="md-nav__link">
        CH21-ThreadPoolExecutor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH22-ScheduledThreadPoolExecutor/" class="md-nav__link">
        CH22-ScheduledThreadPoolExecutor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH23-ForkJoin/" class="md-nav__link">
        CH23-ForkJoin.md
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_6" type="checkbox" id="__nav_3_1_3_6" >
      
      <label class="md-nav__link" for="__nav_3_1_3_6">
        工具
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="工具" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_6">
          <span class="md-nav__icon md-icon"></span>
          工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH24-CountDownLatch/" class="md-nav__link">
        CH24-CountDownLatch
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH25-CyclicBarrier/" class="md-nav__link">
        CH25-CyclicBarrier
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH26-Semaphore/" class="md-nav__link">
        CH26-Semaphore
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH27-Phaser/" class="md-nav__link">
        CH27-Phaser
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH28-Exchanger/" class="md-nav__link">
        CH28-Exchanger
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH29-ThreadLocal/" class="md-nav__link">
        CH29-ThreadLocal
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_7" type="checkbox" id="__nav_3_1_3_7" >
      
      <label class="md-nav__link" for="__nav_3_1_3_7">
        汇总
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="汇总" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_7">
          <span class="md-nav__icon md-icon"></span>
          汇总
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH30-AllLocks/" class="md-nav__link">
        CH30-AllLocks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH31-AllQueues/" class="md-nav__link">
        CH31-AllQueues
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH32-AllPools/" class="md-nav__link">
        CH32-AllPools
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_4" type="checkbox" id="__nav_3_1_4" >
      
      <label class="md-nav__link" for="__nav_3_1_4">
        Java I/O
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java I/O" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_4">
          <span class="md-nav__icon md-icon"></span>
          Java I/O
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH01-IO%E5%88%86%E7%B1%BB/" class="md-nav__link">
        CH01-IO分类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH02-%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH02-装饰模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH03-InputStream/" class="md-nav__link">
        CH03-InputStream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH04-OutputStream/" class="md-nav__link">
        CH04-OutputStream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH05-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/" class="md-nav__link">
        CH05-常用操作.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH06-IO%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        CH06-IO实现
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH07-IO%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH07-IO模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH08-BIO%E5%8E%9F%E7%90%86/" class="md-nav__link">
        CH08-BIO原理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH09-NIO%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        CH09-NIO基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH10-NIO%E5%8E%9F%E7%90%86/" class="md-nav__link">
        CH10-NIO原理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH11-AIO%E5%8E%9F%E7%90%86/" class="md-nav__link">
        CH11-AIO原理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH12-%E9%9B%B6%E6%8B%B7%E8%B4%9D/" class="md-nav__link">
        CH12-零拷贝
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH13-%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84/" class="md-nav__link">
        CH13-内存映射
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_5" type="checkbox" id="__nav_3_1_5" >
      
      <label class="md-nav__link" for="__nav_3_1_5">
        Java JVM
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JVM" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_5">
          <span class="md-nav__icon md-icon"></span>
          Java JVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH01-JVM%E6%A6%82%E8%A7%88/" class="md-nav__link">
        CH01-JVM概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH02-JVM%E5%AD%97%E8%8A%82%E7%A0%81/" class="md-nav__link">
        CH02-JVM字节码
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH03-JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD/" class="md-nav__link">
        CH03-JVM类加载
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH04-JVM%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH04-JVM内存结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH05-JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-1/" class="md-nav__link">
        CH05-JVM内存模型-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH06-JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-2/" class="md-nav__link">
        CH06-JVM内存模型-2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH07-JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="md-nav__link">
        CH07-JVM垃圾回收
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH08-JVM-G1/" class="md-nav__link">
        CH08-JVM-G1.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH09-JVM-ZGC/" class="md-nav__link">
        CH09-JVM-ZGC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH10-JVM%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/" class="md-nav__link">
        CH10-JVM调优参数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH11-JVM-OOM/" class="md-nav__link">
        CH11-JVM-OOM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH12-JVM%E7%BA%BF%E7%A8%8BDump/" class="md-nav__link">
        CH12-JVM线程Dump
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH13-JVM%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        CH13-JVM调试命令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH14-JVM%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        CH14-JVM调试工具
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH15-JVM%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95/" class="md-nav__link">
        CH15-JVM动态调试
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        JVM
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="JVM" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          JVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_1" type="checkbox" id="__nav_3_2_1" >
      
      <label class="md-nav__link" for="__nav_3_2_1">
        Java JSR-133
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JSR-133" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_1">
          <span class="md-nav__icon md-icon"></span>
          Java JSR-133
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH01-%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92/" class="md-nav__link">
        CH01-指令重排
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH02-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C/" class="md-nav__link">
        CH02-内存屏障
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH03-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8/" class="md-nav__link">
        CH03-多处理器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH04-%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" class="md-nav__link">
        CH04-开发指南
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_2" type="checkbox" id="__nav_3_2_2" >
      
      <label class="md-nav__link" for="__nav_3_2_2">
        Java JMM 规范
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JMM 规范" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_2">
          <span class="md-nav__icon md-icon"></span>
          Java JMM 规范
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH01-JMM%E8%A7%84%E8%8C%83/" class="md-nav__link">
        CH01-JMM规范
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH02-JMM%E8%A7%A3%E9%87%8A/" class="md-nav__link">
        CH02-JMM Explain
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH03-JMM%E5%8E%9F%E5%88%99/" class="md-nav__link">
        CH03-JMM原则
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH04-JSR133-FAQ/" class="md-nav__link">
        CH04-JSR133-FAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH05-JSR133-Cook/" class="md-nav__link">
        CH05-JSR133-Cook
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3" type="checkbox" id="__nav_3_2_3" >
      
      <label class="md-nav__link" for="__nav_3_2_3">
        Java JVM 深入理解 V2
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JVM 深入理解 V2" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_3">
          <span class="md-nav__icon md-icon"></span>
          Java JVM 深入理解 V2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_1" type="checkbox" id="__nav_3_2_3_1" >
      
      <label class="md-nav__link" for="__nav_3_2_3_1">
        开始
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="开始" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_1">
          <span class="md-nav__icon md-icon"></span>
          开始
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH01-%E8%B5%B0%E8%BF%9BJava/" class="md-nav__link">
        CH01-走近 Java
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_2" type="checkbox" id="__nav_3_2_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2_3_2">
        内存管理
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="内存管理" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_2">
          <span class="md-nav__icon md-icon"></span>
          内存管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH02-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E4%B8%8E%E6%BA%A2%E5%87%BA%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        CH02-内存区域与溢出
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH03-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E4%B8%8E%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/" class="md-nav__link">
        CH03-垃圾收集与分配策略
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH04-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/" class="md-nav__link">
        CH04-性能监控与故障处理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH05-%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B/" class="md-nav__link">
        CH05-调优案例
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_3" type="checkbox" id="__nav_3_2_3_3" >
      
      <label class="md-nav__link" for="__nav_3_2_3_3">
        执行子系统
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="执行子系统" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_3">
          <span class="md-nav__icon md-icon"></span>
          执行子系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH06-%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH06-类文件结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH07-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH07-类加载
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/" class="md-nav__link">
        CH08-字节码执行引擎
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH09-%E6%A1%88%E4%BE%8B%E4%B8%8E%E5%AE%9E%E6%88%98/" class="md-nav__link">
        CH09-案例与实战
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_4" type="checkbox" id="__nav_3_2_3_4" >
      
      <label class="md-nav__link" for="__nav_3_2_3_4">
        编译与优化
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="编译与优化" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_4">
          <span class="md-nav__icon md-icon"></span>
          编译与优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH10-%E7%BC%96%E8%AF%91%E6%9C%9F%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH10-编译期优化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH11-%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH11-运行时优化
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_5" type="checkbox" id="__nav_3_2_3_5" >
      
      <label class="md-nav__link" for="__nav_3_2_3_5">
        高效并发
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="高效并发" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_5">
          <span class="md-nav__icon md-icon"></span>
          高效并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH12-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" class="md-nav__link">
        CH12-内存模型与线程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH13-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH13-线程安全与锁优化
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_6" type="checkbox" id="__nav_3_2_3_6" >
      
      <label class="md-nav__link" for="__nav_3_2_3_6">
        附录
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="附录" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_6">
          <span class="md-nav__icon md-icon"></span>
          附录
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/Endix-B-%E6%8C%87%E4%BB%A4%E8%A1%A8/" class="md-nav__link">
        Endix-B-字节码指令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/Endix-C-%E5%8F%82%E6%95%B0%E8%A1%A8/" class="md-nav__link">
        Endix-C-虚拟机参数
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        Java JVM 深入理解 V3
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3">
        并发
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="并发" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1" type="checkbox" id="__nav_3_3_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1">
        Java 并发实战
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 并发实战" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_1">
          <span class="md-nav__icon md-icon"></span>
          Java 并发实战
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH01-%E7%AE%80%E4%BB%8B/" class="md-nav__link">
        CH01-简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH02-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7/" class="md-nav__link">
        CH02-线程安全性
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH03-%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB/" class="md-nav__link">
        CH03-对象共享
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH04-%E5%AF%B9%E8%B1%A1%E7%BB%84%E5%90%88/" class="md-nav__link">
        CH04-对象组合
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH05-%E5%9F%BA%E7%A1%80%E6%9E%84%E5%BB%BA%E5%9D%97/" class="md-nav__link">
        CH05-基础构建块
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH06-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C/" class="md-nav__link">
        CH06-任务执行
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH07-%E5%8F%96%E6%B6%88%E5%85%B3%E9%97%AD/" class="md-nav__link">
        CH07-取消关闭
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH08-%E7%BA%BF%E7%A8%8B%E6%B1%A0/" class="md-nav__link">
        CH08-线程池
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH09-GUI%E5%BA%94%E7%94%A8/" class="md-nav__link">
        CH09-GUI应用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH10-%E6%B4%BB%E8%B7%83%E6%80%A7%E5%8D%B1%E9%99%A9/" class="md-nav__link">
        CH10-活跃性危险
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH11-%E6%80%A7%E8%83%BD%E4%B8%8E%E4%BC%B8%E7%BC%A9/" class="md-nav__link">
        CH11-性能与伸缩
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH12-%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        CH12-测试
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH13-%E6%98%BE%E5%BC%8F%E9%94%81/" class="md-nav__link">
        CH13-显式锁
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH14-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95/" class="md-nav__link">
        CH14-自定义扩展
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH15-%E5%8E%9F%E5%AD%90%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5/" class="md-nav__link">
        CH15-原子与非阻塞同步
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH16-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH16-内存模型
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        Java 并发模式
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_3" type="checkbox" id="__nav_3_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3_3">
        深入理解并行
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="深入理解并行" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_3">
          <span class="md-nav__icon md-icon"></span>
          深入理解并行
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH01/" class="md-nav__link">
        CH01-关于本书
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH02/" class="md-nav__link">
        CH02-简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH03/" class="md-nav__link">
        CH03-硬件特性
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH04/" class="md-nav__link">
        CH04-并行工具
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH05/" class="md-nav__link">
        CH05-计数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH06/" class="md-nav__link">
        CH06-分割同步设计
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH07/" class="md-nav__link">
        CH07-锁
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH08/" class="md-nav__link">
        CH08-数据所有权
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH09/" class="md-nav__link">
        CH09-延后处理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH10/" class="md-nav__link">
        CH10-数据结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH11/" class="md-nav__link">
        CH11-验证
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH12/" class="md-nav__link">
        CH12-形式验证
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH13/" class="md-nav__link">
        CH13-综合应用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH14/" class="md-nav__link">
        CH14-高级同步
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH15/" class="md-nav__link">
        CH15-高级同步-内存序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/Endix/" class="md-nav__link">
        ENDIX-C-内存屏障
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_4" type="checkbox" id="__nav_3_3_4" >
      
      <label class="md-nav__link" for="__nav_3_3_4">
        七周七并发模型
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="七周七并发模型" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_4">
          <span class="md-nav__icon md-icon"></span>
          七周七并发模型
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH01/" class="md-nav__link">
        CH01-概述
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH02/" class="md-nav__link">
        CH02-线程与锁
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH03/" class="md-nav__link">
        CH03-函数式编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH04/" class="md-nav__link">
        CH04-分离标识与状态
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH05/" class="md-nav__link">
        CH05-Actor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH06/" class="md-nav__link">
        CH06-CSP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH07/" class="md-nav__link">
        CH07-数据并行
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH08/" class="md-nav__link">
        CH08-Lambda 架构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH09/" class="md-nav__link">
        CH09-未来方向
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      <label class="md-nav__link" for="__nav_3_4">
        Scala
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Scala
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_1" type="checkbox" id="__nav_3_4_1" >
      
      <label class="md-nav__link" for="__nav_3_4_1">
        Scala 精要
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala 精要" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_1">
          <span class="md-nav__icon md-icon"></span>
          Scala 精要
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/case-class/" class="md-nav__link">
        Case Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/functional-1/" class="md-nav__link">
        函数式-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/functional-2/" class="md-nav__link">
        函数式-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-1/" class="md-nav__link">
        Future-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-2/" class="md-nav__link">
        Future-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-3/" class="md-nav__link">
        Future-集合
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-4/" class="md-nav__link">
        Future-Promise
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/implicits-1/" class="md-nav__link">
        Implicits-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/implicits-2/" class="md-nav__link">
        Implicits-进阶
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/trait-1/" class="md-nav__link">
        Trait-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/trait-2/" class="md-nav__link">
        Trait-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/try/" class="md-nav__link">
        Try
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-1/" class="md-nav__link">
        Type-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-2/" class="md-nav__link">
        None
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-2/" class="md-nav__link">
        Type-进阶
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/primitive/" class="md-nav__link">
        Primitive
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/numbers/" class="md-nav__link">
        Numbers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/strings/" class="md-nav__link">
        String
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/control/" class="md-nav__link">
        Control
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/pattern-match/" class="md-nav__link">
        Pattern Match
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-1/" class="md-nav__link">
        Class Object: 基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-2/" class="md-nav__link">
        Class Object: 类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-3/" class="md-nav__link">
        Class Object: 方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-4/" class="md-nav__link">
        Class Object: 对象
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-5/" class="md-nav__link">
        函数式对象
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-6/" class="md-nav__link">
        整体类层级
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-7/" class="md-nav__link">
        组合继承
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/package/" class="md-nav__link">
        Package
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/sbt/" class="md-nav__link">
        SBT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/predef/" class="md-nav__link">
        Predef
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/io/" class="md-nav__link">
        I/O
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/reserved/" class="md-nav__link">
        保留字
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/exception/" class="md-nav__link">
        Exception
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/annotation/" class="md-nav__link">
        Inject Type
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-class/" class="md-nav__link">
        Type Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/map/" class="md-nav__link">
        Map Flatmap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/generic/" class="md-nav__link">
        泛型型变
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/common/" class="md-nav__link">
        常见问题
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/placeholder/" class="md-nav__link">
        占位符
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/multi-vars/" class="md-nav__link">
        多变量赋值
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/constructor/" class="md-nav__link">
        构造器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-system/" class="md-nav__link">
        类型系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/functional/" class="md-nav__link">
        函数式入门
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/monoid/" class="md-nav__link">
        Monoid
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/func-type-class/" class="md-nav__link">
        函数式与类型类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/async-programming/" class="md-nav__link">
        异步编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/scala-style/" class="md-nav__link">
        战略Scala风格：最小功率的原理
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_2" type="checkbox" id="__nav_3_4_2" >
      
      <label class="md-nav__link" for="__nav_3_4_2">
        Scala 函数式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala 函数式" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_2">
          <span class="md-nav__icon md-icon"></span>
          Scala 函数式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH00-%E7%B2%BE%E8%A6%81/" class="md-nav__link">
        CH00-精要
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH01-%E5%AE%9A%E4%B9%89/" class="md-nav__link">
        CH01-定义
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH02-%E5%87%BD%E6%95%B0/" class="md-nav__link">
        CH02-函数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH03-%E6%95%B0%E6%8D%AE/" class="md-nav__link">
        CH03-数据
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH04-%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        CH04-异常
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" type="checkbox" id="__nav_3_5" >
      
      <label class="md-nav__link" for="__nav_3_5">
        设计模式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="设计模式" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          设计模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5_1" type="checkbox" id="__nav_3_5_1" >
      
      <label class="md-nav__link" for="__nav_3_5_1">
        Java 模式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 模式" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_5_1">
          <span class="md-nav__icon md-icon"></span>
          Java 模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH01/" class="md-nav__link">
        CH01-创建型-简单工厂
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH02/" class="md-nav__link">
        CH02-创建型-工厂方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH03/" class="md-nav__link">
        CH03-创建型-抽象工厂
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH04/" class="md-nav__link">
        CH04-创建型-建造者
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH05/" class="md-nav__link">
        CH05-创建型-单例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH06/" class="md-nav__link">
        CH06-结构型-适配器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH07/" class="md-nav__link">
        CH07-结构型-桥接
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH08/" class="md-nav__link">
        CH08-结构型-装饰器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH09/" class="md-nav__link">
        CH09-结构型-外观
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH10/" class="md-nav__link">
        CH10-结构型-享元
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH11/" class="md-nav__link">
        CH11-结构型-代理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH12/" class="md-nav__link">
        CH12-行为型-命令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH13/" class="md-nav__link">
        CH13-行为型-中介者
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH14/" class="md-nav__link">
        CH14-行为型-观察者
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH15/" class="md-nav__link">
        CH15-行为型-状态
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH16/" class="md-nav__link">
        CH16-行为型-策略
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5_2" type="checkbox" id="__nav_3_5_2" >
      
      <label class="md-nav__link" for="__nav_3_5_2">
        Scala 模式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala 模式" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_5_2">
          <span class="md-nav__icon md-icon"></span>
          Scala 模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH01-%E6%A8%A1%E5%BC%8F%E5%88%86%E7%B1%BB/" class="md-nav__link">
        CH01-模式分类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH02-%E7%89%B9%E8%B4%A8%E4%B8%8E%E6%B7%B7%E5%85%A5%E7%BB%84%E5%90%88/" class="md-nav__link">
        CH02-特质与混入组合
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH03-%E7%BB%9F%E4%B8%80%E5%8C%96/" class="md-nav__link">
        CH03-统一化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH04-%E6%8A%BD%E8%B1%A1%E4%B8%8E%E8%87%AA%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH04-抽象与自类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH05-AOP%20%E4%B8%8E%E7%BB%84%E4%BB%B6/" class="md-nav__link">
        CH05-AOP 与组件
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-创建型模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-1-%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" class="md-nav__link">
        CH06-1-工厂方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-2-%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82/" class="md-nav__link">
        CH06-2-抽象工厂
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-3-%E5%85%B6%E4%BB%96%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-3-其他工厂模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-4-%E6%87%92%E5%88%9D%E5%A7%8B%E5%8C%96/" class="md-nav__link">
        CH06-4-懒初始化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-5-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-5-单例模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-6-%E6%9E%84%E5%BB%BA%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-6-构建器模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-7-%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-7-原型模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-结构型模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-1-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-1-适配器模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-2-%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-2-装饰器模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-3-%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-3-桥接模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-4-%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-4-组合模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-5-%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-5-外观模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-6-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-6-享元模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-7-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-7-代理模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH08-%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F-1/" class="md-nav__link">
        CH08-行为型模式-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH09-%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F-2/" class="md-nav__link">
        CH09-行为型模式-2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH10-%E5%87%BD%E6%95%B0%E5%BC%8F%E6%A8%A1%E5%BC%8F%E7%90%86%E8%AE%BA/" class="md-nav__link">
        CH10-函数式模式理论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH11-%E5%87%BD%E6%95%B0%E5%BC%8F%E6%A8%A1%E5%BC%8F%E5%BA%94%E7%94%A8/" class="md-nav__link">
        CH11-函数式模式应用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH12-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/" class="md-nav__link">
        CH12-实际应用
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        Project
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Project" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Project
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" checked>
      
      <label class="md-nav__link" for="__nav_4_1">
        Spring
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Spring" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Spring
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH01-IOC/" class="md-nav__link">
        CH01-IOC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH02-SpringIOC/" class="md-nav__link">
        CH02-SpringIOC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH03-Bean%E5%8A%A0%E8%BD%BD/" class="md-nav__link">
        CH03-Bean加载
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          CH04-IOC源码
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        CH04-IOC源码
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#applicationcontext-bean" class="md-nav__link">
    ApplicationContext 实例化 Bean 的过程
  </a>
  
    <nav class="md-nav" aria-label="ApplicationContext 实例化 Bean 的过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    启动过程分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean" class="md-nav__link">
    创建 Bean 容器前的准备工作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean-bean" class="md-nav__link">
    创建 Bean 容器，加载并注册 Bean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean_1" class="md-nav__link">
    注册 Bean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean_2" class="md-nav__link">
    Bean 容器实例化完成后
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean-preparebeanfactory" class="md-nav__link">
    准备 Bean 容器: prepareBeanFactory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparebeanfactoryfactory" class="md-nav__link">
    prepareBeanFactory(factory)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#singleton-beans" class="md-nav__link">
    初始化所有的 singleton beans
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bean_3" class="md-nav__link">
    获取 Bean
  </a>
  
    <nav class="md-nav" aria-label="获取 Bean">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getbeanstring" class="md-nav__link">
    俯瞰 getBean(String) 源码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#createbean" class="md-nav__link">
    createBean
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    相关疑问
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH05-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/" class="md-nav__link">
        CH05-循环依赖
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH06-AOP/" class="md-nav__link">
        CH06-AOP
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Architect
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Architect" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Architect
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      <label class="md-nav__link" for="__nav_5_1">
        存储系统
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="存储系统" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          存储系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_1" type="checkbox" id="__nav_5_1_1" >
      
      <label class="md-nav__link" for="__nav_5_1_1">
        RDBMS
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="RDBMS" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_1">
          <span class="md-nav__icon md-icon"></span>
          RDBMS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH01-%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F/" class="md-nav__link">
        CH01-工作方式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH02-%E8%AE%BE%E8%AE%A1%E7%90%86%E8%AE%BA/" class="md-nav__link">
        CH02-设计理论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH03-%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B/" class="md-nav__link">
        CH03-设计流程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH04-%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/" class="md-nav__link">
        CH04-核心知识
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_2" type="checkbox" id="__nav_5_1_2" >
      
      <label class="md-nav__link" for="__nav_5_1_2">
        SQL
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="SQL" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_2">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH01-%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        CH01-语法基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH02-%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0/" class="md-nav__link">
        CH02-查询练习
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH03-%E6%9F%A5%E8%AF%A2%E8%BF%9B%E9%98%B6/" class="md-nav__link">
        CH03-查询进阶
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH04-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH04-查询优化
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_3" type="checkbox" id="__nav_5_1_3" >
      
      <label class="md-nav__link" for="__nav_5_1_3">
        MySQL
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="MySQL" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_3">
          <span class="md-nav__icon md-icon"></span>
          MySQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH01-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH01-数据类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH02-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/" class="md-nav__link">
        CH02-存储引擎
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH03-%E7%B4%A2%E5%BC%95B%2B%E6%A0%91/" class="md-nav__link">
        CH03-索引B+树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH04-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH04-性能优化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH05-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" class="md-nav__link">
        CH05-分库分表
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH06-%E5%A4%8D%E5%88%B6%E5%88%86%E7%A6%BB/" class="md-nav__link">
        CH06-复制分离
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH07-%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/" class="md-nav__link">
        CH07-执行过程
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_4" type="checkbox" id="__nav_5_1_4" >
      
      <label class="md-nav__link" for="__nav_5_1_4">
        Redis
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Redis" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_4">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH01-%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH01-基本类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH02-%E9%AB%98%E7%BA%A7%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH02-高级类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH03-Stream/" class="md-nav__link">
        CH03-Stream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH04-%E5%AF%B9%E8%B1%A1%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH04-对象机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH05-%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH05-底层结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        微服务
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      <label class="md-nav__link" for="__nav_5_3">
        分布式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="分布式" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          分布式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/consistence/" class="md-nav__link">
        一致性模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/acid/" class="md-nav__link">
        ACID 隔离级别
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/cap/" class="md-nav__link">
        CAP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/base/" class="md-nav__link">
        BASE
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/calm/" class="md-nav__link">
        CALM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/gossip/" class="md-nav__link">
        Gossip
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/crdt/" class="md-nav__link">
        CRDT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/2pc/" class="md-nav__link">
        2PC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/3pc/" class="md-nav__link">
        3PC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/paxos/" class="md-nav__link">
        Paxos
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/zab/" class="md-nav__link">
        ZAB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/raft/" class="md-nav__link">
        Raft
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4/" class="md-nav__link">
        分布式一致性
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" class="md-nav__link">
        分布式事务
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="md-nav__link">
        分布式锁
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/%E4%B8%80%E8%87%B4%E6%80%A7%E5%85%B1%E8%AF%86/" class="md-nav__link">
        一致性与共识算法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../distribute/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/" class="md-nav__link">
        一致性哈希算法
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        反应式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        数据密集
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        流式系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        消息系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        计算系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        运维交付
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        用户界面
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Interview
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Interview" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Interview
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      <label class="md-nav__link" for="__nav_6_1">
        数据结构
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="数据结构" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          数据结构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH01-%E6%95%B0%E7%BB%84-%E9%93%BE%E8%A1%A8/" class="md-nav__link">
        CH01-数组/链表
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH02-%E5%93%88%E5%B8%8C%E8%A1%A8/" class="md-nav__link">
        CH02-哈希表
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH03-%E6%A0%91-%E4%BA%8C%E5%8F%89%E6%A0%91/" class="md-nav__link">
        CH03-树/二叉树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH04-%E6%8E%92%E5%BA%8F%E4%BA%8C%E5%8F%89%E6%A0%91/" class="md-nav__link">
        CH04-排序二叉树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH05-%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91/" class="md-nav__link">
        CH05-平衡二叉树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH06-%E7%BA%A2%E9%BB%91%E6%A0%91/" class="md-nav__link">
        CH06-红黑树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH07-%E5%93%88%E5%A4%AB%E6%9B%BC%E6%A0%91/" class="md-nav__link">
        CH07-哈夫曼树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH08-%E5%89%8D%E7%BC%80%E6%A0%91/" class="md-nav__link">
        CH08-前缀树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH09-%E5%9B%BE%E6%A6%82%E5%BF%B5/" class="md-nav__link">
        CH09-图概念
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH10-%E9%81%8D%E5%8E%86/" class="md-nav__link">
        CH10-图遍历
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH11-%E6%9C%80%E5%B0%8F%E7%94%9F%E6%88%90%E6%A0%91/" class="md-nav__link">
        CH11-最小生成树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH12-%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84/" class="md-nav__link">
        CH12-图最短路径
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH13-%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH13-图拓扑排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH14-AOE-%E5%85%B3%E9%94%AE%E8%B7%AF%E5%BE%84/" class="md-nav__link">
        CH14-图-AOE-关键路径
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH15-Iterable/" class="md-nav__link">
        CH07-Iterable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH16-Collection/" class="md-nav__link">
        CH16-Collection
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH17-List/" class="md-nav__link">
        CH17-List
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH18-ArrayList/" class="md-nav__link">
        CH18-ArrayList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH19-Queue/" class="md-nav__link">
        CH19-Queue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH20-Deque/" class="md-nav__link">
        CH20-Deque
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH21-ArrayQueue/" class="md-nav__link">
        CH21-ArrayQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH22-PriorityQueue/" class="md-nav__link">
        CH22-PriorityQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH23-LinkedList/" class="md-nav__link">
        CH23-LinkedList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH24-Vector/" class="md-nav__link">
        CH24-Vector
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH25-Stack/" class="md-nav__link">
        CH25-Stack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH26-Map/" class="md-nav__link">
        CH26-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH27-SortedMap/" class="md-nav__link">
        CH27-SortedMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH28-NavigableMap/" class="md-nav__link">
        CH28-NavigableMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH29-TreeMap/" class="md-nav__link">
        CH29-TreeMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH30-HashMap/" class="md-nav__link">
        CH30-HashMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH31-LinkedHashMap/" class="md-nav__link">
        CH31-LinkedHashMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH32-EnumMap/" class="md-nav__link">
        CH32-EnumMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH33-HashTable/" class="md-nav__link">
        CH33-HashTable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH34-Set/" class="md-nav__link">
        CH34-Set
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH35-EnumSet/" class="md-nav__link">
        CH35-EnumSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH36-HashSet/" class="md-nav__link">
        CH36-HashSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH37-LinkedHashSet/" class="md-nav__link">
        CH37-LinkedHashSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH38-TreeSet/" class="md-nav__link">
        CH38-TreeSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH39-FailFast/" class="md-nav__link">
        CH39-FailFast
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      <label class="md-nav__link" for="__nav_6_2">
        排序算法
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="排序算法" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          排序算法
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH01-%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH01-冒泡排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH02-%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH02-选择排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH03-%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH03-插入排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH04-%E5%B8%8C%E5%B0%94%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH04-希尔排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH05-%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH05-归并排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH06-%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH06-快速排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH07-%E5%A0%86%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH07-堆排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH08-%E8%AE%A1%E6%95%B0%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH08-计数排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH09-%E6%A1%B6%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH09-桶排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH10-%E5%9F%BA%E6%95%B0%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH10-基数排序
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      <label class="md-nav__link" for="__nav_6_3">
        剑指 Offer
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="剑指 Offer" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          剑指 Offer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      <label class="md-nav__link" for="__nav_6_4">
        面试指南
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试指南" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          面试指南
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      <label class="md-nav__link" for="__nav_6_5">
        面试宝典
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试宝典" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          面试宝典
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_6" type="checkbox" id="__nav_6_6" >
      
      <label class="md-nav__link" for="__nav_6_6">
        面试金典
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试金典" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_6">
          <span class="md-nav__icon md-icon"></span>
          面试金典
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_7" type="checkbox" id="__nav_6_7" >
      
      <label class="md-nav__link" for="__nav_6_7">
        Leet Code
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Leet Code" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_7">
          <span class="md-nav__icon md-icon"></span>
          Leet Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../open-source/" class="md-nav__link">
        Open Source
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        Blog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#applicationcontext-bean" class="md-nav__link">
    ApplicationContext 实例化 Bean 的过程
  </a>
  
    <nav class="md-nav" aria-label="ApplicationContext 实例化 Bean 的过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    启动过程分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean" class="md-nav__link">
    创建 Bean 容器前的准备工作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean-bean" class="md-nav__link">
    创建 Bean 容器，加载并注册 Bean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean_1" class="md-nav__link">
    注册 Bean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean_2" class="md-nav__link">
    Bean 容器实例化完成后
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean-preparebeanfactory" class="md-nav__link">
    准备 Bean 容器: prepareBeanFactory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparebeanfactoryfactory" class="md-nav__link">
    prepareBeanFactory(factory)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#singleton-beans" class="md-nav__link">
    初始化所有的 singleton beans
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bean_3" class="md-nav__link">
    获取 Bean
  </a>
  
    <nav class="md-nav" aria-label="获取 Bean">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getbeanstring" class="md-nav__link">
    俯瞰 getBean(String) 源码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#createbean" class="md-nav__link">
    createBean
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    相关疑问
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="ch04-ioc">CH04-IOC源码<a class="headerlink" href="#ch04-ioc" title="Permanent link">&para;</a></h1>
<!-- toc -->

<h2 id="applicationcontext-bean">ApplicationContext 实例化 Bean 的过程<a class="headerlink" href="#applicationcontext-bean" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">ApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="p">(</span><span class="s">&quot;classpath:applicationContext.xml&quot;</span><span class="p">);</span>
<span class="n">Hello</span> <span class="n">hello</span> <span class="o">=</span> <span class="p">(</span><span class="n">Hello</span><span class="p">)</span><span class="n">ac</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
<span class="n">hello</span><span class="p">.</span><span class="na">sayHello</span><span class="p">();</span>
</code></pre></div>
<p>这个从写法上我们可以知道从 ClassPath 中寻找 xml 配置文件，然后根据 xml 文件的内容来构建ApplicationContext 对象实例（容器），然后通过容器获取一个叫 ”hello“ 的 bean，执行该 bean 的 sayHello 方法。</p>
<p>当然我们之前也知道这不是唯一的构建容器方式，我们先来看看大体的继承结构是怎么样的：</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120343.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<h3 id="_1">启动过程分析<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>第一步，我们肯定要从 ClassPathXmlApplicationContext 的构造方法说起。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="nf">ClassPathXmlApplicationContext</span><span class="p">(</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">configLocations</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">refresh</span><span class="p">,</span> <span class="nd">@Nullable</span> <span class="n">ApplicationContext</span> <span class="n">parent</span><span class="p">)</span>
      <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>

   <span class="kd">super</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
   <span class="c1">// 根据提供的路径，处理成配置文件数组(以分号、逗号、空格、tab、换行符分割)</span>
   <span class="n">setConfigLocations</span><span class="p">(</span><span class="n">configLocations</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">refresh</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">refresh</span><span class="p">();</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>接下来，就是 <code>refresh()</code>，这里简单说下为什么是 <code>refresh()</code>，而不是 <code>init()</code> 这种名字的方法。因为 ApplicationContext 建立起来以后，其实我们是可以通过调用 <code>refresh()</code> 这个方法重建的，<code>refresh()</code> 会将原来的 ApplicationContext 销毁，然后再重新执行一次初始化操作。</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="p">,</span> <span class="n">IllegalStateException</span> <span class="p">{</span>
    <span class="c1">// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛</span>
    <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">startupShutdownMonitor</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Prepare this context for refreshing.</span>
        <span class="c1">// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符</span>
        <span class="n">prepareRefresh</span><span class="p">();</span>

        <span class="c1">// Tell the subclass to refresh the internal bean factory.</span>
        <span class="c1">// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，</span>
        <span class="c1">// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，</span>
        <span class="c1">// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)</span>
        <span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="p">();</span>

        <span class="c1">// Prepare the bean factory for use in this context.</span>
        <span class="c1">// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean</span>
        <span class="n">prepareBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// Allows post-processing of the bean factory in context subclasses.</span>
            <span class="c1">//提供给子类实现一些postProcess的注册，如AbstractRefreshableWebApplicationContext注册一些Servlet相关的</span>
            <span class="n">postProcessBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

            <span class="c1">// Invoke factory processors registered as beans in the context.</span>
            <span class="c1">//调用所有BeanFactoryProcessor的postProcessBeanFactory()方法</span>
            <span class="n">invokeBeanFactoryPostProcessors</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

            <span class="c1">// Register bean processors that intercept bean creation.</span>
            <span class="c1">//注册BeanPostProcessor，BeanPostProcessor作用是用于拦截Bean的创建</span>
            <span class="n">registerBeanPostProcessors</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

            <span class="c1">// Initialize message source for this context.</span>
            <span class="c1">//初始化消息Bean</span>
            <span class="n">initMessageSource</span><span class="p">();</span>

            <span class="c1">// Initialize event multicaster for this context.</span>
            <span class="c1">//初始化上下文的事件多播组建，ApplicationEvent触发时由multicaster通知给ApplicationListener</span>
            <span class="n">initApplicationEventMulticaster</span><span class="p">();</span>

            <span class="c1">// Initialize other special beans in specific context subclasses.</span>
            <span class="c1">//ApplicationContext初始化一些特殊的bean</span>
            <span class="n">onRefresh</span><span class="p">();</span>

            <span class="c1">// Check for listener beans and register them.</span>
            <span class="c1">//注册事件监听器，事件监听Bean统一注册到multicaster里头，ApplicationEvent事件触发后会由multicaster广播</span>
            <span class="n">registerListeners</span><span class="p">();</span>

            <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.(重点)</span>
            <span class="c1">// 非延迟加载的单例Bean实例化</span>
            <span class="n">finishBeanFactoryInitialization</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

            <span class="c1">// Last step: publish corresponding event.(最后，广播事件，ApplicationContext 初始化完成)</span>
            <span class="n">finishRefresh</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">catch</span> <span class="p">(</span><span class="n">BeansException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isWarnEnabled</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Exception encountered during context initialization - &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;cancelling refresh attempt: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
            <span class="n">destroyBeans</span><span class="p">();</span>

            <span class="c1">// Reset &#39;active&#39; flag.</span>
            <span class="n">cancelRefresh</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>

            <span class="c1">// Propagate exception to caller.</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">finally</span> <span class="p">{</span>
            <span class="c1">// Reset common introspection caches in Spring&#39;s core, since we</span>
            <span class="c1">// might not ever need metadata for singleton beans anymore...</span>
            <span class="n">resetCommonCaches</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>下面，我们开始一步步来肢解这个 <code>refresh()</code> 方法。</p>
<h3 id="bean">创建 Bean 容器前的准备工作<a class="headerlink" href="#bean" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Prepare this context for refreshing, setting its startup date and</span>
<span class="cm"> * active flag as well as performing any initialization of property sources.</span>
<span class="cm"> */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareRefresh</span><span class="p">()</span> <span class="p">{</span>
   <span class="c1">// Switch to active.</span>
   <span class="k">this</span><span class="p">.</span><span class="na">startupDate</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
   <span class="k">this</span><span class="p">.</span><span class="na">closed</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
   <span class="k">this</span><span class="p">.</span><span class="na">active</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Refreshing &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Initialize any placeholder property sources in the context environment.</span>
   <span class="n">initPropertySources</span><span class="p">();</span>

   <span class="c1">// Validate that all properties marked as required are resolvable:</span>
   <span class="c1">// see ConfigurablePropertyResolver#setRequiredProperties</span>
    <span class="c1">// 校验 xml 配置文件</span>
   <span class="n">getEnvironment</span><span class="p">().</span><span class="na">validateRequiredProperties</span><span class="p">();</span>

   <span class="c1">// Store pre-refresh ApplicationListeners...</span>
   <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">earlyApplicationListeners</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">earlyApplicationListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">applicationListeners</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Reset local application listeners to pre-refresh state.</span>
      <span class="k">this</span><span class="p">.</span><span class="na">applicationListeners</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="na">applicationListeners</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">earlyApplicationListeners</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Allow for the collection of early ApplicationEvents,</span>
   <span class="c1">// to be published once the multicaster is available...</span>
   <span class="k">this</span><span class="p">.</span><span class="na">earlyApplicationEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="bean-bean">创建 Bean 容器，加载并注册 Bean<a class="headerlink" href="#bean-bean" title="Permanent link">&para;</a></h3>
<p>我们回到 <code>refresh()</code> 方法中的下一行 <code>obtainFreshBeanFactory()</code>。</p>
<p>注意，这个方法是全文最重要的部分之一，这里将会初始化 BeanFactory、加载 Bean、注册 Bean 等等。</p>
<p>当然，这步结束后，Bean 并没有完成初始化。这里指的是 Bean 实例并未在这一步生成。</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="n">ConfigurableListableBeanFactory</span> <span class="nf">obtainFreshBeanFactory</span><span class="p">()</span> <span class="p">{</span>
   <span class="c1">// 关闭旧的 BeanFactory (如果有)，创建新的 BeanFactory，加载 Bean 定义、注册 Bean 等等</span>
   <span class="n">refreshBeanFactory</span><span class="p">();</span>
   <span class="c1">// 返回刚刚创建的 BeanFactory</span>
   <span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Bean factory for &quot;</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">beanFactory</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">beanFactory</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>// AbstractRefreshableApplicationContext.java</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">refreshBeanFactory</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
   <span class="c1">// 如果 ApplicationContext 中已经加载过 BeanFactory 了，销毁所有 Bean，关闭 BeanFactory</span>
   <span class="c1">// 注意，应用中 BeanFactory 本来就是可以多个的，这里可不是说应用全局是否有 BeanFactory，而是当前</span>
   <span class="c1">// ApplicationContext 是否有 BeanFactory</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">hasBeanFactory</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">destroyBeans</span><span class="p">();</span>
      <span class="n">closeBeanFactory</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// 初始化一个 DefaultListableBeanFactory，为什么用这个，我们马上说。</span>
      <span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">createBeanFactory</span><span class="p">();</span>
      <span class="c1">// 用于 BeanFactory 的序列化</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">setSerializationId</span><span class="p">(</span><span class="n">getId</span><span class="p">());</span>

      <span class="c1">// 下面这两个方法很重要，别跟丢了，具体细节之后说</span>
      <span class="c1">// 设置 BeanFactory 的两个配置属性：是否允许 Bean 覆盖、是否允许循环引用</span>
      <span class="n">customizeBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

      <span class="c1">// 加载 Bean 到 BeanFactory 中</span>
      <span class="n">loadBeanDefinitions</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
      <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">beanFactoryMonitor</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">ApplicationContextException</span><span class="p">(</span><span class="s">&quot;I/O error parsing bean definition source for &quot;</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="p">(),</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>看到这里的时候，我觉得读者就应该站在高处看 ApplicationContext 了，ApplicationContext 继承自 BeanFactory，但是它不应该被理解为 BeanFactory 的实现类，而是说其内部持有一个实例化的 BeanFactory（DefaultListableBeanFactory）。以后所有的 BeanFactory 相关的操作其实是委托给这个实例来处理的。</p>
</blockquote>
<p>我们说说为什么选择实例化 <strong>DefaultListableBeanFactory</strong> ？前面我们说了有个很重要的接口 ConfigurableListableBeanFactory，它实现了 BeanFactory 下面一层的所有三个接口，我把之前的继承图再拿过来大家再仔细看一下：</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120653.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>我们可以看到 ConfigurableListableBeanFactory 只有一个实现类 DefaultListableBeanFactory，而且实现类 DefaultListableBeanFactory 还通过实现右边的 AbstractAutowireCapableBeanFactory 通吃了右路。所以结论就是，最底下这个家伙 DefaultListableBeanFactory 基本上是最牛的 BeanFactory 了，这也是为什么这边会使用这个类来实例化的原因。</p>
<blockquote>
<p>如果你想要在程序运行的时候动态往 Spring IOC 容器注册新的 bean，就会使用到这个类。那我们怎么在运行时获得这个实例呢？</p>
<p>之前我们说过 ApplicationContext 接口能获取到 AutowireCapableBeanFactory，就是最右上角那个，然后它向下转型就能得到 DefaultListableBeanFactory 了。</p>
</blockquote>
<p>在继续往下之前，我们需要先了解 BeanDefinition。<strong>我们说 BeanFactory 是 Bean 容器，那么 Bean 又是什么呢？</strong></p>
<p>这里的 BeanDefinition 就是我们所说的 Spring 的 Bean，我们自己定义的各个 Bean 其实会转换成一个个 BeanDefinition 存在于 Spring 的 BeanFactory 中。</p>
<p>所以，如果有人问你 Bean 是什么的时候，你要知道 Bean 在代码层面上可以认为是 BeanDefinition 的实例。</p>
<blockquote>
<p>BeanDefinition 中保存了我们的 Bean 信息，比如这个 Bean 指向的是哪个类、是否是单例的、是否懒加载、这个 Bean 依赖了哪些 Bean 等等。</p>
</blockquote>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210503120722.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>BeanDefinition 是一个接口，用于属性承载，比如 <bean> 元素标签拥有 class、scope、lazy-init 等配置。bean的定义方式有千千万万种，无论是何种标签，无论是何种资源定义，无论是何种容器，只要按照 Spring 的规范编写xml配置文件，最终的 bean 定义内部表示都将转换为内部的唯一结构：BeanDefinition。当 BeanDefinition 注册完毕以后，Spring 的 BeanFactory 就可以随时根据需要进行实例化了。</p>
<h5 id="beandefinition">BeanDefinition 接口定义<a class="headerlink" href="#beandefinition" title="Permanent link">&para;</a></h5>
<p>我们来看下 BeanDefinition 的接口定义：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanDefinition</span> <span class="kd">extends</span> <span class="n">AttributeAccessor</span><span class="p">,</span> <span class="n">BeanMetadataElement</span> <span class="p">{</span>

   <span class="c1">// 我们可以看到，默认只提供 sington 和 prototype 两种，</span>
   <span class="c1">// 很多读者可能知道还有 request, session, globalSession, application, websocket 这几种，</span>
   <span class="c1">// 不过，它们属于基于 web 的扩展。</span>
   <span class="n">String</span> <span class="n">SCOPE_SINGLETON</span> <span class="o">=</span> <span class="n">ConfigurableBeanFactory</span><span class="p">.</span><span class="na">SCOPE_SINGLETON</span><span class="p">;</span>
   <span class="n">String</span> <span class="n">SCOPE_PROTOTYPE</span> <span class="o">=</span> <span class="n">ConfigurableBeanFactory</span><span class="p">.</span><span class="na">SCOPE_PROTOTYPE</span><span class="p">;</span>

   <span class="c1">// 比较不重要，直接跳过吧</span>
   <span class="kt">int</span> <span class="n">ROLE_APPLICATION</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">ROLE_SUPPORT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">ROLE_INFRASTRUCTURE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

   <span class="c1">// 设置父 Bean，这里涉及到 bean 继承，不是 java 继承。请参见附录的详细介绍</span>
   <span class="c1">// 一句话就是：继承父 Bean 的配置信息而已</span>
   <span class="kt">void</span> <span class="nf">setParentName</span><span class="p">(</span><span class="n">String</span> <span class="n">parentName</span><span class="p">);</span>

   <span class="c1">// 获取父 Bean</span>
   <span class="n">String</span> <span class="nf">getParentName</span><span class="p">();</span>

   <span class="c1">// 设置 Bean 的类名称，将来是要通过反射来生成实例的</span>
   <span class="kt">void</span> <span class="nf">setBeanClassName</span><span class="p">(</span><span class="n">String</span> <span class="n">beanClassName</span><span class="p">);</span>

   <span class="c1">// 获取 Bean 的类名称</span>
   <span class="n">String</span> <span class="nf">getBeanClassName</span><span class="p">();</span>

   <span class="c1">// 设置 bean 的 scope</span>
   <span class="nd">@Nullable</span>
   <span class="kt">void</span> <span class="nf">setScope</span><span class="p">(</span><span class="n">String</span> <span class="n">scope</span><span class="p">);</span>

   <span class="nd">@Nullable</span>
   <span class="n">String</span> <span class="nf">getScope</span><span class="p">();</span>

   <span class="c1">// 设置是否懒加载</span>
   <span class="kt">void</span> <span class="nf">setLazyInit</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">lazyInit</span><span class="p">);</span>

   <span class="kt">boolean</span> <span class="nf">isLazyInit</span><span class="p">();</span>

   <span class="c1">// 设置该 Bean 依赖的所有的 Bean，注意，这里的依赖不是指属性依赖(如 @Autowire 标记的)，</span>
   <span class="c1">// 是 depends-on=&quot;&quot; 属性设置的值。</span>
   <span class="kt">void</span> <span class="nf">setDependsOn</span><span class="p">(</span><span class="n">String</span><span class="p">...</span> <span class="n">dependsOn</span><span class="p">);</span>

   <span class="c1">// 返回该 Bean 的所有依赖</span>
   <span class="n">String</span><span class="o">[]</span> <span class="nf">getDependsOn</span><span class="p">();</span>

   <span class="c1">// 设置该 Bean 是否可以注入到其他 Bean 中，只对根据类型注入有效，</span>
   <span class="c1">// 如果根据名称注入，即使这边设置了 false，也是可以的</span>
   <span class="kt">void</span> <span class="nf">setAutowireCandidate</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">autowireCandidate</span><span class="p">);</span>

   <span class="c1">// 该 Bean 是否可以注入到其他 Bean 中</span>
   <span class="kt">boolean</span> <span class="nf">isAutowireCandidate</span><span class="p">();</span>

   <span class="c1">// 主要的。同一接口的多个实现，如果不指定名字的话，Spring 会优先选择设置 primary 为 true 的 bean</span>
   <span class="kt">void</span> <span class="nf">setPrimary</span><span class="p">(</span><span class="kt">boolean</span> <span class="n">primary</span><span class="p">);</span>

   <span class="c1">// 是否是 primary 的</span>
   <span class="kt">boolean</span> <span class="nf">isPrimary</span><span class="p">();</span>

   <span class="c1">// 如果该 Bean 采用工厂方法生成，指定工厂名称。对工厂不熟悉的读者，请参加附录</span>
   <span class="c1">// 一句话就是：有些实例不是用反射生成的，而是用工厂模式生成的</span>
   <span class="kt">void</span> <span class="nf">setFactoryBeanName</span><span class="p">(</span><span class="n">String</span> <span class="n">factoryBeanName</span><span class="p">);</span>
   <span class="c1">// 获取工厂名称</span>
   <span class="n">String</span> <span class="nf">getFactoryBeanName</span><span class="p">();</span>
   <span class="c1">// 指定工厂类中的 工厂方法名称</span>
   <span class="kt">void</span> <span class="nf">setFactoryMethodName</span><span class="p">(</span><span class="n">String</span> <span class="n">factoryMethodName</span><span class="p">);</span>
   <span class="c1">// 获取工厂类中的 工厂方法名称</span>
   <span class="n">String</span> <span class="nf">getFactoryMethodName</span><span class="p">();</span>

   <span class="c1">// 构造器参数</span>
   <span class="n">ConstructorArgumentValues</span> <span class="nf">getConstructorArgumentValues</span><span class="p">();</span>

   <span class="c1">// Bean 中的属性值，后面给 bean 注入属性值的时候会说到</span>
   <span class="n">MutablePropertyValues</span> <span class="nf">getPropertyValues</span><span class="p">();</span>

   <span class="c1">// 是否 singleton</span>
   <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="p">();</span>

   <span class="c1">// 是否 prototype</span>
   <span class="kt">boolean</span> <span class="nf">isPrototype</span><span class="p">();</span>

   <span class="c1">// 如果这个 Bean 是被设置为 abstract，那么不能实例化，</span>
   <span class="c1">// 常用于作为 父bean 用于继承，其实也很少用......</span>
   <span class="kt">boolean</span> <span class="nf">isAbstract</span><span class="p">();</span>

   <span class="kt">int</span> <span class="nf">getRole</span><span class="p">();</span>
   <span class="n">String</span> <span class="nf">getDescription</span><span class="p">();</span>
   <span class="n">String</span> <span class="nf">getResourceDescription</span><span class="p">();</span>
   <span class="n">BeanDefinition</span> <span class="nf">getOriginatingBeanDefinition</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>这个 BeanDefinition 其实已经包含很多的信息了，暂时不清楚所有的方法对应什么东西没关系，希望看完本文后读者可以彻底搞清楚里面的所有东西。</p>
<p>这里接口虽然那么多，但是没有类似 getInstance() 这种方法来获取我们定义的类的实例，真正的我们定义的类生成的实例到哪里去了呢？别着急，这个要很后面才能讲到。</p>
</blockquote>
<p>有了 BeanDefinition 的概念以后，我们再往下看 <code>refreshBeanFactory()</code> 方法中的剩余部分：</p>
<div class="highlight"><pre><span></span><code><span class="n">customizeBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
<span class="n">loadBeanDefinitions</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
</code></pre></div>
<h4 id="customizebeanfactory">customizeBeanFactory()<a class="headerlink" href="#customizebeanfactory" title="Permanent link">&para;</a></h4>
<p>customizeBeanFactory(beanFactory) 比较简单，就是配置是否允许 BeanDefinition 覆盖、是否允许循环引用。</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">customizeBeanFactory</span><span class="p">(</span><span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">allowBeanDefinitionOverriding</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 是否允许 Bean 定义覆盖</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">setAllowBeanDefinitionOverriding</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">allowBeanDefinitionOverriding</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">allowCircularReferences</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 是否允许 Bean 间的循环依赖</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">setAllowCircularReferences</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">allowCircularReferences</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>BeanDefinition 的覆盖问题可能会有开发者碰到这个坑，就是在配置文件中定义 bean 时使用了相同的 id 或 name，默认情况下，allowBeanDefinitionOverriding 属性为 null，如果在同一配置文件中重复了，会抛错，但是如果不是同一配置文件中，会发生覆盖。</p>
<p>循环引用也很好理解：A 依赖 B，而 B 依赖 A。或 A 依赖 B，B 依赖 C，而 C 依赖 A。</p>
<p>默认情况下，Spring 允许循环依赖，当然如果你在 A 的构造方法中依赖 B，在 B 的构造方法中依赖 A 是不行的。</p>
<p>至于这两个属性怎么配置？我在附录中进行了介绍，尤其对于覆盖问题，很多人都希望禁止出现 Bean 覆盖，可是 Spring 默认是不同文件的时候可以覆盖的。</p>
<p>之后的源码中还会出现这两个属性，先有个印象就可以了。</p>
<h4 id="loadbeandefinitions-bean">loadBeanDefinitions()：加载 Bean<a class="headerlink" href="#loadbeandefinitions-bean" title="Permanent link">&para;</a></h4>
<p>接下来是最重要的 <code>loadBeanDefinitions(beanFactory)</code> 方法了，这个方法将根据配置，加载各个 Bean，然后放到 BeanFactory 中。</p>
<p>读取配置的操作在 XmlBeanDefinitionReader 中，其负责加载配置、解析。</p>
<div class="highlight"><pre><span></span><code><span class="cm">/** 我们可以看到，此方法将通过一个 XmlBeanDefinitionReader 实例来加载各个 Bean。*/</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="p">(</span><span class="n">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="p">,</span> <span class="n">IOException</span> <span class="p">{</span>
   <span class="c1">// 给这个 BeanFactory 实例化一个 XmlBeanDefinitionReader</span>
   <span class="n">XmlBeanDefinitionReader</span> <span class="n">beanDefinitionReader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XmlBeanDefinitionReader</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

   <span class="c1">// Configure the bean definition reader with this context&#39;s</span>
   <span class="c1">// resource loading environment.</span>
   <span class="n">beanDefinitionReader</span><span class="p">.</span><span class="na">setEnvironment</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getEnvironment</span><span class="p">());</span>
   <span class="n">beanDefinitionReader</span><span class="p">.</span><span class="na">setResourceLoader</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
   <span class="n">beanDefinitionReader</span><span class="p">.</span><span class="na">setEntityResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">ResourceEntityResolver</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

   <span class="c1">// 初始化 BeanDefinitionReader，其实这个是提供给子类覆写的，</span>
   <span class="c1">// 我看了一下，没有类覆写这个方法，我们姑且当做不重要吧</span>
   <span class="n">initBeanDefinitionReader</span><span class="p">(</span><span class="n">beanDefinitionReader</span><span class="p">);</span>
   <span class="c1">// 重点来了，继续往下</span>
   <span class="n">loadBeanDefinitions</span><span class="p">(</span><span class="n">beanDefinitionReader</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>现在还在这个类中，接下来用刚刚初始化的 Reader 开始来加载 xml 配置，这块代码读者可以选择性跳过，不是很重要。也就是说，下面这个代码块，读者可以很轻松地略过。</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="p">(</span><span class="n">XmlBeanDefinitionReader</span> <span class="n">reader</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="p">,</span> <span class="n">IOException</span> <span class="p">{</span>
   <span class="n">Resource</span><span class="o">[]</span> <span class="n">configResources</span> <span class="o">=</span> <span class="n">getConfigResources</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">configResources</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 往下看</span>
      <span class="n">reader</span><span class="p">.</span><span class="na">loadBeanDefinitions</span><span class="p">(</span><span class="n">configResources</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">String</span><span class="o">[]</span> <span class="n">configLocations</span> <span class="o">=</span> <span class="n">getConfigLocations</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">configLocations</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 2</span>
      <span class="n">reader</span><span class="p">.</span><span class="na">loadBeanDefinitions</span><span class="p">(</span><span class="n">configLocations</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 上面虽然有两个分支，不过第二个分支很快通过解析路径转换为 Resource 以后也会进到这里</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="p">(</span><span class="n">Resource</span><span class="p">...</span> <span class="n">resources</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>
   <span class="n">Assert</span><span class="p">.</span><span class="na">notNull</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="s">&quot;Resource array must not be null&quot;</span><span class="p">);</span>
   <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="c1">// 注意这里是个 for 循环，也就是每个文件是一个 resource</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">Resource</span> <span class="n">resource</span> <span class="p">:</span> <span class="n">resources</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 继续往下看</span>
      <span class="n">counter</span> <span class="o">+=</span> <span class="n">loadBeanDefinitions</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="c1">// 最后返回 counter，表示总共加载了多少的 BeanDefinition</span>
   <span class="k">return</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// XmlBeanDefinitionReader 303</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="p">(</span><span class="n">Resource</span> <span class="n">resource</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">loadBeanDefinitions</span><span class="p">(</span><span class="k">new</span> <span class="n">EncodedResource</span><span class="p">(</span><span class="n">resource</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// XmlBeanDefinitionReader 314</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="p">(</span><span class="n">EncodedResource</span> <span class="n">encodedResource</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>
   <span class="n">Assert</span><span class="p">.</span><span class="na">notNull</span><span class="p">(</span><span class="n">encodedResource</span><span class="p">,</span> <span class="s">&quot;EncodedResource must not be null&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Loading XML bean definitions from &quot;</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="p">.</span><span class="na">getResource</span><span class="p">());</span>
   <span class="p">}</span>
   <span class="c1">// 用一个 ThreadLocal 来存放配置文件资源</span>
   <span class="n">Set</span><span class="o">&lt;</span><span class="n">EncodedResource</span><span class="o">&gt;</span> <span class="n">currentResources</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">currentResources</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">currentResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">EncodedResource</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">currentResources</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">currentResources</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">encodedResource</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanDefinitionStoreException</span><span class="p">(</span>
            <span class="s">&quot;Detected cyclic loading of &quot;</span> <span class="o">+</span> <span class="n">encodedResource</span> <span class="o">+</span> <span class="s">&quot; - check your import definitions!&quot;</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">encodedResource</span><span class="p">.</span><span class="na">getResource</span><span class="p">().</span><span class="na">getInputStream</span><span class="p">();</span>
      <span class="k">try</span> <span class="p">{</span>
         <span class="n">InputSource</span> <span class="n">inputSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputSource</span><span class="p">(</span><span class="n">inputStream</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">encodedResource</span><span class="p">.</span><span class="na">getEncoding</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">inputSource</span><span class="p">.</span><span class="na">setEncoding</span><span class="p">(</span><span class="n">encodedResource</span><span class="p">.</span><span class="na">getEncoding</span><span class="p">());</span>
         <span class="p">}</span>
         <span class="c1">// 核心部分是这里，往下面看</span>
         <span class="k">return</span> <span class="n">doLoadBeanDefinitions</span><span class="p">(</span><span class="n">inputSource</span><span class="p">,</span> <span class="n">encodedResource</span><span class="p">.</span><span class="na">getResource</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="k">finally</span> <span class="p">{</span>
         <span class="n">inputStream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanDefinitionStoreException</span><span class="p">(</span>
            <span class="s">&quot;IOException parsing XML document from &quot;</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="p">.</span><span class="na">getResource</span><span class="p">(),</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">finally</span> <span class="p">{</span>
      <span class="n">currentResources</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">encodedResource</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">currentResources</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 还在这个文件中，第 388 行</span>
<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doLoadBeanDefinitions</span><span class="p">(</span><span class="n">InputSource</span> <span class="n">inputSource</span><span class="p">,</span> <span class="n">Resource</span> <span class="n">resource</span><span class="p">)</span>
      <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// 这里就不看了，将 xml 文件转换为 Document 对象</span>
      <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">doLoadDocument</span><span class="p">(</span><span class="n">inputSource</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>
      <span class="c1">// 继续</span>
      <span class="k">return</span> <span class="n">registerBeanDefinitions</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(...</span>
<span class="p">}</span>

<span class="c1">// 还在这个文件中，第 505 行</span>
<span class="c1">// 返回值：返回从当前配置文件加载了多少数量的 Bean</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">registerBeanDefinitions</span><span class="p">(</span><span class="n">Document</span> <span class="n">doc</span><span class="p">,</span> <span class="n">Resource</span> <span class="n">resource</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>
   <span class="n">BeanDefinitionDocumentReader</span> <span class="n">documentReader</span> <span class="o">=</span> <span class="n">createBeanDefinitionDocumentReader</span><span class="p">();</span>
   <span class="kt">int</span> <span class="n">countBefore</span> <span class="o">=</span> <span class="n">getRegistry</span><span class="p">().</span><span class="na">getBeanDefinitionCount</span><span class="p">();</span>
   <span class="c1">// 这里</span>
   <span class="n">documentReader</span><span class="p">.</span><span class="na">registerBeanDefinitions</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">createReaderContext</span><span class="p">(</span><span class="n">resource</span><span class="p">));</span>
   <span class="k">return</span> <span class="n">getRegistry</span><span class="p">().</span><span class="na">getBeanDefinitionCount</span><span class="p">()</span> <span class="o">-</span> <span class="n">countBefore</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// DefaultBeanDefinitionDocumentReader.java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="p">(</span><span class="n">Document</span> <span class="n">doc</span><span class="p">,</span> <span class="n">XmlReaderContext</span> <span class="n">readerContext</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="na">readerContext</span> <span class="o">=</span> <span class="n">readerContext</span><span class="p">;</span>
   <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Loading bean definitions&quot;</span><span class="p">);</span>
   <span class="n">Element</span> <span class="n">root</span> <span class="o">=</span> <span class="n">doc</span><span class="p">.</span><span class="na">getDocumentElement</span><span class="p">();</span>
   <span class="c1">// 从 xml 根节点开始解析文件</span>
   <span class="n">doRegisterBeanDefinitions</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>经过漫长的链路，一个配置文件终于转换为一颗 DOM 树了，注意，这里指的是其中一个配置文件，不是所有的，读者可以看到上面有个 for 循环的。下面开始从根节点开始解析：</p>
<h4 id="doregisterbeandefinitions">doRegisterBeanDefinitions()<a class="headerlink" href="#doregisterbeandefinitions" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// DefaultBeanDefinitionDocumentReader.java</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doRegisterBeanDefinitions</span><span class="p">(</span><span class="n">Element</span> <span class="n">root</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// 我们看名字就知道，BeanDefinitionParserDelegate 必定是一个重要的类，它负责解析 Bean 定义，</span>
   <span class="c1">// 这里为什么要定义一个 parent? 看到后面就知道了，是递归问题，</span>
   <span class="c1">// 因为 &lt;beans /&gt; 内部是可以定义 &lt;beans /&gt; 的，所以这个方法的 root 其实不一定就是 xml 的根节点，也可以是嵌套在里面的 &lt;beans /&gt; 节点，从源码分析的角度，我们当做根节点就好了</span>
   <span class="n">BeanDefinitionParserDelegate</span> <span class="n">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">delegate</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">createDelegate</span><span class="p">(</span><span class="n">getReaderContext</span><span class="p">(),</span> <span class="n">root</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">delegate</span><span class="p">.</span><span class="na">isDefaultNamespace</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 这块说的是根节点 &lt;beans ... profile=&quot;dev&quot; /&gt; 中的 profile 是否是当前环境需要的，</span>
      <span class="c1">// 如果当前环境配置的 profile 不包含此 profile，那就直接 return 了，不对此 &lt;beans /&gt; 解析</span>
      <span class="c1">// 不熟悉 profile 为何物，不熟悉怎么配置 profile 读者的请移步附录区</span>
      <span class="n">String</span> <span class="n">profileSpec</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">PROFILE_ATTRIBUTE</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">profileSpec</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">String</span><span class="o">[]</span> <span class="n">specifiedProfiles</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="p">.</span><span class="na">tokenizeToStringArray</span><span class="p">(</span>
               <span class="n">profileSpec</span><span class="p">,</span> <span class="n">BeanDefinitionParserDelegate</span><span class="p">.</span><span class="na">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getReaderContext</span><span class="p">().</span><span class="na">getEnvironment</span><span class="p">().</span><span class="na">acceptsProfiles</span><span class="p">(</span><span class="n">specifiedProfiles</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isInfoEnabled</span><span class="p">())</span> <span class="p">{</span>
               <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> <span class="o">+</span> <span class="n">profileSpec</span> <span class="o">+</span>
                     <span class="s">&quot;] not matching: &quot;</span> <span class="o">+</span> <span class="n">getReaderContext</span><span class="p">().</span><span class="na">getResource</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">preProcessXml</span><span class="p">(</span><span class="n">root</span><span class="p">);</span> <span class="c1">// 钩子</span>
   <span class="c1">// 往下看</span>
   <span class="n">parseBeanDefinitions</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">delegate</span><span class="p">);</span>
   <span class="n">postProcessXml</span><span class="p">(</span><span class="n">root</span><span class="p">);</span> <span class="c1">// 钩子</span>

   <span class="k">this</span><span class="p">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><code>preProcessXml(root)</code> 和 <code>postProcessXml(root)</code> 是给子类用的钩子方法，鉴于没有被使用到，也不是我们的重点，我们直接跳过。</p>
<p>这里涉及到了 profile 的问题，对于不了解的读者，我在附录中对 profile 做了简单的解释，读者可以参考一下。接下来，看核心解析方法</p>
<h4 id="parsebeandefinitionsroot-thisdelegate">parseBeanDefinitions(root, this.delegate)<a class="headerlink" href="#parsebeandefinitionsroot-thisdelegate" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1">// default namespace 涉及到的就四个标签 &lt;import /&gt;、&lt;alias /&gt;、&lt;bean /&gt; 和 &lt;beans /&gt;，</span>
<span class="c1">// 其他的属于 custom 的</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">parseBeanDefinitions</span><span class="p">(</span><span class="n">Element</span> <span class="n">root</span><span class="p">,</span> <span class="n">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">delegate</span><span class="p">.</span><span class="na">isDefaultNamespace</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">NodeList</span> <span class="n">nl</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="na">getChildNodes</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="p">.</span><span class="na">getLength</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nl</span><span class="p">.</span><span class="na">item</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="n">Element</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Element</span> <span class="n">ele</span> <span class="o">=</span> <span class="p">(</span><span class="n">Element</span><span class="p">)</span> <span class="n">node</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">delegate</span><span class="p">.</span><span class="na">isDefaultNamespace</span><span class="p">(</span><span class="n">ele</span><span class="p">))</span> <span class="p">{</span>
               <span class="c1">// 解析 default namespace 下面的几个元素</span>
               <span class="n">parseDefaultElement</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">delegate</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// 解析其他 namespace 的元素</span>
               <span class="n">delegate</span><span class="p">.</span><span class="na">parseCustomElement</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="n">delegate</span><span class="p">.</span><span class="na">parseCustomElement</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>从上面的代码，我们可以看到，对于每个配置来说，分别进入到 <code>parseDefaultElement(ele, delegate);</code> 和 <code>delegate.parseCustomElement(ele);</code> 这两个分支了。</p>
<p><code>parseDefaultElement(ele, delegate)</code> 代表解析的节点是 <code>&lt;import /&gt;</code>、<code>&lt;alias /&gt;</code>、<code>&lt;bean /&gt;</code>、<code>&lt;beans /&gt;</code> 这几个。</p>
<blockquote>
<p>这里的四个标签之所以是 default 的，是因为它们是处于这个 namespace 下定义的：</p>
<p><a href="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</a></p>
<p>又到初学者科普时间，不熟悉 namespace 的读者请看下面贴出来的 xml，这里的第二行 <strong>xmlns</strong> 就是咯。</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">            http://www.springframework.org/schema/beans</span>
<span class="s">          http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>
       <span class="na">default-autowire=</span><span class="s">&quot;byName&quot;</span><span class="nt">&gt;</span>
</code></pre></div>
<p>而对于其他的标签，将进入到 <code>delegate.parseCustomElement(element)</code> 这个分支。如我们经常会使用到的 <code>&lt;mvc /&gt;</code>、<code>&lt;task /&gt;</code>、<code>&lt;context /&gt;</code>、<code>&lt;aop /&gt;</code>等。</p>
<p>这些属于扩展，如果需要使用上面这些 ”非 default“ 标签，那么上面的 xml 头部的地方也要引入相应的 namespace 和 .xsd 文件的路径，如下所示。同时代码中需要提供相应的 parser 来解析，如 MvcNamespaceHandler、TaskNamespaceHandler、ContextNamespaceHandler、AopNamespaceHandler 等。</p>
<p>假如读者想分析 <code>&lt;context:property-placeholder location="classpath:xx.properties" /&gt;</code> 的实现原理，就应该到 ContextNamespaceHandler 中找答案。</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
      <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
      <span class="na">xmlns:mvc=</span><span class="s">&quot;http://www.springframework.org/schema/mvc&quot;</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">           http://www.springframework.org/schema/beans </span>
<span class="s">           http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">           http://www.springframework.org/schema/context</span>
<span class="s">           http://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">           http://www.springframework.org/schema/mvc   </span>
<span class="s">           http://www.springframework.org/schema/mvc/spring-mvc.xsd  </span>
<span class="s">       &quot;</span>
      <span class="na">default-autowire=</span><span class="s">&quot;byName&quot;</span><span class="nt">&gt;</span>
</code></pre></div>
</blockquote>
<p>回过神来，看看处理 default 标签的方法：</p>
<div class="highlight"><pre><span></span><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseDefaultElement</span><span class="p">(</span><span class="n">Element</span> <span class="n">ele</span><span class="p">,</span> <span class="n">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">delegate</span><span class="p">.</span><span class="na">nodeNameEquals</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">IMPORT_ELEMENT</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 处理 &lt;import /&gt; 标签</span>
      <span class="n">importBeanDefinitionResource</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delegate</span><span class="p">.</span><span class="na">nodeNameEquals</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">ALIAS_ELEMENT</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 处理 &lt;alias /&gt; 标签定义</span>
      <span class="c1">// &lt;alias name=&quot;fromName&quot; alias=&quot;toName&quot;/&gt;</span>
      <span class="n">processAliasRegistration</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delegate</span><span class="p">.</span><span class="na">nodeNameEquals</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">BEAN_ELEMENT</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 处理 &lt;bean /&gt; 标签定义，这也算是我们的重点吧</span>
      <span class="n">processBeanDefinition</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">delegate</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">delegate</span><span class="p">.</span><span class="na">nodeNameEquals</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">NESTED_BEANS_ELEMENT</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// 如果碰到的是嵌套的 &lt;beans /&gt; 标签，需要递归</span>
      <span class="n">doRegisterBeanDefinitions</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>如果每个标签都说，那我不吐血，你们都要吐血了。我们挑我们的重点 <code>&lt;bean /&gt;</code> 标签出来说。</p>
<h4 id="processbeandefinition-bean">processBeanDefinition 解析 bean 标签<a class="headerlink" href="#processbeandefinition-bean" title="Permanent link">&para;</a></h4>
<p>下面是 processBeanDefinition 解析 <code>&lt;bean /&gt;</code> 标签：</p>
<p>// DefaultBeanDefinitionDocumentReader.java</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processBeanDefinition</span><span class="p">(</span><span class="n">Element</span> <span class="n">ele</span><span class="p">,</span> <span class="n">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// 将 &lt;bean /&gt; 节点中的信息提取出来，然后封装到一个 BeanDefinitionHolder 中，细节往下看</span>
   <span class="n">BeanDefinitionHolder</span> <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="p">.</span><span class="na">parseBeanDefinitionElement</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>

   <span class="c1">// 下面的几行先不要看，跳过先，跳过先，跳过先，后面会继续说的</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">bdHolder</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="p">.</span><span class="na">decorateBeanDefinitionIfRequired</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bdHolder</span><span class="p">);</span>
      <span class="k">try</span> <span class="p">{</span>
         <span class="c1">// Register the final decorated instance.</span>
         <span class="n">BeanDefinitionReaderUtils</span><span class="p">.</span><span class="na">registerBeanDefinition</span><span class="p">(</span><span class="n">bdHolder</span><span class="p">,</span> <span class="n">getReaderContext</span><span class="p">().</span><span class="na">getRegistry</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="n">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">getReaderContext</span><span class="p">().</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Failed to register bean definition with name &#39;&quot;</span> <span class="o">+</span>
               <span class="n">bdHolder</span><span class="p">.</span><span class="na">getBeanName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">ele</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// Send registration event.</span>
      <span class="n">getReaderContext</span><span class="p">().</span><span class="na">fireComponentRegistered</span><span class="p">(</span><span class="k">new</span> <span class="n">BeanComponentDefinition</span><span class="p">(</span><span class="n">bdHolder</span><span class="p">));</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>继续往下看怎么解析之前，我们先看下 <code>&lt;bean /&gt;</code> 标签中可以定义哪些属性：</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>类的全限定名</td>
</tr>
<tr>
<td>name</td>
<td>可指定 id、name(用逗号、分号、空格分隔)</td>
</tr>
<tr>
<td>scope</td>
<td>作用域</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>指定构造参数</td>
</tr>
<tr>
<td>properties</td>
<td>设置属性的值</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(默认值)、byName、byType、 constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>是否懒加载(如果被非懒加载的bean依赖了那么其实也就不能懒加载了)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean 属性设置完成后，会调用这个方法</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean 销毁后的回调方法</td>
</tr>
</tbody>
</table>
<p>上面表格中的内容我想大家都非常熟悉吧，如果不熟悉，那就是你不够了解 Spring 的配置了。</p>
<p>简单地说就是像下面这样子：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exampleBean&quot;</span> <span class="na">name=</span><span class="s">&quot;name1, name2, name3&quot;</span> <span class="na">class=</span><span class="s">&quot;com.javadoop.ExampleBean&quot;</span>
      <span class="na">scope=</span><span class="s">&quot;singleton&quot;</span> <span class="na">lazy-init=</span><span class="s">&quot;true&quot;</span> <span class="na">init-method=</span><span class="s">&quot;init&quot;</span> <span class="na">destroy-method=</span><span class="s">&quot;cleanup&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 可以用下面三种形式指定构造参数 --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">type=</span><span class="s">&quot;int&quot;</span> <span class="na">value=</span><span class="s">&quot;7500000&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">&quot;years&quot;</span> <span class="na">value=</span><span class="s">&quot;7500000&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">value=</span><span class="s">&quot;7500000&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- property 的几种情况 --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;beanOne&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;anotherExampleBean&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;beanTwo&quot;</span> <span class="na">ref=</span><span class="s">&quot;yetAnotherBean&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;integerProperty&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div>
<p>当然，除了上面举例出来的这些，还有 factory-bean、factory-method、<code>&lt;lockup-method /&gt;</code>、<code>&lt;replaced-method /&gt;</code>、<code>&lt;meta /&gt;</code>、<code>&lt;qualifier /&gt;</code> 这几个，大家是不是熟悉呢？自己检验一下自己对 Spring 中 bean 的了解程度。</p>
<p>有了以上这些知识以后，我们再继续往里看怎么解析 bean 元素，是怎么转换到 BeanDefinitionHolder 的。</p>
<p>// BeanDefinitionParserDelegate.java</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="n">BeanDefinitionHolder</span> <span class="nf">parseBeanDefinitionElement</span><span class="p">(</span><span class="n">Element</span> <span class="n">ele</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">parseBeanDefinitionElement</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="n">BeanDefinitionHolder</span> <span class="nf">parseBeanDefinitionElement</span><span class="p">(</span><span class="n">Element</span> <span class="n">ele</span><span class="p">,</span> <span class="n">BeanDefinition</span> <span class="n">containingBean</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ele</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">ID_ATTRIBUTE</span><span class="p">);</span>
   <span class="n">String</span> <span class="n">nameAttr</span> <span class="o">=</span> <span class="n">ele</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">NAME_ATTRIBUTE</span><span class="p">);</span>

   <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">aliases</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>

   <span class="c1">// 将 name 属性的定义按照 “逗号、分号、空格” 切分，形成一个 别名列表数组，</span>
   <span class="c1">// 当然，如果你不定义 name 属性的话，就是空的了</span>
   <span class="c1">// 我在附录中简单介绍了一下 id 和 name 的配置，大家可以看一眼，有个20秒就可以了</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasLength</span><span class="p">(</span><span class="n">nameAttr</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">nameArr</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="p">.</span><span class="na">tokenizeToStringArray</span><span class="p">(</span><span class="n">nameAttr</span><span class="p">,</span> <span class="n">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="p">);</span>
      <span class="n">aliases</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">nameArr</span><span class="p">));</span>
   <span class="p">}</span>

   <span class="n">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
   <span class="c1">// 如果没有指定id, 那么用别名列表的第一个名字作为beanName</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">beanName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aliases</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">beanName</span> <span class="o">=</span> <span class="n">aliases</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
         <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;No XML &#39;id&#39; specified - using &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
               <span class="s">&quot;&#39; as bean name and &quot;</span> <span class="o">+</span> <span class="n">aliases</span> <span class="o">+</span> <span class="s">&quot; as aliases&quot;</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">containingBean</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">checkNameUniqueness</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">aliases</span><span class="p">,</span> <span class="n">ele</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// 根据 &lt;bean ...&gt;...&lt;/bean&gt; 中的配置创建 BeanDefinition，然后把配置中的信息都设置到实例中,</span>
   <span class="c1">// 细节后面细说，先知道下面这行结束后，一个 BeanDefinition 实例就出来了。</span>
   <span class="n">AbstractBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">parseBeanDefinitionElement</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">containingBean</span><span class="p">);</span>

   <span class="c1">// 到这里，整个 &lt;bean /&gt; 标签就算解析结束了，一个 BeanDefinition 就形成了。</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">beanDefinition</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 如果都没有设置 id 和 name，那么此时的 beanName 就会为 null，进入下面这块代码产生</span>
      <span class="c1">// 如果读者不感兴趣的话，我觉得不需要关心这块代码，对本文源码分析来说，这些东西不重要</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">containingBean</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span><span class="c1">// 按照我们的思路，这里 containingBean 是 null 的</span>
               <span class="n">beanName</span> <span class="o">=</span> <span class="n">BeanDefinitionReaderUtils</span><span class="p">.</span><span class="na">generateBeanName</span><span class="p">(</span>
                     <span class="n">beanDefinition</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">readerContext</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// 如果我们不定义 id 和 name，那么我们引言里的那个例子：</span>
               <span class="c1">//   1. beanName 为：com.javadoop.example.MessageServiceImpl#0</span>
               <span class="c1">//   2. beanClassName 为：com.javadoop.example.MessageServiceImpl</span>

               <span class="n">beanName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">readerContext</span><span class="p">.</span><span class="na">generateBeanName</span><span class="p">(</span><span class="n">beanDefinition</span><span class="p">);</span>

               <span class="n">String</span> <span class="n">beanClassName</span> <span class="o">=</span> <span class="n">beanDefinition</span><span class="p">.</span><span class="na">getBeanClassName</span><span class="p">();</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">beanClassName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                     <span class="n">beanName</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="n">beanClassName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="p">.</span><span class="na">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">beanClassName</span><span class="p">.</span><span class="na">length</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                     <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="na">readerContext</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">().</span><span class="na">isBeanNameInUse</span><span class="p">(</span><span class="n">beanClassName</span><span class="p">))</span> <span class="p">{</span>
                  <span class="c1">// 把 beanClassName 设置为 Bean 的别名</span>
                  <span class="n">aliases</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanClassName</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
               <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Neither XML &#39;id&#39; nor &#39;name&#39; specified - &quot;</span> <span class="o">+</span>
                     <span class="s">&quot;using generated bean name [&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">error</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span> <span class="n">ele</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">aliasesArray</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="p">.</span><span class="na">toStringArray</span><span class="p">(</span><span class="n">aliases</span><span class="p">);</span>
      <span class="c1">// 返回 BeanDefinitionHolder</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">BeanDefinitionHolder</span><span class="p">(</span><span class="n">beanDefinition</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">aliasesArray</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然后，我们再看看怎么根据配置创建 BeanDefinition 实例的：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="n">AbstractBeanDefinition</span> <span class="nf">parseBeanDefinitionElement</span><span class="p">(</span>
      <span class="n">Element</span> <span class="n">ele</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">BeanDefinition</span> <span class="n">containingBean</span><span class="p">)</span> <span class="p">{</span>

   <span class="k">this</span><span class="p">.</span><span class="na">parseState</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="k">new</span> <span class="n">BeanEntry</span><span class="p">(</span><span class="n">beanName</span><span class="p">));</span>

   <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">ele</span><span class="p">.</span><span class="na">hasAttribute</span><span class="p">(</span><span class="n">CLASS_ATTRIBUTE</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">className</span> <span class="o">=</span> <span class="n">ele</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">CLASS_ATTRIBUTE</span><span class="p">).</span><span class="na">trim</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="k">try</span> <span class="p">{</span>
      <span class="n">String</span> <span class="n">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ele</span><span class="p">.</span><span class="na">hasAttribute</span><span class="p">(</span><span class="n">PARENT_ATTRIBUTE</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">ele</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">PARENT_ATTRIBUTE</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// 创建 BeanDefinition，然后设置类信息而已，很简单，就不贴代码了</span>
      <span class="n">AbstractBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">createBeanDefinition</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>

      <span class="c1">// 设置 BeanDefinition 的一堆属性，这些属性定义在 AbstractBeanDefinition 中</span>
      <span class="n">parseBeanDefinitionAttributes</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">containingBean</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
      <span class="n">bd</span><span class="p">.</span><span class="na">setDescription</span><span class="p">(</span><span class="n">DomUtils</span><span class="p">.</span><span class="na">getChildElementValueByTagName</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">DESCRIPTION_ELEMENT</span><span class="p">));</span>

      <span class="cm">/**</span>
<span class="cm">       * 下面的一堆是解析 &lt;bean&gt;......&lt;/bean&gt; 内部的子元素，</span>
<span class="cm">       * 解析出来以后的信息都放到 bd 的属性中</span>
<span class="cm">       */</span>

      <span class="c1">// 解析 &lt;meta /&gt;</span>
      <span class="n">parseMetaElements</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
      <span class="c1">// 解析 &lt;lookup-method /&gt;</span>
      <span class="n">parseLookupOverrideSubElements</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="na">getMethodOverrides</span><span class="p">());</span>
      <span class="c1">// 解析 &lt;replaced-method /&gt;</span>
      <span class="n">parseReplacedMethodSubElements</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bd</span><span class="p">.</span><span class="na">getMethodOverrides</span><span class="p">());</span>
    <span class="c1">// 解析 &lt;constructor-arg /&gt;</span>
      <span class="n">parseConstructorArgElements</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
      <span class="c1">// 解析 &lt;property /&gt;</span>
      <span class="n">parsePropertyElements</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
      <span class="c1">// 解析 &lt;qualifier /&gt;</span>
      <span class="n">parseQualifierElements</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>

      <span class="n">bd</span><span class="p">.</span><span class="na">setResource</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">readerContext</span><span class="p">.</span><span class="na">getResource</span><span class="p">());</span>
      <span class="n">bd</span><span class="p">.</span><span class="na">setSource</span><span class="p">(</span><span class="n">extractSource</span><span class="p">(</span><span class="n">ele</span><span class="p">));</span>

      <span class="k">return</span> <span class="n">bd</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">ClassNotFoundException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error</span><span class="p">(</span><span class="s">&quot;Bean class [&quot;</span> <span class="o">+</span> <span class="n">className</span> <span class="o">+</span> <span class="s">&quot;] not found&quot;</span><span class="p">,</span> <span class="n">ele</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">NoClassDefFoundError</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error</span><span class="p">(</span><span class="s">&quot;Class that bean class [&quot;</span> <span class="o">+</span> <span class="n">className</span> <span class="o">+</span> <span class="s">&quot;] depends on not found&quot;</span><span class="p">,</span> <span class="n">ele</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error</span><span class="p">(</span><span class="s">&quot;Unexpected failure during bean definition parsing&quot;</span><span class="p">,</span> <span class="n">ele</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">finally</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">parseState</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>到这里，我们已经完成了根据 <code>&lt;bean /&gt;</code> 配置创建了一个 BeanDefinitionHolder 实例。注意，是一个。</p>
<p>我们回到解析 <code>&lt;bean /&gt;</code> 的入口方法:</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processBeanDefinition</span><span class="p">(</span><span class="n">Element</span> <span class="n">ele</span><span class="p">,</span> <span class="n">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// 将 &lt;bean /&gt; 节点转换为 BeanDefinitionHolder，就是上面说的一堆</span>
   <span class="n">BeanDefinitionHolder</span> <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="p">.</span><span class="na">parseBeanDefinitionElement</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">bdHolder</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 如果有自定义属性的话，进行相应的解析，先忽略</span>
      <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="p">.</span><span class="na">decorateBeanDefinitionIfRequired</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span> <span class="n">bdHolder</span><span class="p">);</span>
      <span class="k">try</span> <span class="p">{</span>
         <span class="c1">// 我们把这步叫做 注册Bean 吧</span>
         <span class="n">BeanDefinitionReaderUtils</span><span class="p">.</span><span class="na">registerBeanDefinition</span><span class="p">(</span><span class="n">bdHolder</span><span class="p">,</span> <span class="n">getReaderContext</span><span class="p">().</span><span class="na">getRegistry</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="n">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">getReaderContext</span><span class="p">().</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Failed to register bean definition with name &#39;&quot;</span> <span class="o">+</span>
               <span class="n">bdHolder</span><span class="p">.</span><span class="na">getBeanName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">ele</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// 注册完成后，发送事件，本文不展开说这个</span>
      <span class="n">getReaderContext</span><span class="p">().</span><span class="na">fireComponentRegistered</span><span class="p">(</span><span class="k">new</span> <span class="n">BeanComponentDefinition</span><span class="p">(</span><span class="n">bdHolder</span><span class="p">));</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>大家再仔细看一下这块吧，我们后面就不回来说这个了。这里已经根据一个 <code>&lt;bean /&gt;</code> 标签产生了一个 BeanDefinitionHolder 的实例，这个实例里面也就是一个 BeanDefinition 的实例和它的 beanName、aliases 这三个信息，注意，我们的关注点始终在 BeanDefinition 上：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanDefinitionHolder</span> <span class="kd">implements</span> <span class="n">BeanMetadataElement</span> <span class="p">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">BeanDefinition</span> <span class="n">beanDefinition</span><span class="p">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">aliases</span><span class="p">;</span>
<span class="p">...</span>
</code></pre></div>
<p>然后我们准备注册这个 BeanDefinition，最后，把这个注册事件发送出去。</p>
<p>下面，我们开始说说注册 Bean 吧。</p>
<h3 id="bean_1">注册 Bean<a class="headerlink" href="#bean_1" title="Permanent link">&para;</a></h3>
<p>// BeanDefinitionReaderUtils.java</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="p">(</span>
      <span class="n">BeanDefinitionHolder</span> <span class="n">definitionHolder</span><span class="p">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="p">)</span>
      <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>

   <span class="n">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">definitionHolder</span><span class="p">.</span><span class="na">getBeanName</span><span class="p">();</span>
   <span class="c1">// 注册这个 Bean</span>
   <span class="n">registry</span><span class="p">.</span><span class="na">registerBeanDefinition</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">definitionHolder</span><span class="p">.</span><span class="na">getBeanDefinition</span><span class="p">());</span>

   <span class="c1">// 如果还有别名的话，也要根据别名全部注册一遍，不然根据别名就会找不到 Bean 了</span>
   <span class="n">String</span><span class="o">[]</span> <span class="n">aliases</span> <span class="o">=</span> <span class="n">definitionHolder</span><span class="p">.</span><span class="na">getAliases</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">aliases</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">alias</span> <span class="p">:</span> <span class="n">aliases</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// alias -&gt; beanName 保存它们的别名信息，这个很简单，用一个 map 保存一下就可以了，</span>
         <span class="c1">// 获取的时候，会先将 alias 转换为 beanName，然后再查找</span>
         <span class="n">registry</span><span class="p">.</span><span class="na">registerAlias</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">alias</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>别名注册的放一边，毕竟它很简单，我们看看怎么注册 Bean。</p>
<p>// DefaultListableBeanFactory.java 793</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="p">(</span><span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">BeanDefinition</span> <span class="n">beanDefinition</span><span class="p">)</span>
      <span class="kd">throws</span> <span class="n">BeanDefinitionStoreException</span> <span class="p">{</span>

   <span class="n">Assert</span><span class="p">.</span><span class="na">hasText</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="s">&quot;Bean name must not be empty&quot;</span><span class="p">);</span>
   <span class="n">Assert</span><span class="p">.</span><span class="na">notNull</span><span class="p">(</span><span class="n">beanDefinition</span><span class="p">,</span> <span class="s">&quot;BeanDefinition must not be null&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">beanDefinition</span> <span class="k">instanceof</span> <span class="n">AbstractBeanDefinition</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
         <span class="p">((</span><span class="n">AbstractBeanDefinition</span><span class="p">)</span> <span class="n">beanDefinition</span><span class="p">).</span><span class="na">validate</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="n">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanDefinitionStoreException</span><span class="p">(...);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// old? 还记得 “允许 bean 覆盖” 这个配置吗？allowBeanDefinitionOverriding</span>
   <span class="n">BeanDefinition</span> <span class="n">oldBeanDefinition</span><span class="p">;</span>

   <span class="c1">// 之后会看到，所有的 Bean 注册后会放入这个 beanDefinitionMap 中</span>
   <span class="n">oldBeanDefinition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>

   <span class="c1">// 处理重复名称的 Bean 定义的情况</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">oldBeanDefinition</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isAllowBeanDefinitionOverriding</span><span class="p">())</span> <span class="p">{</span>
         <span class="c1">// 如果不允许覆盖的话，抛异常</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanDefinitionStoreException</span><span class="p">(</span><span class="n">beanDefinition</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">()...</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oldBeanDefinition</span><span class="p">.</span><span class="na">getRole</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">beanDefinition</span><span class="p">.</span><span class="na">getRole</span><span class="p">())</span> <span class="p">{</span>
         <span class="c1">// log...用框架定义的 Bean 覆盖用户自定义的 Bean </span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beanDefinition</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">oldBeanDefinition</span><span class="p">))</span> <span class="p">{</span>
         <span class="c1">// log...用新的 Bean 覆盖旧的 Bean</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// log...用同等的 Bean 覆盖旧的 Bean，这里指的是 equals 方法返回 true 的 Bean</span>
      <span class="p">}</span>
      <span class="c1">// 覆盖</span>
      <span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">beanDefinition</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 判断是否已经有其他的 Bean 开始初始化了.</span>
      <span class="c1">// 注意，&quot;注册Bean&quot; 这个动作结束，Bean 依然还没有初始化，我们后面会有大篇幅说初始化过程，</span>
      <span class="c1">// 在 Spring 容器启动的最后，会 预初始化 所有的 singleton beans</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">hasBeanCreationStarted</span><span class="p">())</span> <span class="p">{</span>
         <span class="c1">// Cannot modify startup-time collection elements anymore (for stable iteration)</span>
         <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">beanDefinition</span><span class="p">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">updatedDefinitions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionNames</span><span class="p">.</span><span class="na">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">updatedDefinitions</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionNames</span><span class="p">);</span>
            <span class="n">updatedDefinitions</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionNames</span> <span class="o">=</span> <span class="n">updatedDefinitions</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">manualSingletonNames</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
               <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">updatedSingletons</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">manualSingletonNames</span><span class="p">);</span>
               <span class="n">updatedSingletons</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
               <span class="k">this</span><span class="p">.</span><span class="na">manualSingletonNames</span> <span class="o">=</span> <span class="n">updatedSingletons</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// 最正常的应该是进到这个分支。</span>

         <span class="c1">// 将 BeanDefinition 放到这个 map 中，这个 map 保存了所有的 BeanDefinition</span>
         <span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">beanDefinition</span><span class="p">);</span>
         <span class="c1">// 这是个 ArrayList，所以会按照 bean 配置的顺序保存每一个注册的 Bean 的名字</span>
         <span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionNames</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
         <span class="c1">// 这是个 LinkedHashSet，代表的是手动注册的 singleton bean，</span>
         <span class="c1">// 注意这里是 remove 方法，到这里的 Bean 当然不是手动注册的</span>
         <span class="c1">// 手动指的是通过调用以下方法注册的 bean ：</span>
         <span class="c1">//     registerSingleton(String beanName, Object singletonObject)</span>
         <span class="c1">// 这不是重点，解释只是为了不让大家疑惑。Spring 会在后面&quot;手动&quot;注册一些 Bean，</span>
         <span class="c1">// 如 &quot;environment&quot;、&quot;systemProperties&quot; 等 bean，我们自己也可以在运行时注册 Bean 到容器中的</span>
         <span class="k">this</span><span class="p">.</span><span class="na">manualSingletonNames</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// 这个不重要，在预初始化的时候会用到，不必管它。</span>
      <span class="k">this</span><span class="p">.</span><span class="na">frozenBeanDefinitionNames</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">oldBeanDefinition</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">containsSingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">resetBeanDefinition</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>总结一下，到这里已经初始化了 Bean 容器，<code>&lt;bean /&gt;</code> 配置也相应的转换为了一个个 BeanDefinition，然后注册了各个 BeanDefinition 到注册中心，并且发送了注册事件。</p>
<blockquote>
<p>到这里是一个分水岭，前面的内容都还算比较简单，大家要清楚地知道前面都做了哪些事情。</p>
</blockquote>
<h3 id="bean_2">Bean 容器实例化完成后<a class="headerlink" href="#bean_2" title="Permanent link">&para;</a></h3>
<p>说到这里，我们回到 refresh() 方法，我重新贴了一遍代码，看看我们说到哪了。是的，我们才说完 <code>obtainFreshBeanFactory()</code> 方法。</p>
<p>考虑到篇幅，这里开始大幅缩减掉没必要详细介绍的部分，大家直接看下面的代码中的注释就好了。</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span><span class="p">,</span> <span class="n">IllegalStateException</span> <span class="p">{</span>
   <span class="c1">// 来个锁，不然 refresh() 还没结束，你又来个启动或销毁容器的操作，那不就乱套了嘛</span>
   <span class="kd">synchronized</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">startupShutdownMonitor</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// 准备工作，记录下容器的启动时间、标记“已启动”状态、处理配置文件中的占位符</span>
      <span class="n">prepareRefresh</span><span class="p">();</span>

      <span class="c1">// 这步比较关键，这步完成后，配置文件就会解析成一个个 Bean 定义，注册到 BeanFactory 中，</span>
      <span class="c1">// 当然，这里说的 Bean 还没有初始化，只是配置信息都提取出来了，</span>
      <span class="c1">// 注册也只是将这些信息都保存到了注册中心(说到底核心是一个 beanName-&gt; beanDefinition 的 map)</span>
      <span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="p">();</span>

      <span class="c1">// 设置 BeanFactory 的类加载器，添加几个 BeanPostProcessor，手动注册几个特殊的 bean</span>
      <span class="c1">// 这块待会会展开说</span>
      <span class="n">prepareBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

      <span class="k">try</span> <span class="p">{</span>
         <span class="c1">// 【这里需要知道 BeanFactoryPostProcessor 这个知识点，Bean 如果实现了此接口，</span>
         <span class="c1">// 那么在容器初始化以后，Spring 会负责调用里面的 postProcessBeanFactory 方法。】</span>

         <span class="c1">// 这里是提供给子类的扩展点，到这里的时候，所有的 Bean 都加载、注册完成了，但是都还没有初始化</span>
         <span class="c1">// 具体的子类可以在这步的时候添加一些特殊的 BeanFactoryPostProcessor 的实现类或做点什么事</span>
         <span class="n">postProcessBeanFactory</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
         <span class="c1">// 调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 回调方法</span>
         <span class="n">invokeBeanFactoryPostProcessors</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>          



         <span class="c1">// 注册 BeanPostProcessor 的实现类，注意看和 BeanFactoryPostProcessor 的区别</span>
         <span class="c1">// 此接口两个方法: postProcessBeforeInitialization 和 postProcessAfterInitialization</span>
         <span class="c1">// 两个方法分别在 Bean 初始化之前和初始化之后得到执行。这里仅仅是注册，之后会看到回调这两方法的时机</span>
         <span class="n">registerBeanPostProcessors</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

         <span class="c1">// 初始化当前 ApplicationContext 的 MessageSource，国际化这里就不展开说了，不然没完没了了</span>
         <span class="n">initMessageSource</span><span class="p">();</span>

         <span class="c1">// 初始化当前 ApplicationContext 的事件广播器，这里也不展开了</span>
         <span class="n">initApplicationEventMulticaster</span><span class="p">();</span>

         <span class="c1">// 从方法名就可以知道，典型的模板方法(钩子方法)，不展开说</span>
         <span class="c1">// 具体的子类可以在这里初始化一些特殊的 Bean（在初始化 singleton beans 之前）</span>
         <span class="n">onRefresh</span><span class="p">();</span>

         <span class="c1">// 注册事件监听器，监听器需要实现 ApplicationListener 接口。这也不是我们的重点，过</span>
         <span class="n">registerListeners</span><span class="p">();</span>

         <span class="c1">// 重点，重点，重点</span>
         <span class="c1">// 初始化所有的 singleton beans</span>
         <span class="c1">//（lazy-init 的除外）</span>
         <span class="n">finishBeanFactoryInitialization</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>

         <span class="c1">// 最后，广播事件，ApplicationContext 初始化完成，不展开</span>
         <span class="n">finishRefresh</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">catch</span> <span class="p">(</span><span class="n">BeansException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isWarnEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">logger</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Exception encountered during context initialization - &quot;</span> <span class="o">+</span>
                  <span class="s">&quot;cancelling refresh attempt: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="p">);</span>
         <span class="p">}</span>

         <span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="c1">// 销毁已经初始化的 singleton 的 Beans，以免有些 bean 会一直占用资源</span>
         <span class="n">destroyBeans</span><span class="p">();</span>

         <span class="c1">// Reset &#39;active&#39; flag.</span>
         <span class="n">cancelRefresh</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>

         <span class="c1">// 把异常往外抛</span>
         <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">finally</span> <span class="p">{</span>
         <span class="c1">// Reset common introspection caches in Spring&#39;s core, since we</span>
         <span class="c1">// might not ever need metadata for singleton beans anymore...</span>
         <span class="n">resetCommonCaches</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="bean-preparebeanfactory">准备 Bean 容器: prepareBeanFactory<a class="headerlink" href="#bean-preparebeanfactory" title="Permanent link">&para;</a></h3>
<p>之前我们说过，Spring 把我们在 xml 配置的 bean 都注册以后，会"手动"注册一些特殊的 bean。</p>
<p>这里简单介绍下 <code>prepareBeanFactory(factory)</code> 方法：</p>
<h3 id="preparebeanfactoryfactory">prepareBeanFactory(factory)<a class="headerlink" href="#preparebeanfactoryfactory" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Configure the factory&#39;s standard context characteristics,</span>
<span class="cm"> * such as the context&#39;s ClassLoader and post-processors.</span>
<span class="cm"> * @param beanFactory the BeanFactory to configure</span>
<span class="cm"> */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareBeanFactory</span><span class="p">(</span><span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// 设置 BeanFactory 的类加载器，我们知道 BeanFactory 需要加载类，也就需要类加载器，</span>
   <span class="c1">// 这里设置为加载当前 ApplicationContext 类的类加载器</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">setBeanClassLoader</span><span class="p">(</span><span class="n">getClassLoader</span><span class="p">());</span>

   <span class="c1">// 设置 BeanExpressionResolver</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">setBeanExpressionResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">StandardBeanExpressionResolver</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">getBeanClassLoader</span><span class="p">()));</span>
   <span class="c1">// </span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">addPropertyEditorRegistrar</span><span class="p">(</span><span class="k">new</span> <span class="n">ResourceEditorRegistrar</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">getEnvironment</span><span class="p">()));</span>

   <span class="c1">// 添加一个 BeanPostProcessor，这个 processor 比较简单：</span>
   <span class="c1">// 实现了 Aware 接口的 beans 在初始化的时候，这个 processor 负责回调，</span>
   <span class="c1">// 这个我们很常用，如我们会为了获取 ApplicationContext 而 implement ApplicationContextAware</span>
   <span class="c1">// 注意：它不仅仅回调 ApplicationContextAware，</span>
   <span class="c1">//   还会负责回调 EnvironmentAware、ResourceLoaderAware 等，看下源码就清楚了</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">addBeanPostProcessor</span><span class="p">(</span><span class="k">new</span> <span class="n">ApplicationContextAwareProcessor</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

   <span class="c1">// 下面几行的意思就是，如果某个 bean 依赖于以下几个接口的实现类，在自动装配的时候忽略它们，</span>
   <span class="c1">// Spring 会通过其他方式来处理这些依赖。</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">ignoreDependencyInterface</span><span class="p">(</span><span class="n">EnvironmentAware</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">ignoreDependencyInterface</span><span class="p">(</span><span class="n">EmbeddedValueResolverAware</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">ignoreDependencyInterface</span><span class="p">(</span><span class="n">ResourceLoaderAware</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">ignoreDependencyInterface</span><span class="p">(</span><span class="n">ApplicationEventPublisherAware</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">ignoreDependencyInterface</span><span class="p">(</span><span class="n">MessageSourceAware</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">ignoreDependencyInterface</span><span class="p">(</span><span class="n">ApplicationContextAware</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

   <span class="cm">/**</span>
<span class="cm">    * 下面几行就是为特殊的几个 bean 赋值，如果有 bean 依赖了以下几个，会注入这边相应的值，</span>
<span class="cm">    * 之前我们说过，&quot;当前 ApplicationContext 持有一个 BeanFactory&quot;，这里解释了第一行</span>
<span class="cm">    * ApplicationContext 还继承了 ResourceLoader、ApplicationEventPublisher、MessageSource</span>
<span class="cm">    * 所以对于这几个依赖，可以赋值为 this，注意 this 是一个 ApplicationContext</span>
<span class="cm">    * 那这里怎么没看到为 MessageSource 赋值呢？那是因为 MessageSource 被注册成为了一个普通的 bean</span>
<span class="cm">    */</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">registerResolvableDependency</span><span class="p">(</span><span class="n">BeanFactory</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">beanFactory</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">registerResolvableDependency</span><span class="p">(</span><span class="n">ResourceLoader</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">registerResolvableDependency</span><span class="p">(</span><span class="n">ApplicationEventPublisher</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">registerResolvableDependency</span><span class="p">(</span><span class="n">ApplicationContext</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

   <span class="c1">// 这个 BeanPostProcessor 也很简单，在 bean 实例化后，如果是 ApplicationListener 的子类，</span>
   <span class="c1">// 那么将其添加到 listener 列表中，可以理解成：注册 事件监听器</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">addBeanPostProcessor</span><span class="p">(</span><span class="k">new</span> <span class="n">ApplicationListenerDetector</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

   <span class="c1">// 这里涉及到特殊的 bean，名为：loadTimeWeaver，这不是我们的重点，忽略它</span>
   <span class="c1">// tips: ltw 是 AspectJ 的概念，指的是在运行期进行织入，这个和 Spring AOP 不一样，</span>
   <span class="c1">//    感兴趣的读者请参考我写的关于 AspectJ 的另一篇文章 https://www.javadoop.com/post/aspectj</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">containsBean</span><span class="p">(</span><span class="n">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">addBeanPostProcessor</span><span class="p">(</span><span class="k">new</span> <span class="n">LoadTimeWeaverAwareProcessor</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">));</span>
      <span class="c1">// Set a temporary ClassLoader for type matching.</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">setTempClassLoader</span><span class="p">(</span><span class="k">new</span> <span class="n">ContextTypeMatchClassLoader</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">getBeanClassLoader</span><span class="p">()));</span>
   <span class="p">}</span>

   <span class="cm">/**</span>
<span class="cm">    * 从下面几行代码我们可以知道，Spring 往往很 &quot;智能&quot; 就是因为它会帮我们默认注册一些有用的 bean，</span>
<span class="cm">    * 我们也可以选择覆盖</span>
<span class="cm">    */</span>

   <span class="c1">// 如果没有定义 &quot;environment&quot; 这个 bean，那么 Spring 会 &quot;手动&quot; 注册一个</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">containsLocalBean</span><span class="p">(</span><span class="n">ENVIRONMENT_BEAN_NAME</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">registerSingleton</span><span class="p">(</span><span class="n">ENVIRONMENT_BEAN_NAME</span><span class="p">,</span> <span class="n">getEnvironment</span><span class="p">());</span>
   <span class="p">}</span>
   <span class="c1">// 如果没有定义 &quot;systemProperties&quot; 这个 bean，那么 Spring 会 &quot;手动&quot; 注册一个</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">containsLocalBean</span><span class="p">(</span><span class="n">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">registerSingleton</span><span class="p">(</span><span class="n">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="p">,</span> <span class="n">getEnvironment</span><span class="p">().</span><span class="na">getSystemProperties</span><span class="p">());</span>
   <span class="p">}</span>
   <span class="c1">// 如果没有定义 &quot;systemEnvironment&quot; 这个 bean，那么 Spring 会 &quot;手动&quot; 注册一个</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">containsLocalBean</span><span class="p">(</span><span class="n">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">registerSingleton</span><span class="p">(</span><span class="n">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="p">,</span> <span class="n">getEnvironment</span><span class="p">().</span><span class="na">getSystemEnvironment</span><span class="p">());</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>在上面这块代码中，Spring 对一些特殊的 bean 进行了处理，读者如果暂时还不能消化它们也没有关系，慢慢往下看。</p>
<h3 id="singleton-beans">初始化所有的 singleton beans<a class="headerlink" href="#singleton-beans" title="Permanent link">&para;</a></h3>
<p>我们的重点当然是 <code>finishBeanFactoryInitialization(beanFactory);</code> 这个巨头了，这里会负责初始化所有的 singleton beans。</p>
<p>注意，后面的描述中，我都会使用**初始化**或**预初始化**来代表这个阶段，Spring 会在这个阶段完成所有的 singleton beans 的实例化。</p>
<p>我们来总结一下，到目前为止，应该说 BeanFactory 已经创建完成，并且所有的实现了 BeanFactoryPostProcessor 接口的 Bean 都已经初始化并且其中的 postProcessBeanFactory(factory) 方法已经得到回调执行了。而且 Spring 已经“手动”注册了一些特殊的 Bean，如 ‘environment’、‘systemProperties’ 等。</p>
<p>剩下的就是初始化 singleton beans 了，我们知道它们是单例的，如果没有设置懒加载，那么 Spring 会在接下来初始化所有的 singleton beans。</p>
<p>// AbstractApplicationContext.java 834</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 初始化剩余的 singleton beans</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finishBeanFactoryInitialization</span><span class="p">(</span><span class="n">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// 首先，初始化名字为 conversionService 的 Bean。本着送佛送到西的精神，我在附录中简单介绍了一下 ConversionService，因为这实在太实用了</span>
   <span class="c1">// 什么，看代码这里没有初始化 Bean 啊！</span>
   <span class="c1">// 注意了，初始化的动作包装在 beanFactory.getBean(...) 中，这里先不说细节，先往下看吧</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">containsBean</span><span class="p">(</span><span class="n">CONVERSION_SERVICE_BEAN_NAME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">beanFactory</span><span class="p">.</span><span class="na">isTypeMatch</span><span class="p">(</span><span class="n">CONVERSION_SERVICE_BEAN_NAME</span><span class="p">,</span> <span class="n">ConversionService</span><span class="p">.</span><span class="na">class</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">setConversionService</span><span class="p">(</span>
            <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">CONVERSION_SERVICE_BEAN_NAME</span><span class="p">,</span> <span class="n">ConversionService</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
   <span class="p">}</span>

   <span class="c1">// Register a default embedded value resolver if no bean post-processor</span>
   <span class="c1">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span>
   <span class="c1">// at this point, primarily for resolution in annotation attribute values.</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beanFactory</span><span class="p">.</span><span class="na">hasEmbeddedValueResolver</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">beanFactory</span><span class="p">.</span><span class="na">addEmbeddedValueResolver</span><span class="p">(</span><span class="k">new</span> <span class="n">StringValueResolver</span><span class="p">()</span> <span class="p">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">String</span> <span class="nf">resolveStringValue</span><span class="p">(</span><span class="n">String</span> <span class="n">strVal</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">getEnvironment</span><span class="p">().</span><span class="na">resolvePlaceholders</span><span class="p">(</span><span class="n">strVal</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>

   <span class="c1">// 先初始化 LoadTimeWeaverAware 类型的 Bean</span>
   <span class="c1">// 之前也说过，这是 AspectJ 相关的内容，放心跳过吧</span>
   <span class="n">String</span><span class="o">[]</span> <span class="n">weaverAwareNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="p">.</span><span class="na">getBeanNamesForType</span><span class="p">(</span><span class="n">LoadTimeWeaverAware</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">weaverAwareName</span> <span class="p">:</span> <span class="n">weaverAwareNames</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">getBean</span><span class="p">(</span><span class="n">weaverAwareName</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// Stop using the temporary ClassLoader for type matching.</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">setTempClassLoader</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

   <span class="c1">// 没什么别的目的，因为到这一步的时候，Spring 已经开始预初始化 singleton beans 了，</span>
   <span class="c1">// 肯定不希望这个时候还出现 bean 定义解析、加载、注册。</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">freezeConfiguration</span><span class="p">();</span>

   <span class="c1">// 开始初始化</span>
   <span class="n">beanFactory</span><span class="p">.</span><span class="na">preInstantiateSingletons</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>从上面最后一行往里看，我们就又回到 DefaultListableBeanFactory 这个类了，这个类大家应该都不陌生了吧。</p>
<p>// DefaultListableBeanFactory.java 728</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">preInstantiateSingletons</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Pre-instantiating singletons in &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="c1">// this.beanDefinitionNames 保存了所有的 beanNames</span>
   <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">beanNames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">beanDefinitionNames</span><span class="p">);</span>

   <span class="c1">// 触发所有的非懒加载的 singleton beans 的初始化操作</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">beanName</span> <span class="p">:</span> <span class="n">beanNames</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// 合并父 Bean 中的配置，注意 &lt;bean id=&quot;&quot; class=&quot;&quot; parent=&quot;&quot; /&gt; 中的 parent，用的不多吧，</span>
      <span class="c1">// 考虑到这可能会影响大家的理解，我在附录中解释了一下 &quot;Bean 继承&quot;，不了解的请到附录中看一下</span>
      <span class="n">RootBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>

      <span class="c1">// 非抽象、非懒加载的 singletons。如果配置了 &#39;abstract = true&#39;，那是不需要初始化的</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bd</span><span class="p">.</span><span class="na">isAbstract</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span><span class="p">.</span><span class="na">isSingleton</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bd</span><span class="p">.</span><span class="na">isLazyInit</span><span class="p">())</span> <span class="p">{</span>
         <span class="c1">// 处理 FactoryBean(读者如果不熟悉 FactoryBean，请移步附录区了解)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">isFactoryBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// FactoryBean 的话，在 beanName 前面加上 ‘&amp;’ 符号。再调用 getBean，getBean 方法别急</span>
            <span class="kd">final</span> <span class="n">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="p">(</span><span class="n">FactoryBean</span><span class="o">&lt;?&gt;</span><span class="p">)</span> <span class="n">getBean</span><span class="p">(</span><span class="n">FACTORY_BEAN_PREFIX</span> <span class="o">+</span> <span class="n">beanName</span><span class="p">);</span>
            <span class="c1">// 判断当前 FactoryBean 是否是 SmartFactoryBean 的实现，此处忽略，直接跳过</span>
            <span class="kt">boolean</span> <span class="n">isEagerInit</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getSecurityManager</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">factory</span> <span class="k">instanceof</span> <span class="n">SmartFactoryBean</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">isEagerInit</span> <span class="o">=</span> <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nd">@Override</span>
                  <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
                     <span class="k">return</span> <span class="p">((</span><span class="n">SmartFactoryBean</span><span class="o">&lt;?&gt;</span><span class="p">)</span> <span class="n">factory</span><span class="p">).</span><span class="na">isEagerInit</span><span class="p">();</span>
                  <span class="p">}</span>
               <span class="p">},</span> <span class="n">getAccessControlContext</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
               <span class="n">isEagerInit</span> <span class="o">=</span> <span class="p">(</span><span class="n">factory</span> <span class="k">instanceof</span> <span class="n">SmartFactoryBean</span> <span class="o">&amp;&amp;</span>
                     <span class="p">((</span><span class="n">SmartFactoryBean</span><span class="o">&lt;?&gt;</span><span class="p">)</span> <span class="n">factory</span><span class="p">).</span><span class="na">isEagerInit</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isEagerInit</span><span class="p">)</span> <span class="p">{</span>

               <span class="n">getBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 对于普通的 Bean，只要调用 getBean(beanName) 这个方法就可以进行初始化了</span>
            <span class="n">getBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>


   <span class="c1">// 到这里说明所有的非懒加载的 singleton beans 已经完成了初始化</span>
   <span class="c1">// 如果我们定义的 bean 是实现了 SmartInitializingSingleton 接口的，那么在这里得到回调，忽略</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">beanName</span> <span class="p">:</span> <span class="n">beanNames</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Object</span> <span class="n">singletonInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">singletonInstance</span> <span class="k">instanceof</span> <span class="n">SmartInitializingSingleton</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">final</span> <span class="n">SmartInitializingSingleton</span> <span class="n">smartSingleton</span> <span class="o">=</span> <span class="p">(</span><span class="n">SmartInitializingSingleton</span><span class="p">)</span> <span class="n">singletonInstance</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getSecurityManager</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
               <span class="nd">@Override</span>
               <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
                  <span class="n">smartSingleton</span><span class="p">.</span><span class="na">afterSingletonsInstantiated</span><span class="p">();</span>
                  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">},</span> <span class="n">getAccessControlContext</span><span class="p">());</span>
         <span class="p">}</span>
         <span class="k">else</span> <span class="p">{</span>
            <span class="n">smartSingleton</span><span class="p">.</span><span class="na">afterSingletonsInstantiated</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>接下来，我们就进入到 getBean(beanName) 方法了，这个方法我们经常用来从 BeanFactory 中获取一个 Bean，而初始化的过程也封装到了这个方法里。</p>
<h2 id="bean_3">获取 Bean<a class="headerlink" href="#bean_3" title="Permanent link">&para;</a></h2>
<p>容器和 Bean 已经准备好了，接着就是获取 Bean 去使用了。</p>
<h3 id="getbeanstring">俯瞰 getBean(String) 源码<a class="headerlink" href="#getbeanstring" title="Permanent link">&para;</a></h3>
<p>在本小节，我们先从战略上俯瞰 getBean(String) 方法的实现源码。代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getBean</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
    <span class="c1">// getBean 是一个空壳方法，所有的逻辑都封装在 doGetBean 方法中</span>
    <span class="k">return</span> <span class="n">doGetBean</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">doGetBean</span><span class="p">(</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">requiredType</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">typeCheckOnly</span><span class="p">)</span>
        <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>

    <span class="cm">/*</span>
<span class="cm">     * 通过 name 获取 beanName。这里不使用 name 直接作为 beanName 有两点原因：</span>
<span class="cm">     * 1. name 可能会以 &amp; 字符开头，表明调用者想获取 FactoryBean 本身，而非 FactoryBean </span>
<span class="cm">     *    实现类所创建的 bean。在 BeanFactory 中，FactoryBean 的实现类和其他的 bean 存储</span>
<span class="cm">     *    方式是一致的，即 &lt;beanName, bean&gt;，beanName 中是没有 &amp; 这个字符的。所以我们需要</span>
<span class="cm">     *    将 name 的首字符 &amp; 移除，这样才能从缓存里取到 FactoryBean 实例。</span>
<span class="cm">     * 2. 若 name 是一个别名，则应将别名转换为具体的实例名，也就是 beanName。</span>
<span class="cm">     */</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="c1">// 注意跟着这个，这个是返回值</span>
    <span class="n">Object</span> <span class="n">bean</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * 从缓存中获取单例 bean。Spring 是使用 Map 作为 beanName 和 bean 实例的缓存的，所以这</span>
<span class="cm">     * 里暂时可以把 getSingleton(beanName) 等价于 beanMap.get(beanName)。当然，实际的</span>
<span class="cm">     * 逻辑并非如此简单，后面再细说。</span>
<span class="cm">     */</span>
    <span class="n">Object</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * 如果 sharedInstance = null，则说明缓存里没有对应的实例，表明这个实例还没创建。</span>
<span class="cm">     * BeanFactory 并不会在一开始就将所有的单例 bean 实例化好，而是在调用 getBean 获取 </span>
<span class="cm">     * bean 时再实例化，也就是懒加载。</span>
<span class="cm">     * getBean 方法有很多重载，比如 getBean(String name, Object... args)，我们在首次获取</span>
<span class="cm">     * 某个 bean 时，可以传入用于初始化 bean 的参数数组（args），BeanFactory 会根据这些参数</span>
<span class="cm">     * 去匹配合适的构造方法构造 bean 实例。当然，如果单例 bean 早已创建好，这里的 args 就没有</span>
<span class="cm">     * 用了，BeanFactory 不会多次实例化单例 bean。</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sharedInstance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Returning eagerly cached instance of singleton bean &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
                        <span class="s">&quot;&#39; that is not fully initialized yet - a consequence of a circular reference&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Returning cached instance of singleton bean &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/*</span>
<span class="cm">         * 如果 sharedInstance 是普通的单例 bean，下面的方法会直接返回。但如果 </span>
<span class="cm">         * sharedInstance 是 FactoryBean 类型的，则需调用 getObject 工厂方法获取真正的 </span>
<span class="cm">         * bean 实例。如果用户想获取 FactoryBean 本身，这里也不会做特别的处理，直接返回</span>
<span class="cm">         * 即可。毕竟 FactoryBean 的实现类本身也是一种 bean，只不过具有一点特殊的功能而已。</span>
<span class="cm">         */</span>
        <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="p">(</span><span class="n">sharedInstance</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/*</span>
<span class="cm">     * 如果上面的条件不满足，则表明 sharedInstance 可能为空，此时 beanName 对应的 bean </span>
<span class="cm">     * 实例可能还未创建。这里还存在另一种可能，如果当前容器有父容器，beanName 对应的 bean 实例</span>
<span class="cm">     * 可能是在父容器中被创建了，所以在创建实例前，需要先去父容器里检查一下。</span>
<span class="cm">     */</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// BeanFactory 不缓存 Prototype 类型的 bean，无法处理该类型 bean 的循环依赖问题</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isPrototypeCurrentlyInCreation</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCurrentlyInCreationException</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// 如果 sharedInstance = null，则到父容器中查找 bean 实例</span>
        <span class="n">BeanFactory</span> <span class="n">parentBeanFactory</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parentBeanFactory</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containsBeanDefinition</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// 获取 name 对应的 beanName，如果 name 是以 &amp; 字符开头，则返回 &amp; + beanName</span>
            <span class="n">String</span> <span class="n">nameToLookup</span> <span class="o">=</span> <span class="n">originalBeanName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
            <span class="c1">// 根据 args 是否为空，以决定调用父容器哪个方法获取 bean</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 返回父容器的查询结果</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="n">parentBeanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">nameToLookup</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
            <span class="p">}</span> 
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">parentBeanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">nameToLookup</span><span class="p">,</span> <span class="n">requiredType</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">typeCheckOnly</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">markBeanAsCreated</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
        <span class="p">}</span>

       <span class="cm">/*</span>
<span class="cm">       * 稍稍总结一下：</span>
<span class="cm">       * 到这里的话，要准备创建 Bean 了，对于 singleton 的 Bean 来说，容器中还没创建过此 Bean；</span>
<span class="cm">       * 对于 prototype 的 Bean 来说，本来就是要创建一个新的 Bean。</span>
<span class="cm">       */</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// 合并父 BeanDefinition 与子 BeanDefinition，后面会单独分析这个方法</span>
            <span class="kd">final</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
            <span class="n">checkMergedBeanDefinition</span><span class="p">(</span><span class="n">mbd</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

            <span class="c1">// 检查是否有 dependsOn 依赖，如果有则先初始化所依赖的 bean</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">dependsOn</span> <span class="o">=</span> <span class="n">mbd</span><span class="p">.</span><span class="na">getDependsOn</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">dep</span> <span class="p">:</span> <span class="n">dependsOn</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/*</span>
<span class="cm">                     * 检测是否存在 depends-on 循环依赖，若存在则抛异常。比如 A 依赖 B，</span>
<span class="cm">                     * B 又依赖 A，他们的配置如下：</span>
<span class="cm">                     *   &lt;bean id=&quot;beanA&quot; class=&quot;BeanA&quot; depends-on=&quot;beanB&quot;&gt;</span>
<span class="cm">                     *   &lt;bean id=&quot;beanB&quot; class=&quot;BeanB&quot; depends-on=&quot;beanA&quot;&gt;</span>
<span class="cm">                     *   </span>
<span class="cm">                     * beanA 要求 beanB 在其之前被创建，但 beanB 又要求 beanA 先于它</span>
<span class="cm">                     * 创建。这个时候形成了循环，对于 depends-on 循环，Spring 会直接</span>
<span class="cm">                     * 抛出异常</span>
<span class="cm">                     */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">isDependent</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">dep</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span>
                                <span class="s">&quot;Circular depends-on relationship between &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39; and &#39;&quot;</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="c1">// 注册依赖记录</span>
                    <span class="n">registerDependentBean</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="c1">// 先初始化被依赖项 加载 depends-on 依赖 </span>
                        <span class="n">getBean</span><span class="p">(</span><span class="n">dep</span><span class="p">);</span>
                    <span class="p">}</span> 
                    <span class="k">catch</span> <span class="p">(</span><span class="n">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span>
                                <span class="s">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39; depends on missing bean &#39;&quot;</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// 创建 bean 实例</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">isSingleton</span><span class="p">())</span> <span class="p">{</span>
                <span class="cm">/*</span>
<span class="cm">                 * 这里并没有直接调用 createBean 方法创建 bean 实例，而是通过 </span>
<span class="cm">                 * getSingleton(String, ObjectFactory) 方法获取 bean 实例。</span>
<span class="cm">                 * getSingleton(String, ObjectFactory) 方法会在内部调用 </span>
<span class="cm">                 * ObjectFactory 的 getObject() 方法创建 bean，并会在创建完成后，</span>
<span class="cm">                 * 将 bean 放入缓存中。关于 getSingleton 方法的分析，本文先不展开，我会在</span>
<span class="cm">                 * 后面的文章中进行分析</span>
<span class="cm">                 */</span>
                <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="k">new</span> <span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
                        <span class="k">try</span> <span class="p">{</span>
                            <span class="c1">// 创建 bean 实例</span>
                            <span class="k">return</span> <span class="n">createBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">catch</span> <span class="p">(</span><span class="n">BeansException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">destroySingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
                            <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">});</span>
                <span class="c1">// 如果 bean 是 FactoryBean 类型，则调用工厂方法获取真正的 bean 实例。否则直接返回 bean 实例</span>
                <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="p">(</span><span class="n">sharedInstance</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// 创建 prototype 类型的 bean 实例</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">isPrototype</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">Object</span> <span class="n">prototypeInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">beforePrototypeCreation</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
                    <span class="n">prototypeInstance</span> <span class="o">=</span> <span class="n">createBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">finally</span> <span class="p">{</span>
                    <span class="n">afterPrototypeCreation</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="p">(</span><span class="n">prototypeInstance</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// 创建其他类型的 bean 实例</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">String</span> <span class="n">scopeName</span> <span class="o">=</span> <span class="n">mbd</span><span class="p">.</span><span class="na">getScope</span><span class="p">();</span>
                <span class="kd">final</span> <span class="n">Scope</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">scopes</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">scopeName</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">scope</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;No Scope registered for scope name &#39;&quot;</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">Object</span> <span class="n">scopedInstance</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="k">new</span> <span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
                            <span class="n">beforePrototypeCreation</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
                            <span class="k">try</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="n">createBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="k">finally</span> <span class="p">{</span>
                                <span class="n">afterPrototypeCreation</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                    <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="p">(</span><span class="n">scopedInstance</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">IllegalStateException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span>
                            <span class="s">&quot;Scope &#39;&quot;</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">&quot;&#39; is not active for the current thread; consider &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span><span class="p">,</span>
                            <span class="n">ex</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">BeansException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cleanupAfterBeanCreationFailure</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 如果需要进行类型转换，则在此处进行转换。类型转换这一块我没细看，就不多说了。</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">requiredType</span><span class="p">.</span><span class="na">isInstance</span><span class="p">(</span><span class="n">bean</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">getTypeConverter</span><span class="p">().</span><span class="na">convertIfNecessary</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span> <span class="n">requiredType</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">TypeMismatchException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Failed to convert bean &#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;&#39; to required type &#39;&quot;</span> <span class="o">+</span>
                        <span class="n">ClassUtils</span><span class="p">.</span><span class="na">getQualifiedName</span><span class="p">(</span><span class="n">requiredType</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanNotOfRequiredTypeException</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">requiredType</span><span class="p">,</span> <span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 返回 bean</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="n">bean</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="createbean">createBean<a class="headerlink" href="#createbean" title="Permanent link">&para;</a></h3>
<p>大家应该也猜到了，接下来当然是分析 createBean 方法：</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">createBean</span><span class="p">(</span><span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeanCreationException</span><span class="p">;</span>
</code></pre></div>
<p>第三个参数 args 数组代表创建实例需要的参数，不就是给构造方法用的参数，或者是工厂 Bean 的参数嘛，不过要注意，在我们的初始化阶段，args 是 null。</p>
<p>这回我们要到一个新的类了 AbstractAutowireCapableBeanFactory，看类名，AutowireCapable？类名是不是也说明了点问题了。</p>
<p>主要是为了以下场景，采用 <a class="magiclink magiclink-github magiclink-mention" href="https://github.com/Autowired" title="GitHub User: Autowired">@Autowired</a> 注解注入属性值：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageServiceImpl</span> <span class="kd">implements</span> <span class="n">MessageService</span> <span class="p">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">userService</span><span class="p">.</span><span class="na">getMessage</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;messageService&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;com.example.MessageServiceImpl&quot;</span> <span class="o">/&gt;</span>
</code></pre></div>
<p>以上这种属于混用了 xml 和 注解 两种方式的配置方式，Spring 会处理这种情况。</p>
<p>好了，读者要知道这么回事就可以了，继续向前。</p>
<p>// AbstractAutowireCapableBeanFactory.java 447</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Central method of this class: creates a bean instance,</span>
<span class="cm"> * populates the bean instance, applies post-processors, etc.</span>
<span class="cm"> * @see #doCreateBean</span>
<span class="cm"> */</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="n">Object</span> <span class="nf">createBean</span><span class="p">(</span><span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BeanCreationException</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Creating instance of bean &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">RootBeanDefinition</span> <span class="n">mbdToUse</span> <span class="o">=</span> <span class="n">mbd</span><span class="p">;</span>

   <span class="c1">// 确保 BeanDefinition 中的 Class 被加载</span>
   <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolvedClass</span> <span class="o">=</span> <span class="n">resolveBeanClass</span><span class="p">(</span><span class="n">mbd</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">resolvedClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="na">hasBeanClass</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="p">.</span><span class="na">getBeanClassName</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mbdToUse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootBeanDefinition</span><span class="p">(</span><span class="n">mbd</span><span class="p">);</span>
      <span class="n">mbdToUse</span><span class="p">.</span><span class="na">setBeanClass</span><span class="p">(</span><span class="n">resolvedClass</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// 准备方法覆写，这里又涉及到一个概念：MethodOverrides，它来自于 bean 定义中的 &lt;lookup-method /&gt; </span>
   <span class="c1">// 和 &lt;replaced-method /&gt;，如果读者感兴趣，回到 bean 解析的地方看看对这两个标签的解析。</span>
   <span class="c1">// 我在附录中也对这两个标签的相关知识点进行了介绍，读者可以移步去看看</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="n">mbdToUse</span><span class="p">.</span><span class="na">prepareMethodOverrides</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanDefinitionStoreException</span><span class="p">(</span><span class="n">mbdToUse</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span>
            <span class="n">beanName</span><span class="p">,</span> <span class="s">&quot;Validation of method overrides failed&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// 让 InstantiationAwareBeanPostProcessor 在这一步有机会返回代理，</span>
      <span class="n">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">resolveBeforeInstantiation</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbdToUse</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="n">bean</span><span class="p">;</span> 
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span><span class="n">mbdToUse</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span>
            <span class="s">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="c1">// 重头戏，创建 bean</span>
   <span class="n">Object</span> <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">doCreateBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbdToUse</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Finished creating instance of bean &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">beanInstance</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>我们继续往里看 doCreateBean 这个方法：</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">doCreateBean</span><span class="p">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="kd">final</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span>
      <span class="kd">throws</span> <span class="n">BeanCreationException</span> <span class="p">{</span>

   <span class="c1">// Instantiate the bean.</span>
   <span class="n">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">isSingleton</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">factoryBeanInstanceCache</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 说明不是 FactoryBean，这里实例化 Bean，这里非常关键，细节之后再说</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="c1">// 这个就是 Bean 里面的 我们定义的类 的实例，很多地方我直接描述成 &quot;bean 实例&quot;</span>
   <span class="kd">final</span> <span class="n">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="p">(</span><span class="n">instanceWrapper</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">instanceWrapper</span><span class="p">.</span><span class="na">getWrappedInstance</span><span class="p">()</span> <span class="p">:</span> <span class="kc">null</span><span class="p">);</span>
   <span class="c1">// 类型</span>
   <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="p">(</span><span class="n">instanceWrapper</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">instanceWrapper</span><span class="p">.</span><span class="na">getWrappedClass</span><span class="p">()</span> <span class="p">:</span> <span class="kc">null</span><span class="p">);</span>
   <span class="n">mbd</span><span class="p">.</span><span class="na">resolvedTargetType</span> <span class="o">=</span> <span class="n">beanType</span><span class="p">;</span>

   <span class="c1">// 建议跳过吧，涉及接口：MergedBeanDefinitionPostProcessor</span>
   <span class="kd">synchronized</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">postProcessingLock</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="na">postProcessed</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// MergedBeanDefinitionPostProcessor，这个我真不展开说了，直接跳过吧，很少用的</span>
            <span class="n">applyMergedBeanDefinitionPostProcessors</span><span class="p">(</span><span class="n">mbd</span><span class="p">,</span> <span class="n">beanType</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span>
                  <span class="s">&quot;Post-processing of merged bean definition failed&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="n">mbd</span><span class="p">.</span><span class="na">postProcessed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// Eagerly cache singletons to be able to resolve circular references</span>
   <span class="c1">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
   <span class="c1">// 下面这块代码是为了解决循环依赖的问题</span>
   <span class="kt">boolean</span> <span class="n">earlySingletonExposure</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">isSingleton</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="na">allowCircularReferences</span> <span class="o">&amp;&amp;</span>
         <span class="n">isSingletonCurrentlyInCreation</span><span class="p">(</span><span class="n">beanName</span><span class="p">));</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">earlySingletonExposure</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span> <span class="p">{</span>
         <span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Eagerly caching bean &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
               <span class="s">&quot;&#39; to allow for resolving potential circular references&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">addSingletonFactory</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="k">new</span> <span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObject</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">BeansException</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">getEarlyBeanReference</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">bean</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>

   <span class="c1">// Initialize the bean instance.</span>
   <span class="n">Object</span> <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">bean</span><span class="p">;</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// 这一步也是非常关键的，这一步负责属性装配，因为前面的实例只是实例化了，并没有设值，这里就是设值</span>
      <span class="n">populateBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">instanceWrapper</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">exposedObject</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// 还记得 init-method 吗？还有 InitializingBean 接口？还有 BeanPostProcessor 接口？</span>
         <span class="c1">// 这里就是处理 bean 初始化完成后的各种回调</span>
         <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">exposedObject</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="n">BeanCreationException</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="p">.</span><span class="na">equals</span><span class="p">(((</span><span class="n">BeanCreationException</span><span class="p">)</span> <span class="n">ex</span><span class="p">).</span><span class="na">getBeanName</span><span class="p">()))</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="p">(</span><span class="n">BeanCreationException</span><span class="p">)</span> <span class="n">ex</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span>
               <span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span> <span class="s">&quot;Initialization of bean failed&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">earlySingletonExposure</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// </span>
      <span class="n">Object</span> <span class="n">earlySingletonReference</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">earlySingletonReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">exposedObject</span> <span class="o">==</span> <span class="n">bean</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">earlySingletonReference</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="na">allowRawInjectionDespiteWrapping</span> <span class="o">&amp;&amp;</span> <span class="n">hasDependentBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">dependentBeans</span> <span class="o">=</span> <span class="n">getDependentBeans</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">actualDependentBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dependentBeans</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">dependentBean</span> <span class="p">:</span> <span class="n">dependentBeans</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">removeSingletonIfCreatedForTypeCheckOnly</span><span class="p">(</span><span class="n">dependentBean</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">actualDependentBeans</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">dependentBean</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">actualDependentBeans</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCurrentlyInCreationException</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span>
                     <span class="s">&quot;Bean with name &#39;&quot;</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">&quot;&#39; has been injected into other beans [&quot;</span> <span class="o">+</span>
                     <span class="n">StringUtils</span><span class="p">.</span><span class="na">collectionToCommaDelimitedString</span><span class="p">(</span><span class="n">actualDependentBeans</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> <span class="o">+</span>
                     <span class="s">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> <span class="o">+</span>
                     <span class="s">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> <span class="o">+</span>
                     <span class="s">&quot;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// Register bean as disposable.</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="n">registerDisposableBeanIfNecessary</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">bean</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span>
            <span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span> <span class="s">&quot;Invalid destruction signature&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">exposedObject</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>到这里，我们已经分析完了 doCreateBean 方法，总的来说，我们已经说完了整个初始化流程。</p>
<p>接下来我们挑 doCreateBean 中的三个细节出来说说。</p>
<p>一个是创建 Bean 实例的 createBeanInstance 方法，一个是依赖注入的 populateBean 方法，还有就是回调方法 initializeBean。</p>
<p>注意了，接下来的这三个方法要认真说那也是极其复杂的，很多地方我就点到为止了，感兴趣的读者可以自己往里看，最好就是碰到不懂的，自己写代码去调试它。</p>
<h4 id="bean_4">创建 Bean 实例<a class="headerlink" href="#bean_4" title="Permanent link">&para;</a></h4>
<p>我们先看看 createBeanInstance 方法。需要说明的是，这个方法如果每个分支都分析下去，必然也是极其复杂冗长的，我们挑重点说。此方法的目的就是实例化我们指定的类。</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="n">BeanWrapper</span> <span class="nf">createBeanInstance</span><span class="p">(</span><span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// 确保已经加载了此 class</span>
   <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span> <span class="o">=</span> <span class="n">resolveBeanClass</span><span class="p">(</span><span class="n">mbd</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>

   <span class="c1">// 校验一下这个类的访问权限</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">beanClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Modifier</span><span class="p">.</span><span class="na">isPublic</span><span class="p">(</span><span class="n">beanClass</span><span class="p">.</span><span class="na">getModifiers</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="na">isNonPublicAccessAllowed</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span>
            <span class="s">&quot;Bean class isn&#39;t public, and non-public access not allowed: &quot;</span> <span class="o">+</span> <span class="n">beanClass</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getFactoryMethodName</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>  <span class="p">{</span>
      <span class="c1">// 采用工厂方法实例化，不熟悉这个概念的读者请看附录，注意，不是 FactoryBean</span>
      <span class="k">return</span> <span class="n">instantiateUsingFactoryMethod</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// 如果不是第一次创建，比如第二次创建 prototype bean。</span>
   <span class="c1">// 这种情况下，我们可以从第一次创建知道，采用无参构造函数，还是构造函数依赖注入 来完成实例化</span>
   <span class="kt">boolean</span> <span class="n">resolved</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="kt">boolean</span> <span class="n">autowireNecessary</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">synchronized</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">constructorArgumentLock</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">resolvedConstructorOrFactoryMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="n">autowireNecessary</span> <span class="o">=</span> <span class="n">mbd</span><span class="p">.</span><span class="na">constructorArgumentsResolved</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">resolved</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">autowireNecessary</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// 构造函数依赖注入</span>
         <span class="k">return</span> <span class="n">autowireConstructor</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// 无参构造函数</span>
         <span class="k">return</span> <span class="n">instantiateBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 判断是否采用有参构造函数</span>
   <span class="n">Constructor</span><span class="o">&lt;?&gt;[]</span> <span class="n">ctors</span> <span class="o">=</span> <span class="n">determineConstructorsFromBeanPostProcessors</span><span class="p">(</span><span class="n">beanClass</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">ctors</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
         <span class="n">mbd</span><span class="p">.</span><span class="na">getResolvedAutowireMode</span><span class="p">()</span> <span class="o">==</span> <span class="n">RootBeanDefinition</span><span class="p">.</span><span class="na">AUTOWIRE_CONSTRUCTOR</span> <span class="o">||</span>
         <span class="n">mbd</span><span class="p">.</span><span class="na">hasConstructorArgumentValues</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">ObjectUtils</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>  <span class="p">{</span>
      <span class="c1">// 构造函数依赖注入</span>
      <span class="k">return</span> <span class="n">autowireConstructor</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">ctors</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// 调用无参构造函数</span>
   <span class="k">return</span> <span class="n">instantiateBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>挑个简单的**无参构造函数**构造实例来看看：</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="n">BeanWrapper</span> <span class="nf">instantiateBean</span><span class="p">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="kd">final</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="n">Object</span> <span class="n">beanInstance</span><span class="p">;</span>
      <span class="kd">final</span> <span class="n">BeanFactory</span> <span class="n">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getSecurityManager</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>

               <span class="k">return</span> <span class="n">getInstantiationStrategy</span><span class="p">().</span><span class="na">instantiate</span><span class="p">(</span><span class="n">mbd</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">},</span> <span class="n">getAccessControlContext</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// 实例化</span>
         <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">getInstantiationStrategy</span><span class="p">().</span><span class="na">instantiate</span><span class="p">(</span><span class="n">mbd</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// 包装一下，返回</span>
      <span class="n">BeanWrapper</span> <span class="n">bw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BeanWrapperImpl</span><span class="p">(</span><span class="n">beanInstance</span><span class="p">);</span>
      <span class="n">initBeanWrapper</span><span class="p">(</span><span class="n">bw</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">bw</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span>
            <span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span> <span class="s">&quot;Instantiation of bean failed&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>我们可以看到，关键的地方在于：</p>
<div class="highlight"><pre><span></span><code><span class="n">beanInstance</span> <span class="o">=</span> <span class="n">getInstantiationStrategy</span><span class="p">().</span><span class="na">instantiate</span><span class="p">(</span><span class="n">mbd</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
</code></pre></div>
<p>这里会进行实际的实例化过程，我们进去看看:</p>
<p>// SimpleInstantiationStrategy 59</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Object</span> <span class="nf">instantiate</span><span class="p">(</span><span class="n">RootBeanDefinition</span> <span class="n">bd</span><span class="p">,</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">BeanFactory</span> <span class="n">owner</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// 如果不存在方法覆写，那就使用 java 反射进行实例化，否则使用 CGLIB,</span>
   <span class="c1">// 方法覆写 请参见附录&quot;方法注入&quot;中对 lookup-method 和 replaced-method 的介绍</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="na">getMethodOverrides</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructorToUse</span><span class="p">;</span>
      <span class="kd">synchronized</span> <span class="p">(</span><span class="n">bd</span><span class="p">.</span><span class="na">constructorArgumentLock</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">constructorToUse</span> <span class="o">=</span> <span class="p">(</span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span><span class="p">)</span> <span class="n">bd</span><span class="p">.</span><span class="na">resolvedConstructorOrFactoryMethod</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">constructorToUse</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">bd</span><span class="p">.</span><span class="na">getBeanClass</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="na">isInterface</span><span class="p">())</span> <span class="p">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanInstantiationException</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">&quot;Specified class is an interface&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">try</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getSecurityManager</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">constructorToUse</span> <span class="o">=</span> <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivilegedExceptionAction</span><span class="o">&lt;</span><span class="n">Constructor</span><span class="o">&lt;?&gt;&gt;</span><span class="p">()</span> <span class="p">{</span>
                     <span class="nd">@Override</span>
                     <span class="kd">public</span> <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">run</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">((</span><span class="n">Class</span><span class="o">[]</span><span class="p">)</span> <span class="kc">null</span><span class="p">);</span>
                     <span class="p">}</span>
                  <span class="p">});</span>
               <span class="p">}</span>
               <span class="k">else</span> <span class="p">{</span>
                  <span class="n">constructorToUse</span> <span class="o">=</span> <span class="n">clazz</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">((</span><span class="n">Class</span><span class="o">[]</span><span class="p">)</span> <span class="kc">null</span><span class="p">);</span>
               <span class="p">}</span>
               <span class="n">bd</span><span class="p">.</span><span class="na">resolvedConstructorOrFactoryMethod</span> <span class="o">=</span> <span class="n">constructorToUse</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanInstantiationException</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="s">&quot;No default constructor found&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// 利用构造方法进行实例化</span>
      <span class="k">return</span> <span class="n">BeanUtils</span><span class="p">.</span><span class="na">instantiateClass</span><span class="p">(</span><span class="n">constructorToUse</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 存在方法覆写，利用 CGLIB 来完成实例化，需要依赖于 CGLIB 生成子类，这里就不展开了。</span>
      <span class="c1">// tips: 因为如果不使用 CGLIB 的话，存在 override 的情况 JDK 并没有提供相应的实例化支持</span>
      <span class="k">return</span> <span class="n">instantiateWithMethodInjection</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>到这里，我们就算实例化完成了。我们开始说怎么进行属性注入。</p>
<h4 id="bean_5">bean 属性注入<a class="headerlink" href="#bean_5" title="Permanent link">&para;</a></h4>
<p>看完了 createBeanInstance(...) 方法，我们来看看 populateBean(...) 方法，该方法负责进行属性设值，处理依赖。</p>
<p>// AbstractAutowireCapableBeanFactory 1203</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">populateBean</span><span class="p">(</span><span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">BeanWrapper</span> <span class="n">bw</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// bean 实例的所有属性都在这里了</span>
   <span class="n">PropertyValues</span> <span class="n">pvs</span> <span class="o">=</span> <span class="n">mbd</span><span class="p">.</span><span class="na">getPropertyValues</span><span class="p">();</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvs</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span>
               <span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">,</span> <span class="s">&quot;Cannot apply property values to null instance&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Skip property population phase for null instance.</span>
         <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 到这步的时候，bean 实例化完成（通过工厂方法或构造方法），但是还没开始属性设值，</span>
   <span class="c1">// InstantiationAwareBeanPostProcessor 的实现类可以在这里对 bean 进行状态修改，</span>
   <span class="c1">// 我也没找到有实际的使用，所以我们暂且忽略这块吧</span>
   <span class="kt">boolean</span> <span class="n">continueWithPropertyPopulation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="na">isSynthetic</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hasInstantiationAwareBeanPostProcessors</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">BeanPostProcessor</span> <span class="n">bp</span> <span class="p">:</span> <span class="n">getBeanPostProcessors</span><span class="p">())</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="k">instanceof</span> <span class="n">InstantiationAwareBeanPostProcessor</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">InstantiationAwareBeanPostProcessor</span> <span class="n">ibp</span> <span class="o">=</span> <span class="p">(</span><span class="n">InstantiationAwareBeanPostProcessor</span><span class="p">)</span> <span class="n">bp</span><span class="p">;</span>
            <span class="c1">// 如果返回 false，代表不需要进行后续的属性设值，也不需要再经过其他的 BeanPostProcessor 的处理</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibp</span><span class="p">.</span><span class="na">postProcessAfterInstantiation</span><span class="p">(</span><span class="n">bw</span><span class="p">.</span><span class="na">getWrappedInstance</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">))</span> <span class="p">{</span>
               <span class="n">continueWithPropertyPopulation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">continueWithPropertyPopulation</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getResolvedAutowireMode</span><span class="p">()</span> <span class="o">==</span> <span class="n">RootBeanDefinition</span><span class="p">.</span><span class="na">AUTOWIRE_BY_NAME</span> <span class="o">||</span>
         <span class="n">mbd</span><span class="p">.</span><span class="na">getResolvedAutowireMode</span><span class="p">()</span> <span class="o">==</span> <span class="n">RootBeanDefinition</span><span class="p">.</span><span class="na">AUTOWIRE_BY_TYPE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MutablePropertyValues</span> <span class="n">newPvs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutablePropertyValues</span><span class="p">(</span><span class="n">pvs</span><span class="p">);</span>

      <span class="c1">// 通过名字找到所有属性值，如果是 bean 依赖，先初始化依赖的 bean。记录依赖关系</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getResolvedAutowireMode</span><span class="p">()</span> <span class="o">==</span> <span class="n">RootBeanDefinition</span><span class="p">.</span><span class="na">AUTOWIRE_BY_NAME</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">autowireByName</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">newPvs</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// 通过类型装配。复杂一些</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getResolvedAutowireMode</span><span class="p">()</span> <span class="o">==</span> <span class="n">RootBeanDefinition</span><span class="p">.</span><span class="na">AUTOWIRE_BY_TYPE</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">autowireByType</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">newPvs</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="n">pvs</span> <span class="o">=</span> <span class="n">newPvs</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kt">boolean</span> <span class="n">hasInstAwareBpps</span> <span class="o">=</span> <span class="n">hasInstantiationAwareBeanPostProcessors</span><span class="p">();</span>
   <span class="kt">boolean</span> <span class="n">needsDepCheck</span> <span class="o">=</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="na">getDependencyCheck</span><span class="p">()</span> <span class="o">!=</span> <span class="n">RootBeanDefinition</span><span class="p">.</span><span class="na">DEPENDENCY_CHECK_NONE</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">hasInstAwareBpps</span> <span class="o">||</span> <span class="n">needsDepCheck</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">filteredPds</span> <span class="o">=</span> <span class="n">filterPropertyDescriptorsForDependencyCheck</span><span class="p">(</span><span class="n">bw</span><span class="p">,</span> <span class="n">mbd</span><span class="p">.</span><span class="na">allowCaching</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">hasInstAwareBpps</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="n">BeanPostProcessor</span> <span class="n">bp</span> <span class="p">:</span> <span class="n">getBeanPostProcessors</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="k">instanceof</span> <span class="n">InstantiationAwareBeanPostProcessor</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">InstantiationAwareBeanPostProcessor</span> <span class="n">ibp</span> <span class="o">=</span> <span class="p">(</span><span class="n">InstantiationAwareBeanPostProcessor</span><span class="p">)</span> <span class="n">bp</span><span class="p">;</span>
               <span class="c1">// 这里有个非常有用的 BeanPostProcessor 进到这里: AutowiredAnnotationBeanPostProcessor</span>
               <span class="c1">// 对采用 @Autowired、@Value 注解的依赖进行设值，这里的内容也是非常丰富的，不过本文不会展开说了，感兴趣的读者请自行研究</span>
               <span class="n">pvs</span> <span class="o">=</span> <span class="n">ibp</span><span class="p">.</span><span class="na">postProcessPropertyValues</span><span class="p">(</span><span class="n">pvs</span><span class="p">,</span> <span class="n">filteredPds</span><span class="p">,</span> <span class="n">bw</span><span class="p">.</span><span class="na">getWrappedInstance</span><span class="p">(),</span> <span class="n">beanName</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">pvs</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">needsDepCheck</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">checkDependencies</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">filteredPds</span><span class="p">,</span> <span class="n">pvs</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="c1">// 设置 bean 实例的属性值</span>
   <span class="n">applyPropertyValues</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">pvs</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="initializebean">initializeBean<a class="headerlink" href="#initializebean" title="Permanent link">&para;</a></h4>
<p>属性注入完成后，这一步其实就是处理各种回调了，这块代码比较简单。</p>
<div class="highlight"><pre><span></span><code><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">initializeBean</span><span class="p">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">bean</span><span class="p">,</span> <span class="n">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getSecurityManager</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">AccessController</span><span class="p">.</span><span class="na">doPrivileged</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">invokeAwareMethods</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">bean</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="n">getAccessControlContext</span><span class="p">());</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 如果 bean 实现了 BeanNameAware、BeanClassLoaderAware 或 BeanFactoryAware 接口，回调</span>
      <span class="n">invokeAwareMethods</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">bean</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">Object</span> <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">bean</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="na">isSynthetic</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// BeanPostProcessor 的 postProcessBeforeInitialization 回调</span>
      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsBeforeInitialization</span><span class="p">(</span><span class="n">wrappedBean</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// 处理 bean 中定义的 init-method，</span>
      <span class="c1">// 或者如果 bean 实现了 InitializingBean 接口，调用 afterPropertiesSet() 方法</span>
      <span class="n">invokeInitMethods</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">wrappedBean</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">BeanCreationException</span><span class="p">(</span>
            <span class="p">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mbd</span><span class="p">.</span><span class="na">getResourceDescription</span><span class="p">()</span> <span class="p">:</span> <span class="kc">null</span><span class="p">),</span>
            <span class="n">beanName</span><span class="p">,</span> <span class="s">&quot;Invocation of init method failed&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="na">isSynthetic</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// BeanPostProcessor 的 postProcessAfterInitialization 回调</span>
      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="p">(</span><span class="n">wrappedBean</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">wrappedBean</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>大家发现没有，BeanPostProcessor 的两个回调都发生在这边，只不过中间处理了 init-method，是不是和读者原来的认知有点不一样了？</p>
<h2 id="_2">相关疑问<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h4 id="spring-bean">Spring 的 bean 在什么时候实例化?<a class="headerlink" href="#spring-bean" title="Permanent link">&para;</a></h4>
<p>如果你使用BeanFactory，如 XmlBeanFactory 作为 Spring Bean 的工厂类，则所有的 bean 都是在第一次使用该bean 的时候实例化 。</p>
<p>如果你使用 ApplicationContext 作为 Spring Bean 的工厂类，则又分为以下几种情况：</p>
<ol>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 false（默认是false，所以可以不用设置），则ApplicationContext 启动的时候就实例化该 bean，并且将实例化的 bean 放在一个线程安全的 ConcurrentHashMap 结构的缓存中，下次再使用该 Bean 的时候，直接从这个缓存中取</li>
<li>如果 bean 的 scope 是 singleton 的，并且 lazy-init 为 true，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化</li>
<li>如果 bean 的 scope 是 prototype 的，则该 bean 的实例化是在第一次使用该 bean 的时候进行实例化 。</li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../CH03-Bean%E5%8A%A0%E8%BD%BD/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              CH03-Bean加载
            </div>
          </div>
        </a>
      
      
        <a href="../CH05-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              CH05-循环依赖
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2013 - 2021 Infilos
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/squidfunk" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://github.com/infilow/relax-authentic" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  <script src="../../assets/javascripts/bundle.3b3ca511.min.js"></script>

  </body>
</html>