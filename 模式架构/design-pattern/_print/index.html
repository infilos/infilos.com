<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.4">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84/design-pattern/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>设计模式 | infilos.com</title><meta property="og:title" content="设计模式">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84/design-pattern/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="设计模式">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="设计模式">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84/design-pattern/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>设计模式</h1>
<ul>
<li>1: <a href=#pg-7056cc7a4d53bc129256824af8ff738c>Java 模式</a></li>
<ul>
<li>1.1: <a href=#pg-88a2fe056dd40a9f98a301beb5469e12>CH01-创建型-简单工厂</a></li>
<li>1.2: <a href=#pg-98be543be4e36265ff8e131d9059969b>CH02-创建型-工厂方法</a></li>
<li>1.3: <a href=#pg-bd99bea640ef28468b1c96c0e389a0ff>CH03-创建型-抽象工厂</a></li>
<li>1.4: <a href=#pg-2710de74cae3f674e26a05d1dac20256>CH04-创建型-建造者</a></li>
<li>1.5: <a href=#pg-86b8b3fba215869b86d2d5534dab27d2>CH05-创建型-单例</a></li>
<li>1.6: <a href=#pg-928f5ffc3cdc979f8cdc3be93afece69>CH06-结构型-适配器</a></li>
<li>1.7: <a href=#pg-acaea6d7bde942602601eb017c43c6ac>CH07-结构型-桥接</a></li>
<li>1.8: <a href=#pg-db2f137fa81198994fcaf3cd93b41f61>CH08-结构型-装饰器</a></li>
<li>1.9: <a href=#pg-490ca18d71ef644e626a4a891a3856c3>CH09-结构型-外观</a></li>
<li>1.10: <a href=#pg-4e15f0bfa5f085fcbd4bbb2e4aa4e8ca>CH10-结构型-享元</a></li>
<li>1.11: <a href=#pg-3c2abf60a670073abcce87e0c3c1387f>CH11-结构型-代理</a></li>
<li>1.12: <a href=#pg-93102814bf1adf2a6722e241db588658>CH12-行为型-命令</a></li>
<li>1.13: <a href=#pg-f7d3aa04369806d95d4ec83c84c7333f>CH13-行为型-中介者</a></li>
<li>1.14: <a href=#pg-b67053751f5655bf0729d66618a09a90>CH14-行为型-观察者</a></li>
<li>1.15: <a href=#pg-59313ad332a3d6ac44bee1940613da82>CH15-行为型-状态</a></li>
<li>1.16: <a href=#pg-f17fad01d0380c6b978ba3db030b5483>CH16-行为型-策略</a></li>
</ul>
<li>2: <a href=#pg-1ded6ad8722dec4ccfd8cfad029dfa34>Scala 模式</a></li>
<ul>
<li>2.1: <a href=#pg-6e9693b6bf199f21c4c977e3c03535b0>CH01-模式分类</a></li>
<li>2.2: <a href=#pg-c4fd4d2414cb10a1b7819f3298f7f905>CH02-特质与混入组合</a></li>
<li>2.3: <a href=#pg-7cf846c344c0c6fa6b0f9ee2fd2cd967>CH03-统一化</a></li>
<li>2.4: <a href=#pg-f55e2bf3655f2a5ab93d8fc9f3412bfb>CH04-抽象与自类型</a></li>
<li>2.5: <a href=#pg-76b78cfc1fc291e4e7f1767a8c507fef>CH05-AOP 与组件</a></li>
<li>2.6: <a href=#pg-8eefa8c04facc238b6904fb8fe805849>CH06-创建型模式</a></li>
<li>2.7: <a href=#pg-0d4d31b471daba329c041c1a13ee6b99>CH06-1-工厂方法</a></li>
<li>2.8: <a href=#pg-ac19cd3f0dc7118f99838d6543265c58>CH06-2-抽象工厂</a></li>
<li>2.9: <a href=#pg-c5235bad7f7368119f7e5795ce0d98c6>CH06-3-其他工厂模式</a></li>
<li>2.10: <a href=#pg-12a0eb547c44a6cd9dc7862b732ae30a>CH06-4-懒初始化</a></li>
<li>2.11: <a href=#pg-331ada1c3d2231c55463d61a02d79d18>CH06-5-单例模式</a></li>
<li>2.12: <a href=#pg-c1ebea1c5fbeb4f13a93ebbd71fefdc9>CH06-6-构建器模式</a></li>
<li>2.13: <a href=#pg-e34756daf85416be13164f59a068ab7b>CH06-7-原型模式</a></li>
<li>2.14: <a href=#pg-dcd62209992869cc87e43e70049f1fad>CH07-结构型模式</a></li>
<li>2.15: <a href=#pg-55ef6d7fe806536a06e886ff51323931>CH07-1-适配器模式</a></li>
<li>2.16: <a href=#pg-ebcc881e76da36672713163521dfbc8b>CH07-2-装饰器模式</a></li>
<li>2.17: <a href=#pg-197cde039b5eaa221773406d44e4eb63>CH07-3-桥接模式</a></li>
<li>2.18: <a href=#pg-c770d6e53018726100b55556d9599025>CH07-4-组合模式</a></li>
<li>2.19: <a href=#pg-7cdfc9bbc082469dd414787b2cf41a73>CH07-5-外观模式</a></li>
<li>2.20: <a href=#pg-e29e76383011b6e986605e8d53329161>CH07-6-享元模式</a></li>
<li>2.21: <a href=#pg-f09b2a63cbb1f15437f23ef4eaf4b40c>CH07-7-代理模式</a></li>
<li>2.22: <a href=#pg-deab981b6d4fa0b088c28d95ed21f010>CH08-行为型模式-1</a></li>
<li>2.23: <a href=#pg-ecdea902c568d3f06103804c1d17dbe3>CH09-行为型模式-2</a></li>
<li>2.24: <a href=#pg-15b88e04d349a5f8e8de86b4a8e97283>CH10-函数式模式理论</a></li>
<li>2.25: <a href=#pg-3c543f72b3cd75fdfd89fb6fec23203e>CH11-函数式模式应用</a></li>
<li>2.26: <a href=#pg-198e982211f90ca13626d2c25bfd5ed9>CH12-实际应用</a></li>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-7056cc7a4d53bc129256824af8ff738c>1 - Java 模式</h1>
</div>
<div class=td-content>
<h1 id=pg-88a2fe056dd40a9f98a301beb5469e12>1.1 - CH01-创建型-简单工厂</h1>
<h2 id=创建型模式概述>创建型模式概述</h2>
<p>创建型模式(Creational Pattern)对类的实例化过程进行了抽象，能够将软件模块中对象的创建和使用分离。为了使软件的结构更加清晰，外界对于这些对象只需要知道他们的共同接口，而不清楚其具体细节，使整个系统的设计更加符合单一职责原则。</p>
<p>该模式在创建什么(what)、由谁创建(who)、何时创建(when)等方面都为软件设计者提供了尽可能大的灵活性。创建型模式隐藏了类实例的创建细节，通过隐藏对象如何被创建和组合在一起达到使整个系统独立的目的。</p>
<h2 id=简单工厂simple-factory-pattern>简单工厂(Simple Factory Pattern)</h2>
<h3 id=模式动机>模式动机</h3>
<p>比如一个软件系统可以提供多个外观不同的按钮(圆形、矩形、菱形等)，这些按钮都源自同一个基类，在继承基类后不同的子类修改了部分属性从而使得他们可以呈现不同的外观，如我们在使用这些按钮时，不需要知道这些具体按钮类的名字，只需要知道表示该按钮类的一个参数，并提供一个调用方便的方法，把参数传入该方法即可返回一个相应的按钮对象，这时就可以使用该模式。</p>
<h3 id=模式定义>模式定义</h3>
<p>又称为<strong>静态工厂方法(Static Factory Method)</strong>，它属于类创建型模式。该模式中，可以根据参数的不同返回不同类的实例。简单工厂模式专门定义一个类来负责创建其他类的实例，这些被创建的实例通常拥有共同的父类。</p>
<h3 id=模式结构>模式结构</h3>
<p>简单工厂模式包含如下角色：</p>
<ul>
<li>
<p>Factory：工厂角色</p>
<p>负责实现创建所有实例的内部逻辑。</p>
</li>
<li>
<p>Produce：抽象产品角色</p>
<p>是创建的所有对象的父类，负责描述所有实例所共有的公共接口</p>
</li>
<li>
<p>ConcreteProduce：具体产品角色</p>
<p>是创建目标，所有创建的对象多充当这个角色某个具体类的实例</p>
</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220133908.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220133938.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码实例>代码实例</h3>
<h4 id=c>C++</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;Factory.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;ConcreteProductA.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;ConcreteProductB.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Product</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>Factory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>createProduct</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span> <span style=color:#000>proname</span><span style=color:#000;font-weight:700>){</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span> <span style=color:#4e9a06>&#34;A&#34;</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>proname</span> <span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcreteProductA</span><span style=color:#000;font-weight:700>();</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;B&#34;</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>proname</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcreteProductB</span><span style=color:#000;font-weight:700>();</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span>  <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=模式分析>模式分析</h3>
<ul>
<li>将<strong>对象的创建</strong>和<strong>对象的业务处理</strong>分离可以降低系统的耦合度，使得两者修改起来更简便。</li>
<li>在调用工厂类的工厂方法时，由于工厂方法是静态方法，使用方便，可通过类名直接调用，而且只需要传入一个简单的参数即可。在实际开发中，还可以在调用时将所传入的参数保存在 XML 等配置文件中，修改参数时无需修改任何源代码。</li>
<li>该模式最大的问题在于工厂类的职责过重，增加新的产品需要修改工厂类的逻辑判断，这一点与<strong>开闭原则</strong>是相违背的。</li>
<li>该模式的要点在于：当你需要什么，只需要传入一个正确的参数，就可以获得你需要的对象，而无需知道其创建细节。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>工厂类含有必要的逻辑判断，可以决定什么时候(条件)创建什么类的实例，客户端可以免除直接创建产品对象的责任，而仅仅“消费”(使用)产品。通过这种方式实现对责任的分割，提供专门的工厂类用于创建对象。</li>
<li>客户端无需知道所创建的具体产品类的类名，只需要知道具体产品类对应的参数即可，对于一些复杂的类名，通过该模式可以减少使用者的记忆量。</li>
<li>通过引入配置文件，可以在不修改任何客户端代码的情况下更换个增加新的产品类，在一定程度上提高了系统的灵活性。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>由于工厂类中集中了所有产品类的创建逻辑，一旦不能正常工作，将影响整个系统。</li>
<li>该模式将会增加系统中类的个数，在一定程度上增加了系统的复杂度和立即难度。</li>
<li>系统扩展困难，一旦添加新的产品类则必须修改工厂逻辑，在产品类型较多时，有可能造成工厂逻辑较为复杂，不利于系统的扩展和维护。</li>
<li>由于使用了静态工厂方法，造成工厂角色无法形成基于继承的等级结构。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>工厂类负责创建的对象比较少：由于创建的对象类别少，不会造成工厂方法中的业务逻辑太过复杂。</li>
<li>客户端只知道传入工厂类的参数，对于如何创建对象不关心：客户端既不需要关心创建细节，也不需要知道类名，只需要知道该类型需要的参数。</li>
</ul>
<h3 id=模式应用>模式应用</h3>
<ol>
<li>
<p>JDK 类库中广泛使用了该模式，如工具类<code>java.text.DateFormat</code>，用于格式化一个本地日期：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateFormat</span> <span style=color:#000>getDateInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateFormat</span> <span style=color:#000>getDateInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>style</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>DateFormat</span> <span style=color:#000>getDateInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>style</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Local</span> <span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li>
<li>
<p>Java 加密技术：</p>
<ol>
<li>
<p>获取不同加密算法的密钥生成器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>KeyGenerator</span> <span style=color:#000>keyGen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>KeyGenerator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DESede&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li>
<li>
<p>创建密码器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Cipher</span> <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Cipher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DESede&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li>
</ol>
</li>
</ol>
<h3 id=总结>总结</h3>
<ul>
<li>创建型模式对类的实例化过程进行了抽象，能够将对象的创建与对象的使用分离。</li>
<li>简单工厂模式又称为静态工厂方法模式，属于类创建型模式。在该模式中，可以根据参数的不同返回不同类的实例。同时专门定义了一个类来负责创建其他类的实例，被创建的实例通常都具有共同的父类。</li>
<li>包含三个角色：<strong>工厂角色</strong>负责实现创建所有实例的内部逻辑；<strong>抽象产品角色</strong>是需要创建的所有类的父类，负责描述所有实例所共有的公共接口；<strong>具体产品角色</strong>是创建目标，所有创建的对象都充当这个角色某个具体类的实例。</li>
<li>要点在于：当你需要什么，只需要传入对应正确的参数，就可以获得对应的对象，而无需知道创建细节。</li>
<li>有点在于：将对象的创建与使用分离，将对象的创建交给工厂类负责，但是其最大的缺点在于工厂类不够灵活，增加新的具体产品则需要修改工厂的判断逻辑，当产品较多时，逻辑将会复杂。</li>
<li>适用场景：工厂类需要创建的对象比较少；客户端只知道传入工厂类的参数，对于创建过程不关心。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-98be543be4e36265ff8e131d9059969b>1.2 - CH02-创建型-工厂方法</h1>
<h3 id=模式动机>模式动机</h3>
<p>针对“1-简单工厂”中提到的系统进行修改，不再使用一个按钮工厂类来统一负责所有产品的创建，而是将具体按钮的创建过程交给专门的工厂子类去完成。首先定义一个抽象的按钮工厂类，再定义具体的工厂类来生成圆形、矩形、菱形按钮等，这些具体的工厂类会实现抽象工厂类中定义的方法。</p>
<p>这种抽象化的结构可以在不修改具体工厂类的情况下引入新的产品，如果出现新的按钮类型，只需要为这种新的按钮类型创建对应的工厂类即可获得该新按钮的实例。因此，使得工厂方法模式具有超越简单工厂的优越性，更加符合<strong>开闭原则</strong>。</p>
<h3 id=模式定义>模式定义</h3>
<p>**工厂方法模式(Factory Method Pattern)**又称工厂模式，或虚拟构造器(Virtual Constructor)模式、多态工厂(Polymorphic Factory)，属于类创建型模式。该模式中，工厂父类负责负责定义创建产品对象的公共接口，而工厂子类则负责生成具体的产品对象，将产品类的实例化操作延迟到工厂子类中完成，即通过工厂子类来确定究竟应该实例化哪个具体产品类。</p>
<h3 id=模式结构>模式结构</h3>
<p>工厂方法包含的角色：</p>
<ol>
<li>Product：抽象产品</li>
<li>ConcreteProduct：具体产品</li>
<li>Factory：抽象工厂</li>
<li>ConcreteFactory：具体工厂</li>
</ol>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134030.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134046.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码示例>代码示例</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;ConcreteFactory.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;ConcreteProduct.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>Product</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ConcreteFactory</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>factoryMethod</span><span style=color:#000;font-weight:700>(){</span>

	<span style=color:#204a87;font-weight:700>return</span>  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcreteProduct</span><span style=color:#000;font-weight:700>();</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;Factory.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;ConcreteFactory.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;Product.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;iostream&gt;</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#204a87;font-weight:700>namespace</span> <span style=color:#000>std</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>argv</span><span style=color:#000;font-weight:700>[])</span>
<span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Factory</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>fc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcreteFactory</span><span style=color:#000;font-weight:700>();</span>
	<span style=color:#000>Product</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>prod</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fc</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>factoryMethod</span><span style=color:#000;font-weight:700>();</span>
	<span style=color:#000>prod</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>use</span><span style=color:#000;font-weight:700>();</span>
	
	<span style=color:#204a87;font-weight:700>delete</span> <span style=color:#000>fc</span><span style=color:#000;font-weight:700>;</span>
	<span style=color:#204a87;font-weight:700>delete</span> <span style=color:#000>prod</span><span style=color:#000;font-weight:700>;</span>
	
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=模式分析>模式分析</h3>
<p>由于使用了面向对象的多态性，工厂方法模式保持了简单工厂模式的优点，而且克服了它的缺点。在该模式中，核心的工厂类不再负责所有产品的创建，而是将具体创建工作交给子类去做。这个核心类仅仅负责给出具体工厂必须实现的接口，而不负责哪一个产品类被实例化这个细节，使得工厂方法模式可以允许系统在不修改工厂角色的情况下引进新产品。</p>
<h3 id=实例>实例</h3>
<h4 id=日志记录器>日志记录器</h4>
<p>某系统日志记录器要求支持多种日志记录方式，如文件、数据库等。且用户可以根据要求动态选择日志记录方式，使用工厂方法进行设计：</p>
<p>类图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134111.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>时序图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134127.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=优点>优点</h3>
<ul>
<li>该模式中，工厂方法用来创建用户所需要的产品，同时还向客户隐藏了哪种具体产品类将被实例化这一细节，用户只需要关心所需产品对应的工厂，无需关心创建细节，甚至无需知道具体产品类的类名。</li>
<li>基于工厂角色和产品角色的多态性设计是工厂方法模式的关键。它能使工厂可以自主确定创建何种产品对象，而如何创建这个对象的细节则完全封装在具体工厂内部。</li>
<li>在加入新产品时，无需修改抽象工厂和抽象产品提供的接口，无需修改客户端，也无需修改其他的具体工厂和具体产品，只需要添加一个具体工厂和具体产品就可以了。增加了扩展性，符合开闭原则。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>在添加新产品时需要编写新的产品类，还要提供于此对应的具体工厂类，类的个数会成对增加，一定程度上增加了复杂性。</li>
<li>引入了抽象层，客户端的代码均使用抽象层进行定义，增加了系统的抽象性和理解难度。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>无需知道需要创建对象的类：该模式中，客户端不需要知道具体产品类的类名，只需要知道他对应的工厂即可，具体的产品对象由具体工厂类创建。</li>
<li>通过子类来指定创建哪个对象：该模式中，对于抽象工厂类只需要提供一个创建产品的接口，由其子类来确定具体要创建的对象，利用面向对象的多态性和里氏替换原则，在程序运行时，子类对象将覆盖父类对象，从而使系统更易扩展。</li>
<li>将创建对象的任务委托给多个工厂子类中的某一个，客户端在使用时无需关心是哪个工厂子类来创建产品子类，需要时再动态指定，可将具体工厂类的类名存储在配置文件或数据库中。</li>
</ul>
<h3 id=模式应用>模式应用</h3>
<p>JDBC 中的工厂方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Connection</span> <span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbc:microsoft:sqlserver://localhost:1433;DatabaseName=DB;user=sa;password=&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Statement</span> <span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createStatement</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ResultSet</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>statement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select * from UserInfo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h3 id=模式扩展>模式扩展</h3>
<ul>
<li>使用多个工厂方法：才抽象工厂中可以定义多个工厂方法，从而使具体工厂角色实现这些不同的工厂方法，这些方法可以包含不同的业务逻辑，以满足不同的产品对象的需求。</li>
<li>产品对象的重复使用：工厂对象将已创建过的产品保存到一个集合，然后根据客户端对产品的请求，对集合进行查询。</li>
<li>多态性的丧失和模式的退化：如果工厂仅仅返回一个具体产品对象，便违背了工厂方法的用意，发生退化，此时就不再是工厂方法模式了。工厂对象应该有一个抽象的父类型，如果工厂等级结构中只有一个工厂类的话，抽象工厂可以省略，则发生退化；当只有一个具体工厂，在具体工厂中创建所有产品对象，并且工厂方法设计为静态方法时，该模式就退化成了简单工厂模式。</li>
</ul>
<h3 id=总结>总结</h3>
<ul>
<li>工厂方法模式又称为工厂模式，属于类创建型模式。该模式中，工厂父类负责定义创建产品对象的公共接口，而工厂子类则负责生成具体的产品对象，以将产品类的实例化操作延迟到工厂子类中完成，即通过工厂子类来确定究竟应该实例化哪一个具体产品类。</li>
<li>工厂方法模式包含四个角色：
<ol>
<li><strong>抽象产品</strong>是定义产品的接口，是工厂方法模式所创建对象的超类型，即产品对象的共同父类或接口；</li>
<li><strong>具体产品</strong>实现了抽象产品接口，某种类型的具体具体产品由专门的具体工厂创建，他们之间往往<strong>一一对应</strong>；</li>
<li><strong>抽象工厂</strong>中声明了工厂方法，用于返回一个产品，它是该模式的核心，任何在模式中创建对象的工厂类都必须实现该接口；</li>
<li><strong>具体工厂</strong>是抽象工厂的子类，实现了抽象工厂中定义的方法，并可由客户调用，返回一个具体产品类的实例。</li>
</ol>
</li>
<li>该模式是简单工厂模式的进一步抽象和推广。由于使用了面向对象的多态性，工厂方法模式保持了简单工厂模式的优点，同时克服了它的缺点。核心的工厂类不再负责创建所有类型的产品，而是将其创建交给具体子类去做。该核心类仅负责给出具体工厂必须实现的接口，而不负责产品类被实例化这种细节，这使得该模式可以允许系统在不修改工厂角色的情况下引进新产品。</li>
<li>主要优点是增加新产品而无需修改现有系统，并封装了产品对象的创建细节，系统具有良好的灵活性和可扩展性；缺点在于增加新产品的同时需要增加对应的具体工厂，导致类的个数增长，一定程度上增加了系统的复杂性。</li>
<li>该模式适合的情况包括：一个类不知道他所需要的对象的类；一个类通过其子类来指定创建哪个对象；将创建对象的任务委托给多个工厂子类中的某一个，客户端在使用时可以无需关心是哪一个工厂子类创建产品子类，需要时再动态绑定。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-bd99bea640ef28468b1c96c0e389a0ff>1.3 - CH03-创建型-抽象工厂</h1>
<h3 id=模式动机>模式动机</h3>
<ul>
<li>
<p>在工厂方法模式中，具体工厂负责生成具体的产品，每个具体工厂对应一个具体产品，工厂方法也具有唯一性，一般情况下，一个具体工厂中只有一个工厂方法或一组重载的工厂方法。但是有些时候我们需要一个工厂能够提供多个产品对象，而不是一个单一的产品对象。</p>
<p>为了清晰理解工厂方法模式，需要知道两个概念：</p>
<ol>
<li><strong>产品等级结构</strong>：产品等级结构即产品的继承结构（如一个抽象类是电视机，其子类有：海尔、海信、TCL等，抽象电视机与对应品牌的电视机即构成了产品等级结构）。</li>
<li><strong>产品族</strong>：在抽象工厂模式中，产品族是指<strong>由一个工厂生产的，位于不同产品等级结构中的一组产品</strong>。如海尔电器工厂生产的电视机、电冰箱，海尔电视机位于电视机产品等级结构中，海尔电冰箱位于电冰箱产品等级结构中。</li>
</ol>
</li>
<li>
<p>当系统提供的工厂需要生产的具体产品并不是一个简单的对象，而是多个位于不同产品等级结构中、属于不同类型的具体产品时，需要使用抽象工厂模式。</p>
</li>
<li>
<p>该模式是所有形式的工厂模式中最为抽象和最具一般性的形态。</p>
</li>
<li>
<p>抽象工厂模式与工厂方法模式最大的区别在于：工厂方法模式针对的是一个产品等级结构，而抽象工厂模式需要面对多个产品等级结构，一个工厂等级结构，可以负责多个不同产品等级结构中的产品对象的创建。当一个工厂等级结构(海尔电器工厂)，可以创建出分属不同产品等级结构的 一个产品族中的所有对象(电视机、电冰箱)时，抽象工厂模式比工厂方法模式更有效率。</p>
</li>
</ul>
<h3 id=模式定义>模式定义</h3>
<p>抽象工厂模式(Abstract Factory Pattern)：提供一个 创建一系列相关或相互依赖对象 的接口，而无需指定他们的具体类。又称为 Kit 模式。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含如下角色：</p>
<ul>
<li>AbstractFactory：抽象工厂</li>
<li>ConcreteFactory：具体工厂</li>
<li>AbstractProduct：抽象产品</li>
<li>Product：具体产品</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134229.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>解释：</p>
<ul>
<li>AbstractFactory 可以理解为 电器工厂；</li>
<li>ConcreteFactory1 可以理解为 海尔电器工厂；</li>
<li>ConcreteFactory2 可以理解为 格力电器工厂；</li>
<li>AbstractProductA 理解为产品 电视机；</li>
<li>AbstractProductB 理解为产品 电冰箱；</li>
<li>ProductA1 则为 海尔牌电视机；</li>
<li>ProductA2 则为 格力牌电视机；</li>
<li>ProductB1 则为 海尔牌电冰箱；</li>
<li>ProductB2 则为 格力牌电视机；</li>
</ul>
<p>因此，海尔电器工厂 可以生产 海尔牌的电视机和电冰箱，同理格力电器工厂。这样，产品等级结构(电视机、电冰箱)和产品族(海尔牌、格力牌)通过两种维度实现对产品的建模。</p>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134250.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=优点>优点</h3>
<ul>
<li>抽象工厂模式隔离了具体类的生产，使得客户端并不知道什么被创建。由于这种隔离，更换一个具体工厂就变得相对容易。所有的具体工厂都实现了抽象工厂中定义的那些公共接口，因此只需改变具体工厂的实例，就可以从某种程度上改变整个系统的行为。同时该模式可以实现<strong>高内聚低耦合</strong>的实际目的，因此该模式被广泛应用。</li>
<li>当一个产品族中的多个对象被设计成一起工作时，它能够保证客户端始终只使用一个产品族中的对象。这对一些需要根据当前环境来决定其行为的软件系统来说，是一种非常实用的设计模式。</li>
<li>增加新的具体工厂和产品族非常方便，无需修改已有系统，符合<strong>开闭原则</strong>。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>在添加新的产品对象时，难以扩展抽象工厂来生产新种类的产品，这是因为在抽象工厂角色中规定了所有可能被创建的产品集合，要支持新种类的产品就要对该接口进行扩展，这会涉及到对抽象工厂角色及其所有子类进行修改，会带来较大不便。</li>
<li>开闭原则的倾斜性，增加新的工厂和产品族容易，增加新的产品等级结构麻烦。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>当一个系统不需要依赖于产品类实例如何被创建、组合、表达的细节，这对于所有形式的工厂模式都是重要的。</li>
<li>系统中有多于一个的产品族，而每次只适用其中一个产品族。</li>
<li>属于同一个产品族的产品将在一起使用，这一约束必须在系统的设计中体现出来。</li>
<li>系统提供一个产品类的库，所有的产品以同样的接口出现，从而使客户端不依赖于实现。</li>
</ul>
<h3 id=模式应用>模式应用</h3>
<p>比如一些软件系统中需要更换系统主题，要求界面中的按钮、文本框、背景等一起发生改变时，就可以使用该模式。比如：按钮元素的不同形式构成一个产品等级结构，不同元素的同一主题形式构成一个产品族。</p>
<h3 id=模式扩展>模式扩展</h3>
<p><strong>开闭原则</strong>的倾斜性：</p>
<ul>
<li>开闭原则要求对系统扩展开发，对修改关闭，通过扩展达到增强其功能的目的。对于涉及到多个产品族与多个产品等级结构的系统，其功能增强则包括两方面：
<ol>
<li>增加产品族：对于增加新的产品族，本模式很好的支持了开闭原则，只需要增加一个新的具体工厂即可，对已有代码无需做任何修改；</li>
<li>增加产品等级结构：对于增加新的产品等级结构，需要修改所有的工厂角色，包括抽象工厂类，在所有的工厂类中都需要增加生成新产品的方法，不能很好的支持开闭原则。</li>
</ol>
</li>
<li>抽象工厂模式的这种性质称为<strong>开闭原则的倾斜性</strong>，该模式以一种倾斜的方式来支持增加新的产品，为新产品族的增加提供方便，但不能为新的产品等级结构增加提供方便。</li>
</ul>
<p>工厂模式退化：</p>
<ul>
<li>当抽象工厂模式中每一个具体工厂类只创建一个产品对象，也就是只存在一个产品等级结构时，该模式也就退化成了工厂方法模式；</li>
<li>当工厂方法模式中抽象工厂与具体工厂合并，提供一个统一的工厂来创建产品对象，并将创建产品的方法设计为静态方法时，工厂方法模式退化成简单工厂模式。</li>
</ul>
<h3 id=总结>总结</h3>
<ul>
<li>该模式提供了一个创建一系列相关或相互依赖对象的接口，而无需指定他们的具体类。</li>
<li>包含四种角色。</li>
<li>是所有形式的工厂模式中最为抽象和最具一般性的一种形态。</li>
<li>主要优点是隔离了具体类的生成，使得客户端不知道什么被创建。</li>
<li>。。。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2710de74cae3f674e26a05d1dac20256>1.4 - CH04-创建型-建造者</h1>
<h3 id=模式动机>模式动机</h3>
<p>一些复杂的对象，拥有多个组成部分，比如汽车，包括车轮、方向盘、发动机等。对于大多数用户而言，无需知道这些部件的装配细节，也几乎不会使用单独某个部件，而是使用一辆完整的汽车。可以通过建造者模式对其进行设计与描述，建造者模式可以将其部件和其组装过程分开，逐步创建一个对象。用户只需要指定复杂对象的类型就可以得到该对象，而无需知道其内部的具体构造细节。</p>
<p>软件系统中也存在大量类似汽车的复杂对象，拥有一系列成员和属性，这些成员属性中有些是引用类型的成员对象。而且这些复杂对象中，还可能存在一些限制条件，如某些属性赋值则复杂对象不能作为一个完整的产品使用；有些属性的赋值必须按照某个顺序，一个属性没有赋值之前，另一个属性可能无法赋值等。</p>
<p>复杂对象相当于一辆有待建造的汽车，而对象的属性相当于汽车的部件，建造产品的过程就相当于组合部件的过程。由于组合部件的过程很复杂，因此，这些部件的组合过程往往被“外部化”到一个称为<strong>建造者</strong>的对象里，建造者返还给客户端的是一个已经建造完毕的完整产品对象，而用户无需关心该对象所包含的属性以及他们的组装方式，这就是建造者模式的模式动机。</p>
<h3 id=模式定义>模式定义</h3>
<p><strong>建造者模式(Builder Pattern)</strong>，将一个复杂对象的构建与他的表示分离，使得同样的构建过程可以创建不同的表示。</p>
<p>该模式是逐步创建一个复杂对象，允许用户只通过指定复杂对象的类型和内容就可以构建他们，而不需要知道他们内部的具体构建细节。又称为<strong>生成器模式</strong>。</p>
<h3 id=模式结构>模式结构</h3>
<ul>
<li>Builder：抽象建造者</li>
<li>ConcreteBuilder：具体建造者</li>
<li>Director：指挥者</li>
<li>Product：产品角色</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134317.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134335.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码示例>代码示例</h3>
<p>抽象建造者：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildHead</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildBody</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildFoot</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#000>Persion</span> <span style=color:#000>buildPerson</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>具体建造者 1：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ManBuilder</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Person</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ManBuilder</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Man</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildBody</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set man&#39;s body&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildFoot</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFoot</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set man&#39;s foot&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildHead</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set man&#39;s head&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Person</span> <span style=color:#000>buildPerson</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>具体建造者 2：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WomanBuilder</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Person</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>WomanBuilder</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Woman</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildBody</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set woman&#39;s body&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildFoot</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFoot</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set woman&#39;s foot&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>buildHead</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;set woman&#39;s head&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Person</span> <span style=color:#000>buildPerson</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>指挥者：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PersonDirector</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Person</span> <span style=color:#000>constructPerson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PersonBuilder</span> <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildHead</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildBody</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildFoot</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buildPerson</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>产品：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>foot</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setBody</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>body</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFoot</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>foot</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>foot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>foot</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Man</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Man</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Start building Man&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Woman</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Woman</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Start building Woman&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>用例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Usage</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#000>PersonDirector</span> <span style=color:#000>pd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonDirector</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Person</span> <span style=color:#000>manPerson</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructPerson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ManBuilder</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>Person</span> <span style=color:#000>womanPerson</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructPerson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WomanBuilder</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=模式分析>模式分析</h3>
<p>抽象建造者类中定义了产品的创建方法和返回方法。</p>
<p>建造者模式的结构中还引入了一个指挥者类 Director，该类作用主要有两个：一方面将客户端与产品生产过程；另一方面负责整个产品的生产过程。</p>
<p>指挥者针对抽象建造者编程，客户端只需要提供具体建造者的类型，即可通过指挥者来调用具体建造者的方法，返回一个完整的产品对象。</p>
<p>在客户端代码中，则不需要关心产品具体的生产过程，只需要提供具体建造者类型来调用指挥者的创建方法。建造者模式将复杂对象的构建与对象的表现分离开来，这使得同样的构建过程可以创建出不同的表现。</p>
<h3 id=实例>实例</h3>
<h4 id=kfc-套餐>KFC 套餐</h4>
<p>套餐看做是一个复杂对象，一般包括主食(汉堡、鸡肉卷等)和饮料(果汁、可乐等)等组成部分，服务员可以根据要求，逐步装配这些组成部分，构造一份完整的套餐，然后返回给顾客。</p>
<p>类图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134351.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=优点>优点</h3>
<ul>
<li>客户端不必知道产品内部的组成细节，将产品本身与产品的创建过程解耦，使得<strong>相同的创建过程</strong>(由父类创建者约束了创建该过程)可以创建不同的产品对象。</li>
<li>每一个具体建造者都相对独立，与其他的具体建造者无关，因此可以很方便的替换具体建造者或者增加新的具体建造者，<strong>用户使用不同的具体建造者即可得到不同的产品对象。</strong></li>
<li>**可以更加精细的控制产品的创建过程。**将复杂产品的的创建步骤分解在不同的方法中，使得创建过程更加清晰，也更方便使用程序来控制创建过程。</li>
<li>**增加新的具体创建者无需修改原有代码，指挥者针对抽象建造者编程。**系统扩展方便，符合开闭原则。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>建造者模式所创建的产品一般具有较多的共同点，其组成部分相似，如果产品之间的差异性很大，则不适合使用建造者模式。</li>
<li>如果产品的内部变化复杂，可能需要定义很多具体建造者来实现这些变化，导致系统庞大。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>需要生产的产品有复杂的内部结构，产品通常包含多个成员属性。</li>
<li>需要生产的额产品，其属性相互依赖，需要制定生成顺序。</li>
<li>对象的创建过程独立于创建该对象的类。在该模式中引入了指挥者类，将创建过程封装在指挥者类中，而不再建造者中。</li>
<li>隔离复杂对象的创建和使用，并使得相同的创建过程可以创建不同的产品。</li>
</ul>
<h3 id=模式扩展>模式扩展</h3>
<p>建造者模式的简化：</p>
<ul>
<li>省略掉抽象建造角色：如果系统中只需要一个具体建造者的话。</li>
<li>省略掉指挥者：在具体建造者只有一个的情况下，如果抽象建造者以及被省略掉，那么还可以省略掉指挥者，让建造者充当指挥者与建造者角色。</li>
</ul>
<p>建造者模式与抽象工厂模式的比较：</p>
<ul>
<li>建造者返回一个组装好的完整产品，抽象工厂返回一系列相关的产品，这些产品位于不同的产品等级结构，构成一个产品族。</li>
<li>抽象工厂中，客户端实例化工厂类，然后调用工厂方法获取所需产品对象；建造者中，客户端通过指挥类而不是调用建造者的相关方法，侧重于逐步构造一个复杂对象。</li>
<li>如果将抽象工厂看做是“汽车配件生产工厂”，生产一个产品族的产品；建造者模式就是一个“汽车组装工厂”，通过对部件的组装返回一辆完整的汽车。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-86b8b3fba215869b86d2d5534dab27d2>1.5 - CH05-创建型-单例</h1>
<h3 id=模式动机>模式动机</h3>
<p>对于系统中的某些类来说，<strong>只有一个实例</strong>很重要。比如，系统中可以有多个打印任务，但是只能有一个正在工作的任务；一个系统只能有一个窗口管理器和文件系统；一个系统只能有一个计时器或 ID 生成器。</p>
<p>方式是让类自身负责保存它的唯一实例，保证没有其他实例被创建，并且提供一个访问该实例的方法。</p>
<h3 id=模式定义>模式定义</h3>
<p><strong>单例模式(Singleton Pattern)</strong>，确保某个类只有一个实例，而且自行实例化并向整个系统提供这个实例，这个类称为单例类，它提供全局访问的方法。</p>
<p>单例模式的要点有三个：类只能有一个实例；必须自行创建这个实例；必须向整个系统提供这个实例。</p>
<h3 id=模式结构>模式结构</h3>
<p>单例模式仅有一个角色：Singleton</p>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134417.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134428.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码实例>代码实例</h3>
<h3 id=模式分析>模式分析</h3>
<p>单例模式的目的是<strong>保证一个类仅有一个实例，并提供一个访问该实例的全局访问点</strong>。单例模式的角色只有一个，就是单例类-Singleton。单例类拥有一个私有构造函数，确保用户无法通过<code>new</code>关键字直接实例化它。该模式中<strong>包含一个静态私有成员变量与静态公共工厂方法</strong>，工厂方法负责检验实例是否存在并实例化自己，然后存储在静态成员变量中，以确保只有一个实例被创建。</p>
<p>在单例模式的实现过程中，需要注意一下要点：</p>
<ul>
<li>单例类的构造函数为私有；</li>
<li>提供一个自身的静态私有成员变量；</li>
<li>提供一个共有的静态工厂方法。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>提供了对唯一实例的受控访问。因为单例类封装了它唯一的实例，所以他可以严格控制客户端怎样以及何时访问它，并为设计及开发团队提供了共享的概念。</li>
<li>由于在系统内存中只存在一个对象，因此可以节约系统资源，对于一些需要频繁创建和销毁的对象，该模式可以提高系统性能。</li>
<li>允许可变数目的实例。可以基于单例模式进行扩展，使用与单例控制相似的方法来获得指定个数的对象实例。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>由于单例模式中没有抽象层，因此单例类的扩展有很大的困难。</li>
<li>单例类的职责过重，在一定程度上违背了<strong>单一职责原则</strong>。因为单例类既充当了工厂角色，提供了工厂方法，同时又充当产品角色，包含一些业务方法，将产品的创建和产品本身的功能融合到了一起。</li>
<li>滥用单例将带来一些负面问题，比如，为了节省资源将数据库连接池对象设计成单例类，可能会导致共享该连接池对象的程序过多而出现连接池溢出；如果该对象长期不使用将被 GC 回收，导致对象状态丢失。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>系统中只需要一个实例对象，如提供一个序列号生成器，或资源消耗太大而只能创建一个实例。</li>
<li>客户端调用类的单个实例只允许适用一个公共访问点，不能通过其他途径访问该实例。</li>
<li>系统中要求一个类只能有一个实例时才应当使用单例模式。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-928f5ffc3cdc979f8cdc3be93afece69>1.6 - CH06-结构型-适配器</h1>
<h3 id=模式动机>模式动机</h3>
<ul>
<li>在软件开发中采用<strong>类似于电源适配器的设计和编码技巧</strong>被称为适配器模式。</li>
<li>通常，客户端可以通过目标类的接口访问他所提供的服务。有时，现有的类可以满足客户类的功能需要，但是它所提供的接口不一定是客户类所期望的，这可能是现有类中方法名与目标类中定义的方法名不一致等原因导致的。</li>
<li>这时，现有的接口要转化为客户类期望的接口，这样保证了对现有类的重用。如果不进行这样的转化，客户类就不能利用现有类提供的功能，适配器用于完成这些转化。</li>
<li>在适配器模式中可以定义一个包装类，包装不兼容接口的对象，这个包装类即为适配器(Adapter)，他所包装的对象就是适配者(Adaptee)，即被适配的类。</li>
<li>适配器提供客户类需要的接口，适配器的实现就是<strong>把客户类的请求转化为对适配者的相应接口调用</strong>。也就是说：<strong>当客户类调用适配器的方法时，在适配器的内部将调用适配者的方法，而这个过程对客户端是透明的，客户端并不直接访问适配者类</strong>。因此，适配器可以使因为接口不兼容而不能交互的类完成兼容。即该模式的动机。</li>
</ul>
<h3 id=模式定义>模式定义</h3>
<p><strong>适配器模式(Adapter Pattern)</strong>，将一个接口转换为客户端期望的另一个接口，使接口不兼容的类可以在一起工作，别名为<strong>包装器(Wrapper)</strong>。该模式即可以作为类接口型模式，也可以作为对象结构型模式。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含如下角色：</p>
<ul>
<li>Target：目标抽象类</li>
<li>Adapter：适配器类</li>
<li>Adaptee：适配者类</li>
<li>Client：客户类</li>
</ul>
<h3 id=类图>类图</h3>
<p>分为<strong>对象适配器</strong>和<strong>类适配器</strong>两种实现：</p>
<h4 id=对象适配器>对象适配器</h4>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134456.png style=display:block;width:70% alt=NAME align=center>
</div>
<h4 id=类适配器>类适配器</h4>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134512.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134528.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码分析>代码分析</h3>
<p>对象适配器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>argv</span><span style=color:#000;font-weight:700>[]){</span>
  <span style=color:#000>Adaptee</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>adaptee</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Adaptee</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000>Target</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>target</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Adapter</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>adaptee</span><span style=color:#000;font-weight:700>);</span>
  <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>request</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=优点>优点</h3>
<ul>
<li>将目标类与适配者类解耦，通过引入一个适配器类来重用现有的适配者类，而无需修改原有代码；</li>
<li>增加了类的透明性和复用性，将具体的实现封装在适配者类中，对于客户端来说是透明的，而且提高了适配者的复用性。</li>
<li>灵活性和扩展性很好，通过使用配置文件，可以方便的更换适配器，也可以在不修改原有代码的基础上增加的的适配器类，完全符合“开闭原则”。</li>
</ul>
<p>类适配器模式的独特优点：</p>
<p>​ <strong>由于适配器类是适配者类的子类</strong>，因此可以在适配器类中置换一些适配者的方法，使得适配器的灵活性更强。</p>
<p>对象适配器模式的独特优点：</p>
<p>​ 一个对象适配器可以把多个不同的适配者适配到同一目标，也就是说，同一个适配器可以把适配者类和它的子类都适配到目标接口。</p>
<h3 id=缺点>缺点</h3>
<ul>
<li>类适配器的缺点：对于 Java、C# 等不支持多重继承的语言，一次只能适配一个适配者类，而且目标类只能为抽象类，不能为具体类，有一定局限性，不能将一个适配者类和其子类都适配到目标接口。</li>
<li>对象适配器的缺点：对类适配器相比，要想置换适配者类的方法不方便。如果一定要置换掉适配者类的一个或多个方法，就只好先做一个适配者类的子类，将适配者类的方法置换掉，然后把这个子类当做真正的适配者进行适配，实现复杂。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>需要使用现有类，而这些类的接口不符合系统的需要。</li>
<li>想要建立一个可重复使用的类，用于与一些彼此之间没有太大关联的类，包括一些可能在将来引进的类一起工作。</li>
</ul>
<h3 id=模式扩展>模式扩展</h3>
<p><strong>默认适配器模式(Default Adapter Pattern)</strong>，或称缺省适配器模式。当不需要全部实现接口提供的方法时，可先设计一个抽象类实现接口，并为该接口中每个方法提供一个默认实现(空方法)，该抽象类的子类则可以有选择的覆盖父类的某些方法来实现需求。适用于一个接口不想使用其所有的方法的情况，因此也称为单接口适配器模式。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-acaea6d7bde942602601eb017c43c6ac>1.7 - CH07-结构型-桥接</h1>
<h3 id=模式动机>模式动机</h3>
<p>设想如果要绘制矩形、圆形、椭圆、正方形，至少需要四种形状类，但是如果绘制的图形具有不同的颜色，此时至少有以下两种设计方案：</p>
<ol>
<li>为每一种形状都提供一套各种颜色的版本</li>
<li>根据实际需要对形状和颜色进行组合</li>
</ol>
<p>对于有两个变化维度的系统，采用第二种方案进行设计则类的个数更少，系统扩展也更方便。方案二即为桥接模式，该模式将继承关系转换为关联关系，减少耦合和编码量。</p>
<h3 id=模式定义>模式定义</h3>
<p><strong>桥接模式(Bridge Pattern)</strong>，将抽象部分与它的实现部分分离，使他们都可以独立变化。又称为<strong>柄体模式(Handle and Body)<strong>或</strong>接口模式(Interface)</strong>。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含四种角色：</p>
<ul>
<li>Abstraction：抽象类</li>
<li>RefinedAbstraction：扩充抽象类</li>
<li>Implementor：实现类接口</li>
<li>ConcreteImplementor：具体实现类</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134608.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134632.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码分析>代码分析</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>argv</span><span style=color:#000;font-weight:700>[]){</span>
  <span style=color:#000>Implementor</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>pImp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcreteImplementorA</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000>Abstraction</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>pa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RefinedAbstraction</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000>pa</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>operation</span><span style=color:#000;font-weight:700>();</span>
  
  <span style=color:#000>Abstraction</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>pb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RefinedAbstraction</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcreteImplementorB</span><span style=color:#000;font-weight:700>());</span>
  <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>operation</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=模式分析>模式分析</h3>
<p>理解桥接模式，重点需要理解<strong>如何将抽象化(Abstraction)和实现化(Implementation)解耦，使得二者可以独立的变化。</strong></p>
<ol>
<li><strong>抽象化</strong>：抽象化就是忽略一些信息，把不同的实体当做同样的实体对待，将对象的共同性质抽取出来形成类的过程即为抽象化；</li>
<li><strong>解耦</strong>：解耦就是将抽象化和实现化之间的耦合解脱开，或者将他们之间的强关联转换成弱关联，将两个角色之间的继承关系改为关联关系。桥接模式中的解耦，是指在一个软件系统的抽象化和实现化之间使用关联关系(组合、聚合)，而不是继承关系，从而使两者可以相互独立的变化，也就是桥接模式的动机。</li>
</ol>
<h3 id=实例>实例</h3>
<p>如果需要开发一个跨平台的视频播放器，可以在不同操作系统平台上播放多种格式的视频文件，常见的视频格式包括 MPEG、RMVB、AVI、WMV 等。</p>
<h3 id=优点>优点</h3>
<ul>
<li>分离抽象接口及其实现部分。</li>
<li>桥接模式有时类似于多继承方案，但是多继承方案违背了类的单一职责原则(一个类只有一个变化的原因)，复用性较差，而且多继承中类的个数非常庞大，桥接则是更好的方法。</li>
<li>提高了系统的可扩充性，在两个变化维度任意扩展一个维度，都不需要修改原有的系统。</li>
<li>实现细节对客户透明，可以对用户隐藏实现细节。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>桥接模式的引入会增加系统的理解与设计难度，由于聚合关联关系建立在抽象层，要求开发者针对抽象进行设计与编程。</li>
<li>要求正确识别出系统中两个独立变化的维度，使用范围有一定局限性。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>如果一个系统需要在构件的抽象化角色和具体化角色之间增加更多灵活性，避免在两个层次之间建立静态继承关系，通过桥接模式可以使他们在抽象层建立一个关联关系。</li>
<li>抽象化角色和实现化角色可以以继承的方式独立扩展而互不影响，在程序运行时可以动态将一个抽象化子类的对象和一个实现化子类的对象进行组合，即系统需要对抽象化角色和实现化角色进行动态耦合。</li>
<li>一个类存在两个独立变化的维度，且这两个维度都需要独立扩展。</li>
<li>虽然在系统中使用继承是没有问题的，但是由于抽象化角色和实现化角色需要独立变化，设计要求独立管理这两者。</li>
<li>对于那些不希望使用继承或因为多层继承导致系统类的个数急剧增加的系统，桥接模式尤为适用。</li>
</ul>
<h3 id=模式扩展>模式扩展</h3>
<p>适配器与桥接模式联用：</p>
<p>​ 桥接模式和适配器模式用于设计的不同阶段。桥接模式用于系统的初步设计，对于存在两个独立变化维度的类可以将其分为抽象化和实现化两个角色，使他们可以进行分别变化；在初步设计完成后，当发现系统与已有类无法协同工作时，可以使用适配器模式。有时也需要在设计初期使用适配器模式，尤其是在那些涉及大量第三方应用接口的时候。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-db2f137fa81198994fcaf3cd93b41f61>1.8 - CH08-结构型-装饰器</h1>
<h3 id=模式动机>模式动机</h3>
<p>一般有两种方式可以实现给一个类或对象增加行为：</p>
<ol>
<li>继承机制：通过继承一个类，使子类在拥有自身方法的同时拥有父类的方法。但是这种方式是静态的，用户不能控制增加行为的方式和时机。</li>
<li>关联机制：即将一个类的对象嵌入到另一个对象中，由另一个对象来决定是否调用嵌入对象的行为以便扩展自己的行为，这个嵌入的被称为装饰器。</li>
</ol>
<p>装饰器模式以客户透明的方式动态给一个对象附加上更多的责任，客户端并不会觉得对象在装饰前后有什么不同。可以在不创建更多子类的情况下扩展对象的功能。即该模式的动机。</p>
<h3 id=模式定义>模式定义</h3>
<p><strong>装饰器模式(Decorator Pattern)</strong>，动态给对象增加一些额外的职责(Responsibility)，就增加对象功能来说，装饰模式比创建子类的实现更为灵活。或称为“包装器”，与适配器别名相同但应用场景不同，或称“油漆工模式”。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含四种角色：</p>
<ul>
<li>Component：抽象构件</li>
<li>ConcreteComponent：具体构件</li>
<li>Decorator：抽象装饰类</li>
<li>ConcreteDecorator：具体装饰类</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134702.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134720.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码分析>代码分析</h3>
<h3 id=模式分析>模式分析</h3>
<ul>
<li>与继承关系相比，关联关系的主要优势在于不会破坏的类的封装性，而且继承是一种耦合度较大的静态关系，无法在程序运行时动态扩展。在软件开发阶段，关联关系虽然不会比继承关系减少编码量，但是到了维护阶段，由于关联关系具有较好的松耦合性，因此系统会更易维护。而关联关系的缺点则是会比继承关系要多创建更多对象。</li>
<li>使用装饰器模式来实现扩展比继承更加灵活，它以对客户透明的方式动态的给一个对象附加更多的责任。该模式可以在不创建更多子类的情况下，扩展对象功能。</li>
</ul>
<h3 id=实例>实例</h3>
<h4 id=变形金刚>变形金刚</h4>
<p>变形金刚在变型之前是一辆汽车，它可以在陆地上移动。变型之后除了能够移动外还可以说话；或者变成飞机飞行。</p>
<p>类图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134736.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>时序图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134752.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=优点>优点</h3>
<ul>
<li>装饰模式与继承关系的目的都是要扩展对象的功能，但是装饰器比继承更为灵活。</li>
<li>可以通过动态的方式来扩展一个对象的功能，通过配置文件在运行时选择不同的装饰器，从而实现不同的行为。</li>
<li>通过使用不同的具体装饰类已经这些装饰类的排列组合，可以创造出很多不同行为的组合。或者使用多个不同的具体装饰类装饰同一个对象，得到功能更对强大的对象。</li>
<li>具体构件类与具体装饰类可以独立变化，用户可以根据需要增加新的具体构建类和具体装饰类，在使用时再对其进行组合，原有代码无需改变，符合开闭原则。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>使用装饰模式进行系统设计时将产生很多小对象，这些对象的区别在于他们之间的相互连接方式有所不同，而不是他们的类或属性值有所不同，同时还将产生很多具体装饰类。这些装饰类和小对象的产生将增加系统的复杂性，加大学习与理解难度。</li>
<li>这种比继承机制更加灵活的特性，同时也意味着装饰模式比继承模式更易出错，排查也更加困难，对于多次装饰的对象，调试时寻找试错可能需要逐级排查，较为繁琐。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>在不影响其它对象的情况下，以动态、透明的方式给单个对象增加职责。</li>
<li>需要动态给一个对象增加功能，这些功能也可以动态的被撤销。</li>
<li>当不能采用继承的方式对系统中进行扩从或采用继承不利于系统扩展与维护时。有两种情况不适合使用继承：系统中存在大量独立的扩展，为支持每一种组合将产生大量的子类；活类的定义为 final，不能继承。</li>
</ul>
<h3 id=模式扩展>模式扩展</h3>
<p>装饰器模式简化需要注意的问题：</p>
<ul>
<li>一个装饰类的接口必须与被装饰类的接口保持相同，对于客户端来说，对象在被装饰前后都可以一致对待。</li>
<li>尽量保持具体构件类 Component 作为一个“轻”类，不要把太多的逻辑和状态放在具体构件类中，可以通过装饰类来完成这些工作</li>
</ul>
<p>对该模式进行扩展时：如果只有一个具体构件类而没有抽象构件类，那么抽象装饰类可以作为具体构件类的直接子类。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-490ca18d71ef644e626a4a891a3856c3>1.9 - CH09-结构型-外观</h1>
<h3 id=模式动机>模式动机</h3>
<h3 id=模式定义>模式定义</h3>
<p><strong>外观模式(Facade Pattern)</strong>，外部与子系统的通信必须通过一个统一的外观对象进行，为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。又称<strong>门面模式</strong>。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含两种角色：</p>
<ul>
<li>Facade：外观角色</li>
<li>SubSystem：子系统角色</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134816.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134829.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码分析>代码分析</h3>
<h3 id=模式分析>模式分析</h3>
<ul>
<li>根据<strong>单一职责原则</strong>，在软件中将一个系统划分为若干个子系统有利于降低整个系统的复杂性，一个最常见的目标是<strong>使子系统之间的通信和相互依赖关系达到最小</strong>，达到该目标的方式之一就是引入一个外观对象，来为子系统提供一个简单而单一的入口。</li>
<li>外观模式也是<strong>迪米特法则</strong>的体现，通过引入一个新的外观类可以降低原有系统的复杂度，同时降低客户类与子系统类的耦合度。</li>
<li>该模式要求，一个子系统的外部与其内部的通信通过一个统一的外观对象进行，外观类将客户端与子系统的内部复杂度分隔开，客户端则只需要与外观类交互，而不需要和子系统内部的诸多对象交互。</li>
<li>该模式的目的在于降低系统的复杂度。</li>
<li>该模式很大程度上提高了客户端使用上的便捷性，使得客户端无需关心子系统的内部细节。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>对客户端屏蔽子系统组件，减少客户处理的对象数目，并使得子系统用起来更容易。</li>
<li>实现客户端与子系统的松耦合，使子系统的组件变化不会影响到客户类，只需要调整外观类即可。</li>
<li>降低大型系统中的编译依赖性，并简化了系统在不同平台之间的迁移过程，可以以一个更小粒度(子系统)修改、编译软件。</li>
<li>只是提供了一个统一访问子系统的统一入口，并不影响用户直接使用子系统类。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>不能很好的限制客户使用子系统类，如果对客户访问子系统类做太多的限制则减少了可变性和灵活性。</li>
<li>在不引入抽象外观类的情况下，增加新的子系统可能要修改外观类或客户端的代码，违背了开闭原则。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>当要为复杂子系统提供一个简单接口时可以考虑该模式。</li>
<li>当客户与多个子系统之间存在很大的依赖性。引入外观类将子系统与客户以及其他子系统解耦，可以提高子系统的独立性和可移植性。</li>
<li>在层次化结构中，可以使用外观模式定义系统中的每一层接口，曾与曾之间不直接产生联系，而通过外观类建立联系，降低层之间的耦合度。</li>
</ul>
<h3 id=模式扩展>模式扩展</h3>
<ul>
<li>
<p>一个系统有多个外观类</p>
<p>通常只有一个外观类，同时只有一个实例，即它是一个单例类。同时也可以定义多个外观类，分别于不同的特定子系统交互。</p>
</li>
<li>
<p>不要通过外观类为子系统增加新的行为</p>
</li>
<li>
<p>外观模式与迪米特法则</p>
<p>外观类充当了客户与子系统之间的第三者，降低客户与系统的耦合度。</p>
</li>
<li>
<p>引入抽象外观类</p>
<p>该模式最大的缺点在于违背了开闭原则。当增减子系统时可以通过引入抽象外观类来解决该问题，客户端则针对抽象外观类编程。以增减具体外观类的方式来支持子系统的变更。</p>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4e15f0bfa5f085fcbd4bbb2e4aa4e8ca>1.10 - CH10-结构型-享元</h1>
<h3 id=模式动机>模式动机</h3>
<p>OOP 可以很好的解决一些灵活性和扩展性问题，但同时要增加对象的个数。当对象数过多则会导致运行代价过高，带来性能问题。</p>
<ul>
<li>享元模式正式为了解决这类问题。该模式通过共享技术实现相同或相似对象的重用。</li>
<li>在该模式中可以共享的相同内容称为<strong>内部状态(Intrinsic State)</strong>，而那些需要通过外部环境来配置的不能共享的内容称为<strong>外部状态(Extrinsic State)</strong>。因为区分了内外状态，可以通过设置不同的外部状态使得相同对象可以具有一些不同的特征，而相同的内部状态则可以共享。</li>
<li>该模式中通常会出现工厂模式，需要创建一个<strong>享元工厂</strong>来负责维护一个**享元池(Flyweight Pool)**用于存储具有相同内部状态的享元对象。</li>
<li>该模式中共享的享元对象的内部状态、外部状态需要通过环境来配置。在实际使用中，能够共享的内部状态是有限的，因此享元对象一般都设计为较小的对象，所包含的内部状态较少，也称为<strong>细粒度对象</strong>。该模式的目的就是使用共享技术来实现大量细粒度对象的复用。</li>
</ul>
<h3 id=模式定义>模式定义</h3>
<p><strong>享元模式(Flyweight Pattern)</strong>，运用共享技术有效的支持大量细粒度对象的复用。系统只使用少量的对象，而这些对象都很相似，状态变化很小，可以实现对象的多次复用。由于该模式要求能够共享的对象必须是细粒度对象，因此也称为<strong>轻量级模式</strong>。</p>
<h3 id=模式结构>模式结构</h3>
<p>该模式包含四种角色：</p>
<ul>
<li>Flyweight：抽象享元类</li>
<li>ConcreteFlyweight：具体享元类</li>
<li>UnsharedConcreteFlyweight：非共享具体享元类</li>
<li>FlyweightFactory：享元工厂类</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134855.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134915.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码分析>代码分析</h3>
<h3 id=模式分析>模式分析</h3>
<p>该模式是一种考虑系统性能的设计模式，使用该模式以节约内存空间，提供系统性能。</p>
<p>享元模式的核心在于享元工厂类，它的作用在于提供一个用于存储享元对象的享元池，用户需要对象时，首先从享元池中取，如果不存在则创建一个该具体享元类的实例，存入享元池并返回给客户。</p>
<p>该模式以共享的方式高效的支持大量的细粒度对象，享元对象能够做到共享的关键是区分内部状态和外部状态：</p>
<ul>
<li>内部状态：是存储在享元对象内部并且不会随着环境改变而改变的状态。</li>
<li>外部状态：是随环境而改变的、不可共享的状态。享元对象的外部状态必须由客户端保存，并在享元对象被创建之后，在需要使用的时候在传入到享元对象内部。外部状态相互之间是独立的。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>可以极大减少内存中对象的数量，使得相同对象或者相似对象在内存中只保存一份。</li>
<li>外部状态相互独立，而且不会影响其内部状体，从而使得享元对象可以在不同的环境中被共享。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>该模式使得系统更加复杂，需要分离内部状态和外部状态，使程序逻辑复杂。</li>
<li>为了使对象可以共享，需要将对象的状态外部化，而读取外部状态会使运行时间变长。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>一个系统有大量相同或相似对象，由于这类对象的大量使用，造成内存大量使用。</li>
<li>对象的大部分状态可以外部化，可以将这些外部状态传入对象中。</li>
<li>使用该模式需要维护一个存储享元对象的享元池，而这需要消耗资源，因此，应当在多次重复使用享元对象时才值得使用该模式。</li>
</ul>
<h3 id=模式应用>模式应用</h3>
<p>该模式大量应用于编辑器软件，如在一个文档中多次使用相同的图片等。</p>
<h3 id=模式扩展>模式扩展</h3>
<p>单纯享元模式和复合享元模式：</p>
<ul>
<li>单纯享元模式：所有的享元对象都是可以共享的，即所有抽象享元类的子类都可共享，不存在非共享具体享元类。</li>
<li>复合享元模式：将一些单纯享元使用组合模式加以组合，可以形成复合享元对象，这样的复合享元对象本身不能共享，但是可以分解成单纯享元对象，然后进行共享。</li>
</ul>
<p>与其他模式联用：</p>
<ul>
<li>在享元工厂类中通常提供一个静态工厂方法用于返回享元对象，使用简单工厂模式来生成享元对象。</li>
<li>在一个系统中，通常只有唯一一个享元工厂，因此享元工厂类可以使用单例模式进行设计。</li>
<li>可以结合组合模式形成复合享元模式，统一对享元对象设置外部状态。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3c2abf60a670073abcce87e0c3c1387f>1.11 - CH11-结构型-代理</h1>
<h3 id=模式动机>模式动机</h3>
<p>某些情况下，一个客户不想或者不能直接引用一个对象，此时可以使用一个称为<strong>代理</strong>的第三者来实现间接引用。代理对象可以在客户端和目标对象之间起到中介作用，并且可以通过代理对象来去掉客户不能看到的内容、服务或资源，或添加额外的功能。</p>
<p>通过引入一个新的对象(小图片、远程代理 对象)来实现对真实对象的操作，或者将新的对象作为真实对象的一个替身，这种实现机制即为代理模式，<strong>通过引入代理对象来间接访问一个对象</strong>。</p>
<h3 id=模式定义>模式定义</h3>
<p><strong>代理模式(Proxy Pattern)</strong>，给某一个对象提供一个代理，并由代理对象控制对源对象的引用。或称为 <strong>Surrogate</strong> 。</p>
<h3 id=模式结构>模式结构</h3>
<p>共包含三种角色：</p>
<ul>
<li>Subject：抽象主题角色</li>
<li>Proxy：代理主题角色</li>
<li>RealSubject：真实主题角色</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134937.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220134951.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=优点>优点</h3>
<ul>
<li>能够协调调用者和被调用者，一定程度上降低了系统耦合度。</li>
<li>远程代理使得客户端可以访问在远程机器上的对象，远程机器可能具有更好的计算性能与处理速度，可以快速响应并处理客户端请求。</li>
<li>虚拟代理通过使用一个小对象来代表一个大对象，可以减少系统资源的消耗，优化系统以提升速度。</li>
<li>保护代理可以控制真是对象的使用权限。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>由于在客户端和真实对象之间增加了代理，因此，有些类型的代理模式(如远程)可能会造成请求的处理速度过慢。</li>
<li>实现代理模式需要额外的工作，有些实现则比较复杂。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>远程代理(Remote)：为一个处于不同地址空间的对象提供一个本地代理对象。</li>
<li>虚拟代理(Virtual)：如果需要创建一个资源消耗过大的对象，先创建一个消耗相对较小的对象来表示，真实对象只在需要时在会被真正创建。</li>
<li>Copy-To-Write 代理：是虚拟代理的一种，把复制(克隆)操作 延迟到只有在客户端真正需要时才执行。对象的深克隆是一个开销较大的工作，此方式可以使该操作延迟，需要时才执行。</li>
<li>保护代理(Protect or Access)：控制一个对象的访问，可以给不同的用户提供不同级别的使用权限。</li>
<li>缓冲代理(Cache)：为某一个目标操作的结果提供临时的存储空间，以使多个客户端可以共享这些结果。</li>
<li>防火墙代理(Firewall)：保护目标不让恶意用户接触。</li>
<li>同步化代理(Synchronizaiton)：使几个用户能够同时使用一个对象而没有冲突。</li>
<li>智能引用代理(Smart Reference)：当一个对象被引用时，提供一些额外操作，比如记录对象的调用次数。</li>
</ul>
<h3 id=模式应用>模式应用</h3>
<p>EJB、Web Service等分布式技术都是代理模式的应用。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-93102814bf1adf2a6722e241db588658>1.12 - CH12-行为型-命令</h1>
<h2 id=行为型模式概述>行为型模式概述</h2>
<p><strong>行为型模式(Behavioral Pattern)<strong>是对在不同的对象之间</strong>划分职责和算法</strong>的抽象。</p>
<p>该模式不仅仅关注<strong>类和对象的结构</strong>，而且关注他们之间的<strong>相互作用</strong>。</p>
<p>通过该模式，可以更加清晰地划分类与对象的职责，并研究系统在运行时实例对象之间的交互。在系统运行时，对象并不孤立，他们可以通过相互通信与协作完成某些复杂功能，一个对象在运行时也将影响到其他对象的运行。</p>
<p>该类模式又分为<strong>类行为模式</strong>和<strong>对象行为模式</strong>：</p>
<ul>
<li>类行为模式：使用继承关系在几个子类之间分配行为，通过<strong>多态</strong>方式分配父类与子类的职责。</li>
<li>对象行为模式：使用对象的聚合关联关系来分分配行为，主要是通过<strong>对象关联</strong>等方式类分配两个或多个类的职责。根据<strong>合成复用原则</strong>，系统中要尽量通过关联关系来取代继承关系，因此绝大多数的行为设计模式都属于对象行为型模式。</li>
</ul>
<h2 id=命令模式>命令模式</h2>
<h3 id=模式动机>模式动机</h3>
<p>软件设计中，经常要向对象发送请求，但是并不知道对象的接收者是谁，也不知道被请求的操作是哪个，只需要在运行时指定具体的请求接收者即可，此时，可以使用命令模式来进行设计，使得请求发送者和接收者之间接触耦合，增加对象调用之间的灵活性。</p>
<p>命令模式可以对发送者和接收者完全解耦，发送者与接收者之间没有直接引用关系，发送请求的对象只需要知道如何发送请求，而不必知道如何完成请求。这就是命令模式的模式动机。</p>
<h3 id=模式定义>模式定义</h3>
<p><strong>命令模式(Command Pattern)</strong>：将一个请求封装为一个对象，从而使我们可以用不同的请求对客户进行参数化；对请求排队或记录请求日志，以及支持可撤销的操作。属于对象行为型模式，别名为<strong>动作模式(Action)<strong>或</strong>事务模式(Transaction)</strong>。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含五种角色：</p>
<ul>
<li>Command：抽象命令类</li>
<li>ConcreteCommand：具体命令类</li>
<li>Invoker：调用者</li>
<li>Reciver：接收者</li>
<li>Client：客户端</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135025.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135038.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=代码示例>代码示例</h3>
<h3 id=模式分析>模式分析</h3>
<p><strong>命令模式的本质是对命令进行封装，将发送命令的责任和执行命令的责任分隔开。</strong></p>
<ul>
<li>每一个命令都是一个操作：请求方发出请求，要求执行一个操作；接收方收到请求，并执行操作。</li>
<li>命令模式运行请求方和接收方独立开来，使得请求方不必知道接收方的接口，更不必知道请求是如何被接收的，以及操作是否被执行、合适被执行，以及如何执行。</li>
<li>命令模式使请求本身称为一个对象，这个对象和其他对象一样可以被存储和传递。</li>
<li>命令模式的关键在于<strong>引入了抽象命令接口</strong>，并且发送者针对抽象命令接口编程，只有实现了抽象命令接口的具体命令才能与接收者相互关联。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>降低系统的耦合度</li>
<li>新的命令可以很容易地加入到系统</li>
<li>可以比较容易的设计一个命令队列和宏命令(组合命令)</li>
<li>可以方便的实现对请求的 Undo 和 Redo 操作</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>可能会导致某些系统有过多的具体命令类。因为针对每一个命令都需要设计一个具体命令类，因此某些系统可能会需要大量命令类，这将影响命令模式的使用。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>系统需要将请求调用者和接收者解耦，使得调用者和接收者不直接交互</li>
<li>需要在不同的时间指定请求、将请求排队、执行</li>
<li>系统需要支持命令的撤销和恢复操作</li>
<li>系统需要将一组操作组合在一起，即自持宏命令</li>
</ul>
<h3 id=模式扩展>模式扩展</h3>
<ul>
<li>宏命令又称组合命令，它是命令模式和组合模式联用的产物。</li>
<li>宏命令也是一个具体命令，不过他包含了对其他命令对象的引用。在调用宏命令的<code>execute()</code>方法时，将会递归调用它所包含的每个成员命令的<code>execute()</code>方法。</li>
<li>一个宏命令的成员对象可以是一个简单命令也可以是另外一个宏命令。</li>
<li>执行一个宏命令将执行多个具体命令，从而实现对命令的批处理。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f7d3aa04369806d95d4ec83c84c7333f>1.13 - CH13-行为型-中介者</h1>
<h3 id=模式动机>模式动机</h3>
<ul>
<li>在用户与用户直接聊天的设计方案中，用户对象之间存在很强的关联性，将导致系统出现如下问题：
<ul>
<li>系统结构复杂：对象之间存在大量的相互关联和调用，如有一个对象发生变化，则需要跟踪那些与该对象关联的其他所有对象，并进行适当处理。</li>
<li>对象可用性差：由于一个对象和其他对象具有很强的关联，如没有其他对象的支持，一个对象很难被另一个系统或模块复用，这些对象表现出来更像一个不可分割的整体，职责较为混乱。</li>
<li>系统扩展性低：增加一个新的对象需要在原有对象上增加引用，增加新的引用关系也需要调整原有对象，系统耦合度高，对象操作不灵活，扩展性差。</li>
</ul>
</li>
<li>在面向对象的软件设计与开发过程中，根据“单一职责原则”，应该尽量将对象细化，使其只负责或呈现大一的职责。</li>
<li>对于一个模块，可能有很多对象构成，而且这些对象之间可能存在相互的引用，为了减少对象两两之间复杂的引用关系，使之成为一个松耦合的系统，我们需要使用中介者模式，这就是该模式的动机。</li>
</ul>
<h3 id=模式定义>模式定义</h3>
<p><strong>中介者模式(Mediator Pattern)</strong>：用一个中介对象来封装一系列对象交互，中介者使各个对象不需要直接的相互引用，从而使其耦合松散，而且可以独立的改变他们之间的交互。中介者模式又称为调停者模式，是一种对象行为型模式。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含四种角色：</p>
<ul>
<li>Mediator：抽象中介者</li>
<li>ConcreteMediator：具体中介者</li>
<li>Colleague：抽象同事类</li>
<li>ConcreteColleague：具体同事类</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135103.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135115.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=模式分析>模式分析</h3>
<p>中介者模式可以使对象之间的关系数量急剧减少。</p>
<p>中介者承担两方面的职责：</p>
<ul>
<li>中转作用(结构性)：通过中介者提供的中转作用，各个同事对象之间就不需要再进行显式引用，当需要和其他同事进行通信时，通过中介者即可。该中转作用属于中介者在结构上的支持。</li>
<li>协调作用(行为性)：中介者可以更进一步的对同事之间的关系进行封装，同事可以一致的和中介者进行交互，而不需要指明中介者需要怎么做，中介者根据封装在自身内部的协调逻辑，对同事的请求进行进一步处理，将同事成员之间的关系行为进行分离和封装。该协调作用属于中介者在行为上的支持。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>简化了对象之间的交互</li>
<li>将各同事解耦</li>
<li>减少子类生成</li>
<li>可以简化各同事类的设计和实现</li>
</ul>
<h3 id=缺点>缺点</h3>
<p>在具体中介类中包含类同事之间的交互细节，可能会导致具体中介类非常复杂，使系统难以维护。</p>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>系统中对象之间存在复杂的引用关系，产生的相互依赖关系结构混乱且难以理解。</li>
<li>一个对象由于引用了其他很多对象并且直接和这些对象通信，导致难以复用该对象。</li>
<li>想通过一个中间类来疯转多个类中的行为，而又不想生成太多的子类。</li>
<li>交互的公共行为，如果需要改变行为可以增加新的中介者类。</li>
</ul>
<h3 id=模式应用>模式应用</h3>
<p>MVC 架构中的控制器：Controller 作为一个中介者，它负责控制试图对象 View 和模型对象 Model 之间的交互。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b67053751f5655bf0729d66618a09a90>1.14 - CH14-行为型-观察者</h1>
<h3 id=模式动机>模式动机</h3>
<p>建立一种对象与对象之间的依赖关系，一个对象改变时将自动通知其他对象，其他对象将作出相应反应。在此，发生改变的对象成为观察目标，被通知的对象成为观察者，一个观察目标可以对应多个观察者，而且这些观察者之间没有相互联系，可以根据需要增加或删除观察者，使得系统更易于扩展。这便是该模式的动机。</p>
<h3 id=模式定义>模式定义</h3>
<p><strong>观察者模式(Observer Pattern)</strong>：定义对象的一种一对多关系，使得每当一个对象状态发生改变时，其相关依赖对象皆得到通知并被自动更新。或称为<strong>发布-订阅(Publish/Subscribe)模式、模型-试图(Model/View)模式、源-监听(Source/Listener)模式、从属(Dependents)模式</strong>。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含 4 中角色：</p>
<ul>
<li>Subject：目标</li>
<li>ConcreteSubject：具体目标</li>
<li>Observer：观察者</li>
<li>ConcreteObserver：具体观察者</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135139.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135151.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=模式分析>模式分析</h3>
<ul>
<li>管擦者模式描述了如何建立对象与对象之间的依赖关系，如何构造满足这种需求的系统。</li>
<li>该模式中的关键对象是观察目标和管擦者，一个目标可以有任意数目的、与之相依赖的观察者，一旦目标的状态发生改变，所有的观察者都将得到通知。</li>
<li>作为多这个通知的响应，每个观察者都将更新自己的状态，以与目标状态同步，这种交互也被称为发布-订阅。目标是通知的发布者，它发出通知时并不知道谁是它的观察者，可以有任意数量的观察者订阅它并接收通知。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>该模式可以实现表示层和数据逻辑层的分离，并定义了稳定的消息更新传递机制，抽象了更新接口，使得可以有各种不同的表示层作为具体观察者角色。</li>
<li>该模式在观察目标和观察者之间建立了一个抽象的耦合。</li>
<li>观察者模式支持广播通信。</li>
<li>观察者模式符合“开闭原则”。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>如果一个目标对象有很多直接和间接的观察者的话，将所有的观察者都通知到将会花费很多时间。</li>
<li>如果在观察者和目标之间有循环依赖的话，目标会触发他们之间进行循环调用，导致系统崩溃。</li>
<li>该模式没有相应的机制让观察者知道相应的观察目标是怎样发生变化的，而仅仅只是知道目标发生了变化。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>一个抽象模型有两个方面，其中一个方面依赖于另一个方面。将这些方面封装在独立的对象中，可以使他们各自独立的改变和复用。</li>
<li>一个对象的改变将导致其他一个或多个对象也发生改变，而不知道具体有多少个对象发生改变，可以降低对象之间的耦合度。</li>
<li>一个对象必须通知其他对象，而并不知道这些对象是谁。</li>
<li>需要在系统中创建一个触发链，A 对象的行为将影响 B 对象， B 对象的行为将会影响 C 对象…等等，可以使用该模式创建一种链式触发机制。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-59313ad332a3d6ac44bee1940613da82>1.15 - CH15-行为型-状态</h1>
<h3 id=模式动机>模式动机</h3>
<ul>
<li>很多情况下，一个对象的行为取决于一个或多个动态变化的属性，这样的属性称为状态，这样的对象称为有状态(stateful)对象，这样的对象状态是从事先定义好的一系列值中取出的。当一个这样的对象与外部事件产生互动时，其内部状态就会改变，从而使得系统行为也随之改变。</li>
<li>在 UML 中可以使用状态图来描述对象状态的变化。</li>
</ul>
<h3 id=模式定义>模式定义</h3>
<p><strong>状态模式(State Pattern)</strong>：允许一个对象在其内部状态改变时改变它自身的行为，对象开起来似乎修改了它的类。其别名为状态对象(Objects for states)。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含 3 种角色：</p>
<ul>
<li>Context：环境类</li>
<li>State：抽象状态类</li>
<li>ConcreteState：具体状态类</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135215.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135235.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=模式分析>模式分析</h3>
<ul>
<li>状态模式描述了对象的状态变化以及对象如何在每一种状态下表现出不同的行为。</li>
<li>状态模式的关键是引入了一个抽象类来专门表示对象的状态，这个类称为抽象状态类，而对象的每一种具体状态类都继承自该类，并在不同具体状态类中实现了不同状态的行为，以及不同状态间的转换。</li>
</ul>
<p>需要理解环境类与抽象状态类的作用：</p>
<ul>
<li>
<p>环境类实际上就是拥有状态的对象，有时候可以充当状态管理器(State Manager)的角色，可以在环境类中对状态进行切换操作。</p>
</li>
<li>
<p>抽象状态类可以是抽象类，也可以是接口，不同状态类就是继承这个父类的不同子类，状态类的产生是由于环境类存在多个状态，同时还满足两个条件：</p>
<ul>
<li>这些状态需要经常切换</li>
<li>不同状态下，对象的行为不同</li>
</ul>
<p>因此，可以将不同对象下的行为单独提取出来封装在具体的状态类中，使得环境类对象在其内部状态改变时可以改变它的行为，对象看起来似乎修改了它的类，实际上是由于切换到不同的状态类实现的。</p>
</li>
<li>
<p>由于环境类可以设置为任一具体状态类，因此它针对抽象状态类进行编程，在程序运行时可以将任一具体状态类的对象设置到环境类中，从而使得环境类可以改变内部状态，并且改变行为。</p>
</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>封装了转换规则</li>
<li>枚举可能的状态，在枚举状态之前需要确定状态种类</li>
<li>将所有与某个状态有关的行为放到一个类中，并且可以方便的增加新的状态，只需要改变对象状态即可改变对象行为。</li>
<li>允许状态转换逻辑与状态对象合成一体，而不是一个巨大的条件语句块。</li>
<li>可以让多个环境对象共现一个状态对象，从而减少系统中对象的个数。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>必然增加系统类和对象的个数</li>
<li>结构与实现比较复杂，使用不当将导致结构与代码混乱</li>
<li>对“开闭原则”的支持并不是很好，对于可以切换状态的状态模式，增加新的状态类需要修改那些负责状态装换的源代码，否则无法切换到新增状态；修改某个状态类的行为也需要修改对应类的源代码。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>对象的行为依赖于其状态(属性)，并且需要根据它的状态改变而改变相关行为。</li>
<li>代码中包含大量与对象状态有关的条件语句，这些条件语句的出现，会导致代码的可维护性和灵活性变差，不能方便的增加和删除状态，使客户类与类库之间的耦合增强。在这些条件语句中包含了对象的行为，而且这些条件对应于对象的各种状态。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f17fad01d0380c6b978ba3db030b5483>1.16 - CH16-行为型-策略</h1>
<h3 id=模式动机>模式动机</h3>
<ul>
<li>完成一项任务，往往可以有多种不同的方式，每种方式称为一个策略，我们可以根据环境、条件的不同选择不同的策略来完成该项任务。</li>
<li>在软件开发中也常常遇到类似的情况，实现某一功能有多个途径，此时可以使用一种设计模式来使得系统可以灵活的选择解决途径，也能够方便的增加新的解决途径。</li>
<li>在软件系统中，有许多算法可以实现某一功能，如查找、排序等，一种常用的方法是硬编码在一个类中，如需要提供多种查询算法，可以将这些算法写到一个类中，在该类中提供多个方法，每个方法对应一种算法；或者将所有的算法封装在一个方法中，通过<code>if-else</code>语句来进行选择。这些方法都可以称为硬编码，如果需要增加一种新的算法，则需要修改封装算法类的源代码；修改、更换算法时，仍然需要修改客户端调用代码。这种方式使封装算法的类过于庞大、逻辑复杂，难以维护。</li>
<li>除了提供专门的查找算法外，还可以在客户端程序中直接包含算法代码，这种做法更不可取，将导致客户端程序庞大而难以维护，如果存在大量可供选择的代码则将家中问题的严重性。</li>
<li>为了解决这个问题，可以定义一些独立的类来封装不同的算法，每一个类封装一个具体的算法，每一个封装算法的类我们都可以称之为策略(Strategy)，为了保证这些策略的一致性，一般会使用一个抽象的策略类来做算法的定义，而具体每种算法则应对应于一个具体的策略类。</li>
</ul>
<h3 id=模式定义>模式定义</h3>
<p><strong>策略模式(Strategy Pattern)</strong>：定义一系列算法，将每一个算法封装起来，并让他们可以互相替换。该模式实现算法能够独立于使用它的客户端而独立变化，或称<strong>政策模式(Policy)</strong>。</p>
<h3 id=模式结构>模式结构</h3>
<p>包含 3 种角色：</p>
<ul>
<li>Context：环境类</li>
<li>Strategy：抽象策略类</li>
<li>ConcreteStrategy：具体策略类</li>
</ul>
<h3 id=类图>类图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135530.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=时序图>时序图</h3>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190220135544.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=模式分析>模式分析</h3>
<ul>
<li>策略模式是一个比较容易理解和使用的模式，就是对算法的封装，它把算法的责任和算法本身分割开，委派给不同的对象管理。策略模式通常把一个系列的算法封装到一系列的策略类里面，作为一个抽象策略类的子类。即：准备一组算法，并将每一个算法封装起来，使得他们可以互换。</li>
<li>在该模式中，应当有客户端自己决定何时、选择哪个具体策略。</li>
<li>该模式仅仅是封装算法，提供新算法插入到已有系统中，以及老算法从系统中移除。策略模式并不觉得在何时使用哪种算法，这些由客户端类决定。在一定程度上提升了灵活性，但是客户端需要理解所有具体策略之间的区别，以便选择合适的算法，这也是该模式的缺点，一定程度上增加了客户端的使用难度。</li>
</ul>
<h3 id=优点>优点</h3>
<ul>
<li>提供了对开闭原则的支持，用户可以在不修改原有系统的基础上选择、增减算法或行为。</li>
<li>提供了管理相关算法族的办法。</li>
<li>提供了可以替换继承关系的办法。</li>
<li>可以避免使用多重条件语句。</li>
</ul>
<h3 id=缺点>缺点</h3>
<ul>
<li>客户端必须知道所有的策略类，并自行决定使用哪个策略。</li>
<li>将会产生很多策略类，可以通过使用享元模式在一定程度上减少对象的数量。</li>
</ul>
<h3 id=适用场景>适用场景</h3>
<ul>
<li>如果一个系统中有很多类，他们之间的区别仅在于他们的行为，这时使用策略模式就可以动态的让一个对象在许多行为中选择一个。</li>
<li>系统需要动态地在几种算法中选择一种。</li>
<li>如果一个对象有很多的行为，如果不用恰当的模式，这些行为就只好使用多重的条件选择语句实现。</li>
<li>不希望客户端知道复杂的、与算法相关的数据结构，在具体策略类中封装算法和相关的数据结构，提高算法的保密性与安全性。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1ded6ad8722dec4ccfd8cfad029dfa34>2 - Scala 模式</h1>
</div>
<div class=td-content>
<h1 id=pg-6e9693b6bf199f21c4c977e3c03535b0>2.1 - CH01-模式分类</h1>
<p>在计算机编程世界，有多种不同的方式来构建一个解决方案以用于解决某些问题。然而，有些人会考虑是否存在一种正确的方式来实现特定的任务。答案是肯定的；通常总是会存在正确的方式，但是在软件开发领域，通常会存在多种方式来实现一个任务。存在一些将程序员引导向正确方案的因素，基于此，人们往往也能得到预期的结果。这些因素可以包含多种事物—实际使用的语言，算法，可执行文件类型，输出格式，代码结构等等。本书中我们将会选择使用 Scala 语言。当然，有很多种方式来使用 Scala，不过这里我们仅会关注“设计模式”部分。</p>
<p>本章中，我们将会介绍什么是设计模式以及他们存在的意义。我们将会贯穿多种不同类型的设计模式。本书的目的在于提供有用的实例，以帮助你在学习过程中能够轻松运行他们。因此，这里会提供一些环境搭建的细节。下面是我们要涉及的几个首要话题：</p>
<ul>
<li>什么是一个设计模式以及它们为什么会存在？</li>
<li>主要类型的设计模式及其特性</li>
<li>选择正确的设计模式</li>
<li>搭建开发环境</li>
</ul>
<p>最后一点可能与设计模式本书关联不大。不过正确的构建项目总归是一个好的想法，同时也能使未来的工作更加轻松。</p>
<h2 id=设计模式>设计模式</h2>
<p>在我们深入 Scala 设计模式之前，需要解释一下它们实际的含义、存在的意义，以及为什么值得去精通它们。</p>
<p>软件是一个宽泛的主题，人们可以用它们来做数不尽的事。乍一看，所做的这些事的是完全不同的—游戏、网站、移动手机应用或用于不同产业的特殊系统。然而软件的构建构过程却有很多相似性。无论需要创建的软件为哪种类型，通常人们都需要解决相似的问题。比如，网站和游戏都需要访问数据库。同时贯穿整个时间，开发者们通过经验来学习如何为不同的任务来组织他们的代码。</p>
<p>设计模式的一个正式定义能够让你理解其在构件优雅高效关键中的实际价值。</p>
<blockquote>
<p><strong>The formal definition for design patterns</strong></p>
<p>一个设计模式是一个用于解决反复出现的问题的可复用解决方案。它并非一段已完成的代码片段，而是作为一个模板，用于帮助解决一些特殊问题或一些列问题。</p>
</blockquote>
<p>设计模式是软件开发社区通过很长的时间总结出的最佳实践。它们被认为能够帮助编写高效、可读、易测试、易扩展的代码。在某些情况下，它们可能是某些表达不够优雅的编程语言(比如 Java..)的目标实现的结果。这意味着大多特性丰富的语言可能甚至都不需要一个设计模式。Scala 就属于这种富特性语言，有些情况下，它会让一些设计模式的应用显得过时或者更加简洁。我们将会在本书中看到它是如何做到这一点的。</p>
<p>一个编程语言中的功能缺陷或优势同样决定了其是否能够实现相比其他语言更多的设计模式。</p>
<h3 id=scala-和设计模式>Scala 和设计模式</h3>
<p>Scala 是一个混合型语言，它同时结合了面向对象和函数式编程。这不仅让他能够拥有一些经典的面向对象设计模式，同时提供了多种不同的方式来利用其特性以编写高效、可读、易测试、易扩展的代码。这种混合的性质可以使用更加清晰的技术让一些经典的设计模式变得过时，或者让不能成为可能。</p>
<h3 id=设计模式的需要及其收益>设计模式的需要及其收益</h3>
<p>每个人都需要设计模式并在编写代码之前需要深入了解他们。像我们之前提到的，它们能够帮助编写高效、可读、易测试、易扩展的代码。所有这些特性对于行业中的公司来说都是非常重要的。</p>
<p>尽管有些情况下更需要的是快速编写一个原型并落地，然而更常见的情况是软件的一部分代码需要不断的演变。可能你已经拥有一些对已存在的烂代码扩展经验，但无论如何，这是一项挑战并且会花费很长时间，甚至有时会感觉重写会相对简单。此外，这也可能会给系统引入新的 Bug。</p>
<p>代码可读性有些时候也是需要引起重视的。当然，尽管有些人使用了设计模式但仍然会让他的代码难以理解，但通常来说设计模式会带来一些帮助。大型系统通常是由很多人协同开发，每个人也必须知道到底发生了什么。同时，新加入到团队中的人员也能更简单快速的融入进来，如果他们是基于程序中写的很好的部分工作的话。</p>
<p>可测试性有助于在编写或扩展代码时避免开发者引入 Bug。有些情况下，代码可能会很糟或甚至没法测试。设计模式一般也能很好的解决这些问题。</p>
<p>虽然效率通常与算法相关，设计模式同样也能对其造成影响。比如一个对象，需要很长时间才能完成初始化，并且其实例会被应用的各个部分使用，但这是可以使用单例来代替的。你可以在本书的后续章节中看到更多正确的实例。</p>
<h2 id=模式分类>模式分类</h2>
<p>软件开发是一个非常宽泛的话题，这也使得大量的事情可以通过编程来完成。每件事都是不同的，这导致对软件质量的需求也多种多样。所有这些事实导致了大量不同的设计模式被发明。而这又进一步被现有的具有不同功能和表现力水平的编程语言所促进。</p>
<p>本书关注于从 Scala 的视角来看设计模式。如前所述，Scala 是一个混合型语言。这导致一些非常有名的设计模式不再被需要—比如“null 对象”设计模式，可以简单的使用 Scala 中的<code>Option</code>替代。其他的设计模式同过不同的方式也变得可行—装饰器模式可以使用叠加特质实现。最终，一些新的设计模式变得可用，他们尤其适用于 Scala 这种编程语言—比如蛋糕模式、皮条客等。我们将关注所有这些模式，并通过 Scala 的丰富特性使我们的代码更加简洁，从而使这些模式变得更加清晰。</p>
<p>尽管有多种不同的设计模式，但他们都可以被划分为不同的主要分类：</p>
<ul>
<li>创建型</li>
<li>结构型</li>
<li>行为型</li>
<li>函数式</li>
<li>Scala 特有设计模式</li>
</ul>
<p>一些特定于 Scala 的模式可以被归类到最后一个组。他们均可以作为现有模式的补充或替代。他们是 Scala 独有的，并且利用了一些其他语言中没有的高级语言特性或简单特性的优势。</p>
<p>前三个分类包含了著名的 <em>Gang of Four</em> 设计模式。每本设计模式的书都会涵盖这些，因此我们也不例外。而剩余的部分，尽管它们仍能归类于前三类，但都特定于 Scala 和函数式编程语言。在后续的一些章节中，我们将解释这些分类的主要特点并介绍它们实际所属的设计模式。</p>
<h3 id=创建型设计模式>创建型设计模式</h3>
<p>创建型设计模式用于处理对象的创建机制。它们的目的是在当前的场景中以合适的方式创建对象实例。如果不使用这些模式，将会带来更多不必要的复杂性同时也需要更多的知识。创建型模式背后的思想主要有一下几点：</p>
<ul>
<li>具体类的知识封装</li>
<li>隐藏实际的创建过程和对象组合的细节</li>
</ul>
<p>本书中我们将关注如下几种创建型模式：</p>
<ul>
<li>抽象工厂</li>
<li>工厂方法</li>
<li>惰性初始化</li>
<li>单例</li>
<li>对象池</li>
<li>建造者</li>
<li>原型</li>
</ul>
<p>下面的一些小节给出了这些模式的简要定义，并会在后续章节中进行深入分析。</p>
<h4 id=抽象工厂>抽象工厂</h4>
<p>用于封装那些拥有通用主题的单个工厂。使用时，开发者为抽象工厂创建一个具体实现，像工厂模式的使用方式一样使用其方法来创建对象。可以认为是用来帮助创建类的又一层抽象(类-工程-抽象工厂)。</p>
<h4 id=工厂方法>工厂方法</h4>
<p>创建实例时无需显式指定实例所拥有的具体类—它会基于工厂在运行时决定。这些工厂可能包括操作系统、不同的数据类型或输入参数。它使开发者能够调用一个方法而不是调用一个具体的构造器。</p>
<h4 id=惰性初始化>惰性初始化</h4>
<p>用于延迟一个对象的创建或求值过程，直到第一次需要使用它的时候。在 Scala 中它会变得更加简单，而不像 Java 这种 OO 语言。</p>
<h4 id=单例>单例</h4>
<p>限制一个类只能创建一个实例。如果应用中的多个类都要使用这样的实例，将会返回同一个实例给所有使用者。这种模式可以通过 Scala 的语言特性轻松实现。</p>
<h4 id=对象池>对象池</h4>
<p>创建一个已经初始化并等待使用的对象池。一旦有人需要使用池中的对象则会立即返回，使用完成后手动或自动放回到池中。最常用的场景是数据库连接，创建代价较为昂贵，通常是一次创建后服务于不同的客户端请求。</p>
<h4 id=建造者>建造者</h4>
<p>用于那些拥有大量构造器参数的对象，否则开发者需要为多种不同的创建方式编写多种不同的辅助构造器。这不同于工厂模式，其目的是支持多态。很多种现代化的库都运用了这种模式，Scala 中实现这种模式也非常简便。</p>
<h4 id=原型>原型</h4>
<p>这种模式支持在已有的对象实例使用<code>clone()</code>方法来创建对象。用于某些创建起来非常昂贵的特殊资源，或者不愿使用抽象工厂模式的时候。</p>
<h3 id=结构型设计模式>结构型设计模式</h3>
<p>用于在多种不同的实体间建立联系以构造大型的结构。定义了各个组件的组织方式，以灵活的使多个模块在一个大型系统中协作。结构型模式的主要特性如下：</p>
<ul>
<li>将多个对象的实现结合的组合使用</li>
<li>通过多种不同的组件构建大型系统并维持一个高级别的灵活性</li>
</ul>
<p>本书中将关注如下几种结构型模式：</p>
<ul>
<li>适配器</li>
<li>装饰器</li>
<li>桥接</li>
<li>组合</li>
<li>门面</li>
<li>享元</li>
<li>代理</li>
</ul>
<h4 id=适配器>适配器</h4>
<p>该模式支持一个接口可以使用一个已存在的类的接口。接入一个客户端希望你的类暴露一个<code>doWork()</code>方法。你可能在其他类中已经有这样的实现了，但是方法的调用方式不同而且不兼容。或许需要更多的参数。或者是一些开发者不拥有修改权限的库。这时适配器可以用于包装这些功能并暴露需要的方法。适配器用于集成已存在的组件。在 Scala 中，可以通过隐式类来轻松实现适配器。</p>
<h4 id=装饰器>装饰器</h4>
<p>适配器是子类化的轻量级替代方案。它支持开发者扩展一个对象的功能而不影响用一个类的其他实例。将已被扩展的类的对象包装到另一个扩展了该类的对象，并重写需要被修改功能的方法。这种模式在 Scala 中可以通过特质叠加来实现。</p>
<h4 id=桥接>桥接</h4>
<p>用于将一个抽象与其实现之间解耦，从而使各自的变化独立。多用于当一个类和它的功能会经常变化。这种模式使我们想起适配器，但不同在于适配器用于一些已存在的而且无法改变的东西，而桥接则用在构建的时候。桥接可以让我们避免向客户端暴露多种不同的具体类。当我们深入该主题的时候你可能会理解的更清晰，不过现在，假如我们想拥有一个<code>FlieReader</code>类，它要支持多种不同的平台。使用适配器可以避免该类需要为不同的平台提供不同的实现类。在 Scala 中，我们可以使用自类型(self-type)来实现桥接。</p>
<h4 id=组合>组合</h4>
<p>组合是一个分区设计模式，表示一组对象能够被当做一个单独的对象处理。它支持开发者能够统一处理单个对象或组合，并使用不复杂的代码来构建复杂的层次结构。比如一个树结构，一个节点可以包含另一个节点，等等。</p>
<h4 id=门面>门面</h4>
<p>门面的目的在于为客户端提供一个简单的接口来隐藏系统的复杂性和实现细节。这使代码更具可读性并使外部代码减少依赖。它像是系统的一个简化过的包装器，当然也可以与前面提到的其他模式结合使用。</p>
<h4 id=享元>享元</h4>
<p>该模式通过在系统中共享对象来优化内存使用。对象需要包含尽可能多的数据。比如一个单词处理器，每个字符的图形表示与其他相同的字符进行共享，本地信息将会仅包含字符的位置，被在内部保存。</p>
<p>运用共享技术有效地支持大量细粒度对象的复用。系统只使用少量的对象，而这些对象都很相似，状态变化很小，可以实现对象的多次复用。由于享元模式要求能够共享的对象必须是细粒度对象，因此它又称为轻量级模式。</p>
<h4 id=代理>代理</h4>
<p>代理模式支持开发者对其他对象进行包装以提供一个接口。同时能够提供额外的功能，比如安全性或线程安全。该模式可以与享元模式结合使用，那些共享对象的引用可以包装在代理对象的内部。</p>
<h3 id=行为类设计模式>行为类设计模式</h3>
<p>基于对象之间特殊的相互作用方式增加他们之间的灵活性。创建类模式大多描述对象的创建，结构类模式大多用于描述静态结构，而行为模式则描述一个过程或流向。它使这个流程更简单且更易理解。</p>
<p>行为类模式的主要特性：</p>
<ul>
<li>描述一个过程或流向</li>
<li>流程更加简单且易于理解</li>
<li>完成那些由对象难于或不可能完成的任务</li>
</ul>
<p>本书将关注的行为类模式：</p>
<ul>
<li>值对象</li>
<li>Null 对象</li>
<li>策略</li>
<li>命令</li>
<li>职责链</li>
<li>解释器</li>
<li>迭代器</li>
<li>中介</li>
<li>备忘</li>
<li>管擦者</li>
<li>状态</li>
<li>模板方法</li>
<li>访问者</li>
</ul>
<h4 id=值对象>值对象</h4>
<p>值对象是不可变的并且他们的相等性并不基于他们的标示符(identity)，而是基于他们的字段相等性。可以被用作数据传输对象、颜色、货币金额、数字等等。他们的不变型使其多用于多线程编程。Scala 中鼓励不可变性，值对象也作为自然存在的事情(源生提供不可变型对象)。</p>
<h4 id=null-对象>Null 对象</h4>
<p>Null 对象表示值并不存在并定义一个中性的行为。该技术使对 null 引用的检查不再必要并且使代码更简明。Scala 添加了一个可选值的概念，即 Option，可以替代该模式。</p>
<h4 id=策略>策略</h4>
<p>该模式支持在运行时选择算法。它定义了一类能够替换的封装算法，给客户端提供一个通用的接口。算法的选择取决于应用运行时能够决定的因素。在 Scala 中，可以向方法传递一个函数作为参数，基于该函数将会执行一个不同的动作。</p>
<h4 id=命令>命令</h4>
<p>将一个稍后会触发的动作的信息保存为一个对象，信息中包含了：</p>
<ul>
<li>方法名</li>
<li>方法的拥有者</li>
<li>参数值</li>
</ul>
<p>然后客户端来决定调用者在何时执行哪个命令。该模式在 Scala 中可以通过传名参数这种语言特性实现。</p>
<h4 id=职责链>职责链</h4>
<p>请求的发送者与其接收者进行解耦。这种方式能够使多个对象来接收请求并且保持逻辑分离。接收者组成的链条对请求进行传递，尝试处理，否则传递给下一个接收者。可以变化为一个处理者可以将请求同时分发给多个不同的处理者。</p>
<p>类似于函数组合，在 Scala 中通过叠加特质实现。</p>
<h4 id=解释器>解释器</h4>
<p>该模式基于语言是否能够通过其静态语法来描述一个著名领域。它定义了每个语法规则的类以解释给定语言中的句子。这些类很可能代表层次，因为语法通常也是分层的。解释器可以用在不同的解析器，比如 SQL 或其他语言。</p>
<h4 id=迭代器>迭代器</h4>
<p>用于当一个迭代器穿过容器并访问其对象时。用于将容器与执行在容器上的算法解耦。迭代器应该提供的是对聚合对象的元素的顺序访问，而不必暴露被迭代集合的内部表示。</p>
<h4 id=中介>中介</h4>
<p>封装一个应用中不同类之间的通信。对象通过中介进行通信而不是直接相互作用，以减少他们之间的依赖并解耦。</p>
<h4 id=备忘>备忘</h4>
<p>提供将一个对象回滚到上一个状态的能力。通过三个对象实现：originator, caretaker, memento。originator 是初始状态，caretaker 会修改 originator，memento 包含 originator 返回的状态。originator 知道如何处理一个 memento 以便存储它的上一个状态。</p>
<h4 id=观察者>观察者</h4>
<p>支持创建一个发布、订阅系统。有一个特殊的对象称为主题，当它的状态发生任何改变时会通知所有的观察者。在 GUI 工具包中处理事件时比较常用。与响应式编程也相关，比如 Akka。</p>
<h4 id=状态>状态</h4>
<p>类似于策略模式，使用一个状态对象封装同一个对象的不同行为。它通过避免大量的条件语句来提高代码的可读性和易维护性。</p>
<h4 id=模板方法>模板方法</h4>
<p>在一个方法中定义一个算法的纲要，然后传递一些实际的步骤到子类。支持开发者在不修改算法结构的前提下修改其中的一些步骤。可以是一个抽象类中的方法并调用其他的抽象方法，这些方法在子类中进行实现。</p>
<h4 id=访问者>访问者</h4>
<p>表示一个执行在对象结构的元素上的操作。支持开发者在不修改原始类的情况下定义一个新的操作。</p>
<p>Scala 中通过传递函数到方法来实现。</p>
<h3 id=函数式模式>函数式模式</h3>
<p>我们将从 Scala 的视角来研究前面所提到的设计模式。这意味着它们会看起来与在其他语言中有所不同，但他们并没有专门的被设计为用于函数式编程。函数式编程比面向对象编程拥有更强的表现力。它拥有其自己的设计模式来帮助开发者活的更轻松。我们将会关注：</p>
<ul>
<li>Monoids(幺半群、幺元)</li>
<li>Monads(单子)</li>
<li>Functors(函子)</li>
</ul>
<p>在我们了解过 Scala 的一些函数式编程概念之后将会贯穿这些，我们将会提高一些 Scala 世界中比较有趣的设计模式。</p>
<h4 id=monoids>Monoids</h4>
<p>Monoid 是一个来自数学的概念。我们会在本书的后续部分深入分析需要理解它的更多理论。现在则只需要记住“Monoid 是一个拥有可结合的二元运算和一个单位元的代数结构”。一些你需要知道的关键字：</p>
<ul>
<li>可结合的二元运算：(a+b)+c = a+(b+c)</li>
<li>单位元：a+i = i+a = a，这里 i 则为单位元，比如整数中的 0，字符串中的空串““</li>
</ul>
<p>重要的是 Monoid 为我们提供了一种可能性：使用通用的方式来处理不同类型的值。它支持我们将成对的(两两的)操作适用于序列；结合律让并行化称为可能，单位元元素让我们知道如何处理空列表。Monoid 让我们更易于描述和实现集合。</p>
<h4 id=monads>Monads</h4>
<p>在函数式编程中，Monad 是用于将计算描述为步骤序列的结构。Monad 可用于构建流水线，在一切都是不可变的语言中以更清洁的方式添加带有副作用的操作，实现组合。定义可能听起来晦涩难懂，但是通过几个句子来解释 Monad 恐怕是难以实现的。在本书的后续部分，我们会继续关注它并尝试不使用复杂的数学理论来使其更加清晰。我们将会尝试展示为什么 Monad 有用，他们又带来了什么帮助，直到开发者能够很好的理解他们。</p>
<h4 id=functors>Functors</h4>
<p>Functor 来自范畴论，和 Monad 一样，正确的解释它恐怕要花点时间。我们将会在本书后续部分继续关注它，现在你可以理解为 Functor 能够支持我们将类型<code>A => B</code>的一个函数提升为类型<code>F[A] => F[B]</code>的函数。</p>
<h3 id=scala-特定模式>Scala 特定模式</h3>
<p>这个分类中的模式可以被归类到之前提到的那些分类中。然而，它们是 Scala 所特有的并利用了一些本书中将会关注的语言特性，因此我们决定将它们放在一个单独的分类中。</p>
<p>这里我们将会关注如下模式：</p>
<ul>
<li>透镜(lens)模式</li>
<li>蛋糕模式</li>
<li>皮条客(Pimp my library)模式</li>
<li>叠加特质</li>
<li>类型类</li>
<li>惰性求值</li>
<li>偏函数</li>
<li>隐式注入</li>
<li>鸭子类型</li>
<li>记忆(Memoization)模式</li>
</ul>
<h4 id=透镜模式>透镜模式</h4>
<p>Scala 提倡不可变性。对象的不可变可以保证更少的错误。但是有时候可变性在所难免，透镜模式使我们更好的实现可变性。</p>
<h4 id=蛋糕模式>蛋糕模式</h4>
<p>蛋糕模式是 Scala 中实现依赖注入的方式。常被用于实际的应用，有多中库来帮助开发者实现这种模式。Scala 提供了一种使用语言特性实现这种模式的方式，也就是蛋糕模式。</p>
<h4 id=皮条客模式>皮条客模式</h4>
<p>很多时候开发者需要使用非常泛型的库。但是有时我们需要更接近于我们场景的东西。这种模式支持为这些不可变的库添加扩展方法。或者用于我们自己的库，并且能够提供更好的可读性。</p>
<h4 id=叠加特质>叠加特质</h4>
<p>以 Scala 的方式实现装饰器模式。也可以用于组合功能，基于一些 Scala 提倡的特性。</p>
<h4 id=类型类>类型类</h4>
<p>通过定义一个行为并且能够被指定类型的类的所有成员所支持，来编写泛型代码。比如，所有的数字都必须支持加法和减法操作。</p>
<h4 id=惰性求值>惰性求值</h4>
<p>有时需要处理一些耗时或代价昂贵的操作。但是有些时候这些操作最终并不需要。该技术使一些操作只有在需要的时候才会执行。可以用于应用优化。</p>
<h4 id=偏函数>偏函数</h4>
<p>数学和函数式编程非常近似。这些函数被定义为只能处理接收类型的一个子集。</p>
<h4 id=隐式implicit注入>隐式(implicit)注入</h4>
<p>基于 Scala 的隐式功能。当对象被需要时进行隐式注入，只要他们在当前作用域。</p>
<h4 id=鸭子类型>鸭子类型</h4>
<p>Scala 提供的类似于动态语言的特性。</p>
<h4 id=记忆模式>记忆模式</h4>
<p>根据输入，通过记住函数结果来提供优化。</p>
<h2 id=如何选择>如何选择</h2>
<p>我们已经见到相当多的设计模式了。在很多场景下他们可以组合使用。不幸的是，对于如何选择概念来设计我们的代码并没有确定的回答。有多种因素会影响最后的决定，你也要问自己下面所列的问题：</p>
<ul>
<li>这段代码是趋于稳定还是将会被修改</li>
<li>是否需要动态决定算法的选择</li>
<li>代码是否会被他人使用</li>
<li>是否有约定的接口</li>
<li>计划使用哪种库</li>
<li>是否有性能需求或限制</li>
</ul>
<p>这绝不是一个详尽的问题清单。有大量的因素会指示我们如何来构建系统的决定。然而，真正重要的是要拥有一个清晰的说明(clear specification)，如果有些东西看起来没遗漏了，它总是要在第一时间被检查。</p>
<p>在剩余的章节中，我们将会对是否要使用一种设计模式给出一些特定的建议。它们将会帮助你在开始编写代码之前去问正确的问题并作出正确的决定。</p>
<h2 id=总结>总结</h2>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c4fd4d2414cb10a1b7819f3298f7f905>2.2 - CH02-特质与混入组合</h1>
<p>在专研一些实际的设计模式之前，我们需要确保读者对 Scala 中的一些概念都很了解。这些概念中的很多一部分都会在后续用于实现实际的设计模式，同时能够意识到这些概念的能力、限制以及陷阱也是编写正确、高效代码的关键因素。尽管有些概念并不被认为是“官方上”的设计模式，但仍然可以使用它们来编写好的软件。甚至有些场景中，基于 Scala 的丰富特性，一些概念甚至可以使用语言特性来代替一种设计模式。最后，向我们前面提到的，设计模式的存在是因为一种语言的特性缺失，因为特性的不够丰富而不能完成一些需要的任务。</p>
<p>在第一个主题中我们将会了解特质与混入(mixin)组合。他们为开发者提供了一种可能来共享已实现的功能或在应用中为类定义接口。很多由特质与混入组合为开发者带来的可能性对于本书后续要实现的一些设计模式都是很有帮助的。本章将主要关注一下几个主题：</p>
<ul>
<li>特质</li>
<li>混入组合</li>
<li>多重继承</li>
<li>线性化</li>
<li>测试特质</li>
<li>特质与类</li>
</ul>
<h2 id=特质>特质</h2>
<p>大家或许对 Scala 中的特质持有不同的看法。他们不仅可以被视作类似其他语言中的接口，同时可以被当做一个拥有无参构造器的类。</p>
<blockquote>
<p><strong>特质参数</strong></p>
<p>Scala 编程语言充满活力，其发展很快。其中一个将会在 2.12 版本中探讨的趋势是特质参数。更多信息请查看 <a href=http://www.scala-lang.org/news/roadmap-next/>http://www.scala-lang.org/news/roadmap-next/</a>。</p>
</blockquote>
<p>在下面的几个小节中，我们将会以不同的视角来了解特质并为你提供一些如何使用它们的想法。</p>
<h3 id=特质作为接口>特质作为接口</h3>
<p>特质可以看做是其他语言中的接口，比如 Java。但是支持开发者实现其中的一部分或全部方法。每当特质中拥有一些代码，该特质则被称为 <strong>mixin(混入、混合)</strong>。让我们看一下下面这个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Alarm</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里<code>Alarm</code>是一个接口。仅拥有一个<code>trigger</code>方法，不拥有任何实现，如果它被混入一个非抽象的类则必须提供一个该方法的实现。</p>
<p>让我们看一下另一个特质的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Notifier</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>notificationMessage</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printNotification</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>notificationMessage</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个<code>Notifier</code>特质拥有一个已实现的方法，而<code>notificationMessage</code>的值和<code>clear</code>则需要由混入它的类来提供实现。此外，特质可以要求一个类必须拥有一个指定的变量，这类似于其他语言中的抽象类。</p>
<h4 id=混入带有变量的特质>混入带有变量的特质</h4>
<p>像上面提到的，特质可以要求类拥有一个指定的变量。一个有趣的用法是我们可以传递一个变量到类的构造器中。这样则可以满足该特质的需求：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NotifierImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>notificationMessage</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Notifier</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000>cleared</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里唯一的必要是在类的定义中该变量必须使用相同的名字并且前面要使用<code>val</code>关键字来修饰。如果上面的代码中我们不适用<code>val</code>关键字作为前缀，编译器则仍然会要求我们实现该特质。这种情况下，我们不得不为类的参数使用一个不同的名字，并在类体中拥有一个<code>override val notificationMessage</code>赋值。</p>
<p>这种行为的原因很简单：如果我们显式的使用<code>val</code>(或 var，根据特质要求)，编译器会创建一个字段，并拥有与参数相同作用域的 getter。如果我们仅拥有参数，仅当该参数被用作构造器的作用域之外时(比如用在该类的方法中)才会创建一个字段和内部的 getter。更完备的是，样例类(case class)会自动在参数之前追加<code>val</code>关键字。因此，如果我们使用这个<code>val</code>关键字，我们将会自动获得一个与该参数同名的字段、相同的作用域，同时将会自动覆写特质中对我们的要求。</p>
<h3 id=特质作为类>特质作为类</h3>
<p>特质同样可以以类的视角来看待。这种情况下，他们需要实现其所有的方法，同时仅拥有一个不接收任何参数的构造器。考虑下面的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Beeper</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>beep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>times</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>assert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>times</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#000>times</span> <span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Beep number: </span><span style=color:#4e9a06>$i</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在我们实际上可以直接实例化<code>Beeper</code>并调用其方法。比如下面的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>BeeperRunner</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>TIMES</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>beeper</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Beeper</span><span style=color:#ce5c00;font-weight:700>{}</span>		<span style=color:#8f5902;font-style:italic>// &lt;= 实例化一个特质
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>beeper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>beep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TIMES</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>像预期一样，运行代码后我们将看到如下输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Beep number: <span style=color:#0000cf;font-weight:700>1</span> 
Beep number: <span style=color:#0000cf;font-weight:700>2</span> 
Beep number: <span style=color:#0000cf;font-weight:700>3</span> 
....
</code></pre></div><h3 id=扩展类>扩展类</h3>
<p>特质同样可以用来扩展类。让我们看一下下面的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Connector</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConnectorWithHelper</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Connector</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>findDriver</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Find driver called.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PgSqlConnector</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConnectorWithHelper</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connected...&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Closed...&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>和预期的一样，<code>PgSqlConnector</code>会被抽象类约束来实现其抽象方法。你可能会推测，我们可以用一些别的特质来扩展这些类然后再将他们(同时)进行混入。在 Scala 中，我们会对一些情况稍加限制，在后续章节中我们研究组合的时候会来看一下这么做会对我们产生哪些影响。</p>
<h3 id=扩展特质>扩展特质</h3>
<p>特质可以被互相扩展。看一下如下例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Ping</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>ping</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ping&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>tring</span> <span style=color:#000>Pong</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pong</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pong&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>PingPong</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ping</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Pong</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pingPong</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ping</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>pong</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Runner</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>PingPong</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>pingPong</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>上面这个例子是比较简单的，实际上也可以让<code>Runner</code>分别来扩展两个特质。扩展特质可以很好的用来实现<strong>特质堆叠</strong>这种设计模式，本书的后续部分中我们将会探讨这个话题。</p>
</blockquote>
<h2 id=混入组合>混入组合</h2>
<p>Scala 支持开发者在一个类中扩展多个特质。这相对于那些不允许同时扩展多个类的语言增加了多重继承的可能性并且能剩下很多编写代码的精力。在这个子主题中，我们将会展示如果将多个特质混入到一个指定的类，或者在编写代码的时候如何创建一个带有某些指定功能的匿名类。</p>
<h3 id=混入特质>混入特质</h3>
<p>首先，我们先修改一下上个例子的代码。这个改动很小，它将会展示特质是如何被混入的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>MixinRunner</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Ping</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Pong</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>ping</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>pong</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从上面的代码中可以发现，我们可以将多个特质添加到同一个类中。上面代码中扩展的<code>App</code>特质主要是为了使用其自带的<code>main</code>方法。这会和创建无参类有点类似。</p>
<blockquote>
<p><strong>如何混入特质？</strong></p>
<p>将特质混入到类可以使用如下语法：<code>extends with T1 with T2 with T3 with ... Tn</code>。</p>
<p>如果一个类已经扩展了别的类，我们仅需要通过<code>with</code>关键字来添加特质。</p>
<p>如果特质方法在特质体内并没有被实现，同时我们混入该特质的类也没有声明为抽象类，则该类必须实现特质中的方法。否则，将会出现编译错误。</p>
</blockquote>
<h3 id=组合>组合</h3>
<p>创建时的组合给我们提供了一个无需显式定义就能创建匿名类的机会。同样，如果我们想要组合多个不同的特质，创建所有的可能则要花费很多的工作。</p>
<h4 id=组合简单特质>组合简单特质</h4>
<p>让我们看一个组合简单特质的例子，这里不会扩展其他类或特质：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>watch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>brand</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>initialTime</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Long</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Long</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>initialTime</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>WatchUser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>expensiveWatch</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Watch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;expensive brand&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1000L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Alarm</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Notifier</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The alarm was triggered.&#34;</span>
   <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Alarm cleared.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>notificationMessage</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Alarm is running!&#34;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cheapWatch</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Watch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cheap brand&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1000L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Alarm</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The alarm was triggered.&#34;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#8f5902;font-style:italic>// show some watch usage.
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expensiveWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>())</span>
  <span style=color:#000>expensiveWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printNotification</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The time is </span><span style=color:#4e9a06>${</span><span style=color:#000>expensiveWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>expensiveWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span>
  
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cheapWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>())</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cheap watches cannot manually stop the alarm...&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这个例子中我们使用了之前定义的<code>Alarm</code>和<code>Notifier</code>特质。我们创建了两个手表实例——一个是贵的，它拥有更多有用的功能；另一个是便宜的，它的功能则会少很多。本质上，他们都是匿名类，在初始化的时候被定义。另外要注意的是，和预期一样，我们需要实现那些我们扩展的特质中的抽象方法。希望这个例子能为你在拥有很多特质及多种可能的组合时带来一些想法。</p>
<p>只是为了完整，下面是上个程序的输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>The alarm was triggered.
Alarm is running!
The <span style=color:#204a87>time</span> is 1234567890562.
Alarm cleared.
The alarm was triggered.
Cheap watches cannot manually stop the alarm...
</code></pre></div><p>和预期一样，第三行的时间会在每次运行的时候都有所不同。</p>
<h4 id=组合复杂特质>组合复杂特质</h4>
<p>在有些可能的情况下，我们需要组合更加复杂的特质，这些特质可能扩展了一些别的类或特质。如果在继承链的上层没有一个特质或别的特质已经显式扩展了一个指定的类，事情则会变得很简单，他们也不会改变太多。这种情况下，我们可以简单的访问超特质的方法。然而，让我们看一下如果继承链中的特质已经扩展了一个指定的类会发生什么。在这个例子中，我们将会使用之前定义的<code>ConnectorWithHelper</code>特质。该特质扩展了名为<code>Connector</code>的抽象类。加入我们想拥有另一个非常昂贵的手表，比如它可以连接到数据库：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>ReallyExpensiveWatchUser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>reallyExpensiveWatch</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Watch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;really expensive brand&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1000L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ConnectorWithHelper</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connected with another connector.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Closed with another connector.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Using the really expensive watch.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>reallyExpensiveWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>findDriver</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>reallyExpensiveWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>reallyExpensiveWatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看起来都很好，但是当我们编译的时候，会得到如下错误信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Error:<span style=color:#ce5c00;font-weight:700>(</span>36, 80<span style=color:#ce5c00;font-weight:700>)</span> illegal inheritance<span style=color:#000;font-weight:700>;</span> superclass Watch
	is not a subclass of the superclass Connector of the mixin trait ConnectorWithHelper
	val <span style=color:#000>reallyExpensiveWatch</span> <span style=color:#ce5c00;font-weight:700>=</span> new Watch<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;really expensive brand&#34;</span>,
	1000L<span style=color:#ce5c00;font-weight:700>)</span> with ConnectorWithHelper <span style=color:#ce5c00;font-weight:700>{</span>
^
</code></pre></div><p>该错误消息告诉我们，由于<code>ConnectorWithHelper</code>特质已经扩展了<code>Connector</code>类，所有使用该特质进行组合的类必须是<code>Connector</code>的子类。现在让我们假如需要混入另一个同样已经扩展了一个类的特质，但被扩展的这个类与之前不同。根据之前的逻辑，会需要<code>Watch</code>同样需要是该类的子类。但这是不可能出现的，因为我们同时只能扩展一个类，这也就是 Scala 如何来限制多重继承以避免危险错误的发生。</p>
<p>如果我们想要修复这个例子的编译错误，我们不得不去修改原有的<code>Watch</code>类的实现以确保其是<code>Connector</code>的子类。然而这可能并非我们所原本期望的，或许这种情况下需要一些重构。</p>
<h4 id=组合自类型self-type>组合自类型(self-type)</h4>
<p>在上一节中，我们看到了如何在<code>Watch</code>类中扩展<code>Connector</code>以便能够编译我们的代码。有些场景中我们或许真的需要强制一个类来混入一个特质，或者同时有其他的特质或多个特质需要混入。让我们加入需要一个闹钟同时带有提醒功能：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>AlarmNotifier</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#204a87;font-weight:700>Notifier</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里我们展示了什么是自类型。第二行代码将<code>Notifier</code>的所有方法引入到了新特质的当前作用域，它同时要求所有混入了该特质的类必须同时混入<code>Notifier</code>。否则将会出现编译错误。如果使用<code>self</code>来代替<code>this</code>，我们则可以使用手动的方式来在<code>AlarmNotifier</code>中引用<code>Notifier</code>的方法，比如<code>self.printNotification()</code>。</p>
<p>下面的代码展示了如何来使用这个新的特质：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>SelfTypeWatchUser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>AlarmNotifier</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>watch</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Watch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;alarm with notification&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>AlarmNotifier</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Notifier</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Alarm triggered.&#34;</span>
      <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Alarm cleared.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>notificationMessage</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The notification.&#34;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>watch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>())</span>
  <span style=color:#000>watch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printNotification</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The time is </span><span style=color:#4e9a06>${</span><span style=color:#000>watch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>watch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果在上面的代码中去掉同时扩展<code>Notifier</code>的部分则会出现编译错误。</p>
<p>在这个小节中，我们展示了子类型的简单用法。一个特质可以要求在被混入的同时混入其他一个或多个特质，多个的时候仅需要使用<code>with</code>关键字分割即可。子类型是实现“蛋糕模式”的关键，该模式用于依赖注入。本书后续部分我们会看到更多有趣的用法。</p>
<h3 id=特质冲突>特质冲突</h3>
<p>你的脑海中可能已经出现了一个问题——如果我们混入的特质中拥有相同签名的方法会怎样？下面的几个小节我们将会探讨该问题。</p>
<h4 id=相同签名和返回类型>相同签名和返回类型</h4>
<p>考虑一个例子，我们想要混入的两个特质拥有相同的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>FormalGreeting</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>InformalGreeting</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Greeter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FormalGreeting</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>InformalGreeting</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Good morning, ser/madam!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>GreeterUser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>greeter</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Greeter</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>greetrt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>())</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这个例子中，接待员总是会很有礼貌并且同时混入正式的和非正式的问候。在实现时仅需要实现该方法一次。</p>
<h4 id=相同签名和不同返回类型>相同签名和不同返回类型</h4>
<p>如果我们的问候特质拥有更多方法，签名相同但返回类型不同呢？我们将下面的声明添加到<code>FormalGreeting</code>中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
</code></pre></div><p>同时向<code>InformalGreeting</code>中添加：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
</code></pre></div><p>这种情况下我们需要在<code>Greeter</code>中实现同时实现这两个方法。然而，编译器不允许我们定义<code>getTime</code>两次，这表示 Scala 中会避免发生这样的事。</p>
<h4 id=相同签名和返回类型的混入>相同签名和返回类型的混入</h4>
<p>在继续之前，快速回忆一下混入只是一个带有一些代码实现的特质。这意味着在下面的例子中，我们不需要在使用它们的类中实现这些方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello, I am trait A!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>B</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello, I am trait B!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Clashing</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>B</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>())</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可能和预期一样，我们会得到一个编译错误信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Error:<span style=color:#ce5c00;font-weight:700>(</span>11, 8<span style=color:#ce5c00;font-weight:700>)</span> object Clashing inherits conflicting members:
	method hello in trait A of <span style=color:#204a87>type</span> <span style=color:#ce5c00;font-weight:700>()</span>String and
	method hello in trait B of <span style=color:#204a87>type</span> <span style=color:#ce5c00;font-weight:700>()</span>String
<span style=color:#ce5c00;font-weight:700>(</span>Note: this can be resolved by declaring an override in object Clashing.<span style=color:#ce5c00;font-weight:700>)</span> 
object Clashing extends A with B <span style=color:#ce5c00;font-weight:700>{</span> 
       ^
</code></pre></div><p>该信息很有用，它甚至为我们提供了一个如何修复问题的提示。方法冲突在多重继承中是一个问题，但是和你看到的一样，我们致力于选择一个可用的方法。在<code>Clashing</code>对象中我们或许可以这样修改：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span>
</code></pre></div><p>然而，如果处于某些原因我们相同时使用两个方法呢？这种情况下，我们可以创建另外一个名字不同的方法来调用另一个指定特质中的方法。我们同样可以直接通过<code>super</code>符号直接引用这些方法而不是将他们包装在另一个方法中。然而我个人更倾向于包装在另一个方法内，否则代码将会变得很乱。</p>
<blockquote>
<p><strong>super 符号</strong></p>
<p>如果在上面的例子中，我们直接使用<code>override def hello(): String = super.hello()</code>而不是<code>super[A]. hello()</code>，真正被选择的又是那个特质中的方法呢？这种情况下将会选择 B 中的方法。这取决于 Scala 中的线性化特性，我们将在后面的章节中详细讨论。</p>
</blockquote>
<h4 id=相同签名和不同返回类型的混入>相同签名和不同返回类型的混入</h4>
<p>和预期一样，如果方法的传入参数在类型或数量上有所不同则上面的问题就不再存在，因为这成了一个新的签名。但如果特质中有如下两个方法问题则仍然存在：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span> <span style=color:#8f5902;font-style:italic>// in trait A 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span> <span style=color:#8f5902;font-style:italic>// in trait B
</span></code></pre></div><p>我用用过的方式在这里不再有效，你可能会对此感到吃惊。如果我们决定仅覆写特质 A 中的方法，将会得到如下编译错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Error</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>19</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#a40000>16</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>overriding</span> <span style=color:#000>method</span> <span style=color:#000>value</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>B</span> <span style=color:#000>of</span> <span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>a:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>;</span> 
  <span style=color:#000>method</span> <span style=color:#000>value</span> <span style=color:#000>has</span> <span style=color:#000>incompatible</span> <span style=color:#204a87;font-weight:700>type</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>a:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
  			   <span style=color:#ce5c00;font-weight:700>^</span>
</code></pre></div><p>如果重写 B 中的方法，错误也会随之改变。而如果两个都覆写，则会得到如下错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Error</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>20</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#a40000>16</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>method</span> <span style=color:#000>value</span> <span style=color:#000>is</span> <span style=color:#000>defined</span> <span style=color:#000>twice</span> 
  <span style=color:#000>conflicting</span> <span style=color:#000>symbols</span> <span style=color:#000>both</span> <span style=color:#000>originated</span> <span style=color:#000>in</span> <span style=color:#000>file</span> <span style=color:#a40000>&#39;</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>to</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>traits</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>ivan</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>nikolov</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>composition</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Clashing</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>scala</span><span style=color:#a40000>&#39;</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这展示了 Scala 会避免我们在多重继承中进行这样危险的操作。为了完整，如果你遇到类似的问题，仍然存在变通的方式，比如像下面的例子一样，牺牲掉混入的功能：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>D</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Example</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>C</span><span style=color:#ce5c00;font-weight:700>{}</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>d</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>D</span><span style=color:#ce5c00;font-weight:700>{}</span>
  
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;c.value: </span><span style=color:#4e9a06>${</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;d.value: </span><span style=color:#4e9a06>${</span><span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码中把特质当做合作者使用，但这也丢掉了混入这些特质的类的实例同样也拥有这些特质的类型这一事实(即扩展了特质的类，其实例同时拥有特质的类型)，这一性质在某些操作中会很有用。</p>
<h2 id=多重继承>多重继承</h2>
<p>因为可以同时混入多个特质，而且这些特质都可以拥有各自不同的方法实现，因此我们已经在前面的章节中多次提到了多重继承。多重继承不仅是一个强大的技术，同时也很危险，甚至有些语言中决定不进行支持，比如 Java。向我们看到的一样，Scacla 对此进行了支持，不过带有一些限制。本节中我们会接收多重继承的问题及 Scala 是如何处理这些问题的。</p>
<h3 id=菱形问题>菱形问题</h3>
<p>多重继承忍受着菱形问题的痛苦。</p>
<p>让我们看一下下面的图示：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214164203.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>如图，B 和 C 同时扩展了 A，然后 D 同时扩展了 B 和 C。这看起来可能不是很清晰。比如我们有个方法一开始定义在 A，但是 B 和 C 同时覆写了它。当在 D 中调用该方法时会发生什么呢？实际上调用的是哪个方法呢？</p>
<p>因为上面的问题有点模糊或将引起错误。让我们使用 Scala 的特质来重新描述一下该问题：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello from A&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>B</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello from B&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>C</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello from C&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>D</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>B</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>C</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Diamond</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>D</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>())</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行后会得到如下结果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Hello from C
</code></pre></div><p>如果我们把特质 D 修改为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>D</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>C</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>B</span> <span style=color:#ce5c00;font-weight:700>{</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>则会得到结果为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Hello from B
</code></pre></div><p>你会发现，尽管例子仍然会有点模糊甚至易于出错，我们可以告诉你实际上被调用的是哪个方法。这是通过**线性化(linearization)**实现的，在下一节中会深入介绍。</p>
<h3 id=限制>限制</h3>
<p>在我们关注线性化之前，让我们指出 Scala 所支持的多重继承拥有的限制。我们之前已经见过他们很多次，这里会概括描述。</p>
<blockquote>
<p><strong>Scala 多重继承限制</strong></p>
<p>Scala 中的多重继承由特质实现并遵循线性化规则。</p>
<p>在多重继承中，如果一个特质已经显式扩展了一个类，则混入该特质的类必须是之前特质混入的类的子类。这意味着当混入一个已扩展了别的类的特质时，他们必须拥有相同的父类。</p>
<p>如果特质中<strong>定义</strong>或<strong>声明</strong>了相同签名但返回类型不同的方法，则无法混入这些特质。</p>
</blockquote>
<p>需要特别小心的是特质中<strong>定义</strong>了相同签名和返回类型的方法。若果方式仅是<strong>声明</strong>而被要求实现，这不会带来问题而且只需要提供一个实现即可。</p>
<h2 id=测试特质>测试特质</h2>
<p>测试实际上是软件开发中很重要的一部分。它确保了代码中变更的部分不再产生错误，无论是方法的改变还是其他部分。</p>
<p>我们可以使用多种不同的测试框架，这完全取决于个人喜好。本书中我们将使用 ScalaTest，这也是我在项目中使用的框架；它很容易理解，可读且易于使用。</p>
<p>有些情况下，如果一个特质被混入到了类中，我们则可以直接测试这个类。然而，我们或许仅需要测试一个指定的特质。测试一个没有任何方法实现的特质也没有什么意义，因此这么我会探讨那些拥有代码实现的特质。同时，我们这里展示的单元测实际上是很简单的，他们也仅作为示例。我们会在本书的后续章节讨论更加复杂和有意义的测试。</p>
<h3 id=使用一个类>使用一个类</h3>
<p>让我们看一下前面见到的<code>DoubledMultiplierIdentity</code>将会被如何测试。一种方式是将这个特质混入一个测试类来测试它的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DoubledMultiplierIdentityTest</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Flatspec</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ShouldMatchers</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>DoubledMultiplierIdentity</span>
</code></pre></div><p>然而这会编译失败并显示一个错误信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Error</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#a40000>79</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>illegal</span> <span style=color:#000>inheritance</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>superclass</span> <span style=color:#000>FlatSpec</span> 
  <span style=color:#000>is</span> <span style=color:#000>not</span> <span style=color:#000>a</span> <span style=color:#000>subclass</span> <span style=color:#000>of</span> <span style=color:#000>the</span> <span style=color:#000>superclass</span> <span style=color:#000>MultiplierIdentity</span> 
  <span style=color:#000>of</span> <span style=color:#000>the</span> <span style=color:#000>mixin</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>DoubledMultiplierIdentity</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DoubledMultiplierIdentityTest</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FlatSpec</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ShouldMatchers</span> 
<span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>DoubledMultiplierIdentity</span> <span style=color:#ce5c00;font-weight:700>{</span> 
<span style=color:#ce5c00;font-weight:700>^</span>
</code></pre></div><p>我们在前面已经谈论过这个问题，事实上特质只能被混入到一个与该特质拥有相同基类的类。这意味着为了测试这个特质，我们需要在我们的测试类中创建一个虚拟的类然后再使用它：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.ivan.nikolov.linearization</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.scalatest.</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>ShouldMatchers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>FlatSpec</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DoubledMultiplierIdentityTest</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FlatSpec</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ShouldMatchers</span> <span style=color:#ce5c00;font-weight:700>{</span>
  
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DoubledMultipliersIdentityClass</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DoubledMultiplierIdentity</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>instance</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DoubledMultiplierIdentityClass</span>
  
  <span style=color:#4e9a06>&#34;identity&#34;</span> <span style=color:#000>should</span> <span style=color:#4e9a06>&#34;return 2 * 1&#34;</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>identity</span> <span style=color:#000>should</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=混入特质-1>混入特质</h3>
<p>我们可以将特质混入来对他进行测试。有几个地方我们可以这么做：混入到一个测试类或者一个单独的测试用例。</p>
<h4 id=混入到测试类>混入到测试类</h4>
<p>只有当该特质确定没有扩展任何其他类时，才可以将该特质混入到一个测试类，因此特质、测试类的超类必须是相同的。除了这样，其他任何方式都和我们前面做的一样。</p>
<p>让我们测试一个本节出现过的特质 A，他拥有一个<code>hello</code>方法。同时我们添加了一个<code>pass</code>方法，现在该特质看起来会像下面这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello, I am trait A!&#34;</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;Trait A said: &#39;You passed </span><span style=color:#4e9a06>$a</span><span style=color:#4e9a06>.&#39;&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后是测试类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.ivan.nikolov.composition</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.scalatest.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>ShouldMatchers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>FlatSpec</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TraitTest</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FlatSpec</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ShouldMatchers</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#000>should</span> <span style=color:#4e9a06>&#34;greet properly.&#34;</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#000>should</span> <span style=color:#000>equal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, I am trait A！&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
   
  <span style=color:#4e9a06>&#34;pass&#34;</span> <span style=color:#000>should</span> <span style=color:#4e9a06>&#34;return the right string with the number.&#34;</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>{</span>
	  <span style=color:#000>pass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>should</span> <span style=color:#000>equal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Trait A said: &#39;You passed 10.&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
   <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>it</span> <span style=color:#000>should</span> <span style=color:#4e9a06>&#34;be correct also for negative values.&#34;</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>pass</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>should</span> <span style=color:#000>equal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Trait A said: &#39;You passed -10.&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=混入到测试用例>混入到测试用例</h4>
<p>我们同样可以将特质分别混入到个别测试案例中。这样可以支持我们单独为这些测试用例设置自定义。下面是对上面那个单元测试的另一种表示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.ivan.nikolov.composition</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.scalatest.</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>ShouldMatchers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>FlatSpec</span> <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TraitCaseScopeTest</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FlatSpec</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ShouldMatchers</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#000>should</span> <span style=color:#4e9a06>&#34;greet properly.&#34;</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>new</span>  <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>hello</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#000>should</span> <span style=color:#000>equal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello, I am trait A!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#4e9a06>&#34;pass&#34;</span> <span style=color:#000>should</span> <span style=color:#4e9a06>&#34;return the right string with the number.&#34;</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>pass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>should</span> <span style=color:#000>equal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Trait A said: &#39;You passed 10.&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#000>it</span> <span style=color:#000>should</span> <span style=color:#4e9a06>&#34;be correct also for negative values.&#34;</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>pass</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>should</span> <span style=color:#000>equal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Trait A said: &#39;You passed -10.&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面的代码中你可以看到，这些测试用例与前面的例子一样。但是是在单独的用例中混入 A。这支持我们对不同的用例设置自定义，比如一个特质需要一个方法的实现或者一个变量的初始化。这种方式也可以让我们仅专注于要测试的特质，而不需要创建它的一些实际的实例。</p>
<h3 id=运行测试>运行测试</h3>
<p>在测试编写完成后，运行并观察一切是否符合预期是很有用的。仅需要在项目的根目录执行以下命令将会运行所有测试：<code>mvn clean test</code>。</p>
<p>如果你需要，可以将 Maven 项目转换为 SBT 项目，然后通过<code>sbt test</code>来触发所有测试。</p>
<h2 id=特质与类>特质与类</h2>
<p>特质或许与类很相似，但同时又有很大的不同。对于开发者来说或许很难在不同的场景中进行选择，不过我们会尝试提供一个通用的指导方针以帮助开发者：</p>
<p>使用类：</p>
<ul>
<li>当一个行为根本不会被复用或在多个地方出现</li>
<li>如果你计划在其他语言中使用 Scala 代码，比如创建一个将会在 Java 中使用的库</li>
</ul>
<p>使用特质：</p>
<ul>
<li>当一个行为将会被复用到多个不相关的类中</li>
<li>当你需要定义一个接口并在 Scala 之外使用，比如 Java 中。因为那些没有任何代码实现的特质被编译后与接口类似</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7cf846c344c0c6fa6b0f9ee2fd2cd967>2.3 - CH03-统一化</h1>
<p>为了能够理解和编写好的 Scala 代码需要开发者熟知语言中不同的概念。到目前，我们已经在几个地方提到了 Scala 是真的很具有表现力。在某种程度上，这是因为有很多编程的概念被统一化了。在本章中，我们将会关注如下概念：</p>
<ul>
<li>函数与类</li>
<li>代数数据类型和类层级</li>
<li>模块与对象</li>
</ul>
<h2 id=函数与类>函数与类</h2>
<p>在 Scala 中，所有的值都是一个对象。函数作为第一类值，同时作为他们各自的类的对象。下面的图示展示了 Scala 中被统一的类型系统和实现方式。该图来自 <a href=http://www.scala-lang.org/old/sites/default/files/images/classhierarchy.png>http://www.scala-lang. org/old/sites/default/files/images/classhierarchy.png</a>，它表示了模型的最新视图(有些类比如<code>ScalaObject</code>已经被移除)。</p>
<p>又可以发现，Scala 中并没有 Java 中的原始类型概念，所有的类型最终都是<code>Any</code>的子类型。</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214164520.png style=display:block;width:70% alt=NAME align=center>
</div>
<h3 id=函数作为类>函数作为类</h3>
<p>函数作为类实际上意味着如果他们仅仅是值的话，则可以被自由的传递给其他方法或类。这提高了 Scala 的表现力也让他相对与其他语言(比如 Java)更易于实现一些事情，比如回调。</p>
<h4 id=函数字面值>函数字面值</h4>
<p>让我们看一个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FunctionLiterals</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FunctionLiterals</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>obj</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FunctionLiterals</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;3 + 9 = </span><span style=color:#4e9a06>${</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里我们可以看到<code>FunctionLiterals</code>类的<code>sum</code>字段是如何被赋值为一个函数的。我们可以将任意函数赋值给一个变量，然后把它当做一个函数调用(实际上是调用了它的<code>apply</code>方法)。函数同样可以作为参数传递给其他方法。让我们向<code>FunctionLiterals</code>类中添加如下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>runOperation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以传递需要的函数到<code>runOperation</code>，像下面这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>runOperation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>runOperation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>max</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h4 id=没有语法糖的函数>没有语法糖的函数</h4>
<p>上个例子中我们只是使用了一些语法糖。为了能够理解实际上发生了什么，我们将会展示函数的字面被转换成了什么。他们基本上表示为扩展<code>FunctionN</code>特质，这里 N 是函数参数的数量。函数字面量的实现会通过<code>apply</code>方法被调用(一旦一个类或对象拥有<code>apply</code>方法，则可以通过一对小括号来调用它并传入对应需要的参数)。让我们看一下等同于上个例子的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SumFunction</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Function2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v1</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v2</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>v2</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FunctionObjects</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SumFunction</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>runOperation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FunctionObjects</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>obj</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FunctionObjects</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;3 + 9 = </span><span style=color:#4e9a06>${</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Calling run operation: </span><span style=color:#4e9a06>${</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>runOperation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Using Math.max: </span><span style=color:#4e9a06>${</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>runOperation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>max</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=增加的表现力>增加的表现力</h4>
<p>像你在例子中看到的一样，统一化的类和函数提升了表现力，你可以轻松实现不同的任务，比如回调、惰性参数求值、集中的异常处理等等，而无需编写额外的代码和逻辑。此外，函数可以作为类意味着我们可以扩展它们以提供能多的功能。</p>
<h2 id=代数数据类型>代数数据类型</h2>
<p>代数数据类型和类层级是 Scala 中的另一种统一化。在其他的函数式语言中都拥有不同的方式来创建自定义的代数数据类型。在 Scala 中，这是通过类层级来实现的，称为<code>case class</code>和<code>object</code>。让我们看一下 ADT 到底是什么，他们是什么类型，以及如何定义它们。</p>
<h3 id=adts>ADTs</h3>
<p>代数数据类型只是一种组合类型，它会组合一些已存在的类型或仅表示一些新类型。它们中仅包含数据而非像常规类一样包含任何数据之上的功能。比如，一周之中的一天，或者一个表示 RGB 颜色的类——他们没有任何功能，仅仅是包含类一些信息。下面的几个小节将会带你洞悉 ADT 是什么以及它们是什么类型。</p>
<h4 id=概括-adt>概括 ADT</h4>
<p>整体 ADT 是一种我们可以简单的枚举一个类型所有可能的值并为每个值提供一个单独的构造器。作为一个例子，我们考虑一下一年的所有月份。一年中仅有 12 个月，而且不会改变：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Month</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>January</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>February</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>March</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>April</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>May</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>June</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>July</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>August</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>September</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>October</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>November</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>December</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Month</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>MonthDemo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>month</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Month</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>February</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The current month is: </span><span style=color:#4e9a06>$month</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行这个程序将会得到如下输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>The current month is: February
</code></pre></div><blockquote>
<p>上面代码中的<code>Month</code>是密闭的(使用 sealed 关键字声明)，因为我们不想在当前文件之外被扩展。你可以发现，我们将不同的月份定义为对象，因为没有动机让他们成为分开的实例。值就是他们本身，同时也不会改变。</p>
</blockquote>
<h4 id=产品-adt>产品 ADT</h4>
<p>在产品 ADT 类型中，我们无法枚举所有可能的值。手写他们通常会非常多。我们不能为每个单独的值提供各自的构造器。</p>
<p>比如颜色，有不同的颜色模型，不过最常见的是 RGB。它将主要颜色的不同值进行组合(红绿蓝)以表示其他颜色。假如每种颜色的值区间为 0 - 255，这意味着要表示所有可能的颜色，我们需要 256 的三次方个构造器。因此我们可以使用一个产品 ADT：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>REB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>red</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>green</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>blue</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>RGBDemo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>magenta</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>RGB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Magenta in RGB is: </span><span style=color:#4e9a06>$magenta</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>可以发现，对于产品 ADT 来说，所有不同的值拥有同一个构造器。</p>
</blockquote>
<h4 id=混合-adt>混合 ADT</h4>
<p>混合 ADT 表示一个概况和产品的组合。这意味我们可以拥有特定的值构造器，不过这些值构造器同时接收参数以包装其他类型。</p>
<p>让我们看一个例子。加入我们正在编写一个绘图程序：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Shape</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>radius</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Shape</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rectangle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Shape</span>
</code></pre></div><p>我们拥有不同的形状。这个例子中展示了一个概况 ADT，因为我们拥有<code>Circle</code>和<code>Rectangle</code>两个特定的值构造器。同时我们也拥有一个产品 ADT，因为这两个特定的值构造器同时接收额外的参数以表示更多的类型。</p>
<p>我们把这个类展开一点。当绘制形状时，我们需要知道其位置。因此我们可以添加一个 Point 类来持有 x 和 y 坐标：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Shape</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>centre</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Point</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>radius</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Shape</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rectangle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>topLeft</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Point</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Shape</span>
</code></pre></div><p>希望这有助于理解 Scala 中的 ADT 是什么以及如何使用它们。</p>
<h4 id=统一化>统一化</h4>
<p>在所有上面的例子之后，可以明显的发现类层级和 ADT 是被统一化的而且看起来是同一件事。这给语言添加了一个更高级别的灵活性，使相其对于其他函数式语言中的建模则更加容易。</p>
<h3 id=模式匹配>模式匹配</h3>
<p>模式匹配常用于 ADT。当基于 ADT 的值来做什么事的时候它会使代码更清晰易读，相对于<code>if-else</code>语句也更易扩展。你可能会认为这些语句在有些场景会难以处理，特别是某个数据类型拥有多种可能的值时。</p>
<h4 id=对值进行模式匹配>对值进行模式匹配</h4>
<p>在之前月份的例子中，我们仅拥有月份的名字。我们或许需要他们的数字，否则电脑将不知道这是什么。下面展示了做法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Month</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>month</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Month</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>month</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>January</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>1</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>February</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>2</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>March</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>3</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>April</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>4</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>May</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>5</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>June</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>6</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>July</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>7</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>August</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>8</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>September</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>9</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>October</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>10</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>November</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>11</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>December</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>12</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>你可以看到我们基于他们来匹配不同的值，并最终返回这行正确的值。现在可以这样使用该方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The current month is: </span><span style=color:#4e9a06>$month</span><span style=color:#4e9a06> and it&#39;s number </span><span style=color:#4e9a06>${</span><span style=color:#000>Month</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>month</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>和预期一样，我们的应用会生成如下输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>The</span> <span style=color:#000>current</span> <span style=color:#000>month</span> <span style=color:#000>is</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>February</span> <span style=color:#204a87;font-weight:700>and</span> <span style=color:#204a87;font-weight:700>it</span><span style=color:#a40000>&#39;</span><span style=color:#204a87;font-weight:700>s</span> <span style=color:#204a87;font-weight:700>number</span> <span style=color:#a40000>2</span>
</code></pre></div><p>实际上因为我们指定了基特质为密闭约束，因此在我们的代码之外没人能够扩展它们，同时我们拥有一个没有遗漏的模式匹配。不完整的模式匹配将会充满问题。作为实验，如果我们将二月份注释掉并编译我们的代码，将会得到如下警告：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Warning</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>19</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#a40000>5</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#000>may</span> <span style=color:#000>not</span> <span style=color:#000>be</span> <span style=color:#000>exhaustive</span><span style=color:#ce5c00;font-weight:700>.</span>
<span style=color:#000>It</span> <span style=color:#000>would</span> <span style=color:#000>fail</span> <span style=color:#000>on</span> <span style=color:#000>the</span> <span style=color:#000>following</span> <span style=color:#000>input</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>February</span>
	<span style=color:#000>month</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>^</span>
</code></pre></div><p>运行这个例子将会证明这个警告的正确性，当传入参数使用<code>February</code>时我们的代码将会失败。为了完整，我们可以添加一个默认的情况：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>0</span>
</code></pre></div><h4 id=对产品类型进行模式匹配>对产品类型进行模式匹配</h4>
<p>当模式匹配用于产品或混合 ADT 时将会展示其强大力量。在这种情况下，我们可以匹配这些数据类型的实际值。让我们展示如何实现一个功能来计算面积的值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Shape</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shape</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Shape</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>shape</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>radius</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>PI</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>Match</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>radius</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Rectangle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>w</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在匹配时可以忽略我们不关心的值。对于面积，我们实际上不需要位置信息。在上面的代码中，我们仅仅展示了匹配的两种方式。下划线<code>_</code>操作符可以用于<code>match</code>语句的任何位置，它仅仅会忽略所处位置的值。在这之后，直接使用我们的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>ShapeDemo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>circle</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#0000cf;font-weight:700>2.5</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>rect</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Retangle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The circle area is: </span><span style=color:#4e9a06>${</span><span style=color:#000>Shape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>circle</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The rectangle area is: </span><span style=color:#4e9a06>${</span><span style=color:#000>Shape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rect</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以得到类似下面的输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>The</span> <span style=color:#000>circle</span> <span style=color:#000>area</span> <span style=color:#000>is</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#a40000>19</span><span style=color:#204a87;font-weight:700>.</span><span style=color:#a40000>634954084936208</span> 
<span style=color:#204a87;font-weight:700>The</span> <span style=color:#204a87;font-weight:700>rectangle</span> <span style=color:#204a87;font-weight:700>area</span> <span style=color:#204a87;font-weight:700>is:</span> <span style=color:#a40000>30</span><span style=color:#204a87;font-weight:700>.</span><span style=color:#a40000>0</span>
</code></pre></div><p>在模式匹配时，我们甚至可以使用常量来代替变量来作为 ADT 的构造器参数。这使语言更加强大并支持我们实现更加复杂的逻辑，并且看起来也会很不错。你可以根据上面的例子进行试验以便更深入理解模式匹配的工作原理。</p>
<blockquote>
<p>模式匹配常用语 ADT，它有助于实现清晰、可扩展及无遗漏的代码。</p>
</blockquote>
<h2 id=模块与对象>模块与对象</h2>
<p>模块是组织程序的一种方式。它们是可互换的和可插拔的代码块，有明确定义的接口和隐藏的实现。在 Java 中，模块以包的形式组织。在 Scala 中，模块是对象，就像其他的一切一样。这意味它们可以被参数化、被扩展、像参数一样传递，等等。</p>
<p>Scala 的模块可以提供必要环境以便使用。</p>
<h3 id=使用模块>使用模块</h3>
<p>我们已经总结了 Scala 中模块也是对象而且同样被统一化了。这意味着我们可以在我们的应用中传递一个完整的模块。这可以很有用，然而，下面展示一个模块看起来是什么样子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Tick</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Ticker</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tick</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>ticker</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Ticker</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里，<code>Tick</code>仅是我们一个模块的一个接口。下面是它的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>TickUser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Tick</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TickUserImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ticker</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>curr</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>cont</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>curr</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tick</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>curr</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>curr</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>ticker</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TickUserImpl</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个<code>TickUser</code>实际上是一个模块。它实现了<code>Tick</code>并在其中隐藏了代码。我们创建了一个单例对象来提供实现。对象的名字和<code>Tick</code>中的方法名一样。这样混入该特质的时候则能满足其实现的需求。</p>
<p>类似的，我们可以像下面这样定义一个接口和实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Alarm</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Alarmer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>alarm</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Alarmer</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后是实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>AlarmUser</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Alarm</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Tick</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AlarmUserImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Alarmer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Alarm triggered at </span><span style=color:#4e9a06>${</span><span style=color:#000>ticker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>alarm</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AlarmUserImpl</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>有意思的是我们在<code>AlarmUser</code>同时扩展了两个模块。这展示了模块可以怎样互相基于对方。最终，我们可以像下面这样使用这些模块：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>ModuleDemo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Alarmer</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>TickUser</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Running the ticker. Should trigger the alarm every 10 times.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
      <span style=color:#000>ticker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tick</span><span style=color:#ce5c00;font-weight:700>()</span>
      <span style=color:#000>alarm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>trigger</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>为了让<code>ModuleDemo</code>能够使用<code>AlarmUser</code>模块，编译器会要求混入<code>TickUser</code>或任何混入了<code>Tick</code>的任何模块。这提供了一种可能性来插拔一个不同的功能。</p>
<p>下面是程序的输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Running</span> <span style=color:#000>the</span> <span style=color:#000>ticker</span><span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#000>Should</span> <span style=color:#000>trigger</span> <span style=color:#000>the</span> <span style=color:#000>alarm</span> <span style=color:#000>every</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000>times</span><span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>30</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>60</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>70</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>80</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>90</span><span style=color:#ce5c00;font-weight:700>!</span>
<span style=color:#000>Alarm</span> <span style=color:#000>triggered</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>100</span><span style=color:#ce5c00;font-weight:700>!</span>
</code></pre></div><blockquote>
<p>Scala 中的模块可以像其他对象一样传递。他们是可扩展的、可互换的，并且实现是被隐藏的。</p>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f55e2bf3655f2a5ab93d8fc9f3412bfb>2.4 - CH04-抽象与自类型</h1>
<p>为了能够拥有易于扩展和维护的应用，在软件工程中设计和编写高质量的代码是非常重要的。这些活动要求开发者能够熟悉并正确理解领域，同时应用的需求也能被清晰的定义。如果缺少了任何一项，那么想要编写好的程序则会称为一个挑战。</p>
<p>很多时候，工程师使用一些抽象来建模“世界”。这有助于代码的可扩展性和可维护性，并能避免重复，这在在很多情况下可能会成为错误的原因。好的代码通常有多个小的组件构成，它们会互相依赖或集成。有多种不同的方式来实现抽象和集成。我们将会在本章中关注以下概念：</p>
<ul>
<li>抽象类型</li>
<li>多态</li>
<li>自类型</li>
</ul>
<p>这里所涉及的几个主题将非常有助于我们研究具体的设计模式。理解它们也能有助于理解那些基于它们的设计模式。此外，使用本章所涉及的这些概念本身就能有助于编写良好的代码。</p>
<h2 id=泛型与抽象类型>泛型与抽象类型</h2>
<p>参数化一个类的常用方式之一是使用值。这十分简单，可以通过向类的构造器参数传入不同的值来实现。在下面的例子中，我们可以向<code>Person</code>类的<code>name</code>参数传入不同的值来创建不同的实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>以这种方式我们能够创建不同的实例并将他们加以区分。但这样既不有趣也不是“火箭科学”。更进一步，我们会关注一些更加有趣的参数化来帮助我们编写更好的代码。</p>
<h3 id=泛型>泛型</h3>
<p>泛型是另一种参数化类的方式。当我们编写一个要操作多种不同类型的功能时，泛型会很有用，同时我们能够简单的推迟到最后再选择具体类型。一个例子是开发者所熟知的集合类。比如<code>List</code>，可以保存任何类型的数据，我们可以拥有整形、双精度浮点型、字符串、自定义类等等类型的列表。即便如此，列表的实现仍然总会是一样的。</p>
<p>我们同样可以参数化方法。比如，如果我们想要实现加法，对于不同的数字类型不会有什么不同之处。因此，我们可以使用泛型并仅实现方法一次，而不需要重载来适应世界上的每个类型。</p>
<p>让我们看一些例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Adder</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>numeric</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Numeric</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#000>numeric</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面这段代码可能有点难懂，它定义了一个可以用于<em>numeric</em>类型的<code>sum</code>方法。这实质上是一个专用(ad-hoc)泛型的表示，我们将会在本章的后续部分讨论。</p>
<p>下面的代码展示了如何泛型一个能够包含任何数据的类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Container</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下面的片段展示了例子的用法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>GenericsExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Adder</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;1 + 3 = </span><span style=color:#4e9a06>${</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;1.2 + 6.7 = </span><span style=color:#4e9a06>${</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1.2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>6.7</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#8f5902;font-style:italic>// compilation fails
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// System.out.println(s&#34;abc + cde = ${sum(&#34;abc&#34;, &#34;cde&#34;)}&#34;) 
</span><span style=color:#8f5902;font-style:italic></span>  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>intContainer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Container</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Comparing with int: </span><span style=color:#4e9a06>${</span><span style=color:#000>intContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stringContainer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Container</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;some text&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Comparing with string: </span><span style=color:#4e9a06>${</span><span style=color:#000>stringContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;some text&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行程序将会得到如下输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span>
<span style=color:#0000cf;font-weight:700>1.2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>6.7</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7.9</span>
<span style=color:#000>Comparing</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>int</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span>
<span style=color:#000>Comparing</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>string</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span>
</code></pre></div><h3 id=抽象类型>抽象类型</h3>
<p>另一种参数化类的方式是使用抽象类型。泛型在其他语言中都有对应的实现，比如 Java。但是 Java 中却不存在抽象类型。让我们看一下上面<code>Container</code>的例子如何转换为以抽象类型的方式实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ContainerAT</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>T</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>conpare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后在类中使用这个特质：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringContainer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ContainerAT</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后就可以使用与前面相同的方式来使用这个类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AbstractTypesExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stringContainer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringContainer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;some text&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Comparing with string: </span><span style=color:#4e9a06>${</span><span style=color:#000>stringContainer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;some text&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同样可以得到与预期一样的输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>comparing</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>string</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span>
</code></pre></div><p>当然我们也可以以类似的方式应用于泛型的例子，只需要创建一个特质的实例然后指定类型参数。这意味着泛型和抽象类型为我们提供了两种方式来实现相同的一件事。</p>
<h3 id=泛型与抽象类型-1>泛型与抽象类型</h3>
<p>那为什么 Scala 中同时拥有泛型和抽象类型呢？它们有什么不同吗？或者如何选择使用哪一个呢？我们会在这里给你答案。</p>
<p>泛型和抽象类型是可以互换的。虽然可能需要额外的工作，但是我们能够使用泛型来提供抽象类型所带来的一切。如何选择取决于不同的因素，有的是个人偏好，比如有人是为了可读性，而有人则是为了类的不同用法。</p>
<p>让我们看一个例子来尝试理解泛型与抽象类型可以在合适以及如何使用。在这个例子中我们会使用打印机。大家都知道它们有多种类型——纸质打印机、3D 打印机等等。每种都是用不同的材料来打印，比如墨粉、墨水或塑料，同时它们也会于打印到不同的媒介上——纸或甚至是空气中。我们可以使用抽象类型来描述这些：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PrintData</span>
<span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PrintMaterial</span>
<span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PrintMedia</span>
<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Printer</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Data</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintData</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Material</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintMaterial</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Media</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintMedia</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>material</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Material</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>media</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Media</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#4e9a06>s&#34;Printing </span><span style=color:#4e9a06>$data</span><span style=color:#4e9a06> with </span><span style=color:#4e9a06>$material</span><span style=color:#4e9a06> material on </span><span style=color:#4e9a06>$media</span><span style=color:#4e9a06> media.&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>为了能够调用这个<code>print</code>方法，我们需要拥有不同的媒介、数据类型及原料：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Paper</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PrintMedia</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Air</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PrintMedia</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Text</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PrintData</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Model</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PrintData</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Toner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PrintMaterial</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Plastic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PrintMaterial</span>
</code></pre></div><p>现在让我们创建两个具体的打印机实现，一个激光打印机，一个 3D 打印机：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LaserPrinter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Printer</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Media</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Paper</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Text</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Material</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Toner</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreeDPrinter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Printer</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Media</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Air</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Model</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Material</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Plastic</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在上面的代码中，我们实际上已经给出了数据类型、媒介，以及打印机可以使用的材料的说明。我们不能要求 3D 打印机使用墨粉来打印，或者激光打印机直接打印在空气中。下面是如何使用这两个打印机：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PrinterExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>laser</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LaserPrinter</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>threeD</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreeDPrinter</span>
  
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>laser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Text</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Toner</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Paper</span><span style=color:#ce5c00;font-weight:700>()))</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threeD</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Plastic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Air</span><span style=color:#ce5c00;font-weight:700>()))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码拥有很好的可读性，它支持我们轻松的指定具体类。使事物更易于建模。有意思的是将其转换为泛型的方式实现则会是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>GenericPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Data</span> <span style=color:#204a87;font-weight:700>&lt;:</span><span style=color:#204a87;font-weight:700>PrintData</span>, <span style=color:#204a87;font-weight:700>Material</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintMaterial</span>, <span style=color:#204a87;font-weight:700>Media</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintMedia</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>material</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Material</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>media</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Media</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#4e9a06>s&#34;Printing </span><span style=color:#4e9a06>$data</span><span style=color:#4e9a06> with </span><span style=color:#4e9a06>$material</span><span style=color:#4e9a06> material on </span><span style=color:#4e9a06>$media</span><span style=color:#4e9a06> media.&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个特质很容易被描述，可读性和逻辑性在这里也没有得到损害。然而，我们必须以如下方式来表示具体类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>GenericLaserPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Data</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Text</span>, <span style=color:#204a87;font-weight:700>Material</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Toner</span>, <span style=color:#204a87;font-weight:700>Media</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Paper</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>GenericPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Data</span>, <span style=color:#204a87;font-weight:700>Material</span>, <span style=color:#204a87;font-weight:700>Media</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>GenericThreeDPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Data</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Model</span>, <span style=color:#204a87;font-weight:700>Material</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Plastic</span>, <span style=color:#204a87;font-weight:700>Media</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Air</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>GenericPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Data</span>, <span style=color:#204a87;font-weight:700>Material</span>, <span style=color:#204a87;font-weight:700>Media</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>这会让具体类的定义变得相当长，开发者也更可能犯错。下面的片段展示了如何使用这些类来创建实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>genericLaser</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericLaserPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Text</span>, <span style=color:#204a87;font-weight:700>Toner</span>, <span style=color:#204a87;font-weight:700>Paper</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>genericThreeD</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericThreeDPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Model</span>, <span style=color:#204a87;font-weight:700>Plastic</span>, <span style=color:#204a87;font-weight:700>Air</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>genericLaser</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Text</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Toner</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Paper</span><span style=color:#ce5c00;font-weight:700>()))</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>genericThreeD</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Plastic</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Air</span><span style=color:#ce5c00;font-weight:700>()))</span>
</code></pre></div><p>你会发现每次在创建这些实例的时候都需要指定类型。假如我们拥有更多的泛型类型，或者一些类型本身又是基于泛型，比如集合。这很快会变得冗长，而且让人难以理解这些代码的实际用途。</p>
<p>另一方面，使用泛型能够允许我们复用<code>GenericPrinter</code>而不必为不同的打印机表示进行显式的子类化。然而这也存在逻辑错误的风险：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>GenericPrinterImpl</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Data</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintData</span>, <span style=color:#204a87;font-weight:700>Material</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintMaterial</span>, <span style=color:#204a87;font-weight:700>Media</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>PrintMedia</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>GenericPrinter</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Data</span>, <span style=color:#204a87;font-weight:700>Material</span>, <span style=color:#204a87;font-weight:700>Media</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>如果像相面这样使用则会有犯错的危险：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>wrongPrinter</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GenericPrinterImpl</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Model</span>, <span style=color:#204a87;font-weight:700>Toner</span>, <span style=color:#204a87;font-weight:700>Air</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrongPrinter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Toner</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Air</span><span style=color:#ce5c00;font-weight:700>()))</span>
</code></pre></div><h3 id=应用建议>应用建议</h3>
<p>上面的例子展示了使用泛型和抽象类型的简单比较。两种都是有用的概念；然而，清晰的知道他们具体的用法对于在需要的场景选择正确的一个是很重要的。下面的一些技巧能够帮助你做出正确的选择：</p>
<ul>
<li>泛型：
<ul>
<li>如果你仅需要类型实例化。一个好的示范是标准的集合类。</li>
<li>如果你正在创建一族类型。</li>
</ul>
</li>
<li>抽象类：
<ul>
<li>如果你想允许别人能够通过特质混入类型。</li>
<li>如果你需要在一些允许互换的场景拥有更好的可读性。</li>
<li>如果你想在客户端代码中隐藏类型定义。</li>
</ul>
</li>
</ul>
<h2 id=多态的三种形式>多态的三种形式</h2>
<p>多态是任何使用面向对象编程语言的开发者都知道的东西。</p>
<blockquote>
<p>多态帮助我们编写通用的代码以进行复用并应用到多样性的类型中。</p>
</blockquote>
<p>知道有多种不同类型的多态是很重要的，这节中我们将会讨论它们。</p>
<h3 id=子类型多态>子类型多态</h3>
<p>这是一种每个开发者都知道的多态，它与在具体类中覆写方法相关。考虑下面简单的层级：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Item</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pack</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Fruit</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Item</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pack</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;I&#39;m a fruit and I&#39;m packed in a bag.&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Drink</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Item</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pack</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;I&#39;m a drink and I&#39;m packed in a bottle.&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在我们拥有一个装满物品的购物篮，对每一个都进行<code>pack</code>调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>SubtypePolymorphismExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>shoppingBasket</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Item</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Fruit</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Drink</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>shoppingBasket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pack</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>你会发现，这里我们可以使用一个抽象类型并且无需思考它们具体的类型直接调用<code>pack</code>方法即可。多态会注意打印正确的值。我们的输出会像下面这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>I&#39;m a fruit and I&#39;m packed in a bag. 
I&#39;m a drink and I&#39;m packed in a bottle.
</code></pre></div><blockquote>
<p>子类化多提通过<code>extends</code>关键字使用继承来表示。</p>
</blockquote>
<h3 id=参数式多态>参数式多态</h3>
<p>函数式编程中的参数化多态即为我们上节中展示的泛型。泛型既是参数化多态，我们已经见过，它支持我们定义基于任何类型或给定类型的子集类型的方法和数据结构。而具体的类型则可以在后续的阶段指定。</p>
<blockquote>
<p>参数式多态使用类型参数表示。</p>
</blockquote>
<h3 id=专用ad-hoc多态>专用(ad-hoc)多态</h3>
<p>专用多态类似于参数式多态；然而在这种情况下，参数的类型是很重要的，因为具体实现会依赖于这些参数。它会在编译时被分析，不像子类型多态是在运行时。这多少类似于函数重载。</p>
<p>我们在本章的前面部分看到过它的一个例子，我们创建了一个<code>Adder</code>特质可以对不同的类型求和。让我们一步一步定义一个更加精密的例子，期望这样有助于连接它是如何工作的。我们的目标是让<code>sum</code>方法可以对任何类别的类型(之前是数字类型)求和：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>下一步，我们创建一个使用<code>sum</code>方法的对象并向外界暴露：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Adder</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T:</span> <span style=color:#204a87;font-weight:700>Adder</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#000>implicitly</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]].</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们看到的上面这段代码是 Scala 中的一些语法糖，<code>implicitly</code>表示拥有一个隐式转换可以将<code>T</code>转换为<code>Adder[T]</code>。现在我们可以编写如下程序：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AdhocPolymorphismExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Adder._</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The sum of 1 + 2 is </span><span style=color:#4e9a06>${</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The sum of abc + def is </span><span style=color:#4e9a06>${</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;def&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果我们尝试编译运行这个程序，将会得到如下错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Error:(15, 51) could not find implicit value for evidence parameter 
of type com.ivan.nikolov.polymorphism.Adder[Int]
	System.out.println(s&#34;The sum of 1 + 2 is ${sum(1, 2)}&#34;)
												  ^
Error:(16, 55) could not find implicit value for evidence parameter 
of type com.ivan.nikolov.polymorphism.Adder[String]
	System.out.println(s&#34;The sum of abc + def is ${sum(&#34;abc&#34;, &#34;def&#34;)}&#34;)
													  ^
</code></pre></div><p>这表示我们的代码不知道如何将整数或字符串隐式转换为<code>Adder[Int]</code>或<code>Adder[String]</code>。我们需要做的是定义这些转换以告诉程序<code>sum</code>方法该如何做。我们的<code>Adder</code>对象看起来会是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Adder</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T:</span> <span style=color:#204a87;font-weight:700>Adder</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>implicitly</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]].</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>int2Adder</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>string2Adder</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$a</span><span style=color:#4e9a06> concatenated with </span><span style=color:#4e9a06>$b</span><span style=color:#4e9a06>&#34;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在如果允许上面的程序则会得到如下输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>The sum of 1 + 2 is 3
The sum of abc + def is abc concatenated with def
</code></pre></div><p>同样，如果你记得本章开头的例子，我们是不能对字符串求和的。现在你会发现，我们可以提供不同的实现，因为我们定义了一个转换为<code>Adder</code>方式，因此使用任何类型都是没有问题的。</p>
<p>专用泛型支持我们在不修改基类的基础上扩展代码。这在使用外部库时将会很有帮助，比如因为某些原因我们无法修改原始代码。它很强大而且在编译时求解，这可以确保我们的程序会和预期的一样运行。另外，它可以支持我们为无法访问的类型(比如这里的 Int、String)提供功能。</p>
<h4 id=为多个类型提供功能>为多个类型提供功能</h4>
<p>如果我们回头看本章的开头，我们为数字类型定义了一个<code>Adder</code>，会发现后面最终的实现会要求我们为不同的数字类型单独定义不同的操作，比如 Long、Double等等。有没有方式来实现本章开头的哪种效果呢？当然有，就像下面这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>numeric2Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T:</span> <span style=color:#204a87;font-weight:700>Numeric</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Adder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>implicitly</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Numeric</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]].</span><span style=color:#000>plus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们仅仅定义了另一个隐式转换(将<code>Numeric[T]</code>转换为<code>Adder[T]</code>)，它会为我们处理好一切。现在可以像下面这样使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The sum of 1.2 + 6.5 is </span><span style=color:#4e9a06>${</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1.2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>6.5</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><blockquote>
<p>专用多态通过<strong>隐式混入行为</strong>来表示。这是<strong>类型类设计模式</strong>的主要构建方式，后续章节中将会详细解释。</p>
<p>例子中，首先定义一个泛型接口，然后通过传入具体类型参数来创建不同类型的具体子类实例，从而调用支持不同类型的实例方法。只是这个过程是通过隐式转换完成的。</p>
</blockquote>
<h2 id=自类型>自类型</h2>
<p>好代码的其中一个特性是关注点分离。开发者需要致力于使类与其方法的职责仅有一个。这有助于测试和维护，而且更有助于简化代码的理解。记得，<em>简单的总是最好的</em>。</p>
<p>然而，在编写实际软件时总是无法避免，为了实现某些功能我们需要在一个类的实例中持有别的类的实例。换句话说，一旦我们的对构件块进行了清晰的分离，为了实现功能它们之间则会存在依赖。我们这里所讨论的总结起来实际上就是依赖注入。自类型提供了一种方法来以更加优雅的方式来处理这些依赖。本节中，我们将讨论它们的用法及优点。</p>
<h3 id=使用自类型>使用自类型</h3>
<p>自类型支持我们在应用中更简便的拆分代码，然后再在其他地方指定那些需要的部分。例子会让一切变得清晰，因此让我们看一个实例。假如我们想要往数据库持久化信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>persist</code>方法会对数据做一些转换并存储到我们的数据库。当然，我们的代码写的很好，因此数据库实现是互相分离的。我们拥有以下几种数据库：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Database</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>MemoryDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Database</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>db</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>mutable.MutableList</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MutableList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Saving to in memory database.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>db</span><span style=color:#ce5c00;font-weight:700>.+=:(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>FileDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Database</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Saving to file.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们拥有一个特质及一些具体的数据库实现。那么如何把数据库传递给<code>Persister</code>呢？它应该能够调用数据库中的<code>save</code>方法。可能会有以下几种方式：</p>
<ul>
<li>在<code>Persister</code>中扩展<code>Database</code>。这样虽然可行，但是会让<code>Persister</code>也变成了<code>Database</code>的实例，我们并不希望这样。后面会解释原因。</li>
<li>在<code>Persister</code>中拥有一个<code>Database</code>变量，然后使用它。</li>
<li>使用自类型。</li>
</ul>
<p>为了能够观察自类型是如何工作的，因此使用自类型的方式。我们的<code>Persister</code>接口将会变成下面这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#204a87;font-weight:700>Database</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Calling persist.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
    <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在我们访问了数据库中的方法并在<code>Persister</code>之内调用了<code>save</code>方法。</p>
<blockquote>
<p><strong>为自类型命名</strong></p>
<p>在上面的代码中，我们使用<code>this: Database[T] =></code>语句将自类型包括进来。这样支持我们像使用自身的方法一样直接使用被引入类型的方法。另一种替代的方式是使用<code>self: Database[T] =></code>。有很多例子中使用了后面的方式，这样可以避免当我们需要在嵌套的特质或类定义中使用<code>this</code>而引起的混乱。然而这种方式需要在调用被注入的方法时使用<code>self</code>来引用。</p>
</blockquote>
<p>自类型会要求任何混入<code>Persister</code>类同时混入<code>Database</code>，否则编译将会失败。让我们创建一些持久化到内存和数据库的类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilePersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>FileDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemoryPersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>MemoryDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>最终，我们可以在应用中使用它们：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PersisterExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fileStringPersister</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilePersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>memoryIntPersister</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MemoryPersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span>
  
  <span style=color:#000>fileStringPersister</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;something&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>fileStringPersister</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;something else&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#000>memoryIntPersister</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>memoryIntPersister</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>123</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>自类型与继承所做的事是不同的，它需要一些代码的存在，因此也能支持我们对功能进行很好的拆分。这可以很大的改变的对程序的维护、重构和理解。</p>
<h4 id=使用多个组件>使用多个组件</h4>
<p>在真实的应用中，可能需要使用自类型来对多个组件做出要求。让我们在例子中展示一个<code>Histoty</code>特质，它能够追踪改变并回滚到某个点。不过这里仅做一些打印：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>History</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Action added to history.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们需要在<code>Persister</code>中使用它，看起来像是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#204a87;font-weight:700>Database</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Calling persist.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以通过<code>with</code>关键字同时添加多个需求。然而，如果我们仅让代码做出这些改变，它并不会编译成功。原因是现在我们必须同时混入<code>History</code>到<code>Persister</code>中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilePersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>FileDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemoryPersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>MemoryDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span>
</code></pre></div><p>然后再次运行代码，将会得到如下输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Calling persist.
Saving to file.
Action added to history. Calling persist.
Saving to file.
Action added to history. Calling persist.
Saving to in memory database. Action added to history. Calling persist.
Saving to in memory database. Action added to history.
</code></pre></div><h4 id=组件冲突>组件冲突</h4>
<p>在上面的例子中，我们拥有一个对<code>History</code>特质的需要，它拥有一个<code>add</code>方法。如果不同组件中的方法拥有相同的签名会怎样呢？让我们试一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Mystery</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Mystery added!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后使用到<code>Persister</code>中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>this:</span><span style=color:#204a87;font-weight:700>Database</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Mystery</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>persist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Calling persist.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilePersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>FileDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Mystery</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemoryPersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>MemoryDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Mystery</span>
</code></pre></div><p>如果我们允许这个应用，将会得到如下错误信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Error:(47, 7) class FilePersister inherits conflicting members:
	method add in trait History of type ()Unit and
	method add in trait Mystery of type ()Unit
(Note: this can be resolved by declaring an override in class FilePersister.)
class FilePersister[T] extends Persister[T] with FileDatabase[T] with History with Mystery
^
Error:(48, 7) class MemoryPersister inherits conflicting members:
	method add in trait History of type ()Unit and
	method add in trait Mystery of type ()Unit
(Note: this can be resolved by declaring an override in class MemoryPersister.)class MemoryPersister[T] extends Persister[T] with MemoryDatabase[T] with History with Mystery
							   ^
</code></pre></div><p>幸运的是这个错误消息已经包含了一些如何修复问题的信息。这跟我们一开始使用特质时遇到的完全是相同的问题，我们可以使用如下的方式修复：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilePersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>FileDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Mystery</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>History</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemoryPersister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Persister</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>MemoryDatabase</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>History</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Mystery</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Mystery</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后再次运行例子，将会得到预期的输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Calling persist.
Saving to file.
Action added to history. Calling persist.
Saving to file.
Action added to history. Calling persist.
Saving to in memory database. Mystery added!
Calling persist.
Saving to in memory database. Mystery added!
</code></pre></div><h4 id=自类型与蛋糕模式>自类型与蛋糕模式</h4>
<p>上面我们看到的例子都是单纯的依赖注入的例子。我们通过自类型要要求一个组件必须引入一些指定的组件。</p>
<blockquote>
<p>自类型常用于依赖注入。他们是<em>蛋糕设计模式</em>的主要部分，本书后续部分我们将详细介绍。</p>
</blockquote>
<p>蛋糕模式的实现完全依赖于自类型。它鼓励工程师编写小而简单的组件，然后声明并使用它们的依赖。当应用中所有的组件都编写完成后，可以在一个通用的组件中实例化它们以应用于实际的应用。蛋糕模式的一个好的优势是实际上会在编译时来检查所有的依赖是否都满足了。</p>
<p>在本书的后续部分，我们将使用一整个小节来讨论蛋糕模式，那里我们将讨论更多关于该模式是如何被连接在一起的细节，它的优势及缺陷，等等。</p>
<h3 id=自类型与继承对比>自类型与继承对比</h3>
<p>在上一节中，我们讲到不希望使用继承的方式来访问<code>Database</code>的方法。这又是为何呢？如果我们让<code>Persister</code>扩展<code>Database</code>，这意味着<code>Persister</code>本省也变成了一个<code>Database</code>(is-a 关系)。然而这是不正确的。这里它只是<em>使用</em>一个数据库来实现其功能，而不能称为一个数据库。</p>
<p>继承将子类暴露给父级的实现细节。然而并非总是期望得到这样的结果。根据<em>Design Patterns: Elements of Reusable Object-Oriented Software</em>一书的作者所提倡的，开发者总是应该优先使用组合，而不是继承。</p>
<h4 id=继承泄露了功能>继承泄露了功能</h4>
<p>如果我们使用了继承，同样会将我们不希望的功能泄露给子类。让我们看一下下面的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>DB</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Connected.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>dropDatabase</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Dropping!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Closed.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>UserDB</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DB</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>createUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Creating a user: </span><span style=color:#4e9a06>$username</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Getting a user: </span><span style=color:#4e9a06>$username</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>UserService</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>UserDB</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>bad</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dropDatabase</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这会是一个真实的情况。因为这就是继承的工作方式，我们可以在<code>UserService</code>中访问<code>dropDatabase</code>。这是一些我们不希望发生的事情，而且可以通过自类型来修复。特质<code>DB</code>不需要变动，仅需要修改以下内容：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>trair</span> <span style=color:#000>UserDB</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>this:</span><span style=color:#204a87;font-weight:700>DB</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>createUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Creating a user: </span><span style=color:#4e9a06>$username</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Getting a user: </span><span style=color:#4e9a06>$username</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>UserService</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#204a87;font-weight:700>UserDB</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
  <span style=color:#8f5902;font-style:italic>//...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样，在<code>UserService</code>中就无法再访问到<code>dropDatabase</code>了。我们只能调用我们需要的方法，这也就是我们要真正实现的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-76b78cfc1fc291e4e7f1767a8c507fef>2.5 - CH05-AOP 与组件</h1>
<h1 id=aop-与组件>AOP 与组件</h1>
<p>有些时候在编程中，我们会发现一些代码片段重复出现在不同的方法中。有些情况下，我们会重构我们的代码将它们移到单独的模块中。有时这又是行不通的。有一些经典的日志和验证的例子。面向切面编程在这种情况下会很有帮助，我们将在本章的末尾来理解它。</p>
<p>组件是可复用的代码片段，它会提供多种服务并具有一定的要求。它们对避免代码重复极其有用，当然也能促进代码的复用。这里我们将会看到如何构建组件，以及 Scala 是如何让组件的编写和使用相比其他语言更加简单。</p>
<p>在熟悉面向切面编程和组件的过程中，我们将会贯穿以下主题：</p>
<ul>
<li>面向切面编程</li>
<li>Scala 中的组件</li>
</ul>
<h2 id=面向切面编程>面向切面编程</h2>
<p>面向切面编程，即 AOP(Aspect-oriented programming)，解决了一个通用的功能，贯穿于整个应用，但是又无法使用传统的面向对象技术抽象成一个单独的模块。这种重复的功能通常被引用为“横切关注点(cross-cutting concerns)”。一个通用的例子是日志——通常日志记录器会在一个类中创建，然后在类的方法中调用这个记录器的方法。这有助于调试和追踪应用中的事件，但由于应用实际的功能没什么相关性。</p>
<p>AOP 推荐将横切关注点抽象并封装在它们自己的模块中。在下面的几个章节中我们将会深入了解 AOP 如何来改善代码并能够使横切关注点更易扩展。</p>
<h2 id=实例>实例</h2>
<p>效率是每个程序中很重要的部分。很多情况下，我们可以对方法计时以查找应用中的瓶颈。让我们看一个示例程序。</p>
<p>我们将会看一下解析。在很多真实的应用中，我们需要以特定的格式读取数据并将其解析为我们代码中的对象。比如，我们拥有一个记录人员的小数据库并以 JSON 格式表示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>[</span>
  <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;firstName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Ivan&#34;</span><span style=color:#000;font-weight:700>,</span> 
    <span style=color:#204a87;font-weight:700>&#34;lastName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Nikolov&#34;</span><span style=color:#000;font-weight:700>,</span> 
    <span style=color:#204a87;font-weight:700>&#34;age&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>26</span> 
  <span style=color:#000;font-weight:700>},</span> 
  <span style=color:#000;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>&#34;firstName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;John&#34;</span><span style=color:#000;font-weight:700>,</span> 
    <span style=color:#204a87;font-weight:700>&#34;lastName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Smith&#34;</span><span style=color:#000;font-weight:700>,</span> 
    <span style=color:#204a87;font-weight:700>&#34;age&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>55</span> <span style=color:#000;font-weight:700>},</span> 
  <span style=color:#000;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>&#34;firstName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Maria&#34;</span><span style=color:#000;font-weight:700>,</span> 
    <span style=color:#204a87;font-weight:700>&#34;lastName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Cooper&#34;</span><span style=color:#000;font-weight:700>,</span> 
    <span style=color:#204a87;font-weight:700>&#34;age&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>19</span> 
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>]</span>
</code></pre></div><p>为了在 Scala 中表示这段 Json，我们需要定义模型。这会很简单而且只有一个类：Person。下面是代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>由于我们要读取 Json 输入，因此要对其进行解析。有很多解析器，每种或许会有各自不同的特性。在当前这个例子中我们将会使用 Json4s。这需要在<code>pom.xml</code>中配置额外的依赖：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span> 
  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.json4s<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span> 
  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>json4s-jackson_2.11<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span> 
  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>3.2.11<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span> 
<span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</code></pre></div><p>上面这个依赖可以轻易转换为 SBT，如果读者更愿意使用 SBT 作为构建系统的话。</p>
<p>我们要编写一个拥有两个方法的类，用于解析前面所指定的格式的输入文件并返回一个<code>Person</code>对象列表。这两个方法实际上在做同一件事，但是其中一个会比另一个效率更高：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>DataReader</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readData</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readDataInefficiently</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DataReaderImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DataReader</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>formats</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>DefaultFormats</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readUnitimed</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamInput</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/users/json&#34;</span><span style=color:#ce5c00;font-weight:700>))).</span>
      <span style=color:#000>extract</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]]</span>

  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readData</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>readUntimed</span><span style=color:#ce5c00;font-weight:700>()</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readDataInefficiently</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>num</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>readUntimed</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>readUntimed</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>特质<code>DataReader</code>扮演一个借口，对实现的使用也十分直接：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>DataReaderExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>dataReader</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataReadImpl</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;I just read the following data efficiently: </span><span style=color:#4e9a06>${</span><span style=color:#000>dataReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readData</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;I just read the following data inefficiently: </span><span style=color:#4e9a06>${</span><span style=color:#000>dataReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readDataInefficiently</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行这段代码将会得到和预期一样的结果。</p>
<p>上面的这个例子是很清晰的。然后，如果你想优化你的代码并查看运行缓慢的原因呢？上面的代码并没有提供这种能力，因此我们要做一些额外的工作来对应用计时并查看它是如何执行的。下一个小节我们将会同时展示不适用 AOP 和使用 AOP 的实现。</p>
<h3 id=不使用-aop>不使用 AOP</h3>
<p>有一种基本的方法来进行计时。我们可以把<code>println</code>语句包裹起来，或者让计时称为<code>DataReaderImpl</code>类方法的一部分。通常，将计时作为方法的一部分会是一个更好的选择，因为这个方法可能会在不同的地方被调用，同时它们的性能也取决于传入的参数和一些其他因素。基于我们所说，这也就是<code>DataReaderImpl</code>类将会如何被重构以支持计时的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DataReaderImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DataReader</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>formats</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>DefaultFormats</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readUnitimed</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamInput</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;users.json&#34;</span><span style=color:#ce5c00;font-weight:700>))).</span><span style=color:#000>extract</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]]</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readData</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>startMillis</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>readUnitimed</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>time</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startMillis</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;readData took </span><span style=color:#4e9a06>$time</span><span style=color:#4e9a06> milliseconds&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>result</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readDataInefficiently</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>startMillis</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>foreach</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>num</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>readUntimed</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>readUntimed</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>time</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startMillis</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;readDataInefficiently took </span><span style=color:#4e9a06>${</span><span style=color:#000>time</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> milliseconds.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>result</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因此你会发现，代码会变得不可读，计时功能干扰了实际的功能。运行这段代码将会发现其中一个方法花费的更多的时间来执行。</p>
<p>在下节中将会展示如何使用 AOP 来提升我们的代码。</p>
<h3 id=使用-aop>使用 AOP</h3>
<p>向前面看到的一样，向我们的方法中添加计时代码将会引入重复代码同时也使代码难以追踪，尽管是一个很小的例子。现在，假如我们同样需要打印一些日志或进行一些其他活动。AOP 将会帮助分离这些关注点。</p>
<p>我们可以把<code>DataReadImpl</code>重置到一开始的状态，这时它不再打印任何日志。现在创建另一个名为<code>LoggingDataReader</code>的特质，它扩展自<code>DataReader</code>并拥有以下内容：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>LoggingDataReader</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DataReader</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readData</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>startMillis</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readData</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>time</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startMillis</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pringln</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;readData took </span><span style=color:#4e9a06>$time</span><span style=color:#4e9a06> milliseconds.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>result</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readDataInefficiently</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>startMillis</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readDataInefficiently</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>time</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startMillis</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;readDataIneffieciently took </span><span style=color:#4e9a06>$time</span><span style=color:#4e9a06> milliseconds.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>result</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里有趣的地方在于<code>abstract override</code>修饰符。它提醒编译器我们会进行**叠加性(stackable)**的修改。如果我们不使用该修饰符，编译将会失败：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Error:(9, 24) method readData in trait DataReader is accessed from super. It may not be abstract unless it is overridden by a member declared `abstract&#39; and `override&#39;
	val result = super.readData()
					   ^

Error:(17, 24) method readDataInefficiently in trait DataReader is accessed from super. It may not be abstract unless it is overridden by a member declared `abstract&#39; and `override&#39;
val result = super.readDataInefficiently()
				   ^
</code></pre></div><p>现在让我们的新特质使用之前提到过的混入组合，在下面的程序中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>DataReaderAOPExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>dataReader</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataReaderImpl</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>LoggingDataReader</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;I just read the following data efficiently: </span><span style=color:#4e9a06>${</span><span style=color:#000>dataReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readData</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;I just read the following data inefficiently: </span><span style=color:#4e9a06>${</span><span style=color:#000>dataReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readDataInefficiently</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行这段代码将会得到带有计时信息的输出。</p>
<p>使用 AOP 的优势是很明显的——实现不会被其他代码污染。再者，我们可以以同样的方式添加更多修改——更多的日志、重试逻辑、回滚等等。所有这些都可以通过创建一个新特质并扩展<code>DataReader</code>接口，然后在创建具体实现的实例中混入即可。当然，我们可以同时应用多个修改，它们将会按顺序执行，而顺序将会遵循线性化原则。</p>
<h2 id=组件>组件</h2>
<p>组件作为应用的一部分意味着会与应用的其他部分进行结合。它们应该是可复用的，以便减少代码的重复。组件通常拥有接口，用于描述它们提供的服务或者它们依赖的一些服务或是其他组件。</p>
<p>在大型的应用中，我们通常会看到多个组件会被集成在一起工作。要描述一个组件提供的服务通常会很直接，这会使用接口的帮助来完成。与其他组件进行集成则可能需要开发者完成更多的工作。这通常会通过<strong>将需要的组件的接口作为参数来传递</strong>。然而，加入有一个大型的应用需要很多的组件；完成这些链接需要花费时间和精力。进一步，每次需要一个新的需求，我们也需要进行大量的重构。<strong>多重继承</strong>可以作为参数传递的替代方案；然而，首先需要语言支持这种方式。</p>
<p>像 Java 语言中用来链接组件的流行做法是使用<strong>依赖注入</strong>。Java 中拥有这样的库用于在运行时将组件注入。</p>
<h3 id=丰富的-scala>丰富的 Scala</h3>
<p>本书中我们已经提到多次，Scala 比简单的面向对象语言拥有更强的表现力。我们已经讨论了一些概念，比如：抽象类型、自类型、统一化、混入组合。这支持我们创建通用的代码，特定的类，并能以相同的方式来处理对象、类、变量或函数，并实现多重继承。使用不同的组合用法可以让我们编写期望的模块化代码。</p>
<h4 id=实现组件>实现组件</h4>
<p>作为一个例子，假如我们尝试构建一个做饭机器人。我们的机器人能够查找食谱并制作我们需要的菜肴。我们可以通过创建新的组件来给机器人添加新的功能。</p>
<p>我们期望代码是模块化的，因此有必要对功能进行拆分。下面的图示展示了机器人的雏形以及各组件间的关系：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214165538.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>首先让我们给不同的组件定义接口：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>RecipeFinder</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>findRecipe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dish</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Cooker</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>cook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>what</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Food</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个例子中需要一个简单的<code>Food</code>类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Food</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>一旦这些完成后，我们就可以开始创建组件了。首先是<code>TimeConponent</code>，而<code>Time</code>的实现是一个嵌套类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>TimeConponent</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>time</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Time</span>
  
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TimeImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>formatter</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>DateTimeFormatter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ofPattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;HH:mm:ss&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
      <span style=color:#4e9a06>s&#34;The time is: </span><span style=color:#4e9a06>${</span><span style=color:#000>LocalDateTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>formatter</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在以类似的方式实现<code>RecipeComponent</code>，下面是组件和实现的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>RecipeComponent</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>recipe</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>RecipeFinder</span>
  
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RecipeFinderImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RecipeFinder</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>findRecipe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dish</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dish</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;chips&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Fry the potatoes for 10 minutes.&#34;</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;fish&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Clean the fish and put in the oven for 30 minutes.&#34;</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;sandwich&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Put butter, ham and cheese on the bread, toast and add tomatoes.&#34;</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>dish</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> is unknown recipe.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终，我们需要实现<code>CookingComponent</code>。它实际上会使用<code>RecipeComponent</code>，下面是它的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>CookingComponent</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#204a87;font-weight:700>RecipeComponent</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cooker</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Cooker</span>
  
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CookerImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cooker</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>cook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>what</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Food</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>recipeText</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>recipe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>findRecipe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>what</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#000>Food</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;We just cooked </span><span style=color:#4e9a06>$what</span><span style=color:#4e9a06> using the following recipe: &#39;</span><span style=color:#4e9a06>$recipeText</span><span style=color:#4e9a06>&#39;.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在所有的组件都各自实现了，我们可以将它们组合来创建我们的机器人。首先创建一个机器人要使用的组件注册表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RobotRegisty</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TimeComponent</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ReipeComponent</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>CookingComponent</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>time</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeImpl</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>recipe</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>RecipeFinder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RecipeFinderImpl</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cooker</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Cooker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CookerImpl</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在创建机器人：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Robot</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RobotRegisty</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>cook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>what</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>cooker</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>what</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后使用我们的机器人：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>RobotExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>robot</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Robot</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>robot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#ce5c00;font-weight:700>())</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>robot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;chips&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>robot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cook</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sandwich&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的例子中，我们看到了 Scala 不使用外部库来实现依赖注入的方式。这种方式真的很有用，它会避免我们的构造器过大，也不需要扩展过多的类。更进一步，各个组件可以很好的分离，可测试，并能清晰定义各自的依赖。我们同样看到了可以使用一些依赖其他组件的组件来递归的添加需求。</p>
<blockquote>
<p>上面这个例子实际上展示了蛋糕模式。一个好的特性是，依赖的存在会在编译期间进行求值，而不像 Java 那些流行的库一样在运行时进行求值。</p>
<p>蛋糕模式同样也存在缺点，我们会在稍后关注所有特性——无论好坏。那里我们将会展示组件如何可以被测试。</p>
</blockquote>
<p>这个蛋糕模式例子实质上很简单。在真是的应用中，我们可能需要一些组件依赖于其他组件，而那些组件有拥有各自的依赖。在这些情况下，事情会变得很复杂。我们将会本书的后续部分更好更详细的展示这一点。</p>
<h2 id=总结>总结</h2>
<p>本章我们探讨了 Scala 中的 AOP，现在我们知道如何将那些本不需要出现在模块中的代码进行拆分。这将有效减少代码重复并使我们的程序拥有不同的专用模块。</p>
<p>我们同样展示了如何使用本书前面部分讨论的技术来创建可复用的组件。组件提供接口并拥有指定的需求，这可以很方便的使用 Scala 的丰富特性。这与设计模式很相关，应为它们拥有相同的目标——使代码更好，避免重复，易于测试。</p>
<p>本书的后续章节我们将会讨论一些具体的设计模式，及其有用特性和用法。我们将会以创建型模式开始，它们由四人帮(Gof)创建，当然，这里会以 Scala 的视角。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8eefa8c04facc238b6904fb8fe805849>2.6 - CH06-创建型模式</h1>
<h1 id=创建型模式>创建型模式</h1>
<p>从这章开始，我们将会深入到实际的实际模式当中。我们已经提到过了解并能正确使用现有的设计模式的重要性。</p>
<p>设计模式可以被认为是一些能够解决特定问题的最佳实践或甚至是模板。开发者需要处理的问题的数量是无穷尽的，有些情况下不同的设计模式不得不被组合使用。然而，基于编写一段代码来解决问题的程序的各个方面，我们可以将设计模式分为一下几个组要的组。</p>
<ul>
<li>创建型</li>
<li>结构型</li>
<li>行为型</li>
</ul>
<p>本章将会关注于创建型设计模式，当然，我们将会以 Scala 语言的视角。我们将会贯穿以下一个主要的主题：</p>
<ul>
<li>什么是创建型设计模式</li>
<li>工厂方法</li>
<li>抽象工厂</li>
<li>其他工厂设计模式</li>
<li>单例</li>
<li>构建器</li>
<li>原型</li>
</ul>
<p>在正式的定义这些创建型设计模式之后，我们将会更详细的单独研究其中的每一种。我们将会强调何时及如何使用它们，何时拒绝使用一些模式，当然，会展示一些相关的实例。</p>
<h2 id=什么是创建型设计模式>什么是创建型设计模式</h2>
<p>创建型设计模式，和它名字描述的一样，用于处理对象的创建。有些情况下，对象的创建在程序中可能会引起一些额外的复杂性，而创建型模式隐藏这些复杂性以使软件组件的使用更加简单。对象创建的复杂性可能由下面任何一种原因引起：</p>
<ul>
<li>初始化参数的数量</li>
<li>必要的验证</li>
<li>捕获必要参数的复杂性</li>
</ul>
<p>上面这个列表在有些情况下可能会变得更长，这些因素也不会单独出现，总是伴随而来。</p>
<p>我们将会在下个小节关注创建型设计模式的方方面面，希望你会对为何需要他们以及如何在实际生活中应用它们，有个好的理解。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0d4d31b471daba329c041c1a13ee6b99>2.7 - CH06-1-工厂方法</h1>
<p>工厂方法模式用于封装实际类的初始化。它简单的提供一个借口来创建对象，然后工厂的子类来决定创建哪个具体的类。当我们需要在应用的运行时创建不同类的实例，这种模式将会很有用。这种模式同样可以有效的用于当需要开发者传入额外的参数时。</p>
<p>例子可以让一切变得简单，后面的小节我们将会提供一个实例。</p>
<h2 id=类图>类图</h2>
<p>对于工厂方法，我们将会展示一个数据库相关的例子。为了使事情变得简单(因为实际的<code>java.sql.Connection</code>拥有很多方法)，我们将会定义自己的<code>SimpleConnection</code>，它会拥有 MySQL 和 PostgreSQL 的具体实现。</p>
<p>这个连接类的类图看起来会像下面这样：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214170134.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>现在，连接的创建将会基于我们选择使用的数据库。然而，因为它们提供的接口，用法将会完全一样。实际的创建过程可能需要执行一些额外的、我们想要对用户隐藏的参数计算，而如果我们对每个数据库使用不同的常数，这些计算也会是相关的。这也就是为什么我们要使用工厂方法模式。下面的图示展示了剩余部分的代码将会如何被组织：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214170157.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>上面的图示中，<code>MysqlClient</code>和<code>PgsqlClient</code>都是<code>DatabaseClient</code>的具体实现。工厂方法<code>connect</code>将会在不同的客户端中返回不同的实际连接。即便我们进行了覆写，代码中的签名仍然会显示返回一个<code>SimpleConnection</code>，但实际上会是具体类型。在这个类图中，为了清晰我们选择展示实际的返回类型。</p>
<h2 id=代码实例>代码实例</h2>
<p>基于上面类图中清晰的展示，基于我们要使用的数据库客户端，一个不同的连接将会被创建和使用。让我们看一下这个类图的代码表示。首先是<code>SimpleConnection</code>以及其具体实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>SimpleConnection</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimpleMysqlConnection</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SimpleConnection</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;SimpleMySQLConnection&#34;</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Executing the query &#39;</span><span style=color:#4e9a06>$query</span><span style=color:#4e9a06>&#39; the MySQL way.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimplePgSqlConnection</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SimpleConnection</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;SimpePgSqlConnection&#34;</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Executing the query &#39;</span><span style=color:#4e9a06>$query</span><span style=color:#4e9a06>&#39; the PgSQL way.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于这些实现的使用将会发生在工厂方法中，名为<code>connect</code>。下面的代码片段展示了我们可以如何利用连接，以及如何在特定的数据库客户端中实现。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// the factory
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DatabaseClient</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>connection</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#8f5902;font-style:italic>// the factory method
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MysqlClient</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DatabaseClient</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleMysqlConnection</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PgSqlClient</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DatabaseClient</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimplePgSqlConnection</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后可以直接使用这些客户端：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Example</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>clientMysql</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>DatabaseClient</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MysqlClient</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>clientPgsql</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>DatabaseClient</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PgSqlClient</span>
  
  <span style=color:#000>clientMySql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SELECT * FROM users&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>clientPgSql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SELECT * FROM employees&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们看到了工厂方法模式是如何工作的。如果我们需要添加另一个数据库客户端，则可以扩展<code>DatabaseClient</code>，并在实现<code>connect</code>方法时返回一个扩展自<code>SimpleConnection</code>的类。</p>
<blockquote>
<p>上面例子中选择使用特质来定义 SimpleConnection，并使用抽象类来实现 DatabaseClient，这只是随机的选择。当然，我们完全可以使用特质来替代抽象类(除非需要参数构造器的时候)。</p>
</blockquote>
<p>在有些场景中，由工厂方法创建的对象可能会在构造器中需要一些参数，而这些参数有可能基于持有工厂方法的对象的一些特定状态或功能。这也是该模式的实际闪光点。</p>
<h2 id=scala-中的替代选择>Scala 中的替代选择</h2>
<p>与软件工程中的任何事情一样，该模式同样可以由不同的方式来实现。不同的选择则要归结于需求的不同和应用、被创建对象的特定属性。一些可选的替代方法有：</p>
<ul>
<li>通过构造器向该类传入其需要的组件(对象组合)。这样一来可能意味着，每次请求，这些组件可能是特定的实例而非一个新的。</li>
<li>传入一个能够创建我们所需要的实例的函数。</li>
</ul>
<p>使用 Scala 的丰富特性，我们能够避免这种设计模式，我们能够更明智的知道，我们将要使用或暴露的这些对象是如何创建的，而无论工厂方法是如何被创建的。没有绝对对错的方式。然而，应该基于特定的需求来选择一种能够同时满足使用、维护更加简便的方式。</p>
<h2 id=优点>优点</h2>
<p>和其他工厂一样，对象的创建细节被隐藏了。这意味着，如果我们改变了一个特定对象的创建方式，我们仅需要修改创建它的工厂方法(基于设计，这可能会涉及很多创建器)。工厂方法支持我们使用一个类的抽象版本并把对象的创建指派给子类。</p>
<h2 id=缺点>缺点</h2>
<p>在上面的例子中，如果我们拥有多于一个的工厂方法则很快会遇到问题。这首先需要开发者实现更多的方法，但更重要的是，这将导致返回的对象互不兼容。让我们看一个小例子。首先我们会定义另一个特质<code>SimpleConnectionPrinter</code>，拥有一个在被调用时打印一些东西的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>SimpleConnectionPrinter</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printSimpleConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后我们想改变我们的<code>DatabaseClient</code>并换个不同的名字：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BadDatabaseClient</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>connection</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>connectionPrinter</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>getConnectionPrinter</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>connectionPrinter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printSimpleConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>SimpleConnection</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getConnectionPrinter</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>SimpleConnectionPrinter</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>与原有例子不同的地方在于我们多了一个工厂方法，并在执行查询的时候同时被调用。类似于<code>SimpleConnection</code>的实现，现在让我们为<code>SimpleConnectionPrinter</code>创建另外两个具体实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimpleMysqlConnectionPrinter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SimpleConnectionPrinter</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printSimpleConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;I require a MySQL connection. It is: &#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimplePgSqlConnectionPrinter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SimpleConnectionPrinter</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printSimpleConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SimpleConnection</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;I require a PgSQL connection. It is: &#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在我们可以应用工厂设计模式来创建 MySQL 和 PostgreSQL 客户端：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BadMysqlClient</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BadDatabaseClient</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleMysqlConnection</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getConnectionPrinter</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>SimpleConnectionPrinter</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleMySqlConnectionPrinter</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BadPgsqlClient</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BadDatabaseClient</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>SimpleConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimplePgSqlConnection</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getConnectionPrinter</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>SimpleConnectionPrinter</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpleMySqlConnectionPrinter</span>	<span style=color:#8f5902;font-style:italic>// note here
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面这个实现则有效完成了，现在我们可以使用它：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>object BadExample extends App{
  val clientMySql: BadDatabaseClient = new BadMySqlClient
  val clientPgSql: BadDatabaseClient = new BadPgSqlClient
  clientMySql.executeQuery(&#34;SELECT * FROM users&#34;)
  clientPgSql.executeQuery(&#34;SELECT * FROM employees&#34;)
}
</code></pre></div><p>但是运行会得到如下结果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>I require a MySQL connection. It is &#39;SimpleMysqlConnection&#39;
Execution the query &#39;SELECT * FROM users&#39; the MySQL way.
I require a Mysql connection. It is &#39;SimplePysqlConnection&#39;
Execution the query &#39;SELECT * FROM employees&#39; the PgSQL way.
</code></pre></div><p>上面的例子显然发生了一个逻辑错误，同时也没有给我们提供任何提醒(在具体的工厂方法中使用了错误的具体实现)。随着要实现的方法数量的增长，这将会成为一个问题，并且错误会更易于发生。比如，我们的代码没有抛出任何异常，但是这种陷阱会引起运行时错误，这让问题变得难于发现和调试。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ac19cd3f0dc7118f99838d6543265c58>2.8 - CH06-2-抽象工厂</h1>
<p>抽象工厂是工厂模式系列的另一种设计模式。其目的与所有工厂设计模式一样——封装对象的创建逻辑并对用户隐藏。不同在于它的实现方式。</p>
<p>抽象工厂设计模式基于<strong>对象组合</strong>，而非<strong>继承</strong>，像工厂方法模式的实现中则是基于继承。这里我们有一个单独的对象，它提供一个借口来创建我们需要的类的实例。</p>
<h2 id=类图>类图</h2>
<p>这里我们仍然使用前面的<code>SimpleConnection</code>例子。下面的类图展示了抽象工厂是如何被组织的：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214170258.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>从上图中我们可以发现，现在我们可以拥有一个带有层级结构的工厂，而非数据库客户端中的一个方法。我们将会在应用中使用<code>DatabaseConnectorFactory</code>，同时它也会基于实际的实例类型返回正确的对象。</p>
<h2 id=实例>实例</h2>
<p>让我们以代码的视角来观察我们的例子。下面的代码清单展示了工厂的层级结构：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>DatabaseConnectionFactory</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MysqlFactory</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DatabaseConnectionFactory</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimpeMysqlConnection</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PgsqlFactory</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DatabaseConnectionFactory</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>SimpleConnection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimplePgsqlConnection</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后我们可以将这些工厂传递给类并调用需要的方法来使用它们。这里有一个与之前展示的工厂方法类似的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DatabaseClient</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connectionFactory</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>DatabaseConnectionFactory</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>connectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后使用这个数据库客户端：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Example</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>clientMysql</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>DatabaseClient</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DatabaseClient</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MysqlFactory</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>clientPgsql</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>DatabaseClient</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DatabaseClient</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PgsqlFactory</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#000>clientMysql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SELECT * FROM users&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>clientPgsql</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>executeQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SELECT * FROM employees&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这就是抽象工厂的工作方式了。如果我们需要添加数据库客户端，只需要添加一个新的具体工厂来扩展<code>DatabaseConnectionFactory</code>。这给重构和扩展带来很大的遍历。</p>
<h2 id=scala-中的替代选择>Scala 中的替代选择</h2>
<p>这种设计模式同样可以以不同的方式实现。实际上，我们使用对象组合来将工厂传递给类也暗示着也可以使用别的方式：我们可以简单的传入一个函数，因为在 Scala 中它们也是统一化的一部分，它们会被与对象相同的方式处理。</p>
<h2 id=优点>优点</h2>
<p>像所有工程模式一样，对象的创建细节被隐藏了。当我们想要暴露一系列对象时(比如数据库连接器)，这种模式尤其有用。这时客户端会与具体类解耦。该模式通常会在一些 UI 工具集中最为示例展示，比如那些基于操作系统的不同而有所不同的元素。它也是测试友好的，因为我们可以给客户端提供一些模拟器而非实际的工厂。</p>
<p>尽管我们前面提过的不兼容问题在这里仍然存在，不过现在会很难遇到。主要是因为这里客户端实际上仅仅会传递一个单独的工厂作为参数。这种情况下我们为用户提供了一个具体的工厂，而编写这些工厂的时候一切都被静心安排过了。</p>
<h2 id=缺点>缺点</h2>
<p>如果我们使用的对象(这里是 SimpleConnection)和方法改变了签名，将会引起问题的出现。有些情况下，该模式可能会为我们的代码带来一些没有必要的复杂性，以及难以阅读和维护。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c5235bad7f7368119f7e5795ce0d98c6>2.9 - CH06-3-其他工厂模式</h1>
<p>还有一些工厂设计模式的变种。而在所有的场景中，它们的目的都是相同的——隐藏创建过程的复杂性。在下个小节中，我们将简短的提到另外两种工厂模式：静态工厂、简单工厂。</p>
<h2 id=静态工厂>静态工厂</h2>
<p>静态工厂可以被表示为一个静态方法，并作为基类的一部分。调用它来创建那些具体类的实例。这里最大的缺点之一是，如果给基类添加了另外一个扩展，基类也需要给修改，即修改这个静态方法。让我们展示一个动物世界中的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Animal</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Bird</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Mammal</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ainmal</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Fish</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>animal</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Animal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>animal</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;bird&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Bird</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;mammal&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Mammal</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;fish&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Fish</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Unknown animal: </span><span style=color:#4e9a06>$x</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样每次添加一种新的具体动物，我们不得不修改这个<code>apply</code>方法来包括它，特别是当我们要考虑新的类型时。</p>
<h2 id=简单工厂>简单工厂</h2>
<p>简单工厂比静态工厂要好一点，因为实际的工厂功能是在另一个类中。这使得每次扩展基类不必再去修改基类。类似于抽象工厂，但不同在于这里我们没有一个抽象工厂类，会直接使用具体工厂。通常从一个简单的工厂开始，随着时间的推移和项目的进化，最终会演变成一个抽象工厂。</p>
<h2 id=工厂组合>工厂组合</h2>
<p>当然，可以将不同的工厂模式组合在一起。当然，这种方式需要谨慎选择并且仅在有必要的时候使用。否则，设计模式的滥用将会导致烂代码。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-12a0eb547c44a6cd9dc7862b732ae30a>2.10 - CH06-4-懒初始化</h1>
<p>在软件工程中，懒初始化是是将对象或变量的初始化过程延迟直到第一次被需要使用的时候。这个想法的背后是想要延迟或避免昂贵操作的执行。</p>
<h2 id=类图>类图</h2>
<p>在其他的语言中，比如 Java，懒初始化通常与工厂方法模式联合使用。该方法通常会检查我们需要使用的对象或变量是否已经被初始化了，如果没有则初始化该对象并返回。在后续的使用中，将会直接返回已被初始化的对象或变量。</p>
<p>Scala 语言中对懒初始化提供了内建支持，通过<code>lazy</code>关键字。因此在这里提供类图也没有意义了。</p>
<h2 id=实例>实例</h2>
<p>让我们看一下懒初始化在 Scala 中是如何工作的，并证明它真的是“懒”的。我们会看一个求圆形面积的计算。我们知道，公式是<code>pi * r² </code> 。数学语言中已经提供了数学常量，我们在现实生活中也不会这么做。然而，如果我们讨论的是一个不为大家熟知常量，这个例子仍然是有关联的，或者基于一个值波动的常量，但是每天都会不同。</p>
<p>在学习里我们被教育 π 的值为 3.14。这是对的，然而，如果我们关心精度的话后面还有很多额外的小数，我们仍然要包括它们。比如，包含 100 个小数的 π：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>3.14159265358979323846264338327950288419716939937510582097494459230781 64062862089986280348253421170679
</code></pre></div><p>因此让我们创建一个根据半径计算圆形面积的工具。我们将会把我们的 π 值作为变量放在工具类中，不过我们仍然支持用户来选择是否需要一个精确的面积值。如果需要，我们将会从配置文件中读取一个包含 100 个小时的 π 值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CircleUtils</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>basicPi</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3.14</span>
  <span style=color:#204a87;font-weight:700>lazy</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>precisePi</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Reading properties for the precise PI.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>props</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Properties</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getResourceAsStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pi.properties&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#000>props</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;pi.high&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toDouble</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>redius</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isPrecise</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pi</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isPrecise</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>precisePi</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>basicPi</span>
    <span style=color:#000>pi</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>radius</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>基于对精度的需求，我们将会使用 π 的不同版本。这里的懒初始化是很有帮助的，因为我们可能永远都不需要计算一个精确的面积。或者有时需要有时不需要。更进一步，读取配置文件是一个 IO 操作，可以认为是一个慢的或者多次执行会产生不好的副作用的操作。现在来使用它：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Example</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The basic area for a circle with radius 2.5 is </span><span style=color:#4e9a06>${</span><span style=color:#000>CircleUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2.5</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The precise area for a circle with radius 2.5 is </span><span style=color:#4e9a06>${</span><span style=color:#000>CircleUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2.5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The basic area for a circle with radius 6.78 is </span><span style=color:#4e9a06>${</span><span style=color:#000>CircleUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6.78</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The precise area for a circle with radius 6.78 is </span><span style=color:#4e9a06>${</span><span style=color:#000>CircleUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>area</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6.78</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们可以运行并观察程序的输出。首先，精度确实很重要，比如一些行业，金融、航天等等要重要的多。然后，在懒初始化块中，我们使用了一个<code>print</code>方法，它会在我们第一次使用精确实现的时候打印信息。普通的值会在实例创建的时候完成初始化。这显示了 Scala 中的懒初始化确实在第一次使用的时候才执行。</p>
<h2 id=优点>优点</h2>
<p>当一个对象或变量的初始化过程很耗时或者可能用不着，懒初始化会尤其有用。有人会说我们可以简单的使用一个方法来实现，这也是对的。然而，假如一种场景，我们需要在我们的对象中以不同的调用从多个方法访问一个懒初始化的对象或变量。这种情况下，将结果保存在一个地方并复用它将会很有帮助。</p>
<h2 id=缺点>缺点</h2>
<p>在 Scala 之外的语言中，从多线程环境访问一个懒初始化的变量需要被小心管理。在 Java 中，需要使用<code>synchronized</code>来进行初始化。为了能够提供更好的安全性，应该优先使用<em>double-checked locking</em>，而 Scala 中则没有这种危险(?)。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-331ada1c3d2231c55463d61a02d79d18>2.11 - CH06-5-单例模式</h1>
<p>单例模式用于确保一个类在整个应用中仅有一个实例。它在使用它的应用用引入了一个全局状态。</p>
<p>一个单例对象可以由不同的策略来初始化——懒初始化或热(eager)初始化。这都基于期望的用途，以及对象需要被初始化的时机，等等。</p>
<h2 id=类图>类图</h2>
<p>单例是另一种由 Scala 语言语法所支持的设计模式。我们通过<code>object</code>关键字来实现它，并没有必要提供一个类图，因此我们下一小节直接进入一个实例。</p>
<h2 id=实例>实例</h2>
<p>这个实例的目的是展示如果在 Scala 中创建一个单例对象，以及理解在 Scala 中对象是何时被创建的。我们将会看到一个名为<code>StringUtils</code>的类，提供了一些字符串相关的工具方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>countNumberOfSpecs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\\+s&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个类的用法也很直接。Scala 会管理对象的创建过程、线程安全，等等：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>UtilsExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sentence</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello there! I am a utils example.&#34;</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The number of spaces in &#39;</span><span style=color:#4e9a06>$sentence</span><span style=color:#4e9a06>&#39; is:
</span><span style=color:#4e9a06>  </span><span style=color:#4e9a06>${</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>countNumberOfSpaces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sentence</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>尽管<code>StringUtils</code>对象是一个单例实例，上面这个例子看起来仍然很清晰，类似于带有静态方法的类。这也就是在 Scala 中定义静态方法的方式。给一个单例类添加状态或许会更有意思。下面的例子展示了这种方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Registry initialization block called.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>users</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>TrieMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>addUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>removeUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isUserRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getAllUserNames</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>users</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toList</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>AppRegistry</code>包含一个使用应用的当前用户所构成的并发 Map。这是我们的全局状态，同时提供了一些方法来支持用户操作它。同时我们有一个打印语句，它会在这个单例对象被创建时执行。我们可以在下面的应用中使用这个注册表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AppRegistryExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Sleeping for 5 seconds.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I woke up.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Ivan&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;John&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;3&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Martin&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Is user with ID=1 registered? </span><span style=color:#4e9a06>${</span><span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isUserRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Removing ID=2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>removeUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Is user with ID=2 registered? </span><span style=color:#4e9a06>${</span><span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isUserRegistered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;All users registered are: </span><span style=color:#4e9a06>${</span><span style=color:#000>AppRegistry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getAllUserNames</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>mkString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;,&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从运行这段代码得到的输出你会发现，在 “I woke up” 之后会打印单例对象被初始化的信息，因为在 Scala 中，单例会被懒初始化。</p>
<h2 id=优点>优点</h2>
<p>在 Scala 中，单例模式与静态方法的实现方式一样。这也是单例可以有效的用于创建没有状态的工具类的原因。Scala 中的单例也可以用于创建 ADT。</p>
<p>另一个在 Scala 中严格有效的事情是，单例会被以线程安全的方式创建，因此无需一些额外的操作来确保。</p>
<h2 id=缺点>缺点</h2>
<p>单例模式实际上通常被称为是“anti-pattern”(反面模式、反面教材)。很多人说全局状态不能以单例的方式来实现。也有人说如果你不得不使用单例模式，则你需要尝试重构你的代码。虽然这在有些场景中是对的，但有些场景很适合使用单例模式。通常首要的原则是：如果你能避免，那就避免。</p>
<p>对于 Scala 的单例需要特别指出的一点是它可以真的仅拥有一个实例。虽然这实际上是该模式的定义，在其他语言中，我们可以拥有一个预定义的数量而非仅仅一个单例对象，我们可以使用自定义的逻辑进行控制。</p>
<p>有一点对 Scala 没有影响，不过还是值得一提。当应用中的单例被延迟初始化时，为了能够提供线程安全，需要基于一种加锁机制，比如前面提到过的<em>double-checked locking</em>。访问应用中的单例时，无论是在 Scala 中还是别的语言，同样需要以线程安全的方式来完成，或者由单例内部来处理这个问题。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c1ebea1c5fbeb4f13a93ebbd71fefdc9>2.12 - CH06-6-构建器模式</h1>
<p>构建起模式支持以类方法而类构造器的方式来创建实例。当一个类的构造器拥有多个版本以支持不同的用途时，这种模式尤其有用。更进一步，有些情况下，创建所有的组合是不可能的或者它们也无法被了解。构建起模式使用一个额外的对象，称为<code>builder</code>，用于在创建最终版本的对象之前接收和保存初始化参数。</p>
<h2 id=类图>类图</h2>
<p>这个小节中，我们首先会提供一个在其他语言中看起来比较经典的类图，包括 Java。然后，我们会基于它们来提供不同版本的代码实现来使其更符合 Scala，以及一些围绕它们的观察和讨论。</p>
<p>我们会拥有一个<code>Person</code>类，带有参数：<code>firstName</code>,<code>lastName</code>,<code>age</code>,<code>departmentId</code>等等。下个小节中会展示实际的代码。创建一个具体的构造器可能会花费太长时间，尤其是有些参数有些时候可能并不需要或被了解。这也会让代码在以后变得难以维护。而构建器模式可能会是个不错的想法，它的来图看起来像下面这样：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214170427.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>我们已经提到过，这也就是构建器模式在纯面向对象语言中看起来的样子。当构建器是抽象的时候，表示也会有所不同，这时会存在一些具体的构建器。这对它所创建的产品来说也是一样。最终，它们的目标都一样——使对象的创建更简单。</p>
<h2 id=实例>实例</h2>
<p>实际上在 Scala 中有三种不同的方式来表示构建器模式：</p>
<ul>
<li>经典方式，像上面展示的类图，类似与其他编程语言。这种方式实际上是不推荐的，尽管在 Scala 中也能实现。为了实现它使用了可变性，这违背了语言的可不变原则。为了完整性和体现使用 Scala 的简单特性会使实现多么简单，我们会进行展示。</li>
<li>使用带有默认参数的的样例类。我们会看到两种版本的实现，一种验证参数而另一种则没有。</li>
<li>使用泛化的(generalized)类型约束。</li>
</ul>
<p>下面的几个小节我们将会关注这些方式。为了使事情变得简单便于演示，我们会在类中使用较少的字段；然而，需要注意的是构建器模式真正适用的是拥有大量字段的类。</p>
<h2 id=类似-java-方式的实现>类似 Java 方式的实现</h2>
<p>首先是 Person 类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builder</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>age</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该类接收一个 builder 并使用它被设置的值来初始化字段。下面是 Builder 的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PersonBuilder</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>firstName</span>
    <span style=color:#204a87;font-weight:700>this</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lastName</span>
    <span style=color:#204a87;font-weight:700>this</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>age</span>
    <span style=color:#204a87;font-weight:700>this</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>构建器中提供了方法用于设置与<code>Person</code>向对应的字段值。这些方法都会返回相同的构建器实例，这样就能支持我们链式的调用它们。下面是如何使用这个构建器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PersonBuilderExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Ivan&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Nikolov&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Person: </span><span style=color:#4e9a06>${</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> </span><span style=color:#4e9a06>${</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>. Age: </span><span style=color:#4e9a06>${</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>age</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这就是构建器模式的使用方式。现在我们就可以创建一个<code>Person</code>对象而无论是否拥有需要提供的值——甚至仅拥有需要字段的一部分，我们可以指定一些字段然后剩余的字段会拥有默认的值。当为<code>Person</code>类添加新的字段也不必再创建新的构造器。仅需要通过<code>PersonBuilder</code>类进行兼容即可。</p>
<h2 id=使用样例类实现>使用样例类实现</h2>
<p>上个构建器模式的例子看起来很好，但是需要编写一些额外的代码和创建模板。此外，它需要我们在<code>PersonBuilder</code>类中拥有，这也违背了 Scala 中的不可变原则。</p>
<p>Scala 拥有样例类，这使得构建器模式的实现更加简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>其用法也与之前构建器类似：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PersonCaseClassExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Ivan&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Nikolov&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;John&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Person 1: </span><span style=color:#4e9a06>${</span><span style=color:#000>person1</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Person 2: </span><span style=color:#4e9a06>${</span><span style=color:#000>person2</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种实现要比前面第一种实现更加简短也更易维护。它能为开发者提供与第一种实现完全相同的功能，但是更简短、语法更清晰。同时保持了<code>Person</code>类的字段不可变，这也遵循了 Scala 中好的实践。</p>
<p>这两种实现都有的缺点是没有对参数进行验证。如果一些组件相互依赖并且有些特定的参数需要验证呢？前面这两种方式的用例中，我们可能会得到一些运行时异常。下一小节中将会展示如何确保验证和需求得到满足被实现。</p>
<h2 id=使用泛化类型约束>使用泛化类型约束</h2>
<p>在软件工程中的一些创建对象的用例中，我们会拥有一些依赖。我们要需要一些东西已经被初始化完成，那么需要一个特定的初始化顺序，等等。前面我们看到的两种构建器模式实现都缺乏确保某些东西已被实现或未被实现的能力。在这种方式中，我们需要围绕构建器模式创建一些额外的验证，以确保一切都符合预期。当然，我们会看一下在运行时创建对象是否是安全的。</p>
<p>使用一些我们之前在本书中见到的技术，我们可以创建一个能够在运行时验证所有的需求是否都已被满足的构建器。这杯称为<strong>type-safe builder</strong>，下个小节中我们会展示这种模式。</p>
<h3 id=改变-person-类>改变 Person 类</h3>
<p>首先，我们将使用与 Java 实现方式中展示的例子中相同的类开始。现在添加一些约束，比如每个人都最少拥有<code>firstName</code>和<code>lastName</code>。为了能够让编译器感知到这些字段是否已被设置，需要将这些编码为一个类型。我们将使用 ADT 来达到这个目的。让我们定义下面的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>BuildStep</span>
<span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>HasFirstStep</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BuildStep</span>
<span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>HasLastStep</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BuildStep</span>
</code></pre></div><p>上面这些抽象类型定义了构建过程的不同步骤。现在对之前的<code>Person</code>类个构建器进行一些重构：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>我们将会使用<code>Person</code>类完整的构造器，而非传递一个构建器。这是为了展示构建实例并保持后续的步骤代码简介的另一种方式。这些改变需要<code>PersonBuilder</code>中的<code>build</code>方法也进行一些改变：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=改变-personbuilder-类>改变 PersonBuilder 类</h3>
<p>现在改变<code>PersonBuilder</code>的声明为如下方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>PassedStep</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>BuildStep</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>private</span> <span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这将要求之前所有那些返回<code>PersonBuilder</code>的方法现在返回<code>PersonBuilder[PassedStep]</code>。同时，这要限制不能够在使用<code>new</code>关键字来创建构建器了，因为构造器现在是私有的。现在添加一些构造器重载：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pb</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>age</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>后面我们将会看到如何使用这些构造器。我们会支持用户以另一个方法来创建构建器，因为所有的构造器对外部都是不可见的。因此我们要添加一个伴生对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>BuildStep</span><span style=color:#ce5c00;font-weight:700>]()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>伴生对象使用了我们前面定义的其中一个构造器，它同样确保了返回的对象用有正确的构建步骤。</p>
<h2 id=给需要的方法添加泛化类型约束>给需要的方法添加泛化类型约束</h2>
<p>到目前为止，我们所有拥有的仍然不能满足我们对每个 Person 对象初始化的要求。我们需要改变一些<code>PersonBuilder</code>类中的方法。下面是这些方法的定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasFirstName</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>firstName</span>
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasFirstName</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasLastName</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lastName</span>
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasLastName</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>有趣的部分是最后的<code>build</code>方法，让我们首先看一下最初的额实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ev</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PassedStep</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HasLastName</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>上面的语法设置了一个泛化类型约束，它要求仅能在已经通过了<code>HasLastName</code>步骤的构建器上调用。看起来我们已经接近了预期的实现，但是现在的<code>build</code>方法仅适用于<code>setLastName</code>是四个方法中最后一个被调用的时候，同时也不会验证其他字段。让我们为<code>setFirstName</code>和<code>setLastName</code>使用类似的方式并将它们链接起来，因此每个方法都会要求上一个方法已经被调用。下面是<code>PersonBuilder</code>的最终实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>PassedStep</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>BuildStep</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>private</span> <span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
<span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pb</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#000>pb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>age</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setFirtstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasFirstName</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>firstName</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasFirstName</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ev</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PassedStep</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HasFirstName</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasLastName</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lastName</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>HasLastName</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>PsersonBuilder</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>PassedStep</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>age</span>
    <span style=color:#204a87;font-weight:700>this</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ev</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PassedStep</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>HasLastStep</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=使用-type-safe-构建器>使用 type-safe 构建器</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PersonBuilderTypeSafeExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>PersonBuilder</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Ivan&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Nikolov&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Person: </span><span style=color:#4e9a06>${</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06> </span><span style=color:#4e9a06>${</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>. Age: </span><span style=color:#4e9a06>${</span><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>age</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果我们遗漏了两个要求的方法之一或者颠倒了顺序，将会得到一个类似下面这样的编译错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Error:(103, 23) Cannot prove that com.ivan.nikolov.creational.builder.
type_safe.BuildStep =:=
com.ivan.nikolov.creational.builder.type_safe.HasFirstName.
		.setLastName(&#34;Nikolov&#34;)
		^
</code></pre></div><p>顺序的要求可以被认为是一个缺点，特别是根本不需要顺序的时候，不过可以通过一些额外的方式来解决这个问题。</p>
<blockquote>
<p>对这个 type-safe 构建器的一些观察：</p>
<ul>
<li>使用 type-safe 构建器，我们可以限定一个指定的调用顺序，和一些已经被初始化的字段</li>
<li>如果我们限定了多个字段，则需要将它们链接，这使得调用顺序变得重要。有些情况下会使库变得难用</li>
<li>编译器消息，如果构建器没有被正确使用，这些消息并不能明确指示错误</li>
<li>代码看起来跟 Java 方式的实现类似</li>
<li>这种类似 Java 的实现方式导致了对并不推荐的可变性的依赖</li>
</ul>
</blockquote>
<p>Scala 支持我们使用一个很好很清晰的构建器模式实现，同时能够要求构建顺序和已被初始化的字段。这是一个很好的特性，尽管有时会变得冗长乏味，或者限制了方法的实际用途。</p>
<h2 id=使用-require-语句>使用 require 语句</h2>
<p>上面展示的 type-safe 构建器很好，不过仍然有一些缺点：</p>
<ul>
<li>复杂性</li>
<li>可变性</li>
<li>一个预定义的初始化顺序</li>
</ul>
<p>然而，它有时可能会很有用，因为能够支持在编译期间检查所编写的代码。尽管有些时候编译期间的检查是没有必要的。如果这样的话，我们可以使事情变得非常简单并摆脱之前的复杂性，即使用已知的 case 类和<code>require</code>语句：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>){</span> 
  <span style=color:#000>require</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;First name is required.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>require</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Last name is required.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果上面的布尔条件不满足，我们的代码将会抛出一个<code>IllegalArgumentException</code>异常并包含正确信息。我们可以以同样的方式使用这些 case 类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PersonCaseClassRequireExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Ivan&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Nikolov&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>26</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Person 1: </span><span style=color:#4e9a06>${</span><span style=color:#000>person1</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;John&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们发现这里变得更加简单了，字段也不再可变，实际上也没有任何特定的初始化顺序。更进一步，我们可以设置有意义的信息来帮助我们诊断潜在的问题。如果编译期间的验证并非必须，这可能是更好的方式。</p>
<h2 id=优点>优点</h2>
<p>当我们需要创建一个复杂的对象时，这种构建器模式尤其适用，否则需要创建很多构造器。它通过一个 step-by-step 的方式使对象的创建更加简单、清晰、可读。</p>
<h2 id=缺点>缺点</h2>
<p>像我们在 type-safe 构建器中看到的，添加一些高级的逻辑和要求会带来相当多的工作。如果没有这种可能性，开发者会将危险暴露给这些类的用户以出现更多错误。同时，构建器包含很多看起来重复的代码，尤其是以类似 Java 的方式实现。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e34756daf85416be13164f59a068ab7b>2.13 - CH06-7-原型模式</h1>
<p>原型模式是一种从已存在的对象创建新对象的创建型模式。其目的在于避免昂贵的调用来保持高性能。</p>
<h2 id=类图>类图</h2>
<p>在 Java 语言中，我们通常会看到一个类实现一个带有<code>clone</code>方法的接口，它返回一个该类的新实例。限免的图示展示了其类图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214170506.png style=display:block;width:70% alt=NAME align=center>
</div>
<h2 id=实例>实例</h2>
<p>Scala 中原型模式的实现变得尤其简单。我们可以使用一种语言特性。由于原型设计模式真的类似于生物细胞分裂，让我们用一个细胞作为一个例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>/** Represents a bio cell */</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cell</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dna</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>proteins</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span>
</code></pre></div><p>在 Scala 中，所有的 case 类都拥有一个<code>copy</code>方法，它会返回一个克隆自原有实例的新实例。并在复制的过程中改变一些值。下面是用法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PrototypeExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>initialCell</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Cell</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;abcd&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;protein1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;protein2&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>copy1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>initialCell</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>copy2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>initialCell</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>copy3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>initialCell</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dna</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1234&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;The prototype is: </span><span style=color:#4e9a06>${</span><span style=color:#000>initialCell</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Cell 1: </span><span style=color:#4e9a06>${</span><span style=color:#000>copy1</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Cell 2: </span><span style=color:#4e9a06>${</span><span style=color:#000>copy2</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Cell 3: </span><span style=color:#4e9a06>${</span><span style=color:#000>copy3</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;1 and 2 are equal: </span><span style=color:#4e9a06>${</span><span style=color:#000>copy1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>copy2</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=优点>优点</h2>
<p>当性能很重要的时候原型模式将会很有帮助。使用<code>copy</code>方法，我们不用花费时间创建就能得到实例。缓慢可能源自一些创建过程中引起的计算，必须数据库调用或数据查询，等待。</p>
<h2 id=缺点>缺点</h2>
<p>使用对象的浅(shallow)拷贝可能引起错误或副作用，实际的引用会指向原始的实例。同时，避免构造器可能导致烂代码。原型模式需要被真正的用于不使用则会引起巨大的性能影响的场景。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dcd62209992869cc87e43e70049f1fad>2.14 - CH07-结构型模式</h1>
<h1 id=结构型设计模式>结构型设计模式</h1>
<p>我们设计模式之旅的下一张将关注一系列结构型设计模式。我们将以 Scala 的视角探索以下结构型设计模式：</p>
<ul>
<li>适配器</li>
<li>装饰器</li>
<li>桥接</li>
<li>组合</li>
<li>门面</li>
<li>享元</li>
<li>代理</li>
</ul>
<p>这一节我们将对什么是结构型设计模式以及它们为什么有用给出一个很好的理解。当我们熟悉了它们是什么之后，我们将单独的研究其中每一个并深入其细节，包括代码实例，何时使用、何时避免，以及在使用时需要注意什么。</p>
<h2 id=什么是结构型设计模式>什么是结构型设计模式</h2>
<p>结构型设计模式关心于软件中对象与类的组合。它们使用不同的方式以获得新的、更大型的、通常也更复杂的结构。这些方式有一下几种：</p>
<ul>
<li>继承</li>
<li>组合</li>
</ul>
<p>能够正确识别软件中对象之间的关系是简化软件结构的关键。在下面的几个小节，我们将讨论几种不同的设计模式并提供一些实例，能够为如何使用不同的结构型设计模式找到一些感觉。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-55ef6d7fe806536a06e886ff51323931>2.15 - CH07-1-适配器模式</h1>
<p>在很多情况下，我们需要通过将不同的组件组合在一起来让应用跑起来。然而，通常会出现不同组件的接口互相不兼容的问题。类似于使用一些公共库或任何库，我们自己并不能对其进行修改——因为别人的意见跟我们目前的配置完全一样是不太常见的。这也就是适配器的用途所在。它的目的在于在不修改源代码的情况下帮助兼容各个接口以能够在一起工作。</p>
<p>我们将会在下面的小节中通过类图和实例来展示适配器是如何工作的。</p>
<h2 id=类图>类图</h2>
<p>对于适配器的类图来说，让我们假如我们需要在应用中转换为使用一个新的日志库。我们尝试使用的新的库拥有一个<code>log</code>方法，它接收日志的消息和严重程度。然而，贯穿我们的整个应用，我们期望拥有<code>info/debug/warning/error</code>方法并且只接收日志消息，它能够自动的设置严重程度。当然，我们不能编辑原始库的代码，因此需要使用适配器模式。下面的图示展示了适配器模式的类图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172521.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>在上面的类图中，可以发现我们的适配器 AppLogger 扩展了 Logger，并使用其实例作为一个字段。在实现这些方法的时候，我们就可以简单的调用其<code>log</code>方法并传入不同的参数。这也就是通用的适配器实现方式，后面的小节我们会看到具体的代码实例。可能有些情况下不能直接扩展(比如原始类为 final)，我们将展示 Scala 如何来处理这种问题。同时，我们也会展示一些推荐的用法来使用语言特性实现适配器模式。</p>
<h2 id=实例>实例</h2>
<p>首先，首先看一下我们不能进行修改的<code>Logger</code>类的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Logger</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sevrvity</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>severity</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpperCase</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>: </span><span style=color:#4e9a06>$message</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们尽量保持简单以避免读者从本书的主旨上分心。下一步，我们可以要么仅仅编写一个类来扩展<code>Logger</code>，或者要么提供一个接口用于抽象。让我们使用第二种方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Log</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>into</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>warning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终，我们可以创建<code>AppLogger</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AppLogger</span> <span style=color:#000>extedns</span> <span style=color:#000>Logger</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>overrride</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>messgae</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;info&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>warning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;warning&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;error&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;debug&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后在我们的程序中使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AdapterExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>logger</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Logger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AppLogger</span>
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;This is an info message.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Debug something here.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Show an error message.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>warning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;About to finish.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bye!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>你会发现我们并没有完全按照类图的结构实现。我们并不需要 Logger 类的实例作为我们类的一个字段，因为我们的类已经是 Logger 的一个实例了(继承自 Logger)，因此可以直接方法它的 log 方法。</p>
</blockquote>
<p>这就是实现和使用基本的适配器模式的方法。然而，有些情况下我们想要适配的类被声明为 final，因此不能再对其进行扩展。下面的小节将展示如何处理这种情况。</p>
<h3 id=final-类的适配器模式>final 类的适配器模式</h3>
<p>如果我们声明原始日志类为 final，会发现之前实现的代码将编译错误。这种场景下有另一种适配器方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FinalAppLogger</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Log</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>logger</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FinalLogger</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;info&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>warning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;warning&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;error&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;debug&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里，我们简单的将最终日志类的实例包装在一个类中，并调用它的方法来传入不同的参数。这种用法跟前面的实现完全一样。或者有一种变种是将最终日志类的实例作为构造器参数传入适配日志类。这在原始日志类的创建过程需要一些额外的参数时比较有用。</p>
<h3 id=scala-方式的适配器模式>Scala 方式的适配器模式</h3>
<p>之前我们已经提到过很多次，Scala 是一个特性丰富的语言。基于这样的事实，我们可以使用隐式类来实现适配器的功能。这里我们会使用前面例子中的定义的 FinalLogger 来演示。</p>
<p>隐式类会在可能的地方提供隐式转换。为了能使隐式转换生效，我们需要导入这些隐式声明，这也就是为何它们通常被声明在对象(object)或包对象(package-object)中。对于这个例子，我们将使用包对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>object</span> <span style=color:#000>adapter</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FinalLoggerImplicit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>logger</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>FinalLogger</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Log</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;info&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>warning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;warning&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;error&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;debug&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这是一个我们日志实例定义位置的包对象。它户自动将<code>FinalLogger</code>实例转换为我们的隐式类。下面的代码片段展示了如何使用它：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AdapterImplicitExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>logger</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FinalLogger</span>
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;This is an info message.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Debug something here.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Show an error message.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>warning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;About to finish.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Bye!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=优点>优点</h2>
<p>适配器模式可以用于代码已经被设计并编写。它可以是接口协同工作或进行兼容。其实现和用法也很直接。</p>
<h2 id=缺点>缺点</h2>
<p>上面例子中的最后一种实现存在一些问题。就是每当我们需要使用这个日志器的时候总是需要导入包或对象。同时，隐式类或转换可能会让代码难以阅读和理解。隐式类也存在一些限制，描述在这：<a href=http://docs.scala-lang.org/overviews/core/implicit-classes.html>implicit-classes</a>。</p>
<p>像我们已经提到过的，当我们有一些无法改变的代码时该模式是有帮助的。如果我们能够修改原始代码，这将是最好的选择，因为在贯穿整个应用中使用适配器模式将会导致程序难以维护和理解。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ebcc881e76da36672713163521dfbc8b>2.16 - CH07-2-装饰器模式</h1>
<p>有些情况下我们需要给应用中的类添加一些功能。这可以通过继承来完成；然而，我们并不像这么做以避免影响应用中的其他所有类。这也就是装饰器的用途。</p>
<blockquote>
<p>装饰器的目的在于在不扩展原有类、并不影响其他扩展自该类的对象的行为的基础上为原有类添加额外的功能。</p>
</blockquote>
<p>装饰器模式通过包装被装饰的类来工作，并可以在运行时应用。装饰器尤其适用于一个类拥有多个扩展，并且这些扩展会以不同的方式组合的场景。替代编写所有可能的组合，装饰器可以被创建并在每个之上叠加它们的修改。后面的几个小节我们将展示何时在真实的场景中使用装饰器。</p>
<h2 id=类图>类图</h2>
<p>像我们之前看到的适配器设计模式，它的目标是将接口改变成不同的一个。在装饰器中，另一方面来说，帮助我们给方法提供额外的功能来增强一个接口。对于类图，我们将使用一个数据流的例子。假如我们拥有一个基本的流(stream)，我们想要对其加密、压缩、替换字符等等。下面是类图：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172630.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>在上面的类图中，<code>AdvancedInputReader</code>为<code>InputReader</code>提供了基本的实现。它包装了一个<code>BufferedReader</code>。然后我们拥有一个抽象的<code>InputReaderDecorator</code>类扩展自<code>InputReader</code>并拥有它的一个实例。通过扩展基本的装饰器，我们为流提供了加密、压缩或 Base64 编码它得到的输入的能力。我们可能在应用中想要不同的流，并且想要在上面的操作中以不同的顺序执行一个或多个。如果我们想要提供所有的可能性，代码将很快变得凌乱从而难以维护，尤其是当可能的操作数量很多。而使用装饰器，会在后面小节中看到的一样清晰整洁。</p>
<h2 id=实例>实例</h2>
<p>让我们看一下描述上面类图的具体代码实例。首先，我们使用一个特质来定义<code>InputReader</code>接口：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>InputReader</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后在<code>AdvancedInputReader</code>类中为接口提供一个基本的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AdvancedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reader</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>BufferedReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReader</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>asScala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toStream</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>为了能够应用装饰器模式，我们需要创建一些不同的装饰器。现在定义一个基本的装饰器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InputReaderDecorator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputReader</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>InputReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReader</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>inputReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后拥有不同的装饰器实现。首先定义一个将所有文本转换为大写的装饰器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CapitalizedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputReader</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>InputReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReaderDecorator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>再实现一个装饰器使用 gzip 分别将每一行输入进行压缩：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CompressingInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputReader</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>InputReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReaderDecorator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>text</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Length before compression: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>output</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteArrayOutputStream</span><span style=color:#ce5c00;font-weight:700>()</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>compressor</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GZIPOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>output</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>compressor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>outputByteArray</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>output</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toByteArray</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Length after compression: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>outputByteArray</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>outputByteArray</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>compressor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#000>output</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终，一个将所有行编码为 Base64 的装饰器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Base64EncoderInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputReader</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>InputReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReaderDecorator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputReader</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>Base64</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getEncoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getBytes</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>我们使用了一个中间的抽象类来演示装饰器模式，所有具体的装饰器都扩展自该抽象类。也可以不使用该中间抽象类而是直接扩展 InputReader 并包装其实例来实现这种模式。</p>
</blockquote>
<p>现在则可以在应用中根据需要来使用这些装饰器给输入流增加功能。用法和直接，像下面这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>DecoratorExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stream</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getResourceAsStream</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data.txt&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>reader</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CapitalizedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AdvancedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的例子中我们使用了类路径中的文本文件，它有如下内如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>this is a data file 
which contains lines 
and those lines will be 
manipulated by our stream reader.
</code></pre></div><p>和预期一样，我们应用装饰器的顺序也定义了这个被增强的功能的顺序。</p>
<p>让我们看另一个例子，这次会应用所有的装饰器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>DecoratorExampleBig</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stream</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getResourceAsStream</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data.txt&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>reader</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CompressingInputReader</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Base64InputReader</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CapitalizedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span>
          <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AdvancedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个例子会读取文本、转换为大写、Base64 编码，最终压缩为 GZIP。</p>
<h2 id=scala-方式的装饰器模式>Scala 方式的装饰器模式</h2>
<p>向其他设计模式一样，该模式也有一种利用 Scala 丰富特性的实现，其中使用了一些本书开头介绍的几种概念。在 Scala 中装饰器模式被称为<strong>特质叠加(stackable traits)</strong>。让我们看一下它的形式以及如何使用它。<code>InputReader</code>和<code>AdvancedInputReader</code>会像前面小节的实现一样被完全保留。我们实际是在两个例子中对其进行了复用。</p>
<p>下一步，不再定义一个<code>abstract decorator</code>类，取而代之的是仅仅在新的特质中定义不同的读取器修改：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>CapitalizedInputReaderTrait</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReader</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后，定义压缩输入读取器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>CompressingInuptReadrTrait</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReader</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>LazyLogging</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>text</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Length before compression: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>output</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteArrayOutputStream</span><span style=color:#ce5c00;font-weight:700>()</span> 
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>compressor</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GZIPOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>output</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>compressor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>outputByteArray</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>output</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toByteArray</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Length after compression: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>outputByteArray</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>outputByteArray</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>conpressor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#000>output</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后是 Base64 编码读取器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Base64EncoderInputReaderTrait</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputReader</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Stream</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readlines</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
      <span style=color:#000>Base64</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getEncoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Charset</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>你会发现这些实现并没有很大区别，这里我们使用特质替代了类，扩展自基本的<code>InputReader</code>特质，并使用了<code>abstract override</code>。</p>
<blockquote>
<p>抽象覆写(abstract override)支持我们在特质中对声明为 abstract 的方法调用 super。这允许在混入了一个已实现前一个方法的特质或类之后混入特质。abstract override 会告诉编译器我们是在故意这么做从而避免编译失败——它会在稍后进行检查，当我们使用特质并且其需要已经被满足的时候。</p>
</blockquote>
<p>上面我们展示了两个例子，现在我们会展示使用堆叠特质又会是什么样子。首先是仅进行转换大写：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>StackableTraitsExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stream</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getResourceAsStream</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data.txt&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>reader</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AdvancedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>CapitalizedInputReaderTrait</span>
    <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>第二个例子包括转换大写、Base64 编码和压缩：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>StackableTraitsBigExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stream</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getResourceAsStream</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data.txt&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>reader</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AdvancedInputReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> 
      <span style=color:#000>CapitalizedInputReaderTrait</span> <span style=color:#204a87;font-weight:700>with</span>
      <span style=color:#000>Base64EncoderInputReaderTrait</span> <span style=color:#204a87;font-weight:700>with</span>
      <span style=color:#000>CompressingInputReaderTrait</span>
    <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLines</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这两个例子的输出将会和原来的例子一样。然而这里我们使用了混入组合，看起来则会更加清晰。同时我们也少了一个类，因为我们不再需要<code>abstract decorator</code>类。要理解修改是如何被应用的也很简单——这里将会遵循叠加特质被混入的顺序。</p>
<blockquote>
<p><strong>叠加特质遵循线性化规则</strong></p>
<p>事实上在我们当前的例子中，修改从左到右被应用会被误解。这会发生的原因是，我们会将调用推到栈上，直到我们抵达 readLines 的基本实现，然后再以反向的顺序应用修改。</p>
<p>在后续的章节中我们将会看到更加深入的例子。</p>
</blockquote>
<h2 id=优点>优点</h2>
<p>装饰器给我们的应用带了个更多灵活性。它们不会修改原有的类，因此不会向原有的代码引入错误，也会节省更多代码的编写和维护。同时，它们可以避免我们对所创建的类的应用场景有所遗忘或没有遇见到。</p>
<p>在上面的例子中，我们展示了一些静态行为修改。然而，同样能够在运行时对实例进行动态装饰。</p>
<h2 id=缺点>缺点</h2>
<p>我们已经覆盖了使用装饰器的正面影响；然而，同样要支持的是对装饰器的过度使用仍然会带来问题。最终我们会得到大量很小的类，这会使我们的库难以使用，对领域知识的要求也更高。它们也会使初始化过程变得复杂，会需要一些其他的(创建型)设计模式，比如工厂或构建器。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-197cde039b5eaa221773406d44e4eb63>2.17 - CH07-3-桥接模式</h1>
<p>有些应用中对一个特定的功能拥有多种不同的实现。这些实现可能是一组算法或者在多个平台上执行的操作。这些实现经常会发生变化，同时贯穿整个应用的声明周期中会添加有新的实现。更进一步，这些实现可能会以不同的方式应用于不同的抽象。像在这些场景下，更好的方式是从我们的代码中解耦，否则我们将面临类爆炸的危险。</p>
<blockquote>
<p>桥接模式的目的在于将抽象与其实现解耦，然后二者可以互相独立地进行变动。</p>
</blockquote>
<p>当抽象或实现经常会独立的进行变动时，桥接设计模式会很有帮助。如果我们直接实现一个抽象，对于抽象或实现的变动将总是会影响继承层级中的其他类。这将使扩展、修改、对类的独立复用变得难以进行。</p>
<p>桥接模式消除了直接实现抽象带来的问题，因此能够使抽象和实现易于复用和修改。</p>
<p>桥接模式与适配器模式非常类似，而它们的不同在于，前者是我们在设计的时候应用，而后者是在使用一些遗留代码或外部库时应用。</p>
<h2 id=类图>类图</h2>
<p>对于类图和代码实例，让我们假设我们正在编写一个散列密码的库。在实践中，以普通文本的方式保存密码是需要避免的。这也是我们的库能够帮助用户的地方。有很多不同的散列算法可用。比如 SHA-1，MD5 和 SHA-256。我们想最少能够支持这些必能够轻松地添加新的方式。有不同的散列策略——你可以散列多次，组合不同的散列，给密码加盐等等。这些策略会让我们的密码很难通过*彩虹表(rainbow-table, 一种破解工具)*猜到。作为例子，我们将会展示带盐的散列和没有任何算的简单散列。</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172702.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>从上面的类图中你会发现，我们将实现(Hasher 及子类)和抽闲(PasswordConveter)进行了分离。这样就能支持我们添加新的散列实现，并在创建<code>PasswordConveter</code>的时候传入一个它的实例来立即使用它。如果我们没有之前的构建器模式，或许需要为每个散列算法分别创建一个密码转换器——这会使我们的代码规模膨胀或太过冗长而难以使用。</p>
<h2 id=实例>实例</h2>
<p>现在让我们以 Scala 的视角看一下上面的类图。首先，我们会关注于实现这一边的<code>Haser</code>特质：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Hasher</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
  
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getDigest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>algorithm</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>crypt</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>MessageDigest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>algorithm</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>crypt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>crypt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getBytes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#000>crypt</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后我们有三个类来实现它。代码看起来很简单也很类似，只是返回的结果不同：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Sha1Hasher</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Hasher</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeHex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getDigest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SHA-1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>digest</span><span style=color:#ce5c00;font-weight:700>()))</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Sha256Hasher</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Hasher</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeHex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getDigest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SHA-256&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>digest</span><span style=color:#ce5c00;font-weight:700>()))</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Md5Hasher</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Hasher</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeHex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getDigest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;MD5&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>digest</span><span style=color:#ce5c00;font-weight:700>()))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在让我们看一下抽象这一边。这也就是客户端要使用的部分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PasswordConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasher</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Hasher</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们选择提供两种不同的实现，<code>SimplePasswordConverter</code>和<code>SaltedPasswordConverter</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimplePasswrodConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasher</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Hasher</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PasswordConveter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasher</span><span style=color:#ce5c00;font-weight:700>){</span>
 <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SaltedPasswordConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasher</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Hasher</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PasswordConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasher</span><span style=color:#ce5c00;font-weight:700>){</span>
 <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hasher</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>passwrod</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在，如果客户端想要使用这个库，可以编写类似下面这样的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>BridgeExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimplePasswordConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sha256Hasher</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimplePasswordConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Md5Hasher</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SaltedPasswordConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;8jsdf32T^$%&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sha1Hasher</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p4</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SaltedPasswordConverter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;8jsdf32T^$%&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sha256Hasher</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;password&#39; in SHA-256 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;1234567890&#39; in MD5 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1234567890&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;password&#39; in salted SHA-1 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;password&#39; in salted SHA-256 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=scala-方式的桥接模式>Scala 方式的桥接模式</h2>
<p>桥接模式是另一种能够通过使用 Scala 的强大语言特性来实现的模式。这里我们将使用自类型。最初的<code>Hasher</code>特质将会保持不变。而实现将会转为为特质而不再是类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Sha1Hasher</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Hasher</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeHex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getDigest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SHA-1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>digest</span><span style=color:#ce5c00;font-weight:700>()))</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Sha256Hasher</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Hasher</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeHex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getDigest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;SHA-256&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>digest</span><span style=color:#ce5c00;font-weight:700>()))</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Md5Hasher</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Hasher</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Hex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>encodeHex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getDigest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;MD5&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>digest</span><span style=color:#ce5c00;font-weight:700>()))</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用特质将支持我们在后面需要的时候混入。</p>
<p>我们改变了例子中一些类的名字以避免冲突。<code>PasswordConverter</code>抽象现在看起来会像这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PasswordConverterBase</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Hasher</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>自类型会告诉编译器当我们使用<code>PasswordConverterBase</code>的时候同时需要混入一个<code>Hasher</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimplePasswordConverterScala</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PasswordConverterBase</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Hasher</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SaltedPasswrodConverterScala</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>salt</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PasswordConverterBase</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Hasher</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>salt</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:</span><span style=color:#4e9a06>${</span><span style=color:#000>password</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终，我们可以像下面这样使用新的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>ScalaBridgeExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimplePasswordConverterScala</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Sha256Hasher</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SimplePasswordConverterScala</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Md5Hasher</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SaltedPasswordConverterScala</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;8jsdf32T^$%&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Sha1Hasher</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p4</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SaltedPasswordConverterScala</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;8jsdf32T^$%&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Sha256Hasher</span>
  
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;password&#39; in SHA-256 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;1234567890&#39; in MD5 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1234567890&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;password&#39; in salted SHA-1 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;&#39;password&#39; in salted SHA-256 is: </span><span style=color:#4e9a06>${</span><span style=color:#000>p4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;password&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行这段代码将会与第一种实现得到的输出一样。然而，当我们使用我们的抽象时，可以混入我们需要使用的散列算法。但我们拥有更多的实现需要与散列结合时，这种优势会变得更加明显。使用混入看起来也会更加自然和易懂。</p>
<h2 id=优点>优点</h2>
<p>像我们已经提到的，桥接模式类似于适配器模式，不过我们会在设计应用的时候应用该模式。使用它的一个明显优势是最终我们的应用中不会拥有爆炸数量的类，从而导致库的使用变得相当复杂。分离的层级结构也支持我们能够独立的扩展它们而不会影响其他的类。</p>
<h2 id=缺点>缺点</h2>
<p>桥接模式需要我们编写一些模板代码。当需要选择哪种的具体的实现时，会增加使用库的复杂性，或许使用桥接模式和一些创建型模式相结合或是一个不错的主意。总而言之，它没有主要的缺点，开发者需要根据当前的情况明智的选择是否使用这种模式。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c770d6e53018726100b55556d9599025>2.18 - CH07-4-组合模式</h1>
<p>组合设计模式用于描述一组对象应该像一个对象一样处理。</p>
<blockquote>
<p>目的在于将对象组合为一个树结构以表示 整体-部分 的层级关系。</p>
</blockquote>
<p>组合模式可用于移除重复代码或者在一组对象应该以相同的方式处理时避免错误。一个典型的例子是文件系统，我们可以拥有文件夹，其中又可以拥有其他文件夹或文件。通常，用于交互文件或文件夹的接口是相同的，因此它们可以很好的适用组合模式。</p>
<h2 id=类图>类图</h2>
<p>像我们之前提到的，文件系统能够很好的适用组合模式。总的来说，它们是一个树形结构，因此对于我们的例子来说，我们将会展示如何使用组合模式来构建一个树形结构。</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172735.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>从上面的类图你会发现，Tree 是我们的组合对象。它包含子对象，要么是另一个带有子对象的 Tree 对象，要门仅仅是一个 Leaf 节点。</p>
<h2 id=实例>实例</h2>
<p>让我们看一下上面类图的代码表示。首先我们需要通过一个特质来定义<code>Node</code>接口：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>print 方法的 prefix 参数用于帮助在打印树结构时拥有更好的可视化。</p>
</blockquote>
<p>在我们拥有接口之后，现在可以定义具体的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Node</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>prefix</span><span style=color:#4e9a06>}${</span><span style=color:#000>data</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Tree</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>children</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ListBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Node</span><span style=color:#ce5c00;font-weight:700>]</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>prefix</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>(&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>prefix</span><span style=color:#4e9a06>}${</span><span style=color:#000>prefix</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>prefix</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>)&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Node</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>child</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nonEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>之后便可以直接使用这些代码。在打印的时候，我们不用关心它具体是叶子还是树。我们的代码将会自动处理这些：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CompositeExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>tree</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Tree</span>
  
  <span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;leaf 1&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>subtree1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Tree</span> 
  <span style=color:#000>subtree1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;leaf 2&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>subtree2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Tree</span> 
  <span style=color:#000>subtree2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;leaf 3&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>subtree2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;leaf 4&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>subtree1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subtree2</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subtree1</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>subtree3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Tree</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>subtree4</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Tree</span> 
  <span style=color:#000>subtree4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;leaf 5&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>subtree4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;leaf 6&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  
  <span style=color:#000>subtree3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subtree4</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subtree3</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>tree</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码实际上会对我们的树形结构进行深度优先遍历。我们拥有的数据结构看起来会像下面这样：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172753.png style=display:block;width:70% alt=NAME align=center>
</div>
<h2 id=优点>优点</h2>
<p>组合模式能够有效的减少代码重复，在创建层级结构的时候也很直接。简化的部分来自于客户端并不知道它们实际上正在处理的什么类型的对象。添加新的节点类型也很简单，不需要改变其他任何东西。</p>
<h2 id=缺点>缺点</h2>
<p>组合模式没有任何主要的缺点。它确实适用于具体场景。开发者需要注意的一点是在处理大规模的层级结构时，因为在这种情况下，我们可能会深入到递归签到的项目里，而这可能会引起栈溢出问题。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7cdfc9bbc082469dd414787b2cf41a73>2.19 - CH07-5-外观模式</h1>
<p>每当我们要构建一些库或大型的系统，总是会需要依赖一些其他的库或功能。方法的实现有时需要同时依赖多个类。这就需要一些必要的知识以了解这些类。无论何时我们为用户构建一些库，我们总是尝试使其对用户来说变得简单以假设他们并不会也并不需要像我们一样拥有广泛的领域知识。另外，开发者需要确保那些组件能够在整个用户的应用中易于使用。这也就是外观模式的用途所在。</p>
<blockquote>
<p>其目的在于通过一个简单的结构来包装一个复杂的系统，以隐藏使用的复杂性来简化客户端的交互。</p>
</blockquote>
<p>我们已经看到过一些基于包装来实现的设计模式。适配器模式通过将一个接口转换为另一个，装饰器用来添加额外的功能，而外观模式则使一切变得更加简单。</p>
<h2 id=类图>类图</h2>
<p>对于类图，让我们假设一下的设置：我们想要用户能够从服务端下载一些数据并能以对象的方式完成反序列化。服务端以编码的形式返回数据，因此我们首先要对其进行解码，然后解析，最终返回正确的对象。所涉及的这些大量的操作使事情变的复杂。这也就是我们要使用外观模式的原因。</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172825.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>当客户端使用上面的应用时，他们仅需要与<code>DataReader</code>进行交互。而在内部会处理好对数据的下载、解码及反序列化。</p>
<h2 id=实例>实例</h2>
<p>上面的类图中展示了<code>DataDownloader</code>、<code>DataDecoder</code>、<code>DataDeserializer</code> 作为对象组合在<code>DataReader</code>中使用。这样实现起来直接清晰——它们要么可以通过默认的构造器创建，要么作为参数传入。对于我们例子的代码展示来说，我们选择使用特质来代替类，并将它们混入到<code>DataReader</code>类中。</p>
<p>首先让我们看一下这几个特质：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>DataDownloader</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>LazyLogging</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>download</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Byte</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Downloading from: {}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#8f5902;font-style:italic>// { 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// &#34;name&#34;: &#34;Ivan&#34;, 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// &#34;age&#34;: 26 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// } 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// the string below is the Base64 encoded Json above.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#4e9a06>&#34;ew0KICAgICJuYW1lIjogIkl2YW4iLA0KICAgICJhZ2UiOiAyNg0KfQ==&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getBytes</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>DataDecoder</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>decode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Byte</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Base64</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getDecoder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>decode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>DataDeserializer</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>formats</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>DefaultFormats</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>m</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Manifest</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#000>JsonMethods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringInput</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#000>extract</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的这些实现十分简单并且相互分离，因为它们都处理不同的任务。任何人都可以使用它们；然而，这会需要一些必备的知识并使事情变得更加复杂。这也是为什么我们把外观类称为<code>DataReader</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DataReader</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DataDownloader</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>DataDecoder</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>DataDeserializer</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>readPerson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>data</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>download</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>json</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>decode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>json</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个实例清晰的展示了替代使用三个不同的接口，我们可以使用一个简单的方法调用。而所有的复杂性都隐藏在方法的内部。下面的清单展示了这个类的用法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FacadeExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>reader</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataReader</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;We just read the following person: </span><span style=color:#4e9a06>${</span><span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readPerson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://www.ivan-nikolov.com/&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当然，在这个例子中，我们同样可以使用类来代替特质混入，这完全基于实现的需要。</p>
<h2 id=优点>优点</h2>
<p>外观模式可以用于隐藏库的实现细节，使接口更加易于用来交互负载的系统。</p>
<h2 id=缺点>缺点</h2>
<p>人们常犯的一个错误是尝试把一切都放到一个外观中。这种形式是没有任何帮助的，开发者仍然要面对复杂的系统。另外，外观可能会被证明限制了那些拥有足够领域知识的用户对原始的功能的使用。当门面称为与内部系统交互的唯一方式时这种限制就尤为明显。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e29e76383011b6e986605e8d53329161>2.20 - CH07-6-享元模式</h1>
<p>通常当软件编写完成后，开发者会尝试使其更加快速高效。通常这意味着更少的处理循环和更少的内存占用。有多种不同的方式来实现这两个概念。大多数时间，一个好的算法能够处理好第一个问题。内存的使用规模则存在不同的原因和解决方案，而享元模式则是用于帮助减少内存的使用。</p>
<blockquote>
<p>该模式的目是通过将一个对象与其类似的对象共享尽可能多的数据来帮助优化内存的使用。</p>
</blockquote>
<p>在很多情况下很多对象会共享一些相同的信息。讨论享元模式时一个常用的例子是单词处理。替代使用所有的信息包括字体、大小、颜色、图片等等来表示一个字符，我们可以仅仅保存类似字符的坐标并引用一个拥有相同信息的对象。这样可以使内存的使用显著减少。否则，这样的应用将无法使用。</p>
<h2 id=类图>类图</h2>
<p>对于类图，让我们假设正在尝试表示一个类似下面这样用于色盲测试的图片：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172918.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>我们可以发现，它由拥有不同大小和颜色的原型组合而成。可能的情况下，这可能是一个无限大的图片从而拥有无数个原型。为了使事情变的简单，让我们设置一个限制，假设仅拥有五种不同的颜色：红、绿、蓝、黄、洋红。下面的类图展示了如何使用享元模式来表示类似上面的图片：</p>
<div align=center>
<img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190214172931.png style=display:block;width:70% alt=NAME align=center>
</div>
<p>实际的享元模式通过<code>CircleFactory</code>、<code>Circle</code>、<code>Client</code>来实现。客户端请求工厂，要么返回一个新的<code>Circle</code>实例，要么是拥有相同参数的实例已经存在，则会从缓存中返回。比如，共享的数据是带有各自颜色的<code>Circle</code>对象，而每个特定的<code>Circle</code>都拥有各自的坐标和半径。<code>Graphic</code>中会包含带有所有信息的圆形。基于上面类图的代码实现会使一切变得更加清晰。</p>
<h2 id=实例>实例</h2>
<p>是时候看一下使用 Scala 来表示享元模式是什么样子了。我们将使用前面展示过的相同的例子。如果代码版本中的名称等属性与类图中有所不同，并没有什么值得注意的。这种变化主要是源自 Scala 的习俗。在贯穿代码的时候我们将会在发生的地方明确指出。</p>
<p>关于享元模式和例子中有趣的一点是我们实际上使用了一些前面提到过的模式和技术。我们同样会在贯穿代码的时候明确指出。</p>
<p>首先我们要做的是表示颜色。这实际上跟模式无关，这里我们使用 ADT 来表示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Color</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Red</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Color</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Blue</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Color</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Green</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Color</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Yellow</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Color</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Magenta</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Color</span>
</code></pre></div><p>在定义完颜色之后，我们开始定义<code>Circle</code>类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>color</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Color</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Creating a circle with </span><span style=color:#4e9a06>$color</span><span style=color:#4e9a06> color.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;Circle(</span><span style=color:#4e9a06>$color</span><span style=color:#4e9a06>)&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这些圆形将会是享元对象，因此对象中仅拥有将会与其他对象共享的数据。现在我们拥有了圆形的模型，现在创建圆形工厂。这里使用了工厂模式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cache</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Color</span>, <span style=color:#204a87;font-weight:700>Circle</span><span style=color:#ce5c00;font-weight:700>]</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>color</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Color</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Circle</span> <span style=color:#ce5c00;font-weight:700>=</span> 
    <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getOrElseUpdate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>color</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>color</span><span style=color:#ce5c00;font-weight:700>))</span>
    
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>circlesCreated</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>size</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们使用 Scala 中的伴生对象来实现工厂模式。这也就是为什么类名与上面类图中的类名不同。这种表示支持我们使用下面的语法要么获得一个已存在的实例要么创建一个新的实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Green</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>现在我们拥有了圆形和工厂，然后实现<code>Graphic</code>类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Graphic</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>items</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ListBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>Int</span>,<span style=color:#204a87;font-weight:700>Int</span>,<span style=color:#204a87;font-weight:700>Double</span>,<span style=color:#204a87;font-weight:700>Circle</span><span style=color:#ce5c00;font-weight:700>)]</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>radius</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>circle</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Circle</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>items</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>radius</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>circle</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>draw</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>radius</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>circle</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Drawing a circle at (</span><span style=color:#4e9a06>$x</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>$y</span><span style=color:#4e9a06>) with radius </span><span style=color:#4e9a06>$radius</span><span style=color:#4e9a06>: </span><span style=color:#4e9a06>$circle</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>Graphic</code>类实际上将会包含所有其他与圆形相关的数据。上面类图中的<code>Client</code>并不需要在代码中进行明确的表示——它仅仅是使用工厂的代码。类似的，<code>Graphic</code>对象会被程序来搜索圆形对象，而非通过一个客户端的显式访问。下面是对这些类的使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FlyweightExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>graphic</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Graphic</span>
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Green</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Red</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blue</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Green</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Yellow</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Magenta</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blue</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Blue</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Yellow</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>addCircle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Red</span><span style=color:#ce5c00;font-weight:700>))</span>

  <span style=color:#000>graphic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>draw</span><span style=color:#ce5c00;font-weight:700>()</span>

  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Total number of circle objects created: </span><span style=color:#4e9a06>${</span><span style=color:#000>Circle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>circlesCreated</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在一开始定义<code>Circle</code>类的时候，我们会在其构造期间打印一条信息。运行这段代码会发现，带有每个特定颜色的圆形仅会被创建一次，尽管我们在构件整个图的时候使用了很多圆形。最后一行信息显示了我们事实上仅拥有 5 个实际的圆形实例，尽管我们的图拥有十个不同的圆形。</p>
<p>该实例仅仅展示了享元模式是如何工作的。在真实的应用中，享元对象可能会共享更多的信息，从能能够在实际的应用中减少内存的占用。</p>
<h2 id=优点>优点</h2>
<p>像我们前面已经提到的，享元模式可以用于尝试减少应用的内存占用。使用共享的对象，我们的应用会需要更少对象的构造和解构，同时也能提高性能。</p>
<h2 id=缺点>缺点</h2>
<p>基于所要共享数据的规模，有时实际共享对象的数量会动态的增长而不能带来更多的优势。另外，会增加工长本身和其用法的复杂性。多线程应用则需要对工厂进行额外的处理。最后但并非最不重要的是，开发者在使用共享对象时需要额外小心，其中的任何改变都会影响到整个应用，在 Scala 中由于不可变性则不需要额外关心。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f09b2a63cbb1f15437f23ef4eaf4b40c>2.21 - CH07-7-代理模式</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-deab981b6d4fa0b088c28d95ed21f010>2.22 - CH08-行为型模式-1</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ecdea902c568d3f06103804c1d17dbe3>2.23 - CH09-行为型模式-2</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-15b88e04d349a5f8e8de86b4a8e97283>2.24 - CH10-函数式模式理论</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3c543f72b3cd75fdfd89fb6fec23203e>2.25 - CH11-函数式模式应用</h1>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-198e982211f90ca13626d2c25bfd5ed9>2.26 - CH12-实际应用</h1>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>