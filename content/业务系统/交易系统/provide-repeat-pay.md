---
type: docs
title: "防止重复支付"
linkTitle: "防止重复支付"
weight: 1
---

## 业务场景

<div><img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220220215758.png" style="display:block;margin-left:auto;margin-right:auto;width:80%;" alt="20220220215758" /></div>

如图是一个简化的下单流程，首先是提交订单，然后是支付。支付的话，一般是走支付网关（支付中心），然后支付中心与第三方支付渠道（微信、支付宝、银联）交互，支付成功以后，异步通知支付中心，支付中心更新自身支付订单状态，再通知业务应用，各业务再更新各自订单状态。

这个过程中经常可能遇到的问题是掉单，无论是超时未收到回调通知也好，还是程序自身报错也好，总之由于各种各样的原因，没有如期收到通知并正确的处理后续逻辑等等，都会造成用户支付成功了，但是服务端这边订单状态没更新，这个时候有可能产生投诉，或者用户重复支付。

由于③⑤造成的掉单称之为**外部掉单**，由④⑥造成的掉单我们称之为**内部掉单**。

## 防止掉单

1. 支付订单增加一个中间状态“支付中”，当同一个订单去支付的时候，先检查有没有状态为“支付中”的支付流水，当然支付（prepay）的时候要加个锁。支付完成以后更新支付流水状态的时候再将其改成“支付成功”状态。
2. 支付中心这边要自己定义一个超时时间（比如：30秒），在此时间范围内如果没有收到支付成功回调，则应调用接口主动查询支付结果，比如10s、20s、30s查一次，如果在最大查询次数内没有查到结果，应做异常处理
3. 支付中心收到支付结果以后，将结果同步给业务系统，可以发MQ，也可以直接调用，直接调用的话要加重试（比如：SpringBoot Retry）
4. 无论是支付中心，还是业务应用，在接收支付结果通知时都要考虑接口幂等性，消息只处理一次，其余的忽略
5. 业务应用也应做超时主动查询支付结果

对于上面说的超时主动查询可以在发起支付的时候将这些支付订单放到一张表中，用定时任务去扫。

## 防止重复

创建订单的时候，用订单信息计算一个哈希值，判断 redis 中是否有key，有则不允许重复提交，没有则生成一个新key，放到redis中设置个过期时间，然后创建订单。其实就是在一段时间内不可重复相同的操作。

### 微信支付的支付流程

<div><img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220220220202.png" style="display:block;margin-left:auto;margin-right:auto;width:80%;" alt="20220220220202" /></div>
