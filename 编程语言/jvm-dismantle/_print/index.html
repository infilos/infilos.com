<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.93.0">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-dismantle/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>JVM 拆解 | infilos.com</title><meta property="og:title" content="JVM 拆解">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-dismantle/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="JVM 拆解">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="JVM 拆解">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-123062585-1","auto"),ga("send","pageview"))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head><body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand-lg navbar-dark td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span>
<span class=font-weight-bold>infilos.com</span>
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li><li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div></li><li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div></li><li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div></li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li><li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li></ul><div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div></div></div></nav></header><div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-dismantle/>返回本页常规视图</a>.
</p></div><h1 class=title>JVM 拆解</h1><ul>
<li>1: <a href=#pg-c1e5cf4d699a5905d24ddaa4f74d23fb>CH01-开始运行</a></li><li>2: <a href=#pg-b1c9efdea7f6466c46935fd744172c01>CH02-基本类型</a></li><li>3: <a href=#pg-7437e6365d10a130934c8e53d72b90e2>CH03-类加载</a></li><li>4: <a href=#pg-df06c3266af88cb5c7fa593b0b2d4543>CH04-方法调用-上</a></li><li>5: <a href=#pg-6f77ddc54011b6a8b54ff7d3045b7cb5>CH05-方法调用-下</a></li><li>6: <a href=#pg-7a7e79b881d0ead21c480bf426bde765>CH06-异常处理</a></li><li>7: <a href=#pg-663901ec4075a7ebc81009718147915e>CH07-实现反射</a></li><li>8: <a href=#pg-b61c62764420638d737c30aec2b80d43>CH08-invokedynamic-上</a></li><li>9: <a href=#pg-80d0892bfadac8f9301a80f0d5509158>CH09-invokedynamic-下</a></li><li>10: <a href=#pg-3e5864898a2903c5e0fc455ace4fb22d>CH10-对象内存布局</a></li><li>11: <a href=#pg-7802b4a703743b4e6094f0a6360fcd34>CH11-垃圾回收-上</a></li><li>12: <a href=#pg-00b575886fac0d960951532d20312051>CH12-垃圾回收-下</a></li><li>13: <a href=#pg-845e85e25246c2e4a708a3fbb1f6db7e>CH13-内存模型</a></li><li>14: <a href=#pg-400b9766cf9bfc55888b6281e35996a8>CH14-Synchronized</a></li><li>15: <a href=#pg-dbe0efdcbae5f047258ef99095d85569>CH99-常用工具</a></li></ul><div class=content>
</div></div><div class=td-content>
<h1 id=pg-c1e5cf4d699a5905d24ddaa4f74d23fb>1 - CH01-开始运行</h1><p>Java 代码有很多种不同的运行方式。比如说可以在开发工具中运行，可以双击执行 jar 文件运行，也可以在命令行中运行，甚至可以在网页中运行。当然，这些执行方式都离不开 <strong>JRE</strong>，也就是 <strong>Java 运行时环境</strong>。</p><p>实际上，JRE 仅包含运行 Java 程序的必需组件，包括 Java 虚拟机以及 Java 核心类库等。我们 Java 程序员经常接触到的 JDK（Java 开发工具包）同样包含了 JRE，并且还附带了一系列开发、诊断工具。</p><h2 id=为什么需要虚拟机>为什么需要虚拟机</h2><p>Java 作为一门高级程序语言，它的语法非常复杂，抽象程度也很高。因此，直接在硬件上运行这种复杂的程序并不现实，需要进行一些转换。</p><p>当前的主流思路是，设计一个面向 Java 语言特性的虚拟机，并通过编译器将 Java 程序转换成该虚拟机所能识别的指令序列，也称 <strong>Java 字节码</strong>。叫做字节码是因为 Java 字节码指令的操作码（opcode）被固定为一个字节。</p><p>比如下面代码的中间列，正是用 Java 写的 Helloworld 程序编译而成的字节码。可以看到，它与 C 版本的编译结果一样，都是由一个个字节组成的。</p><p>我们同样可以将其反汇编为人类可读的代码格式（如下图的最右列所示）。不同的是，Java 版本的编译结果相对精简一些。这是因为 Java 虚拟机相对于物理机而言，抽象程度更高。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># 最左列是偏移；中间列是给虚拟机读的机器码；最右列是给人读的代码
</span></span><span style=display:flex><span>0x00:  b2 00 02         getstatic java.lang.System.out
</span></span><span style=display:flex><span>0x03:  12 03            ldc &#34;Hello, World!&#34;
</span></span><span style=display:flex><span>0x05:  b6 00 04         invokevirtual java.io.PrintStream.println
</span></span><span style=display:flex><span>0x08:  b1               return
</span></span></code></pre></div><p>Java 虚拟机可以由硬件实现 [1]，但更为常见的是在各个现有平台（如 Windows_x64、Linux_aarch64）上提供软件实现。这么做的意义在于，一旦一个程序被转换成 Java 字节码，那么它便可以在不同平台上的虚拟机实现里运行。这也就是我们经常说的“<strong>一次编写，到处运行</strong>”。</p><p>虚拟机的<strong>另外一个好处是它带来了一个托管环境</strong>（Managed Runtime）。这个托管环境能够代替我们处理一些代码中冗长而且容易出错的部分。其中最广为人知的当属自动内存管理与垃圾回收，这部分内容甚至催生了一波垃圾回收调优的业务。</p><p>除此之外，托管环境还提供了诸如数组越界、动态类型、安全权限等等的动态检测，使我们免于书写这些无关业务逻辑的代码。</p><h2 id=jvm-如何执行字节码>JVM 如何执行字节码</h2><p>从虚拟机视角来看，执行 Java 代码首先需要将它编译而成的 class 文件加载到 Java 虚拟机中。加载后的 Java 类会被存放于**方法区（Method Area）**中。实际运行时，虚拟机会执行方法区内的代码。</p><p>如果你熟悉 X86 的话，你会发现这和段式内存管理中的代码段类似。而且，Java 虚拟机同样也<strong>在内存中划分出堆和栈来存储运行时数据</strong>。</p><p>不同的是，<strong>Java 虚拟机会将栈细分为面向 Java 方法的 Java 方法栈，面向本地方法（用 C++ 写的 native 方法）的本地方法栈，以及存放各个线程执行位置的 PC 寄存器。</strong></p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220222221719.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220222221719></div><p>在运行过程中，<strong>每当调用进入一个 Java 方法，Java 虚拟机会在当前线程的 Java 方法栈中生成一个栈帧，用以存放局部变量以及字节码的操作数。这个栈帧的大小是提前计算好的，而且 Java 虚拟机不要求栈帧在内存空间里连续分布。</strong></p><p>当退出当前执行的方法时，不管是正常返回还是异常返回，Java 虚拟机均会弹出当前线程的当前栈帧，并将之舍弃。</p><p>从硬件视角来看，Java 字节码无法直接执行。因此，Java 虚拟机需要将字节码翻译成机器码。</p><p>在 HotSpot 里面，上述翻译过程有两种形式：<strong>第一种是解释执行，即逐条将字节码翻译成机器码并执行</strong>；<strong>第二种是即时编译（Just-In-Time compilation，JIT），即将一个方法中包含的所有字节码编译成机器码后再执行</strong>。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220222221905.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220222221905></div><p><strong>前者的优势在于无需等待编译，而后者的优势在于实际运行速度更快</strong>。HotSpot 默认采用<strong>混合模式</strong>，综合了解释执行和即时编译两者的优点。它会<strong>先解释执行字节码，而后将其中反复执行的热点代码，以方法为单位进行即时编译。</strong></p><h2 id=jvm-运行效率>JVM 运行效率</h2><p>HotSpot 采用了多种技术来提升启动性能以及峰值性能，刚刚提到的即时编译便是其中最重要的技术之一。</p><p><strong>即时编译</strong>建立在程序符合二八定律的假设上，也就是百分之二十的代码占据了百分之八十的计算资源。</p><p>对于占据大部分的不常用的代码，我们无需耗费时间将其编译成机器码，而是采取解释执行的方式运行；另一方面，<strong>对于仅占据小部分的热点代码，我们则可以将其编译成机器码，以达到理想的运行速度</strong>。</p><p>理论上讲，即时编译后的 Java 程序的执行效率，是可能超过 C++ 程序的。这是因为与静态编译相比，<strong>即时编译拥有程序的运行时信息，并且能够根据这个信息做出相应的优化。</strong></p><p>举个例子，我们知道<strong>虚方法是用来实现面向对象语言多态性的</strong>。<strong>对于一个虚方法调用，尽管它有很多个目标方法，但在实际运行过程中它可能只调用其中的一个。</strong></p><p>这个信息便可以<strong>被即时编译器所利用，来规避虚方法调用的开销，从而达到比静态编译的 C++ 程序更高的性能。</strong></p><p>为了满足不同用户场景的需要，HotSpot 内置了多个即时编译器：C1、C2 和 Graal。Graal 是 Java 10 正式引入的实验性即时编译器，在专栏的第四部分我会详细介绍，这里暂不做讨论。</p><p>之所以引入多个即时编译器，是为了<strong>在编译时间和生成代码的执行效率之间进行取舍</strong>。<strong>C1 又叫做 Client 编译器</strong>，面向的是对启动性能有要求的客户端 GUI 程序，采用的优化手段相对简单，因此编译时间较短。</p><p><strong>C2 又叫做 Server 编译器</strong>，面向的是对峰值性能有要求的服务器端程序，采用的优化手段相对复杂，因此编译时间较长，但同时生成代码的执行效率较高。</p><p><strong>从 Java 7 开始，HotSpot 默认采用分层编译的方式：热点方法首先会被 C1 编译，而后热点方法中的热点会进一步被 C2 编译。</strong></p><p>为了不干扰应用的正常运行，<strong>HotSpot 的即时编译是放在额外的编译线程中进行的</strong>。HotSpot 会<strong>根据 CPU 的数量设置编译线程的数目，并且按 1:2 的比例配置给 C1 及 C2 编译器。</strong></p><p>在计算资源充足的情况下，字节码的解释执行和即时编译可同时进行。编译完成后的机器码会在下次调用该方法时启用，以替换原本的解释执行。</p><h2 id=总结与实践>总结与实践</h2><p>之所以要在虚拟机中运行，是因为它提供了<strong>可移植性</strong>。一旦 Java 代码被编译为 Java 字节码，便可以在不同平台上的 Java 虚拟机实现上运行。此外，虚拟机还提供了一个<strong>代码托管的环境</strong>，代替我们处理部分冗长而且容易出错的事务，例如内存管理。</p><p>Java 虚拟机<strong>将运行时内存区域划分为五个部分，分别为方法区、堆、PC 寄存器、Java 方法栈和本地方法栈</strong>。Java 程序<strong>编译而成的 class 文件，需要先加载至方法区中，方能在 Java 虚拟机中运行</strong>。</p><p>为了提高运行效率，标准 JDK 中的 HotSpot 虚拟机采用的是一种<strong>混合执行</strong>的策略。</p><p><strong>它会解释执行 Java 字节码，然后会将其中反复执行的热点代码，以方法为单位进行即时编译，翻译成机器码后直接运行在底层硬件之上。</strong></p><p>HotSpot 装载了<strong>多个不同的即时编译器，以便在编译时间和生成代码的执行效率之间做取舍。</strong></p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-b1c9efdea7f6466c46935fd744172c01>2 - CH02-基本类型</h1><p>Java 引进了八个基本类型，来支持数值计算。Java 这么做的原因主要是工程上的考虑，因为<strong>使用基本类型能够在执行效率以及内存使用两方面提升软件性能</strong>。</p><h2 id=boolean>boolean</h2><p>在 <strong>Java 语言规范中</strong>，boolean 类型的值只有两种可能，它们分别用符号**“true”和“false”**来表示。显然，这两个符号是不能被虚拟机直接使用的。</p><p>在 <strong>Java 虚拟机规范中，boolean 类型则被映射成 int 类型</strong>。具体来说，“true”被映射为整数 1，而“false”被映射为整数 0。这个编码规则约束了 Java 字节码的具体实现。</p><p>举个例子，对于存储 boolean 数组的字节码，Java 虚拟机需保证实际存入的值是整数 1 或者 0。</p><p>Java 虚拟机规范同时也要求 Java 编译器遵守这个编码规则，<strong>并且用整数相关的字节码来实现逻辑运算，以及基于 boolean 类型的条件跳转</strong>。这样一来，在编译而成的 class 文件中，除了字段和传入参数外，基本看不出 boolean 类型的痕迹了。</p><p>对于 Java 虚拟机来说，它看到的 boolean 类型，早已被映射为整数类型。因此，将原本声明为 boolean 类型的局部变量，通过字节码修改工具赋值为除了 0、1 之外的整数值，在 Java 虚拟机看来是“合法”的。</p><h2 id=基本类型>基本类型</h2><p>除了上面提到的 boolean 类型外，Java 的基本类型还包括整数类型 byte、short、char、int 和 long，以及浮点类型 float 和 double。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220222223014.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220222223014></div><p>Java 的基本类型都有对应的值域和默认值。可以看到，byte、short、int、long、float 以及 double 的<strong>值域依次扩大</strong>，而且前面的值域被后面的值域所包含。因此，<strong>从前面的基本类型转换至后面的基本类型，无需强制转换</strong>。另外一点值得注意的是，<strong>尽管他们的默认值看起来不一样，但在内存中都是 0</strong>。</p><p>在这些基本类型中，<strong>boolean 和 char 是唯二的无符号类型</strong>。在不考虑违反规范的情况下，boolean 类型的取值范围是 0 或者 1。char 类型的取值范围则是 [0, 65535]。通常我们可以认定 char 类型的值为非负数。这种特性十分有用，比如说作为数组索引等。</p><p>在前面的例子中，我们能够将整数 2 存储到一个声明为 boolean 类型的局部变量中。那么，声明为 byte、char 以及 short 的局部变量，是否也能够存储超出它们取值范围的数值呢？</p><p>答案是可以的。而且，这些超出取值范围的数值同样会带来一些麻烦。比如说，声明为 char 类型的局部变量实际上有可能为负数。当然，在正常使用 Java 编译器的情况下，<strong>生成的字节码会遵守 Java 虚拟机规范对编译器的约束，因此你无须过分担心局部变量会超出它们的取值范围。</strong></p><p><strong>Java 的浮点类型采用 IEEE 754 浮点数格式。以 float 为例，浮点类型通常有两个 0，+0.0F 以及 -0.0F。</strong></p><p>前者在 Java 里是 0，后者是符号位为 1、其他位均为 0 的浮点数，在内存中等同于十六进制整数 0x8000000（即 -0.0F 可通过 Float.intBitsToFloat(0x8000000) 求得）。尽管它们的内存数值不同，但是在 Java 中 +0.0F == -0.0F 会返回真。</p><p>在有了 +0.0F 和 -0.0F 这两个定义后，我们便可以定义浮点数中的正无穷及负无穷。正无穷就是任意正浮点数（不包括 +0.0F）除以 +0.0F 得到的值，而负无穷是任意正浮点数除以 -0.0F 得到的值。<strong>在 Java 中，正无穷和负无穷是有确切的值，在内存中分别等同于十六进制整数 0x7F800000 和 0xFF800000。</strong></p><p>你也许会好奇，既然整数 0x7F800000 等同于正无穷，那么 0x7F800001 又对应什么浮点数呢？</p><p>这个数字对应的浮点数是 NaN（Not-a-Number）。</p><p>不仅如此，[0x7F800001, 0x7FFFFFFF] 和 [0xFF800001, 0xFFFFFFFF] 对应的都是 NaN。当然，一般我们计算得出的 NaN，比如说通过 +0.0F/+0.0F，在内存中应为 0x7FC00000。这个数值，我们称之为标准的 NaN，而其他的我们称之为不标准的 NaN。</p><p><strong>NaN 有一个有趣的特性：除了“!=”始终返回 true 之外，所有其他比较结果都会返回 false。</strong></p><p>举例来说，“NaN&lt;1.0F”返回 false，而“NaN>=1.0F”同样返回 false。对于任意浮点数 f，不管它是 0 还是 NaN，“f!=NaN”始终会返回 true，而“f==NaN”始终会返回 false。</p><p>因此，我们在程序里做浮点数比较的时候，需要考虑上述特性。在本专栏的第二部分，我会介绍这个特性给向量化比较带来什么麻烦。</p><h2 id=基本类型的大小>基本类型的大小</h2><p>在第一篇中我曾经提到，Java 虚拟机每调用一个 Java 方法，便会创建一个栈帧。为了方便理解，<strong>这里我只讨论供解释器使用的解释栈帧（interpreted frame）</strong>。</p><p>这种栈帧有两个主要的组成部分，分别是<strong>局部变量区，以及字节码的操作数栈</strong>。这里的局部变量是广义的，除了普遍意义下的局部变量之外，它<strong>还包含实例方法的“this 指针”以及方法所接收的参数</strong>。</p><p>在 Java 虚拟机规范中，<strong>局部变量区等价于一个数组，并且可以用正整数来索引</strong>。<strong>除了 long、double 值需要用两个数组单元来存储之外，其他基本类型以及引用类型的值均占用一个数组单元。</strong></p><p>也就是说，<strong>boolean、byte、char、short 这四种类型，在栈上占用的空间和 int 是一样的，和引用类型也是一样的。因此，在 32 位的 HotSpot 中，这些类型在栈上将占用 4 个字节；而在 64 位的 HotSpot 中，他们将占 8 个字节。</strong></p><p>当然，<strong>这种情况仅存在于局部变量，而并不会出现在存储于堆中的字段或者数组元素上</strong>。<strong>对于 byte、char 以及 short 这三种类型的字段或者数组单元，它们在堆上占用的空间分别为一字节、两字节，以及两字节，也就是说，跟这些类型的值域相吻合。</strong></p><p>因此，当我们将一个 int 类型的值，存储到这些类型的字段或数组时，相当于做了一次隐式的掩码操作。举例来说，当我们把 0xFFFFFFFF（-1）存储到一个声明为 char 类型的字段里时，由于该字段仅占两字节，所以高两位的字节便会被截取掉，最终存入“\uFFFF”。</p><p>boolean 字段和 boolean 数组则比较特殊。在 HotSpot 中，boolean 字段占用一字节，而 boolean 数组则直接用 byte 数组来实现。为了保证堆中的 boolean 值是合法的，HotSpot 在存储时显式地进行掩码操作，也就是说，只取最后一位的值存入 boolean 字段或数组中。</p><p>讲完了存储，现在我来讲讲加载。<strong>Java 虚拟机的算数运算几乎全部依赖于操作数栈</strong>。也就是说，<strong>我们需要将堆中的 boolean、byte、char 以及 short 加载到操作数栈上，而后将栈上的值当成 int 类型来运算。</strong></p><p>对于 boolean、char 这两个无符号类型来说，加载伴随着<strong>零扩展</strong>。举个例子，char 的大小为两个字节。在加载时 char 的值会被复制到 int 类型的低二字节，而高二字节则会用 0 来填充。</p><p>对于 byte、short 这两个类型来说，加载伴随着<strong>符号扩展</strong>。举个例子，short 的大小为两个字节。在加载时 short 的值同样会被复制到 int 类型的低二字节。如果该 short 值为非负数，即最高位为 0，那么该 int 类型的值的高二字节会用 0 来填充，否则用 1 来填充。</p><h2 id=总结与实践>总结与实践</h2><p>其中，boolean 类型在 Java 虚拟机中被映射为整数类型：“true”被映射为 1，而“false”被映射为 0。Java 代码中的逻辑运算以及条件跳转，都是用整数相关的字节码来实现的。</p><p>除 boolean 类型之外，Java 还有另外 7 个基本类型。它们拥有不同的值域，但默认值在内存中均为 0。这些基本类型之中，浮点类型比较特殊。基于它的运算或比较，需要考虑 +0.0F、-0.0F 以及 NaN 的情况。</p><p><strong>除 long 和 double 外，其他基本类型与引用类型在解释执行的方法栈帧中占用的大小是一致的，但它们在堆中占用的大小确不同。在将 boolean、byte、char 以及 short 的值存入字段或者数组单元时，Java 虚拟机会进行掩码操作。在读取时，Java 虚拟机则会将其扩展为 int 类型。</strong></p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-7437e6365d10a130934c8e53d72b90e2>3 - CH03-类加载</h1><p>我们知道 Java 语言的类型可以分为两大类：基本类型（primitive types）和引用类型（reference types）。在上一篇中，我已经详细介绍过了 Java 的基本类型，它们是由 Java 虚拟机预先定义好的。</p><p>至于另一大类<strong>引用类型</strong>，Java 将其细分为四种：<strong>类、接口、数组类和泛型参数</strong>。由于泛型参数会在编译过程中被擦除（我会在专栏的第二部分详细介绍），因此 Java 虚拟机实际上只有前三种。在类、接口和数组类中，<strong>数组类是由 Java 虚拟机直接生成的，其他两种则有对应的字节流。</strong></p><p>说到<strong>字节流</strong>，最常见的形式要属由 <strong>Java 编译器生成的 class 文件</strong>。除此之外，我们也可以在程序内部直接生成，或者从网络中获取（例如网页中内嵌的小程序 Java applet）字节流。这些不同形式的字节流，都会被加载到 Java 虚拟机中，成为类或接口。为了叙述方便，下面我就用“类”来统称它们。</p><p>无论是直接生成的数组类，还是加载的类，Java 虚拟机都需要对其进行链接和初始化。接下来，我会详细给你介绍一下每个步骤具体都在干些什么。</p><h2 id=加载>加载</h2><p><strong>加载，是指查找字节流，并且据此创建类的过程</strong>。前面提到，对于数组类来说，它并没有对应的字节流，而是由 Java 虚拟机直接生成的。对于其他的类来说，<strong>Java 虚拟机则需要借助类加载器来完成查找字节流的过程</strong>。</p><p>以盖房子为例，村里的 Tony 要盖个房子，那么按照流程他得先找个建筑师，跟他说想要设计一个房型，比如说“一房、一厅、四卫”。你或许已经听出来了，这里的房型相当于类，而建筑师，就相当于类加载器。</p><p>村里有许多建筑师，他们等级森严，但有着共同的祖师爷，叫启动类加载器（boot class loader）。<strong>启动类加载器是由 C++ 实现的，没有对应的 Java 对象，因此在 Java 中只能用 null 来指代</strong>。换句话说，祖师爷不喜欢像 Tony 这样的小角色来打扰他，所以谁也没有祖师爷的联系方式。</p><p>除了启动类加载器之外，<strong>其他的类加载器都是 java.lang.ClassLoader 的子类，因此有对应的 Java 对象</strong>。这些类加载器需要先由另一个类加载器，比如说启动类加载器，加载至 Java 虚拟机中，方能执行类加载。</p><p>村里的建筑师有一个潜规则，就是接到单子自己不能着手干，得先给师傅过过目。师傅不接手的情况下，才能自己来。在 Java 虚拟机中，这个潜规则有个特别的名字，叫<strong>双亲委派模型</strong>。<strong>每当一个类加载器接收到加载请求时，它会先将请求转发给父类加载器。在父类加载器没有找到所请求的类的情况下，该类加载器才会尝试去加载。</strong></p><p><strong>在 Java 9 之前，启动类加载器负责加载最为基础、最为重要的类，比如存放在 JRE 的 lib 目录下 jar 包中的类</strong>（以及由虚拟机参数 -Xbootclasspath 指定的类）。除了启动类加载器之外，另外两个重要的类加载器是<strong>扩展类加载器</strong>（extension class loader）和<strong>应用类加载器</strong>（application class loader），均由 Java 核心类库提供。</p><p><strong>扩展类加载器的父类加载器是启动类加载器。它负责加载相对次要、但又通用的类，比如存放在 JRE 的 lib/ext 目录下 jar 包中的类（以及由系统变量 java.ext.dirs 指定的类）。</strong></p><p><strong>应用类加载器的父类加载器则是扩展类加载器。它负责加载应用程序路径下的类</strong>。（这里的应用程序路径，便是指虚拟机参数 -cp/-classpath、系统变量 java.class.path 或环境变量 CLASSPATH 所指定的路径。）默认情况下，应用程序中包含的类便是由应用类加载器加载的。</p><p><strong>Java 9 引入了模块系统</strong>，并且略微更改了上述的类加载器<a href=https://docs.oracle.com/javase/9/migrate/toc.htm#JSMIG-GUID-A868D0B9-026F-4D46-B979-901834343F9E>1</a>。扩展类加载器被改名为<strong>平台类加载器</strong>（platform class loader）。Java SE 中除了少数几个关键模块，比如说 java.base 是由启动类加载器加载之外，其他的模块均由平台类加载器所加载。</p><p>除了由 Java 核心类库提供的类加载器外，我们还可以加入自定义的类加载器，来实现特殊的加载方式。举例来说，我们可以对 class 文件进行加密，加载时再利用自定义的类加载器对其解密。</p><p>除了加载功能之外，类加载器还提供了命名空间的作用。这个很好理解，打个比方，咱们这个村不讲究版权，如果你剽窃了另一个建筑师的设计作品，那么只要你标上自己的名字，这两个房型就是不同的。</p><p>在 Java 虚拟机中，<strong>类的唯一性是由类加载器实例以及类的全名一同确定的</strong>。即便是同一串字节流，经由不同的类加载器加载，也会得到两个不同的类。在大型应用中，我们往往借助这一特性，来运行同一个类的不同版本。</p><h2 id=链接>链接</h2><p><strong>链接，是指将创建成的类合并至 Java 虚拟机中，使之能够执行的过程</strong>。它可分为<strong>验证、准备以及解析</strong>三个阶段。</p><p><strong>验证阶段</strong>的目的，在于<strong>确保被加载类能够满足 Java 虚拟机的约束条件</strong>。这就好比 Tony 需要将设计好的房型提交给市政部门审核。只有当审核通过，才能继续下面的建造工作。</p><p>通常而言，Java 编译器生成的类文件必然满足 Java 虚拟机的约束条件。因此，这部分我留到讲解字节码注入时再详细介绍。</p><p><strong>准备阶段</strong>的目的，则是<strong>为被加载类的静态字段分配内存</strong>。Java 代码中对静态字段的具体初始化，则会在稍后的初始化阶段中进行。过了这个阶段，咱们算是盖好了毛坯房。虽然结构已经完整，但是在没有装修之前是不能住人的。</p><p>除了分配内存外，部分 Java 虚拟机还会在此阶段<strong>构造其他跟类层次相关的数据结构，比如说用来实现虚方法的动态绑定的方法表</strong>。</p><p><strong>在 class 文件被加载至 Java 虚拟机之前，这个类无法知道其他类及其方法、字段所对应的具体地址，甚至不知道自己方法、字段的地址。因此，每当需要引用这些成员时，Java 编译器会生成一个符号引用。在运行阶段，这个符号引用一般都能够无歧义地定位到具体目标上。</strong></p><p>举例来说，<strong>对于一个方法调用，编译器会生成一个包含目标方法所在类的名字、目标方法的名字、接收参数类型以及返回值类型的符号引用，来指代所要调用的方法</strong>。</p><p><strong>解析阶段</strong>的目的，正是<strong>将这些符号引用解析成为实际引用</strong>。<strong>如果符号引用指向一个未被加载的类，或者未被加载类的字段或方法，那么解析将触发这个类的加载</strong>（但未必触发这个类的链接以及初始化。）</p><p>如果将这段话放在盖房子的语境下，那么符号引用就好比“Tony 的房子”这种说法，不管它存在不存在，我们都可以用这种说法来指代 Tony 的房子。实际引用则好比实际的通讯地址，如果我们想要与 Tony 通信，则需要启动盖房子的过程。</p><p><strong>Java 虚拟机规范并没有要求在链接过程中完成解析。它仅规定了：如果某些字节码使用了符号引用，那么在执行这些字节码之前，需要完成对这些符号引用的解析。</strong></p><h2 id=初始化>初始化</h2><p>在 Java 代码中，如果要初始化一个静态字段，我们可以在声明时直接赋值，也可以在静态代码块中对其赋值。</p><p><strong>如果直接赋值的静态字段被 final 所修饰，并且它的类型是基本类型或字符串时，那么该字段便会被 Java 编译器标记成常量值（ConstantValue），其初始化直接由 Java 虚拟机完成</strong>。<strong>除此之外的直接赋值操作，以及所有静态代码块中的代码，则会被 Java 编译器置于同一方法中，并把它命名为 &lt; clinit ></strong>。</p><p>类加载的最后一步是初始化，便是<strong>为标记为常量值的字段赋值，以及执行 &lt; clinit > 方法的过程</strong>。Java 虚拟机会<strong>通过加锁来确保类的 &lt; clinit > 方法仅被执行一次</strong>。</p><p><strong>只有当初始化完成之后，类才正式成为可执行的状态</strong>。这放在我们盖房子的例子中就是，只有当房子装修过后，Tony 才能真正地住进去。</p><p>那么，类的初始化何时会被触发呢？JVM 规范枚举了下述多种触发情况：</p><ol>
<li>当<strong>虚拟机启动时</strong>，初始化用户指定的主类；</li><li>当<strong>遇到用以新建目标类实例的 new 指令时</strong>，初始化 new 指令的目标类；</li><li>当遇到<strong>调用静态方法的指令时</strong>，初始化该静态方法所在的类；</li><li>当遇到<strong>访问静态字段的指令时</strong>，初始化该静态字段所在的类；</li><li><strong>子类的初始化会触发父类的初始化</strong>；</li><li>如果一个接口定义了 <strong>default 方法</strong>，那么<strong>直接实现或者间接实现该接口的类的初始化，会触发该接口的初始化</strong>；</li><li><strong>使用反射 API 对某个类进行反射调用时</strong>，初始化这个类；</li><li>当<strong>初次调用 MethodHandle 实例时，初始化该 MethodHandle 指向的方法所在的类</strong>。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Singleton</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Singleton</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LazyHolder</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Singleton</span> <span style=color:#000>INSTANCE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Singleton</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Singleton</span> <span style=color:#000>getInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>LazyHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INSTANCE</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>我在文章中贴了一段代码，这段代码是在著名的单例延迟初始化例子中<a href=https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom>2</a>，只有当调用 Singleton.getInstance 时，程序才会访问 LazyHolder.INSTANCE，才会触发对 LazyHolder 的初始化（对应第 4 种情况），继而新建一个 Singleton 的实例。</p><p>由于类初始化是线程安全的，并且仅被执行一次，因此程序可以确保多线程环境下有且仅有一个 Singleton 实例。</p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 Java 虚拟机将字节流转化为 Java 类的过程。这个过程可分为<strong>加载、链接以及初始化</strong>三大步骤。</p><p><strong>加载是指查找字节流，并且据此创建类</strong>的过程。加载需要借助类加载器，在 Java 虚拟机中，类加载器使用了<strong>双亲委派模型，即接收到加载请求时，会先将请求转发给父类加载器</strong>。</p><p>链接，是指将创建成的类合并至 Java 虚拟机中，使之能够执行的过程。<strong>链接还分验证、准备和解析三个阶段</strong>。其中，解析阶段为非必须的。</p><p><strong>初始化，则是为标记为常量值的字段赋值，以及执行 &lt; clinit > 方法的过程</strong>。类的初始化仅会被执行一次，这个特性被用来实现单例的延迟初始化。</p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-df06c3266af88cb5c7fa593b0b2d4543>4 - CH04-方法调用-上</h1><p>下面是一个可变长参数的方法重载问题：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>    <span style=color:#8f5902;font-style:italic>// 调用第二个 invoke 方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 调用第二个 invoke 方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>});</span> <span style=color:#8f5902;font-style:italic>// 只有手动绕开可变长参数的语法糖，
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                               <span style=color:#8f5902;font-style:italic>// 才能调用第一个 invoke 方法
</span></span></span></code></pre></div><h2 id=重载与重写>重载与重写</h2><p>在 Java 程序里，如果同一个类中出现多个名字相同，并且参数类型相同的方法，那么它无法通过编译。也就是说，在正常情况下，如果我们想要在<strong>同一个类中定义名字相同的方法，那么它们的参数类型必须不同</strong>。这些方法之间的关系，我们称之为<strong>重载</strong>。</p><blockquote>
<p>小知识：这个限制可以通过字节码工具绕开。也就是说，在编译完成之后，我们可以再向 class 文件中添加方法名和参数类型相同，而返回类型不同的方法。</p><p>当这种包括多个方法名相同、参数类型相同，而返回类型不同的方法的类，出现在 Java 编译器的用户类路径上时，它是怎么确定需要调用哪个方法的呢？</p><p>当前版本的 Java 编译器会直接选取第一个方法名以及参数类型匹配的方法。并且，它会根据所选取方法的返回类型来决定可不可以通过编译，以及需不需要进行值转换等。</p></blockquote><p><strong>重载的方法在编译过程中即可完成识别</strong>。具体到每一个方法调用，<strong>Java 编译器会根据所传入参数的声明类型（注意与实际类型区分）来选取重载方法</strong>。选取的过程共分为三个阶段：</p><ol>
<li>在<strong>不考虑对基本类型自动装拆箱</strong>（auto-boxing，auto-unboxing），<strong>以及可变长参数</strong>的情况下选取重载方法；</li><li>如果在第 1 个阶段中没有找到适配的方法，那么在<strong>允许自动装拆箱，但不允许可变长参数</strong>的情况下选取重载方法；</li><li>如果在第 2 个阶段中没有找到适配的方法，那么在<strong>允许自动装拆箱以及可变长参数</strong>的情况下选取重载方法。</li></ol><p>简化后就是：</p><ul>
<li><strong>原始类型+定长参数</strong></li><li><strong>装箱类型+定长参数</strong></li><li><strong>装箱类型+变长参数</strong></li></ul><p>如果 Java 编译器在同一个阶段中找到了多个适配的方法，那么它会在其中选择一个最为贴切的，而决定贴切程度的一个关键就是<strong>形式参数类型的继承关系</strong>。</p><blockquote>
<p>在开头的例子中，<strong>当传入 null 时，它既可以匹配第一个方法中声明为 Object 的形式参数，也可以匹配第二个方法中声明为 String 的形式参数。由于 String 是 Object 的子类，因此 Java 编译器会认为第二个方法更为贴切</strong>。</p></blockquote><p>除了同一个类中的方法，重载也可以作用于这个类所<strong>继承</strong>而来的方法。也就是说，<strong>如果子类定义了与父类中非私有方法同名的方法，而且这两个方法的参数类型不同，那么在子类中，这两个方法同样构成了重载</strong>。</p><p>那么，如果<strong>子类定义了与父类中非私有方法同名的方法，而且这两个方法的参数类型相同</strong>，那么这两个方法之间又是什么关系呢？</p><p>如果这两个方法都是<strong>静态</strong>的，那么<strong>子类中的方法隐藏了父类中的方法</strong>。如果这两个方法<strong>都不是静态的，且都不是私有的，那么子类的方法重写了父类中的方法</strong>。</p><p>众所周知，Java 是一门面向对象的编程语言，它的一个重要特性便是<strong>多态</strong>。而方法<strong>重写，正是多态最重要的一种体现方式：它允许子类在继承父类部分功能的同时，拥有自己独特的行为</strong>。</p><p>打个比方，如果你经常漫游，那么你可能知道，拨打 10086 会根据你当前所在地，连接到当地的客服。重写调用也是如此：它会根据调用者的动态类型，来选取实际的目标方法。</p><h2 id=静态绑定和动态绑定>静态绑定和动态绑定</h2><p>接下来，我们来看看 Java 虚拟机是怎么识别方法的。</p><p>Java 虚拟机识别方法的关键在于<strong>类名、方法名以及方法描述符</strong>（method descriptor）。前面两个就不做过多的解释了。至于方法描述符，它是由<strong>方法的参数类型以及返回类型</strong>所构成。在同一个类中，如果同时出现多个名字相同且描述符也相同的方法，那么 Java 虚拟机会在类的验证阶段报错。</p><p>可以看到，<strong>Java 虚拟机与 Java 语言不同，它并不限制名字与参数类型相同，但返回类型不同的方法出现在同一个类中，对于调用这些方法的字节码来说，由于字节码所附带的方法描述符包含了返回类型，因此 Java 虚拟机能够准确地识别目标方法。</strong></p><p><strong>Java 虚拟机中关于方法重写的判定同样基于方法描述符</strong>。也就是说，如果子类定义了与父类中非私有、非静态方法同名的方法，那么只有当这两个方法的参数类型以及返回类型一致，Java 虚拟机才会判定为重写。</p><p>对于 Java 语言中重写而 Java 虚拟机中非重写的情况，编译器会通过<strong>生成桥接方法 [2] 来实现 Java 中的重写语义</strong>。</p><p>由于<strong>对重载方法的区分在编译阶段已经完成</strong>，我们可以认为 Java 虚拟机不存在重载这一概念。因此，在某些文章中，<strong>重载也被称为静态绑定</strong>（static binding），或者<strong>编译时多态</strong>（compile-time polymorphism）；而<strong>重写则被称为动态绑定</strong>（dynamic binding）。</p><p>这个说法在 Java 虚拟机语境下并非完全正确。这是因为某个类中的重载方法可能被它的子类所重写，因此 <strong>Java 编译器会将所有对非私有实例方法的调用编译为需要动态绑定的类型</strong>。</p><p>确切地说，Java 虚拟机中的<strong>静态绑定指的是在解析时便能够直接识别目标方法的情况，而动态绑定则指的是需要在运行过程中根据调用者的动态类型来识别目标方法的情况</strong>。</p><p>具体来说，Java 字节码中与调用相关的指令共有五种。</p><ol>
<li><strong>invokestatic</strong>：用于调用静态方法。</li><li><strong>invokespecial</strong>：用于调用私有实例方法、构造器，以及使用 super 关键字调用父类的实例方法或构造器，和所实现接口的默认方法。</li><li><strong>invokevirtual</strong>：用于调用非私有实例方法。</li><li><strong>invokeinterface</strong>：用于调用接口方法。</li><li><strong>invokedynamic</strong>：用于调用动态方法。</li></ol><p>由于 invokedynamic 指令较为复杂，我将在后面的篇章中单独介绍。这里我们只讨论前四种。</p><p>我在文章中贴了一段代码，展示了编译生成这四种调用指令的情况。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>interface 客户 {
</span></span><span style=display:flex><span>  boolean isVIP();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>class 商户 {
</span></span><span style=display:flex><span>  public double 折后价格 (double 原价, 客户 某客户) {
</span></span><span style=display:flex><span>    return 原价 * 0.8d;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>class 奸商 extends 商户 {
</span></span><span style=display:flex><span>  @Override
</span></span><span style=display:flex><span>  public double 折后价格 (double 原价, 客户 某客户) {
</span></span><span style=display:flex><span>    if (某客户.isVIP()) {                         // invokeinterface      
</span></span><span style=display:flex><span>      return 原价 * 价格歧视 ();                    // invokestatic
</span></span><span style=display:flex><span>    } else {
</span></span><span style=display:flex><span>      return super. 折后价格 (原价, 某客户);          // invokespecial
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  public static double 价格歧视 () {
</span></span><span style=display:flex><span>    // 咱们的杀熟算法太粗暴了，应该将客户城市作为随机数生成器的种子。
</span></span><span style=display:flex><span>    return new Random()                          // invokespecial
</span></span><span style=display:flex><span>           .nextDouble()                         // invokevirtual
</span></span><span style=display:flex><span>           + 0.8d;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在代码中，“商户”类定义了一个成员方法，叫做“折后价格”，它将接收一个 double 类型的参数，以及一个“客户”类型的参数。这里“客户”是一个接口，它定义了一个接口方法，叫“isVIP”。</p><p>我们还定义了另一个叫做“奸商”的类，它继承了“商户”类，并且重写了“折后价格”这个方法。如果客户是 VIP，那么它会被给到一个更低的折扣。</p><p>在这个方法中，我们首先会调用“客户”接口的”isVIP“方法。该调用会被编译为 invokeinterface 指令。</p><p>如果客户是 VIP，那么我们会调用奸商类的一个名叫“价格歧视”的静态方法。该调用会被编译为 invokestatic 指令。如果客户不是 VIP，那么我们会通过 super 关键字调用父类的“折后价格”方法。该调用会被编译为 invokespecial 指令。</p><p>在静态方法“价格歧视”中，我们会调用 Random 类的构造器。该调用会被编译为 invokespecial 指令。然后我们会以这个新建的 Random 对象为调用者，调用 Random 类中的 nextDouble 方法。该调用会被编译为 invokevirutal 指令。</p><p><strong>对于 invokestatic 以及 invokespecial 而言，Java 虚拟机能够直接识别具体的目标方法。</strong></p><p><strong>而对于 invokevirtual 以及 invokeinterface 而言，在绝大部分情况下，虚拟机需要在执行过程中，根据调用者的动态类型，来确定具体的目标方法。</strong></p><p>唯一的例外在于，<strong>如果虚拟机能够确定目标方法有且仅有一个，比如说目标方法被标记为 final[3][4]，那么它可以不通过动态类型，直接确定目标方法。</strong></p><h2 id=调用指令的符号引用>调用指令的符号引用</h2><p><strong>在编译过程中，我们并不知道目标方法的具体内存地址</strong>。因此，<strong>Java 编译器会暂时用符号引用来表示该目标方法。这一符号引用包括目标方法所在的类或接口的名字，以及目标方法的方法名和方法描述符</strong>。</p><p><strong>符号引用存储在 class 文件的常量池之中</strong>。根据目标方法是否为接口方法，这些引用可分为<strong>接口符号引用</strong>和<strong>非接口符号引用</strong>。我在文章中贴了一个例子，<strong>利用“javap -v”打印某个类的常量池</strong>，如果你感兴趣的话可以到文章中查看。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// 在奸商.class 的常量池中，#16 为接口符号引用，指向接口方法 &#34; 客户.isVIP()&#34;。而 #22 为非接口符号引用，指向静态方法 &#34; 奸商. 价格歧视 ()&#34;。
</span></span><span style=display:flex><span>$ javap -v 奸商.class ...
</span></span><span style=display:flex><span>Constant pool:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  #16 = InterfaceMethodref #27.#29        // 客户.isVIP:()Z
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  #22 = Methodref          #1.#33         // 奸商. 价格歧视:()D
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>上一篇中我曾提到过，<strong>在执行使用了符号引用的字节码前，Java 虚拟机需要解析这些符号引用，并替换为实际引用</strong>。</p><p>对于<strong>非接口符号引用</strong>，假定<strong>该符号引用所指向的类为 C</strong>，则 Java 虚拟机会按照如下步骤进行查找。</p><ol>
<li><strong>在 C 中查找符合名字及描述符的方法</strong>。</li><li><strong>如果没有找到，在 C 的父类中继续搜索，直至 Object 类</strong>。</li><li>如果没有找到，<strong>在 C 所直接实现或间接实现的接口中搜索</strong>，这一步搜索得到的目标方法必须是<strong>非私有、非静态</strong>的。并且，如果目标方法在间接实现的接口中，则需满足 C 与该接口之间没有其他符合条件的目标方法。<strong>如果有多个符合条件的目标方法，则任意返回其中一个</strong>。</li></ol><p>从这个解析算法可以看出，<strong>静态方法也可以通过子类来调用。此外，子类的静态方法会隐藏（注意与重写区分）父类中的同名、同描述符的静态方法。</strong></p><p>对于<strong>接口符号引用</strong>，假定该<strong>符号引用所指向的接口为 I</strong>，则 Java 虚拟机会按照如下步骤进行查找。</p><ol>
<li><strong>在 I 中查找符合名字及描述符的方法</strong>。</li><li><strong>如果没有找到，在 Object 类中的公有实例方法中搜索</strong>。</li><li><strong>如果没有找到，则在 I 的超接口中搜索</strong>。这一步的搜索结果的要求与非接口符号引用步骤 3 的要求一致。</li></ol><p>经过上述的解析步骤之后，符号引用会被解析成实际引用。对于可以<strong>静态绑定</strong>的方法调用而言，<strong>实际引用是一个指向方法的指针</strong>。对于需要<strong>动态绑定</strong>的方法调用而言，<strong>实际引用则是一个方法表的索引</strong>。具体什么是方法表，我会在下一篇中做出解答。</p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 Java 以及 Java 虚拟机是如何识别目标方法的。</p><p>在 Java 中，方法存在<strong>重载</strong>以及<strong>重写</strong>的概念，重载指的是方法名相同而参数类型不相同的方法之间的关系，重写指的是方法名相同并且参数类型也相同的方法之间的关系。</p><p>Java 虚拟机<strong>识别方法</strong>的方式略有不同，除了<strong>方法名</strong>和参数类型之外，它还会考虑<strong>返回类型</strong>。</p><p>在 Java 虚拟机中，<strong>静态绑定指的是在解析时便能够直接识别目标方法的情况，而动态绑定则指的是需要在运行过程中根据调用者的动态类型来识别目标方法的情况。由于 Java 编译器已经区分了重载的方法，因此可以认为 Java 虚拟机中不存在重载。</strong></p><p>在 class 文件中，<strong>Java 编译器会用符号引用指代目标方法</strong>。在执行调用指令前，它所附带的<strong>符号引用需要被解析成实际引用</strong>。对于可以<strong>静态绑定的方法调用而言，实际引用为目标方法的指针</strong>。对于需要<strong>动态绑定的方法调用而言，实际引用为辅助动态绑定的信息</strong>。</p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-6f77ddc54011b6a8b54ff7d3045b7cb5>5 - CH05-方法调用-下</h1><h2 id=虚方法调用>虚方法调用</h2><p>在上一篇中我曾经提到，Java 里所有非私有实例方法调用都会被编译成 <strong>invokevirtual</strong> 指令，而接口方法调用都会被编译成 <strong>invokeinterface</strong> 指令。这两种指令，均属于 Java 虚拟机中的<strong>虚方法调用</strong>。</p><p>在绝大多数情况下，Java 虚拟机需要<strong>根据调用者的动态类型，来确定虚方法调用的目标方法</strong>。这个过程我们称之为动态绑定。那么，相对于静态绑定的非虚方法调用来说，<strong>虚方法调用更加耗时</strong>。</p><p>在 Java 虚拟机中，<strong>静态绑定</strong>包括用于调用静态方法的 <strong>invokestatic</strong> 指令，和用于调用构造器、私有实例方法以及超类非私有实例方法的 <strong>invokespecial</strong> 指令。如果虚方法调用指向一个<strong>标记为 final 的方法</strong>，那么 Java 虚拟机<strong>也可以静态绑定该虚方法调用的目标方法</strong>。</p><p>Java 虚拟机中采取了一种<strong>用空间换取时间的策略来实现动态绑定</strong>。<strong>它为每个类生成一张方法表，用以快速定位目标方法</strong>。那么方法表具体是怎样实现的呢？</p><h2 id=方法表>方法表</h2><p>在介绍那篇类加载机制的<strong>链接</strong>部分中，我曾提到<strong>类加载的准备阶段</strong>，它除了<strong>为静态字段分配内存</strong>之外，还会<strong>构造与该类相关联的方法表</strong>。</p><p>这个数据结构，便是 Java 虚拟机实现动态绑定的关键所在。下面我将以 **invokevirtual 所使用的虚方法表（virtual method table，vtable）**为例介绍方法表的用法。**invokeinterface 所使用的接口方法表（interface method table，itable）**稍微复杂些，但是原理其实是类似的。</p><p><strong>方法表本质上是一个数组，每个数组元素指向一个当前类及其祖先类中非私有的实例方法。</strong></p><p>这些方法可能是具体的、可执行的方法，也可能是没有相应字节码的抽象方法。<strong>方法表满足两个特质：其一，子类方法表中包含父类方法表中的所有方法；其二，子类方法在方法表中的索引值，与它所重写的父类方法的索引值相同。</strong></p><p>我们知道，<strong>方法调用指令中的符号引用会在执行之前解析成实际引用。对于静态绑定的方法调用而言，实际引用将指向具体的目标方法。对于动态绑定的方法调用而言，实际引用则是方法表的索引值（实际上并不仅是索引值）</strong>。</p><p><strong>在执行过程中，Java 虚拟机将获取调用者的实际类型，并在该实际类型的虚方法表中，根据索引值获得目标方法。这个过程便是动态绑定。</strong></p><p>一个模拟出国边检的小例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>乘客</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>出境</span> <span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>外国人</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>乘客</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>出境</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>/* 进外国人通道 */</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>中国人</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>乘客</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>出境</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>/* 进中国人通道 */</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>买买买</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>/* 逛免税店 */</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>乘客</span> <span style=color:#000>某乘客</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>某乘客</span><span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#000>出境</span> <span style=color:#ce5c00;font-weight:700>();</span>
</span></span></code></pre></div><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220223223933.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220223223933></div><p>在我们的例子中，“乘客”类的方法表包括两个方法：“toString”以及“出境”，分别对应 0 号和 1 号。</p><p>之所以方法表调换了“toString”方法和“出境”方法的位置，是因为“toString”方法的索引值需要与 Object 类中同名方法的索引值一致。为了保持简洁，这里我就不考虑 Object 类中的其他方法。</p><p>“外国人”的方法表同样有两行。其中，0 号方法指向继承而来的“乘客”类的“toString”方法。1 号方法则指向自己重写的“出境”方法。</p><p>“中国人”的方法表则包括三个方法，除了继承而来的“乘客”类的“toString“方法，自己重写的“出境”方法之外，还包括独有的“买买买”方法。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>乘客 某乘客 = ...
</span></span><span style=display:flex><span>某乘客. 出境 ();
</span></span></code></pre></div><p>这里，Java 虚拟机的工作可以想象为导航员。每当来了一个乘客需要出境，导航员会先问是中国人还是外国人（获取动态类型），然后翻出中国人 / 外国人对应的小册子（获取动态类型的方法表），小册子的第 1 页便写着应该到哪条通道办理出境手续（用 1 作为索引来查找方法表所对应的目标方法）。</p><p>实际上，**使用了方法表的动态绑定与静态绑定相比，仅仅多出几个内存解引用操作：访问栈上的调用者，读取调用者的动态类型，读取该类型的方法表，读取方法表中某个索引值所对应的目标方法。**相对于创建并初始化 Java 栈帧来说，这几个内存解引用操作的开销简直可以忽略不计。</p><p>那么我们是否可以认为虚方法调用对性能没有太大影响呢？</p><p>其实是不能的，上述优化的效果看上去十分美好，但实际上仅存在于解释执行中，或者即时编译代码的最坏情况中。这是因为<strong>即时编译还拥有另外两种性能更好的优化手段：内联缓存（inlining cache）和方法内联（method inlining）</strong>。下面我便来介绍第一种内联缓存。</p><h2 id=内联缓存>内联缓存</h2><p>内联缓存是一种<strong>加快动态绑定</strong>的优化技术。它能够<strong>缓存虚方法调用中调用者的动态类型，以及该类型所对应的目标方法</strong>。<strong>在之后的执行过程中，如果碰到已缓存的类型，内联缓存便会直接调用该类型所对应的目标方法。如果没有碰到已缓存的类型，内联缓存则会退化至使用基于方法表的动态绑定。</strong></p><p>在我们的例子中，这相当于导航员记住了上一个出境乘客的国籍和对应的通道，例如中国人，走了左边通道出境。那么下一个乘客想要出境的时候，导航员会先问是不是中国人，是的话就走左边通道。如果不是的话，只好拿出外国人的小册子，翻到第 1 页，再告知查询结果：右边。</p><p><strong>在针对多态的优化手段中，我们通常会提及以下三个术语。</strong></p><ol>
<li><strong>单态</strong>（monomorphic）指的是仅有一种状态的情况。</li><li><strong>多态</strong>（polymorphic）指的是有限数量种状态的情况。二态（bimorphic）是多态的其中一种。</li><li><strong>超多态</strong>（megamorphic）指的是更多种状态的情况。通常我们用一个具体数值来区分多态和超多态。在这个数值之下，我们称之为多态。否则，我们称之为超多态。</li></ol><p>对于内联缓存来说，我们也有对应的<strong>单态内联缓存、多态内联缓存和超多态内联缓存</strong>。单态内联缓存，顾名思义，便是只缓存了一种动态类型以及它所对应的目标方法。它的实现非常简单：比较所缓存的动态类型，如果命中，则直接调用对应的目标方法。</p><p>多态内联缓存则缓存了多个动态类型及其目标方法。它需要逐个将所缓存的动态类型与当前动态类型进行比较，如果命中，则调用对应的目标方法。</p><p>一般来说，我们<strong>会将更加热门的动态类型放在前面</strong>。在实践中，大部分的虚方法调用均是单态的，也就是只有一种动态类型。<strong>为了节省内存空间，Java 虚拟机只采用单态内联缓存</strong>。</p><p>前面提到，当内联缓存没有命中的情况下，Java 虚拟机需要重新使用方法表进行动态绑定。对于内联缓存中的内容，我们有两种选择。一是<strong>替换单态内联缓存中的纪录</strong>。这种做法就好比 CPU 中的数据缓存，它对数据的局部性有要求，即在替换内联缓存之后的一段时间内，方法调用的调用者的动态类型应当保持一致，从而能够有效地利用内联缓存。</p><p>因此，在最坏情况下，我们用两种不同类型的调用者，轮流执行该方法调用，那么每次进行方法调用都将替换内联缓存。也就是说，只有写缓存的额外开销，而没有用缓存的性能提升。</p><p>另外一种选择则是<strong>劣化为超多态状态</strong>。这也是 Java 虚拟机的具体实现方式。处于这种状态下的内联缓存，实际上放弃了优化的机会。它将直接访问方法表，来动态绑定目标方法。与替换内联缓存纪录的做法相比，它牺牲了优化的机会，但是节省了写缓存的额外开销。</p><p>具体到我们的例子，如果来了一队乘客，其中外国人和中国人依次隔开，那么在重复使用的单态内联缓存中，导航员需要反复记住上个出境的乘客，而且记住的信息在处理下一乘客时又会被替换掉。因此，倒不如一直不记，以此来节省脑细胞。</p><p><strong>虽然内联缓存附带内联二字，但是它并没有内联目标方法</strong>。这里需要明确的是，<strong>任何方法调用除非被内联，否则都会有固定开销</strong>。<strong>这些开销来源于保存程序在该方法中的执行位置，以及新建、压入和弹出新方法所使用的栈帧</strong>。</p><p>对于极其简单的方法而言，比如说 getter/setter，这部分固定开销占据的 CPU 时间甚至超过了方法本身。此外，在即时编译中，方法内联不仅仅能够消除方法调用的固定开销，而且还增加了进一步优化的可能性，我们会在专栏的第二部分详细介绍方法内联的内容。</p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了虚方法调用在 Java 虚拟机中的实现方式。</p><p><strong>虚方法调用包括 invokevirtual 指令和 invokeinterface 指令。如果这两种指令所声明的目标方法被标记为 final，那么 Java 虚拟机会采用静态绑定。否则，Java 虚拟机将采用动态绑定，在运行过程中根据调用者的动态类型，来决定具体的目标方法。</strong></p><p><strong>Java 虚拟机的动态绑定是通过方法表这一数据结构来实现的。方法表中每一个重写方法的索引值，与父类方法表中被重写的方法的索引值一致。在解析虚方法调用时，Java 虚拟机会纪录下所声明的目标方法的索引值，并且在运行过程中根据这个索引值查找具体的目标方法。</strong></p><p><strong>Java 虚拟机中的即时编译器会使用内联缓存来加速动态绑定。Java 虚拟机所采用的单态内联缓存将纪录调用者的动态类型，以及它所对应的目标方法。</strong></p><p>当碰到新的调用者时，如果其动态类型与缓存中的类型匹配，则直接调用缓存的目标方法。否则，Java 虚拟机将该内联缓存劣化为超多态内联缓存，在今后的执行过程中直接使用方法表进行动态绑定。</p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-7a7e79b881d0ead21c480bf426bde765>6 - CH06-异常处理</h1><p>异常处理的两大组成要素是<strong>抛出异常</strong>和<strong>捕获异常</strong>。这两大要素共同实现程序控制流的非正常转移。</p><p>抛出异常可分为显式和隐式两种。<strong>显式抛异常的主体是应用程序，它指的是在程序中使用“throw”关键字，手动将异常实例抛出。</strong></p><p><strong>隐式抛异常的主体则是 Java 虚拟机，它指的是 Java 虚拟机在执行过程中，碰到无法继续执行的异常状态，自动抛出异常</strong>。举例来说，Java 虚拟机在执行读取数组操作时，发现输入的索引值是负数，故而抛出数组索引越界异常（ArrayIndexOutOfBoundsException）。</p><p>捕获异常则涉及了如下三种代码块。</p><ol>
<li><strong>try 代码块</strong>：用来标记需要进行异常监控的代码。</li><li><strong>catch 代码块</strong>：跟在 try 代码块之后，用来捕获在 try 代码块中触发的某种指定类型的异常。除了声明所捕获异常的类型之外，catch 代码块还定义了针对该异常类型的异常处理器。在 Java 中，try 代码块后面可以跟着多个 catch 代码块，来捕获不同类型的异常。Java 虚拟机会从上至下匹配异常处理器。因此，前面的 catch 代码块所捕获的异常类型不能覆盖后边的，否则编译器会报错。</li><li><strong>finally 代码块</strong>：跟在 try 代码块和 catch 代码块之后，用来声明一段必定运行的代码。它的设计初衷是为了避免跳过某些关键的清理代码，例如关闭已打开的系统资源。</li></ol><p>在程序正常执行的情况下，这段代码会在 try 代码块之后运行。否则，也就是 try 代码块触发异常的情况下，如果该异常没有被捕获，finally 代码块会直接运行，并且在运行之后重新抛出该异常。</p><p>如果该异常被 catch 代码块捕获，finally 代码块则在 catch 代码块之后运行。在某些不幸的情况下，catch 代码块也触发了异常，那么 finally 代码块同样会运行，并会抛出 catch 代码块触发的异常。在某些极端不幸的情况下，finally 代码块也触发了异常，那么只好中断当前 finally 代码块的执行，并往外抛异常。</p><p>上面这段听起来有点绕，但是等我讲完 Java 虚拟机的异常处理机制之后，你便会明白这其中的道理。</p><h2 id=异常的基本概念>异常的基本概念</h2><p>在 Java 语言规范中，所有异常都是 Throwable 类或者其子类的实例。Throwable 有两大直接子类。第一个是 Error，涵盖程序不应捕获的异常。当程序触发 Error 时，它的执行状态已经无法恢复，需要中止线程甚至是中止虚拟机。第二子类则是 Exception，涵盖程序可能需要捕获并且处理的异常。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220223231306.png style=display:block;margin-left:auto;margin-right:auto;width:40% alt=20220223231306></div><p>Exception 有一个特殊的子类 <strong>RuntimeException，用来表示“程序虽然无法继续执行，但是还能抢救一下”的情况</strong>。前边提到的数组索引越界便是其中的一种。</p><p><strong>RuntimeException 和 Error 属于 Java 里的非检查异常（unchecked exception）。其他异常则属于检查异常（checked exception）</strong>。在 Java 语法中，<strong>所有的检查异常都需要程序显式地捕获，或者在方法声明中用 throws 关键字标注</strong>。通常情况下，程序中自定义的异常应为检查异常，以便最大化利用 Java 编译器的编译时检查。</p><p><strong>异常实例的构造十分昂贵。这是由于在构造异常实例时，Java 虚拟机便需要生成该异常的栈轨迹（stack trace）。该操作会逐一访问当前线程的 Java 栈帧，并且记录下各种调试信息，包括栈帧所指向方法的名字，方法所在的类名、文件名，以及在代码中的第几行触发该异常</strong>。</p><p>当然，在生成栈轨迹时，Java 虚拟机会忽略掉异常构造器以及填充栈帧的 Java 方法（Throwable.fillInStackTrace），直接从新建异常位置开始算起。此外，Java 虚拟机还会忽略标记为不可见的 Java 方法栈帧。我们在介绍 Lambda 的时候会看到具体的例子。</p><p>既然异常实例的构造十分昂贵，我们是否可以缓存异常实例，在需要用到的时候直接抛出呢？从语法角度上来看，这是允许的。然而，该异常对应的栈轨迹并非 throw 语句的位置，而是新建异常的位置。</p><p>因此，这种做法可能会误导开发人员，使其定位到错误的位置。这也是为什么在实践中，我们往往选择抛出新建异常实例的原因。</p><h2 id=java-虚拟机是如何捕获异常的>Java 虚拟机是如何捕获异常的？</h2><p><strong>在编译生成的字节码中，每个方法都附带一个异常表。异常表中的每一个条目代表一个异常处理器，并且由 from 指针、to 指针、target 指针以及所捕获的异常类型构成。这些指针的值是字节码索引（bytecode index，bci），用以定位字节码。</strong></p><p>其中，<strong>from 指针和 to 指针标示了该异常处理器所监控的范围</strong>，例如 try 代码块所覆盖的范围。<strong>target 指针则指向异常处理器的起始位置</strong>，例如 catch 代码块的起始位置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mayThrowException</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 对应的 Java 字节码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>String</span><span style=color:#ce5c00;font-weight:700>[]);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span> <span style=color:#000>mayThrowException</span><span style=color:#ce5c00;font-weight:700>:()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>    <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>goto</span> <span style=color:#000>11</span>
</span></span><span style=display:flex><span>    <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span>
</span></span><span style=display:flex><span>   <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Exception</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>from</span>  <span style=color:#000>to</span> <span style=color:#000>target</span> <span style=color:#000>type</span>
</span></span><span style=display:flex><span>      <span style=color:#000>0</span>   <span style=color:#000>3</span>   <span style=color:#000>6</span>  <span style=color:#000>Class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span>  <span style=color:#8f5902;font-style:italic>// 异常表条目
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> 
</span></span></code></pre></div><p>举个例子，在上图的 main 方法中，我定义了一段 try-catch 代码。其中，catch 代码块所捕获的异常类型为 Exception。</p><p>编译过后，该方法的异常表拥有一个条目。其 from 指针和 to 指针分别为 0 和 3，代表它的监控范围从索引为 0 的字节码开始，到索引为 3 的字节码结束（不包括 3）。该条目的 target 指针是 6，代表这个异常处理器从索引为 6 的字节码开始。条目的最后一列，代表该异常处理器所捕获的异常类型正是 Exception。</p><p><strong>当程序触发异常时，Java 虚拟机会从上至下遍历异常表中的所有条目。当触发异常的字节码的索引值在某个异常表条目的监控范围内，Java 虚拟机会判断所抛出的异常和该条目想要捕获的异常是否匹配。如果匹配，Java 虚拟机会将控制流转移至该条目 target 指针指向的字节码。</strong></p><p><strong>如果遍历完所有异常表条目，Java 虚拟机仍未匹配到异常处理器，那么它会弹出当前方法对应的 Java 栈帧，并且在调用者（caller）中重复上述操作。在最坏情况下，Java 虚拟机需要遍历当前线程 Java 栈上所有方法的异常表。</strong></p><p>finally 代码块的编译比较复杂。当前版本 Java 编译器的做法，是<strong>复制 finally 代码块的内容，分别放在 try-catch 代码块所有正常执行路径以及异常执行路径的出口中。</strong></p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220223231629.png style=display:block;margin-left:auto;margin-right:auto;width:80% alt=20220223231629></div><p>针对异常执行路径，Java 编译器会生成一个或多个异常表条目，监控整个 try-catch 代码块，并且捕获所有种类的异常（在 javap 中以 any 指代）。这些异常表条目的 target 指针将指向另一份复制的 finally 代码块。并且，在这个 finally 代码块的最后，Java 编译器会重新抛出所捕获的异常。</p><p>如果你感兴趣的话，可以用 javap 工具来查看下面这段包含了 try-catch-finally 代码块的编译结果。为了更好地区分每个代码块，我定义了四个实例字段：tryBlock、catchBlock、finallyBlock、以及 methodExit，并且仅在对应的代码块中访问这些字段。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>catchBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>finallyBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>methodExit</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>tryBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>catchBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>finallyBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>methodExit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>$</span> <span style=color:#000>javap</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>c</span> <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_0</span>
</span></span><span style=display:flex><span>       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>20</span>                 <span style=color:#8f5902;font-style:italic>// Field tryBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>goto</span>          <span style=color:#000>30</span>
</span></span><span style=display:flex><span>       <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_1</span>
</span></span><span style=display:flex><span>       <span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>22</span>                 <span style=color:#8f5902;font-style:italic>// Field catchBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>15</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>24</span>                 <span style=color:#8f5902;font-style:italic>// Field finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>goto</span>          <span style=color:#000>35</span>
</span></span><span style=display:flex><span>      <span style=color:#000>22</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>23</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>24</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>25</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>24</span>                 <span style=color:#8f5902;font-style:italic>// Field finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>28</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>29</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>athrow</span>
</span></span><span style=display:flex><span>      <span style=color:#000>30</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>31</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>32</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>24</span>                 <span style=color:#8f5902;font-style:italic>// Field finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>35</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>36</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_3</span>
</span></span><span style=display:flex><span>      <span style=color:#000>37</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>26</span>                 <span style=color:#8f5902;font-style:italic>// Field methodExit:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>40</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Exception</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>from</span>    <span style=color:#000>to</span>  <span style=color:#000>target</span> <span style=color:#000>type</span>
</span></span><span style=display:flex><span>           <span style=color:#000>0</span>     <span style=color:#000>5</span>     <span style=color:#000>8</span>   <span style=color:#000>Class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span>
</span></span><span style=display:flex><span>           <span style=color:#000>0</span>    <span style=color:#000>14</span>    <span style=color:#000>22</span>   <span style=color:#000>any</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>...</span>
</span></span></code></pre></div><p>可以看到，编译结果包含三份 finally 代码块。其中，前两份分别位于 try 代码块和 catch 代码块的正常执行路径出口。最后一份则作为异常处理器，监控 try 代码块以及 catch 代码块。它将捕获 try 代码块触发的、未被 catch 代码块捕获的异常，以及 catch 代码块触发的异常。</p><p>这里有一个小问题，如果 catch 代码块捕获了异常，并且触发了另一个异常，那么 finally 捕获并且重抛的异常是哪个呢？答案是后者。也就是说原本的异常便会被忽略掉，这对于代码调试来说十分不利。</p><h2 id=java-7-的-supressed-异常以及语法糖>Java 7 的 Supressed 异常以及语法糖</h2><p>Java 7 引入了 Supressed 异常来解决这个问题。这个新特性允许开发人员将一个异常附于另一个异常之上。因此，抛出的异常可以附带多个异常的信息。</p><p>然而，Java 层面的 finally 代码块缺少指向所捕获异常的引用，所以这个新特性使用起来非常繁琐。</p><p>为此，Java 7 专门构造了一个名为 try-with-resources 的语法糖，在字节码层面自动使用 Supressed 异常。当然，该语法糖的主要目的并不是使用 Supressed 异常，而是精简资源打开关闭的用法。</p><p>在 Java 7 之前，对于打开的资源，我们需要定义一个 finally 代码块，来确保该资源在正常或者异常执行状况下都能关闭。</p><p>资源的关闭操作本身容易触发异常。因此，如果同时打开多个资源，那么每一个资源都要对应一个独立的 try-finally 代码块，以保证每个资源都能够关闭。这样一来，代码将会变得十分繁琐。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#000>FileInputStream</span> <span style=color:#000>in0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>FileInputStream</span> <span style=color:#000>in1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>FileInputStream</span> <span style=color:#000>in2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>in0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;in0.txt&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>in1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;in1.txt&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>in2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;in2.txt&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in2</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>in2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in1</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>in1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in0</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>in0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>Java 7 的 try-with-resources 语法糖，极大地简化了上述代码。程序可以在 try 关键字后声明并实例化实现了 AutoCloseable 接口的类，编译器将自动添加对应的 close() 操作。在声明多个 AutoCloseable 实例的情况下，编译生成的字节码类似于上面手工编写代码的编译结果。与手工代码相比，try-with-resources 还会使用 Supressed 异常的功能，来避免原异常“被消失”。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>AutoCloseable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span> <span style=color:#000>foo0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Foo0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// try-with-resources
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>Foo</span> <span style=color:#000>foo1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Foo1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Foo</span> <span style=color:#000>foo2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Foo2&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Initial&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 运行结果：
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Exception</span> <span style=color:#000>in</span> <span style=color:#000>thread</span> <span style=color:#4e9a06>&#34;main&#34;</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Initial</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>18</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Suppressed</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Foo2</span>
</span></span><span style=display:flex><span>                <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Suppressed</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Foo1</span>
</span></span><span style=display:flex><span>                <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Suppressed</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Foo0</span>
</span></span><span style=display:flex><span>                <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>除了 try-with-resources 语法糖之外，Java 7 还支持在同一 catch 代码块中捕获多种异常。实际实现非常简单，生成多个异常表条目即可。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 在同一 catch 代码块中捕获多种异常
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SomeException</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>OtherException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 Java 虚拟机的异常处理机制。</p><p>Java 的异常分为 Exception 和 Error 两种，而 Exception 又分为 RuntimeException 和其他类型。RuntimeException 和 Error 属于非检查异常。其他的 Exception 皆属于检查异常，在触发时需要显式捕获，或者在方法头用 throws 关键字声明。</p><p>Java 字节码中，每个方法对应一个异常表。当程序触发异常时，Java 虚拟机将查找异常表，并依此决定需要将控制流转移至哪个异常处理器之中。Java 代码中的 catch 代码块和 finally 代码块都会生成异常表条目。</p><p>Java 7 引入了 Supressed 异常、try-with-resources，以及多异常捕获。后两者属于语法糖，能够极大地精简我们的代码。</p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-663901ec4075a7ebc81009718147915e>7 - CH07-实现反射</h1><p>反射在 Java 中的应用十分广泛。开发人员日常接触到的 Java 集成开发环境（IDE）便运用了这一功能：每当我们敲入点号时，IDE 便会根据点号前的内容，动态展示可以访问的字段或者方法。</p><p>另一个日常应用则是 Java 调试器，它能够在调试过程中枚举某一对象所有字段的值。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220223232807.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220223232807></div><p>在 Web 开发中，我们经常能够接触到各种可配置的通用框架。为了保证框架的可扩展性，它们往往借助 Java 的反射机制，根据配置文件来加载不同的类。举例来说，Spring 框架的依赖反转（IoC），便是依赖于反射机制。</p><p>然而，我相信不少开发人员都嫌弃反射机制比较慢。甚至是甲骨文关于反射的教学网页 [1]，也强调了反射性能开销大的缺点。</p><h2 id=反射调用的实现>反射调用的实现</h2><p>首先，我们来看看方法的反射调用，也就是 Method.invoke，是怎么实现的。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Method</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Executable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#8f5902;font-style:italic>// 权限检查
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MethodAccessor</span> <span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodAccessor</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>acquireMethodAccessor</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ma</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>如果你查阅 <strong>Method.invoke</strong> 的源代码，那么你会发现，它实际上委派给 <strong>MethodAccessor</strong> 来处理。MethodAccessor 是一个接口，它有两个已有的<strong>具体实现：一个通过本地方法来实现反射调用，另一个则使用了委派模式</strong>。为了方便记忆，我便用“本地实现”和“委派实现”来指代这两者。</p><p><strong>每个 Method 实例的第一次反射调用都会生成一个委派实现，它所委派的具体实现便是一个本地实现。本地实现非常容易理解。当进入了 Java 虚拟机内部之后，我们便拥有了 Method 实例所指向方法的具体地址。这时候，反射调用无非就是将传入的参数准备好，然后调用进入目标方法。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// v0 版本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.reflect.Method</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>klass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Test&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>klass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;target&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a40000>#</span> <span style=color:#000>不同版本的输出略有不同</span><span style=color:#a40000>，</span><span style=color:#000>这里我使用了</span> <span style=color:#000>Java</span> <span style=color:#000>10</span><span style=color:#a40000>。</span>
</span></span><span style=display:flex><span><span style=color:#000>$</span> <span style=color:#000>java</span> <span style=color:#000>Test</span>
</span></span><span style=display:flex><span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exception</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Native</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span> <span style=color:#000>a</span>      <span style=color:#000>t</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>62</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span> <span style=color:#000>t</span>       <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>i</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>43</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>564</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>t</span>        <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>131</span>
</span></span></code></pre></div><p>为了方便理解，我们可以打印一下反射调用到目标方法时的栈轨迹。在上面的 v0 版本代码中，我们获取了一个指向 Test.target 方法的 Method 对象，并且用它来进行反射调用。在 Test.target 中，我会打印出栈轨迹。</p><p>可以看到，<strong>反射调用先是调用了 Method.invoke，然后进入委派实现（DelegatingMethodAccessorImpl），再然后进入本地实现（NativeMethodAccessorImpl），最后到达目标方法。</strong></p><p>这里你可能会疑问，为什么反射调用还要采取委派实现作为中间层？直接交给本地实现不可以么？</p><p>其实，<strong>Java 的反射调用机制还设立了另一种动态生成字节码的实现（下称动态实现），直接使用 invoke 指令来调用目标方法。之所以采用委派实现，便是为了能够在本地实现以及动态实现中切换。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 动态实现的伪代码，这里只列举了关键的调用逻辑，其实它还包括调用者检测、参数检测的字节码。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>jdk.internal.reflect</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>GeneratedMethodAccessor1</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Overrides</span>    
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>target</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>动态实现和本地实现相比，其运行效率要快上 20 倍 [2] 。这是因为动态实现无需经过 Java 到 C++ 再到 Java 的切换，但由于生成字节码十分耗时，仅调用一次的话，反而是本地实现要快上 3 到 4 倍 [3]。</strong></p><p><strong>考虑到许多反射调用仅会执行一次，Java 虚拟机设置了一个阈值 15（可以通过 -Dsun.reflect.inflationThreshold= 来调整），当某个反射调用的调用次数在 15 之下时，采用本地实现；当达到 15 时，便开始动态生成字节码，并将委派实现的委派对象切换至动态实现，这个过程我们称之为 Inflation。</strong></p><p>为了观察这个过程，我将刚才的例子更改为下面的 v1 版本。它会将反射调用循环 20 次。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// v1 版本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.reflect.Method</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>klass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Test&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>klass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;target&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a40000>#</span> <span style=color:#000>使用</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>verbose</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>打印加载的类</span>
</span></span><span style=display:flex><span><span style=color:#000>$</span> <span style=color:#000>java</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>verbose</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exception</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>14</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Native</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>62</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DelegatingMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>43</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>564</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>158s</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>160s</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GeneratedMethodAccessor1</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>__JVM_DefineClass__</span>
</span></span><span style=display:flex><span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exception</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>15</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Native</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NativeMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>62</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DelegatingMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>43</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>564</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exception</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>16</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GeneratedMethodAccessor1</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Unknown</span> <span style=color:#000>Source</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>jdk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DelegatingMethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>43</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>564</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>at</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span></code></pre></div><p>可以看到，在第 15 次（从 0 开始数）反射调用时，我们便触发了动态实现的生成。这时候，Java 虚拟机额外加载了不少类。其中，最重要的当属 GeneratedMethodAccessor1（第 30 行）。并且，从第 16 次反射调用开始，我们便切换至这个刚刚生成的动态实现（第 40 行）。</p><p><strong>反射调用的 Inflation 机制是可以通过参数（-Dsun.reflect.noInflation=true）来关闭的。这样一来，在反射调用一开始便会直接生成动态实现，而不会使用委派实现或者本地实现。</strong></p><h2 id=反射调用的开销>反射调用的开销</h2><p>下面，我们便来拆解反射调用的性能开销。</p><p>在刚才的例子中，我们先后进行了 Class.forName，Class.getMethod 以及 Method.invoke 三个操作。其中，**Class.forName 会调用本地方法，Class.getMethod 则会遍历该类的公有方法。如果没有匹配到，它还将遍历父类的公有方法。**可想而知，这两个操作都非常费时。</p><p>值得注意的是，<strong>以 getMethod 为代表的查找方法操作，会返回查找得到结果的一份拷贝。因此，我们应当避免在热点代码中使用返回 Method 数组的 getMethods 或者 getDeclaredMethods 方法，以减少不必要的堆空间消耗。</strong></p><p>在实践中，我们往往会<strong>在应用程序中缓存 Class.forName 和 Class.getMethod 的结果。因此，下面我就只关注反射调用本身的性能开销。</strong></p><p>为了比较直接调用和反射调用的性能差距，我将前面的例子改为下面的 v2 版本。它会将反射调用循环二十亿次。此外，它还将记录下每跑一亿次的时间。</p><p>我将取最后五个记录的平均值，作为预热后的峰值性能。（注：这种性能评估方式并不严谨，我会在专栏的第三部分介绍如何用 JMH 来测性能。）</p><p>在我这个老笔记本上，一亿次直接调用耗费的时间大约在 120ms。这和不调用的时间是一致的。其<strong>原因在于这段代码属于热循环，同样会触发即时编译。并且，即时编译会将对 Test.target 的调用内联进来，从而消除了调用的开销。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// v2 版本
</span></span><span style=display:flex><span>mport java.lang.reflect.Method;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>public class Test {
</span></span><span style=display:flex><span>  public static void target(int i) {
</span></span><span style=display:flex><span>    // 空方法
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  public static void main(String[] args) throws Exception {
</span></span><span style=display:flex><span>    Class&lt;?&gt; klass = Class.forName(&#34;Test&#34;);
</span></span><span style=display:flex><span>    Method method = klass.getMethod(&#34;target&#34;, int.class);
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    long current = System.currentTimeMillis();
</span></span><span style=display:flex><span>    for (int i = 1; i &lt;= 2_000_000_000; i++) {
</span></span><span style=display:flex><span>      if (i % 100_000_000 == 0) {
</span></span><span style=display:flex><span>        long temp = System.currentTimeMillis();
</span></span><span style=display:flex><span>        System.out.println(temp - current);
</span></span><span style=display:flex><span>        current = temp;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>      method.invoke(null, 128);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>下面我将以 120ms 作为基准，来比较反射调用的性能开销。</p><p>由于目标方法 Test.target 接收一个 int 类型的参数，因此我传入 128 作为反射调用的参数，测得的结果约为基准的 2.7 倍。我们暂且不管这个数字是高是低，先来看看在反射调用之前字节码都做了什么。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#000>59</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>                         <span style=color:#8f5902;font-style:italic>// 加载 Method 对象
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>60</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aconst_null</span>                     <span style=color:#8f5902;font-style:italic>// 反射调用的第一个参数 null
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>61</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_1</span>
</span></span><span style=display:flex><span>   <span style=color:#000>62</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>anewarray</span> <span style=color:#000>Object</span>                <span style=color:#8f5902;font-style:italic>// 生成一个长度为 1 的 Object 数组
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>65</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dup</span>
</span></span><span style=display:flex><span>   <span style=color:#000>66</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_0</span>
</span></span><span style=display:flex><span>   <span style=color:#000>67</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sipush</span> <span style=color:#000>128</span>
</span></span><span style=display:flex><span>   <span style=color:#000>70</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span>    <span style=color:#8f5902;font-style:italic>// 将 128 自动装箱成 Integer
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>73</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aastore</span>                         <span style=color:#8f5902;font-style:italic>// 存入 Object 数组中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>74</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span>     <span style=color:#8f5902;font-style:italic>// 反射调用
</span></span></span></code></pre></div><p>这里我截取了循环中反射调用编译而成的字节码。可以看到，这段字节码除了反射调用外，还额外做了两个操作。</p><p><strong>第一，由于 Method.invoke 是一个变长参数方法，在字节码层面它的最后一个参数会是 Object 数组（感兴趣的同学私下可以用 javap 查看）。Java 编译器会在方法调用处生成一个长度为传入参数数量的 Object 数组，并将传入参数一一存储进该数组中。</strong></p><p><strong>第二，由于 Object 数组不能存储基本类型，Java 编译器会对传入的基本类型参数进行自动装箱。</strong></p><p>这两个操作除了带来性能开销外，还可能占用堆内存，使得 GC 更加频繁。（如果你感兴趣的话，可以用虚拟机参数 -XX:+PrintGC 试试。）那么，如何消除这部分开销呢？</p><p>关于第二个自动装箱，Java 缓存了 [-128, 127] 中所有整数所对应的 Integer 对象。当需要自动装箱的整数在这个范围之内时，便返回缓存的 Integer，否则需要新建一个 Integer 对象。</p><p>因此，我们可以将这个缓存的范围扩大至覆盖 128（对应参数
-Djava.lang.Integer.IntegerCache.high=128），便可以避免需要新建 Integer 对象的场景。</p><p>或者，我们可以在循环外缓存 128 自动装箱得到的 Integer 对象，并且直接传入反射调用中。这两种方法测得的结果差不多，约为基准的 1.8 倍。</p><p>现在我们再回来看看第一个因变长参数而自动生成的 Object 数组。既然每个反射调用对应的参数个数是固定的，那么我们可以选择在循环外新建一个 Object 数组，设置好参数，并直接交给反射调用。改好的代码可以参照文稿中的 v3 版本。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// v3 版本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.reflect.Method</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 空方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>klass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Test&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>klass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;target&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span> <span style=color:#8f5902;font-style:italic>// 在循环外构造参数数组
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>2_000_000_000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>100_000_000</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>      <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>测得的结果反而更糟糕了，为基准的 2.9 倍。这是为什么呢？</p><p>如果你在上一步解决了自动装箱之后查看运行时的 GC 状况，你会发现这段程序并不会触发 GC。其原因在于，<strong>原本的反射调用被内联了，从而使得即时编译器中的逃逸分析将原本新建的 Object 数组判定为不逃逸的对象。</strong></p><p><strong>如果一个对象不逃逸，那么即时编译器可以选择栈分配甚至是虚拟分配，也就是不占用堆空间</strong>。具体我会在本专栏的第二部分详细解释。</p><p><strong>如果在循环外新建数组，即时编译器无法确定这个数组会不会中途被更改，因此无法优化掉访问数组的操作，可谓是得不偿失。</strong></p><p>到目前为止，我们的最好记录是 1.8 倍。那能不能再进一步提升呢？</p><p>刚才我曾提到，<strong>可以关闭反射调用的 Inflation 机制，从而取消委派实现，并且直接使用动态实现</strong>。此外，<strong>每次反射调用都会检查目标方法的权限，而这个检查同样可以在 Java 代码里关闭</strong>，在关闭了这两项机制之后，也就得到了我们的 v4 版本，它测得的结果约为基准的 1.3 倍。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// v4 版本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.reflect.Method</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 在运行指令中添加如下两个虚拟机参数：
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// -Djava.lang.Integer.IntegerCache.high=128
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// -Dsun.reflect.noInflation=true
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 空方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>klass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Test&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>klass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;target&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// 关闭权限检查
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>2_000_000_000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>100_000_000</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>      <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>到这里，我们基本上把反射调用的水分都榨干了。接下来，我来把反射调用的性能开销给提回去。</p><p>首先，在这个例子中，之所以反射调用能够变得这么快，主要是因为即时编译器中的方法内联。在关闭了 Inflation 的情况下，内联的瓶颈在于 Method.invoke 方法中对 MethodAccessor.invoke 方法的调用。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220223232843.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220223232843></div><p>我会在后面的文章中介绍方法内联的具体实现，这里先说个结论：<strong>在生产环境中，我们往往拥有多个不同的反射调用，对应多个 GeneratedMethodAccessor，也就是动态实现。</strong></p><p><strong>由于 Java 虚拟机的关于上述调用点的类型 profile（注：对于 invokevirtual 或者 invokeinterface，Java 虚拟机会记录下调用者的具体类型，我们称之为类型 profile）无法同时记录这么多个类，因此可能造成所测试的反射调用没有被内联的情况。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// v5 版本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.reflect.Method</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 空方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>klass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Test&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>klass</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;target&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// 关闭权限检查
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>polluteProfile</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>2_000_000_000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>100_000_000</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>      <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>polluteProfile</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Method</span> <span style=color:#000>method1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;target1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Method</span> <span style=color:#000>method2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;target2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>2000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>method1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>method2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>在上面的 v5 版本中，我在测试循环之前调用了 polluteProfile 的方法。该方法将反射调用另外两个方法，并且循环上 2000 遍。</p><p>而测试循环则保持不变。测得的结果约为基准的 6.7 倍。也就是说，只要误扰了 Method.invoke 方法的类型 profile，性能开销便会从 1.3 倍上升至 6.7 倍。</p><p>之所以这么慢，除了没有内联之外，另外一个原因是逃逸分析不再起效。这时候，我们便可以采用刚才 v3 版本中的解决方案，在循环外构造参数数组，并直接传递给反射调用。这样子测得的结果约为基准的 5.2 倍。</p><p>除此之外，我们还可以提高 Java 虚拟机关于每个调用能够记录的类型数目（对应虚拟机参数 -XX:TypeProfileWidth，默认值为 2，这里设置为 3）。最终测得的结果约为基准的 2.8 倍，尽管它和原本的 1.3 倍还有一定的差距，但总算是比 6.7 倍好多了。</p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 Java 里的反射机制。</p><p>在默认情况下，方法的反射调用为委派实现，委派给本地实现来进行方法调用。在调用超过 15 次之后，委派实现便会将委派对象切换至动态实现。这个动态实现的字节码是自动生成的，它将直接使用 invoke 指令来调用目标方法。</p><p>方法的反射调用会带来不少性能开销，原因主要有三个：变长参数方法导致的 Object 数组，基本类型的自动装箱、拆箱，还有最重要的方法内联。</p><h2 id=附录反射-api-简介>附录：反射 API 简介</h2><p>通常来说，使用反射 API 的第一步便是<strong>获取 Class 对象</strong>。在 Java 中常见的有这么三种。</p><ol>
<li><strong>使用静态方法 Class.forName 来获取</strong>。</li><li><strong>调用对象的 getClass() 方法</strong>。</li><li><strong>直接用类名 +“.class”访问</strong>。对于基本类型来说，它们的包装类型（wrapper classes）拥有一个名为“TYPE”的 final 静态字段，指向该基本类型对应的 Class 对象。</li></ol><p>例如，Integer.TYPE 指向 int.class。对于数组类型来说，可以使用类名 +“[ ].class”来访问，如 int[ ].class。</p><p>除此之外，Class 类和 java.lang.reflect 包中还提供了许多返回 Class 对象的方法。例如，对于数组类的 Class 对象，调用 Class.getComponentType() 方法可以获得数组元素的类型。</p><p>一旦得到了 Class 对象，我们便可以正式地使用反射功能了。下面我列举了较为常用的几项。</p><ol>
<li><strong>使用 newInstance() 来生成一个该类的实例</strong>。它要求该类中拥有一个无参数的构造器。</li><li><strong>使用 isInstance(Object) 来判断一个对象是否该类的实例</strong>，语法上等同于 instanceof 关键字（JIT 优化时会有差别，我会在本专栏的第二部分详细介绍）。</li><li><strong>使用 Array.newInstance(Class,int) 来构造该类型的数组</strong>。</li><li><strong>使用 getFields()/getConstructors()/getMethods() 来访问该类的成员</strong>。除了这三个之外，Class 类还提供了许多其他方法，详见 [4]。需要注意的是，方法名中带 Declared 的不会返回父类的成员，但是会返回私有成员；而不带 Declared 的则相反。</li></ol><p>当获得了类成员之后，我们可以进一步做如下操作。</p><ul>
<li><strong>使用 Constructor/Field/Method.setAccessible(true) 来绕开 Java 语言的访问限制</strong>。</li><li><strong>使用 Constructor.newInstance(Object[]) 来生成该类的实例</strong>。</li><li><strong>使用 Field.get/set(Object) 来访问字段的值</strong>。</li><li><strong>使用 Method.invoke(Object, Object[]) 来调用方法</strong>。</li></ul></div><div class=td-content style=page-break-before:always>
<h1 id=pg-b61c62764420638d737c30aec2b80d43>8 - CH08-invokedynamic-上</h1><p>前不久，“虚拟机”赛马俱乐部来了个年轻人，标榜自己是动态语言，是先进分子。</p><p>这一天，先进分子牵着一头鹿进来，说要参加赛马。咱部里的老学究 Java 就不同意了呀，鹿又不是马，哪能参加赛马。</p><p>当然了，这种墨守成规的调用方式，自然是先进分子所不齿的。现在年轻人里流行的是鸭子类型（duck typing）[1]，只要是跑起来像只马的，它就是一只马，也就能够参加赛马比赛。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Horse</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>race</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Horse.race()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Deer</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>race</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Deer.race()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cobra</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>race</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;How do you turn this on?&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>(如何用同一种方式调用他们的赛跑方法？)</p><p>说到了这里，如果我们将赛跑定义为对赛跑方法（对应上述代码中的 race()）的调用的话，那么这个故事的关键，就在于能不能在马场中调用非马类型的赛跑方法。</p><p>为了解答这个问题，我们先来回顾一下 Java 里的方法调用。<strong>在 Java 中，方法调用会被编译为 invokestatic，invokespecial，invokevirtual 以及 invokeinterface 四种指令。这些指令与包含目标方法类名、方法名以及方法描述符的符号引用捆绑。在实际运行之前，Java 虚拟机将根据这个符号引用链接到具体的目标方法。</strong></p><p>可以看到，在这四种调用指令中，Java 虚拟机明确要求方法调用需要提供目标方法的类名。在这种体系下，我们有两个解决方案。一是调用其中一种类型的赛跑方法，比如说马类的赛跑方法。对于非马的类型，则给它套一层马甲，当成马来赛跑。</p><p>另外一种解决方式，是通过反射机制，来查找并且调用各个类型中的赛跑方法，以此模拟真正的赛跑。</p><p>显然，比起直接调用，这两种方法都相当复杂，执行效率也可想而知。为了解决这个问题，Java 7 引入了一条新的指令 <strong>invokedynamic</strong>。<strong>该指令的调用机制抽象出调用点这一个概念，并允许应用程序将调用点链接至任意符合条件的方法上。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>startRace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>                <span style=color:#8f5902;font-style:italic>// 加载一个任意对象
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokedynamic</span> <span style=color:#000>race</span>     <span style=color:#8f5902;font-style:italic>// 调用赛跑方法
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> 
</span></span></code></pre></div><p>(理想的调用方式)</p><p><strong>作为 invokedynamic 的准备工作，Java 7 引入了更加底层、更加灵活的方法抽象 ：方法句柄（MethodHandle）</strong>。</p><h2 id=方法句柄的概念>方法句柄的概念</h2><p><strong>方法句柄是一个强类型的，能够被直接执行的引用 [2]</strong>。该引用<strong>可以指向常规的静态方法或者实例方法，也可以指向构造器或者字段</strong>。<strong>当指向字段时，方法句柄实则指向包含字段访问字节码的虚构方法，语义上等价于目标字段的 getter 或者 setter 方法</strong>。</p><p>这里需要注意的是，<strong>它并不会直接指向目标字段所在类中的 getter/setter，毕竟你无法保证已有的 getter/setter 方法就是在访问目标字段</strong>。</p><p><strong>方法句柄的类型（MethodType）是由所指向方法的参数类型以及返回类型组成的</strong>。<strong>它是用来确认方法句柄是否适配的唯一关键。当使用方法句柄时，我们其实并不关心方法句柄所指向方法的类名或者方法名。</strong></p><p>打个比方，如果兔子的“赛跑”方法和“睡觉”方法的参数类型以及返回类型一致，那么对于兔子递过来的一个方法句柄，我们并不知道会是哪一个方法。</p><p><strong>方法句柄的创建是通过 MethodHandles.Lookup 类来完成的。它提供了多个 API，既可以使用反射 API 中的 Method 来查找，也可以根据类、方法名以及方法句柄类型来查找。</strong></p><p><strong>当使用后者这种查找方式时，用户需要区分具体的调用类型，比如说对于用 invokestatic 调用的静态方法，我们需要使用 Lookup.findStatic 方法；对于用 invokevirutal 调用的实例方法，以及用 invokeinterface 调用的接口方法，我们需要使用 findVirtual 方法；对于用 invokespecial 调用的实例方法，我们则需要使用 findSpecial 方法。</strong></p><p><strong>调用方法句柄，和原本对应的调用指令是一致的。也就是说，对于原本用 invokevirtual 调用的方法句柄，它也会采用动态绑定；而对于原本用 invkespecial 调用的方法句柄，它会采用静态绑定。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>bar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>..</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Lookup</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lookup</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 获取方法句柄的不同方式
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Lookup</span> <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lookup</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 具备 Foo 类的访问权限
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Method</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>MethodHandle</span> <span style=color:#000>mh0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unreflect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>MethodType</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MethodType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>MethodHandle</span> <span style=color:#000>mh1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p><strong>方法句柄同样也有权限问题</strong>。但它与反射 API 不同，其<strong>权限检查是在句柄的创建阶段完成的</strong>。在实际调用过程中，Java 虚拟机并不会检查方法句柄的权限。如果该句柄被多次调用的话，那么与反射调用相比，它将<strong>省下重复权限检查的开销</strong>。</p><p>需要注意的是，<strong>方法句柄的访问权限不取决于方法句柄的创建位置，而是取决于 Lookup 对象的创建位置</strong>。</p><p>举个例子，对于一个私有字段，如果 Lookup 对象是在私有字段所在类中获取的，那么这个 Lookup 对象便拥有对该私有字段的访问权限，即使是在所在类的外边，也能够通过该 Lookup 对象创建该私有字段的 getter 或者 setter。</p><p>由于方法句柄没有运行时权限检查，因此，应用程序需要负责方法句柄的管理。一旦它发布了某些指向私有方法的方法句柄，那么这些私有方法便被暴露出去了。</p><h2 id=方法句柄的操作>方法句柄的操作</h2><p>方法句柄的<strong>调用可分为两种，一是需要严格匹配参数类型的 invokeExact</strong>。它有多严格呢？假设一个方法句柄将接收一个 Object 类型的参数，如果你直接传入 String 作为实际参数，那么方法句柄的调用会在运行时抛出方法类型不匹配的异常。正确的调用方式是将该 String 显式转化为 Object 类型。</p><p>在普通 Java 方法调用中，我们只有在选择重载方法时，才会用到这种显式转化。这是因为经过显式转化后，参数的声明类型发生了改变，因此有可能匹配到不同的方法描述符，从而选取不同的目标方法。调用方法句柄也是利用同样的原理，并且涉及了一个签名多态性（signature polymorphism）的概念。（在这里我们暂且认为签名等同于方法描述符。）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#5c35cc;font-weight:700>@PolymorphicSignature</span> <span style=color:#000>Object</span> <span style=color:#000>invokeExact</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><p><strong>方法句柄 API 有一个特殊的注解类 @PolymorphicSignature。在碰到被它注解的方法调用时，Java 编译器会根据所传入参数的声明类型来生成方法描述符，而不是采用目标方法所声明的描述符。</strong></p><p>在刚才的例子中，当传入的参数是 String 时，对应的方法描述符包含 String 类；而当我们转化为 Object 时，对应的方法描述符则包含 Object 类。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodHandle</span> <span style=color:#000>mh</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeExact</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeExact</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// 对应的 Java 字节码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodHandle</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Throwable</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
</span></span><span style=display:flex><span>       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>
</span></span><span style=display:flex><span>       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#000>MethodHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeExact</span><span style=color:#ce5c00;font-weight:700>:(</span><span style=color:#000>Ljava</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>;)</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
</span></span><span style=display:flex><span>       <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>
</span></span><span style=display:flex><span>       <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#000>MethodHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeExact</span><span style=color:#ce5c00;font-weight:700>:(</span><span style=color:#000>Ljava</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>;)</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>      <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span></code></pre></div><p><strong>invokeExact 会确认该 invokevirtual 指令对应的方法描述符，和该方法句柄的类型是否严格匹配</strong>。在不匹配的情况下，便会在运行时抛出异常。</p><p><strong>如果你需要自动适配参数类型，那么你可以选取方法句柄的第二种调用方式 invoke</strong>。它同样是一个签名多态性的方法。<strong>invoke 会调用 MethodHandle.asType 方法，生成一个适配器方法句柄，对传入的参数进行适配，再调用原方法句柄。调用原方法句柄的返回值同样也会先进行适配，然后再返回给调用者。</strong></p><p><strong>方法句柄还支持增删改参数的操作，这些操作都是通过生成另一个方法句柄来实现的。这其中，改操作就是刚刚介绍的 MethodHandle.asType 方法。删操作指的是将传入的部分参数就地抛弃，再调用另一个方法句柄。它对应的 API 是 MethodHandles.dropArguments 方法。</strong></p><p><strong>增操作则非常有意思。它会往传入的参数中插入额外的参数，再调用另一个方法句柄，它对应的 API 是 MethodHandle.bindTo 方法。Java 8 中捕获类型的 Lambda 表达式便是用这种操作来实现的</strong>，下一篇我会详细进行解释。</p><p><strong>增操作还可以用来实现方法的柯里化 [3]</strong>。举个例子，有一个指向 f(x, y) 的方法句柄，我们可以通过将 x 绑定为 4，生成另一个方法句柄 g(y) = f(4, y)。在执行过程中，每当调用 g(y) 的方法句柄，它会在参数列表最前面插入一个 4，再调用指向 f(x, y) 的方法句柄。</p><h2 id=方法句柄的实现>方法句柄的实现</h2><p>下面我们来看看 HotSpot 虚拟机中方法句柄调用的具体实现。（由于篇幅原因，这里只讨论 DirectMethodHandle。）</p><p>前面提到，调用方法句柄所使用的 invokeExact 或者 invoke 方法具备签名多态性的特性。它们会根据具体的传入参数来生成方法描述符。那么，拥有这个描述符的方法实际存在吗？对 invokeExact 或者 invoke 的调用具体会进入哪个方法呢？</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.invoke.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>bar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Lookup</span> <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lookup</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MethodType</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MethodType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MethodHandle</span> <span style=color:#000>mh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeExact</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>和查阅反射调用的方式一样，我们可以通过新建异常实例来查看栈轨迹。打印出来的占轨迹如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>$</span> <span style=color:#000>java</span> <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exception</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>也就是说，invokeExact 的目标方法竟然就是方法句柄指向的方法。</p><p>先别高兴太早。我刚刚提到过，invokeExact 会对参数的类型进行校验，并在不匹配的情况下抛出异常。如果它直接调用了方法句柄所指向的方法，那么这部分参数类型校验的逻辑将无处安放。因此，唯一的可能便是 Java 虚拟机隐藏了部分栈信息。</p><p><strong>当我们启用了 -XX:+ShowHiddenFrames 这个参数来打印被 Java 虚拟机隐藏了的栈信息时，你会发现 main 方法和目标方法中间隔着两个貌似是生成的方法。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>$</span> <span style=color:#000>java</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>XX</span><span style=color:#ce5c00;font-weight:700>:+</span><span style=color:#000>UnlockDiagnosticVMOptions</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>XX</span><span style=color:#ce5c00;font-weight:700>:+</span><span style=color:#000>ShowHiddenFrames</span> <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Exception</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DirectMethodHandle$Holder</span><span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#000>invokeStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DirectMethodHandle$Holder</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1000010</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LambdaForm$MH000</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>766572210</span><span style=color:#ce5c00;font-weight:700>.</span> <span style=color:#000>invokeExact_MT000_LLL_V</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LambdaForm$MH000</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1000019</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000>at</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p><strong>实际上，Java 虚拟机会对 invokeExact 调用做特殊处理，调用至一个共享的、与方法句柄类型相关的特殊适配器中。这个适配器是一个 LambdaForm，我们可以通过添加虚拟机参数将之导出成 class 文件</strong>（-Djava.lang.invoke.MethodHandle.DUMP_CLASS_FILES=true）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LambdaForm$MH000</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeExact_MT000_LLLLV</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jeava</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jjava</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jjava</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bject</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>      <span style=color:#a40000>#</span><span style=color:#000>14</span>                 <span style=color:#8f5902;font-style:italic>//Mclass java/lang/invoke/ethodHandle
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dup</span>
</span></span><span style=display:flex><span>      <span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_0</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_32</span>        <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>      <span style=color:#a40000>#</span><span style=color:#000>16</span>                 <span style=color:#8f5902;font-style:italic>//Mclass java/lang/invoke/ethodType
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span>  <span style=color:#000>I</span><span style=color:#a40000>#</span><span style=color:#000>22</span>                 <span style=color:#8f5902;font-style:italic>// Method java/lang/invoke/nvokers.checkExactType:(MLjava/lang/invoke/ethodHandle,;Ljava/lang/invoke/ethodType);V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span>   <span style=color:#a40000>#</span><span style=color:#000>26</span>     <span style=color:#000>I</span>           <span style=color:#8f5902;font-style:italic>// Method java/lang/invoke/nvokers.checkCustomized:(MLjava/lang/invoke/ethodHandle);V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>17</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>      <span style=color:#000>18</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ainvakevirtudl</span> <span style=color:#a40000>#</span><span style=color:#000>30</span>             <span style=color:#000>2</span>   <span style=color:#8f5902;font-style:italic>// Methodijava/lang/nvokev/ethodHandle.invokeBasic:(LLeava/lang/bject;;V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>23</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>可以看到，<strong>在这个适配器中，它会调用 Invokers.checkExactType 方法来检查参数类型，然后调用 Invokers.checkCustomized 方法。后者会在方法句柄的执行次数超过一个阈值时进行优化</strong>（对应参数 -Djava.lang.invoke.MethodHandle.CUSTOMIZE_THRESHOLD，默认值为 127）。<strong>最后，它会调用方法句柄的 invokeBasic 方法。</strong></p><p><strong>Java 虚拟机同样会对 invokeBasic 调用做特殊处理，这会将调用至方法句柄本身所持有的适配器中。这个适配器同样是一个 LambdaForm</strong>，你可以通过反射机制将其打印出来。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 该方法句柄持有的 LambdaForm 实例的 toString() 结果
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>DMH</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invokeStatic_L_V</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>Lambda</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a0</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>)=&gt;{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>DirectMethodHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internalMemberName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a0</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>t3</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>MethodHandle</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>linkToStatic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>这个适配器将获取方法句柄中的 MemberName 类型的字段，并且以它为参数调用 linkToStatic 方法。估计你已经猜到了，Java 虚拟机也会对 linkToStatic 调用做特殊处理，它将根据传入的 MemberName 参数所存储的方法地址或者方法表索引，直接跳转至目标方法。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemberName</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cloneable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//@Injected JVM_Method* vmtarget;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//@Injected int         vmindex;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span></code></pre></div><p>那么前面那个适配器中的优化又是怎么回事？实际上，<strong>方法句柄一开始持有的适配器是共享的。当它被多次调用之后，Invokers.checkCustomized 方法会为该方法句柄生成一个特有的适配器。这个特有的适配器会将方法句柄作为常量，直接获取其 MemberName 类型的字段，并继续后面的 linkToStatic 调用。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LambdaForm$DMH000</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invokeStatic000_LL_V</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ldc</span>           <span style=color:#a40000>#</span><span style=color:#000>14</span>                 <span style=color:#8f5902;font-style:italic>// String CONSTANT_PLACEHOLDER_1 &lt;&lt;Foo.bar(Object)void/invokeStatic&gt;&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>     <span style=color:#a40000>#</span><span style=color:#000>16</span>                 <span style=color:#8f5902;font-style:italic>// class java/lang/invoke/MethodHandle
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_0</span>     <span style=color:#8f5902;font-style:italic>// 上面的优化代码覆盖了传入的方法句柄
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>      <span style=color:#8f5902;font-style:italic>// 从这里开始跟初始版本一致
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span>  <span style=color:#a40000>#</span><span style=color:#000>22</span>                 <span style=color:#8f5902;font-style:italic>// Method java/lang/invoke/DirectMethodHandle.internalMemberName:(Ljava/lang/Object;)Ljava/lang/Object;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>     <span style=color:#a40000>#</span><span style=color:#000>24</span>                 <span style=color:#8f5902;font-style:italic>// class java/lang/invoke/MemberName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span>  <span style=color:#a40000>#</span><span style=color:#000>28</span>                 <span style=color:#8f5902;font-style:italic>// Method java/lang/invoke/MethodHandle.linkToStatic:(Ljava/lang/Object;Ljava/lang/invoke/MemberName;)V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span></code></pre></div><p>可以看到，方法句柄的调用和反射调用一样，都是间接调用。因此，它也会面临无法内联的问题。不过，与反射调用不同的是，方法句柄的内联瓶颈在于即时编译器能否将该方法句柄识别为常量。具体内容我会在下一篇中进行详细的解释。</p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 invokedynamic 底层机制的基石：方法句柄。</p><p><strong>方法句柄是一个强类型的、能够被直接执行的引用。它仅关心所指向方法的参数类型以及返回类型，而不关心方法所在的类以及方法名。方法句柄的权限检查发生在创建过程中，相较于反射调用节省了调用时反复权限检查的开销。</strong></p><p><strong>方法句柄可以通过 invokeExact 以及 invoke 来调用。其中，invokeExact 要求传入的参数和所指向方法的描述符严格匹配。方法句柄还支持增删改参数的操作，这些操作是通过生成另一个充当适配器的方法句柄来实现的。</strong></p><p><strong>方法句柄的调用和反射调用一样，都是间接调用，同样会面临无法内联的问题。</strong></p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-80d0892bfadac8f9301a80f0d5509158>9 - CH09-invokedynamic-下</h1><p>上回讲到，为了让所有的动物都能参加赛马，Java 7 引入了 invokedynamic 机制，允许调用任意类的“赛跑”方法。不过，我们并没有讲解 invokedynamic，而是深入地探讨了它所依赖的方法句柄。</p><p>今天，我便来正式地介绍 invokedynamic 指令，讲讲它是如何生成调用点，并且允许应用程序自己决定链接至哪一个方法中的。</p><h2 id=invokedynamic-指令>invokedynamic 指令</h2><p>invokedynamic 是 Java 7 引入的一条新指令，用以支持动态语言的方法调用。具体来说，<strong>它将调用点（CallSite）抽象成一个 Java 类，并且将原本由 Java 虚拟机控制的方法调用以及方法链接暴露给了应用程序</strong>。在运行过程中，<strong>每一条 invokedynamic 指令将捆绑一个调用点，并且会调用该调用点所链接的方法句柄</strong>。</p><p><strong>在第一次执行 invokedynamic 指令时，Java 虚拟机会调用该指令所对应的启动方法（BootStrap Method），来生成前面提到的调用点，并且将之绑定至该 invokedynamic 指令中</strong>。<strong>在之后的运行过程中，Java 虚拟机则会直接调用绑定的调用点所链接的方法句柄</strong>。</p><p><strong>在字节码中，启动方法是用方法句柄来指定的</strong>。<strong>这个方法句柄指向一个返回类型为调用点的静态方法。该方法必须接收三个固定的参数，分别为一个 Lookup 类实例，一个用来指代目标方法名字的字符串，以及该调用点能够链接的方法句柄的类型。</strong></p><p>除了这三个必需参数之外，启动方法还可以接收若干个其他的参数，用来辅助生成调用点，或者定位所要链接的目标方法。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.invoke.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Horse</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>race</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Horse.race()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Deer</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>race</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Deer.race()&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// javac Circuit.java
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// java Circuit
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Circuit</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>startRace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// aload obj
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// invokedynamic race()
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>startRace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Horse</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// startRace(new Deer());
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>CallSite</span> <span style=color:#000>bootstrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Lookup</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodType</span> <span style=color:#000>callSiteType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MethodHandle</span> <span style=color:#000>mh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findVirtual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Horse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConstantCallSite</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>callSiteType</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>我在文稿中贴了一段代码，其中便包含一个启动方法。它将接收前面提到的三个固定参数，并且返回一个链接至 Horse.race 方法的 ConstantCallSite。</p><p><strong>这里的 ConstantCallSite 是一种不可以更改链接对象的调用点。除此之外，Java 核心类库还提供多种可以更改链接对象的调用点，比如 MutableCallSite 和 VolatileCallSite。</strong></p><p>这两者的区别就好比正常字段和 volatile 字段之间的区别。此外，应用程序还可以自定义调用点类，来满足特定的重链接需求。</p><p>由于 Java 暂不支持直接生成 invokedynamic 指令 [1]，所以接下来我会借助之前介绍过的字节码工具 ASM 来实现这一目的。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.invoke.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.nio.file.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.objectweb.asm.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// javac -cp /path/to/asm-all-6.0_BETA.jar:. ASMHelper.java
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// java -cp /path/to/asm-all-6.0_BETA.jar:. ASMHelper
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// java Circuit
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ASMHelper</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Opcodes</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyMethodVisitor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MethodVisitor</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>BOOTSTRAP_CLASS_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Circuit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>replace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>BOOTSTRAP_METHOD_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bootstrap&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>BOOTSTRAP_METHOD_DESC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MethodType</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CallSite</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Lookup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMethodDescriptorString</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>TARGET_METHOD_NAME</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;race&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>TARGET_METHOD_DESC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;(Ljava/lang/Object;)V&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MethodVisitor</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyMethodVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>api</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodVisitor</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>api</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>visitCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitVarInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ALOAD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Handle</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Handle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>H_INVOKESTATIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BOOTSTRAP_CLASS_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BOOTSTRAP_METHOD_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BOOTSTRAP_METHOD_DESC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitInvokeDynamicInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TARGET_METHOD_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TARGET_METHOD_DESC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RETURN</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitMaxs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitEnd</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassReader</span> <span style=color:#000>cr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Circuit&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassWriter</span> <span style=color:#000>cw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassWriter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>COMPUTE_FRAMES</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassVisitor</span> <span style=color:#000>cv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ASM6</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cw</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MethodVisitor</span> <span style=color:#000>visitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>access</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>signature</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>          <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>exceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>MethodVisitor</span> <span style=color:#000>visitor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>access</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>signature</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptions</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;startRace&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyMethodVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ASM6</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>};</span>
</span></span><span style=display:flex><span>    <span style=color:#000>cr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SKIP_FRAMES</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#000>Files</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Paths</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Circuit.class&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>cw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toByteArray</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>你无需理解上面这段代码的具体含义，只须了解它会更改同一目录下 Circuit 类的 startRace(Object) 方法，使之包含 invokedynamic 指令，执行所谓的赛跑方法。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>startRace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>         <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokedynamic</span> <span style=color:#a40000>#</span><span style=color:#000>80</span><span style=color:#ce5c00;font-weight:700>,</span>  <span style=color:#000>0</span> <span style=color:#8f5902;font-style:italic>// race:(Ljava/lang/Object;)V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span></code></pre></div><p>如果你足够细心的话，你会发现该指令所调用的赛跑方法的描述符，和 Horse.race 方法或者 Deer.race 方法的描述符并不一致。这是因为 <strong>invokedynamic 指令最终调用的是方法句柄，而方法句柄会将调用者当成第一个参数。因此，刚刚提到的那两个方法恰恰符合这个描述符所对应的方法句柄类型。</strong></p><p>到目前为止，我们已经可以通过 invokedynamic 调用 Horse.race 方法了。为了支持调用任意类的 race 方法，我实现了一个简单的单态内联缓存。如果调用者的类型命中缓存中的类型，便直接调用缓存中的方法句柄，否则便更新缓存。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 需要更改 ASMHelper.MyMethodVisitor 中的 BOOTSTRAP_CLASS_NAME
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.invoke.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MonomorphicInlineCache</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Lookup</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MonomorphicInlineCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Lookup</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lookup</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>cachedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MethodHandle</span> <span style=color:#000>mh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>receiver</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedClass</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>receiver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>cachedClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>receiver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findVirtual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>mh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>receiver</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>CallSite</span> <span style=color:#000>bootstrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodHandles</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Lookup</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodType</span> <span style=color:#000>callSiteType</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MonomorphicInlineCache</span> <span style=color:#000>ic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MonomorphicInlineCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MethodHandle</span> <span style=color:#000>mh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findVirtual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MonomorphicInlineCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;invoke&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>methodType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConstantCallSite</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bindTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ic</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>可以看到，尽管 invokedynamic 指令调用的是所谓的 race 方法，但是实际上我返回了一个链接至名为“invoke”的方法的调用点。由于调用点仅要求方法句柄的类型能够匹配，因此这个链接是合法的。</p><p>不过，这正是 invokedynamic 的目的，也就是将调用点与目标方法的链接交由应用程序来做，并且依赖于应用程序对目标方法进行验证。所以，如果应用程序将赛跑方法链接至兔子的睡觉方法，那也只能怪应用程序自己了。</p><h2 id=java-8-的-lambda-表达式>Java 8 的 Lambda 表达式</h2><p>在 Java 8 中，Lambda 表达式也是借助 invokedynamic 来实现的。</p><p>具体来说，Java 编译器利用 invokedynamic 指令来生成实现了函数式接口的适配器。这里的函数式接口指的是仅包括一个非 default 接口方法的接口，一般通过 @FunctionalInterface 注解。不过就算是没有使用该注解，Java 编译器也会将符合条件的接口辨认为函数式接口。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>..</span>
</span></span><span style=display:flex><span><span style=color:#000>IntStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>举个例子，上面这段代码会对 IntStream 中的元素进行两次映射。我们知道，映射方法 map 所接收的参数是 IntUnaryOperator（这是一个函数式接口）。也就是说，在运行过程中我们需要将 i->i<em>2 和 i->i</em>x 这两个 Lambda 表达式转化成 IntUnaryOperator 的实例。这个转化过程便是由 invokedynamic 来实现的。</p><p>在编译过程中，Java 编译器会对 Lambda 表达式进行解语法糖（desugar），生成一个方法来保存 Lambda 表达式的内容。该方法的参数列表不仅包含原本 Lambda 表达式的参数，还包含它所捕获的变量。(注：方法引用，如 Horse::race，则不会生成生成额外的方法。)</p><p>在上面那个例子中，第一个 Lambda 表达式没有捕获其他变量，而第二个 Lambda 表达式（也就是 i->i*x）则会捕获局部变量 x。这两个 Lambda 表达式对应的方法如下所示。可以看到，所捕获的变量同样也会作为参数传入生成的方法之中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// i -&gt; i * 2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lambda$0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_0</span>
</span></span><span style=display:flex><span>       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
</span></span><span style=display:flex><span>       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>imul</span>
</span></span><span style=display:flex><span>       <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ireturn</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// i -&gt; i * x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lambda$1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_1</span>
</span></span><span style=display:flex><span>       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_0</span>
</span></span><span style=display:flex><span>       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>imul</span>
</span></span><span style=display:flex><span>       <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ireturn</span>
</span></span></code></pre></div><p><strong>第一次执行 invokedynamic 指令时，它所对应的启动方法会通过 ASM 来生成一个适配器类。这个适配器类实现了对应的函数式接口，在我们的例子中，也就是 IntUnaryOperator。启动方法的返回值是一个 ConstantCallSite，其链接对象为一个返回适配器类实例的方法句柄。</strong></p><p><strong>根据 Lambda 表达式是否捕获其他变量，启动方法生成的适配器类以及所链接的方法句柄皆不同。</strong></p><p><strong>如果该 Lambda 表达式没有捕获其他变量，那么可以认为它是上下文无关的。因此，启动方法将新建一个适配器类的实例，并且生成一个特殊的方法句柄，始终返回该实例。</strong></p><p><strong>如果该 Lambda 表达式捕获了其他变量，那么每次执行该 invokedynamic 指令，我们都要更新这些捕获了的变量，以防止它们发生了变化。</strong></p><p><strong>另外，为了保证 Lambda 表达式的线程安全，我们无法共享同一个适配器类的实例。因此，在每次执行 invokedynamic 指令时，所调用的方法句柄都需要新建一个适配器类实例。</strong></p><p><strong>在这种情况下，启动方法生成的适配器类将包含一个额外的静态方法，来构造适配器类的实例。该方法将接收这些捕获的参数，并且将它们保存为适配器类实例的实例字段。</strong></p><p>你可以通过虚拟机参数 -Djdk.internal.lambda.dumpProxyClasses=/DUMP/PATH 导出这些具体的适配器类。这里我导出了上面这个例子中两个 Lambda 表达式对应的适配器类。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// i-&gt;i*2 对应的适配器类
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LambdaTest$$Lambda$1</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>IntUnaryOperator</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LambdaTest$$Lambda$1</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>    <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#4e9a06>&#34;&lt;init&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>:()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>    <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>applyAsInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span> <span style=color:#000>LambdaTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lambda$0</span><span style=color:#ce5c00;font-weight:700>:(</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ireturn</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// i-&gt;i*x 对应的适配器类
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LambdaTest$$Lambda$2</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>IntUnaryOperator</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg$1</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LambdaTest$$Lambda$2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>    <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#4e9a06>&#34;&lt;init&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>:()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>    <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>    <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span> <span style=color:#000>arg$1</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>function</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IntUnaryOperator</span> <span style=color:#000>get$Lambda</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LambdaTest$$Lambda$2</span>
</span></span><span style=display:flex><span>    <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dup</span>
</span></span><span style=display:flex><span>    <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_0</span>
</span></span><span style=display:flex><span>    <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#4e9a06>&#34;&lt;init&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>:(</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>    <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>areturn</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>applyAsInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>    <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getfield</span> <span style=color:#000>arg$1</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iload_1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokestatic</span> <span style=color:#000>LambdaTest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lambda$1</span><span style=color:#ce5c00;font-weight:700>:(</span><span style=color:#000>II</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>ireturn</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>可以看到，捕获了局部变量的 Lambda 表达式多出了一个 get$Lambda 的方法。启动方法便会将所返回的调用点链接至指向该方法的方法句柄。也就是说，<strong>每次执行 invokedynamic 指令时，都会调用至这个方法中，并构造一个新的适配器类实例。</strong></p><p>这个多出来的新建实例会对程序性能造成影响吗？</p><h2 id=lambda-以及方法句柄的性能分析>Lambda 以及方法句柄的性能分析</h2><p>我再次请出测试反射调用性能开销的那段代码，并将其改造成使用 Lambda 表达式的 v6 版本。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// v6 版本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.function.IntConsumer</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>2_000_000_000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>100_000_000</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>IntConsumer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// ((IntConsumer) Test::target.accept(128);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>测量结果显示，它与直接调用的性能并无太大的区别。也就是说，<strong>即时编译器能够将转换 Lambda 表达式所使用的 invokedynamic，以及对 IntConsumer.accept 方法的调用统统内联进来，最终优化为空操作。</strong></p><p>这个其实不难理解：<strong>Lambda 表达式所使用的 invokedynamic 将绑定一个 ConstantCallSite，其链接的目标方法无法改变。因此，即时编译器会将该目标方法直接内联进来。对于这类没有捕获变量的 Lambda 表达式而言，目标方法只完成了一个动作，便是加载缓存的适配器类常量。</strong></p><p>另一方面，<strong>对 IntConsumer.accept 方法的调用实则是对适配器类的 accept 方法的调用。</strong></p><p>如果你查看了 accept 方法对应的字节码的话，你会发现它仅包含一个方法调用，调用至 Java 编译器在解 Lambda 语法糖时生成的方法。</p><p>该方法的内容便是 Lambda 表达式的内容，也就是直接调用目标方法 Test.target。将这几个方法调用内联进来之后，原本对 accept 方法的调用则会被优化为空操作。</p><p>下面我将之前的代码更改为带捕获变量的 v7 版本。理论上，每次调用 invokedynamic 指令，Java 虚拟机都会新建一个适配器类的实例。然而，实际运行结果还是与直接调用的性能一致。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// v7 版本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.function.IntConsumer</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>2_000_000_000</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>100_000_000</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temp</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>IntConsumer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>128</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>显然，即时编译器的逃逸分析又将该新建实例给优化掉了。我们可以通过虚拟机参数 -XX:-DoEscapeAnalysis 来关闭逃逸分析。果然，这时候测得的值约为直接调用的 2.5 倍。</p><p>尽管逃逸分析能够去除这些额外的新建实例开销，但是它也不是时时奏效。它需要同时满足两件事：<strong>invokedynamic 指令所执行的方法句柄能够内联，和接下来的对 accept 方法的调用也能内联。</strong></p><p><strong>只有这样，逃逸分析才能判定该适配器实例不逃逸</strong>。<strong>否则，我们会在运行过程中不停地生成适配器类实例</strong>。所以，我们应当尽量使用非捕获的 Lambda 表达式。</p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 invokedynamic 指令以及 Lambda 表达式的实现。</p><p><strong>invokedymaic 指令抽象出调用点的概念，并且将调用该调用点所链接的方法句柄。在第一次执行 invokedynamic 指令时，Java 虚拟机将执行它所对应的启动方法，生成并且绑定一个调用点。之后如果再次执行该指令，Java 虚拟机则直接调用已经绑定了的调用点所链接的方法。</strong></p><p><strong>Lambda 表达式到函数式接口的转换是通过 invokedynamic 指令来实现的。该 invokedynamic 指令对应的启动方法将通过 ASM 生成一个适配器类。</strong></p><p><strong>对于没有捕获其他变量的 Lambda 表达式，该 invokedynamic 指令始终返回同一个适配器类的实例。对于捕获了其他变量的 Lambda 表达式，每次执行 invokedynamic 指令将新建一个适配器类实例。</strong></p><p><strong>不管是捕获型的还是未捕获型的 Lambda 表达式，它们的性能上限皆可以达到直接调用的性能。其中，捕获型 Lambda 表达式借助了即时编译器中的逃逸分析，来避免实际的新建适配器类实例的操作。</strong></p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-3e5864898a2903c5e0fc455ace4fb22d>10 - CH10-对象内存布局</h1><p>在 Java 程序中，我们拥有多种新建对象的方式。除了最为常见的 new 语句之外，我们还可以通过反射机制、Object.clone 方法、反序列化以及 Unsafe.allocateInstance 方法来新建对象。</p><p>其中，<strong>Object.clone 方法和反序列化通过直接复制已有的数据，来初始化新建对象的实例字段。Unsafe.allocateInstance 方法则没有初始化实例字段，而 new 语句和反射机制，则是通过调用构造器来初始化实例字段。</strong></p><p>以 new 语句为例，它编译而成的字节码将包含用来请求内存的 new 指令，以及用来调用构造器的 invokespecial 指令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Foo foo = new Foo(); 编译而成的字节码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>0</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span>  <span style=color:#000>3</span> <span style=color:#000>dup</span>
</span></span><span style=display:flex><span>  <span style=color:#000>4</span> <span style=color:#000>invokespecial</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>  <span style=color:#000>7</span> <span style=color:#000>astore_1</span>
</span></span></code></pre></div><p>提到构造器，就不得不提到 Java 对构造器的诸多约束。首先，如果一个类没有定义任何构造器的话， Java 编译器会自动添加一个无参数的构造器。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Foo 类构造器会调用其父类 Object 的构造器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000>0</span> <span style=color:#000>aload_0</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>1</span> <span style=color:#000>invokespecial</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>4</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span></code></pre></div><p>然后，子类的构造器需要调用父类的构造器。如果父类存在无参数构造器的话，该调用可以是隐式的，也就是说 Java 编译器会自动添加对父类构造器的调用。但是，如果父类没有无参数构造器，那么子类的构造器则需要显式地调用父类带参数的构造器。</p><p>显式调用又可分为两种，一是直接使用“super”关键字调用父类构造器，二是使用“this”关键字调用同一个类中的其他构造器。无论是直接的显式调用，还是间接的显式调用，都需要作为构造器的第一条语句，以便优先初始化继承而来的父类字段。（不过这可以通过调用其他生成参数的方法，或者字节码注入来绕开。）</p><p>总而言之，<strong>当我们调用一个构造器时，它将优先调用父类的构造器，直至 Object 类。这些构造器的调用者皆为同一对象，也就是通过 new 指令新建而来的对象。</strong></p><p>你应该已经发现了其中的玄机：<strong>通过 new 指令新建出来的对象，它的内存其实涵盖了所有父类中的实例字段。也就是说，虽然子类无法访问父类的私有实例字段，或者子类的实例字段隐藏了父类的同名实例字段，但是子类的实例还是会为这些父类实例字段分配内存的。</strong></p><p>这些字段在内存中的具体分布是怎么样的呢？今天我们就来看看对象的内存布局。</p><h2 id=压缩指针>压缩指针</h2><p><strong>在 Java 虚拟机中，每个 Java 对象都有一个对象头（object header），这个由标记字段和类型指针所构成。其中，标记字段用以存储 Java 虚拟机有关该对象的运行数据，如哈希码、GC 信息以及锁信息，而类型指针则指向该对象的类。</strong></p><p><strong>在 64 位的 Java 虚拟机中，对象头的标记字段占 64 位，而类型指针又占了 64 位。也就是说，每一个 Java 对象在内存中的额外开销就是 16 个字节</strong>。以 Integer 类为例，它仅有一个 int 类型的私有字段，占 4 个字节。因此，每一个 Integer 对象的额外内存开销至少是 400%。这也是为什么 Java 要引入基本类型的原因之一。</p><p><strong>为了尽量较少对象的内存使用量，64 位 Java 虚拟机引入了压缩指针 [1] 的概念（对应虚拟机选项 -XX:+UseCompressedOops，默认开启），将堆中原本 64 位的 Java 对象指针压缩成 32 位的。</strong></p><p><strong>这样一来，对象头中的类型指针也会被压缩成 32 位，使得对象头的大小从 16 字节降至 12 字节。当然，压缩指针不仅可以作用于对象头的类型指针，还可以作用于引用类型的字段，以及引用类型数组。</strong></p><p>那么压缩指针是什么原理呢？</p><p>打个比方，路上停着的全是房车，而且每辆房车恰好占据两个停车位。现在，我们按照顺序给它们编号。也就是说，停在 0 号和 1 号停车位上的叫 0 号车，停在 2 号和 3 号停车位上的叫 1 号车，依次类推。</p><p>原本的内存寻址用的是车位号。比如说我有一个值为 6 的指针，代表第 6 个车位，那么沿着这个指针可以找到 3 号车。现在我们规定指针里存的值是车号，比如 3 指代 3 号车。当需要查找 3 号车时，我便可以将该指针的值乘以 2，再沿着 6 号车位找到 3 号车。</p><p>这样一来，32 位压缩指针最多可以标记 2 的 32 次方辆车，对应着 2 的 33 次方个车位。当然，房车也有大小之分。大房车占据的车位可能是三个甚至是更多。不过这并不会影响我们的寻址算法：我们只需跳过部分车号，便可以保持原本车号 *2 的寻址系统。</p><p>上述模型有一个前提，你应该已经想到了，<strong>就是每辆车都从偶数号车位停起。这个概念我们称之为内存对齐（对应虚拟机选项 -XX:ObjectAlignmentInBytes，默认值为 8）。</strong></p><p><strong>默认情况下，Java 虚拟机堆中对象的起始地址需要对齐至 8 的倍数</strong>。<strong>如果一个对象用不到 8N 个字节，那么空白的那部分空间就浪费掉了。这些浪费掉的空间我们称之为对象间的填充（padding）。</strong></p><p><strong>在默认情况下，Java 虚拟机中的 32 位压缩指针可以寻址到 2 的 35 次方个字节，也就是 32GB 的地址空间（超过 32GB 则会关闭压缩指针）。</strong></p><p><strong>在对压缩指针解引用时，我们需要将其左移 3 位，再加上一个固定偏移量，便可以得到能够寻址 32GB 地址空间的伪 64 位指针了。</strong></p><p><strong>此外，我们可以通过配置刚刚提到的内存对齐选项（-XX:ObjectAlignmentInBytes）来进一步提升寻址范围。但是，这同时也可能增加对象间填充，导致压缩指针没有达到原本节省空间的效果。</strong></p><p>举例来说，如果规定每辆车都需要从偶数车位号停起，那么对于占据两个车位的小房车来说刚刚好，而对于需要三个车位的大房车来说，也仅是浪费一个车位。</p><p>但是如果规定需要从 4 的倍数号车位停起，那么小房车则会浪费两个车位，而大房车至多可能浪费三个车位。</p><p>当然，就算是关闭了压缩指针，Java 虚拟机还是会进行内存对齐。此外，内存对齐不仅存在于对象与对象之间，也存在于对象中的字段之间。比如说，Java 虚拟机要求 long 字段、double 字段，以及非压缩指针状态下的引用字段地址为 8 的倍数。</p><p>**字段内存对齐的其中一个原因，是让字段只出现在同一 CPU 的缓存行中。如果字段不是对齐的，那么就有可能出现跨缓存行的字段。也就是说，该字段的读取可能需要替换两个缓存行，而该字段的存储也会同时污染两个缓存行。**这两种情况对程序的执行效率而言都是不利的。</p><p>下面我来介绍一下对象内存布局另一个有趣的特性：字段重排列。</p><h2 id=字段重排列>字段重排列</h2><p>字段重排列，顾名思义，<strong>就是 Java 虚拟机重新分配字段的先后顺序，以达到内存对齐的目的</strong>。Java 虚拟机中有三种排列方法（对应 Java 虚拟机选项 -XX:FieldsAllocationStyle，默认值为 1），但都会遵循如下两个规则。</p><p><strong>其一，如果一个字段占据 C 个字节，那么该字段的偏移量需要对齐至 NC。这里偏移量指的是字段地址与对象的起始地址差值。</strong></p><p>以 long 类为例，它仅有一个 long 类型的实例字段。在使用了压缩指针的 64 位虚拟机中，尽管对象头的大小为 12 个字节，该 long 类型字段的偏移量也只能是 16，而中间空着的 4 个字节便会被浪费掉。</p><p><strong>其二，子类所继承字段的偏移量，需要与父类对应字段的偏移量保持一致。</strong></p><p>在具体实现中，Java 虚拟机还会对齐子类字段的起始位置。对于使用了压缩指针的 64 位虚拟机，子类第一个字段需要对齐至 4N；而对于关闭了压缩指针的 64 位虚拟机，子类第一个字段则需要对齐至 8N。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#a40000>；</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>B</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>我在文中贴了一段代码，里边定义了两个类 A 和 B，其中 B 继承 A。A 和 B 各自定义了一个 long 类型的实例字段和一个 int 类型的实例字段。下面我分别打印了 B 类在启用压缩指针和未启用压缩指针时，各个字段的偏移量。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a40000>#</span> <span style=color:#000>启用压缩指针时</span><span style=color:#a40000>，</span><span style=color:#000>B</span> <span style=color:#000>类的字段分布</span>
</span></span><span style=display:flex><span><span style=color:#000>B</span> <span style=color:#000>object</span> <span style=color:#000>internals</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span> <span style=color:#000>OFFSET</span>  <span style=color:#000>SIZE</span>   <span style=color:#000>TYPE</span> <span style=color:#000>DESCRIPTION</span>
</span></span><span style=display:flex><span>      <span style=color:#000>0</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000>4</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000>8</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000>12</span>     <span style=color:#000>4</span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>i</span>                                       <span style=color:#000>0</span>
</span></span><span style=display:flex><span>     <span style=color:#000>16</span>     <span style=color:#000>8</span>   <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>l</span>                                       <span style=color:#000>0</span>
</span></span><span style=display:flex><span>     <span style=color:#000>24</span>     <span style=color:#000>8</span>   <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>l</span>                                       <span style=color:#000>0</span>
</span></span><span style=display:flex><span>     <span style=color:#000>32</span>     <span style=color:#000>4</span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>i</span>                                       <span style=color:#000>0</span>
</span></span><span style=display:flex><span>     <span style=color:#000>36</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loss</span> <span style=color:#000>due</span> <span style=color:#000>to</span> <span style=color:#000>the</span> <span style=color:#000>next</span> <span style=color:#000>object</span> <span style=color:#000>alignment</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>当启用压缩指针时，可以看到 Java 虚拟机将 A 类的 int 字段放置于 long 字段之前，以填充因为 long 字段对齐造成的 4 字节缺口。由于对象整体大小需要对齐至 8N，因此对象的最后会有 4 字节的空白填充。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a40000>#</span> <span style=color:#000>关闭压缩指针时</span><span style=color:#a40000>，</span><span style=color:#000>B</span> <span style=color:#000>类的字段分布</span>
</span></span><span style=display:flex><span><span style=color:#000>B</span> <span style=color:#000>object</span> <span style=color:#000>internals</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span> <span style=color:#000>OFFSET</span>  <span style=color:#000>SIZE</span>   <span style=color:#000>TYPE</span> <span style=color:#000>DESCRIPTION</span>
</span></span><span style=display:flex><span>      <span style=color:#000>0</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000>4</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000>8</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000>12</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span> <span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>     <span style=color:#000>16</span>     <span style=color:#000>8</span>   <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>l</span>
</span></span><span style=display:flex><span>     <span style=color:#000>24</span>     <span style=color:#000>4</span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>i</span>
</span></span><span style=display:flex><span>     <span style=color:#000>28</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>alignment</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>padding</span> <span style=color:#000>gap</span><span style=color:#ce5c00;font-weight:700>)</span>                  
</span></span><span style=display:flex><span>     <span style=color:#000>32</span>     <span style=color:#000>8</span>   <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>l</span>
</span></span><span style=display:flex><span>     <span style=color:#000>40</span>     <span style=color:#000>4</span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>i</span>
</span></span><span style=display:flex><span>     <span style=color:#000>44</span>     <span style=color:#000>4</span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loss</span> <span style=color:#000>due</span> <span style=color:#000>to</span> <span style=color:#000>the</span> <span style=color:#000>next</span> <span style=color:#000>object</span> <span style=color:#000>alignment</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>当关闭压缩指针时，B 类字段的起始位置需对齐至 8N。这么一来，B 类字段的前后各有 4 字节的空白。那么我们可不可以将 B 类的 int 字段移至前面的空白中，从而节省这 8 字节呢？</p><p>我认为是可以的，并且我修改过后的 Java 虚拟机也没有跑崩。由于 HotSpot 中的这块代码年久失修，公司的同事也已经记不得是什么原因了，那么姑且先认为是一些历史遗留问题吧。</p><p><strong>Java 8 还引入了一个新的注释 @Contended，用来解决对象字段之间的虚共享（false sharing）问题 [2]。这个注释也会影响到字段的排列。</strong></p><p>虚共享是怎么回事呢？<strong>假设两个线程分别访问同一对象中不同的 volatile 字段，逻辑上它们并没有共享内容，因此不需要同步。</strong></p><p>然而，<strong>如果这两个字段恰好在同一个缓存行中，那么对这些字段的写操作会导致缓存行的写回，也就造成了实质上的共享。</strong>（volatile 字段和缓存行的故事我会在之后的篇章中详细介绍。）</p><p><strong>Java 虚拟机会让不同的 @Contended 字段处于独立的缓存行中，因此你会看到大量的空间被浪费掉</strong>。具体的分布算法属于实现细节，随着 Java 版本的变动也比较大，因此这里就不做阐述了。</p><p>如果你感兴趣，可以利用实践环节的工具，来查阅 Contended 字段的内存布局。注意使用虚拟机选项 -XX:-RestrictContended。如果你在 Java 9 以上版本试验的话，在使用 javac 编译时需要添加 &ndash;add-exports java.base/jdk.internal.vm.annotation=ALL-UNNAME</p><h2 id=总结和实践>总结和实践</h2><p>今天我介绍了 Java 虚拟机构造对象的方式，所构造对象的大小，以及对象的内存布局。</p><p>常见的 new 语句会被编译为 new 指令，以及对构造器的调用。每个类的构造器皆会直接或者间接调用父类的构造器，并且在同一个实例中初始化相应的字段。</p><p>Java 虚拟机引入了压缩指针的概念，将原本的 64 位指针压缩成 32 位。压缩指针要求 Java 虚拟机堆中对象的起始地址要对齐至 8 的倍数。Java 虚拟机还会对每个类的字段进行重排列，使得字段也能够内存对齐。</p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-7802b4a703743b4e6094f0a6360fcd34>11 - CH11-垃圾回收-上</h1><p>Java 虚拟机的自动内存管理，将原本需要由开发人员手动回收的内存，交给垃圾回收器来自动回收。不过既然是自动机制，肯定没法做到像手动回收那般精准高效 [1] ，而且还会带来不少与垃圾回收实现相关的问题。</p><h2 id=引用计数法与可达性分析>引用计数法与可达性分析</h2><p>垃圾回收，顾名思义，便是将已经分配出去的，但却不再使用的内存回收回来，以便能够再次分配。在 Java 虚拟机的语境下，<strong>垃圾指的是死亡的对象所占据的堆空间</strong>。这里便涉及了一个关键的问题：如何辨别一个对象是存是亡？</p><p>我们先来讲一种<strong>古老的辨别方法：引用计数法</strong>（reference counting）。它的做法是为每个对象添加一个引用计数器，用来统计指向该对象的引用个数。一旦某个对象的引用计数器为 0，则说明该对象已经死亡，便可以被回收了。</p><p>它的具体实现是这样子的：<strong>如果有一个引用，被赋值为某一对象，那么将该对象的引用计数器 +1。如果一个指向某一对象的引用，被赋值为其他值，那么将该对象的引用计数器 -1</strong>。也就是说，我们需要截获所有的引用更新操作，并且相应地增减目标对象的引用计数器。</p><p>除了需要额外的空间来存储计数器，以及繁琐的更新操作，引用计数法还有一个重大的漏洞，那便是<strong>无法处理循环引用对象</strong>。</p><p>举个例子，假设对象 a 与 b 相互引用，除此之外没有其他引用指向 a 或者 b。在这种情况下，a 和 b 实际上已经死了，但由于它们的引用计数器皆不为 0，在引用计数法的心中，这两个对象还活着。因此，这些循环引用对象所占据的空间将不可回收，从而造成了内存泄露。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220301205153.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220301205153></div><p>目前 Java 虚拟机的主流垃圾回收器采取的是<strong>可达性分析算法</strong>。这个算法的实质在于<strong>将一系列 GC Roots 作为初始的存活对象合集（live set），然后从该合集出发，探索所有能够被该集合引用到的对象，并将其加入到该集合中，这个过程我们也称之为标记（mark）。最终，未被探索到的对象便是死亡的，是可以回收的。</strong></p><p>那么什么是 GC Roots 呢？我们可以暂时理解为<strong>由堆外指向堆内的引用</strong>，一般而言，GC Roots 包括（但不限于）如下几种：</p><ol>
<li><strong>Java 方法栈桢中的局部变量</strong>；</li><li><strong>已加载类的静态变量</strong>；</li><li>JNI handles；</li><li><strong>已启动且未停止的 Java 线程</strong>。</li></ol><p>可达性分析可以解决引用计数法所不能解决的循环引用问题。举例来说，即便对象 a 和 b 相互引用，只要从 GC Roots 出发无法到达 a 或者 b，那么可达性分析便不会将它们加入存活对象合集之中。</p><p>虽然可达性分析的算法本身很简明，但是在实践中还是有不少其他问题需要解决的。</p><p>比如说，<strong>在多线程环境下，其他线程可能会更新已经访问过的对象中的引用，从而造成误报（将引用设置为 null）或者漏报（将引用设置为未被访问过的对象）</strong>。</p><p>误报并没有什么伤害，Java 虚拟机至多损失了部分垃圾回收的机会。漏报则比较麻烦，因为垃圾回收器可能回收事实上仍被引用的对象内存。一旦从原引用访问已经被回收了的对象，则很有可能会直接导致 Java 虚拟机崩溃。</p><h2 id=stop-the-world-以及安全点>Stop-the-world 以及安全点</h2><p>怎么解决这个问题呢？在 Java 虚拟机里，<strong>传统的垃圾回收算法采用的是一种简单粗暴的方式，那便是 Stop-the-world，停止其他非垃圾回收线程的工作，直到完成垃圾回收</strong>。这也就造成了垃圾回收所谓的暂停时间（GC pause）。</p><p>Java 虚拟机中的 Stop-the-world 是通过<strong>安全点（safepoint）机制</strong>来实现的。<strong>当 Java 虚拟机收到 Stop-the-world 请求，它便会等待所有的线程都到达安全点，才允许请求 Stop-the-world 的线程进行独占的工作</strong>。</p><p>这篇博客 [2] 还提到了一种比较另类的解释：<strong>安全词</strong>。<strong>一旦垃圾回收线程喊出了安全词，其他非垃圾回收线程便会一一停下。</strong></p><p>当然，<strong>安全点的初始目的并不是让其他线程停下，而是找到一个稳定的执行状态。在这个执行状态下，Java 虚拟机的堆栈不会发生变化。这么一来，垃圾回收器便能够“安全”地执行可达性分析</strong>。</p><p>举个例子，当 Java 程序通过 JNI 执行本地代码时，如果这段代码不访问 Java 对象、调用 Java 方法或者返回至原 Java 方法，那么 Java 虚拟机的堆栈不会发生改变，也就代表着这段本地代码可以作为同一个安全点。</p><p>只要不离开这个安全点，Java 虚拟机便能够在垃圾回收的同时，继续运行这段本地代码。</p><p>由于本地代码需要通过 JNI 的 API 来完成上述三个操作，因此 Java 虚拟机仅需在 API 的入口处进行安全点检测（safepoint poll），测试是否有其他线程请求停留在安全点里，便可以在必要的时候挂起当前线程。</p><p><strong>除了执行 JNI 本地代码外，Java 线程还有其他几种状态：解释执行字节码、执行即时编译器生成的机器码和线程阻塞。阻塞的线程由于处于 Java 虚拟机线程调度器的掌控之下，因此属于安全点。</strong></p><p><strong>其他几种状态则是运行状态，需要虚拟机保证在可预见的时间内进入安全点</strong>。否则，垃圾回收线程可能长期处于等待所有线程进入安全点的状态，从而变相地提高了垃圾回收的暂停时间。</p><p>对于解释执行来说，字节码与字节码之间皆可作为安全点。Java 虚拟机采取的做法是，当有安全点请求时，执行一条字节码便进行一次安全点检测。</p><p>执行即时编译器生成的机器码则比较复杂。由于这些代码直接运行在底层硬件之上，不受 Java 虚拟机掌控，因此在生成机器码时，即时编译器需要插入安全点检测，以避免机器码长时间没有安全点检测的情况。HotSpot 虚拟机的做法便是在生成代码的方法出口以及非计数循环的循环回边（back-edge）处插入安全点检测。</p><p>那么为什么不在每一条机器码或者每一个机器码基本块处插入安全点检测呢？原因主要有两个。</p><p>第一，<strong>安全点检测本身也有一定的开销</strong>。不过 HotSpot 虚拟机已经将机器码中安全点检测简化为一个内存访问操作。在有安全点请求的情况下，Java 虚拟机会将安全点检测访问的内存所在的页设置为不可读，并且定义一个 segfault 处理器，来截获因访问该不可读内存而触发 segfault 的线程，并将它们挂起。</p><p>第二，<strong>即时编译器生成的机器码打乱了原本栈桢上的对象分布状况</strong>。在进入安全点时，机器码还需提供一些额外的信息，来表明哪些寄存器，或者当前栈帧上的哪些内存空间存放着指向对象的引用，以便垃圾回收器能够枚举 GC Roots。</p><p>由于这些信息需要不少空间来存储，因此即时编译器会尽量避免过多的安全点检测。</p><p>不过，不同的即时编译器插入安全点检测的位置也可能不同。以 Graal 为例，除了上述位置外，它还会在计数循环的循环回边处插入安全点检测。其他的虚拟机也可能选取方法入口而非方法出口来插入安全点检测。</p><p>不管如何，其目的都是在可接受的性能开销以及内存开销之内，避免机器码长时间不进入安全点的情况，间接地减少垃圾回收的暂停时间。</p><p>除了垃圾回收之外，Java 虚拟机其他一些对堆栈内容的一致性有要求的操作也会用到安全点这一机制。我会在涉及的时侯再进行具体的讲解。</p><h2 id=垃圾回收的三种方式>垃圾回收的三种方式</h2><p>当标记完所有的存活对象时，我们便可以进行死亡对象的回收工作了。主流的基础回收方式可分为三种。</p><p><strong>第一种是清除（sweep），即把死亡对象所占据的内存标记为空闲内存，并记录在一个空闲列表（free list）之中。当需要新建对象时，内存管理模块便会从该空闲列表中寻找空闲内存，并划分给新建的对象。</strong></p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220301210455.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220301210455></div><p>清除这种回收方式的原理及其简单，但是有两个缺点。一是会造成<strong>内存碎片</strong>。由于 Java 虚拟机的堆中对象必须是连续分布的，因此可能出现总空闲内存足够，但是无法分配的极端情况。</p><p>另一个则是<strong>分配效率较低</strong>。如果是一块连续的内存空间，那么我们可以通过指针加法（pointer bumping）来做分配。而对于空闲列表，Java 虚拟机则需要逐个访问列表中的项，来查找能够放入新建对象的空闲内存。</p><p><strong>第二种是压缩（compact），即把存活的对象聚集到内存区域的起始位置，从而留下一段连续的内存空间。这种做法能够解决内存碎片化的问题，但代价是压缩算法的性能开销。</strong></p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220301210539.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220301210539></div><p><strong>第三种则是复制（copy），即把内存区域分为两等分，分别用两个指针 from 和 to 来维护，并且只是用 from 指针指向的内存区域来分配内存。当发生垃圾回收时，便把存活的对象复制到 to 指针指向的内存区域中，并且交换 from 指针和 to 指针的内容。复制这种回收方式同样能够解决内存碎片化的问题，但是它的缺点也极其明显，即堆空间的使用效率极其低下。</strong></p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220301210610.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220301210610></div><p>当然，现代的垃圾回收器往往会综合上述几种回收方式，综合它们优点的同时规避它们的缺点。在下一篇中我们会详细介绍 Java 虚拟机中垃圾回收算法的具体实现。</p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了垃圾回收的一些基础知识。</p><p>Java 虚拟机中的垃圾回收器采用可达性分析来探索所有存活的对象。它<strong>从一系列 GC Roots 出发，边标记边探索所有被引用的对象。</strong></p><p><strong>为了防止在标记过程中堆栈的状态发生改变，Java 虚拟机采取安全点机制来实现 Stop-the-world 操作，暂停其他非垃圾回收线程。</strong></p><p>回收死亡对象的内存共有三种方式，分别为：<strong>会造成内存碎片的清除、性能开销较大的压缩、以及堆使用效率较低的复制。</strong></p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-00b575886fac0d960951532d20312051>12 - CH12-垃圾回收-下</h1><p>在读博士的时候，我曾经写过一个统计 Java 对象生命周期的动态分析，并且用它来跑了一些基准测试。</p><p>其中一些程序的结果，恰好验证了许多研究人员的假设，即<strong>大部分的 Java 对象只存活一小段时间，而存活下来的小部分 Java 对象则会存活很长一段时间</strong>。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220301210859.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220301210859></div><p>（pmd 中 Java 对象生命周期的直方图，红色的表示被逃逸分析优化掉的对象）</p><p>之所以要提到这个假设，是因为它造就了 Java 虚拟机的<strong>分代回收思想</strong>。简单来说，就是<strong>将堆空间划分为两代，分别叫做新生代和老年代。新生代用来存储新建的对象。当对象存活时间够长时，则将其移动到老年代。</strong></p><p>Java 虚拟机可以给不同代使用不同的回收算法。对于<strong>新生代，我们猜测大部分的 Java 对象只存活一小段时间，那么便可以频繁地采用耗时较短的垃圾回收算法，让大部分的垃圾都能够在新生代被回收掉</strong>。</p><p>对于<strong>老年代，我们猜测大部分的垃圾已经在新生代中被回收了，而在老年代中的对象有大概率会继续存活。当真正触发针对老年代的回收时，则代表这个假设出错了，或者堆的空间已经耗尽了</strong>。</p><p>这时候，Java 虚拟机往往需要做一次全堆扫描，耗时也将不计成本。（当然，现代的垃圾回收器都在并发收集的道路上发展，来避免这种全堆扫描的情况。）</p><p>今天这一篇我们来关注一下针对新生代的 Minor GC。首先，我们来看看 Java 虚拟机中的堆具体是怎么划分的。</p><h2 id=java-虚拟机的堆划分>Java 虚拟机的堆划分</h2><p>前面提到，Java 虚拟机将堆划分为新生代和老年代。其中，<strong>新生代又被划分为 Eden 区，以及两个大小相同的 Survivor 区。</strong></p><p>默认情况下，Java 虚拟机采取的是一种<strong>动态分配的策略</strong>（对应 Java 虚拟机参数 -XX:+UsePSAdaptiveSurvivorSizePolicy），<strong>根据生成对象的速率，以及 Survivor 区的使用情况动态调整 Eden 区和 Survivor 区的比例</strong>。</p><p>当然，你也可以通过参数 <strong>-XX:SurvivorRatio</strong> 来固定这个比例。但是需要注意的是，<strong>其中一个 Survivor 区会一直为空，因此比例越低浪费的堆空间将越高。</strong></p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220301211146.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220301211146></div><p>通常来说，当我们<strong>调用 new 指令时，它会在 Eden 区中划出一块作为存储对象的内存</strong>。由于<strong>堆空间是线程共享的，因此直接在这里边划空间是需要进行同步的</strong>。</p><p>否则，将有可能出现两个对象共用一段内存的事故。如果你还记得前两篇我用“停车位”打的比方的话，这里就相当于两个司机（线程）同时将车停入同一个停车位，因而发生剐蹭事故。</p><p><strong>Java 虚拟机的解决方法是为每个司机预先申请多个停车位，并且只允许该司机停在自己的停车位上</strong>。那么当司机的停车位用完了该怎么办呢（假设这个司机代客泊车）？</p><p>答案是：<strong>再申请多个停车位便可以了。这项技术被称之为 TLAB（Thread Local Allocation Buffer，对应虚拟机参数 -XX:+UseTLAB，默认开启）</strong>。</p><p>具体来说，<strong>每个线程可以向 Java 虚拟机申请一段连续的内存，比如 2048 字节，作为线程私有的 TLAB</strong>。</p><p><strong>这个操作需要加锁，线程需要维护两个指针（实际上可能更多，但重要也就两个），一个指向 TLAB 中空余内存的起始位置，一个则指向 TLAB 末尾。</strong></p><p><strong>接下来的 new 指令，便可以直接通过指针加法（bump the pointer）来实现，即把指向空余内存位置的指针加上所请求的字节数。</strong></p><blockquote>
<p>我猜测会有留言问为什么不把 bump the pointer 翻译成指针碰撞。这里先解释一下，在英语中我们通常省略了 bump up the pointer 中的 up。在这个上下文中 bump 的含义应为“提高”。另外一个例子是当我们发布软件的新版本时，也会说 bump the version number。</p></blockquote><p><strong>如果加法后空余内存指针的值仍小于或等于指向末尾的指针，则代表分配成功。否则，TLAB 已经没有足够的空间来满足本次新建操作。这个时候，便需要当前线程重新申请新的 TLAB。</strong></p><p><strong>当 Eden 区的空间耗尽了怎么办？这个时候 Java 虚拟机便会触发一次 Minor GC，来收集新生代的垃圾。存活下来的对象，则会被送到 Survivor 区。</strong></p><p>前面提到，新生代共有两个 Survivor 区，我们分别用 from 和 to 来指代。<strong>其中 to 指向的 Survivior 区是空的</strong>。</p><p><strong>当发生 Minor GC 时，Eden 区和 from 指向的 Survivor 区中的存活对象会被复制到 to 指向的 Survivor 区中，然后交换 from 和 to 指针，以保证下一次 Minor GC 时，to 指向的 Survivor 区还是空的</strong>。</p><p><strong>Java 虚拟机会记录 Survivor 区中的对象一共被来回复制了几次。如果一个对象被复制的次数为 15（对应虚拟机参数 -XX:+MaxTenuringThreshold），那么该对象将被晋升（promote）至老年代</strong>。另外，<strong>如果单个 Survivor 区已经被占用了 50%（对应虚拟机参数 -XX:TargetSurvivorRatio），那么较高复制次数的对象也会被晋升至老年代</strong>。</p><p>总而言之，<strong>当发生 Minor GC 时，我们应用了标记 - 复制算法，将 Survivor 区中的老存活对象晋升到老年代，然后将剩下的存活对象和 Eden 区的存活对象复制到另一个 Survivor 区中</strong>。<strong>理想情况下，Eden 区中的对象基本都死亡了，那么需要复制的数据将非常少，因此采用这种标记 - 复制算法的效果极好</strong>。</p><p><strong>Minor GC 的另外一个好处是不用对整个堆进行垃圾回收。但是，它却有一个问题，那就是老年代的对象可能引用新生代的对象。也就是说，在标记存活对象的时候，我们需要扫描老年代中的对象。如果该对象拥有对新生代对象的引用，那么这个引用也会被作为 GC Roots。</strong></p><p>这样一来，岂不是又做了一次全堆扫描呢？</p><h2 id=卡表>卡表</h2><p>HotSpot 给出的解决方案是一项叫做<strong>卡表</strong>（Card Table）的技术。该技术<strong>将整个堆划分为一个个大小为 512 字节的卡，并且维护一个卡表，用来存储每张卡的一个标识位</strong>。<strong>这个标识位代表对应的卡是否可能存有指向新生代对象的引用。如果可能存在，那么我们就认为这张卡是脏的</strong>。</p><p><strong>在进行 Minor GC 的时候，我们便可以不用扫描整个老年代，而是在卡表中寻找脏卡，并将脏卡中的对象加入到 Minor GC 的 GC Roots 里。当完成所有脏卡的扫描之后，Java 虚拟机便会将所有脏卡的标识位清零。</strong></p><p><strong>由于 Minor GC 伴随着存活对象的复制，而复制需要更新指向该对象的引用。因此，在更新引用的同时，我们又会设置引用所在的卡的标识位。这个时候，我们可以确保脏卡中必定包含指向新生代对象的引用。</strong></p><p>在 Minor GC 之前，我们并不能确保脏卡中包含指向新生代对象的引用。其原因和如何设置卡的标识位有关。</p><p><strong>首先，如果想要保证每个可能有指向新生代对象引用的卡都被标记为脏卡，那么 Java 虚拟机需要截获每个引用型实例变量的写操作，并作出对应的写标识位操作。</strong></p><p><strong>这个操作在解释执行器中比较容易实现。但是在即时编译器生成的机器码中，则需要插入额外的逻辑。这也就是所谓的写屏障</strong>（write barrier，注意不要和 volatile 字段的写屏障混淆）。</p><p>写屏障需要尽可能地保持简洁。这是因为我们并不希望在每条引用型实例变量的写指令后跟着一大串注入的指令。</p><p>因此，<strong>写屏障并不会判断更新后的引用是否指向新生代中的对象，而是宁可错杀，不可放过，一律当成可能指向新生代对象的引用。</strong></p><p>这么一来，写屏障便可精简为下面的伪代码 [1]。这里右移 9 位相当于除以 512，Java 虚拟机便是通过这种方式来从地址映射到卡表中的索引的。最终，这段代码会被编译成一条移位指令和一条存储指令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>CARD_TABLE [this address &gt;&gt; 9] = DIRTY;
</span></span></code></pre></div><p><strong>虽然写屏障不可避免地带来一些开销，但是它能够加大 Minor GC 的吞吐率</strong>（ 应用运行时间 /(应用运行时间 + 垃圾回收时间) ）。总的来说还是值得的。不过，<strong>在高并发环境下，写屏障又带来了虚共享</strong>（false sharing）问题 [2]。</p><p>在介绍对象内存布局中我曾提到虚共享问题，讲的是几个 volatile 字段出现在同一缓存行里造成的虚共享。这里的虚共享则是<strong>卡表中不同卡的标识位之间的虚共享问题</strong>。</p><p><strong>在 HotSpot 中，卡表是通过 byte 数组来实现的。对于一个 64 字节的缓存行来说，如果用它来加载部分卡表，那么它将对应 64 张卡，也就是 32KB 的内存。</strong></p><p><strong>如果同时有两个 Java 线程，在这 32KB 内存中进行引用更新操作，那么也将造成存储卡表的同一部分的缓存行的写回、无效化或者同步操作，因而间接影响程序性能。</strong></p><p>为此，HotSpot 引入了一个新的参数 -XX:+UseCondCardMark，来<strong>尽量减少写卡表的操作</strong>。其伪代码如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>if (CARD_TABLE [this address &gt;&gt; 9] != DIRTY) 
</span></span><span style=display:flex><span>  CARD_TABLE [this address &gt;&gt; 9] = DIRTY;
</span></span></code></pre></div><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 Java 虚拟机中垃圾回收具体实现的一些通用知识。</p><p>Java 虚拟机<strong>将堆分为新生代和老年代，并且对不同代采用不同的垃圾回收算法。其中，新生代分为 Eden 区和两个大小一致的 Survivor 区，并且其中一个 Survivor 区是空的</strong>。</p><p><strong>在指针对新生代的 Minor GC 中，Eden 区和非空 Survivor 区的存活对象会被复制到空的 Survivor 区中，当 Survivor 区中的存活对象复制次数超过一定数值时，它将被晋升至老年代。</strong></p><p><strong>因为 Minor GC 只针对新生代进行垃圾回收，所以在枚举 GC Roots 的时候，它需要考虑从老年代到新生代的引用。为了避免扫描整个老年代，Java 虚拟机引入了名为卡表的技术，大致地标出可能存在老年代到新生代引用的内存区域。</strong></p><h2 id=垃圾回收器>垃圾回收器</h2><p>针对<strong>新生代的垃圾回收器共有三个：Serial，Parallel Scavenge 和 Parallel New</strong>。这三个采用的都是<strong>标记 - 复制</strong>算法。其中，Serial 是一个<strong>单线程</strong>的，Parallel New 可以看成 Serial 的多线程版本。Parallel Scavenge 和 Parallel New 类似，但更加注重<strong>吞吐率</strong>。此外，Parallel Scavenge 不能与 CMS 一起使用。</p><p>针对<strong>老年代的垃圾回收器也有三个</strong>：刚刚提到的 <strong>Serial Old 和 Parallel Old，以及 CMS</strong>。Serial Old 和 Parallel Old 都是<strong>标记 - 压缩</strong>算法。同样，前者是<strong>单线程</strong>的，而后者可以看成前者的<strong>多线程</strong>版本。</p><p><strong>CMS 采用的是标记 - 清除算法</strong>，并且是<strong>并发</strong>的。除了少数几个操作需要 Stop-the-world 之外，它可以在应用程序运行过程中进行垃圾回收。在并发收集失败的情况下，Java 虚拟机会使用其他两个压缩型垃圾回收器进行一次垃圾回收。由于 G1 的出现，CMS 在 Java 9 中已被废弃 [3]。</p><p><strong>G1</strong>（Garbage First）是一个<strong>横跨新生代和老年代</strong>的垃圾回收器。实际上，它已经打乱了前面所说的堆结构，<strong>直接将堆分成极其多个区域</strong>。<strong>每个区域都可以充当 Eden 区、Survivor 区或者老年代中的一个</strong>。它采用的是<strong>标记 - 压缩</strong>算法，而且和 CMS 一样都能够在应用程序运行过程中并发地进行垃圾回收。</p><p><strong>G1 能够针对每个细分的区域来进行垃圾回收。在选择进行垃圾回收的区域时，它会优先回收死亡对象较多的区域</strong>。这也是 G1 名字的由来。</p><p>即将到来的 Java 11 引入了 ZGC，宣称暂停时间不超过 10ms。</p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-845e85e25246c2e4a708a3fbb1f6db7e>13 - CH13-内存模型</h1><p>我们先来看一个反常识的例子。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>method1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>method2</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这里我定义了两个共享变量 a 和 b，以及两个方法。第一个方法将局部变量 r2 赋值为 a，然后将共享变量 b 赋值为 1。第二个方法将局部变量 r1 赋值为 b，然后将共享变量 a 赋值为 2。请问（r1，r2）的可能值都有哪些？</p><p>在单线程环境下，我们可以先调用第一个方法，最终（r1，r2）为（1，0）；也可以先调用第二个方法，最终为（0，2）。</p><p>在多线程环境下，假设这两个方法分别跑在两个不同的线程之上，如果 Java 虚拟机在执行了任一方法的第一条赋值语句之后便切换线程，那么最终结果将可能出现（0，0）的情况。</p><p>除上述三种情况之外，Java 语言规范第 17.4 小节 [1] 还介绍了一种看似不可能的情况（1，2）。</p><p>造成这一情况的原因有三个，分别为<strong>即时编译器的重排序</strong>，<strong>处理器的乱序执行</strong>，以及<strong>内存系统的重排序</strong>。由于后两种原因涉及具体的体系架构，我们暂且放到一边。下面我先来讲一下编译器优化的重排序是怎么一回事。</p><p>首先需要说明一点，<strong>即时编译器（和处理器）需要保证程序能够遵守 as-if-serial 属性。通俗地说，就是在单线程情况下，要给程序一个顺序执行的假象。即经过重排序的执行结果要与顺序执行的结果保持一致</strong>。</p><p>另外，如果两个操作之间存在数据依赖，那么即时编译器（和处理器）不能调整它们的顺序，否则将会造成程序语义的改变。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>int a=0, b=0;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>public void method1() {
</span></span><span style=display:flex><span>  int r2 = a;
</span></span><span style=display:flex><span>  b = 1;
</span></span><span style=display:flex><span>  .. // Code uses b
</span></span><span style=display:flex><span>  if (r2 == 2) {
</span></span><span style=display:flex><span>    .. 
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上面这段代码中，我扩展了先前例子中的第一个方法。新增的代码会先使用共享变量 b 的值，然后再使用局部变量 r2 的值。</p><p>此时，即时编译器有两种选择。</p><p>第一，在一开始便将 a 加载至某一寄存器中，并且在接下来 b 的赋值操作以及使用 b 的代码中避免使用该寄存器。第二，在真正使用 r2 时才将 a 加载至寄存器中。这么一来，在执行使用 b 的代码时，我们不再霸占一个通用寄存器，从而减少需要借助栈空间的情况。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>method1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(..)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>..</span> <span style=color:#8f5902;font-style:italic>// Code uses r2 and rewrites a
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>另一个例子则是将第一个方法的代码放入一个循环中。除了原本的两条赋值语句之外，我只在循环中添加了使用 r2，并且更新 a 的代码。由于对 b 的赋值是循环无关的，即时编译器很有可能将其移出循环之前，而对 r2 的赋值语句还停留在循环之中。</p><p>如果想要复现这两个场景，你可能需要添加大量有意义的局部变量，来给寄存器分配算法施加压力。</p><p>可以看到，即时编译器的优化可能将原本字段访问的执行顺序打乱。在单线程环境下，由于 as-if-serial 的保证，我们无须担心顺序执行不可能发生的情况，如（r1，r2）=（1，2）。</p><p>然而，在多线程情况下，这种数据竞争（data race）的情况是有可能发生的。而且，Java 语言规范将其归咎于应用程序没有作出恰当的同步操作。</p><h2 id=java-内存模型与-happens-before-关系>Java 内存模型与 happens-before 关系</h2><p>为了让应用程序能够免于<strong>数据竞争</strong>的干扰，Java 5 引入了明确定义的 <strong>Java 内存模型</strong>。其中最为重要的一个概念便是 happens-before 关系。<strong>happens-before 关系是用来描述两个操作的内存可见性</strong>的。<strong>如果操作 X happens-before 操作 Y，那么 X 的结果对于 Y 可见</strong>。</p><p><strong>在同一个线程中，字节码的先后顺序（program order）也暗含了 happens-before 关系：在程序控制流路径中靠前的字节码 happens-before 靠后的字节码</strong>。然而，这并不意味着前者一定在后者之前执行。实际上，<strong>如果后者没有观测前者的运行结果，即后者没有数据依赖于前者，那么它们可能会被重排序</strong>。</p><p>除了线程内的 happens-before 关系之外，Java 内存模型还定义了下述线程间的 happens-before 关系。</p><ol>
<li><strong>解锁操作 happens-before 之后（这里指时钟顺序先后）对同一把锁的加锁操作。</strong></li><li><strong>volatile 字段的写操作 happens-before 之后（这里指时钟顺序先后）对同一字段的读操作。</strong></li><li><strong>线程的启动操作（即 Thread.starts()） happens-before 该线程的第一个操作。</strong></li><li><strong>线程的最后一个操作 happens-before 它的终止事件（即其他线程通过 Thread.isAlive() 或 Thread.join() 判断该线程是否中止）。</strong></li><li><strong>线程对其他线程的中断操作 happens-before 被中断线程所收到的中断事件（即被中断线程的 InterruptedException 异常，或者第三个线程针对被中断线程的 Thread.interrupted 或者 Thread.isInterrupted 调用）。</strong></li><li><strong>构造器中的最后一个操作 happens-before 析构器的第一个操作。</strong></li></ol><p><strong>happens-before 关系还具备传递性</strong>。如果操作 X happens-before 操作 Y，而操作 Y happens-before 操作 Z，那么操作 X happens-before 操作 Z。</p><p>在文章开头的例子中，程序没有定义任何 happens-before 关系，仅拥有默认的线程内 happens-before 关系。也就是 r2 的赋值操作 happens-before b 的赋值操作，r1 的赋值操作 happens-before a 的赋值操作。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Thread1      Thread2
</span></span><span style=display:flex><span>  |            |
</span></span><span style=display:flex><span> b=1           |
</span></span><span style=display:flex><span>  |          r1=b
</span></span><span style=display:flex><span>  |           a=2
</span></span><span style=display:flex><span>r2=a           | 
</span></span></code></pre></div><p>拥有 happens-before 关系的两对赋值操作之间没有数据依赖，因此即时编译器、处理器都可能对其进行重排序。举例来说，只要将 b 的赋值操作排在 r2 的赋值操作之前，那么便可以按照赋值 b，赋值 r1，赋值 a，赋值 r2 的顺序得到（1，2）的结果。</p><p>那么如何解决这个问题呢？答案是，将 a 或者 b 设置为 volatile 字段。</p><p>比如说将 b 设置为 volatile 字段。假设 r1 能够观测到 b 的赋值结果 1。显然，这需要 b 的赋值操作在时钟顺序上先于 r1 的赋值操作。根据 volatile 字段的 happens-before 关系，我们知道 b 的赋值操作 happens-before r1 的赋值操作。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>int a=0;
</span></span><span style=display:flex><span>volatile int b=0;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>public void method1() {
</span></span><span style=display:flex><span>  int r2 = a;
</span></span><span style=display:flex><span>  b = 1;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>public void method2() {
</span></span><span style=display:flex><span>  int r1 = b;
</span></span><span style=display:flex><span>  a = 2;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>根据同一个线程中，字节码顺序所暗含的 happens-before 关系，以及 happens-before 关系的传递性，我们可以轻易得出 r2 的赋值操作 happens-before a 的赋值操作。</p><p>这也就意味着，当对 a 进行赋值时，对 r2 的赋值操作已经完成了。因此，在 b 为 volatile 字段的情况下，程序不可能出现（r1，r2）为（1，2）的情况。</p><p>由此可以看出，<strong>解决这种数据竞争问题的关键在于构造一个跨线程的 happens-before 关系 ：操作 X happens-before 操作 Y，使得操作 X 之前的字节码的结果对操作 Y 之后的字节码可见。</strong></p><h2 id=java-内存模型的底层实现>Java 内存模型的底层实现</h2><p>在理解了 Java 内存模型的概念之后，我们现在来看看它的底层实现。<strong>Java 内存模型是通过内存屏障（memory barrier）来禁止重排序的。</strong></p><p><strong>对于即时编译器来说，它会针对前面提到的每一个 happens-before 关系，向正在编译的目标方法中插入相应的读读、读写、写读以及写写内存屏障。</strong></p><p>这些<strong>内存屏障会限制即时编译器的重排序操作</strong>。以 volatile 字段访问为例，所插入的内存屏障将不允许 volatile 字段写操作之前的内存访问被重排序至其之后；也将不允许 volatile 字段读操作之后的内存访问被重排序至其之前。</p><p><strong>然后，即时编译器将根据具体的底层体系架构，将这些内存屏障替换成具体的 CPU 指令</strong>。<strong>以我们日常接触的 X86_64 架构来说，读读、读写以及写写内存屏障是空操作（no-op），只有写读内存屏障会被替换成具体指令 [2]。</strong></p><p>在文章开头的例子中，method1 和 method2 之中的代码均属于先读后写（假设 r1 和 r2 被存储在寄存器之中）。X86_64 架构的处理器并不能将读操作重排序至写操作之后，具体可参考 Intel Software Developer Manual Volumn 3，8.2.3.3 小节。因此，我认为例子中的重排序必然是即时编译器造成的。</p><p>举例来说，对于 volatile 字段，即时编译器将在 volatile 字段的读写操作前后各插入一些内存屏障。</p><p>然而，在 X86_64 架构上，只有 volatile 字段写操作之后的写读内存屏障需要用具体指令来替代。（HotSpot 所选取的具体指令是 lock add DWORD PTR [rsp],0x0，而非 mfence[3]。）</p><p><strong>该具体指令的效果，可以简单理解为强制刷新处理器的写缓存</strong>。写缓存是处理器用来加速内存存储效率的一项技术。</p><p><strong>在碰到内存写操作时，处理器并不会等待该指令结束，而是直接开始下一指令，并且依赖于写缓存将更改的数据同步至主内存（main memory）之中。</strong></p><p><strong>强制刷新写缓存，将使得当前线程写入 volatile 字段的值（以及写缓存中已有的其他内存修改），同步至主内存之中。</strong></p><p><strong>由于内存写操作同时会无效化其他处理器所持有的、指向同一内存地址的缓存行，因此可以认为其他处理器能够立即见到该 volatile 字段的最新值。</strong></p><h2 id=锁volatile-字段final-字段与安全发布>锁，volatile 字段，final 字段与安全发布</h2><p>下面我来讲讲 Java 内存模型涉及的几个关键词。</p><p>前面提到，<strong>锁操作同样具备 happens-before 关系</strong>。具体来说，解锁操作 happens-before 之后对同一把锁的加锁操作。实际上，在解锁时，Java 虚拟机同样需要强制刷新缓存，使得当前线程所修改的内存对其他线程可见。</p><p>需要注意的是，锁操作的 happens-before 规则的关键字是同一把锁。也就意味着，如果编译器能够（通过逃逸分析）证明某把锁仅被同一线程持有，那么它可以移除相应的加锁解锁操作。</p><p>因此也就不再强制刷新缓存。举个例子，即时编译后的 synchronized (new Object()) {}，可能等同于空操作，而不会强制刷新缓存。</p><p><strong>volatile 字段可以看成一种轻量级的、不保证原子性的同步，其性能往往优于（至少不亚于）锁操作</strong>。然而，频繁地访问 volatile 字段也会因为不断地强制刷新缓存而严重影响程序的性能。</p><p>在 X86_64 平台上，只有 volatile 字段的写操作会强制刷新缓存。因此，理想情况下对 volatile 字段的使用应当多读少写，并且应当只有一个线程进行写操作。</p><p><strong>volatile 字段的另一个特性是即时编译器无法将其分配到寄存器里。换句话说，volatile 字段的每次访问均需要直接从内存中读写。</strong></p><p>final 实例字段则涉及新建对象的发布问题。当一个对象包含 final 实例字段时，我们希望其他线程只能看到已初始化的 final 实例字段。</p><p>因此，<strong>即时编译器会在 final 字段的写操作后插入一个写写屏障，以防某些优化将新建对象的发布（即将实例对象写入一个共享引用中）重排序至 final 字段的写操作之前</strong>。在 X86_64 平台上，写写屏障是空操作。</p><p>新建对象的安全发布（safe publication）问题不仅仅包括 final 实例字段的可见性，还包括其他实例字段的可见性。</p><p><strong>当发布一个已初始化的对象时，我们希望所有已初始化的实例字段对其他线程可见。否则，其他线程可能见到一个仅部分初始化的新建对象，从而造成程序错误</strong>。这里我就不展开了。如果你感兴趣的话，可以参考这篇博客 [4]。</p><h2 id=总结与实践>总结与实践</h2><p>今天我主要介绍了 Java 的内存模型。</p><p><strong>Java 内存模型通过定义了一系列的 happens-before 操作，让应用程序开发者能够轻易地表达不同线程的操作之间的内存可见性。</strong></p><p><strong>在遵守 Java 内存模型的前提下，即时编译器以及底层体系架构能够调整内存访问操作，以达到性能优化的效果。如果开发者没有正确地利用 happens-before 规则，那么将可能导致数据竞争。</strong></p><p><strong>Java 内存模型是通过内存屏障来禁止重排序的。对于即时编译器来说，内存屏障将限制它所能做的重排序优化。对于处理器来说，内存屏障会导致缓存的刷新操作。</strong></p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-400b9766cf9bfc55888b6281e35996a8>14 - CH14-Synchronized</h1><p>在 Java 程序中，我们可以利用 synchronized 关键字来对程序进行加锁。它既可以用来声明一个 synchronized 代码块，也可以直接标记静态方法或者实例方法。</p><p><strong>当声明 synchronized 代码块时，编译而成的字节码将包含 monitorenter 和 monitorexit 指令。这两种指令均会消耗操作数栈上的一个引用类型的元素（也就是 synchronized 关键字括号里的引用），作为所要加锁解锁的锁对象。</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// 上面的 Java 代码将编译为下面的字节码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
</span></span><span style=display:flex><span>       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dup</span>
</span></span><span style=display:flex><span>       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_2</span>
</span></span><span style=display:flex><span>       <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>monitorenter</span>
</span></span><span style=display:flex><span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>
</span></span><span style=display:flex><span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>:()</span><span style=color:#000>I</span>
</span></span><span style=display:flex><span>       <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>pop</span>
</span></span><span style=display:flex><span>       <span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>monitorexit</span>
</span></span><span style=display:flex><span>      <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>goto</span>          <span style=color:#000>19</span>
</span></span><span style=display:flex><span>      <span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_3</span>
</span></span><span style=display:flex><span>      <span style=color:#000>15</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>
</span></span><span style=display:flex><span>      <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>monitorexit</span>
</span></span><span style=display:flex><span>      <span style=color:#000>17</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_3</span>
</span></span><span style=display:flex><span>      <span style=color:#000>18</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>athrow</span>
</span></span><span style=display:flex><span>      <span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Exception</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#000>from</span>    <span style=color:#000>to</span>  <span style=color:#000>target</span> <span style=color:#000>type</span>
</span></span><span style=display:flex><span>           <span style=color:#000>4</span>    <span style=color:#000>11</span>    <span style=color:#000>14</span>   <span style=color:#000>any</span>
</span></span><span style=display:flex><span>          <span style=color:#000>14</span>    <span style=color:#000>17</span>    <span style=color:#000>14</span>   <span style=color:#000>any</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>我在文稿中贴了一段包含 synchronized 代码块的 Java 代码，以及它所编译而成的字节码。你可能会留意到，上面的字节码中包含一个 monitorenter 指令以及多个 monitorexit 指令。这是因为 Java 虚拟机需要确保所获得的锁在正常执行路径，以及异常执行路径上都能够被解锁。</p><p>你可以根据我在介绍异常处理时介绍过的知识，对照字节码和异常处理表来构造所有可能的执行路径，看看在执行了 monitorenter 指令之后，是否都有执行 monitorexit 指令。</p><p>当用 synchronized 标记方法时，你会看到字节码中方法的访问标记包括 ACC_SYNCHRONIZED。该标记表示在进入该方法时，Java 虚拟机需要进行 monitorenter 操作。而在退出该方法时，不管是正常返回，还是向调用者抛异常，Java 虚拟机均需要进行 monitorexit 操作。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>  public synchronized void foo(Object lock) {
</span></span><span style=display:flex><span>    lock.hashCode();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  // 上面的 Java 代码将编译为下面的字节码
</span></span><span style=display:flex><span>  public synchronized void foo(java.lang.Object);
</span></span><span style=display:flex><span>    descriptor: (Ljava/lang/Object;)V
</span></span><span style=display:flex><span>    flags: (0x0021) ACC_PUBLIC, ACC_SYNCHRONIZED
</span></span><span style=display:flex><span>    Code:
</span></span><span style=display:flex><span>      stack=1, locals=2, args_size=2
</span></span><span style=display:flex><span>         0: aload_1
</span></span><span style=display:flex><span>         1: invokevirtual java/lang/Object.hashCode:()I
</span></span><span style=display:flex><span>         4: pop
</span></span><span style=display:flex><span>         5: return
</span></span></code></pre></div><p><strong>这里 monitorenter 和 monitorexit 操作所对应的锁对象是隐式的</strong>。<strong>对于实例方法来说，这两个操作对应的锁对象是 this；对于静态方法来说，这两个操作对应的锁对象则是所在类的 Class 实例。</strong></p><p>关于 monitorenter 和 monitorexit 的作用，我们<strong>可以抽象地理解为每个锁对象拥有一个锁计数器和一个指向持有该锁的线程的指针</strong>。</p><p><strong>当执行 monitorenter 时，如果目标锁对象的计数器为 0，那么说明它没有被其他线程所持有</strong>。<strong>在这个情况下，Java 虚拟机会将该锁对象的持有线程设置为当前线程，并且将其计数器加 1</strong>。</p><p><strong>在目标锁对象的计数器不为 0 的情况下，如果锁对象的持有线程是当前线程，那么 Java 虚拟机可以将其计数器加 1，否则需要等待，直至持有线程释放该锁</strong>。</p><p><strong>当执行 monitorexit 时，Java 虚拟机则需将锁对象的计数器减 1。当计数器减为 0 时，那便代表该锁已经被释放掉了。</strong></p><p><strong>之所以采用这种计数器的方式，是为了允许同一个线程重复获取同一把锁</strong>。举个例子，如果一个 Java 类中拥有多个 synchronized 方法，那么这些方法之间的相互调用，不管是直接的还是间接的，都会涉及对同一把锁的重复加锁操作。因此，我们需要设计这么一个可重入的特性，来避免编程里的隐式约束。</p><p>说完抽象的锁算法，下面我们便来介绍 HotSpot 虚拟机中具体的锁实现。</p><h2 id=重量级锁>重量级锁</h2><p>重量级锁是 Java 虚拟机中最为基础的锁实现。在这种状态下，Java 虚拟机会阻塞加锁失败的线程，并且在目标锁被释放的时候，唤醒这些线程。</p><p><strong>Java 线程的阻塞以及唤醒，都是依靠操作系统来完成的</strong>。举例来说，对于符合 posix 接口的操作系统（如 macOS 和绝大部分的 Linux），上述操作是通过 pthread 的互斥锁（mutex）来实现的。此外，<strong>这些操作将涉及系统调用，需要从操作系统的用户态切换至内核态，其开销非常之大</strong>。</p><p><strong>为了尽量避免昂贵的线程阻塞、唤醒操作，Java 虚拟机会在线程进入阻塞状态之前，以及被唤醒后竞争不到锁的情况下，进入自旋状态，在处理器上空跑并且轮询锁是否被释放。如果此时锁恰好被释放了，那么当前线程便无须进入阻塞状态，而是直接获得这把锁。</strong></p><p>与线程阻塞相比，自旋状态可能会浪费大量的处理器资源。这是因为当前线程仍处于运行状况，只不过跑的是无用指令。它期望在运行无用指令的过程中，锁能够被释放出来。</p><p>我们可以用等红绿灯作为例子。Java 线程的阻塞相当于熄火停车，而自旋状态相当于怠速停车。如果红灯的等待时间非常长，那么熄火停车相对省油一些；如果红灯的等待时间非常短，比如说我们在 synchronized 代码块里只做了一个整型加法，那么在短时间内锁肯定会被释放出来，因此怠速停车更加合适。</p><p>然而，对于 Java 虚拟机来说，它并不能看到红灯的剩余时间，也就没办法根据等待时间的长短来选择自旋还是阻塞。Java 虚拟机给出的方案是<strong>自适应自旋</strong>，<strong>根据以往自旋等待时是否能够获得锁，来动态调整自旋的时间</strong>（循环数目）。</p><p>就我们的例子来说，如果之前不熄火等到了绿灯，那么这次不熄火的时间就长一点；如果之前不熄火没等到绿灯，那么这次不熄火的时间就短一点。</p><p>自旋状态还带来另外一个副作用，那便是<strong>不公平的锁机制</strong>。<strong>处于阻塞状态的线程，并没有办法立刻竞争被释放的锁。然而，处于自旋状态的线程，则很有可能优先获得这把锁</strong>。</p><h2 id=轻量级锁>轻量级锁</h2><p>你可能见到过深夜的十字路口，四个方向都闪黄灯的情况。由于深夜十字路口的车辆来往可能比较少，如果还设置红绿灯交替，那么很有可能出现四个方向仅有一辆车在等红灯的情况。</p><p>因此，红绿灯可能被设置为闪黄灯的情况，代表车辆可以自由通过，但是司机需要注意观察（个人理解，实际意义请咨询交警部门）。</p><p>Java 虚拟机也存在着类似的情形：<strong>多个线程在不同的时间段请求同一把锁，也就是说没有锁竞争</strong>。针对这种情形，Java 虚拟机采用了轻量级锁，来避免重量级锁的阻塞以及唤醒。</p><p>在介绍轻量级锁的原理之前，我们先来了解一下 Java 虚拟机是怎么区分轻量级锁和重量级锁的。</p><p>（你可以参照<a href=https://wiki.openjdk.java.net/display/HotSpot/Synchronization>HotSpot Wiki</a>里这张图阅读。）</p><p>在对象内存布局那一篇中我曾经介绍了<strong>对象头中的标记字段（mark word）</strong>。它的<strong>最后两位</strong>便被用来表示该对象的锁状态。其中，<strong>00 代表轻量级锁，01 代表无锁（或偏向锁），10 代表重量级锁，11 则跟垃圾回收算法的标记有关。</strong></p><p><strong>当进行加锁操作时，Java 虚拟机会判断是否已经是重量级锁。如果不是，它会在当前线程的当前栈桢中划出一块空间，作为该锁的锁记录，并且将锁对象的标记字段复制到该锁记录中。</strong></p><p><strong>然后，Java 虚拟机会尝试用 CAS（compare-and-swap）操作替换锁对象的标记字段。这里解释一下，CAS 是一个原子操作，它会比较目标地址的值是否和期望值相等，如果相等，则替换为一个新的值。</strong></p><p>假设当前锁对象的标记字段为 X…XYZ，Java 虚拟机会比较该字段是否为 X…X01。如果是，则替换为刚才分配的锁记录的地址。由于内存对齐的缘故，它的最后两位为 00。此时，该线程已成功获得这把锁，可以继续执行了。</p><p>如果不是 X…X01，那么有两种可能。第一，该线程重复获取同一把锁。此时，Java 虚拟机会将锁记录清零，以代表该锁被重复获取。第二，其他线程持有该锁。此时，Java 虚拟机会将这把锁膨胀为重量级锁，并且阻塞当前线程。</p><p><strong>当进行解锁操作时，如果当前锁记录（你可以将一个线程的所有锁记录想象成一个栈结构，每次加锁压入一条锁记录，解锁弹出一条锁记录，当前锁记录指的便是栈顶的锁记录）的值为 0，则代表重复进入同一把锁，直接返回即可。</strong></p><p><strong>否则，Java 虚拟机会尝试用 CAS 操作，比较锁对象的标记字段的值是否为当前锁记录的地址。如果是，则替换为锁记录中的值，也就是锁对象原本的标记字段。此时，该线程已经成功释放这把锁。</strong></p><p><strong>如果不是，则意味着这把锁已经被膨胀为重量级锁。此时，Java 虚拟机会进入重量级锁的释放过程，唤醒因竞争该锁而被阻塞了的线程。</strong></p><h2 id=偏向锁>偏向锁</h2><p>如果说轻量级锁针对的情况很乐观，那么接下来的偏向锁针对的情况则更加乐观：<strong>从始至终只有一个线程请求某一把锁。</strong></p><p>这就好比你在私家庄园里装了个红绿灯，并且庄园里只有你在开车。偏向锁的做法便是在红绿灯处识别来车的车牌号。如果匹配到你的车牌号，那么直接亮绿灯。</p><p>具体来说，<strong>在线程进行加锁时，如果该锁对象支持偏向锁，那么 Java 虚拟机会通过 CAS 操作，将当前线程的地址记录在锁对象的标记字段之中，并且将标记字段的最后三位设置为 101</strong>。</p><p><strong>在接下来的运行过程中，每当有线程请求这把锁，Java 虚拟机只需判断锁对象标记字段中：最后三位是否为 101，是否包含当前线程的地址，以及 epoch 值是否和锁对象的类的 epoch 值相同。如果都满足，那么当前线程持有该偏向锁，可以直接返回。</strong></p><p>这里的 epoch 值是一个什么概念呢？</p><p>我们先从偏向锁的撤销讲起。<strong>当请求加锁的线程和锁对象标记字段保持的线程地址不匹配时（而且 epoch 值相等，如若不等，那么当前线程可以将该锁重偏向至自己），Java 虚拟机需要撤销该偏向锁。这个撤销过程非常麻烦，它要求持有偏向锁的线程到达安全点，再将偏向锁替换成轻量级锁。</strong></p><p><strong>如果某一类锁对象的总撤销数超过了一个阈值（对应 Java 虚拟机参数 -XX:BiasedLockingBulkRebiasThreshold，默认为 20），那么 Java 虚拟机会宣布这个类的偏向锁失效。</strong></p><p><strong>具体的做法便是在每个类中维护一个 epoch 值，你可以理解为第几代偏向锁。当设置偏向锁时，Java 虚拟机需要将该 epoch 值复制到锁对象的标记字段中。</strong></p><p><strong>在宣布某个类的偏向锁失效时，Java 虚拟机实则将该类的 epoch 值加 1，表示之前那一代的偏向锁已经失效。而新设置的偏向锁则需要复制新的 epoch 值。</strong></p><p><strong>为了保证当前持有偏向锁并且已加锁的线程不至于因此丢锁，Java 虚拟机需要遍历所有线程的 Java 栈，找出该类已加锁的实例，并且将它们标记字段中的 epoch 值加 1。该操作需要所有线程处于安全点状态。</strong></p><p><strong>如果总撤销数超过另一个阈值（对应 Java 虚拟机参数 -XX:BiasedLockingBulkRevokeThreshold，默认值为 40），那么 Java 虚拟机会认为这个类已经不再适合偏向锁。此时，Java 虚拟机会撤销该类实例的偏向锁，并且在之后的加锁过程中直接为该类实例设置轻量级锁。</strong></p><h2 id=总结与实践>总结与实践</h2><p>今天我介绍了 Java 虚拟机中 synchronized 关键字的实现，按照代价由高至低可分为重量级锁、轻量级锁和偏向锁三种。</p><p><strong>重量级锁会阻塞、唤醒请求加锁的线程。它针对的是多个线程同时竞争同一把锁的情况。Java 虚拟机采取了自适应自旋，来避免线程在面对非常小的 synchronized 代码块时，仍会被阻塞、唤醒的情况。</strong></p><p><strong>轻量级锁采用 CAS 操作，将锁对象的标记字段替换为一个指针，指向当前线程栈上的一块空间，存储着锁对象原本的标记字段。它针对的是多个线程在不同时间段申请同一把锁的情况。</strong></p><p><strong>偏向锁只会在第一次请求时采用 CAS 操作，在锁对象的标记字段中记录下当前线程的地址。在之后的运行过程中，持有该偏向锁的线程的加锁操作将直接返回。它针对的是锁仅会被同一线程持有的情况。</strong></p></div><div class=td-content style=page-break-before:always>
<h1 id=pg-dbe0efdcbae5f047258ef99095d85569>15 - CH99-常用工具</h1><h2 id=1-javap查阅-java-字节码>1. javap：查阅 Java 字节码</h2><p>javap 是一个能够将 class 文件反汇编成人类可读格式的工具。在本专栏中，我们经常借助这个工具来查阅 Java 字节码。</p><p>举个例子，在讲解异常处理那一篇中，我曾经展示过这么一段代码。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>catchBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>finallyBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>methodExit</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>tryBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>catchBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>finallyBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>methodExit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>编译过后，我们便可以使用 javap 来查阅 Foo.test 方法的字节码。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>$</span> <span style=color:#000>javac</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span>
</span></span><span style=display:flex><span><span style=color:#000>$</span> <span style=color:#000>javap</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>v</span> <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span><span style=color:#000>Classfile</span> <span style=color:#ce5c00;font-weight:700>../</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Last</span> <span style=color:#000>modified</span> <span style=color:#ce5c00;font-weight:700>..;</span> <span style=color:#000>size</span> <span style=color:#000>541</span> <span style=color:#000>bytes</span>
</span></span><span style=display:flex><span>  <span style=color:#000>MD5</span> <span style=color:#000>checksum</span> <span style=color:#000>3828cdfbba56fea1da6c8d94fd13b20d</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Compiled</span> <span style=color:#000>from</span> <span style=color:#4e9a06>&#34;Foo.java&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span>  <span style=color:#000>minor</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span>
</span></span><span style=display:flex><span>  <span style=color:#000>major</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>54</span>
</span></span><span style=display:flex><span>  <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0021</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PUBLIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ACC_SUPER</span>
</span></span><span style=display:flex><span>  <span style=color:#000>this_class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>7</span>                          <span style=color:#8f5902;font-style:italic>// Foo
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>super_class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>8</span>                         <span style=color:#8f5902;font-style:italic>// java/lang/Object
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fields</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>1</span>
</span></span><span style=display:flex><span><span style=color:#000>Constant</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>   <span style=color:#a40000>#</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Methodref</span>          <span style=color:#a40000>#</span><span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#a40000>#</span><span style=color:#000>23</span>         <span style=color:#8f5902;font-style:italic>// java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Fieldref</span>           <span style=color:#a40000>#</span><span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#a40000>#</span><span style=color:#000>24</span>         <span style=color:#8f5902;font-style:italic>// Foo.tryBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Fieldref</span>           <span style=color:#a40000>#</span><span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#a40000>#</span><span style=color:#000>25</span>         <span style=color:#8f5902;font-style:italic>// Foo.finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span>              <span style=color:#a40000>#</span><span style=color:#000>26</span>            <span style=color:#8f5902;font-style:italic>// java/lang/Exception
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Fieldref</span>           <span style=color:#a40000>#</span><span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#a40000>#</span><span style=color:#000>27</span>         <span style=color:#8f5902;font-style:italic>// Foo.catchBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>6</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Fieldref</span>           <span style=color:#a40000>#</span><span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#a40000>#</span><span style=color:#000>28</span>         <span style=color:#8f5902;font-style:italic>// Foo.methodExit:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>7</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span>              <span style=color:#a40000>#</span><span style=color:#000>29</span>            <span style=color:#8f5902;font-style:italic>// Foo
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>8</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span>              <span style=color:#a40000>#</span><span style=color:#000>30</span>            <span style=color:#8f5902;font-style:italic>// java/lang/Object
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#a40000>#</span><span style=color:#000>9</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>tryBlock</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>10</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>I</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>11</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>catchBlock</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>12</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>finallyBlock</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>13</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>methodExit</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>14</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>15</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#ce5c00;font-weight:700>()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>16</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>Code</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>17</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>LineNumberTable</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>18</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>test</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>19</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>StackMapTable</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>20</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span>              <span style=color:#a40000>#</span><span style=color:#000>31</span>            <span style=color:#8f5902;font-style:italic>// java/lang/Throwable
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#a40000>#</span><span style=color:#000>21</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>SourceFile</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>22</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>23</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NameAndType</span>        <span style=color:#a40000>#</span><span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#a40000>#</span><span style=color:#000>15</span>        <span style=color:#8f5902;font-style:italic>// &#34;&lt;init&gt;&#34;:()V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#a40000>#</span><span style=color:#000>24</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NameAndType</span>        <span style=color:#a40000>#</span><span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#a40000>#</span><span style=color:#000>10</span>         <span style=color:#8f5902;font-style:italic>// tryBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#a40000>#</span><span style=color:#000>25</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NameAndType</span>        <span style=color:#a40000>#</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#a40000>#</span><span style=color:#000>10</span>        <span style=color:#8f5902;font-style:italic>// finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#a40000>#</span><span style=color:#000>26</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>27</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NameAndType</span>        <span style=color:#a40000>#</span><span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#a40000>#</span><span style=color:#000>10</span>        <span style=color:#8f5902;font-style:italic>// catchBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#a40000>#</span><span style=color:#000>28</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NameAndType</span>        <span style=color:#a40000>#</span><span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#a40000>#</span><span style=color:#000>10</span>        <span style=color:#8f5902;font-style:italic>// methodExit:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#a40000>#</span><span style=color:#000>29</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>30</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Object</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>31</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Throwable</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0002</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PRIVATE</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>catchBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0002</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PRIVATE</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>finallyBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0002</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PRIVATE</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>methodExit</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0002</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PRIVATE</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0001</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PUBLIC</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>      <span style=color:#000>stack</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>locals</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args_size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1</span>
</span></span><span style=display:flex><span>         <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>         <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>1</span>                  <span style=color:#8f5902;font-style:italic>// Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>      <span style=color:#000>LineNumberTable</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0001</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PUBLIC</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>      <span style=color:#000>stack</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>locals</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args_size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1</span>
</span></span><span style=display:flex><span>         <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>         <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_0</span>
</span></span><span style=display:flex><span>         <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>2</span>                  <span style=color:#8f5902;font-style:italic>// Field tryBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>         <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
</span></span><span style=display:flex><span>         <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>3</span>                  <span style=color:#8f5902;font-style:italic>// Field finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>goto</span>          <span style=color:#000>35</span>
</span></span><span style=display:flex><span>        <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>15</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>5</span>                  <span style=color:#8f5902;font-style:italic>// Field catchBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>3</span>                  <span style=color:#8f5902;font-style:italic>// Field finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>24</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>goto</span>          <span style=color:#000>35</span>
</span></span><span style=display:flex><span>        <span style=color:#000>27</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>astore_2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>28</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>29</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>30</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>3</span>                  <span style=color:#8f5902;font-style:italic>// Field finallyBlock:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>33</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>34</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>athrow</span>
</span></span><span style=display:flex><span>        <span style=color:#000>35</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>36</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>iconst_3</span>
</span></span><span style=display:flex><span>        <span style=color:#000>37</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>putfield</span>      <span style=color:#a40000>#</span><span style=color:#000>6</span>                  <span style=color:#8f5902;font-style:italic>// Field methodExit:I
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>40</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Exception</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>         <span style=color:#000>from</span>    <span style=color:#000>to</span>  <span style=color:#000>target</span> <span style=color:#000>type</span>
</span></span><span style=display:flex><span>             <span style=color:#000>0</span>     <span style=color:#000>5</span>    <span style=color:#000>13</span>   <span style=color:#000>Class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span>
</span></span><span style=display:flex><span>             <span style=color:#000>0</span>     <span style=color:#000>5</span>    <span style=color:#000>27</span>   <span style=color:#000>any</span>
</span></span><span style=display:flex><span>            <span style=color:#000>13</span>    <span style=color:#000>19</span>    <span style=color:#000>27</span>   <span style=color:#000>any</span>
</span></span><span style=display:flex><span>      <span style=color:#000>LineNumberTable</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>5</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>10</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>13</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>14</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>19</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>24</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>27</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>33</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>15</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>35</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>40</span>
</span></span><span style=display:flex><span>      <span style=color:#000>StackMapTable</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>number_of_entries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span>
</span></span><span style=display:flex><span>        <span style=color:#000>frame_type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>77</span> <span style=color:#8f5902;font-style:italic>/* same_locals_1_stack_item */</span>
</span></span><span style=display:flex><span>          <span style=color:#000>stack</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>frame_type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>77</span> <span style=color:#8f5902;font-style:italic>/* same_locals_1_stack_item */</span>
</span></span><span style=display:flex><span>          <span style=color:#000>stack</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>frame_type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>7</span> <span style=color:#8f5902;font-style:italic>/* same */</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#f57900>SourceFile:</span> <span style=color:#4e9a06>&#34;Foo.java&#34;</span>
</span></span></code></pre></div><p>这里面我用到了两个选项。第一个选项是 -p。默认情况下 javap 会打印所有非私有的字段和方法，当加了 -p 选项后，它还将打印私有的字段和方法。第二个选项是 -v。它尽可能地打印所有信息。如果你只需要查阅方法对应的字节码，那么可以用 -c 选项来替换 -v。</p><p><strong>javap 的 -v 选项的输出分为几大块。</strong></p><h3 id=1-基本信息涵盖了原-class-文件的相关信息>1. 基本信息，涵盖了原 class 文件的相关信息。</h3><p>class 文件的版本号（minor version: 0，major version: 54），该类的访问权限（flags: (0x0021) ACC_PUBLIC, ACC_SUPER），该类（this_class: #7）以及父类（super_class: #8）的名字，所实现接口（interfaces: 0）、字段（fields: 4）、方法（methods: 2）以及属性（attributes: 1）的数目。</p><p>这里属性指的是 class 文件所携带的辅助信息，比如该 class 文件的源文件的名称。这类信息通常被用于 Java 虚拟机的验证和运行，以及 Java 程序的调试，一般无须深入了解。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Classfile</span> <span style=color:#ce5c00;font-weight:700>../</span><span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Last</span> <span style=color:#000>modified</span> <span style=color:#ce5c00;font-weight:700>..;</span> <span style=color:#000>size</span> <span style=color:#000>541</span> <span style=color:#000>bytes</span>
</span></span><span style=display:flex><span>  <span style=color:#000>MD5</span> <span style=color:#000>checksum</span> <span style=color:#000>3828cdfbba56fea1da6c8d94fd13b20d</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Compiled</span> <span style=color:#000>from</span> <span style=color:#4e9a06>&#34;Foo.java&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span>
</span></span><span style=display:flex><span>  <span style=color:#000>minor</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span>
</span></span><span style=display:flex><span>  <span style=color:#000>major</span> <span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>54</span>
</span></span><span style=display:flex><span>  <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0021</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PUBLIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ACC_SUPER</span>
</span></span><span style=display:flex><span>  <span style=color:#000>this_class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>7</span>                          <span style=color:#8f5902;font-style:italic>// Foo
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>super_class</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#a40000>#</span><span style=color:#000>8</span>                         <span style=color:#8f5902;font-style:italic>// java/lang/Object
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fields</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>1</span>
</span></span></code></pre></div><p>class 文件的版本号指的是编译生成该 class 文件时所用的 JRE 版本。由较新的 JRE 版本中的 javac 编译而成的 class 文件，不能在旧版本的 JRE 上跑，否则，会出现如下异常信息。（Java 8 对应的版本号为 52，Java 10 对应的版本号为 54。）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Exception in thread &#34;main&#34; java.lang.UnsupportedClassVersionError: Foo has been compiled by a more recent version of the Java Runtime (class file version 54.0), this version of the Java Runtime only recognizes class file versions up to 52.0
</span></span></code></pre></div><p>类的访问权限通常为 ACC_ 开头的常量。具体每个常量的意义可以查阅 Java 虚拟机规范 4.1 小节 [1]。</p><h3 id=2-常量池用来存放各种常量以及符号引用>2. 常量池，用来存放各种常量以及符号引用。</h3><p>常量池中的每一项都有一个对应的索引（如 #1），并且可能引用其他的常量池项（#1 = Methodref #8.#23）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Constant</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>   <span style=color:#a40000>#</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Methodref</span>          <span style=color:#a40000>#</span><span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#a40000>#</span><span style=color:#000>23</span>         <span style=color:#8f5902;font-style:italic>// java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>...</span> 
</span></span><span style=display:flex><span>   <span style=color:#a40000>#</span><span style=color:#000>8</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span>              <span style=color:#a40000>#</span><span style=color:#000>30</span>            <span style=color:#8f5902;font-style:italic>// java/lang/Object
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>14</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>15</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#ce5c00;font-weight:700>()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>23</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NameAndType</span>        <span style=color:#a40000>#</span><span style=color:#000>14</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#a40000>#</span><span style=color:#000>15</span>        <span style=color:#8f5902;font-style:italic>// &#34;&lt;init&gt;&#34;:()V
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>#</span><span style=color:#000>30</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Utf8</span>               <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Object</span>
</span></span></code></pre></div><p>举例来说，上图中的 1 号常量池项是一个指向 Object 类构造器的符号引用。它是由另外两个常量池项所构成。如果将它看成一个树结构的话，那么它的叶节点会是字符串常量，如下图所示。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220223232229.png style=display:block;margin-left:auto;margin-right:auto;width:60% alt=20220223232229></div><h3 id=3-字段区域用来列举该类中的各个字段>3. 字段区域，用来列举该类中的各个字段。</h3><p>这里最主要的信息便是该字段的类型（descriptor: I）以及访问权限（flags: (0x0002) ACC_PRIVATE）。对于声明为 final 的静态字段而言，如果它是基本类型或者字符串类型，那么字段区域还将包括它的常量值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>I</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0002</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PRIVATE</span>
</span></span><span style=display:flex><span> 
</span></span></code></pre></div><p>另外，Java 虚拟机同样使用了“描述符”（descriptor）来描述字段的类型。具体的对照如下表所示。其中比较特殊的，我已经高亮显示。</p><h3 id=4-方法区域用来列举该类中的各个方法>4. 方法区域，用来列举该类中的各个方法。</h3><p>除了方法描述符以及访问权限之外，每个方法还包括最为重要的代码区域（Code:)。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>()</span><span style=color:#000>V</span>
</span></span><span style=display:flex><span>    <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0x0001</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ACC_PUBLIC</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>      <span style=color:#000>stack</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>locals</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args_size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1</span>
</span></span><span style=display:flex><span>         <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>goto</span>          <span style=color:#000>35</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>34</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>athrow</span>
</span></span><span style=display:flex><span>        <span style=color:#000>35</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>40</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Exception</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>         <span style=color:#000>from</span>    <span style=color:#000>to</span>  <span style=color:#000>target</span> <span style=color:#000>type</span>
</span></span><span style=display:flex><span>             <span style=color:#000>0</span>     <span style=color:#000>5</span>    <span style=color:#000>13</span>   <span style=color:#000>Class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span>
</span></span><span style=display:flex><span>             <span style=color:#000>0</span>     <span style=color:#000>5</span>    <span style=color:#000>27</span>   <span style=color:#000>any</span>
</span></span><span style=display:flex><span>            <span style=color:#000>13</span>    <span style=color:#000>19</span>    <span style=color:#000>27</span>   <span style=color:#000>any</span>
</span></span><span style=display:flex><span>      <span style=color:#000>LineNumberTable</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>9</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>line</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>40</span>
</span></span><span style=display:flex><span>      <span style=color:#000>StackMapTable</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>number_of_entries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span>
</span></span><span style=display:flex><span>        <span style=color:#000>frame_type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>77</span> <span style=color:#8f5902;font-style:italic>/* same_locals_1_stack_item */</span>
</span></span><span style=display:flex><span>          <span style=color:#000>stack</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span></code></pre></div><p>代码区域一开始会声明该方法中的操作数栈（stack=2）和局部变量数目（locals=3）的最大值，以及该方法接收参数的个数（args_size=1）。注意这里局部变量指的是字节码中的局部变量，而非 Java 程序中的局部变量。</p><p>接下来则是该方法的字节码。每条字节码均标注了对应的偏移量（bytecode index，BCI），这是用来定位字节码的。比如说偏移量为 10 的跳转字节码 10: goto 35，将跳转至偏移量为 35 的字节码 35: aload_0。</p><p>紧跟着的异常表（Exception table:）也会使用偏移量来定位每个异常处理器所监控的范围（由 from 到 to 的代码区域），以及异常处理器的起始位置（target）。除此之外，它还会声明所捕获的异常类型（type）。其中，any 指代任意异常类型。</p><p>再接下来的行数表（LineNumberTable:）则是 Java 源程序到字节码偏移量的映射。如果你在编译时使用了 -g 参数（javac -g Foo.java），那么这里还将出现局部变量表（LocalVariableTable:），展示 Java 程序中每个局部变量的名字、类型以及作用域。</p><p>行数表和局部变量表均属于调试信息。Java 虚拟机并不要求 class 文件必备这些信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>      <span style=color:#000>LocalVariableTable</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Start</span>  <span style=color:#000>Length</span>  <span style=color:#000>Slot</span>  <span style=color:#000>Name</span>   <span style=color:#000>Signature</span>
</span></span><span style=display:flex><span>           <span style=color:#000>14</span>       <span style=color:#000>5</span>     <span style=color:#000>1</span>     <span style=color:#000>e</span>   <span style=color:#000>Ljava</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>0</span>      <span style=color:#000>41</span>     <span style=color:#000>0</span>  <span style=color:#204a87;font-weight:700>this</span>   <span style=color:#000>LFoo</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><p>最后则是字节码操作数栈的映射表（StackMapTable: number_of_entries = 3）。该表描述的是字节码跳转后操作数栈的分布情况，一般被 Java 虚拟机用于验证所加载的类，以及即时编译相关的一些操作，正常情况下，你无须深入了解。</p><h2 id=2-openjdk-项目-code-tools实用小工具集>2. OpenJDK 项目 Code Tools：实用小工具集</h2><p>OpenJDK 的 Code Tools 项目 [2] 包含了好几个实用的小工具。</p><p>在第一篇的实践环节中，我们使用了其中的字节码汇编器反汇编器 ASMTools[3]，当前 6.0 版本的下载地址位于 [4]。ASMTools 的反汇编以及汇编操作所对应的命令分别为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ java -cp /path/to/asmtools.jar org.openjdk.asmtools.jdis.Main Foo.class &gt; Foo.jasm
</span></span></code></pre></div><p>和</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ java -cp /path/to/asmtools.jar org.openjdk.asmtools.jasm.Main Foo.jasm
</span></span></code></pre></div><p>该反汇编器的输出格式和 javap 的不尽相同。一般我只使用它来进行一些简单的字节码修改，以此生成无法直接由 Java 编译器生成的类，它在 HotSpot 虚拟机自身的测试中比较常见。</p><p>在第一篇的实践环节中，我们需要将整数 2 赋值到一个声明为 boolean 类型的局部变量中。我采取的做法是将编译生成的 class 文件反汇编至一个文本文件中，然后找到 boolean flag = true 对应的字节码序列，也就是下面的两个。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>iconst_1</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>istore_1</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><p>将这里的 iconst_1 改为 iconst_2[5]，保存后再汇编至 class 文件即可完成第一篇实践环节的需求。</p><p>除此之外，你还可以利用这一套工具来验证我之前文章中的一些结论。比如我说过 class 文件允许出现参数类型相同、而返回类型不同的方法，并且，在作为库文件时 Java 编译器将使用先定义的那一个，来决定具体的返回类型。</p><p>具体的验证方法便是在反汇编之后，利用文本编辑工具复制某一方法，并且更改该方法的描述符，保存后再汇编至 class 文件。</p><p>Code Tools 项目还包含另一个实用的小工具 JOL[6]，当前 0.9 版本的下载地址位于 [7]。JOL 可用于查阅 Java 虚拟机中对象的内存分布，具体可通过如下两条指令来实现。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ java -jar /path/to/jol-cli-0.9-full.jar internals java.util.HashMap
</span></span><span style=display:flex><span>$ java -jar /path/to/jol-cli-0.9-full.jar estimates java.util.HashMap
</span></span></code></pre></div><h2 id=3-asmjava-字节码框架>3. ASM：Java 字节码框架</h2><p>ASM[8] 是一个字节码分析及修改框架。它被广泛应用于许多项目之中，例如 Groovy、Kotlin 的编译器，代码覆盖测试工具 Cobertura、JaCoCo，以及各式各样通过字节码注入实现的程序行为监控工具。甚至是 Java 8 中 Lambda 表达式的适配器类，也是借助 ASM 来动态生成的。</p><p>ASM 既可以生成新的 class 文件，也可以修改已有的 class 文件。前者相对比较简单一些。ASM 甚至还提供了一个辅助类 ASMifier，它将接收一个 class 文件并且输出一段生成该 class 文件原始字节数组的代码。如果你想快速上手 ASM 的话，那么你可以借助 ASMifier 生成的代码来探索各个 API 的用法。</p><p>下面我将借助 ASMifier，来生成第一篇实践环节所用到的类。（你可以通过该地址 [9] 下载 6.0-beta 版。）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>public class Foo {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> public static void main(String[] args) {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  boolean flag = true;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  if (flag) System.out.println(&#34;Hello, Java!&#34;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  if (flag == true) System.out.println(&#34;Hello, JVM!&#34;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}&#39;</span> &gt; Foo.java
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 这里的 javac 我使用的是 Java 8 版本的。ASM 6.0 可能暂不支持新版本的 javac 编译出来的 class 文件</span>
</span></span><span style=display:flex><span>$ javac Foo.java
</span></span><span style=display:flex><span>$ java -cp /PATH/TO/asm-all-6.0_BETA.jar org.objectweb.asm.util.ASMifier Foo.class <span style=color:#000;font-weight:700>|</span> tee FooDump.java
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>public class FooDump implements Opcodes <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>public static byte<span style=color:#ce5c00;font-weight:700>[]</span> dump <span style=color:#ce5c00;font-weight:700>()</span> throws Exception <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>ClassWriter <span style=color:#000>cw</span> <span style=color:#ce5c00;font-weight:700>=</span> new ClassWriter<span style=color:#ce5c00;font-weight:700>(</span>0<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>FieldVisitor fv<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>MethodVisitor mv<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>AnnotationVisitor av0<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>cw.visit<span style=color:#ce5c00;font-weight:700>(</span>V1_8, ACC_PUBLIC + ACC_SUPER, <span style=color:#4e9a06>&#34;Foo&#34;</span>, null, <span style=color:#4e9a06>&#34;java/lang/Object&#34;</span>, null<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#000>mv</span> <span style=color:#ce5c00;font-weight:700>=</span> cw.visitMethod<span style=color:#ce5c00;font-weight:700>(</span>ACC_PUBLIC + ACC_STATIC, <span style=color:#4e9a06>&#34;main&#34;</span>, <span style=color:#4e9a06>&#34;([Ljava/lang/String;)V&#34;</span>, null, null<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>mv.visitCode<span style=color:#ce5c00;font-weight:700>()</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>mv.visitInsn<span style=color:#ce5c00;font-weight:700>(</span>ICONST_1<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>mv.visitVarInsn<span style=color:#ce5c00;font-weight:700>(</span>ISTORE, 1<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>mv.visitVarInsn<span style=color:#ce5c00;font-weight:700>(</span>ILOAD, 1<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>mv.visitInsn<span style=color:#ce5c00;font-weight:700>(</span>RETURN<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>mv.visitMaxs<span style=color:#ce5c00;font-weight:700>(</span>2, 2<span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>mv.visitEnd<span style=color:#ce5c00;font-weight:700>()</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>可以看到，ASMifier 生成的代码中包含一个名为 FooDump 的类，其中定义了一个名为 dump 的方法。该方法将返回一个 byte 数组，其值为生成类的原始字节。</p><p>在 dump 方法中，我们新建了功能类 ClassWriter 的一个实例，并通过它来访问不同的成员，例如方法、字段等等。</p><p>每当访问一种成员，我们便会得到另一个访问者。在上面这段代码中，当我们访问方法时（即 visitMethod），便会得到一个 MethodVisitor。在接下来的代码中，我们会用这个 MethodVisitor 来访问（这里等同于生成）具体的指令。</p><p>这便是 ASM 所使用的访问者模式。当然，这段代码仅包含 ClassWriter 这一个访问者，因此看不出具体有什么好处。</p><p>我们暂且不管这个访问者模式，先来看看如何实现第一篇课后实践的要求。首先，main 方法中的 boolean flag = true; 语句对应的代码是：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ICONST_1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitVarInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ISTORE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>也就是说，我们只需将这里的 ICONST_1 更改为 ICONST_2，便可以满足要求。下面我用另一个类 Wrapper，来调用修改过后的 FooDump.dump 方法。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;import java.nio.file.*;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06> 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>public class Wrapper {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  public static void main(String[] args) throws Exception {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    Files.write(Paths.get(&#34;Foo.class&#34;), FooDump.dump());
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}&#39;</span> &gt; Wrapper.java
</span></span><span style=display:flex><span>$ javac -cp /PATH/TO/asm-all-6.0_BETA.jar FooDump.java Wrapper.java
</span></span><span style=display:flex><span>$ java -cp /PATH/TO/asm-all-6.0_BETA.jar:. Wrapper
</span></span><span style=display:flex><span>$ java Foo
</span></span></code></pre></div><p>这里的输出结果应和通过 ASMTools 修改的结果一致。</p><p>通过 ASM 来修改已有 class 文件则相对复杂一些。不过我们可以从下面这段简单的代码来开始学起：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassReader</span> <span style=color:#000>cr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Foo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassWriter</span> <span style=color:#000>cw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassWriter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>COMPUTE_FRAMES</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>cr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cw</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SKIP_FRAMES</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Files</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Paths</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Foo.class&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>cw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toByteArray</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这段代码的功能便是读取一个 class 文件，将之转换为 ASM 的数据结构，然后再转换为原始字节数组。其中，我使用了两个功能类。除了已经介绍过的 ClassWriter 外，还有一个 ClassReader。</p><p>ClassReader 将读取“Foo”类的原始字节，并且翻译成对应的访问请求。也就是说，在上面 ASMifier 生成的代码中的各个访问操作，现在都交给 ClassReader.accept 这一方法来发出了。</p><p>那么，如何修改这个 class 文件的字节码呢？原理很简单，就是将 ClassReader 的访问请求发给另外一个访问者，再由这个访问者委派给 ClassWriter。</p><p>这样一来，新增操作可以通过在某一需要转发的请求后面附带新的请求来实现；删除操作可以通过不转发请求来实现；修改操作可以通过忽略原请求，新建并发出另外的请求来实现。</p><div><img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20220223232257.png style=display:block;margin-left:auto;margin-right:auto;width:80% alt=20220223232257></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.nio.file.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.objectweb.asm.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ASMHelper</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Opcodes</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyMethodVisitor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MethodVisitor</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MethodVisitor</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyMethodVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>api</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodVisitor</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>api</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>visitCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitFieldInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>GETSTATIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;java/lang/System&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;out&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Ljava/io/PrintStream;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitLdcInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, World!&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitMethodInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>INVOKEVIRTUAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;java/io/PrintStream&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;println&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;(Ljava/lang/String;)V&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitInsn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RETURN</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitMaxs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000>mv</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitEnd</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyClassVisitor</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ClassVisitor</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyClassVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>api</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassVisitor</span> <span style=color:#000>cv</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>api</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cv</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MethodVisitor</span> <span style=color:#000>visitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>access</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>signature</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>exceptions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>MethodVisitor</span> <span style=color:#000>visitor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>visitMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>access</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>signature</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exceptions</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;main&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyMethodVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ASM6</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>visitor</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassReader</span> <span style=color:#000>cr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Foo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassWriter</span> <span style=color:#000>cw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassWriter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>COMPUTE_FRAMES</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClassVisitor</span> <span style=color:#000>cv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyClassVisitor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ASM6</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cw</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>cr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SKIP_FRAMES</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Files</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Paths</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Foo.class&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>cw</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toByteArray</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这里我贴了一段代码，在 ClassReader 和 ClassWriter 中间插入了一个自定义的访问者 MyClassVisitor。它将截获由 ClassReader 发出的对名字为“main”的方法的访问请求，并且替换为另一个自定义的 MethodVisitor。</p><p>这个 MethodVisitor 会忽略由 ClassReader 发出的任何请求，仅在遇到 visitCode 请求时，生成一句“System.out.println(“Hello World!”);”。</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 infilos.com All Rights Reserved</small>
</div></div></div></footer></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.3f3f4f1e22307ccbb13271a98be2e4dbb8386b7e67c3d606db44d3d0649f485e.js integrity="sha256-Pz9PHiIwfMuxMnGpi+Lk27g4a35nw9YG20TT0GSfSF4=" crossorigin=anonymous></script>
</body></html>