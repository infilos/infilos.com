<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.92.2">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Java 基础 | infilos.com</title><meta property="og:title" content="Java 基础">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Java 基础">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Java 基础">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Java 基础</h1>
<ul>
<li>1: <a href=#pg-e1db212d12351161d48050f0f381f7c4>CH01-面向对象</a></li>
<li>2: <a href=#pg-f726ea2046bedecf6cb9f08310041837>CH02-基本知识</a></li>
<li>3: <a href=#pg-4cad2acc9d30ff525a7e1eaa4c81f679>CH03-基本图谱</a></li>
<li>4: <a href=#pg-b55749cae60e608c7ca23e6a61d68cb6>CH04-泛型机制</a></li>
<li>5: <a href=#pg-b8f50da20bead099ffecc9e2ee818530>CH05-注解机制</a></li>
<li>6: <a href=#pg-f947a3a008aa40dbb8eed80c6ed1d899>CH06-异常机制</a></li>
<li>7: <a href=#pg-1782eebed124e635eda873f42d596c92>CH07-反射机制</a></li>
<li>8: <a href=#pg-4a27de20847a48405d85a4161174c1ee>CH08-SPI 机制</a></li>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-e1db212d12351161d48050f0f381f7c4>1 - CH01-面向对象</h1>
<h2 id=三大特性>三大特性</h2>
<h3 id=封装>封装</h3>
<p>利用抽象数据类型将数据和基于数据的操作封装在一起，使其构成一个不可分割的独立实体。数据被保护在抽象数据类型的内部，尽可能的隐藏内部的细节，只保留一些对外接口使其与外部发生关系。用户无需知道对象内部的细节，但可以通过对象所提供的接口来访问对象。</p>
<blockquote>
<p>优点：</p>
<ul>
<li>减少耦合：可以独立的开发、测试、优化、使用、理解、修改</li>
<li>减少维护负担：可以更容易的被其他开发者理解，并且在调试的时候可以不影响其他模块</li>
<li>有效的调节性能：可以通过剖析确定哪些模块影响了系统的性能</li>
<li>提高软件的可重用性</li>
<li>降低了构建大型系统的风险：即使整个系统不可用，但是这些独立的模块却有可能是可用的</li>
</ul>
</blockquote>
<h3 id=继承>继承</h3>
<p>继承实现了 IS-A 关系，比如 Cat 和 Animal 就是一种 IS-A 关系，因此 Cat 可以继承自 Animal，从而获得属于 Animal 的非私有的属性和方法。</p>
<p>继承应该遵循里氏替换原则，子类对象必须能够替换掉父类对象(可以直接将子类对象看做是父类对象)。</p>
<p>Cat 可以当做 Animal 来使用，也就是说可以使用 Animal 引用 Cat 对象。父类引用指向子类对象称为 <strong>向上转型</strong>。</p>
<h3 id=多态>多态</h3>
<p>多态分为编译时多态和运行时多态：</p>
<blockquote>
<ul>
<li>编译时多态主要指方法的重载</li>
<li>运行时多态指程序中定义的对象引用所指向的具体类型在运行期才确定</li>
</ul>
</blockquote>
<p>运行时多态有三个条件：</p>
<blockquote>
<ul>
<li>继承</li>
<li>覆写</li>
<li>向上转型</li>
</ul>
</blockquote>
<h2 id=类图>类图</h2>
<h3 id=泛化关系>泛化关系</h3>
<p>Java extend。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407001857.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=实现关系>实现关系</h3>
<p>Java implement。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407002106.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=聚合关系>聚合关系</h3>
<p>表示整体由部分组成，但是整体和部分不是强依赖，整体不存在了部分还会存在。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/image-20210407002223139.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=组合关系>组合关系</h3>
<p>和聚合不同，组合中整体和部分是强依赖的，整体不存在了部分也不存在了。比如公司和部门，公司没了部门就不存在了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407002455.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=关联关系>关联关系</h3>
<p>表示不同类对象之间有关联，这是一种静态关系，与运行过程的状态无关，在最开始就是可以确定的。因此也可以用一对一、一对多、多对一、多对多这种表述来表示。</p>
<p>比如学生和学校就是一种关联关系，一个学校可以有多个学生，但是一个学生只属于一个学校，因此这是一种多对一关系，在运行开始就能确定。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407003751.png style=display:block;width:20% alt=NAME align=center> </div>
<h3 id=依赖关系>依赖关系</h3>
<p>依赖关系是在运行中起作用的。A 类对 B 类的依赖关系主要有三种形式：</p>
<blockquote>
<ul>
<li>A 类是 B 类中的局部变量</li>
<li>A 类是 B 类方法中的参数</li>
<li>A 类向 B 类发送消息，从而影响 B 类</li>
</ul>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407004935.png style=display:block;width:20% alt=NAME align=center> </div>
<p>Vihicle 的 move 方法接收一个 MoveBehavior 对象作为参数来实现移动逻辑，而 MoveBehavior 可能的实现是向上或向下移动。</p>
<h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://www.pdai.tech/md/java/basic/java-basic-oop.html>Java 基础 - 面向对象</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f726ea2046bedecf6cb9f08310041837>2 - CH02-基本知识</h1>
<h2 id=数据类型>数据类型</h2>
<h3 id=包装类型>包装类型</h3>
<p>八个基本类型：</p>
<blockquote>
<ul>
<li>boolean：1</li>
<li>byte：8</li>
<li>char：16</li>
<li>short：16</li>
<li>int：32</li>
<li>float：32</li>
<li>long：64</li>
<li>double：64</li>
</ul>
</blockquote>
<p>基本类型都拥有对应的包装类型，它们之间的赋值使用自动装箱与拆箱完成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Integer</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>	<span style=color:#8f5902;font-style:italic>// 装箱
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>			<span style=color:#8f5902;font-style:italic>// 拆箱
</span></code></pre></div><h3 id=缓存池>缓存池</h3>
<p><code>new Integer(21)</code> 与 <code>Integer.valueOf(21)</code> 的区别在于：</p>
<ul>
<li>前者每次都会创建一个新的对象</li>
<li>后者会使用缓存池中的对象，多次调用会获得同一个对象的引用</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Integer</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Integer</span> <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>);</span>	<span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Integer</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Integer</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>	<span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p><code>valueOf()</code> 方法的实现比较简单，它会先判断值是否在缓存池中，有则返回否则新建并返回。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Integer</span> <span style=color:#000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>IngegerCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>low</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>high</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>IntegerCache</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>IngegerCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>low</span><span style=color:#ce5c00;font-weight:700>)];</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 Java 8 中，Integer 缓存池的大小默认为 -128 至 127。</p>
<p>编译器会<strong>在缓冲池范围内的基本类型</strong>自动装箱过程中调用 <code>valueOf</code> 方法，因此多个取值相同的 Integer 实例在使用自动装箱来创建时，会引用相同的对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Integer</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Integer</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>基本类型对应的缓冲池如下：</p>
<blockquote>
<p>boolean: true, false</p>
<p>all byte values</p>
<p>short values between -128 to 127</p>
<p>int values between -128 to 127</p>
<p>char in range \u0000 to \u007F</p>
</blockquote>
<h2 id=string>String</h2>
<h3 id=概览>概览</h3>
<p>String 被声明为 final，因此不可被继承。</p>
<p>其内部使用 char 数组存储数据，该数据也被声明为 final，表示该 value 数组初始化之后便不能再被修改。并且没有提供修改该数组的方法，因此可以保证 String 不可变。</p>
<h3 id=不可变的好处>不可变的好处</h3>
<ol>
<li><strong>可以缓存哈希值</strong></li>
</ol>
<p>因为 String 的 hash 值经常被使用，比如 String 作为 HashMap 的 key。不可变使得其 hash 值也不会变，因此仅需计算一次。</p>
<ol start=2>
<li>String Pool 的需要</li>
</ol>
<p>如果一个 String 对象已经被创建过了，那么就会从 String Pool 中取得引用。只有 String 是不可变的，才可能使用 String Pool。</p>
<ol start=3>
<li>安全性</li>
</ol>
<p>String 经常被作为参数类型，String 不可变性可以保证参数不可变。</p>
<ol start=4>
<li>线程安全</li>
</ol>
<p>不可变特性天生具备线程安全性，可以在多个线程中并发使用。</p>
<blockquote>
<p><a href=https://www.programcreek.com/2013/04/why-string-is-immutable-in-java/>Program Creek: Why String is immutable in Java?</a></p>
</blockquote>
<h3 id=string-stringbuffer-string-builder>String, StringBuffer, String Builder</h3>
<ul>
<li>可变性
<ul>
<li>String 不可变</li>
<li>StringBuffer、StringBuilder 可变</li>
</ul>
</li>
<li>线程安全
<ul>
<li>String 不可变，即线程安全</li>
<li>StringBuilder 非线程安全</li>
<li>StringBuffer 保证线程安全，内部使用 synchronized 实现同步</li>
</ul>
</li>
</ul>
<blockquote>
<p><a href=https://stackoverflow.com/questions/2971315/string-stringbuffer-and-stringbuilder>StackOverflow : String, StringBuffer, and StringBuilder</a></p>
</blockquote>
<h3 id=stirngintern>Stirng.intern()</h3>
<p>使用 <code>Stirng.intern()</code> 可以保证相同内容的字符串变量引用同一个内存对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aaa&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>String</span> <span style=color:#000>s2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aaa&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s2</span><span style=color:#ce5c00;font-weight:700>);</span>           <span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>String</span> <span style=color:#000>s3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intern</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s3</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>如果直接使用 <code>"bbb"</code> 这种形式而非 new 来创建字符串实例，会自动将其放入 String Pool 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>s4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bbb&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>String</span> <span style=color:#000>s5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bbb&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s4</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s5</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>在 Java 7 之前，字符串常量池被放在运行时常量池中，属于永久代。在 Java 7 中，字符串常量池被移到 Native Method 中。这是因为永久代的空间有限，在大量使用字符串的场景下会导致 OOM。</p>
<blockquote>
<ul>
<li><a href=https://stackoverflow.com/questions/10578984/what-is-string-interning>What is Java String interning? - Stack Overflow</a></li>
<li><a href=https://tech.meituan.com/in_depth_understanding_string_intern.html>深入解析 String#intern (opens new window) (meituan.com)</a></li>
</ul>
</blockquote>
<h2 id=运算>运算</h2>
<h3 id=参数传递>参数传递</h3>
<p>Java 中的参数是以<strong>值传递</strong>的形式传入方法中，而不是引用传递。(这里的值值得是引用的地址值)</p>
<p>以下代码中，<code>Dog dog</code> 是一个指针，存储的是对象的地址值。在将一个参数传入一个方法时，本质上是将对象的地址以值的形式传递到形参中。因此在方法中改变指针引用的对象，那么这两个指针将指向不同的对象，一方改变自身指向的对象不会对另一方产生影响。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>String</span> <span style=color:#000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PassByValueExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@4554617c
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@4554617c
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>          <span style=color:#8f5902;font-style:italic>// A
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span> <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@4554617c
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;B&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@74a14482
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>          <span style=color:#8f5902;font-style:italic>// B
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是如果在方法中改变对象的字段值，则会改变原对象的字段值，因为改变的是同一个地址指向的内容。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PassByValueExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>          <span style=color:#8f5902;font-style:italic>// B
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span> <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;B&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p><a href=https://stackoverflow.com/questions/40480/is-java-pass-by-reference-or-pass-by-value>StackOverflow: Is Java “pass-by-reference” or “pass-by-value”? </a></p>
</blockquote>
<h3 id=float-与-double>float 与 double</h3>
<p><code>1.1</code> 这样的字面量属于 double 类型，不能直接将其赋值给 float 变量，因为是向下转型。Java 不能隐式执行向下转型，因为会使得精度降低。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>1</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// error
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>1f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// right
</span></code></pre></div><h3 id=隐式类型转换>隐式类型转换</h3>
<p>因为字面量 <code>1</code> 是 int 类型，它比 short 类型精度要高，因此不能隐式的将 int 类型向下转型为 short 类型。</p>
<p>但是使用 <code>+=</code> 运算可以执行隐式类型转换：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>short</span> <span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>// s1 = s1 + 1;
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>这其实相当于将 <code>s1 + 1</code> 的计算结果执行了向下转型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><blockquote>
<p><a href=https://stackoverflow.com/questions/8710619/why-dont-javas-compound-assignment-operators-require-casting>StackOverflow : Why don&rsquo;t Java&rsquo;s +=, -=, *=, /= compound assignment operators require casting? </a></p>
</blockquote>
<h3 id=switch>switch</h3>
<p>从 Java 7 开始，可以在 switch 条件判断语句中使用 String 对象。</p>
<p>Switch 不支持 long，是因为 switch 的设计初衷是对那些只有极少数的几个值进行等值判断，如果值的范围过大，那么还是使用 if 比较合适。</p>
<blockquote>
<p><a href=https://stackoverflow.com/questions/2676210/why-cant-your-switch-statement-data-type-be-long-java>Why can&rsquo;t your switch statement data type be long, Java? - Stack Overflow</a></p>
</blockquote>
<h2 id=继承>继承</h2>
<h3 id=访问权限>访问权限</h3>
<p>Java 中有三个访问权限修饰符：private、protected、public，如果不加访问修饰符，则表示 package 范围内可见。</p>
<p>可以对类或类中的成员(字段/方法)添加修饰符。</p>
<ul>
<li>类可见表示其他类可以用这类来创建实例对象。(即通过类来引用成员)</li>
<li>成员可见表示其他类可以用这个类的实例对象访问到该成员。(即通过类实例来引用成员)</li>
</ul>
<p>protected 用于修饰成员，表示在继承体系中成员对于子类可见，但是该修饰符对于类没有作用。</p>
<p>设计良好的模块会隐藏所有实现细节，将其 API 和实现细节清晰的隔离开来。模块之间仅通过他们的 API 进行通信，一个模块不需要知道其他模块内部的具体细节，这个概念被称为信息隐藏或封装。因此访问权限应当尽可能的使每个类或成员不被外界访问。</p>
<p>如果子类的方法重写了父类的方法，那么子类中该方法的访问级别不允许低于父类的访问级别。这是为了确保可以在使用父类实例的地方都能使用子类实例，即子类实例提供了父类应该具体的能力，即里氏替换原则。</p>
<p>字段决不能是 public，因为这么做就是去了对这个字段修改行为的控制，外部可以对其执行任意修改。</p>
<p>如果是 package 范围或私有的嵌套类，那么直接暴露成员不会有太大的影响。</p>
<h3 id=抽象类与接口>抽象类与接口</h3>
<ol>
<li>抽象类</li>
</ol>
<p>抽象类和抽象方法使用 abstract 关键字声明。抽象类一般会包含抽象方法，抽象方法一定位于抽象类中。</p>
<p>抽象类和普通类之间最大的区别是，抽象类不能被实例化，需要继承抽象类并实例化子类。</p>
<ol start=2>
<li>接口</li>
</ol>
<p>接口是抽象类型的延伸，在 Java 8 之前，可以看做是一个完全抽象的类，即不能拥有任何实现方法。</p>
<p>从 Java 8 开始，接口也可以拥有默认的实现方法，这是因为不支持默认方法的接口的维护成本太高了。在此之前，如果一个接口想要添加新方法，那么要修改所有实现了该接口的类。</p>
<p>接口的成员都是 public 可见，并且不允许定义为 private 或 protected。</p>
<p>接口的字段默认都是 static final 的，即静态的。</p>
<ol start=3>
<li>比较</li>
</ol>
<ul>
<li>从设计层面看，抽象类提供了 IS-A 关系，那么就必须满足里氏替换原则，即子类对象必须能够替换所有父类对象。
<ul>
<li>接口更像是 LIKE-A 关系，它只是提供一种方法实现契约，并不要求接口和实现接口的类具有 IS-A 关系。</li>
</ul>
</li>
<li>从使用上来看，一个类可以实现多个接口，但不能同时继承多个抽象类。</li>
<li>接口的字段只能是 static final，抽象类没有该限制。</li>
<li>即可的成员只能是 public 可见，而抽象类的成员可以有多种范围可见。</li>
</ul>
<ol start=4>
<li>选择</li>
</ol>
<p>使用接口：</p>
<ul>
<li>需要让不相关的类都都实现一个方法，比如无关的类都可以实现 Comparable 接口中的 compareTo 方法。</li>
<li>需要使用多重继承。</li>
</ul>
<p>使用抽象类：</p>
<ul>
<li>需要在几个相关的类中共享代码。</li>
<li>需要能够控制继承的成员的访问权限，而非均为 public。</li>
<li>需要集成非静态和非常量字段。</li>
</ul>
<p>在很多情况下，接口优先于抽象类，因为接口没有抽象类严格的类层次结构要求，可以灵活的为一个类添加行为。并且从 Java 8 开始，接口也可以有默认的实现方法，使得修改接口的成本降低。</p>
<blockquote>
<ul>
<li><a href=https://www.ibm.com/developerworks/cn/java/l-javainterface-abstract/>深入理解 abstract class 和 interface (opens new window) (ibm.com)</a></li>
<li><a href=https://dzone.com/articles/when-to-use-abstract-class-and-intreface>When to Use Abstract Class and Interface (opens new window) (dzone.com)</a></li>
</ul>
</blockquote>
<h3 id=super>super</h3>
<ul>
<li>访问父类的构造函数：从而委托父类完成一些初始化工作。</li>
<li>方位父类的成员：如果子类重写了父类的某个方法实现，则可以通过 super 来引用父类原有的方法实现。</li>
</ul>
<blockquote>
<p><a href=https://docs.oracle.com/javase/tutorial/java/IandI/super.html>Using the Keyword super (opens new window) (oracle.com)</a></p>
</blockquote>
<h3 id=重写与重载>重写与重载</h3>
<ol>
<li>重写(overwrite)</li>
</ol>
<p>存在与继承体系中，子类实现了与父类在方法声明上完全相同的一个方法。</p>
<p>为了满足里氏替换原则，重写必须有以下两个限制：</p>
<ul>
<li>子类方法的访问权限不能低于父类方法</li>
<li>子类方法的返回类型必须是父类方法返回类型的原类型或其子类型。</li>
</ul>
<p>使用 <code>@Overwrite</code> 注解可以通过编译器来检查这两个限制是否满足。</p>
<ol start=2>
<li>重载(overload)</li>
</ol>
<p>存在与同一个类中，指多个方法的名称相同，但是参数类型、个数、顺序至少有一个不同。</p>
<p>如果仅返回值不同，其他都相同，不能认为是重载。</p>
<h2 id=object-通用方法>Object 通用方法</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#000>Object</span> <span style=color:#000>clone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notify</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finalize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</code></pre></div><h3 id=equals>equals</h3>
<ol>
<li>
<p>等价关系</p>
<ul>
<li>自反性：<code>x.equals(x)</code> 为 true</li>
<li>对称性：<code>x.equals(y) == y.equals(x)</code> 为 true</li>
<li>传递性：<code>x.equals(y) && y.equals(z)</code> 则 <code>x.equals(z)</code> 为 true</li>
<li>一致性：多次调用 equals 方法的结果不会变化</li>
<li>与 null 比较：任何不为 null 的对象 x 调用 <code>x.equals(null)</code> 均为 false</li>
</ul>
</li>
<li>
<p>equals 与 ==</p>
<ul>
<li>对于基本类型，== 判断值是否相等，基本类型没有 equals 方法</li>
<li>对于引用类型，== 判断两变量的引用是否相等，而 equals 则判断引用的对象是否等价</li>
</ul>
</li>
<li>
<p>实现</p>
<ul>
<li>检查是否为同一个对象的引用，如果是则直接返回 true</li>
<li>检查是否为同一个类型，不同直接返回 false</li>
<li>将 Object 转型</li>
<li>判断每个关键域是否相等</li>
</ul>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EqualExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>EqualExample</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>z</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>EqualExample</span> <span style=color:#000>that</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EqualExample</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>z</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>z</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=hashcode>hashCode</h3>
<p>hashCode 返回哈希值，而 equals 用于判断两个对象是否等价。等价的两个对象的哈希值也一定相等，但是哈希值相等的两个对象不一定等价。</p>
<p>在重写 equals 方法时应当总是重写 hashCode 以确保等价对象的哈希值也一定相等。</p>
<p>理想的哈希函数应该具有均匀性，不相等的对象应该均匀分布到所有可能的哈希值上。这就要求哈希函数能把所有域的值都考虑进来，可以将每个域都当做 R 进制的某一位，然后组成一个 R 进制的整数。R 一般取 31，因为它是一个奇素数，如果是偶数的话，当出现乘法溢出，信息就会丢失，因为与 2 相乘相当于左移一位。</p>
<p>一个数与 31 相乘可以转换成移位和减法操作：<code>31*X == (X&lt;&lt;5)-X</code>，编译器会自动执行该优化。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>17</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>31</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>31</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>31</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=tostring>toString</h3>
<p>默认返回的是对象的内存地址，如 <code>ToStringExample@4554617c</code>，其中 <code>@</code> 符号后面的值为散列码的无符号十六进制表示。</p>
<h3 id=clone>Clone</h3>
<ol>
<li>cloneable</li>
</ol>
<p><code>clone()</code> 是 Object 对象的 protected 方法，并非 public，如果一个类不显式的重新 clone 方法，其他类就无法直接去调用该类实例的 clone 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CloneExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>CloneExample</span> <span style=color:#000>clone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CloneExample</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>CloneExample</span> <span style=color:#000>e1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CloneExample</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>CloneExample</span> <span style=color:#000>e2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// will throw: CloneNotSupportedException
</span></code></pre></div><p>直接调用重写后的 clone 方法会抛出以上异常，这是因为 CloneExample 并未实现 Cloneable 接口。</p>
<p>注意，clone 并非 Cloneable 接口的方法，而是 Object 的一个 protected 方法。Cloneable 只是规定了：如果一个类没有实现 Cloneable 接口，直接调用 clone 方法时就会抛出该异常。</p>
<ol start=2>
<li>浅拷贝</li>
</ol>
<p>拷贝对象和原始对象的引用类型引用同一个对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 像上面一样实现 Cloneable 接口并重写 clone 方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ShallowCloneExample</span> <span style=color:#000>e1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ShallowCloneExample</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ShallowCloneExample</span> <span style=color:#000>e2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#000>e2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><ol start=3>
<li>深拷贝</li>
</ol>
<p>拷贝对象和原始对象的引用类型引用不同对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DeepCloneExample</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Cloneable</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>DeepCloneExample</span> <span style=color:#000>clone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DeepCloneExample</span> <span style=color:#000>cloned</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeepCloneExample</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
      <span style=color:#000>cloned</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]=</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cloned</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol start=4>
<li>clone 的替代方案</li>
</ol>
<p>使用 clone 方法来拷贝对象既复杂又有风险，可能会抛出异常，并且还需要类型转换。可以基于 Effective Java 中的建议，通过拷贝构造函数或拷贝工厂来拷贝一个对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CloneConstructorExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CloneConstructorExample</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CloneConstructorExample</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CloneConstructorExample</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=关键字>关键字</h2>
<h3 id=final>final</h3>
<ol>
<li>变量</li>
</ol>
<p>声明数据为常量，可以为编译时常量，也可以是在运行时被初始化后不能修改的常量。</p>
<ul>
<li>对于基本类型，fianl 使数值不变</li>
<li>对于引用类型，final 使引用不变，即不能被重新赋值为别的对象，但是所引用对象的值可以被修改</li>
</ul>
<ol start=2>
<li>方法</li>
</ol>
<p>声明的方法不能被子类重写。</p>
<p>被 private 修饰的方法隐式的被指定为 fianl，如果在子类中定义的方法和基类中某个 private 方法签名一样，此时子类的方法并被重写基类方法，而是在子类中重新定义了一个新的方法。</p>
<ol start=3>
<li>类</li>
</ol>
<p>声明类不能被继承。</p>
<h3 id=static>static</h3>
<ol>
<li>静态变量</li>
</ol>
<p>静态变量：又称为类变量，该变量属于类，而非该类的实例，类的所有实例都共享该变量，并通过类名来引用该变量，在内存中仅有一份。</p>
<p>实例变量：每创建一个实例就会产生一个实例变量，它与该实例同生共死。</p>
<ol start=2>
<li>静态方法</li>
</ol>
<p>静态方法在类加载的时候就存在了，它不依赖于任何实例。所以静态方法必须要实现，也就是说他不能抽象方法。</p>
<p>只能访问所属类的静态字段(变量)和静态方法，方法中不能有 this 和 super 关键字。</p>
<ol start=3>
<li>静态语句块</li>
</ol>
<p>静态语句块将在类初始化时执行一次。</p>
<ol start=4>
<li>静态内部类</li>
</ol>
<p>非静态内部类属于外部类的实例，而静态内部类属于外部类本身，通过外部类来引用该静态内部类。</p>
<ol start=5>
<li>静态导包</li>
</ol>
<p>通过静态导包，可以在使用静态变量和方法时不用再逐个指明 ClassName，可一件简化代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import static</span> <span style=color:#000>com.xxx.ClassName.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><ol start=6>
<li>初始化顺序</li>
</ol>
<p>静态变量和语句块优先于实例变量和普通语句块，它们的顺序由代码中的编写顺序决定。然后才是构造函数。</p>
<p>存在集成的情况下，初始化顺序为：</p>
<ul>
<li>父类(静态变量、静态语句块)</li>
<li>子类(静态变量、静态语句块)</li>
<li>父类(实例变量、普通语句块)</li>
<li>父类(构造函数)</li>
<li>子类(实例变量、普通语句块)</li>
<li>子类(构造函数)</li>
</ul>
<h2 id=反射>反射</h2>
<p>每个类都有一个 Class 对象，包含了与类有关的信息。当编译一个新类时，会产生一个同名的 class 文件，该文件内存保存着 Class 对象。</p>
<p>类加载相当于 Class 对象的加载。类在第一次使用时才会动态加载到 JVM 中，或者使用 <code>Class.forName(...)</code> 主动加载一个类，该方法会返回一个 Class 对象。</p>
<p>反射可以在运行时提供类的信息，并且该类可以在运行时才被加载进来，甚至在编译期该类的 class 尚不存在。</p>
<p>Class 和 java.lang.reflect 一起为反射提供了支持，java.lang.reflect 类库主要包括以下三个类：</p>
<ul>
<li>Field：可以使用 get 和 set 方法读取或修改 Field 对象关联的字段。</li>
<li>Method：可以使用 invoke 方法滴啊用与 Method 对象关联的方法。</li>
<li>Constructor：可以使用 Constructor 创建新的对象。</li>
</ul>
<p>高级用法：</p>
<ul>
<li>
<p><strong>Extensibility Features</strong> : An application may make use of external, user-defined classes by creating instances of extensibility objects using their fully-qualified names.</p>
</li>
<li>
<p><strong>Class Browsers and Visual Development Environments</strong> : A class browser needs to be able to enumerate the members of classes. Visual development environments can benefit from making use of type information available in reflection to aid the developer in writing correct code.</p>
</li>
<li>
<p><strong>Debuggers and Test Tools</strong> : Debuggers need to be able to examine private members on classes. Test harnesses can make use of reflection to systematically call a discoverable set APIs defined on a class, to insure a high level of code coverage in a test suite.</p>
</li>
</ul>
<p>反射的缺点：</p>
<p>反射虽然强大但不应被直接使用。如果能够在不使用反射的情况下完成操作，则应避免使用反射。使用反射时应注意以下几点：</p>
<ul>
<li><strong>Performance Overhead</strong> : Because reflection involves types that are dynamically resolved, certain Java virtual machine optimizations can not be performed. Consequently, reflective operations have slower performance than their non-reflective counterparts, and should be avoided in sections of code which are called frequently in performance-sensitive applications.</li>
<li><strong>Security Restrictions</strong> : Reflection requires a runtime permission which may not be present when running under a security manager. This is in an important consideration for code which has to run in a restricted security context, such as in an Applet.</li>
<li><strong>Exposure of Internals</strong> :Since reflection allows code to perform operations that would be illegal in non-reflective code, such as accessing private fields and methods, the use of reflection can result in unexpected side-effects, which may render code dysfunctional and may destroy portability. Reflective code breaks abstractions and therefore may change behavior with upgrades of the platform.</li>
</ul>
<blockquote>
<ul>
<li><a href=https://docs.oracle.com/javase/tutorial/reflect/index.html>Trail: The Reflection API (opens new window) (oracle.com)</a></li>
<li><a href=http://www.sczyh30.com/posts/Java/java-reflection-1/>深入解析 Java 反射—基础 (opens new window) (sczyh30.com)</a></li>
</ul>
</blockquote>
<h2 id=异常>异常</h2>
<p>Throwable 可以用来表示任何可以作为异常抛出的类，分为两种：Error 和 Exception。其中 Error 用来表示 JVM 无法处理的错误，Exception 分为两种：</p>
<ul>
<li>受检异常：需要 try&mldr;catch 语句捕获并进行处理，并且可以从异常中恢复。</li>
<li>非受检异常：程序运行时错误，比如除零操作会引起 ArithmeticException，这时程序崩溃且无法恢复。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210412231249.png style=display:block;width:50% alt=NAME align=center> </div>
<blockquote>
<ul>
<li><a href=https://www.tianmaying.com/tutorial/Java-Exception>Java 入门之异常处理 (opens new window) (tianmaying.com)</a></li>
<li><a href=http://www.importnew.com/7383.html>Java 异常的面试问题及答案 -Part 1(importnew.com)</a></li>
</ul>
</blockquote>
<h2 id=泛型>泛型</h2>
<blockquote>
<ul>
<li><a href=http://www.importnew.com/24029.html>Java 泛型详解(importnew.com)</a></li>
<li><a href=https://cloud.tencent.com/developer/article/1033693>10 道 Java 泛型面试题 (tencent.com)</a></li>
</ul>
</blockquote>
<h2 id=注解>注解</h2>
<p>Java 注解是附加在代码中的一些元信息，用于一些工具在编译期、运行时执行解析并使用，起到说明、配置的功能。注解不会也不应该影响代码的实际逻辑，仅仅起到辅助性的作用。</p>
<h2 id=特性>特性</h2>
<h3 id=版本特性>版本特性</h3>
<p><strong>Java 8</strong></p>
<ul>
<li>Lambda Expressions</li>
<li>Pipelines and Streams</li>
<li>Date and Time API</li>
<li>Default Methods</li>
<li>Type Annotations</li>
<li>Nashhorn JavaScript Engine</li>
<li>Concurrent Accumulators</li>
<li>Parallel operations</li>
<li>PermGen Error Removed</li>
</ul>
<p><strong>Java 7</strong></p>
<ul>
<li>
<p>Strings in Switch Statement</p>
</li>
<li>
<p>Type Inference for Generic Instance Creation</p>
</li>
<li>
<p>Multiple Exception Handling</p>
</li>
<li>
<p>Support for Dynamic Languages</p>
</li>
<li>
<p>Try with Resources</p>
</li>
<li>
<p>Java nio Package</p>
</li>
<li>
<p>Binary Literals, Underscore in literals</p>
</li>
<li>
<p>Diamond Syntax</p>
</li>
</ul>
<h3 id=与-c>与 C++</h3>
<ul>
<li>Java 是纯粹的面向对象语言，所有的对象都继承自 Object，C++ 为了兼容 C 同时支持面向对象和面向过程。</li>
<li>Java 通过虚拟机实现跨平台特性，但是 C++ 依赖于特定的平台。</li>
<li>Java 没有指针，其引用可以理解为安全指针，而 C++ 具有与 C 一样的指针。</li>
<li>Java 支持自动垃圾回收，而 C++ 需要手动回收。</li>
<li>Java 不支持多重继承，只能通过实现多个接口到达相同的目的，而 C++ 支持多重继承。</li>
<li>Java 不支持操作符重载，虽然可以对两个 String 对象执行加法运算，但是是语言内置的操作，不属于操作符重载，而 C++ 可以。</li>
<li>Java 的 goto 是保留字，不可以使用，C++ 可以使用。</li>
<li>Java 不支持条件编译，C++ 通过 <code>#ifdef #ifndef</code> 等预处理制冷可以实现条件编译。</li>
</ul>
<blockquote>
<ul>
<li><a href=http://cs-fundamentals.com/tech-interview/java/differences-between-java-and-cpp.php>What are the main differences between Java and C++? (cs-fundamentals.com)</a></li>
</ul>
</blockquote>
<h3 id=jre-与-jdk>JRE 与 JDK</h3>
<ul>
<li>JRE 是 JVM 程序，Java 应用需要运行在 JRE 之上。</li>
<li>JDK 是 JRE 的超集，带有 JRE 和用于编写 Java 程序的工具，比如 javac。</li>
</ul>
<h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://www.pdai.tech/md/java/basic/java-basic-lan-basic.html>Java 基础 - 知识点 (pdai.tech)</a></li>
<li>Eckel B. Java 编程思想. 机械工业出版社, 2002</li>
<li>Bloch J. Effective java. Addison-Wesley Professional, 2017</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4cad2acc9d30ff525a7e1eaa4c81f679>3 - CH03-基本图谱</h1>
<h2 id=概述>概述</h2>
<ul>
<li>术语
<ul>
<li>JDK：Java 开发者工具，Java Developer&rsquo;s Kit</li>
<li>JRE：Java 运行时环境，Java Runtime Environment</li>
<li>JVM：Java 虚拟机，Java Vitual Machine</li>
<li>API：应用程序编程接口，Application Programming Interface</li>
</ul>
</li>
<li>IDE
<ul>
<li>Eclipse</li>
<li>Intellij IDEA</li>
</ul>
</li>
<li>程序构造块
<ul>
<li>package</li>
<li>import</li>
<li>class</li>
<li>main</li>
<li>大括号</li>
<li>语句</li>
<li>注释</li>
</ul>
</li>
<li>工作方式
<ul>
<li>先编译后执行
<ul>
<li>Java 扩平台的根本</li>
<li>编译生成中间代码</li>
<li>JVM 加载执行中间代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=语言核心>语言核心</h2>
<h3 id=语言元素>语言元素</h3>
<ul>
<li>关键字：有特殊含义的单词
<ul>
<li>48 个可用</li>
<li>2 个保留：goto，const</li>
</ul>
</li>
<li>标识符
<ul>
<li>字符、数字、下划线、<code>$</code></li>
<li>不能以数字开头</li>
<li>不能有<code>!</code>等特殊字符</li>
<li>不能是关键字</li>
<li>大小写敏感</li>
<li>驼峰风格</li>
</ul>
</li>
<li>运算符
<ul>
<li>赋值：<code>=</code></li>
<li>算术：<code>+,-,*,/,%</code></li>
<li>关系：<code>>,&lt;,>=,&lt;=,!=,==</code></li>
<li>短路：<code>&&,||</code></li>
<li>三目：<code>..?..:..</code></li>
<li>逻辑：<code>&,|,!</code></li>
<li>自增/减运：<code>++,--</code></li>
<li>下标运：<code>[]</code></li>
<li>类型运：<code>(ClassName)</code></li>
<li>其他：
<ul>
<li>new</li>
<li>instanceOf</li>
<li>位与</li>
<li>访问成员</li>
</ul>
</li>
</ul>
</li>
<li>字面量：
<ul>
<li>整形：122</li>
<li>实数：3.14，2.1E-3</li>
<li>字符：<code>'a'</code></li>
<li>字符串：<code>"b"</code></li>
<li>布尔：true</li>
<li>引用：null</li>
<li>类型：<code>int.class, String.class</code></li>
</ul>
</li>
<li>分隔符</li>
</ul>
<h3 id=变量常量>变量/常量</h3>
<h3 id=数据类型>数据类型</h3>
<ul>
<li>基本类型：
<ul>
<li>byte-1</li>
<li>short-2</li>
<li>int-4</li>
<li>long-8</li>
<li>float-4</li>
<li>double-8</li>
<li>boolean</li>
<li>char-2</li>
</ul>
</li>
<li>枚举类型：符号常量</li>
<li>引用类型：对象</li>
</ul>
<h2 id=字符串>字符串</h2>
<ul>
<li>创建
<ul>
<li><code>String str = new String("abc")</code></li>
<li><code>String str = "abc";</code></li>
</ul>
</li>
<li>操作</li>
</ul>
<h2 id=数组>数组</h2>
<ul>
<li>一维数组：<code>int[] a = [1,2,3]</code></li>
<li>二维数组：<code>int[][] a = [[1,2,3],[4,5,6]]</code></li>
</ul>
<h2 id=循环>循环</h2>
<ul>
<li>
<p>for</p>
</li>
<li>
<p>while</p>
</li>
<li>
<p>do-while</p>
</li>
</ul>
<h2 id=分支>分支</h2>
<ul>
<li>if-else</li>
<li>switch-case</li>
</ul>
<h2 id=faq>FAQ</h2>
<h3 id=使用哪种数据类型表示价格>使用哪种数据类型表示价格</h3>
<p>如果不是特别关心内存和性能的话，使用BigDecimal，否则使用预定义精度的 double 类型。</p>
<h3 id=怎么将-byte-转换为-string>怎么将 byte 转换为 String</h3>
<p>可以使用 String 接收 byte[] 参数的构造器来进行转换，需要注意的点是要使用的正确的编码，否则会使用平台默认编码，这个编码可能跟原来的编码相同，也可能不同。</p>
<h3 id=java-中怎样将-bytes-转换为-long-类型>Java 中怎样将 bytes 转换为 long 类型</h3>
<p>String接收bytes的构造器转成String，再 Long.parseLong。</p>
<h3 id=我们能将-int-强制转换为-byte-类型的变量吗>我们能将 int 强制转换为 byte 类型的变量吗</h3>
<p>是的，我们可以做强制转换，但是 Java 中 int 是 32 位的，而 byte 是 8 位的，所以，如果强制转化是，int 类型的高 24 位将会被丢弃，byte 类型的范围是从 -128 到 127。</p>
<h3 id=存在两个类b-继承-ac-继承-b我们能将-b-转换为-c-么-如-c--c-b>存在两个类，B 继承 A，C 继承 B，我们能将 B 转换为 C 么? 如 C = (C) B</h3>
<p>可以，向下转型。但是不建议使用，容易出现类型转型异常.</p>
<h3 id=哪个类包含-clone-方法-是-cloneable-还是-object>哪个类包含 clone 方法? 是 Cloneable 还是 Object?</h3>
<p>java.lang.Cloneable 是一个标示性接口，不包含任何方法，clone 方法在 object 类中定义。并且需要知道 clone() 方法是一个本地方法，这意味着它是由 c 或 c++ 或 其他本地语言实现的。</p>
<h3 id=java-中--操作符是线程安全的吗>Java 中 ++ 操作符是线程安全的吗?</h3>
<p>不是线程安全的操作。它涉及到多个指令，如读取变量值，增加，然后存储回内存，这个过程可能会出现多个线程交差。还会存在竞态条件(读取-修改-写入)。</p>
<h3 id=a--a--b-与-a--b-的区别>a = a + b 与 a += b 的区别</h3>
<p>+= 隐式的将加操作的结果类型强制转换为持有结果的类型。如果两这个整型相加，如 byte、short 或者 int，首先会将它们提升到 int 类型，然后在执行加法操作。</p>
<h3 id=我能在不进行强制转换的情况下将一个-double-值赋值给-long-类型的变量吗>我能在不进行强制转换的情况下将一个 double 值赋值给 long 类型的变量吗?</h3>
<p>不行，你不能在没有强制类型转换的前提下将一个 double 值赋值给 long 类型的变量，因为 double 类型的范围比 long 类型更广，所以必须要进行强制转换。</p>
<h3 id=301--03-将会返回什么-true-还是-false>3*0.1 == 0.3 将会返回什么? true 还是 false?</h3>
<p>false，因为有些浮点数不能完全精确的表示出来。</p>
<h3 id=int-和-integer-哪个会占用更多的内存>int 和 Integer 哪个会占用更多的内存?</h3>
<p>Integer 对象会占用更多的内存。Integer 是一个对象，需要存储对象的元数据。但是 int 是一个原始类型的数据，所以占用的空间更少。</p>
<h3 id=为什么-java-中的-string-是不可变的immutable>为什么 Java 中的 String 是不可变的(Immutable)?</h3>
<p>Java 中的 String 不可变是因为 Java 的设计者认为字符串使用非常频繁，将字符串设置为不可变可以允许多个客户端之间共享相同的字符串。更详细的内容参见答案。</p>
<h3 id=我们能在-switch-中使用-string-吗>我们能在 Switch 中使用 String 吗?</h3>
<p>从 Java 7 开始，我们可以在 switch case 中使用字符串，但这仅仅是一个语法糖。内部实现在 switch 中使用字符串的 hash code。</p>
<h3 id=java-中的构造器链是什么>Java 中的构造器链是什么?</h3>
<p>当你从一个构造器中调用另一个构造器，就是Java 中的构造器链。这种情况只在重载了类的构造器的时候才会出现。</p>
<h3 id=枚举类>枚举类</h3>
<p>JDK1.5出现 每个枚举值都需要调用一次构造函数</p>
<h3 id=什么是不可变对象immutable-object-java-中怎么创建一个不可变对象>什么是不可变对象(immutable object)? Java 中怎么创建一个不可变对象?</h3>
<p>不可变对象指对象一旦被创建，状态就不能再改变。任何修改都会创建一个新的对象，如 String、Integer及其它包装类。</p>
<ul>
<li>对象的状态在创建之后就不能发生改变，任何对它的改变都应该产生一个新的对象。</li>
<li>类的所有的属性都应该是final的。</li>
<li>对象必须被正确的创建，比如: 对象引用在对象创建过程中不能泄露(leak)。</li>
<li>对象应该是final的，以此来限制子类继承父类，以避免子类改变了父类的immutable特性。</li>
<li>如果类中包含mutable类对象，那么返回给客户端的时候，返回该对象的一个拷贝，而不是该对象本身(该条可以归为第一条中的一个特例)</li>
</ul>
<h3 id=我们能创建一个包含可变对象的不可变对象吗>我们能创建一个包含可变对象的不可变对象吗?</h3>
<p>是的，我们是可以创建一个包含可变对象的不可变对象的，你只需要谨慎一点，不要共享可变对象的引用就可以了，如果需要变化时，就返回原对象的一个拷贝。最常见的例子就是对象中包含一个日期对象的引用。</p>
<h3 id=有没有可能两个不相等的对象有有相同的-hashcode>有没有可能两个不相等的对象有有相同的 hashcode?</h3>
<p>有可能，两个不相等的对象可能会有相同的 hashcode 值，这就是为什么在 hashmap 中会有冲突。相等 hashcode 值的规定只是说如果两个对象相等，必须有相同的hashcode 值，但是没有关于不相等对象的任何规定。</p>
<h3 id=两个相同的对象会有不同的的-hash-code-吗>两个相同的对象会有不同的的 hash code 吗?</h3>
<p>不能，根据 hash code 的规定，这是不可能的。</p>
<h3 id=我们可以在-hashcode-中使用随机数字吗>我们可以在 hashcode() 中使用随机数字吗?</h3>
<p>不行，因为对象的 hashcode 值必须是相同的。</p>
<h3 id=java-中comparator-与-comparable-有什么不同>Java 中，Comparator 与 Comparable 有什么不同?</h3>
<p>Comparable 接口用于定义对象的自然顺序，而 comparator 通常用于定义用户定制的顺序。Comparable 总是只有一个，但是可以有多个 comparator 来定义对象的顺序。</p>
<h3 id=为什么在重写-equals-方法的时候需要重写-hashcode-方法>为什么在重写 equals 方法的时候需要重写 hashCode 方法?</h3>
<p>因为有强制的规范指定需要同时重写 hashcode 与 equal 是方法，许多容器类，如 HashMap、HashSet 都依赖于 hashcode 与 equals 的规定。</p>
<h3 id=ab和aequalsb有什么区别>“a==b”和”a.equals(b)”有什么区别?</h3>
<p>如果 a 和 b 都是对象，则 a==b 是比较两个对象的引用，只有当 a 和 b 指向的是堆中的同一个对象才会返回 true，而 a.equals(b) 是进行逻辑比较，所以通常需要重写该方法来提供逻辑一致性的比较。例如，String 类重写 equals() 方法，所以可以用于两个不同对象，但是包含的字母相同的比较。</p>
<h3 id=ahashcode-有什么用-与-aequalsb-有什么关系>a.hashCode() 有什么用? 与 a.equals(b) 有什么关系?</h3>
<p>hashCode() 方法是相应对象整型的 hash 值。它常用于基于 hash 的集合类，如 Hashtable、HashMap、LinkedHashMap等等。</p>
<p>它与 equals() 方法关系特别紧密。根据 Java 规范，两个使用 equal() 方法来判断相等的对象，必须具有相同的 hash code。</p>
<h3 id=finalfinalize-和-finally-的不同之处>final、finalize 和 finally 的不同之处?</h3>
<ul>
<li>final 是一个修饰符，可以修饰变量、方法和类。如果 final 修饰变量，意味着该变量的值在初始化后不能被改变。</li>
<li>Java 技术允许使用 finalize() 方法在垃圾收集器将对象从内存中清除出去之前做必要的清理工作。这个方法是由垃圾收集器在确定这个对象没有被引用时对这个对象调用的，但是什么时候调用 finalize 没有保证。</li>
<li>finally 是一个关键字，与 try 和 catch 一起用于异常的处理。finally 块一定会被执行，无论在 try 块中是否有发生异常。</li>
</ul>
<h3 id=java-中的编译期常量是什么-使用它又什么风险>Java 中的编译期常量是什么? 使用它又什么风险?</h3>
<p>变量也就是我们所说的编译期常量，这里的 public 可选的。实际上这些变量在编译时会被替换掉，因为编译器知道这些变量的值，并且知道这些变量在运行时不能改变。这种方式存在的一个问题是你使用了一个内部的或第三方库中的公有编译时常量，但是这个值后面被其他人改变了，但是你的客户端仍然在使用老的值，甚至你已经部署了一个新的jar。为了避免这种情况，当你在更新依赖 JAR 文件时，确保重新编译你的程序。</p>
<h3 id=静态内部类与顶级类有什么区别>静态内部类与顶级类有什么区别?</h3>
<p>一个公共的顶级类的源文件名称与类名相同，而嵌套静态类没有这个要求。一个嵌套类位于顶级类内部，需要使用顶级类的名称来引用嵌套静态类，如 HashMap.Entry 是一个嵌套静态类，HashMap 是一个顶级类，Entry是一个嵌套静态类。</p>
<h3 id=java-中serializable-与-externalizable-的区别>Java 中，Serializable 与 Externalizable 的区别?</h3>
<p>Serializable 接口是一个序列化 Java 类的接口，以便于它们可以在网络上传输或者可以将它们的状态保存在磁盘上，是 JVM 内嵌的默认序列化方式，成本高、脆弱而且不安全。Externalizable 允许你控制整个序列化过程，指定特定的二进制格式，增加安全机制。</p>
<h3 id=说出-jdk-17-中的三个新特性>说出 JDK 1.7 中的三个新特性?</h3>
<p>虽然 JDK 1.7 不像 JDK 5 和 8 一样的大版本，但是，还是有很多新的特性，如 try-with-resource 语句，这样你在使用流或者资源的时候，就不需要手动关闭，Java 会自动关闭。Fork-Join 池某种程度上实现 Java 版的 Map-reduce。允许 Switch 中有 String 变量和文本。菱形操作符(&lt;>)用于泛型推断，不再需要在变量声明的右边申明泛型，因此可以写出可读写更强、更简洁的代码。另一个值得一提的特性是改善异常处理，如允许在同一个 catch 块中捕获多个异常。</p>
<h3 id=说出-5-个-jdk-18-引入的新特性>说出 5 个 JDK 1.8 引入的新特性?</h3>
<p>Java 8 在 Java 历史上是一个开创新的版本，下面 JDK 8 中 5 个主要的特性: Lambda 表达式，允许像对象一样传递匿名函数 Stream API，充分利用现代多核 CPU，可以写出很简洁的代码 Date 与 Time API，最终，有一个稳定、简单的日期和时间库可供你使用 扩展方法，现在，接口中可以有静态、默认方法。 重复注解，现在你可以将相同的注解在同一类型上使用多次。</p>
<p>下述包含 Java 面试过程中关于 SOLID 的设计原则，OOP 基础，如类，对象，接口，继承，多态，封装，抽象以及更高级的一些概念，如组合、聚合及关联。也包含了 GOF 设计模式的问题。</p>
<h3 id=接口是什么-为什么要使用接口而不是直接使用具体类>接口是什么? 为什么要使用接口而不是直接使用具体类?</h3>
<p>接口用于定义 API。它定义了类必须得遵循的规则。同时，它提供了一种抽象，因为客户端只使用接口，这样可以有多重实现，如 List 接口，你可以使用可随机访问的 ArrayList，也可以使用方便插入和删除的 LinkedList。接口中不允许普通方法，以此来保证抽象，但是 Java 8 中你可以在接口声明静态方法和默认普通方法。</p>
<h3 id=java-中抽象类与接口之间有什么不同>Java 中，抽象类与接口之间有什么不同?</h3>
<p>Java 中，抽象类和接口有很多不同之处，但是最重要的一个是 Java 中限制一个类只能继承一个类，但是可以实现多个接口。抽象类可以很好的定义一个家族类的默认行为，而接口能更好的定义类型，有助于后面实现多态机制 参见第六条。</p>
<h3 id=object有哪些公用方法>Object有哪些公用方法?</h3>
<p>clone equals hashcode wait notify notifyall finalize toString getClass 除了clone和finalize其他均为公共方法。</p>
<p>11个方法，wait被重载了两次</p>
<h3 id=equals与的区别>equals与==的区别</h3>
<ul>
<li>== 是一个运算符 equals是Object类的方法</li>
<li>比较时的区别
<ul>
<li>用于基本类型的变量比较时: ==用于比较值是否相等，equals不能直接用于基本数据类型的比较，需要转换为其对应的包装类型。</li>
<li>用于引用类型的比较时。==和equals都是比较栈内存中的地址是否相等 。相等为true 否则为false。但是通常会重写equals方法去实现对象内容的比较。</li>
</ul>
</li>
</ul>
<h3 id=stringstringbuffer与stringbuilder的区别>String、StringBuffer与StringBuilder的区别</h3>
<p>第一点: 可变和适用范围。String对象是不可变的，而StringBuffer和StringBuilder是可变字符序列。每次对String的操作相当于生成一个新的String对象，而对StringBuffer和StringBuilder的操作是对对象本身的操作，而不会生成新的对象，所以对于频繁改变内容的字符串避免使用String，因为频繁的生成对象将会对系统性能产生影响。</p>
<p>第二点: 线程安全。String由于有final修饰，是immutable的，安全性是简单而纯粹的。StringBuilder和StringBuffer的区别在于StringBuilder不保证同步，也就是说如果需要线程安全需要使用StringBuffer，不需要同步的StringBuilder效率更高。</p>
<h3 id=接口与抽象类>接口与抽象类</h3>
<ul>
<li>一个子类只能继承一个抽象类,但能实现多个接口</li>
<li>抽象类可以有构造方法,接口没有构造方法</li>
<li>抽象类可以有普通成员变量,接口没有普通成员变量</li>
<li>抽象类和接口都可有静态成员变量,抽象类中静态成员变量访问类型任意，接口只能public static final(默认)</li>
<li>抽象类可以没有抽象方法,抽象类可以有普通方法,接口中都是抽象方法</li>
<li>抽象类可以有静态方法，接口不能有静态方法</li>
<li>抽象类中的方法可以是public、protected;接口方法只有public abstract</li>
</ul>
<h3 id=抽象类和最终类>抽象类和最终类</h3>
<p>抽象类可以没有抽象方法, 最终类可以没有最终方法</p>
<p>最终类不能被继承, 最终方法不能被重写(可以重载)</p>
<h3 id=异常>异常</h3>
<p>相关的关键字 throw、throws、try&mldr;catch、finally</p>
<ul>
<li>throws 用在方法签名上, 以便抛出的异常可以被调用者处理</li>
<li>throw 方法内部通过throw抛出异常</li>
<li>try 用于检测包住的语句块, 若有异常, catch子句捕获并执行catch块</li>
</ul>
<h3 id=关于finally>关于finally</h3>
<ul>
<li>finally不管有没有异常都要处理</li>
<li>当try和catch中有return时，finally仍然会执行，finally比return先执行</li>
<li>不管有木有异常抛出, finally在return返回前执行</li>
<li>finally是在return后面的表达式运算后执行的(此时并没有返回运算后的值，而是先把要返回的值保存起来，管finally中的代码怎么样，返回的值都不会改变，仍然是之前保存的值)，所以函数返回值是在finally执行前确定的</li>
</ul>
<p>注意: finally中最好不要包含return，否则程序会提前退出，返回值不是try或catch中保存的返回值</p>
<p>finally不执行的几种情况: 程序提前终止如调用了 System.exit、断电</p>
<h3 id=受检查异常和运行时异常>受检查异常和运行时异常</h3>
<ul>
<li>受检查的异常(checked exceptions),其必须被try&mldr;catch语句块所捕获, 或者在方法签名里通过throws子句声明。受检查的异常必须在编译时被捕捉处理,命名为Checked Exception是因为Java编译器要进行检查, Java虚拟机也要进行检查, 以确保这个规则得到遵守。</li>
<li>运行时异常(runtime exceptions), 需要程序员自己分析代码决定是否捕获和处理,比如空指针,被0除&mldr;</li>
<li>Error的，则属于严重错误，如系统崩溃、虚拟机错误、动态链接失败等，这些错误无法恢复或者不可能捕捉，将导致应用程序中断，Error不需要捕获。</li>
</ul>
<h3 id=super出现在父类的子类中有三种存在方式>super出现在父类的子类中。有三种存在方式</h3>
<ul>
<li>super.xxx(xxx为变量名或对象名)意思是获取父类中xxx的变量或引用</li>
<li>super.xxx(); (xxx为方法名)意思是直接访问并调用父类中的方法</li>
<li>super() 调用父类构造</li>
</ul>
<h3 id=this--super在构造方法中的区别>this() & super()在构造方法中的区别</h3>
<ul>
<li>调用super()必须写在子类构造方法的第一行, 否则编译不通过</li>
<li>super从子类调用父类构造, this在同一类中调用其他构造均需要放在第一行</li>
<li>尽管可以用this调用一个构造器, 却不能调用2个</li>
<li>this和super不能出现在同一个构造器中, 否则编译不通过</li>
<li>this()、super()都指的对象,不可以在static环境中使用</li>
<li>本质this指向本对象的指针。super是一个关键字</li>
</ul>
<h3 id=序列化>序列化</h3>
<p>声明为static和transient类型的数据不能被序列化， 反序列化需要一个无参构造函数</p>
<h3 id=java移位运算符>Java移位运算符</h3>
<ul>
<li><code>&lt;&lt;</code> :左移运算符,<code>x &lt;&lt; 1</code>,相当于x乘以2(不溢出的情况下),低位补0</li>
<li><code>>></code> :带符号右移,<code>x >> 1</code>,相当于x除以2,正数高位补0,负数高位补1</li>
<li><code>>>></code> :无符号右移,忽略符号位,空位都以0补齐</li>
</ul>
<h3 id=形参实参>形参&实参</h3>
<p>形式参数可被视为local variable.形参和局部变量一样都不能离开方法。只有在方法中使用，不会在方法外可见。 形式参数只能用final修饰符，其它任何修饰符都会引起编译器错误。但是用这个修饰符也有一定的限制，就是在方法中不能对参数做任何修改。不过一般情况下，一个方法的形参不用final修饰。只有在特殊情况下，那就是: 方法内部类。一个方法内的内部类如果使用了这个方法的参数或者局部变量的话，这个参数或局部变量应该是final。 形参的值在调用时根据调用者更改，实参则用自身的值更改形参的值(指针、引用皆在此列)，也就是说真正被传递的是实参。</p>
<h3 id=局部变量为什么要初始化>局部变量为什么要初始化</h3>
<p>局部变量是指类方法中的变量，必须初始化。局部变量运行时被分配在栈中，量大，生命周期短，如果虚拟机给每个局部变量都初始化一下，是一笔很大的开销，但变量不初始化为默认值就使用是不安全的。出于速度和安全性两个方面的综合考虑，解决方案就是虚拟机不初始化，但要求编写者一定要在使用前给变量赋值。</p>
<h3 id=java语言的鲁棒性>Java语言的鲁棒性</h3>
<p>Java在编译和运行程序时，都要对可能出现的问题进行检查，以消除错误的产生。它提供自动垃圾收集来进行内存管理，防止程序员在管理内存时容易产生的错误。通过集成的面向对象的例外处理机制，在编译时，Java揭示出可能出现但未被处理的异常，帮助程序员正确地进行选择以防止系统的崩溃。另外，Java在编译时还可捕获类型声明中的许多常见错误，防止动态运行时不匹配问题的出现。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b55749cae60e608c7ca23e6a61d68cb6>4 - CH04-泛型机制</h1>
<h2 id=概览>概览</h2>
<p>Java 的泛型特性由 JDK 1.5 引入，因此为了兼容之前的版本，Java 泛型的实现采用了“伪泛型”策略。即 Java 在语法上支持泛型，但是在编译阶段会执行“类型擦除(Type Erasure)”，将所有的泛型表示都替换为实际的类型，就像完全没有泛型一样。</p>
<p>泛型的本质是为了参数化类型，在不创建新类型的情况下，通过泛型指定的不同类型来控制形式化参数所限制的具体类型。也就是说在泛型的使用过程中，操作的数据类型被指定为一个参数，该类型参数可以用在类、接口、方法中，分别被称为泛型类、泛型接口、泛型方法。</p>
<p>引入泛型的最直接意义在于：</p>
<ul>
<li><strong>适用于多种数据类型执行相同的代码逻辑(代码复用)</strong>。</li>
<li>泛型中的类型在使用时指定，不需要强制类型转换(类型安全，由编译器执行检查)。</li>
</ul>
<h2 id=基本使用>基本使用</h2>
<h3 id=泛型类>泛型类</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getVar</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>var</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>point</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>pioint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h3 id=泛型接口>泛型接口</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Info</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>T</span> <span style=color:#000>getVar</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InfoImpl</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Info</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=泛型方法>泛型方法</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Caster</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>castAs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=泛型边界>泛型边界</h3>
<blockquote>
<ul>
<li>参考 “泛型型变-Scala”。</li>
</ul>
</blockquote>
<h2 id=泛型擦除>泛型擦除</h2>
<p>擦除原则：</p>
<ul>
<li>消除类型参数声明，即删除 <code>&lt;></code> 及其包围的部分。</li>
<li>根据类型参数的上下界推断并替换所有的类型参数为具体类型：
<ul>
<li>如果类型参数是无限制通配符或没有上下界限定则替换为 Object。</li>
<li>如果存在上下界限定则根据子类替换原则取类型参数的最左侧限定类型，即父类。</li>
</ul>
</li>
<li>为了保证类型安全，必要时插入强制类型转换代码。</li>
<li>自动产生“桥接方法”以保证类型擦除后的代码仍然具有泛型的“多态性”。</li>
</ul>
<p>如何执行类型擦除：</p>
<ul>
<li>
<p>参数类定义中的类型参数：无限制类型擦除</p>
<p>当类定义中类型参数没有任何限制时，直接将其替换为 Object，如 <code>&lt;T></code> 或 <code>&lt;?></code> 会被直接替换为 Object。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210413223040.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
<li>
<p>擦除类定义中的类型参数：有限制类型擦除</p>
<p>如果类定义中的类型参数有上下界限定，在擦除时将其替换为类型参数的上界或下界，如 <code>&lt;T extends Number></code> 和 <code>&lt;? extends Number></code> 会被替换为 Number，<code>&lt;? super Number></code> 会被替换为 Object。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210413223306.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
<li>
<p>擦除方法定义中的类型参数</p>
<p>原则和擦除类定义中的类型参数一致，这里仅擦除方法定义中的有限制类型参数为例。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210413223413.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
</ul>
<h3 id=如何证明类型擦除>如何证明类型擦除</h3>
<ul>
<li>
<p>原始类型相等</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div></li>
<li>
<p>通过反射添加其他类型的元素</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li>
</ul>
<h3 id=类型擦除后的原生类型raw-type>类型擦除后的原生类型(Raw Type)</h3>
<p><strong>原生类型</strong>为擦除掉泛型信息后，保留在字节码中的类型变量的真正类型，无论何时定义一个泛型类型，对应的原始类型都会自动提供，类型变量擦除，并使用其限定类型或 Object 替换。</p>
<h3 id=如何理解编译期检查>如何理解编译期检查</h3>
<p>Java 编译器首先<strong>检查</strong>代码中泛型的类型，然后再执行类型擦除，然后再执行编译。</p>
<p>基于代码的类型检查是如何进行的呢？</p>
<p>比如以下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//第一种 情况
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ArrayList</span> <span style=color:#000>list2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span> <span style=color:#8f5902;font-style:italic>//第二种 情况
</span></code></pre></div><p>以上代码可以编译通过，且不会出现变异警告。但是仅第一种可以实现与完全使用泛型参数一样的效果，第二种不行。</p>
<p>因为类型检查就是编译时完成的，<code>new ArrayList()</code> 只是在内存中开辟一个存储空间，可以存储任何类型的对象，而真正涉及类型检查的是它的引用，因为我们是通过引用 list1 来调用它的方法，比如调用其 add 方法，所以 list1 引用能能完成泛型类型的检查。而引用 list2 没有使用泛型，所以不行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>();</span> 
<span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译错误  
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>String</span> <span style=color:#000>str1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//返回类型就是String 
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>ArrayList</span> <span style=color:#000>list2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ist2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//返回类型就是Object
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;11&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>22</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译错误
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>String</span> <span style=color:#000>str2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//返回类型就是String
</span></code></pre></div><p>因此可以得出，<strong>类型检查就是针对引用执行的检查，谁是一个引用，通过该引用调用泛型方法，就会对这个引用调用的方法进行类型检测，而无关它真正引用的对象</strong>。</p>
<h3 id=泛型多态桥接方法>泛型多态/桥接方法</h3>
<p>类型擦除会造成多态冲突，而 JVM 通过桥接方法类解决。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>  

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后实现一个子类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DateInter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>  

    <span style=color:#5c35cc;font-weight:700>@Override</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  

    <span style=color:#5c35cc;font-weight:700>@Override</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这个子类中，我们设定父类的泛型类型为<code>Pair&lt;Date></code>，在子类中，我们覆盖了父类的两个方法，我们的原意是这样的：将父类的泛型类型限定为 Date，那么父类里面的两个方法的参数都为 Date 类型。</p>
<p>实际上类型擦除后，父类的泛型类型全部变成了 Object，所以父类编译之后会成为如下形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pair</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span>  <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>这时子类中的两个重写方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#5c35cc;font-weight:700>@Override</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先是 setValue 方法，父类的类型是 Object，而子类的类型是 Date，参数类型不一样，如果是在普通的继承体系中，根本就不会是重写，而是重载。但是如果通过基于重载的形式以子类来调用父类的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>DateInter</span> <span style=color:#000>dateInter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DateInter</span><span style=color:#ce5c00;font-weight:700>();</span>  
<span style=color:#000>dateInter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>());</span>                  
<span style=color:#000>dateInter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//编译错误
</span></code></pre></div><p>如果是重载，那么子类中会有两个 setValue 方法，一个参数为 Object，一个参数为 Date，但编译错误可以得出这里实际上是重写。</p>
<p>原因是，当我们集成父类并设定其类型参数为 Date，期望将泛型类变成如下形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pair</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后在子类中重写参数类型为 Date 的两个方法，实现继承中的多态。</p>
<p>但是由于种种原因，JVM 并不能将泛型类型转换为 Date，只能将其擦除，称为原生类型 Object。这样我们本意是重写来实现多态，但类型擦除后只能变为了重载。从而导致类型擦除与多态的冲突。因此 JVM 决定通过桥接来解决该问题。</p>
<p>首先通过命令 <code>javap -c className</code> 的方式反编译 DateInter 子类的字节码，结果如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tao</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DateInter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tao</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>  
  <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tao</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DateInter</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>8</span>                  <span style=color:#8f5902;font-style:italic>// Method com/tao/test/Pair.&#34;&lt;init&gt;&#34;:()V  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Date</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//我们重写的setValue方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>  
       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>16</span>                 <span style=color:#8f5902;font-style:italic>// Method com/tao/test/Pair.setValue:(Ljava/lang/Object;)V  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>    <span style=color:#8f5902;font-style:italic>//我们重写的getValue方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>23</span>                 <span style=color:#8f5902;font-style:italic>// Method com/tao/test/Pair.getValue:()Ljava/lang/Object;  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>     <span style=color:#a40000>#</span><span style=color:#000>26</span>                 <span style=color:#8f5902;font-style:italic>// class java/util/Date  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>areturn</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>     <span style=color:#8f5902;font-style:italic>//编译时由编译器生成的巧方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#a40000>#</span><span style=color:#000>28</span>                 <span style=color:#8f5902;font-style:italic>// Method getValue:()Ljava/util/Date 去调用我们重写的getValue方法;  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>areturn</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>);</span>   <span style=color:#8f5902;font-style:italic>//编译时由编译器生成的巧方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>  
       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>     <span style=color:#a40000>#</span><span style=color:#000>26</span>                 <span style=color:#8f5902;font-style:italic>// class java/util/Date  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#a40000>#</span><span style=color:#000>30</span>                 <span style=color:#8f5902;font-style:italic>// Method setValue:(Ljava/util/Date; 去调用我们重写的setValue方法)V  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从编译结果来看，我们原本要重写方法实际上成了 4 个方法，最后两个方法即为编译器自动生成的桥接方法。可以发现桥接方法的参数类型都是 Object，也就是说，子类中真正覆盖父类方法的就是这两个桥接方法。桥接方法的内部会执行类型转换并调用我们重写的那两个方法。</p>
<h3 id=基本类型不能作为泛型参数>基本类型不能作为泛型参数</h3>
<p>比如只能使用 <code>List&lt;Integer></code> 而不能使用 <code>List&lt;int></code>。因为当类型擦除后，List 的原生类型变为 Object，但是 Object 不能存储 int 值，只能是引用类型 Integer 的值。</p>
<p>然后实际操作中使用的 <code>list.add(1)</code>，则是基本类型的自动装箱机制。</p>
<h3 id=泛型类型不能实例化>泛型类型不能实例化</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>T</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>以上代码会直接报错。因为 Java 编译期没法确定泛型参数的实际类型，也就找不到对应的类的字节码文件，所以自然就不能完成编译。此外由于 T 被擦除为 Object，如果可以执行 <code>new T()</code>，则就变成了 <code>new Object()</code>，失去了代码的本意。</p>
<h3 id=泛型数组通过具体类型参数初始化>泛型数组：通过具体类型参数初始化</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>lsa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span> <span style=color:#8f5902;font-style:italic>// Not really allowed.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>oa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>li</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>oa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// Unsound, but passes run time store check
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// Run-time error ClassCastException.
</span></code></pre></div><p>由于擦除机制，上面代码可以给 <code>oa[1]</code> 赋值为 ArrayList 类型的变量也不会出现异常。但是在取出数据时要做一次类型转换，所以就会出现 ClassCastException。</p>
<p>如果可以执行泛型数组的声明则上面这种情况就不会出现任何警告和错误，只有在运行时才会报错，但是泛型的出现就是为了避免转型错误，所有 Java 支持泛型数组初始化则与初衷违背。</p>
<p>下面的代码是成立的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>lsa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span> <span style=color:#8f5902;font-style:italic>// OK, array of unbounded wildcard type.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>oa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>li</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>oa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// Correct.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Integer</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// OK
</span></code></pre></div><p>所以说采用通配符的方式初始化泛型数组是允许的，因为对于通配符的方式是最后取出数据时才执行转型，符合预期逻辑。</p>
<p>Java 的泛型数组初始化时数组类型不能是具体的泛型类型，只能是通配符的形式，因为具体类型会导致可存入任意类型对象，在取出时会发生类型转换异常，会与泛型的设计思想冲突，而通配符形式本来就需要自己强转，符合预期。</p>
<h3 id=泛型数组正确的初始化数组实例>泛型数组：正确的初始化数组实例</h3>
<p>无论是 <code>new ArrayList[10]</code> 的形式还是通过泛型通配符的形式来初始化都存在转型异常风险。</p>
<p>在需要使用泛型数组时应尽量使用列表集合替代，此外也可以通过反射来创建一个具有指定类型的数组：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>create</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//...
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arrayToken</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrayToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=泛型类中的静态方法与静态变量>泛型类中的静态方法与静态变量</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>T</span> <span style=color:#000>one</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>//编译错误    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>T</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>one</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#8f5902;font-style:italic>//编译错误    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#ce5c00;font-weight:700>}</span>    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为泛型类中的类型参数是在定义对象时才指定的，而静态变量或静态方法不需要使用对象实例来调用。对象未被创建，如何确定该泛型参数的具体类型，所以错误。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>    

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>one</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#8f5902;font-style:italic>//这是正确的    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#ce5c00;font-weight:700>}</span>    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意这里 show 方法的类型参数 T 并非 Test 类的类型参数 T。</p>
<h3 id=异常中使用泛型>异常中使用泛型</h3>
<ul>
<li>不能抛出也不能捕获泛型对象。继承 Throwable 时使用泛型也是非法的。
<ul>
<li>因为异常仅在运行时抛出，编译期擦除参数类型后无法区分不同具体类型的泛型异常。</li>
</ul>
</li>
<li>不能在 catch 子句中使用泛型变量
<ul>
<li>因为泛型信息会被擦除为原生类型，<code>catch(T e)</code> 会变成 <code>catch(Throwable e)</code></li>
<li>根据异常捕获原则，如果下面还有别的 catch 语句来处理其他异常类型，导致冲突。</li>
</ul>
</li>
<li>可以在声明中抛出参数啊类型的异常，<code>&lt;T extends Throwable> void do(T t) throws T</code></li>
</ul>
<h3 id=如何获取类型参数>如何获取类型参数</h3>
<p><code>java.lang.reflect.Type</code> 是 Java 中所有类型的公共高级接口，代表了所有 Java 中的类型。Type 体系中的类型包括：</p>
<ul>
<li>数组类型：GenericArrayType</li>
<li>参数化类型：ParameterizedType</li>
<li>类型变量：TypeVariable</li>
<li>通配符类型：WildcardType</li>
<li>原始类型：Class</li>
<li>基本类型：Class</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b8f50da20bead099ffecc9e2ee818530>5 - CH05-注解机制</h1>
<h2 id=概览>概览</h2>
<p>注解是 JDK 1.5 版本开始引入的一个特性，用于对代码进行说明，可以对包、类、接口、字段、方法参数、局部变量等进行注解。它主要的作用有以下四方面：</p>
<ul>
<li>
<p>生成文档，通过代码里标识的元数据生成javadoc文档。</p>
</li>
<li>
<p>编译检查，通过代码里标识的元数据让编译器在编译期间进行检查验证。</p>
</li>
<li>
<p>编译时动态处理，编译时通过代码里标识的元数据动态处理，例如动态生成代码。</p>
</li>
<li>
<p>运行时动态处理，运行时通过代码里标识的元数据动态处理，例如使用反射注入实例。</p>
</li>
</ul>
<p>比如：</p>
<ul>
<li><strong>Java自带的标准注解</strong>，包括<code>@Override</code>、<code>@Deprecated</code>和<code>@SuppressWarnings</code>，分别用于标明重写某个方法、标明某个类或方法过时、标明要忽略的警告，用这些注解标明后编译器就会进行检查。</li>
<li><strong>元注解</strong>，元注解是用于定义注解的注解，包括<code>@Retention</code>、<code>@Target</code>、<code>@Inherited</code>、<code>@Documented</code>，<code>@Retention</code>用于标明注解被保留的阶段，<code>@Target</code>用于标明注解使用的范围，<code>@Inherited</code>用于标明注解可继承，<code>@Documented</code>用于标明是否生成javadoc文档。</li>
<li><strong>自定义注解</strong>，可以根据自己的需求定义注解，并可用元注解对自定义注解进行注解。</li>
</ul>
<h3 id=内置注解>内置注解</h3>
<ul>
<li>@Override</li>
<li>@Deprecated</li>
<li>@SuppressWarnings</li>
</ul>
<h3 id=元注解>元注解</h3>
<ul>
<li>@Target</li>
<li>@Retention，@RetentionTarget</li>
<li>@Documented</li>
<li>@Inherited</li>
<li>@Repeatable</li>
<li>@Native</li>
</ul>
<h3 id=注解与反射接口>注解与反射接口</h3>
<p>通过反射工具包 <code>java.lang.reflect</code> 中的 <code>AnnotatedElement</code> 可以访问注解信息。注意仅在注解被声明为 RUNTIME 时，才能在运行时获取注解信息，当 class 文件被加载时保存在 class 文件中的注解信息才会被 JVM 读取。</p>
<p>AnnotatedElement 接口是所有成语元素的父接口，所有程序通过反射获得了某个类的 AnnotatedElement 对象之后，就可以调用该对象的方法来访问具体的注解信息：</p>
<ul>
<li><code>boolean isAnnotationPresent(Class&lt;?extends Annotation> annotationClass)</code></li>
<li><code>&lt;T extends Annotation> T getAnnotation(Class&lt;T> annotationClass)</code></li>
<li><code>Annotation[] getAnnotations()</code></li>
<li><code>&lt;T extends Annotation> T[] getAnnotationsByType(Class&lt;T> annotationClass)</code></li>
<li><code>&lt;T extends Annotation> T[] getDeclaredAnnotationsByType(Class&lt;T> annotationClass)</code></li>
<li><code>Annotation[] getDeclaredAnnotations()</code></li>
</ul>
<h3 id=自定义注解>自定义注解</h3>
<p>定义注解：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>MyMethodAnnotation</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>description</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用注解：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestMethodAnnotation</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;toStringMethod&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>description</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;override toString method&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Override toString method&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Deprecated</span>
    <span style=color:#5c35cc;font-weight:700>@MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;old static method&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>description</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;deprecated old static method&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>oldMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;old method, don&#39;t use it.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;deprecation&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#5c35cc;font-weight:700>@MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test method&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>description</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;suppress warning static method&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>genericsTest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>FileNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span> <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>oldMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>读取注解：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TestMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#4e9a06>&#34;com.pdai.java.annotation.TestMethodAnnotation&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethods</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 方法上是否有MyMethodAnnotation注解
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotationPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取并遍历方法上的所有注解
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Annotation</span> <span style=color:#000>anno</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredAnnotations</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Annotation in Method &#39;&#34;</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; : &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>anno</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 获取MyMethodAnnotation对象信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>MyMethodAnnotation</span> <span style=color:#000>methodAnno</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span>
                    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodAnno</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>title</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=注解特性>注解特性</h2>
<h3 id=java-8-新特性>Java 8 新特性</h3>
<ul>
<li>@Repeatable</li>
<li>@ElementType.TYPE_USE</li>
<li>@ElementType.TYPE_PARAMETER</li>
</ul>
<p>TYPE_USE 包括类型声明和类型参数声明，是为了方便设计者进行类型检查。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 自定义ElementType.TYPE_PARAMETER注解
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE_PARAMETER</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>MyNotEmpty</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 自定义ElementType.TYPE_USE注解
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE_USE</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>MyNotNull</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 测试类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TypeParameterAndTypeUseAnnotation</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#5c35cc;font-weight:700>@MyNotEmpty</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;{</span>

  <span style=color:#8f5902;font-style:italic>//使用TYPE_PARAMETER类型，会编译不通过
</span><span style=color:#8f5902;font-style:italic>//		public @MyNotEmpty T test(@MyNotEmpty T a){
</span><span style=color:#8f5902;font-style:italic>//			new ArrayList&lt;@MyNotEmpty String&gt;();
</span><span style=color:#8f5902;font-style:italic>//				return a;
</span><span style=color:#8f5902;font-style:italic>//		}
</span><span style=color:#8f5902;font-style:italic></span>
  <span style=color:#8f5902;font-style:italic>//使用TYPE_USE类型，编译通过
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@MyNotNull</span> <span style=color:#000>T</span> <span style=color:#000>test2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@MyNotNull</span> <span style=color:#000>T</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#5c35cc;font-weight:700>@MyNotNull</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f947a3a008aa40dbb8eed80c6ed1d899>6 - CH06-异常机制</h1>
<h2 id=概览>概览</h2>
<p>Java 异常是 Java 提供的一种识别及响应错误的机制，Java 异常机制可以使程序中异常处理的代码和正常业务代码分离，保证程序代码更加优雅，并提高程序的健壮性。</p>
<h2 id=层次结构>层次结构</h2>
<p>异常是指非预期的各种状况，如：文件找不到、网络连接失败、非法参数等。异常是一个事件，它发生在程序运行期间，干扰了正常的指令流程。Java 通过 API 中 Throwable 类的众多子类描述各种不同的异常。因此，Java 异常都是对象，是 Throwable 子类的实例，描述了出现在一段编码中的错误条件。当条件生成时，错误将引发异常。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210414223305.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=throwable>Throwable</h3>
<p>Throwable 是 Java 语言中所有错误与异常的超类。</p>
<p>Throwable 包含两个子类：Error（错误）和 Exception（异常），它们通常用于指示发生了异常情况。</p>
<p>Throwable 包含了其线程创建时线程执行堆栈的快照，它提供了 printStackTrace() 等接口用于获取堆栈跟踪数据等信息。</p>
<h3 id=error>Error</h3>
<p>Error 类及其子类：程序中无法处理的错误，表示运行应用程序中出现了严重的错误。</p>
<p>此类错误一般表示代码运行时 JVM 出现问题。通常有 Virtual MachineError(虚拟机运行错误)、NoClassDefFoundError(类定义错误)等。比如 OutOfMemoryError：内存不足错误；StackOverflowError：栈溢出错误。此类错误发生时，JVM 将终止线程。</p>
<p>这些错误是不受检异常，非代码性错误。因此，当此类错误发生时，应用程序不应该去处理此类错误。按照 Java 惯例，我们是不应该实现任何新的 Error 子类的！</p>
<h3 id=exception>Exception</h3>
<p>程序本身可以捕获并且可以处理的异常。Exception 这种异常又分为两类：运行时异常和编译时异常。</p>
<ul>
<li>运行时异常
<ul>
<li>都是 RuntimeException 类及其子类异常，如 NullPointerException(空指针异常)、IndexOutOfBoundsException(下标越界异常)等，这些异常是不检查异常，程序中可以选择捕获处理，也可以不处理。这些异常一般是由程序逻辑错误引起的，程序应该从逻辑角度尽可能避免这类异常的发生。</li>
<li>运行时异常的特点是 Java 编译器不会检查它，也就是说，当程序中可能出现这类异常，即使没有用 try-catch 语句捕获它，也没有用 throws 子句声明抛出它，也会编译通过。</li>
</ul>
</li>
<li>编译期异常
<ul>
<li>是 RuntimeException 以外的异常，类型上都属于 Exception 类及其子类。从程序语法角度讲是必须进行处理的异常，如果不处理，程序就不能编译通过。如 IOException、SQLException 等以及用户自定义的 Exception 异常，一般情况下不自定义检查异常。</li>
</ul>
</li>
</ul>
<h3 id=受检异常非受检异常>受检异常/非受检异常</h3>
<ul>
<li>受检异常：编译器妖气必须处理的异常
<ul>
<li>正确的程序在运行中，很容易出现的、情理可容的异常状况。可查异常虽然是异常状况，但在一定程度上它的发生是可以预计的，而且一旦发生这种异常状况，就必须采取某种方式进行处理。</li>
<li>除了 RuntimeException 及其子类以外，其他的 Exception 类及其子类都属于受检异常。这种异常的特点是 Java 编译器会检查它，也就是说，当程序中可能出现这类异常，要么用 try-catch 语句捕获它，要么用 throws 子句声明抛出它，否则编译不会通过。</li>
</ul>
</li>
<li>非受检异常：编译器不强制要求检查的异常
<ul>
<li>包括运行时异常(RuntimeException与其子类)和错误(Error)。</li>
</ul>
</li>
</ul>
<h2 id=异常基础>异常基础</h2>
<h3 id=关键字>关键字</h3>
<ul>
<li>try：监听异常</li>
<li>catch：捕获异常</li>
<li>finally：总是执行</li>
<li>throw：抛出异常</li>
<li>throws：声明异常</li>
</ul>
<h3 id=异常捕获>异常捕获</h3>
<ul>
<li>try-catch</li>
<li>try-catch-finally</li>
<li>try-finally</li>
<li>try-with-resource: AutoCloseable</li>
</ul>
<h3 id=常见异常>常见异常</h3>
<ul>
<li>RuntimeException
<ul>
<li>ArrayIndexOutOfBoundsException：数组索引越界</li>
<li>ArithmeticException：除零异常</li>
<li>NullPointerException：空指针</li>
<li>ClassNotFoundException：类加载</li>
<li>NegativeArraySizeException：数组长度为负</li>
<li>ArrayStoreException：数组元素类型不兼容</li>
<li>SecurityException：安全性异常</li>
<li>IllegalArgumentException：非法参数</li>
</ul>
</li>
<li>IOException
<ul>
<li>IOException：输出输出流异常</li>
<li>EOFException：文件结束</li>
<li>FileNotFoundException：文件未找到</li>
</ul>
</li>
<li>Others
<ul>
<li>ClassCastException</li>
<li>SQLException</li>
<li>NoSuchFieldException</li>
<li>NoSuchMethodException</li>
<li>NumberFormatException</li>
<li>StringIndexOutOfBoundsException</li>
<li>IllegalAccessException</li>
<li>InstantiationException</li>
</ul>
</li>
</ul>
<h3 id=应用实践>应用实践</h3>
<ul>
<li>在恰当的级别处理异常，即知道该如何处理的地方及时处理异常。</li>
<li>解决问题并且重新调用产生异常的方法。</li>
<li>进行少许修补，然后绕过异常发生的地方继续执行。</li>
<li>用别的数据进行计算，以代替方法预计会返回的值。</li>
<li>把当前运行环境下能做的事尽量做完，然后把相同的异常重抛到更高层。</li>
<li>终止程序。</li>
<li>进行简化。</li>
<li>让类库和程序更安全。</li>
<li>不要通过异常来实现业务流程。</li>
</ul>
<h2 id=底层机制>底层机制</h2>
<h3 id=try-catch>try-catch</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>simpleTryCatch</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>testNPE</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 javap 的带编译后的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//javap -c Main
 public static void simpleTryCatch();
    Code:
       0: invokestatic  #3                  // Method testNPE:()V
       3: goto          11
       6: astore_0
       7: aload_0
       8: invokevirtual #5                  // Method java/lang/Exception.printStackTrace:()V
      11: return
    Exception table:
       from    to  target type
           0     3     6   Class java/lang/Exception
</code></pre></div><p>异常表中包含了一个或多个异常处理器的信息，内容如下：</p>
<ul>
<li>from：可能发生异常的起始点</li>
<li>to：可能发生异常的结束点</li>
<li>target：从 from 到 to 之间发生异常后异常处理器的位置</li>
<li>type：异常处理器所处理的异常类型</li>
</ul>
<p>当发生一个异常时：</p>
<ol>
<li>JVM 会在当前出现异常的方法中查找异常表，检查是否有合适的处理器</li>
<li>如果当前方法的异常表不为空，且异常符合表中 from to 的范围，同时 type 匹配，则 JVM 将调用位于 target 的处理器来处理异常</li>
<li>如果上一步没有找到处理器，则继续检查异常表中的下一项</li>
<li>如果当前异常表无法处理，则向上查找(弹栈)调用方法的调用点，并重复 1-3 步的操作。</li>
<li>如果所有栈帧都被弹出，仍然没有处理，则抛出异常给当前 Thread，Thread 会终止。</li>
<li>如果当前 Thread 为最后一个非守护线程，且异常未处理，则导致 JVM 终止运行。</li>
</ol>
<h3 id=try-catch-finally>try-catch-finally</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>simpleTryCatchFinally</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>testNPE</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finally&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 javap 得到异常表部分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public static void simpleTryCatchFinally();
    Code:
       0: invokestatic  #3                  // Method testNPE:()V
       3: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;
       6: ldc           #7                  // String Finally
       8: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      11: goto          41
      14: astore_0
      15: aload_0
      16: invokevirtual #5                  // Method java/lang/Exception.printStackTrace:()V
      19: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;
      22: ldc           #7                  // String Finally
      24: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      27: goto          41
      30: astore_1
      31: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;
      34: ldc           #7                  // String Finally
      36: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      39: aload_1
      40: athrow
      41: return
    Exception table:
       from    to  target type
           0     3    14   Class java/lang/Exception
           0     3    30   any
          14    19    30   any
</code></pre></div><ul>
<li>如果 0-3 之间发生了 Exception 异常，调用 14 位置的处理器。</li>
<li>如果 0-3 之间无论发生哪种异常，都调用 30 位置的处理器。</li>
<li>如果 14-19(catch) 之间无论发生什么异常，都调用 30 位置的处理器。</li>
</ul>
<p>注意异常表会代码中 finally 的部分同时在异常表的 catch 和 finally 部分注册，以实现无论是否发生异常都执行的逻辑。</p>
<h3 id=catch-先后顺序>catch 先后顺序</h3>
<p>先 catch 类层级较高的异常类型会导致编译错误。</p>
<h3 id=return-与-finally>return 与 finally</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>tryCatchReturn</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>testNPE</span><span style=color:#ce5c00;font-weight:700>();</span>
       <span style=color:#204a87;font-weight:700>return</span>  <span style=color:#4e9a06>&#34;OK&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;ERROR&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tryCatchReturn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里无论是否抛出一查，finally 部分都会执行。</p>
<h3 id=性能损耗>性能损耗</h3>
<p>创建一个异常对象是创建一个普通对象所需耗时的几十倍，抛出、捕获异常则是创建异常对象所需耗时的数倍。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1782eebed124e635eda873f42d596c92>7 - CH07-反射机制</h1>
<h2 id=反射基础>反射基础</h2>
<p>Runtime Type Identification(RTTI) 运行时类型识别，作用是在运行时识别一个对象的类型和类信息。主要有两种方式：</p>
<ul>
<li>传统的的 RTTI，它假设我们在编译期就知道了所有的类型。</li>
<li>反射机制，它允许我们在运行时发现和使用类的信息。</li>
</ul>
<h3 id=class-类>Class 类</h3>
<p>Class 类就像 String 类、Object 类一样，是一个实实在在的类，存在与 java.lang 包中。Class 类的实例表示 java 应用运行时的类(class ans enum)或接口(interface and annotation)，可以通过 <code>类名.class</code>、<code>类型.class</code>、<code>Class.forName(类名)</code>等方法获取 Class 类的对象实例。</p>
<p>数组同样也被映射为为 class 对象的一个类，所有具有相同元素类型和维数的数组都共享该 Class 对象。基本类型boolean，byte，char，short，int，long，float，double 和关键字 void 同样表现为 class 对象。</p>
<ul>
<li>Class 类也是类的一种，与 class 关键字是不一样的。</li>
<li>手动编写的类被编译后会产生一个 Class 对象，其表示的是创建的类的类型信息，而且这个 Class 对象保存在 同名.class 的文件中(字节码文件)</li>
<li>每个通过关键字 class 标识的类，在内存中有且只有一个与之对应的 Class 对象来描述其类型信息，无论创建多少个实例对象，其依据的都是用一个Class对象。</li>
<li>Class 类只有私有构造函数，因此对应 Class 对象只能由 JVM 创建和加载。</li>
<li>Class 类的对象作用是运行时提供或获得某个对象的类型信息。</li>
</ul>
<h3 id=类加载>类加载</h3>
<p>类加载流程：</p>
<ul>
<li>加载</li>
<li>连接
<ul>
<li>验证</li>
<li>准备</li>
<li>解析</li>
</ul>
</li>
<li>初始化</li>
<li>使用</li>
<li>卸载</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210414231732.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=反射应用>反射应用</h2>
<p>在Java中，Class类与java.lang.reflect类库一起对反射技术进行了全力的支持。在反射包中，我们常用的类主要有Constructor类表示的是Class 对象所表示的类的构造方法，利用它可以在运行时动态创建对象、Field表示Class对象所表示的类的成员变量，通过它可以在运行时动态修改成员变量的属性值(包含private)、Method表示Class对象所表示的类的成员方法，通过它可以动态调用对象的方法(包含private)，下面将对这几个重要类进行分别说明。</p>
<h3 id=class-对象>Class 对象</h3>
<ul>
<li>类名.class</li>
<li>对象.getClass()</li>
<li>完全限定名：Class.forName(全限定类名)</li>
</ul>
<h3 id=class-方法>Class 方法</h3>
<ul>
<li>forName()</li>
<li>Object.getClass()</li>
<li>getName()：类的全限定名，可用于 Class.forName</li>
<li>getSimpleName()：仅类名</li>
<li>getCanonicalName()：更易理解的完全限定名，数组时表示不同</li>
<li>isInterface()</li>
<li>getInterfaces()</li>
<li>getSupercalss()</li>
<li>newInstance()</li>
<li>getFields()</li>
<li>getDeclaredFields()</li>
<li>getConstructors()</li>
<li>&mldr;</li>
</ul>
<h3 id=constructor>Constructor</h3>
<h3 id=field>Field</h3>
<h3 id=method>Method</h3>
<h2 id=反射流程>反射流程</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloReflect</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 1. 使用外部配置的实现，进行动态加载类
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TempFunctionTest</span> <span style=color:#000>test</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TempFunctionTest</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.tester.HelloReflect&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sayHello</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;call directly&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 2. 根据配置的函数名，进行方法调用（不需要通用的接口抽象）
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TempFunctionTest</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sayHello&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;method invoke&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalAccessException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchMethodException</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationTargetException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sayHello</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>word</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello,&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>word</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210414232506.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=反射获取类实例>反射获取类实例</h3>
<p>通过 Class 的静态方法，获取类信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 先通过反射，获取调用进来的类信息，从而获取当前的 classLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 调用native方法进行获取class信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>forName0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后，JVM 会回调 ClassLoader 执行类加载：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// sun.misc.Launcher
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastIndexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>46</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var3</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SecurityManager</span> <span style=color:#000>var4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var4</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>var4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkPackageAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ucp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownToNotExist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span> <span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findLoadedClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassNotFoundException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// java.lang.ClassLoader
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 先获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoadingLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// First, check if the class has already been loaded
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 如果已经加载了的话，就不用再加载了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findLoadedClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 双亲委托加载
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findBootstrapClassOrNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// ClassNotFoundException thrown if class not found
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// from the non-null parent class loader
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 父类没有加载到时，再自己加载
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// If still not found, then invoke findClass in order
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// to find the class.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// this is the defining class loader; record the stats
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentDelegationTime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>t0</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFindClassTime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addElapsedTimeFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFindClasses</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>increment</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getClassLoadingLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parallelLockMap</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用 ConcurrentHashMap来保存锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>newLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parallelLockMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newLock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newLock</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>findLoadedClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>checkName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>findLoadedClass0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以下是 newInstance 的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 首先肯定是 Class.newInstance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalAccessException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUBLIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// NOTE: the following code may not be strictly correct under
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// the current Java memory model.
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// Constructor lookup
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// newInstance() 其实相当于调用类的无参构造函数，所以，首先要找到其无参构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedConstructor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 不允许调用 Class 的 newInstance() 方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;Can not call newInstance() on the Class for java.lang.Class&#34;</span>
            <span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取无参构造器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>empty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{};</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConstructor0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECLARED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// Disable accessibility checks on the constructor
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// since we have to do the security check here anyway
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// (the stack depth is wrong for the Constructor&#39;s
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// security check to work)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#000>cachedConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchMethodException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>initCause</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tmpConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedConstructor</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Security check (same as in java.lang.reflect.Constructor)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>modifiers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tmpConstructor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>quickCheckMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newInstanceCallerCache</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ensureMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>newInstanceCallerCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// Run constructor
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 调用无参构造器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tmpConstructor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[])</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationTargetException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>throwException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetException</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>// Not reached
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>newInstance 的主要逻辑：</p>
<ol>
<li>权限检测，如果不通过则直接报错</li>
<li>查找无参构造器，并将其缓存</li>
<li>调用具体方法的无参构造方法，生成实例并返回</li>
</ol>
<p>以下是获取构造器过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getConstructor0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>which</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>NoSuchMethodException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取所有构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>constructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>privateGetDeclaredConstructors</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>which</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUBLIC</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>constructor</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>constructors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrayContentsEq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getReflectionFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>copyConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchMethodException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&lt;init&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argumentTypesToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>获取构造器分为三步：</p>
<ol>
<li>先获取所有的 constructors, 然后执行参数类型比较；</li>
<li>如果存在匹配，通过 ReflectionFactory copy 一份 constructor 返回；</li>
<li>否则抛出 NoSuchMethodException;</li>
</ol>
<p>下面是获取所有构造器的过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 获取当前类所有的构造方法，通过jvm或者缓存
</span><span style=color:#8f5902;font-style:italic>// Returns an array of &#34;root&#34; constructors. These Constructor
</span><span style=color:#8f5902;font-style:italic>// objects must NOT be propagated to the outside world, but must
</span><span style=color:#8f5902;font-style:italic>// instead be copied via ReflectionFactory.copyConstructor.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>privateGetDeclaredConstructors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkInitted</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 调用 reflectionData(), 获取保存的信息，使用软引用保存，从而使内存不够可以回收
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>publicOnly</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publicConstructors</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredConstructors</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 存在缓存，则直接返回
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// No cached value available; request value from VM
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>temporaryRes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temporaryRes</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用native方法从jvm获取构造器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDeclaredConstructors0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 最后，将从jvm中读取的内容，存入缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publicConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Lazily create and cache ReflectionData
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>reflectionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflectionData</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>classRedefinedCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>useCaches</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#000>reflectionData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>redefinedCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// else no SoftReference or cleared SoftReference or stale ReflectionData
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// -&gt; create and replace new instance
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 新创建缓存，保存反射信息
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>oldReflectionData</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>useCaches</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 使用cas保证更新的线程安全性，所以反射是保证线程安全的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// try to CAS it...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Atomic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>casReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>oldReflectionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 先使用CAS更新，如果更新成功，则立即返回，否则测查当前已被其他线程更新的情况，如果和自己想要更新的状态一致，则也算是成功了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>oldReflectionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflectionData</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>classRedefinedCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldReflectionData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldReflectionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>redefinedCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>首先阐释缓存中获取</li>
<li>如果没有缓存，则从 JVM 中重新加载，并存入缓存，缓存使用软引用保存，保证内存可用。</li>
</ol>
<p>另外，使用 relactionData() 进行缓存保存；ReflectionData 的数据结构如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// reflection data that might get invalidated when JVM TI RedefineClasses() is called
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredFields</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>publicFields</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>publicMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>declaredConstructors</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>publicConstructors</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Intermediate results for getFields and getMethods
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredPublicFields</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredPublicMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// Value of classRedefinedCount when we created this ReflectionData instance
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>redefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>redefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>redefinedCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>redefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>比较构造是否是要查找构造器，其实就是比较类型完全相等性，有一个不相等则返回 false。</p>
<p>最终通过以下逻辑获得构造器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>arrayContentsEq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>a2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.ReflectionFactory
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>/** Makes a copy of the passed constructor. The returned
</span><span style=color:#8f5902;font-style:italic>    constructor is a &#34;child&#34; of the passed one; see the comments
</span><span style=color:#8f5902;font-style:italic>    in Constructor.java for details. */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>copyConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>langReflectAccess</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>copyConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// java.lang.reflect.Constructor, copy 其实就是新new一个 Constructor 出来
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// This routine enables sharing of ConstructorAccessor objects
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// among Constructor objects which refer to the same underlying
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// method in the VM. (All of this contortion is only necessary
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// because of the &#34;accessibility&#34; bit in AccessibleObject,
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// which implicitly requires that new java.lang.reflect
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// objects be fabricated for each reflective call on Class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// objects.)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Can not copy a non-root Constructor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>exceptionTypes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>slot</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>signature</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>annotations</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>parameterAnnotations</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// root 指向当前 constructor
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Might as well eagerly propagate this if already present
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorAccessor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorAccessor</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后只需调用对应构造器的 newInstance 方法即可返回实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// return tmpConstructor.newInstance((Object[])null); 
</span><span style=color:#8f5902;font-style:italic>// java.lang.reflect.Constructor
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>initargs</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span>
           <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>override</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>quickCheckMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>checkAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENUM</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cannot reflectively create enum objects&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ConstructorAccessor</span> <span style=color:#000>ca</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorAccessor</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>// read volatile
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ca</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ca</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>acquireConstructorAccessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>T</span> <span style=color:#000>inst</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ca</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initargs</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>inst</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.DelegatingConstructorAccessorImpl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span>
         <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span>
         <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.NativeConstructorAccessorImpl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span>
           <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span>
           <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// We can&#39;t inflate a constructor belonging to a vm-anonymous class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// because that kind of class can&#39;t be referred to by name, hence can&#39;t
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// be found from the generated bytecode.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>numInvocations</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ReflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inflationThreshold</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConstructorAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConstructorAccessorImpl</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
                <span style=color:#000>generateConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 调用native方法，进行调用 constructor
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newInstance0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>返回实例之后，可以根据实际需要执行类型转化，以调用具体类型的方法。</p>
<h3 id=反射获取方法>反射获取方法</h3>
<p>首先获取 Method：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// java.lang.Class
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Method</span> <span style=color:#000>getDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;...</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>NoSuchMethodException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SecurityException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECLARED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>searchMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>privateGetDeclaredMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchMethodException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argumentTypesToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>获取所有方法列表</li>
<li>更具方法名和方法列表，找到符合要求的方法</li>
<li>如果没有则抛出异常，有则返回方法</li>
</ol>
<p>首先获取类的所有方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Returns an array of &#34;root&#34; methods. These Method objects must NOT
</span><span style=color:#8f5902;font-style:italic>// be propagated to the outside world, but must instead be copied
</span><span style=color:#8f5902;font-style:italic>// via ReflectionFactory.copyMethod.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>privateGetDeclaredMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkInitted</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>publicOnly</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredPublicMethods</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// No cached value available; request value from VM
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filterMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getDeclaredMethods0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredPublicMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>与构造器类似，首先读取缓存，没有缓存则从 JVM 中获取。</p>
<p>不同的是，方法列表执行过滤 Reflection.filterMethods。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// sun.misc.Reflection
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filterMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>containingClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodFilterMap</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Bootstrapping
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[])</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodFilterMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingClass</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// 可以过滤指定的方法，一般为空，如果要指定过滤，可以调用 registerMethodsToFilter(), 或者...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>filteredNames</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numNewMembers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span> <span style=color:#000>member</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>filteredName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>filteredNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>filteredName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>numNewMembers</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newMembers</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[])</span><span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>numNewMembers</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>destIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span> <span style=color:#000>member</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>filteredName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>filteredNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>filteredName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>newMembers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>destIdx</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newMembers</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后<strong>根据方法名和参数类型过滤指定方法返回</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Method</span> <span style=color:#000>searchMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Method</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 使用常量池，避免重复创建String
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>internedName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intern</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Method</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>internedName</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>arrayContentsEq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span>
                <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>())))</span>
            <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getReflectionFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>copyMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在执行匹配的过程将会尝试最精确的匹配，最后会通过 ReflectionFactory.copy 返回方法。</p>
<h3 id=调用-methodinvoke>调用 method.invoke</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span>
       <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>override</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>quickCheckMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>checkAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>MethodAccessor</span> <span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodAccessor</span><span style=color:#ce5c00;font-weight:700>;</span>             <span style=color:#8f5902;font-style:italic>// read volatile
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>acquireMethodAccessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ma</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 MethodAccessor 执行调用，而 MethodAccessor 为接口，在第一次使用时或调用 acquireMethodAccessor 新建实例。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// probably make the implementation more scalable.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MethodAccessor</span> <span style=color:#000>acquireMethodAccessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// First check to see if one has been created yet, and take it
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// if so
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MethodAccessor</span> <span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodAccessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 存在缓存时，存入 methodAccessor，否则调用 ReflectionFactory 创建新的 MethodAccessor
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>methodAccessor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Otherwise fabricate one and propagate it up to the root
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMethodAccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>setMethodAccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.ReflectionFactory
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MethodAccessor</span> <span style=color:#000>newMethodAccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkInitted</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>noInflation</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
            <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>NativeMethodAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>两种 Accessor 的细节：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//     NativeMethodAccessorImpl / DelegatingMethodAccessorImpl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NativeMethodAccessorImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numInvocations</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// We can&#39;t inflate methods belonging to vm-anonymous classes because
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// that kind of class can&#39;t be referred to by name, hence can&#39;t be
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// found from the generated bytecode.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>numInvocations</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ReflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inflationThreshold</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
                    <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#000>Object</span> <span style=color:#000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行 method.invoke(obj, args) 时，滴啊用 DelegatingMethodAccessorImpl.invoke()，最后被委托到 NativeMethodAccessorImpl.invoke()：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// We can&#39;t inflate methods belonging to vm-anonymous classes because
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// that kind of class can&#39;t be referred to by name, hence can&#39;t be
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// found from the generated bytecode.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>numInvocations</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ReflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inflationThreshold</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
                <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// invoke0 是个 native 方法，由jvm进行调用业务方法。从而完成反射调用功能。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其中，generateMethod 是生成具体类的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** This routine is not thread-safe */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MethodAccessor</span> <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>String</span>   <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span>   <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>checkedExceptions</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>generate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>checkedExceptions</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>generate 的实现中会出现：ClassDefiner.defineClass(xx, declaringClass.getClassLoader()).newInstance()。</p>
<p>在<code>ClassDefiner.defineClass</code>方法实现中，每被调用一次都会生成一个DelegatingClassLoader类加载器对象 ，这里每次都生成新的类加载器，是为了性能考虑，在某些情况下可以卸载这些生成的类，因为类的卸载是只有在类加载器可以被回收的情况下才会被回收的，如果用了原来的类加载器，那可能导致这些新创建的类一直无法被卸载。</p>
<p>而反射生成的类，有时候可能用了就可以卸载了，所以使用其独立的类加载器，从而使得更容易控制反射类的生命周期。</p>
<h3 id=反射汇总>反射汇总</h3>
<ol>
<li>反射类及反射方法的获取，都是通过从列表中搜寻查找匹配的方法，所以查找性能会随类的大小方法多少而变化；</li>
<li>每个类都会有一个与之对应的Class实例，从而每个类都可以获取method反射方法，并作用到其他实例身上；</li>
<li>反射也是考虑了线程安全；</li>
<li>反射使用软引用relectionData缓存class信息，避免每次重新从jvm获取带来的开销；</li>
<li>反射调用多次生成新代理Accessor, 而通过字节码生成的则考虑了卸载功能，所以会使用独立的类加载器；</li>
<li>当找到需要的方法，都会copy一份出来，而不是使用原来的实例，从而保证数据隔离；</li>
<li>调用反射方法，最终是由jvm执行invoke0()执行；</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4a27de20847a48405d85a4161174c1ee>8 - CH08-SPI 机制</h1>
<h2 id=概览>概览</h2>
<p>Service Provider Interface(SPI) 是 JDK 内置的服务发现机制，可以用来启用框架扩展或替换组件，主要用于框架。比如 java.sql.Driver 接口，不同的数据库厂商可以针对同一接口提供不同的实现，MySQL 和 PostgreSQL 分别为用户提供了不同的实现。</p>
<p>Java SPI 机制的主要思想是将装配的控制权移交到程序之外，目的在于解耦。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210415224103.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当服务的提供者提供了一种接口的实现后，需要在 classpath 下的 <code>META-INF/services/</code> 目录中创建一个以服务接口命名的文件，并在该文件中添加实现类的完全限定名。其他程序可以通过 ServiceLoader 查找这个 jar 包的配置文件，根据其中的实现类名加载并实例化，然后使用实现类提供的功能。</p>
<h2 id=示例>示例</h2>
<ol>
<li>
<p>定义接口</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Serach</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>serach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>keyword</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>实现接口</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FileSearch</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Search</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>search</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>keyword</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>...;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DatabaseSearch</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Search</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>search</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>keyword</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>...;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>在 <code>/resource/META-INF/services/</code> 目录下创建 <code>com.example.Search</code> 文件，在其中添加我们要使用的某个实现类的完全限定名，如<code>com.example.FileSearch</code>。</p>
</li>
<li>
<p>加载接口实现类</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Search</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>impls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SeraiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Serach</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Serach</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>itor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>impls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>()){</span>
  <span style=color:#000>Search</span> <span style=color:#000>search</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>itor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#000>search</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>search</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyword&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
</ol>
<h2 id=实际应用>实际应用</h2>
<h3 id=jdbc-drivermanager>JDBC DriverManager</h3>
<ul>
<li>JDBC 接口定义：首先 Java 中定义了接口 <code>java.sql.Driver</code>。</li>
<li>MySQL 实现类：在 mysql-connector-java-version.jar 中，可以找打 <code>META-INF/services</code> 目录查看其中的 <code>java.sql.Driver</code> 文件，其中定义了实现类名 <code>com.mysql.cj.jdbc.Driver</code>。</li>
<li>加载实现类：<code>DriverManager.getConnection(uil,username,password)</code>。</li>
</ul>
<p>DriverManager 的具体加载过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadInitialDrivers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbc.drivers&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			      <span style=color:#8f5902;font-style:italic>//使用SPI的ServiceLoader来加载接口的实现
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loadedDrivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>driversIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadedDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driversIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>driversIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Do nothing
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>});</span>

    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DriverManager.initialize: jdbc.drivers = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>driversList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;:&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;number of Drivers:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>driversList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>aDriver</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>driversList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DriverManager.Initialize: loading &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>aDriver</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DriverManager.Initialize: load failed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>从系统变量中获取有关驱动的定义。</li>
<li>使用 SPI 获取驱动实现。</li>
<li>遍历 SPI 获取到的具体实现类，实例化各个实现类。</li>
<li>根据第一步得到的驱动列表实例化具体实现类。</li>
</ol>
<h3 id=common-logging>Common Logging</h3>
<p>通过 <code>LogFactory.getLog</code> 获取日志实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>LogConfigurationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>LogFactory 是一个抽象类，它负责加载具体的日志实现，具体过程为：</p>
<ol>
<li>从 JVM 系统属性获取相关配置</li>
<li>使用 SPI 查找得到 <code>org.apache.commons.logging.LogFactory</code> 实现</li>
<li>查找 classpath 根目录 <code>commons-logging.properties</code> 的属性是否设置特定的实现</li>
<li>使用默认实现类</li>
</ol>
<h3 id=eclipse-osgi-插件体系>Eclipse OSGI 插件体系</h3>
<p>Eclipse使用OSGi作为插件系统的基础，动态添加新插件和停止现有插件，以动态的方式管理组件生命周期。</p>
<p>一般来说，插件的文件结构必须在指定目录下包含以下三个文件：</p>
<ul>
<li><code>META-INF/MANIFEST.MF</code>: 项目基本配置信息，版本、名称、启动器等</li>
<li><code>build.properties</code>: 项目的编译配置信息，包括，源代码路径、输出路径</li>
<li><code>plugin.xml</code>：插件的操作配置信息，包含弹出菜单及点击菜单后对应的操作执行类等</li>
</ul>
<p>当eclipse启动时，会遍历plugins文件夹中的目录，扫描每个插件的清单文件<code>MANIFEST.MF</code>，并建立一个内部模型来记录它所找到的每个插件的信息，就实现了动态添加新的插件。</p>
<p>这也意味着是 eclipse 制定了一系列的规则，像是文件结构、类型、参数等。插件开发者遵循这些规则去开发自己的插件，eclipse并不需要知道插件具体是怎样开发的，只需要在启动的时候根据配置文件解析、加载到系统里就好了，是spi思想的一种体现。</p>
<h3 id=spring-factory>Spring Factory</h3>
<p>在 springboot 的自动装配过程中，最终会加载<code>META-INF/spring.factories</code>文件，而加载的过程是由<code>SpringFactoriesLoader</code>加载的。从 CLASSPATH 下的每个 Jar 包中搜寻所有<code>META-INF/spring.factories</code>配置文件，然后将解析 properties 文件，找到指定名称的配置后返回。需要注意的是，其实这里不仅仅是会去 ClassPath 路径下查找，会扫描所有路径下的 Jar 包，只不过这个文件只会在 Classpath 下的 jar 包中。</p>
<h2 id=实现原理>实现原理</h2>
<p>ServiceLoader 的具体实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ServiceLoader实现了Iterable接口，可以遍历所有的服务实现者
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//查找配置文件的目录
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>PREFIX</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;META-INF/services/&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//表示要被加载的服务的类或接口
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//这个ClassLoader用来定位，加载，实例化服务提供者
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 访问控制上下文
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AccessControlContext</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 缓存已经被实例化的服务提供者，按照实例化的顺序存储
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>providers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

    <span style=color:#8f5902;font-style:italic>// 迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LazyIterator</span> <span style=color:#000>lookupIterator</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//重新加载，就相当于重新创建ServiceLoader了，用于新的服务提供者安装到正在运行的Java虚拟机中的情况。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reload</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//清空缓存中所有已实例化的服务提供者
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//新建一个迭代器，该迭代器会从头查找和实例化服务提供者
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>lookupIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LazyIterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//私有构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//使用指定的类加载器和服务创建服务加载器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//如果没有指定类加载器，使用系统类加载器，就是应用类加载器。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Service interface cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>reload</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//解析失败处理的方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceConfigurationError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceConfigurationError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//解析服务提供者配置文件中的一行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//首先去掉注释校验，然后保存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//返回下一行行号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//重复的配置项和已经被实例化的配置项不会被保存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parseLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BufferedReader</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//读取一行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLine</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//#号代表注释行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ci</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;#&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ci</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ci</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;\t&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal configuration-file syntax&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>codePointAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isJavaIdentifierStart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal provider-class name: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>charCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>charCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>codePointAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isJavaIdentifierPart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal provider-class name: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//解析配置文件，解析指定的url配置文件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//使用parseLine方法进行解析，未被实例化的服务提供者会被保存到缓存中去
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>BufferedReader</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>names</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;utf-8&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//服务提供者查找的迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LazyIterator</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//服务提供者接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//类加载器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Enumeration</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//保存实现类的url
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pending</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//保存实现类的全名
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//迭代器中下一个实现类的全名
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LazyIterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>fullName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fullName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fullName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>pending</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>pending</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreElements</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>pending</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextElement</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pending</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>S</span> <span style=color:#000>nextService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchElementException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>String</span> <span style=color:#000>cn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextName</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Provider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>cn</span>  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; not a subtype&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>S</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>};</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>S</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextService</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>S</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextService</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>};</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//获取迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//返回遍历服务提供者的迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//以懒加载的方式加载可用的服务提供者
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//懒加载的实现是：解析配置文件和实例化服务提供者的工作由迭代器本身完成
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//按照实例化顺序返回已经缓存的服务提供者实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>knownProviders</span>
                <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>knownProviders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lookupIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>S</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>knownProviders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>knownProviders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lookupIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#ce5c00;font-weight:700>};</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//为指定的服务使用指定的类加载器来创建一个ServiceLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//使用线程上下文的类加载器来创建ServiceLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getContextClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//使用扩展类加载器为指定的服务创建ServiceLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//只能找到并加载已经安装到当前Java虚拟机中的服务提供者，应用程序类路径中的服务提供者将被忽略
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loadInstalled</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ClassLoader</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParent</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;java.util.ServiceLoader[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>SeriviceLoader 实现了 Iterable 接口，所有具有迭代器属性，即 hasNext 和 next。其中主要是调用 lookupIterator 的对应 hasNext 和 next 方法，lookupIterator 为懒加载迭代器。</li>
<li>LazyIterator 中的 hasNext 方法，静态变量 PREFIX 为 <code>META-INF/services</code> 目录。</li>
<li>通过反射 <code>Class.forName</code> 加载类对象，并通过 <code>newInstance</code> 方法创建实现类的实例，并将实例缓存，然后返回实例对象。</li>
</ol>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>