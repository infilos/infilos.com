<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.92.2">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-debug/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Java Debug | infilos.com</title><meta property="og:title" content="Java Debug">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-debug/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Java Debug">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Java Debug">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-debug/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Java Debug</h1>
<ul>
<li>1: <a href=#pg-8f576888da9fbe7e42970489d649e1c7>内存溢出</a></li>
<li>2: <a href=#pg-b9b9e29423e747594fcad0ee8bfb7ffb>溢出分析</a></li>
<li>3: <a href=#pg-44b8dfb7169381b5e82e113bf9e315b1>Linux 命令</a></li>
<li>4: <a href=#pg-339d160baa8bd7de7be96fc2f5ce875e>调试工具集</a></li>
<li>5: <a href=#pg-ef265a0d1780667f5aeb19df3a4e49c6>动态调试技术</a></li>
<li>6: <a href=#pg-12291d649dc328488a60c3f171ad3b5c>Arthas</a></li>
<li>7: <a href=#pg-a41d104c7e9d1e19fd5d27d5bf0f9159>本地调试</a></li>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-8f576888da9fbe7e42970489d649e1c7>1 - 内存溢出</h1>
<h2 id=heap-堆内存溢出>Heap 堆内存溢出</h2>
<p>在 Java 堆内存中要不断的创建对象，如果 GC-Roots 到对象之间存在引用链，JVM 就不会回收对象。</p>
<p>如果将 -Xms 和 -Xmx (最小堆和最大堆)设置为一样的值，就会禁止 JVM 自动扩展堆内存。</p>
<p>当使用一个 <code>while(true)</code> 循环来不断创建对象就会发生 OMM 异常，还可以使用 <code>-XX:+HeapDumpOutofMemoryError</code> 在发生 OOM 时自动将堆栈信息 dump 到文件中，以便排查分析。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当出现 OOM 时可以通过工具来分析 <code>GC-Roots</code> ，查看对象和 <code>GC-Roots</code> 是如何进行关联的，是否存在对象的生命周期过长，或者是这些对象确实改存在的，那就要考虑将堆内存调大了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Exception in thread &#34;main&#34; java.lang.OutOfMemoryError: Java heap space
	at java.util.Arrays.copyOf(Arrays.java:3210)
	at java.util.Arrays.copyOf(Arrays.java:3181)
	at java.util.ArrayList.grow(ArrayList.java:261)
	at java.util.ArrayList.ensureExplicitCapacity(ArrayList.java:235)
	at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:227)
	at java.util.ArrayList.add(ArrayList.java:458)
	at com.crossoverjie.oom.HeapOOM.main(HeapOOM.java:18)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)

Process finished with exit code 1
</code></pre></div><p><code>java.lang.OutOfMemoryError: Java heap space</code>表示堆内存溢出。</p>
<h2 id=metaspace-元数据内存溢出>MetaSpace 元数据内存溢出</h2>
<blockquote>
<p>JDK 8 中将永久代移除，使用 MetaSpace 来保存类加载之后的类信息，字符串常量池也被移动到了堆内存之中。</p>
</blockquote>
<p><code>PermSize</code> 和 <code>MaxPermSize</code> 已经不能使用了，在 JDK8 中配置这两个参数将会发出警告。</p>
<p>JDK 8 中将类信息移到到了本地堆内存(Native Heap)中，将原有的永久代移动到了本地堆中成为 <code>MetaSpace</code> ,如果不指定该区域的大小，JVM 将会动态的调整。</p>
<p>可以使用 <code>-XX:MaxMetaspaceSize=10M</code> 来限制最大元数据。这样当不停的·创建类时将会占满该区域并出现 <code>OOM</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#000>Enhancer</span>  <span style=color:#000>enhancer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Enhancer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSuperclass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HeapOOM</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUseCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCallback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodInterceptor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>intercept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>objects</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MethodProxy</span> <span style=color:#000>methodProxy</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>methodProxy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>objects</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#000>enhancer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用 <code>cglib</code> 不停的创建新类，最终会抛出:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Caused by: java.lang.reflect.InvocationTargetException
	at sun.reflect.GeneratedMethodAccessor1.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at net.sf.cglib.core.ReflectUtils.defineClass(ReflectUtils.java:459)
	at net.sf.cglib.core.AbstractClassGenerator.generate(AbstractClassGenerator.java:336)
	... 11 more
Caused by: java.lang.OutOfMemoryError: Metaspace
	at java.lang.ClassLoader.defineClass1(Native Method)
	at java.lang.ClassLoader.defineClass(ClassLoader.java:763)
	... 16 more
</code></pre></div><p>注意: 这里的 OOM 伴随的是 <code>java.lang.OutOfMemoryError: Metaspace</code> 也就是元数据溢出。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b9b9e29423e747594fcad0ee8bfb7ffb>2 - 溢出分析</h1>
<h2 id=thread-dump>Thread Dump</h2>
<h3 id=什么是-thread-dump>什么是 Thread Dump</h3>
<p>Thread Dump 是非常有用的用于诊断 Java 应用问题的工具。每一个 Java 虚拟机都有及时生成所有线程在某一点状态的 thread-dump 的能力，虽然各个 Java虚拟机打印的thread dump略有不同，但是 大多都提供了当前活动线程的快照，及 JVM 中所有 Java 线程的堆栈跟踪信息，堆栈信息一般包含完整的类名及所执行的方法，如果可能的话还有源代码的行数。</p>
<h3 id=thread-dump-特点>Thread Dump 特点</h3>
<ul>
<li>能在各种操作系统下使用；</li>
<li>能在各种Java应用服务器下使用；</li>
<li>能在生产环境下使用而不影响系统的性能；</li>
<li>能将问题直接定位到应用程序的代码行上；</li>
</ul>
<h3 id=thread-dump-抓取>Thread Dump 抓取</h3>
<p>一般当服务器挂起，崩溃或者性能低下时，就需要抓取服务器的线程堆栈（Thread Dump）用于后续的分析。在实际运行中，往往一次 dump的信息，还不足以确认问题。为了反映线程状态的动态变化，需要接连多次做thread dump，每次间隔10-20s，建议至少产生三次 dump信息，如果每次 dump都指向同一个问题，我们才确定问题的典型性。</p>
<h4 id=系统命令获取-threaddump>系统命令获取 ThreadDump</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ps –ef <span style=color:#000;font-weight:700>|</span> grep java
<span style=color:#204a87>kill</span> -3 &lt;pid&gt;
</code></pre></div><blockquote>
<p>注意：kill -9 命令会杀死进程。</p>
</blockquote>
<h4 id=jvm-自带工具获取-threaddump>JVM 自带工具获取 ThreadDump</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jps 或 ps –ef <span style=color:#000;font-weight:700>|</span> grep java （获取PID）
jstack <span style=color:#ce5c00;font-weight:700>[</span>-l <span style=color:#ce5c00;font-weight:700>]</span> &lt;pid&gt; <span style=color:#000;font-weight:700>|</span> tee -a jstack.log（获取ThreadDump）
</code></pre></div><h2 id=thread-dump-分析>Thread Dump 分析</h2>
<h3 id=头部信息时间jvm信息>头部信息：时间，JVM信息</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>2011-11-02 19:05:06  
Full thread dump Java HotSpot(TM) Server VM (16.3-b01 mixed mode): 
</code></pre></div><h3 id=线程-info-信息>线程 INFO 信息</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>1. &#34;Timer-0&#34; daemon prio=10 tid=0xac190c00 nid=0xaef in Object.wait() [0xae77d000] 
# 线程名称：Timer-0；线程类型：daemon；优先级: 10，默认是5；
# JVM线程id：tid=0xac190c00，JVM内部线程的唯一标识（通过java.lang.Thread.getId()获取，通常用自增方式实现）。
# 对应系统线程id（NativeThread ID）：nid=0xaef，和top命令查看的线程pid对应，不过一个是10进制，一个是16进制。（通过命令：top -H -p pid，可以查看该进程的所有线程信息）
# 线程状态：in Object.wait()；
# 起始栈地址：[0xae77d000]，对象的内存地址，通过JVM内存查看工具，能够看出线程是在哪儿个对象上等待；
2.  java.lang.Thread.State: TIMED_WAITING (on object monitor)
3.  at java.lang.Object.wait(Native Method)
4.  -waiting on &lt;0xb3885f60&gt; (a java.util.TaskQueue)     # 继续wait 
5.  at java.util.TimerThread.mainLoop(Timer.java:509)
6.  -locked &lt;0xb3885f60&gt; (a java.util.TaskQueue)         # 已经locked
7.  at java.util.TimerThread.run(Timer.java:462)
Java thread statck trace：是上面2-7行的信息。到目前为止这是最重要的数据，Java stack trace提供了大部分信息来精确定位问题根源。
</code></pre></div><h3 id=thread-stack-trace>Thread Stack Trace</h3>
<p><strong>堆栈信息应该逆向解读</strong>：程序先执行的是第7行，然后是第6行，依次类推。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>- locked &lt;0xb3885f60&gt; (a java.util.ArrayList)
- waiting on &lt;0xb3885f60&gt; (a java.util.ArrayList) 
</code></pre></div><p><strong>也就是说对象先上锁，锁住对象0xb3885f60，然后释放该对象锁，进入waiting状态</strong>。为啥会出现这样的情况呢？看看下面的java代码示例，就会明白：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>synchronized(obj) {  
   .........  
   obj.wait();  
   .........  
}
</code></pre></div><p>如上，线程的执行过程，先用 <code>synchronized</code> 获得了这个对象的 Monitor（对应于 <code>locked &lt;0xb3885f60></code> ）。当执行到 <code>obj.wait()</code>，线程即放弃了 Monitor的所有权，进入 “wait set”队列（对应于 <code>waiting on &lt;0xb3885f60></code> ）。</p>
<p><strong>在堆栈的第一行信息中，进一步标明了线程在代码级的状态</strong>，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>java.lang.Thread.State: TIMED_WAITING (parking)
</code></pre></div><p>解释如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>|blocked|

&gt; This thread tried to enter asynchronized block, but the lock was taken by another thread. This thread isblocked until the lock gets released.

|blocked (on thin lock)|

&gt; This is the same state asblocked, but the lock in question is a thin lock.

|waiting|

&gt; This thread calledObject.wait() on an object. The thread will remain there until some otherthread sends a notification to that object.

|sleeping|

&gt; This thread calledjava.lang.Thread.sleep().

|parked|

&gt; This thread calledjava.util.concurrent.locks.LockSupport.park().

|suspended|

&gt; The thread&#39;s execution wassuspended by java.lang.Thread.suspend() or a JVMTI agent call.
</code></pre></div><h3 id=thread-state>Thread State</h3>
<p>线程的状态是一个很重要的东西，因此thread dump中会显示这些状态，通过对这些状态的分析，能够得出线程的运行状况，进而发现可能存在的问题。<strong>线程的状态在Thread.State这个枚举类型中定义</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>State</span>   <span style=color:#ce5c00;font-weight:700>{</span>  
   <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>    * Thread state for a thread which has not yet started. 
</span><span style=color:#8f5902;font-style:italic>    */</span>  
   <span style=color:#000>NEW</span><span style=color:#ce5c00;font-weight:700>,</span>  

   <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>    * Thread state for a runnable thread.  A thread in the runnable 
</span><span style=color:#8f5902;font-style:italic>    * state is executing in the Java virtual machine but it may 
</span><span style=color:#8f5902;font-style:italic>    * be waiting for other resources from the operating system 
</span><span style=color:#8f5902;font-style:italic>    * such as processor. 
</span><span style=color:#8f5902;font-style:italic>    */</span>  
   <span style=color:#000>RUNNABLE</span><span style=color:#ce5c00;font-weight:700>,</span>  

   <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>    * Thread state for a thread blocked waiting for a monitor lock. 
</span><span style=color:#8f5902;font-style:italic>    * A thread in the blocked state is waiting for a monitor lock 
</span><span style=color:#8f5902;font-style:italic>    * to enter a synchronized block/method or  
</span><span style=color:#8f5902;font-style:italic>    * reenter a synchronized block/method after calling 
</span><span style=color:#8f5902;font-style:italic>    * {@link Object#wait() Object.wait}. 
</span><span style=color:#8f5902;font-style:italic>    */</span>  
   <span style=color:#000>BLOCKED</span><span style=color:#ce5c00;font-weight:700>,</span>  

   <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>    * Thread state for a waiting thread. 
</span><span style=color:#8f5902;font-style:italic>    * A thread is in the waiting state due to calling one of the  
</span><span style=color:#8f5902;font-style:italic>    * following methods: 
</span><span style=color:#8f5902;font-style:italic>    * &lt;ul&gt; 
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt; 
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt; 
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt; 
</span><span style=color:#8f5902;font-style:italic>    * &lt;/ul&gt; 
</span><span style=color:#8f5902;font-style:italic>    *  
</span><span style=color:#8f5902;font-style:italic>    * &lt;p&gt;A thread in the waiting state is waiting for another thread to 
</span><span style=color:#8f5902;font-style:italic>    * perform a particular action.   
</span><span style=color:#8f5902;font-style:italic>    * 
</span><span style=color:#8f5902;font-style:italic>    * For example, a thread that has called &lt;tt&gt;Object.wait()&lt;/tt&gt; 
</span><span style=color:#8f5902;font-style:italic>    * on an object is waiting for another thread to call  
</span><span style=color:#8f5902;font-style:italic>    * &lt;tt&gt;Object.notify()&lt;/tt&gt; or &lt;tt&gt;Object.notifyAll()&lt;/tt&gt; on  
</span><span style=color:#8f5902;font-style:italic>    * that object. A thread that has called &lt;tt&gt;Thread.join()&lt;/tt&gt;  
</span><span style=color:#8f5902;font-style:italic>    * is waiting for a specified thread to terminate. 
</span><span style=color:#8f5902;font-style:italic>    */</span>  
   <span style=color:#000>WAITING</span><span style=color:#ce5c00;font-weight:700>,</span>  

   <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>    * Thread state for a waiting thread with a specified waiting time. 
</span><span style=color:#8f5902;font-style:italic>    * A thread is in the timed waiting state due to calling one of  
</span><span style=color:#8f5902;font-style:italic>    * the following methods with a specified positive waiting time: 
</span><span style=color:#8f5902;font-style:italic>    * &lt;ul&gt; 
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt; 
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt; 
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt; 
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt;  
</span><span style=color:#8f5902;font-style:italic>    *   &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt; 
</span><span style=color:#8f5902;font-style:italic>    * &lt;/ul&gt; 
</span><span style=color:#8f5902;font-style:italic>    */</span>  
   <span style=color:#000>TIMED_WAITING</span><span style=color:#ce5c00;font-weight:700>,</span>  

   <span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>    * Thread state for a terminated thread. 
</span><span style=color:#8f5902;font-style:italic>    * The thread has completed execution. 
</span><span style=color:#8f5902;font-style:italic>    */</span>  
   <span style=color:#000>TERMINATED</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>
<p>NEW：</p>
<ul>
<li>每一个线程，在堆内存中都有一个对应的Thread对象。Thread t = new Thread();当刚刚在堆内存中创建Thread对象，还没有调用t.start()方法之前，线程就处在NEW状态。在这个状态上，线程与普通的java对象没有什么区别，就仅仅是一个堆内存中的对象。</li>
</ul>
</li>
<li>
<p>RUNNABLE：</p>
<ul>
<li>该状态表示线程具备所有运行条件，在运行队列中准备操作系统的调度，或者正在运行。 这个状态的线程比较正常，但如果线程长时间停留在在这个状态就不正常了，这说明线程运行的时间很长（存在性能问题），或者是线程一直得不得执行的机会（存在线程饥饿的问题）。</li>
</ul>
</li>
<li>
<p>BLOCKED：</p>
<ul>
<li>线程正在等待获取java对象的监视器(也叫内置锁)，即线程正在等待进入由synchronized保护的方法或者代码块。synchronized用来保证原子性，任意时刻最多只能由一个线程进入该临界区域，其他线程只能排队等待。</li>
</ul>
</li>
<li>
<p>WAITING：</p>
<ul>
<li>处在该线程的状态，正在等待某个事件的发生，只有特定的条件满足，才能获得执行机会。而产生这个特定的事件，通常都是另一个线程。也就是说，如果不发生特定的事件，那么处在该状态的线程一直等待，不能获取执行的机会。比如：</li>
<li>A线程调用了obj对象的obj.wait()方法，如果没有线程调用obj.notify或obj.notifyAll，那么A线程就没有办法恢复运行； 如果A线程调用了LockSupport.park()，没有别的线程调用LockSupport.unpark(A)，那么A没有办法恢复运行。 TIMED_WAITING：</li>
<li>J.U.C中很多与线程相关类，都提供了限时版本和不限时版本的API。TIMED_WAITING意味着线程调用了限时版本的API，正在等待时间流逝。当等待时间过去后，线程一样可以恢复运行。如果线程进入了WAITING状态，一定要特定的事件发生才能恢复运行；而处在TIMED_WAITING的线程，如果特定的事件发生或者是时间流逝完毕，都会恢复运行。</li>
</ul>
</li>
<li>
<p>TERMINATED：</p>
<ul>
<li>线程执行完毕，执行完run方法正常返回，或者抛出了运行时异常而结束，线程都会停留在这个状态。这个时候线程只剩下Thread对象了，没有什么用了。</li>
</ul>
</li>
</ul>
<h3 id=关键状态分析>关键状态分析</h3>
<h4 id=wait-on-condition><strong>Wait on condition</strong>：</h4>
<p>The thread is either sleeping or waiting to be notified by another thread.</p>
<p>该状态说明它在等待另一个条件的发生，来把自己唤醒，或者干脆它是调用了 sleep(n)。</p>
<p>此时线程状态大致为以下几种：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>java.lang.Thread.State: WAITING (parking)：一直等那个条件发生；
java.lang.Thread.State: TIMED_WAITING (parking或sleeping)：定时的，那个条件不到来，也将定时唤醒自己。
</code></pre></div><h4 id=waiting-for-monitor-entry-和-in-objectwait><strong>Waiting for Monitor Entry 和 in Object.wait()</strong>：</h4>
<p>The thread is waiting to get the lock for an object (some other thread may be holding the lock). This happens if two or more threads try to execute synchronized code. Note that the lock is always for an object and not for individual methods.</p>
<p>在多线程的JAVA程序中，实现线程之间的同步，就要说说 Monitor。<strong>Monitor是Java中用以实现线程之间的互斥与协作的主要手段，它可以看成是对象或者Class的锁。每一个对象都有，也仅有一个 Monitor</strong> 。下面这个图，描述了线程和 Monitor之间关系，以及线程的状态转换图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211122230920.png style=display:block;width:80% alt=NAME align=center> </div>
<p>如上图，每个Monitor在某个时刻，只能被一个线程拥有，<strong>该线程就是 “ActiveThread”，而其它线程都是 “Waiting Thread”，分别在两个队列“Entry Set”和“Wait Set”里等候</strong>。在“Entry Set”中等待的线程状态是“Waiting for monitor entry”，而在“Wait Set”中等待的线程状态是“in Object.wait()”。</p>
<p>先看“Entry Set”里面的线程。我们称被 synchronized保护起来的代码段为临界区。<strong>当一个线程申请进入临界区时，它就进入了“Entry Set”队列</strong>。对应的 code就像：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>synchronized(obj) {
   .........
}
</code></pre></div><p>这时有两种可能性：</p>
<ul>
<li>该 monitor不被其它线程拥有， Entry Set 里面也没有其它等待线程。本线程即成为相应类或者对象的 Monitor的 Owner，执行临界区的代码。</li>
<li>该 monitor被其它线程拥有，本线程在 Entry Set 队列中等待。</li>
</ul>
<p>在第一种情况下，线程将处于 “Runnable”的状态，而第二种情况下，线程 DUMP 会显示处于 “waiting for monitor entry”。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#4e9a06>&#34;Thread-0&#34;</span> <span style=color:#000>prio</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000>tid</span><span style=color:#ce5c00;font-weight:700>=</span>0x08222eb0 <span style=color:#000>nid</span><span style=color:#ce5c00;font-weight:700>=</span>0x9 waiting <span style=color:#204a87;font-weight:700>for</span> monitor entry <span style=color:#ce5c00;font-weight:700>[</span>0xf927b000..0xf927bdb8<span style=color:#ce5c00;font-weight:700>]</span> 
at testthread.WaitThread.run<span style=color:#ce5c00;font-weight:700>(</span>WaitThread.java:39<span style=color:#ce5c00;font-weight:700>)</span> 
- waiting to lock &lt;0xef63bf08&gt; <span style=color:#ce5c00;font-weight:700>(</span>a java.lang.Object<span style=color:#ce5c00;font-weight:700>)</span> 
- locked &lt;0xef63beb8&gt; <span style=color:#ce5c00;font-weight:700>(</span>a java.util.ArrayList<span style=color:#ce5c00;font-weight:700>)</span> 
at java.lang.Thread.run<span style=color:#ce5c00;font-weight:700>(</span>Thread.java:595<span style=color:#ce5c00;font-weight:700>)</span> 
</code></pre></div><p><strong>临界区的设置，是为了保证其内部的代码执行的原子性和完整性</strong>。但是因为临界区在任何时间只允许线程串行通过，这和我们多线程的程序的初衷是相反的。<strong>如果在多线程的程序中，大量使用 synchronized，或者不适当的使用了它，会造成大量线程在临界区的入口等待，造成系统的性能大幅下降</strong>。如果在线程 DUMP中发现了这个情况，应该审查源码，改进程序。</p>
<p>再看“Wait Set”里面的线程。<strong>当线程获得了 Monitor，进入了临界区之后，如果发现线程继续运行的条件没有满足，它则调用对象（一般就是被 synchronized 的对象）的 wait() 方法，放弃 Monitor，进入 “Wait Set”队列。只有当别的线程在该对象上调用了 notify() 或者 notifyAll()，“Wait Set”队列中线程才得到机会去竞争</strong>，但是只有一个线程获得对象的Monitor，恢复到运行态。在 “Wait Set”中的线程， DUMP中表现为： in Object.wait()。如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#4e9a06>&#34;Thread-1&#34;</span> <span style=color:#000>prio</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000>tid</span><span style=color:#ce5c00;font-weight:700>=</span>0x08223250 <span style=color:#000>nid</span><span style=color:#ce5c00;font-weight:700>=</span>0xa in Object.wait<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>[</span>0xef47a000..0xef47aa38<span style=color:#ce5c00;font-weight:700>]</span> 
 at java.lang.Object.wait<span style=color:#ce5c00;font-weight:700>(</span>Native Method<span style=color:#ce5c00;font-weight:700>)</span> 
 - waiting on &lt;0xef63beb8&gt; <span style=color:#ce5c00;font-weight:700>(</span>a java.util.ArrayList<span style=color:#ce5c00;font-weight:700>)</span> 
 at java.lang.Object.wait<span style=color:#ce5c00;font-weight:700>(</span>Object.java:474<span style=color:#ce5c00;font-weight:700>)</span> 
 at testthread.MyWaitThread.run<span style=color:#ce5c00;font-weight:700>(</span>MyWaitThread.java:40<span style=color:#ce5c00;font-weight:700>)</span> 
 - locked &lt;0xef63beb8&gt; <span style=color:#ce5c00;font-weight:700>(</span>a java.util.ArrayList<span style=color:#ce5c00;font-weight:700>)</span> 
 at java.lang.Thread.run<span style=color:#ce5c00;font-weight:700>(</span>Thread.java:595<span style=color:#ce5c00;font-weight:700>)</span> 
</code></pre></div><p>综上，一般CPU很忙时，则关注runnable的线程，CPU很闲时，则关注waiting for monitor entry的线程。</p>
<ul>
<li><strong>JDK 5.0 的 Lock</strong></li>
</ul>
<p>上面提到如果 synchronized和 monitor机制运用不当，可能会造成多线程程序的性能问题。在 JDK 5.0中，引入了 Lock 机制，从而使开发者能更灵活的开发高性能的并发多线程程序，可以替代以往 JDK中的 synchronized和 Monitor的 机制。但是，<strong>要注意的是，因为 Lock类只是一个普通类，JVM无从得知 Lock对象的占用情况，所以在线程 DUMP中，也不会包含关于 Lock的信息</strong>， 关于死锁等问题，就不如用 synchronized的编程方式容易识别。</p>
<h3 id=关键状态示例>关键状态示例</h3>
<h4 id=显示blocked状态><strong>显示BLOCKED状态</strong></h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BlockedState</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>  
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>  
    <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>Runnable</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  

            <span style=color:#5c35cc;font-weight:700>@Override</span>  
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span>  
            <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span>  
                <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>begin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>  
  
                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>  

                    <span style=color:#8f5902;font-style:italic>// 让线程运行5分钟,会一直持有object的监视器  
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>60</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span>  
                    <span style=color:#ce5c00;font-weight:700>{</span>  
  
                    <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#ce5c00;font-weight:700>};</span>  

        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>先获取object的线程会执行5分钟，<strong>这5分钟内会一直持有object的监视器，另一个线程无法执行处在BLOCKED状态</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Full thread dump Java HotSpot(TM) Server VM (20.12-b01 mixed mode):  
  
&#34;DestroyJavaVM&#34; prio=6 tid=0x00856c00 nid=0x1314 waiting on condition [0x00000000]  
java.lang.Thread.State: RUNNABLE  

&#34;t2&#34; prio=6 tid=0x27d7a800 nid=0x1350 waiting for monitor entry [0x2833f000]  
java.lang.Thread.State: BLOCKED (on object monitor)  
     at jstack.BlockedState$1.run(BlockedState.java:17)  
     - waiting to lock &lt;0x1cfcdc00&gt; (a java.lang.Object)  
     at java.lang.Thread.run(Thread.java:662)  

&#34;t1&#34; prio=6 tid=0x27d79400 nid=0x1338 runnable [0x282ef000]  
 java.lang.Thread.State: RUNNABLE  
     at jstack.BlockedState$1.run(BlockedState.java:22)  
     - locked &lt;0x1cfcdc00&gt; (a java.lang.Object)  
     at java.lang.Thread.run(Thread.java:662)
</code></pre></div><p>通过thread dump可以看到：<strong>t2线程确实处在BLOCKED (on object monitor)。waiting for monitor entry 等待进入synchronized保护的区域</strong>。</p>
<h4 id=显示waiting状态><strong>显示WAITING状态</strong></h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>jstack</span><span style=color:#ce5c00;font-weight:700>;</span>  
  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitingState</span>  
<span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>  
    <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>Runnable</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  

            <span style=color:#5c35cc;font-weight:700>@Override</span>  
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span>  
            <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span>  
                <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>begin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>  
                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>  

                    <span style=color:#8f5902;font-style:italic>// 让线程运行5分钟,会一直持有object的监视器  
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>5</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>60</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span>  
                    <span style=color:#ce5c00;font-weight:700>{</span>  
                        <span style=color:#204a87;font-weight:700>try</span>  
                        <span style=color:#ce5c00;font-weight:700>{</span>  
                            <span style=color:#8f5902;font-style:italic>// 进入等待的同时,会进入释放监视器  
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wait</span><span style=color:#ce5c00;font-weight:700>();</span>  
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>  
                        <span style=color:#ce5c00;font-weight:700>{</span>  
                            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>  
                        <span style=color:#ce5c00;font-weight:700>}</span>  
                    <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#ce5c00;font-weight:700>};</span>  

        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>  
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Full thread dump Java HotSpot(TM) Server VM (20.12-b01 mixed mode):  

&#34;DestroyJavaVM&#34; prio=6 tid=0x00856c00 nid=0x1734 waiting on condition [0x00000000]  
java.lang.Thread.State: RUNNABLE  

&#34;t2&#34; prio=6 tid=0x27d7e000 nid=0x17f4 in Object.wait() [0x2833f000]  
java.lang.Thread.State: WAITING (on object monitor)  
     at java.lang.Object.wait(Native Method)  
     - waiting on &lt;0x1cfcdc00&gt; (a java.lang.Object)  
     at java.lang.Object.wait(Object.java:485)  
     at jstack.WaitingState$1.run(WaitingState.java:26)  
     - locked &lt;0x1cfcdc00&gt; (a java.lang.Object)  
     at java.lang.Thread.run(Thread.java:662)  

&#34;t1&#34; prio=6 tid=0x27d7d400 nid=0x17f0 in Object.wait() [0x282ef000]  
java.lang.Thread.State: WAITING (on object monitor)  
     at java.lang.Object.wait(Native Method)  
     - waiting on &lt;0x1cfcdc00&gt; (a java.lang.Object)  
     at java.lang.Object.wait(Object.java:485)  
     at jstack.WaitingState$1.run(WaitingState.java:26)  
     - locked &lt;0x1cfcdc00&gt; (a java.lang.Object)  
     at java.lang.Thread.run(Thread.java:662)  
</code></pre></div><p>可以发现t1和t2都处在WAITING (on object monitor)，进入等待状态的原因是调用了in Object.wait()。通过J.U.C包下的锁和条件队列，也是这个效果，大家可以自己实践下。</p>
<h4 id=显示timed_waiting状态><strong>显示TIMED_WAITING状态</strong></h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>jstack</span><span style=color:#ce5c00;font-weight:700>;</span>  

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.TimeUnit</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.Condition</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.Lock</span><span style=color:#ce5c00;font-weight:700>;</span>  
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.ReentrantLock</span><span style=color:#ce5c00;font-weight:700>;</span>  
  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TimedWaitingState</span>  
<span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#8f5902;font-style:italic>// java的显示锁,类似java对象内置的监视器  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>  
  
    <span style=color:#8f5902;font-style:italic>// 锁关联的条件队列(类似于object.wait)  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Condition</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCondition</span><span style=color:#ce5c00;font-weight:700>();</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>  
    <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>Runnable</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  

            <span style=color:#5c35cc;font-weight:700>@Override</span>  
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span>  
            <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#8f5902;font-style:italic>// 加锁,进入临界区  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>  
  
                <span style=color:#204a87;font-weight:700>try</span>  
                <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MINUTES</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>  
                <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
  
                <span style=color:#8f5902;font-style:italic>// 解锁,退出临界区  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
        <span style=color:#ce5c00;font-weight:700>};</span>  
  
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Full thread dump Java HotSpot(TM) Server VM (20.12-b01 mixed mode):  

&#34;DestroyJavaVM&#34; prio=6 tid=0x00856c00 nid=0x169c waiting on condition [0x00000000]  
java.lang.Thread.State: RUNNABLE  

&#34;t2&#34; prio=6 tid=0x27d7d800 nid=0xc30 waiting on condition [0x2833f000]  
java.lang.Thread.State: TIMED_WAITING (parking)  
     at sun.misc.Unsafe.park(Native Method)  
     - parking to wait for  &lt;0x1cfce5b8&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)  
     at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)  
     at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2116)  
     at jstack.TimedWaitingState$1.run(TimedWaitingState.java:28)  
     at java.lang.Thread.run(Thread.java:662)  

&#34;t1&#34; prio=6 tid=0x280d0c00 nid=0x16e0 waiting on condition [0x282ef000]  
java.lang.Thread.State: TIMED_WAITING (parking)  
     at sun.misc.Unsafe.park(Native Method)  
     - parking to wait for  &lt;0x1cfce5b8&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)  
     at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)  
     at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2116)  
     at jstack.TimedWaitingState$1.run(TimedWaitingState.java:28)  
     at java.lang.Thread.run(Thread.java:662)  
</code></pre></div><p>可以看到t1和t2线程都处在java.lang.Thread.State: TIMED_WAITING (parking)，这个parking代表是调用的JUC下的工具类，而不是java默认的监视器。</p>
<h2 id=重要线程>重要线程</h2>
<h3 id=attach-listener-attach-listener>Attach Listener Attach Listener</h3>
<p>线程是负责接收到外部的命令，而对该命令进行执行的并把结果返回给发送者。通常我们会用一些命令去要求JVM给我们一些反馈信息，如：java -version、jmap、jstack等等。 如果该线程在JVM启动的时候没有初始化，那么，则会在用户第一次执行JVM命令时，得到启动。</p>
<h3 id=signal-dispatcher>Signal Dispatcher</h3>
<p>前面提到Attach Listener线程的职责是接收外部JVM命令，当命令接收成功后，会交给signal dispather线程去进行分发到各个不同的模块处理命令，并且返回处理结果。signal dispather线程也是在第一次接收外部JVM命令时，进行初始化工作。</p>
<h3 id=compilerthread0>CompilerThread0</h3>
<p>用来调用JITing，实时编译装卸class 。 通常，JVM会启动多个线程来处理这部分工作，线程名称后面的数字也会累加，例如：CompilerThread1。</p>
<h3 id=concurrent-mark-sweep-gc-thread>Concurrent Mark-Sweep GC Thread</h3>
<p>并发标记清除垃圾回收器（就是通常所说的CMS GC）线程， 该线程主要针对于老年代垃圾回收。ps：启用该垃圾回收器，需要在JVM启动参数中加上：-XX:+UseConcMarkSweepGC。</p>
<h3 id=destroyjavavm>DestroyJavaVM</h3>
<p>执行main()的线程，在main执行完后调用JNI中的 jni_DestroyJavaVM() 方法唤起DestroyJavaVM 线程，处于等待状态，等待其它线程（Java线程和Native线程）退出时通知它卸载JVM。每个线程退出时，都会判断自己当前是否是整个JVM中最后一个非deamon线程，如果是，则通知DestroyJavaVM 线程卸载JVM。</p>
<h3 id=finalizer-thread>Finalizer Thread</h3>
<p>这个线程也是在main线程之后创建的，其优先级为10，主要用于在垃圾收集前，调用对象的finalize()方法；关于Finalizer线程的几点：1) 只有当开始一轮垃圾收集时，才会开始调用finalize()方法；因此并不是所有对象的finalize()方法都会被执行；2) 该线程也是daemon线程，因此如果虚拟机中没有其他非daemon线程，不管该线程有没有执行完finalize()方法，JVM也会退出；3) JVM在垃圾收集时会将失去引用的对象包装成Finalizer对象（Reference的实现），并放入ReferenceQueue，由Finalizer线程来处理；最后将该Finalizer对象的引用置为null，由垃圾收集器来回收；4) JVM为什么要单独用一个线程来执行finalize()方法呢？如果JVM的垃圾收集线程自己来做，很有可能由于在finalize()方法中误操作导致GC线程停止或不可控，这对GC线程来说是一种灾难；</p>
<h3 id=low-memory-detector>Low Memory Detector</h3>
<p>这个线程是负责对可使用内存进行检测，如果发现可用内存低，分配新的内存空间。</p>
<h3 id=reference-handler>Reference Handler</h3>
<p>JVM在创建main线程后就创建Reference Handler线程，其优先级最高，为10，它主要用于处理引用对象本身（软引用、弱引用、虚引用）的垃圾回收问题 。</p>
<h3 id=vm-thread>VM Thread</h3>
<p>JVM里面的线程母体，根据hotspot源码（vmThread.hpp）里面的注释，它是一个单个的对象（最原始的线程）会产生或触发所有其他的线程，这个单个的VM线程是会被其他线程所使用来做一些VM操作（如：清扫垃圾等）。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-44b8dfb7169381b5e82e113bf9e315b1>3 - Linux 命令</h1>
<h2 id=文本操作>文本操作</h2>
<h3 id=文本查找---grep>文本查找 - grep</h3>
<p>grep常用命令：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 基本使用</span>
grep yoursearchkeyword f.txt     <span style=color:#8f5902;font-style:italic>#文件查找</span>
grep <span style=color:#4e9a06>&#39;KeyWord otherKeyWord&#39;</span> f.txt cpf.txt <span style=color:#8f5902;font-style:italic>#多文件查找, 含空格加引号</span>
grep <span style=color:#4e9a06>&#39;KeyWord&#39;</span> /home/admin -r -n <span style=color:#8f5902;font-style:italic>#目录下查找所有符合关键字的文件</span>
grep <span style=color:#4e9a06>&#39;keyword&#39;</span> /home/admin -r -n -i <span style=color:#8f5902;font-style:italic># -i 忽略大小写</span>
grep <span style=color:#4e9a06>&#39;KeyWord&#39;</span> /home/admin -r -n --include *.<span style=color:#ce5c00;font-weight:700>{</span>vm,java<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic>#指定文件后缀</span>
grep <span style=color:#4e9a06>&#39;KeyWord&#39;</span> /home/admin -r -n --exclude *.<span style=color:#ce5c00;font-weight:700>{</span>vm,java<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic>#反匹配</span>

<span style=color:#8f5902;font-style:italic># cat + grep</span>
cat f.txt <span style=color:#000;font-weight:700>|</span> grep -i keyword <span style=color:#8f5902;font-style:italic># 查找所有keyword且不分大小写  </span>
cat f.txt <span style=color:#000;font-weight:700>|</span> grep -c <span style=color:#4e9a06>&#39;KeyWord&#39;</span> <span style=color:#8f5902;font-style:italic># 统计Keyword次数</span>

<span style=color:#8f5902;font-style:italic># seq + grep</span>
seq <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000;font-weight:700>|</span> grep <span style=color:#0000cf;font-weight:700>5</span> -A <span style=color:#0000cf;font-weight:700>3</span>    <span style=color:#8f5902;font-style:italic>#上匹配</span>
seq <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000;font-weight:700>|</span> grep <span style=color:#0000cf;font-weight:700>5</span> -B <span style=color:#0000cf;font-weight:700>3</span>    <span style=color:#8f5902;font-style:italic>#下匹配</span>
seq <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000;font-weight:700>|</span> grep <span style=color:#0000cf;font-weight:700>5</span> -C <span style=color:#0000cf;font-weight:700>3</span>    <span style=color:#8f5902;font-style:italic>#上下匹配，平时用这个就妥了</span>
</code></pre></div><h3 id=文本分析---awk>文本分析 - awk</h3>
<p>awk基本命令：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 基本使用</span>
awk <span style=color:#4e9a06>&#39;{print $4,$6}&#39;</span> f.txt
awk <span style=color:#4e9a06>&#39;{print NR,$0}&#39;</span> f.txt cpf.txt    
awk <span style=color:#4e9a06>&#39;{print FNR,$0}&#39;</span> f.txt cpf.txt
awk <span style=color:#4e9a06>&#39;{print FNR,FILENAME,$0}&#39;</span> f.txt cpf.txt
awk <span style=color:#4e9a06>&#39;{print FILENAME,&#34;NR=&#34;NR,&#34;FNR=&#34;FNR,&#34;$&#34;NF&#34;=&#34;$NF}&#39;</span> f.txt cpf.txt
<span style=color:#204a87>echo</span> 1:2:3:4 <span style=color:#000;font-weight:700>|</span> awk -F: <span style=color:#4e9a06>&#39;{print $1,$2,$3,$4}&#39;</span>

<span style=color:#8f5902;font-style:italic># 匹配</span>
awk <span style=color:#4e9a06>&#39;/ldb/ {print}&#39;</span> f.txt   <span style=color:#8f5902;font-style:italic>#匹配ldb</span>
awk <span style=color:#4e9a06>&#39;!/ldb/ {print}&#39;</span> f.txt  <span style=color:#8f5902;font-style:italic>#不匹配ldb</span>
awk <span style=color:#4e9a06>&#39;/ldb/ &amp;&amp; /LISTEN/ {print}&#39;</span> f.txt   <span style=color:#8f5902;font-style:italic>#匹配ldb和LISTEN</span>
awk <span style=color:#4e9a06>&#39;$5 ~ /ldb/ {print}&#39;</span> f.txt <span style=color:#8f5902;font-style:italic>#第五列匹配ldb</span>
</code></pre></div><p>内建变量：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#4e9a06>`</span>NR<span style=color:#4e9a06>`</span>: NR表示从awk开始执行后，按照记录分隔符读取的数据次数，默认的记录分隔符为换行符，因此默认的就是读取的数据行数，NR可以理解为Number of Record的缩写。

<span style=color:#4e9a06>`</span>FNR<span style=color:#4e9a06>`</span>: 在awk处理多个输入文件的时候，在处理完第一个文件后，NR并不会从1开始，而是继续累加，因此就出现了FNR，每当处理一个新文件的时候，FNR就从1开始计数，FNR可以理解为File Number of Record。

<span style=color:#4e9a06>`</span>NF<span style=color:#4e9a06>`</span>: NF表示目前的记录被分割的字段的数目，NF可以理解为Number of Field。
</code></pre></div><h3 id=文本处理---sed>文本处理 - sed</h3>
<p>sed常用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 文本打印</span>
sed -n <span style=color:#4e9a06>&#39;3p&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic>#只打印第三行</span>
sed -n <span style=color:#4e9a06>&#39;$p&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic>#只打印最后一行</span>
sed -n <span style=color:#4e9a06>&#39;3,9p&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic>#只查看文件的第3行到第9行</span>
sed -n -e <span style=color:#4e9a06>&#39;3,9p&#39;</span> -e <span style=color:#4e9a06>&#39;=&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic>#打印3-9行，并显示行号</span>
sed -n <span style=color:#4e9a06>&#39;/root/p&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic>#显示包含root的行</span>
sed -n <span style=color:#4e9a06>&#39;/hhh/,/omc/p&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic># 显示包含&#34;hhh&#34;的行到包含&#34;omc&#34;的行之间的行</span>

<span style=color:#8f5902;font-style:italic># 文本替换</span>
sed -i <span style=color:#4e9a06>&#39;s/root/world/g&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic># 用world 替换xxx.log文件中的root; s==search  查找并替换, g==global  全部替换, -i: implace</span>

<span style=color:#8f5902;font-style:italic># 文本插入</span>
sed <span style=color:#4e9a06>&#39;1,4i hahaha&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic># 在文件第一行和第四行的每行下面添加hahaha</span>
sed -e <span style=color:#4e9a06>&#39;1i happy&#39;</span> -e <span style=color:#4e9a06>&#39;$a new year&#39;</span> xxx.log  <span style=color:#8f5902;font-style:italic>#【界面显示】在文件第一行添加happy,文件结尾添加new year</span>
sed -i -e <span style=color:#4e9a06>&#39;1i happy&#39;</span> -e <span style=color:#4e9a06>&#39;$a new year&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic>#【真实写入文件】在文件第一行添加happy,文件结尾添加new year</span>

<span style=color:#8f5902;font-style:italic># 文本删除</span>
sed  <span style=color:#4e9a06>&#39;3,9d&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic># 删除第3到第9行,只是不显示而已</span>
sed <span style=color:#4e9a06>&#39;/hhh/,/omc/d&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic># 删除包含&#34;hhh&#34;的行到包含&#34;omc&#34;的行之间的行</span>
sed <span style=color:#4e9a06>&#39;/omc/,10d&#39;</span> xxx.log <span style=color:#8f5902;font-style:italic># 删除包含&#34;omc&#34;的行到第十行的内容</span>

<span style=color:#8f5902;font-style:italic># 与find结合</span>
find . -name  <span style=color:#4e9a06>&#34;*.txt&#34;</span> <span style=color:#000;font-weight:700>|</span>xargs   sed -i <span style=color:#4e9a06>&#39;s/hhhh/\hHHh/g&#39;</span>
find . -name  <span style=color:#4e9a06>&#34;*.txt&#34;</span> <span style=color:#000;font-weight:700>|</span>xargs   sed -i <span style=color:#4e9a06>&#39;s#hhhh#hHHh#g&#39;</span>
find . -name  <span style=color:#4e9a06>&#34;*.txt&#34;</span> -exec sed -i <span style=color:#4e9a06>&#39;s/hhhh/\hHHh/g&#39;</span> <span style=color:#ce5c00;font-weight:700>{}</span> <span style=color:#4e9a06>\;</span>
find . -name  <span style=color:#4e9a06>&#34;*.txt&#34;</span> <span style=color:#000;font-weight:700>|</span>xargs cat
</code></pre></div><h2 id=文件操作>文件操作</h2>
<h3 id=文件监听---tail>文件监听 - tail</h3>
<p>最常用的<code>tail -f filename</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 基本使用</span>
tail -f xxx.log <span style=color:#8f5902;font-style:italic># 循环监听文件</span>
tail -300f xxx.log <span style=color:#8f5902;font-style:italic>#倒数300行并追踪文件</span>
tail +20 xxx.log <span style=color:#8f5902;font-style:italic>#从第 20 行至文件末尾显示文件内容</span>

<span style=color:#8f5902;font-style:italic># tailf使用</span>
tailf xxx.log <span style=color:#8f5902;font-style:italic>#等同于tail -f -n 10 打印最后10行，然后追踪文件</span>
</code></pre></div><p>tail -f 与tail F 与tailf三者区别</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#4e9a06>`</span>tail  -f <span style=color:#4e9a06>`</span>  等于--follow<span style=color:#ce5c00;font-weight:700>=</span>descriptor，根据文件描述进行追踪，当文件改名或删除后，停止追踪。

<span style=color:#4e9a06>`</span>tail -F<span style=color:#4e9a06>`</span> 等于 --follow<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span>retry，根据文件名字进行追踪，当文件改名或删除后，保持重试，当有新的文件和他同名时，继续追踪

<span style=color:#4e9a06>`</span>tailf<span style=color:#4e9a06>`</span> 等于tail -f -n 10（tail -f或-F默认也是打印最后10行，然后追踪文件），与tail -f不同的是，如果文件不增长，它不会去访问磁盘文件，所以tailf特别适合那些便携机上跟踪日志文件，因为它减少了磁盘访问，可以省电。
</code></pre></div><p>tail的参数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-f 循环读取
-q 不显示处理信息
-v 显示详细的处理信息
-c&lt;数目&gt; 显示的字节数
-n&lt;行数&gt; 显示文件的尾部 n 行内容
--pid<span style=color:#ce5c00;font-weight:700>=</span>PID 与-f合用,表示在进程ID,PID死掉之后结束
-q, --quiet, --silent 从不输出给出文件名的首部
-s, --sleep-interval<span style=color:#ce5c00;font-weight:700>=</span>S 与-f合用,表示在每次反复的间隔休眠S秒
</code></pre></div><h3 id=文件查找---find>文件查找 - find</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo -u admin find /home/admin /tmp /usr -name <span style=color:#4e9a06>\*</span>.log<span style=color:#ce5c00;font-weight:700>(</span>多个目录去找<span style=color:#ce5c00;font-weight:700>)</span>
find . -iname <span style=color:#4e9a06>\*</span>.txt<span style=color:#ce5c00;font-weight:700>(</span>大小写都匹配<span style=color:#ce5c00;font-weight:700>)</span>
find . -type d<span style=color:#ce5c00;font-weight:700>(</span>当前目录下的所有子目录<span style=color:#ce5c00;font-weight:700>)</span>
find /usr -type l<span style=color:#ce5c00;font-weight:700>(</span>当前目录下所有的符号链接<span style=color:#ce5c00;font-weight:700>)</span>
find /usr -type l -name <span style=color:#4e9a06>&#34;z*&#34;</span> -ls<span style=color:#ce5c00;font-weight:700>(</span>符号链接的详细信息 eg:inode,目录<span style=color:#ce5c00;font-weight:700>)</span>
find /home/admin -size +250000k<span style=color:#ce5c00;font-weight:700>(</span>超过250000k的文件，当然+改成-就是小于了<span style=color:#ce5c00;font-weight:700>)</span>
find /home/admin f -perm <span style=color:#0000cf;font-weight:700>777</span> -exec ls -l <span style=color:#ce5c00;font-weight:700>{}</span> <span style=color:#4e9a06>\;</span> <span style=color:#ce5c00;font-weight:700>(</span>按照权限查询文件<span style=color:#ce5c00;font-weight:700>)</span>
find /home/admin -atime -1  1天内访问过的文件
find /home/admin -ctime -1  1天内状态改变过的文件    
find /home/admin -mtime -1  1天内修改过的文件
find /home/admin -amin -1  1分钟内访问过的文件
find /home/admin -cmin -1  1分钟内状态改变过的文件    
find /home/admin -mmin -1  1分钟内修改过的文件
</code></pre></div><h3 id=pgm>pgm</h3>
<p>批量查询vm-shopbase满足条件的日志</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pgm -A -f vm-shopbase <span style=color:#4e9a06>&#39;cat /home/admin/shopbase/logs/shopbase.log.2017-01-17|grep 2069861630&#39;</span>
</code></pre></div><h2 id=查看网络和进程>查看网络和进程</h2>
<h3 id=查看所有网络接口的属性>查看所有网络接口的属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># ifconfig</span>
eth0: <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style=color:#0000cf;font-weight:700>1500</span>
        inet 172.31.165.194  netmask 255.255.240.0  broadcast 172.31.175.255
        ether 00:16:3e:08:c1:ea  txqueuelen <span style=color:#0000cf;font-weight:700>1000</span>  <span style=color:#ce5c00;font-weight:700>(</span>Ethernet<span style=color:#ce5c00;font-weight:700>)</span>
        RX packets <span style=color:#0000cf;font-weight:700>21213152</span>  bytes <span style=color:#0000cf;font-weight:700>2812084823</span> <span style=color:#ce5c00;font-weight:700>(</span>2.6 GiB<span style=color:#ce5c00;font-weight:700>)</span>
        RX errors <span style=color:#0000cf;font-weight:700>0</span>  dropped <span style=color:#0000cf;font-weight:700>0</span>  overruns <span style=color:#0000cf;font-weight:700>0</span>  frame <span style=color:#0000cf;font-weight:700>0</span>
        TX packets <span style=color:#0000cf;font-weight:700>25264438</span>  bytes <span style=color:#0000cf;font-weight:700>46566724676</span> <span style=color:#ce5c00;font-weight:700>(</span>43.3 GiB<span style=color:#ce5c00;font-weight:700>)</span>
        TX errors <span style=color:#0000cf;font-weight:700>0</span>  dropped <span style=color:#0000cf;font-weight:700>0</span> overruns <span style=color:#0000cf;font-weight:700>0</span>  carrier <span style=color:#0000cf;font-weight:700>0</span>  collisions <span style=color:#0000cf;font-weight:700>0</span>

lo: <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span style=color:#0000cf;font-weight:700>65536</span>
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen <span style=color:#0000cf;font-weight:700>1000</span>  <span style=color:#ce5c00;font-weight:700>(</span>Local Loopback<span style=color:#ce5c00;font-weight:700>)</span>
        RX packets <span style=color:#0000cf;font-weight:700>502</span>  bytes <span style=color:#0000cf;font-weight:700>86350</span> <span style=color:#ce5c00;font-weight:700>(</span>84.3 KiB<span style=color:#ce5c00;font-weight:700>)</span>
        RX errors <span style=color:#0000cf;font-weight:700>0</span>  dropped <span style=color:#0000cf;font-weight:700>0</span>  overruns <span style=color:#0000cf;font-weight:700>0</span>  frame <span style=color:#0000cf;font-weight:700>0</span>
        TX packets <span style=color:#0000cf;font-weight:700>502</span>  bytes <span style=color:#0000cf;font-weight:700>86350</span> <span style=color:#ce5c00;font-weight:700>(</span>84.3 KiB<span style=color:#ce5c00;font-weight:700>)</span>
        TX errors <span style=color:#0000cf;font-weight:700>0</span>  dropped <span style=color:#0000cf;font-weight:700>0</span> overruns <span style=color:#0000cf;font-weight:700>0</span>  carrier <span style=color:#0000cf;font-weight:700>0</span>  collisions <span style=color:#0000cf;font-weight:700>0</span>
</code></pre></div><h3 id=查看防火墙设置>查看防火墙设置</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># iptables -L</span>
Chain INPUT <span style=color:#ce5c00;font-weight:700>(</span>policy ACCEPT<span style=color:#ce5c00;font-weight:700>)</span>
target     prot opt <span style=color:#204a87>source</span>               destination

Chain FORWARD <span style=color:#ce5c00;font-weight:700>(</span>policy ACCEPT<span style=color:#ce5c00;font-weight:700>)</span>
target     prot opt <span style=color:#204a87>source</span>               destination

Chain OUTPUT <span style=color:#ce5c00;font-weight:700>(</span>policy ACCEPT<span style=color:#ce5c00;font-weight:700>)</span>
target     prot opt <span style=color:#204a87>source</span>               destination
</code></pre></div><h3 id=查看路由表>查看路由表</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.31.175.253  0.0.0.0         UG    <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>        <span style=color:#0000cf;font-weight:700>0</span> eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     <span style=color:#0000cf;font-weight:700>1002</span>   <span style=color:#0000cf;font-weight:700>0</span>        <span style=color:#0000cf;font-weight:700>0</span> eth0
172.31.160.0    0.0.0.0         255.255.240.0   U     <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span>        <span style=color:#0000cf;font-weight:700>0</span> eth0
</code></pre></div><h3 id=netstat>netstat</h3>
<p>查看所有监听端口</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># netstat -lntp</span>
Active Internet connections <span style=color:#ce5c00;font-weight:700>(</span>only servers<span style=color:#ce5c00;font-weight:700>)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name  
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:443             0.0.0.0:*               LISTEN      970/nginx: master p
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:9999            0.0.0.0:*               LISTEN      1249/java         
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      970/nginx: master p
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1547/sshd         
tcp6       <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> :::3306                 :::*                    LISTEN      1894/mysqld       
</code></pre></div><p>查看所有已经建立的连接</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># netstat -antp</span>
Active Internet connections <span style=color:#ce5c00;font-weight:700>(</span>servers and established<span style=color:#ce5c00;font-weight:700>)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:443             0.0.0.0:*               LISTEN      970/nginx: master p
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:9999            0.0.0.0:*               LISTEN      1249/java
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      970/nginx: master p
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1547/sshd
tcp        <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> 172.31.165.194:53874    100.100.30.25:80        ESTABLISHED 18041/AliYunDun
tcp        <span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>64</span> 172.31.165.194:22       xxx.194.1.200:2649      ESTABLISHED 32516/sshd: root@pt
tcp6       <span style=color:#0000cf;font-weight:700>0</span>      <span style=color:#0000cf;font-weight:700>0</span> :::3306                 :::*                    LISTEN      1894/m
</code></pre></div><p>查看当前连接</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># netstat -nat|awk  &#39;{print $6}&#39;|sort|uniq -c|sort -rn</span>
      <span style=color:#0000cf;font-weight:700>5</span> LISTEN
      <span style=color:#0000cf;font-weight:700>2</span> ESTABLISHED
      <span style=color:#0000cf;font-weight:700>1</span> Foreign
      <span style=color:#0000cf;font-weight:700>1</span> established<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>查看网络统计信息进程</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># netstat -s</span>
Ip:
    <span style=color:#0000cf;font-weight:700>21017132</span> total packets received
    <span style=color:#0000cf;font-weight:700>0</span> forwarded
    <span style=color:#0000cf;font-weight:700>0</span> incoming packets discarded
    <span style=color:#0000cf;font-weight:700>21017131</span> incoming packets delivered
    <span style=color:#0000cf;font-weight:700>25114367</span> requests sent out
    <span style=color:#0000cf;font-weight:700>324</span> dropped because of missing route
Icmp:
    <span style=color:#0000cf;font-weight:700>18088</span> ICMP messages received
    <span style=color:#0000cf;font-weight:700>692</span> input ICMP message failed.
    ICMP input histogram:
        destination unreachable: <span style=color:#0000cf;font-weight:700>4241</span>
        timeout in transit: <span style=color:#0000cf;font-weight:700>19</span>
        <span style=color:#204a87>echo</span> requests: <span style=color:#0000cf;font-weight:700>13791</span>
        <span style=color:#204a87>echo</span> replies: <span style=color:#0000cf;font-weight:700>4</span>
        timestamp request: <span style=color:#0000cf;font-weight:700>33</span>
    <span style=color:#0000cf;font-weight:700>13825</span> ICMP messages sent
    <span style=color:#0000cf;font-weight:700>0</span> ICMP messages failed
    ICMP output histogram:
        destination unreachable: <span style=color:#0000cf;font-weight:700>1</span>
        <span style=color:#204a87>echo</span> replies: <span style=color:#0000cf;font-weight:700>13791</span>
        timestamp replies: <span style=color:#0000cf;font-weight:700>33</span>
IcmpMsg:
        InType0: <span style=color:#0000cf;font-weight:700>4</span>
        InType3: <span style=color:#0000cf;font-weight:700>4241</span>
        InType8: <span style=color:#0000cf;font-weight:700>13791</span>
        InType11: <span style=color:#0000cf;font-weight:700>19</span>
        InType13: <span style=color:#0000cf;font-weight:700>33</span>
        OutType0: <span style=color:#0000cf;font-weight:700>13791</span>
        OutType3: <span style=color:#0000cf;font-weight:700>1</span>
        OutType14: <span style=color:#0000cf;font-weight:700>33</span>
Tcp:
    <span style=color:#0000cf;font-weight:700>12210</span> active connections openings
    <span style=color:#0000cf;font-weight:700>208820</span> passive connection openings
    <span style=color:#0000cf;font-weight:700>54198</span> failed connection attempts
    <span style=color:#0000cf;font-weight:700>9805</span> connection resets received
...
</code></pre></div><h3 id=查看所有进程>查看所有进程</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># ps -ef | grep java</span>
root      <span style=color:#0000cf;font-weight:700>1249</span>     <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> Nov04 ?        00:58:05 java -jar /opt/tech_doc/bin/tech_arch-0.0.1-RELEASE.jar --server.port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>9999</span>
root     <span style=color:#0000cf;font-weight:700>32718</span> <span style=color:#0000cf;font-weight:700>32518</span>  <span style=color:#0000cf;font-weight:700>0</span> 08:36 pts/0    00:00:00 grep --color<span style=color:#ce5c00;font-weight:700>=</span>auto java
</code></pre></div><h3 id=top>top</h3>
<p>top除了看一些基本信息之外，剩下的就是配合来查询vm的各种问题了</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># top -H -p pid</span>
top - 08:37:51 up <span style=color:#0000cf;font-weight:700>45</span> days, 18:45,  <span style=color:#0000cf;font-weight:700>1</span> user,  load average: 0.01, 0.03, 0.05
Threads:  <span style=color:#0000cf;font-weight:700>28</span> total,   <span style=color:#0000cf;font-weight:700>0</span> running,  <span style=color:#0000cf;font-weight:700>28</span> sleeping,   <span style=color:#0000cf;font-weight:700>0</span> stopped,   <span style=color:#0000cf;font-weight:700>0</span> zombie
%Cpu<span style=color:#ce5c00;font-weight:700>(</span>s<span style=color:#ce5c00;font-weight:700>)</span>:  0.7 us,  0.7 sy,  0.0 ni, 98.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  <span style=color:#0000cf;font-weight:700>1882088</span> total,    <span style=color:#0000cf;font-weight:700>74608</span> free,   <span style=color:#0000cf;font-weight:700>202228</span> used,  <span style=color:#0000cf;font-weight:700>1605252</span> buff/cache
KiB Swap:  <span style=color:#0000cf;font-weight:700>2097148</span> total,  <span style=color:#0000cf;font-weight:700>1835392</span> free,   <span style=color:#0000cf;font-weight:700>261756</span> used.  <span style=color:#0000cf;font-weight:700>1502036</span> avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
 <span style=color:#0000cf;font-weight:700>1347</span> root      <span style=color:#0000cf;font-weight:700>20</span>   <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>2553808</span> <span style=color:#0000cf;font-weight:700>113752</span>   <span style=color:#0000cf;font-weight:700>1024</span> S  0.3  6.0  48:46.74 VM Periodic Tas
 <span style=color:#0000cf;font-weight:700>1249</span> root      <span style=color:#0000cf;font-weight:700>20</span>   <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>2553808</span> <span style=color:#0000cf;font-weight:700>113752</span>   <span style=color:#0000cf;font-weight:700>1024</span> S  0.0  6.0   0:00.00 java
 <span style=color:#0000cf;font-weight:700>1289</span> root      <span style=color:#0000cf;font-weight:700>20</span>   <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>2553808</span> <span style=color:#0000cf;font-weight:700>113752</span>   <span style=color:#0000cf;font-weight:700>1024</span> S  0.0  6.0   0:03.74 java
...
</code></pre></div><h2 id=查看磁盘和内存相关>查看磁盘和内存相关</h2>
<h3 id=查看内存使用---free--m>查看内存使用 - free -m</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># free -m</span>
              total        used        free      shared  buff/cache   available
Mem:           <span style=color:#0000cf;font-weight:700>1837</span>         <span style=color:#0000cf;font-weight:700>196</span>         <span style=color:#0000cf;font-weight:700>824</span>           <span style=color:#0000cf;font-weight:700>0</span>         <span style=color:#0000cf;font-weight:700>816</span>        <span style=color:#0000cf;font-weight:700>1469</span>
Swap:          <span style=color:#0000cf;font-weight:700>2047</span>         <span style=color:#0000cf;font-weight:700>255</span>        <span style=color:#0000cf;font-weight:700>1792</span>
</code></pre></div><h3 id=查看各分区使用情况>查看各分区使用情况</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># df -h</span>
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        909M     <span style=color:#0000cf;font-weight:700>0</span>  909M   0% /dev
tmpfs           919M     <span style=color:#0000cf;font-weight:700>0</span>  919M   0% /dev/shm
tmpfs           919M  452K  919M   1% /run
tmpfs           919M     <span style=color:#0000cf;font-weight:700>0</span>  919M   0% /sys/fs/cgroup
/dev/vda1        40G   15G   23G  40% /
tmpfs           184M     <span style=color:#0000cf;font-weight:700>0</span>  184M   0% /run/user/0
</code></pre></div><h3 id=查看指定目录的大小>查看指定目录的大小</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># du -sh</span>
803M
</code></pre></div><h3 id=查看内存总量>查看内存总量</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># grep MemTotal /proc/meminfo</span>
MemTotal:        <span style=color:#0000cf;font-weight:700>1882088</span> kB
</code></pre></div><h3 id=查看空闲内存量>查看空闲内存量</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># grep MemFree /proc/meminfo</span>
MemFree:           <span style=color:#0000cf;font-weight:700>74120</span> kB
</code></pre></div><h3 id=查看系统负载磁盘和分区>查看系统负载磁盘和分区</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># grep MemFree /proc/meminfo</span>
MemFree:           <span style=color:#0000cf;font-weight:700>74120</span> kB
</code></pre></div><h3 id=查看系统负载磁盘和分区-1>查看系统负载磁盘和分区</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># cat /proc/loadavg</span>
0.01 0.04 0.05 2/174 <span style=color:#0000cf;font-weight:700>32751</span>
</code></pre></div><h3 id=查看挂接的分区状态>查看挂接的分区状态</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># mount | column -t</span>
sysfs       on  /sys                             <span style=color:#204a87>type</span>  sysfs       <span style=color:#ce5c00;font-weight:700>(</span>rw,nosuid,nodev,noexec,relatime<span style=color:#ce5c00;font-weight:700>)</span>
proc        on  /proc                            <span style=color:#204a87>type</span>  proc        <span style=color:#ce5c00;font-weight:700>(</span>rw,nosuid,nodev,noexec,relatime<span style=color:#ce5c00;font-weight:700>)</span>
devtmpfs    on  /dev                             <span style=color:#204a87>type</span>  devtmpfs    <span style=color:#ce5c00;font-weight:700>(</span>rw,nosuid,size<span style=color:#ce5c00;font-weight:700>=</span>930732k,nr_inodes<span style=color:#ce5c00;font-weight:700>=</span>232683,mode<span style=color:#ce5c00;font-weight:700>=</span>755<span style=color:#ce5c00;font-weight:700>)</span>
securityfs  on  /sys/kernel/security             <span style=color:#204a87>type</span>  securityfs  <span style=color:#ce5c00;font-weight:700>(</span>rw,nosuid,nodev,noexec,relatime<span style=color:#ce5c00;font-weight:700>)</span>
...
</code></pre></div><h3 id=查看所有分区>查看所有分区</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># fdisk -l</span>

Disk /dev/vda: 42.9 GB, <span style=color:#0000cf;font-weight:700>42949672960</span> bytes, <span style=color:#0000cf;font-weight:700>83886080</span> sectors
<span style=color:#000>Units</span> <span style=color:#ce5c00;font-weight:700>=</span> sectors of <span style=color:#0000cf;font-weight:700>1</span> * <span style=color:#000>512</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>512</span> bytes
Sector size <span style=color:#ce5c00;font-weight:700>(</span>logical/physical<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>512</span> bytes / <span style=color:#0000cf;font-weight:700>512</span> bytes
I/O size <span style=color:#ce5c00;font-weight:700>(</span>minimum/optimal<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>512</span> bytes / <span style=color:#0000cf;font-weight:700>512</span> bytes
Disk label type: dos
Disk identifier: 0x0008d73a

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        <span style=color:#0000cf;font-weight:700>2048</span>    <span style=color:#0000cf;font-weight:700>83884031</span>    <span style=color:#0000cf;font-weight:700>41940992</span>   <span style=color:#0000cf;font-weight:700>83</span>  Linux
</code></pre></div><h3 id=查看所有交换分区>查看所有交换分区</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># swapon -s</span>
Filename                                Type            Size    Used    Priority
/etc/swap                               file    <span style=color:#0000cf;font-weight:700>2097148</span> <span style=color:#0000cf;font-weight:700>261756</span>  -2
</code></pre></div><h3 id=查看硬盘大小>查看硬盘大小</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># fdisk -l |grep Disk</span>
Disk /dev/vda: 42.9 GB, <span style=color:#0000cf;font-weight:700>42949672960</span> bytes, <span style=color:#0000cf;font-weight:700>83886080</span> sectors
Disk label type: dos
Disk identifier: 0x0008d73a
</code></pre></div><h2 id=查看用户和组相关>查看用户和组相关</h2>
<h3 id=查看活动用户>查看活动用户</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># w</span>
 08:47:20 up <span style=color:#0000cf;font-weight:700>45</span> days, 18:54,  <span style=color:#0000cf;font-weight:700>1</span> user,  load average: 0.01, 0.03, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     pts/0    xxx.194.1.200    08:32    0.00s  0.32s  0.32s -bash
</code></pre></div><h3 id=查看指定用户信息>查看指定用户信息</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># id</span>
<span style=color:#000>uid</span><span style=color:#ce5c00;font-weight:700>=</span>0<span style=color:#ce5c00;font-weight:700>(</span>root<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>gid</span><span style=color:#ce5c00;font-weight:700>=</span>0<span style=color:#ce5c00;font-weight:700>(</span>root<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>groups</span><span style=color:#ce5c00;font-weight:700>=</span>0<span style=color:#ce5c00;font-weight:700>(</span>root<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=查看用户登录日志>查看用户登录日志</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># last</span>
root     pts/0        xxx.194.1.200    Fri Dec <span style=color:#0000cf;font-weight:700>20</span> 08:32   still logged in
root     pts/0        xxx.73.164.60     Thu Dec <span style=color:#0000cf;font-weight:700>19</span> 21:47 - 00:28  <span style=color:#ce5c00;font-weight:700>(</span>02:41<span style=color:#ce5c00;font-weight:700>)</span>
root     pts/0        xxx.106.236.255  Thu Dec <span style=color:#0000cf;font-weight:700>19</span> 16:00 - 18:24  <span style=color:#ce5c00;font-weight:700>(</span>02:23<span style=color:#ce5c00;font-weight:700>)</span>
root     pts/1        xxx.194.3.173    Tue Dec <span style=color:#0000cf;font-weight:700>17</span> 13:35 - 17:37  <span style=color:#ce5c00;font-weight:700>(</span>04:01<span style=color:#ce5c00;font-weight:700>)</span>
root     pts/0        xxx.194.3.173    Tue Dec <span style=color:#0000cf;font-weight:700>17</span> 13:35 - 17:37  <span style=color:#ce5c00;font-weight:700>(</span>04:02<span style=color:#ce5c00;font-weight:700>)</span>
...
</code></pre></div><h3 id=查看系统所有用户>查看系统所有用户</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>root@pdai.tech ~<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#8f5902;font-style:italic># cut -d: -f1 /etc/passwd</span>
root
bin
daemon
adm
...
</code></pre></div><h3 id=查看系统所有组>查看系统所有组</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cut -d: -f1 /etc/group
</code></pre></div><h2 id=查看服务模块和包相关>查看服务，模块和包相关</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 查看当前用户的计划任务服务</span>
crontab -l 

<span style=color:#8f5902;font-style:italic># 列出所有系统服务</span>
chkconfig –list 

<span style=color:#8f5902;font-style:italic># 列出所有启动的系统服务程序</span>
chkconfig –list <span style=color:#000;font-weight:700>|</span> grep on 

<span style=color:#8f5902;font-style:italic># 查看所有安装的软件包</span>
rpm -qa 

<span style=color:#8f5902;font-style:italic># 列出加载的内核模块</span>
lsmod 
</code></pre></div><h2 id=查看系统设备环境信息>查看系统，设备，环境信息</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 常用</span>
env <span style=color:#8f5902;font-style:italic># 查看环境变量资源</span>
uptime <span style=color:#8f5902;font-style:italic># 查看系统运行时间、用户数、负载</span>
lsusb -tv <span style=color:#8f5902;font-style:italic># 列出所有USB设备的linux系统信息命令</span>
lspci -tv <span style=color:#8f5902;font-style:italic># 列出所有PCI设备</span>
head -n <span style=color:#0000cf;font-weight:700>1</span> /etc/issue <span style=color:#8f5902;font-style:italic># 查看操作系统版本，是数字1不是字母L</span>
uname -a <span style=color:#8f5902;font-style:italic># 查看内核/操作系统/CPU信息的linux系统信息命令</span>

<span style=color:#8f5902;font-style:italic># /proc/</span>
cat /proc/cpuinfo ：查看CPU相关参数的linux系统命令
cat /proc/partitions ：查看linux硬盘和分区信息的系统信息命令
cat /proc/meminfo ：查看linux系统内存信息的linux系统命令
cat /proc/version ：查看版本，类似uname -r
cat /proc/ioports ：查看设备io端口
cat /proc/interrupts ：查看中断
cat /proc/pci ：查看pci设备的信息
cat /proc/swaps ：查看所有swap分区的信息
cat /proc/cpuinfo <span style=color:#000;font-weight:700>|</span>grep <span style=color:#4e9a06>&#34;model name&#34;</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> cat /proc/cpuinfo <span style=color:#000;font-weight:700>|</span>grep <span style=color:#4e9a06>&#34;physical id&#34;</span>
</code></pre></div><h2 id=tsar>tsar</h2>
<p>tsar是淘宝开源的的采集工具。很好用, 将历史收集到的数据持久化在磁盘上，所以我们快速来查询历史的系统数据。当然实时的应用情况也是可以查询的啦。大部分机器上都有安装。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tsar  <span style=color:#8f5902;font-style:italic>##可以查看最近一天的各项指标</span>
tsar --live <span style=color:#8f5902;font-style:italic>##可以查看实时指标，默认五秒一刷</span>
tsar -d <span style=color:#0000cf;font-weight:700>20161218</span> <span style=color:#8f5902;font-style:italic>##指定查看某天的数据，貌似最多只能看四个月的数据</span>
tsar --mem
tsar --load
tsar --cpu <span style=color:#8f5902;font-style:italic>##当然这个也可以和-d参数配合来查询某天的单个指标的情况 </span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-339d160baa8bd7de7be96fc2f5ce875e>4 - 调试工具集</h1>
<h2 id=自带工具>自带工具</h2>
<h3 id=jps>jps</h3>
<blockquote>
<p>jps是jdk提供的一个查看当前java进程的小工具， 可以看做是JavaVirtual Machine Process Status Tool的缩写。</p>
</blockquote>
<p>jps常用命令</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jps <span style=color:#8f5902;font-style:italic># 显示进程的ID 和 类的名称</span>
jps –l <span style=color:#8f5902;font-style:italic># 输出输出完全的包名，应用主类名，jar的完全路径名 </span>
jps –v <span style=color:#8f5902;font-style:italic># 输出jvm参数</span>
jps –q <span style=color:#8f5902;font-style:italic># 显示java进程号</span>
jps -m <span style=color:#8f5902;font-style:italic># main 方法</span>
jps -l xxx.xxx.xx.xx <span style=color:#8f5902;font-style:italic># 远程查看 </span>
</code></pre></div><p>jps参数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-q：仅输出VM标识符，不包括classname,jar name,arguments in main method 
-m：输出main method的参数 
-l：输出完全的包名，应用主类名，jar的完全路径名 
-v：输出jvm参数 
-V：输出通过flag文件传递到JVM中的参数<span style=color:#ce5c00;font-weight:700>(</span>.hotspotrc文件或-XX:Flags<span style=color:#ce5c00;font-weight:700>=</span>所指定的文件 
-Joption：传递参数到vm,例如:-J-Xms512m
</code></pre></div><p>jps原理</p>
<blockquote>
<p>java程序在启动以后，会在java.io.tmpdir指定的目录下，就是临时文件夹里，生成一个类似于hsperfdata_User的文件夹，这个文件夹里（在Linux中为/tmp/hsperfdata_{userName}/），有几个文件，名字就是java进程的pid，因此列出当前运行的java进程，只是把这个目录里的文件名列一下而已。 至于系统的参数什么，就可以解析这几个文件获得。</p>
</blockquote>
<p>更多请参考 <a href=https://docs.oracle.com/javase/1.5.0/docs/tooldocs/share/jps.html>jps - Java Virtual Machine Process Status Tool (opens new window)</a></p>
<h3 id=jstack>jstack</h3>
<blockquote>
<p>jstack是jdk自带的线程堆栈分析工具，使用该命令可以查看或导出 Java 应用程序中线程堆栈信息。</p>
</blockquote>
<p>jstack常用命令:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 基本</span>
jstack <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># java和native c/c++框架的所有栈信息</span>
jstack -m <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># 额外的锁信息列表，查看是否死锁</span>
jstack -l <span style=color:#0000cf;font-weight:700>2815</span>
</code></pre></div><p>jstack参数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-l 长列表. 打印关于锁的附加信息,例如属于java.util.concurrent 的 ownable synchronizers列表.

-F 当’jstack <span style=color:#ce5c00;font-weight:700>[</span>-l<span style=color:#ce5c00;font-weight:700>]</span> pid’没有相应的时候强制打印栈信息

-m 打印java和native c/c++框架的所有栈信息.

-h <span style=color:#000;font-weight:700>|</span> -help 打印帮助信息
</code></pre></div><h3 id=jinfo>jinfo</h3>
<blockquote>
<p>jinfo 是 JDK 自带的命令，可以用来查看正在运行的 java 应用程序的扩展参数，包括Java System属性和JVM命令行参数；也可以动态的修改正在运行的 JVM 一些参数。当系统崩溃时，jinfo可以从core文件里面知道崩溃的Java应用程序的配置信息</p>
</blockquote>
<p>jinfo常用命令:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 输出当前 jvm 进程的全部参数和系统属性</span>
jinfo <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># 输出所有的参数</span>
jinfo -flags <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># 查看指定的 jvm 参数的值</span>
jinfo -flag PrintGC <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># 开启/关闭指定的JVM参数</span>
jinfo -flag +PrintGC <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># 设置flag的参数</span>
jinfo -flag <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span>value <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># 输出当前 jvm 进行的全部的系统属性</span>
jinfo -sysprops <span style=color:#0000cf;font-weight:700>2815</span>
</code></pre></div><p>jinfo参数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>no option 输出全部的参数和系统属性
-flag name 输出对应名称的参数
-flag <span style=color:#ce5c00;font-weight:700>[</span>+<span style=color:#000;font-weight:700>|</span>-<span style=color:#ce5c00;font-weight:700>]</span>name 开启或者关闭对应名称的参数
-flag <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span>value 设定对应名称的参数
-flags 输出全部的参数
-sysprops 输出系统属性
</code></pre></div><h3 id=jmap>jmap</h3>
<blockquote>
<p>命令jmap是一个多功能的命令。它可以生成 java 程序的 dump 文件， 也可以查看堆内对象示例的统计信息、查看 ClassLoader 的信息以及 finalizer 队列。</p>
</blockquote>
<p>两个用途</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 查看堆的情况</span>
jmap -heap <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># dump</span>
jmap -dump:live,format<span style=color:#ce5c00;font-weight:700>=</span>b,file<span style=color:#ce5c00;font-weight:700>=</span>/tmp/heap2.bin <span style=color:#0000cf;font-weight:700>2815</span>
jmap -dump:format<span style=color:#ce5c00;font-weight:700>=</span>b,file<span style=color:#ce5c00;font-weight:700>=</span>/tmp/heap3.bin <span style=color:#0000cf;font-weight:700>2815</span>

<span style=color:#8f5902;font-style:italic># 查看堆的占用</span>
jmap -histo <span style=color:#0000cf;font-weight:700>2815</span> <span style=color:#000;font-weight:700>|</span> head -10
</code></pre></div><p>jmap 参数</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>no option： 查看进程的内存映像信息,类似 Solaris pmap 命令。
heap： 显示Java堆详细信息
histo<span style=color:#ce5c00;font-weight:700>[</span>:live<span style=color:#ce5c00;font-weight:700>]</span>： 显示堆中对象的统计信息
clstats：打印类加载器信息
finalizerinfo： 显示在F-Queue队列等待Finalizer线程执行finalizer方法的对象
dump:&lt;dump-options&gt;：生成堆转储快照
F： 当-dump没有响应时，使用-dump或者-histo参数. 在这个模式下,live子参数无效.
help：打印帮助信息
J&lt;flag&gt;：指定传递给运行jmap的JVM的参数
</code></pre></div><h3 id=jstat>jstat</h3>
<p>利用JVM内建的指令对Java应用程序的资源和性能进行实时的命令行的监控，包括了对Heap size和垃圾回收状况的监控。</p>
<p>jstat 是用于见识虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类装载、内存、垃圾收集、jit编译等运行数据，它是线上定位jvm性能的首选工具。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jstat -gcutil <span style=color:#0000cf;font-weight:700>2815</span> <span style=color:#0000cf;font-weight:700>1000</span> 
</code></pre></div><h3 id=jdb>jdb</h3>
<p>jdb可以用来预发debug,假设你预发的java_home是/opt/java/，远程调试端口是8000.那么</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>jdb -attach <span style=color:#0000cf;font-weight:700>8000</span>
</code></pre></div><p>出现以上代表jdb启动成功。后续可以进行设置断点进行调试。</p>
<p>具体参数可见oracle官方说明<a href=http://docs.oracle.com/javase/7/docs/technotes/tools/windows/jdb.html>jdb - The Java Debugger (opens new window)</a></p>
<h3 id=chlsdb>CHLSDB</h3>
<p>CHLSDB感觉很多情况下可以看到更好玩的东西，不详细叙述了。 查询资料听说jstack和jmap等工具就是基于它的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>java -classpath /opt/taobao/java/lib/sa-jdi.jar sun.jvm.hotspot.CLHSDB
</code></pre></div><h2 id=进阶工具>进阶工具</h2>
<h3 id=btrace>btrace</h3>
<p>首当其冲的要说的是btrace。</p>
<ul>
<li>查看当前谁调用了ArrayList的add方法，同时只打印当前ArrayList的size大于500的线程调用栈</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@OnMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;java.util.ArrayList&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>location</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@Location</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Kind</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CALL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/./&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/./&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@ProbeClassName</span> <span style=color:#000>String</span> <span style=color:#000>probeClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@ProbeMethodName</span> <span style=color:#000>String</span> <span style=color:#000>probeMethod</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@TargetInstance</span> <span style=color:#000>Object</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@TargetMethodOrField</span> <span style=color:#000>String</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java.util.ArrayList&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;size&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>479</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;check who ArrayList.add method:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>probeClass</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>probeMethod</span>  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, method:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, size:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>getInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>field</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java.util.ArrayList&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;size&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>jstack</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;===========================&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>监控当前服务方法被调用时返回的值以及请求的参数</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@OnMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.taobao.sellerhome.transfer.biz.impl.C2CApplyerServiceImpl&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;nav&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>location</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@Location</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Kind</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RETURN</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>relation</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>check</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>redirectUrl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@Return</span> <span style=color:#000>AnyType</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parameter# userId:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>userId</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, current:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, relation:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>relation</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, check:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>check</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, redirectUrl:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>redirectUrl</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, result:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>btrace 具体可以参考这里：https://github.com/btraceio/btrace</p>
<p>注意:</p>
<ul>
<li>经过观察，1.3.9的release输出不稳定，要多触发几次才能看到正确的结果</li>
<li>正则表达式匹配trace类时范围一定要控制，否则极有可能出现跑满CPU导致应用卡死的情况</li>
<li>由于是字节码注入的原理，想要应用恢复到正常情况，需要重启应用。</li>
</ul>
<h3 id=greys>Greys</h3>
<p>Greys是@杜琨的大作。说几个挺棒的功能(部分功能和btrace重合):</p>
<ul>
<li><code>sc -df xxx</code>: 输出当前类的详情,包括源码位置和classloader结构</li>
<li><code>trace class method</code>: 打印出当前方法调用的耗时情况，细分到每个方法, 对排查方法性能时很有帮助。</li>
</ul>
<h3 id=arthas>Arthas</h3>
<blockquote>
<p>Arthas是基于Greys。</p>
</blockquote>
<h3 id=javosize>javOSize</h3>
<p>就说一个功能:</p>
<ul>
<li><code>classes</code>：通过修改了字节码，改变了类的内容，即时生效。 所以可以做到快速的在某个地方打个日志看看输出，缺点是对代码的侵入性太大。但是如果自己知道自己在干嘛，的确是不错的玩意儿。</li>
</ul>
<p>其他功能 Greys 和 btrace 都能很轻易做的到，不说了。</p>
<h3 id=jprofiler>JProfiler</h3>
<p>之前判断许多问题要通过JProfiler，但是现在Greys和btrace基本都能搞定了。再加上出问题的基本上都是生产环境(网络隔离)，所以基本不怎么使用了，但是还是要标记一下。</p>
<h3 id=dmesg>dmesg</h3>
<p>如果发现自己的java进程悄无声息的消失了，几乎没有留下任何线索，那么dmesg一发，很有可能有你想要的。</p>
<p>sudo dmesg|grep -i kill|less 去找关键字oom_killer。找到的结果类似如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>6710782.021013<span style=color:#ce5c00;font-weight:700>]</span> java invoked oom-killer: <span style=color:#000>gfp_mask</span><span style=color:#ce5c00;font-weight:700>=</span>0xd0, <span style=color:#000>order</span><span style=color:#ce5c00;font-weight:700>=</span>0, <span style=color:#000>oom_adj</span><span style=color:#ce5c00;font-weight:700>=</span>0, <span style=color:#000>oom_scoe_adj</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#ce5c00;font-weight:700>[</span>6710782.070639<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>&lt;ffffffff81118898&gt;<span style=color:#ce5c00;font-weight:700>]</span> ? oom_kill_process+0x68/0x140 
<span style=color:#ce5c00;font-weight:700>[</span>6710782.257588<span style=color:#ce5c00;font-weight:700>]</span> Task in /LXC011175068174 killed as a result of limit of /LXC011175068174 
<span style=color:#ce5c00;font-weight:700>[</span>6710784.698347<span style=color:#ce5c00;font-weight:700>]</span> Memory cgroup out of memory: Kill process <span style=color:#0000cf;font-weight:700>215701</span> <span style=color:#ce5c00;font-weight:700>(</span>java<span style=color:#ce5c00;font-weight:700>)</span> score <span style=color:#0000cf;font-weight:700>854</span> or sacrifice child 
<span style=color:#ce5c00;font-weight:700>[</span>6710784.707978<span style=color:#ce5c00;font-weight:700>]</span> Killed process 215701, UID 679, <span style=color:#ce5c00;font-weight:700>(</span>java<span style=color:#ce5c00;font-weight:700>)</span> total-vm:11017300kB, anon-rss:7152432kB, file-rss:1232kB
</code></pre></div><p>以上表明，对应的java进程被系统的OOM Killer给干掉了，得分为854. 解释一下OOM killer（Out-Of-Memory killer），该机制会监控机器的内存资源消耗。当机器内存耗尽前，该机制会扫描所有的进程（按照一定规则计算，内存占用，时间等），挑选出得分最高的进程，然后杀死，从而保护机器。</p>
<p>dmesg日志时间转换公式: log实际时间=格林威治1970-01-01+(当前时间秒数-系统启动至今的秒数+dmesg打印的log时间)秒数：</p>
<p>date -d &ldquo;1970-01-01 UTC <code>echo "$(date +%s)-$(cat /proc/uptime|cut -f 1 -d' ')+12288812.926194"|bc</code> seconds&rdquo; 剩下的，就是看看为什么内存这么大，触发了OOM-Killer了。</p>
<h3 id=flight-recorder>Flight Recorder</h3>
<p>是Oracle官方推出的商业环境的性能调优利器；其本身对运行期系统的侵入性很小，同时又能提供相对准确和丰富的运行期信息。</p>
<p>JFR本身是基于周期性对JVM虚拟机的运行状况进行采样记录的，其采样的频率可以通过其参数传入;只是需要留意的是，采样间隔越小对系统的性能干扰就越大。 和传统的JProfiler/VisualVM这些基于JMX的工具所不同的是，JFR记录的信息是<strong>近似而非精确</strong>的；当然大部分情况下这些<strong>模糊性信息就足够说明问题</strong>了。 对于大部分场景下，这些近似信息反而可以更容易发现一些真正的问题。</p>
<p><a href=https://openjdk.java.net/jeps/328>JEP 328: Flight Recorder (java.net)</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ef265a0d1780667f5aeb19df3a4e49c6>5 - 动态调试技术</h1>
<div class="pageinfo pageinfo-primary">
<p>原文链接：<a href=https://tech.meituan.com/2019/11/07/java-dynamic-debugging-technology.html>Java 动态调试技术原理及实践</a></p>
</div>
<h2 id=目标问题>目标问题</h2>
<p>断点调试是我们最常使用的调试手段，它可以获取到方法执行过程中的变量信息，并可以观察到方法的执行路径。但断点调试会在断点位置停顿，使得整个应用停止响应。在线上停顿应用是致命的，动态调试技术给了我们创造新的调试模式的想象空间。本文将研究Java语言中的动态调试技术，首先概括Java动态调试所涉及的技术基础，接着介绍我们在Java动态调试领域的思考及实践，通过结合实际业务场景，设计并实现了一种具备动态性的断点调试工具Java-debug-tool，显著提高了故障排查效率。</p>
<h2 id=java-agent>Java Agent</h2>
<p>JVMTI （JVM Tool Interface）是Java虚拟机对外提供的Native编程接口，通过JVMTI，外部进程可以获取到运行时JVM的诸多信息，比如线程、GC等。Agent是一个运行在目标JVM的特定程序，它的职责是负责从目标JVM中获取数据，然后将数据传递给外部进程。加载Agent的时机可以是目标JVM启动之时，也可以是在目标JVM运行时进行加载，而在目标JVM运行时进行Agent加载具备动态性，对于时机未知的Debug场景来说非常实用。下面将详细分析Java Agent技术的实现细节。</p>
<h3 id=实现模式>实现模式</h3>
<p>JVMTI是一套Native接口，在Java SE 5之前，要实现一个Agent只能通过编写Native代码来实现。从Java SE 5开始，可以使用Java的Instrumentation接口（java.lang.instrument）来编写Agent。无论是通过Native的方式还是通过Java Instrumentation接口的方式来编写Agent，它们的工作都是借助JVMTI来进行完成，下面介绍通过Java Instrumentation接口编写Agent的方法。</p>
<h4 id=通过java-instrumentation-api>通过Java Instrumentation API</h4>
<ol>
<li><strong>实现 Agent 启动方法</strong></li>
</ol>
<p>Java Agent支持目标JVM启动时加载，也支持在目标JVM运行时加载，这两种不同的加载模式会使用不同的入口函数，如果需要在目标JVM启动的同时加载Agent，那么可以选择实现下面的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[1] public static void premain(String agentArgs, Instrumentation inst);
[2] public static void premain(String agentArgs);
</code></pre></div><p>JVM将首先寻找[1]，如果没有发现[1]，再寻找[2]。如果希望在目标JVM运行时加载Agent，则需要实现下面的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[1] public static void agentmain(String agentArgs, Instrumentation inst);
[2] public static void agentmain(String agentArgs);
</code></pre></div><p>这两组方法的第一个参数AgentArgs是随同 “– javaagent”一起传入的程序参数，如果这个字符串代表了多个参数，就需要自己解析这些参数。inst是Instrumentation类型的对象，是JVM自动传入的，我们可以拿这个参数进行类增强等操作。</p>
<ol start=2>
<li><strong>指定 Main-Class</strong></li>
</ol>
<p>Agent需要打包成一个jar包，在ManiFest属性中指定“Premain-Class”或者“Agent-Class”：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Premain-Class: class
Agent-Class: class
</code></pre></div><ol start=3>
<li><strong>挂载到目标 JVM</strong></li>
</ol>
<p>将编写的Agent打成jar包后，就可以挂载到目标JVM上去了。如果选择在目标JVM启动时加载Agent，则可以使用 “-javaagent:[=</p>
<p>com.sun.tools.attach.VirtualMachine 这个类代表一个JVM抽象，可以通过这个类找到目标JVM，并且将Agent挂载到目标JVM上。下面是使用com.sun.tools.attach.VirtualMachine进行动态挂载Agent的一般实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>attachAgentToTargetJVM</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>VirtualMachineDescriptor</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>virtualMachineDescriptors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>VirtualMachine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>list</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>VirtualMachineDescriptor</span> <span style=color:#000>targetVM</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>VirtualMachineDescriptor</span> <span style=color:#000>descriptor</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>virtualMachineDescriptors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPid</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>targetVM</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>descriptor</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetVM</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;could not find the target jvm by process id:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>configure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPid</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>VirtualMachine</span> <span style=color:#000>virtualMachine</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>virtualMachine</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>VirtualMachine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>targetVM</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>virtualMachine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadAgent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;{agent}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;{params}&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>virtualMachine</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>virtualMachine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>detach</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先通过指定的进程ID找到目标JVM，然后通过Attach挂载到目标JVM上，执行加载Agent操作。VirtualMachine的Attach方法就是用来将Agent挂载到目标JVM上去的，而Detach则是将Agent从目标JVM卸载。关于Agent是如何挂载到目标JVM上的具体技术细节，将在下文中进行分析。</p>
<h3 id=启动时加载-agent>启动时加载 Agent</h3>
<h4 id=参数解析>参数解析</h4>
<p>创建JVM时，JVM会进行参数解析，即解析那些用来配置JVM启动的参数，比如堆大小、GC等；本文主要关注解析的参数为-agentlib、 -agentpath、 -javaagent，这几个参数用来指定Agent，JVM会根据这几个参数加载Agent。下面来分析一下JVM是如何解析这几个参数的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// -agentlib and -agentpath
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match_option</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>option</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-agentlib:&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
          <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>is_absolute_path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>match_option</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>option</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-agentpath:&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>strchr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#39;=&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>size_t</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>strlen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>strncpy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NEW_C_HEAP_ARRAY</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mtArguments</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;\0&#39;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>options</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>options</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>strdup_check_oom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mtArguments</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#a40000>#</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>INCLUDE_JVMTI</span>
        <span style=color:#000>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>valid_jdwp_agent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>is_absolute_path</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>jio_fprintf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultStream</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>error_stream</span><span style=color:#ce5c00;font-weight:700>(),</span>
            <span style=color:#4e9a06>&#34;Debugging agents are not supported in this VM\n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>JNI_ERR</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#a40000>#</span><span style=color:#000>endif</span> <span style=color:#8f5902;font-style:italic>// !INCLUDE_JVMTI
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>add_init_agent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>is_absolute_path</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// -javaagent
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>match_option</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>option</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-javaagent:&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#a40000>#</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>INCLUDE_JVMTI</span>
      <span style=color:#000>jio_fprintf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>defaultStream</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>error_stream</span><span style=color:#ce5c00;font-weight:700>(),</span>
        <span style=color:#4e9a06>&#34;Instrumentation agents are not supported in this VM\n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>JNI_ERR</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#a40000>#</span><span style=color:#204a87;font-weight:700>else</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>size_t</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>strlen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>options</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NEW_C_HEAP_ARRAY</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mtArguments</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>jio_snprintf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;%s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>add_init_agent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;instrument&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// java agents need module java.instrument
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>create_numbered_property</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdk.module.addmods&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;java.instrument&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>addmods_count</span><span style=color:#ce5c00;font-weight:700>++))</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>JNI_ENOMEM</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#a40000>#</span><span style=color:#000>endif</span> <span style=color:#8f5902;font-style:italic>// !INCLUDE_JVMTI
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码片段截取自hotspot/src/share/vm/runtime/arguments.cpp中的 Arguments::parse_each_vm_init_arg(const JavaVMInitArgs* args, bool* patch_mod_javabase, Flag::Flags origin) 函数，该函数用来解析一个具体的JVM参数。这段代码的主要功能是解析出需要加载的Agent路径，然后调用add_init_agent函数进行解析结果的存储。下面先看一下add_init_agent函数的具体实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// -agentlib and -agentpath arguments
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>AgentLibraryList</span> <span style=color:#000>_agentList</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add_init_agent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bool</span> <span style=color:#000>absolute_path</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>_agentList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AgentLibrary</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>absolute_path</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>));</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>AgentLibraryList是一个简单的链表结构，add_init_agent函数将解析好的、需要加载的Agent添加到这个链表中，等待后续的处理。</p>
<p>这里需要注意，解析-javaagent参数有一些特别之处，这个参数用来指定一个我们通过Java Instrumentation API来编写的Agent，Java Instrumentation API底层依赖的是JVMTI，对-JavaAgent的处理也说明了这一点，在调用add_init_agent函数时第一个参数是“instrument”，关于加载Agent这个问题在下一小节进行展开。到此，我们知道在启动JVM时指定的Agent已经被JVM解析完存放在了一个链表结构中。下面来分析一下JVM是如何加载这些Agent的。</p>
<h4 id=执行加载操作>执行加载操作</h4>
<p>在创建JVM进程的函数中，解析完JVM参数之后，下面的这段代码和加载Agent相关：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// Launch -agentlib/-agentpath and converted -Xrun agents
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Arguments</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>init_agents_at_startup</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>create_vm_init_agents</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>bool</span> <span style=color:#000>init_agents_at_startup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>_agentList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>is_empty</span><span style=color:#ce5c00;font-weight:700>();</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当JVM判断出上一小节中解析出来的Agent不为空的时候，就要去调用函数create_vm_init_agents来加载Agent，下面来分析一下create_vm_init_agents函数是如何加载Agent的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Threads</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>create_vm_init_agents</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>AgentLibrary</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arguments</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>agents</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>OnLoadEntry_t</span>  <span style=color:#000>on_load_entry</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lookup_agent_on_load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>on_load_entry</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#8f5902;font-style:italic>// Invoke the Agent_OnLoad function
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>jint</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>on_load_entry</span><span style=color:#ce5c00;font-weight:700>)(&amp;</span><span style=color:#000>main_vm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>create_vm_init_agents这个函数通过遍历Agent链表来逐个加载Agent。通过这段代码可以看出，首先通过lookup_agent_on_load来加载Agent并且找到Agent_OnLoad函数，这个函数是Agent的入口函数。如果没找到这个函数，则认为是加载了一个不合法的Agent，则什么也不做，否则调用这个函数，这样Agent的代码就开始执行起来了。对于使用Java Instrumentation API来编写Agent的方式来说，在解析阶段观察到在add_init_agent函数里面传递进去的是一个叫做”instrument”的字符串，其实这是一个动态链接库。在Linux里面，这个库叫做libinstrument.so，在BSD系统中叫做libinstrument.dylib，该动态链接库在{JAVA_HOME}/jre/lib/目录下。</p>
<h4 id=instrument-动态链接库>instrument 动态链接库</h4>
<p>libinstrument用来支持使用Java Instrumentation API来编写Agent，在libinstrument中有一个非常重要的类称为：JPLISAgent（Java Programming Language Instrumentation Services Agent），它的作用是初始化所有通过Java Instrumentation API编写的Agent，并且也承担着通过JVMTI实现Java Instrumentation中暴露API的责任。</p>
<p>我们已经知道，在JVM启动的时候，JVM会通过-javaagent参数加载Agent。最开始加载的是libinstrument动态链接库，然后在动态链接库里面找到JVMTI的入口方法：Agent_OnLoad。下面就来分析一下在libinstrument动态链接库中，Agent_OnLoad函数是怎么实现的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>JNIEXPORT</span> <span style=color:#000>jint</span> <span style=color:#000>JNICALL</span>
<span style=color:#000>DEF_Agent_OnLoad</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JavaVM</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>vm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>reserved</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>initerror</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createNewJPLISAgent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>initerror</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>JPLIS_INIT_ERROR_NONE</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parseArgumentTail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>jarfile</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>fprintf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stderr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-javaagent: memory allocation failure.\n&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>JNI_ERR</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jarfile</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>premainClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Premain-Class&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>/* Save the jarfile name */</span>
        <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mJarfile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>jarfile</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * Convert JAR attributes into agent capabilities
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>convertCapabilityAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>         * Track (record) the agent class name and options data
</span><span style=color:#8f5902;font-style:italic>         */</span>
        <span style=color:#000>initerror</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>recordCommandLineData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>premainClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码片段是经过精简的libinstrument中Agent_OnLoad实现的，大概的流程就是：先创建一个JPLISAgent，然后将ManiFest中设定的一些参数解析出来， 比如（Premain-Class）等。创建了JPLISAgent之后，调用initializeJPLISAgent对这个Agent进行初始化操作。跟进initializeJPLISAgent看一下是如何初始化的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>JPLISInitializationError</span> <span style=color:#000>initializeJPLISAgent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JPLISAgent</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>JavaVM</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>vm</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jvmtiEnv</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/* check what capabilities are available */</span>
    <span style=color:#000>checkCapabilities</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/* check phase - if live phase then we don&#39;t need the VMInit event */</span>
    <span style=color:#000>jvmtierror</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>)-&gt;</span><span style=color:#000>GetPhase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/* now turn on the VMInit event */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>jvmtierror</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>JVMTI_ERROR_NONE</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>jvmtiEventCallbacks</span> <span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>memset</span><span style=color:#ce5c00;font-weight:700>(&amp;</span><span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeof</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>VMInit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>eventHandlerVMInit</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>jvmtierror</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>)-&gt;</span><span style=color:#000>SetEventCallbacks</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>,&amp;</span><span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>sizeof</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>callbacks</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>jvmtierror</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>JVMTI_ERROR_NONE</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>jvmtierror</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(*</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>)-&gt;</span><span style=color:#000>SetEventNotificationMode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>JVMTI_ENABLE</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>JVMTI_EVENT_VM_INIT</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jvmtierror</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>JVMTI_ERROR_NONE</span><span style=color:#ce5c00;font-weight:700>)?</span> <span style=color:#000>JPLIS_INIT_ERROR_NONE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>JPLIS_INIT_ERROR_FAILURE</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里，我们关注callbacks.VMInit = &amp;eventHandlerVMInit;这行代码，这里设置了一个VMInit事件的回调函数，表示在JVM初始化的时候会回调eventHandlerVMInit函数。下面来看一下这个函数的实现细节，猜测就是在这里调用了Premain方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>JNICALL</span>  <span style=color:#000>eventHandlerVMInit</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>jvmtiEnv</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>jvmtienv</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>JNIEnv</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jthread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>processJavaStart</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>environment</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mAgent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>jboolean</span>  <span style=color:#000>processJavaStart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JPLISAgent</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>JNIEnv</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createInstrumentationImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     *  Load the Java agent, and call the premain.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>startJavaAgent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mAgentClassName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mOptionsString</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mPremainCaller</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>jboolean</span> <span style=color:#000>startJavaAgent</span><span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#000>JPLISAgent</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>JNIEnv</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>classname</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>optionsString</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>jmethodID</span> <span style=color:#000>agentMainMethod</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// ...  
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>invokeJavaAgentMainMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mInstrumentationImpl</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>agentMainMethod</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>classNameObject</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>optionsStringObject</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>看到这里，Instrument已经实例化，invokeJavaAgentMainMethod这个方法将我们的premain方法执行起来了。接着，我们就可以根据Instrument实例来做我们想要做的事情了。</p>
<h3 id=运行时加载-agent>运行时加载 Agent</h3>
<p>比起JVM启动时加载Agent，运行时加载Agent就比较有诱惑力了，因为运行时加载Agent的能力给我们提供了很强的动态性，我们可以在需要的时候加载Agent来进行一些工作。因为是动态的，我们可以按照需求来加载所需要的Agent，下面来分析一下动态加载Agent的相关技术细节。</p>
<h4 id=attachlistener>AttachListener</h4>
<p>Attach机制通过Attach Listener线程来进行相关事务的处理，下面来看一下Attach Listener线程是如何初始化的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Starts the Attach Listener thread
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 创建线程相关部分代码被去掉了
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>thread_name</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Attach Listener&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>Handle</span> <span style=color:#000>string</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>java_lang_String</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>create_from_str</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thread_name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>MutexLocker</span> <span style=color:#000>mu</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Threads_lock</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>JavaThread</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>listener_thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavaThread</span><span style=color:#ce5c00;font-weight:700>(&amp;</span><span style=color:#000>attach_listener_thread_entry</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们知道，一个线程启动之后都需要指定一个入口来执行代码，Attach Listener线程的入口是attach_listener_thread_entry，下面看一下这个函数的具体实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>attach_listener_thread_entry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JavaThread</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TRAPS</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>set_initialized</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>AttachOperation</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>op</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>dequeue</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#8f5902;font-style:italic>// find the function to dispatch too
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>AttachOperationFunctionInfo</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>;</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>funcs</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>funcs</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strcmp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;(</span><span style=color:#000>funcs</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]);</span> <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}}</span>
       <span style=color:#8f5902;font-style:italic>// dispatch to the function that implements this operation
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>info</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#8f5902;font-style:italic>//...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>整个函数执行逻辑，大概是这样的：</p>
<ul>
<li>拉取一个需要执行的任务：AttachListener::dequeue。</li>
<li>查询匹配的命令处理函数。</li>
<li>执行匹配到的命令执行函数。</li>
</ul>
<p>其中第二步里面存在一个命令函数表，整个表如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>AttachOperationFunctionInfo</span> <span style=color:#000>funcs</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;agentProperties&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>  <span style=color:#000>get_agent_properties</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;datadump&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>         <span style=color:#000>data_dump</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;dumpheap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>         <span style=color:#000>dump_heap</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;load&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>             <span style=color:#000>load_agent</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;properties&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>       <span style=color:#000>get_system_properties</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;threaddump&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>       <span style=color:#000>thread_dump</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;inspectheap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>      <span style=color:#000>heap_inspection</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;setflag&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>          <span style=color:#000>set_flag</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;printflag&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>        <span style=color:#000>print_flag</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;jcmd&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>             <span style=color:#000>jcmd</span> <span style=color:#ce5c00;font-weight:700>},</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>NULL</span><span style=color:#ce5c00;font-weight:700>,</span>               <span style=color:#000>NULL</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>};</span>
</code></pre></div><p>对于加载Agent来说，命令就是“load”。现在，我们知道了Attach Listener大概的工作模式，但是还是不太清楚任务从哪来，这个秘密就藏在AttachListener::dequeue这行代码里面，接下来我们来分析一下dequeue这个函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>LinuxAttachOperation</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>LinuxAttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>dequeue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// wait for client to connect
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>struct</span> <span style=color:#000>sockaddr</span> <span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>socklen_t</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeof</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>RESTARTABLE</span><span style=color:#ce5c00;font-weight:700>(::</span><span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>listener</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// get the credentials of the peer and check the effective uid/guid
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// - check with jeff on this.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>struct</span> <span style=color:#000>ucred</span> <span style=color:#000>cred_info</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>socklen_t</span> <span style=color:#000>optlen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeof</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cred_info</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(::</span><span style=color:#000>getsockopt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SOL_SOCKET</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SO_PEERCRED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*)&amp;</span><span style=color:#000>cred_info</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>optlen</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// peer credential look okay so we read the request
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LinuxAttachOperation</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>op</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read_request</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这是Linux上的实现，不同的操作系统实现方式不太一样。上面的代码表面，Attach Listener在某个端口监听着，通过accept来接收一个连接，然后从这个连接里面将请求读取出来，然后将请求包装成一个AttachOperation类型的对象，之后就会从表里查询对应的处理函数，然后进行处理。</p>
<p>Attach Listener使用一种被称为“懒加载”的策略进行初始化，也就是说，JVM启动的时候Attach Listener并不一定会启动起来。下面我们来分析一下这种“懒加载”策略的具体实现方案。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// Start Attach Listener if +StartAttachListener or it can&#39;t be started lazily
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>DisableAttachMechanism</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vm_start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StartAttachListener</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>init_at_startup</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// Attach Listener is started lazily except in the case when
</span><span style=color:#8f5902;font-style:italic>// +ReduseSignalUsage is used
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>bool</span> <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>init_at_startup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ReduceSignalUsage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的代码截取自create_vm函数，DisableAttachMechanism、StartAttachListener和ReduceSignalUsage这三个变量默认都是false，所以AttachListener::init();这行代码不会在create_vm的时候执行，而vm_start会执行。下面来看一下这个函数的实现细节：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vm_start</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>UNIX_PATH_MAX</span><span style=color:#ce5c00;font-weight:700>];</span>
  <span style=color:#000>struct</span> <span style=color:#000>stat64</span> <span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ret</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>snprintf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UNIX_PATH_MAX</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;%s/.java_pid%d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
           <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>get_temp_directory</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>current_process_id</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#204a87;font-weight:700>assert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>UNIX_PATH_MAX</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;java_pid file name buffer overflow&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#000>RESTARTABLE</span><span style=color:#ce5c00;font-weight:700>(::</span><span style=color:#000>stat64</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>ret</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ret</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ret</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>unlink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ret</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>log_debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attach</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#4e9a06>&#34;Failed to remove stale attach pid file at %s&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这是在Linux上的实现，是将/tmp/目录下的.java_pid{pid}文件删除，后面在创建Attach Listener线程的时候会创建出来这个文件。上面说到，AttachListener::init()这行代码不会在create_vm的时候执行，这行代码的实现已经在上文中分析了，就是创建Attach Listener线程，并监听其他JVM的命令请求。现在来分析一下这行代码是什么时候被调用的，也就是“懒加载”到底是怎么加载起来的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// Signal Dispatcher needs to be started before VMInit event is posted
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>signal_init</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>这是create_vm中的一段代码，看起来跟信号相关，其实Attach机制就是使用信号来实现“懒加载“的。下面我们来仔细地分析一下这个过程。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>signal_init</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ReduceSignalUsage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Setup JavaThread for processing signals
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>EXCEPTION_MARK</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Klass</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SystemDictionary</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>resolve_or_fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>vmSymbols</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>java_lang_Thread</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CHECK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>instanceKlassHandle</span> <span style=color:#000>klass</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>instanceHandle</span> <span style=color:#000>thread_oop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>klass</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>allocate_instance_handle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CHECK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>thread_name</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Signal Dispatcher&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Handle</span> <span style=color:#000>string</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>java_lang_String</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>create_from_str</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thread_name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CHECK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// Initialize thread_oop to put it into the system threadGroup
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Handle</span> <span style=color:#000>thread_group</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Universe</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>system_thread_group</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>JavaValue</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T_VOID</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>JavaCalls</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>call_special</span><span style=color:#ce5c00;font-weight:700>(&amp;</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>thread_oop</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>klass</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>vmSymbols</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>object_initializer_name</span><span style=color:#ce5c00;font-weight:700>(),</span><span style=color:#000>vmSymbols</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>threadgroup_string_void_signature</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>thread_group</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>CHECK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>KlassHandle</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SystemDictionary</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ThreadGroup_klass</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>JavaCalls</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>call_special</span><span style=color:#ce5c00;font-weight:700>(&amp;</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>thread_group</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>vmSymbols</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>add_method_name</span><span style=color:#ce5c00;font-weight:700>(),</span><span style=color:#000>vmSymbols</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>thread_void_signature</span><span style=color:#ce5c00;font-weight:700>(),</span><span style=color:#000>thread_oop</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>CHECK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>signal_init_pd</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>MutexLocker</span> <span style=color:#000>mu</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Threads_lock</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>JavaThread</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>signal_thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>JavaThread</span><span style=color:#ce5c00;font-weight:700>(&amp;</span><span style=color:#000>signal_thread_entry</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// Handle ^BREAK
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>signal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SIGBREAK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>user_handler</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>JVM创建了一个新的进程来实现信号处理，这个线程叫“Signal Dispatcher”，一个线程创建之后需要有一个入口，“Signal Dispatcher”的入口是signal_thread_entry：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124221535.png style=display:block;width:80% alt=NAME align=center> </div>
<p>这段代码截取自signal_thread_entry函数，截取中的内容是和Attach机制信号处理相关的代码。这段代码的意思是，当接收到“SIGBREAK”信号，就执行接下来的代码，这个信号是需要Attach到JVM上的信号发出来，这个后面会再分析。我们先来看一句关键的代码：AttachListener::is_init_trigger()：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>bool</span> <span style=color:#000>AttachListener</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>is_init_trigger</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>init_at_startup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>is_initialized</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>               <span style=color:#8f5902;font-style:italic>// initialized at startup or already initialized
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>char</span> <span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>PATH_MAX</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>
  <span style=color:#000>sprintf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;.attach_pid%d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>current_process_id</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ret</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>struct</span> <span style=color:#000>stat64</span> <span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#000>RESTARTABLE</span><span style=color:#ce5c00;font-weight:700>(::</span><span style=color:#000>stat64</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>ret</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ret</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>log_trace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attach</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#4e9a06>&#34;Failed to find attach file: %s, trying alternate&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>snprintf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sizeof</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#4e9a06>&#34;%s/.attach_pid%d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>get_temp_directory</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>current_process_id</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>RESTARTABLE</span><span style=color:#ce5c00;font-weight:700>(::</span><span style=color:#000>stat64</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>ret</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ret</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// simple check to avoid starting the attach mechanism when
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// a bogus user creates the file
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>st</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>st_uid</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>geteuid</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先检查了一下是否在JVM启动时启动了Attach Listener，或者是否已经启动过。如果没有，才继续执行，在/tmp目录下创建一个叫做.attach_pid%d的文件，然后执行AttachListener的init函数，这个函数就是用来创建Attach Listener线程的函数，上面已经提到多次并进行了分析。到此，我们知道Attach机制的奥秘所在，也就是Attach Listener线程的创建依靠Signal Dispatcher线程，Signal Dispatcher是用来处理信号的线程，当Signal Dispatcher线程接收到“SIGBREAK”信号之后，就会执行初始化Attach Listener的工作。</p>
<h4 id=运行时加载-agent-的实现>运行时加载 Agent 的实现</h4>
<p>我们继续分析，到底是如何将一个Agent挂载到运行着的目标JVM上，在上文中提到了一段代码，用来进行运行时挂载Agent，可以参考上文中展示的关于“attachAgentToTargetJvm”方法的代码。这个方法里面的关键是调用VirtualMachine的attach方法进行Agent挂载的功能。下面我们就来分析一下VirtualMachine的attach方法具体是怎么实现的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>VirtualMachine</span> <span style=color:#000>attach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>var0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>AttachNotSupportedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var0</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>List</span> <span style=color:#000>var1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AttachProvider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>providers</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AttachNotSupportedException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;no providers installed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>AttachNotSupportedException</span> <span style=color:#000>var2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>Iterator</span> <span style=color:#000>var3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>AttachProvider</span> <span style=color:#000>var4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AttachProvider</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>var4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attachVirtualMachine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var0</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AttachNotSupportedException</span> <span style=color:#000>var6</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>var2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>var6</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法通过attachVirtualMachine方法进行attach操作，在MacOS系统中，AttachProvider的实现类是BsdAttachProvider。我们来看一下BsdAttachProvider的attachVirtualMachine方法是如何实现的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>VirtualMachine</span> <span style=color:#000>attachVirtualMachine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>AttachNotSupportedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkAttachPermission</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>testAttachable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BsdVirtualMachine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>BsdVirtualMachine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AttachProvider</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>AttachNotSupportedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findSocketFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>path</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>File</span> <span style=color:#000>var4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmpdir</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;.attach_pid&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>createAttachFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPath</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>sendQuitTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>var6</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>200L</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var8</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attachTimeout</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>var6</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var6</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>var21</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findSocketFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>var8</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>path</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>var4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var24</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var24</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>path</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>findSocketFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>String</span> <span style=color:#000>var2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;.java_pid&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>File</span> <span style=color:#000>var3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmpdir</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exists</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPath</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>findSocketFile方法用来查询目标JVM上是否已经启动了Attach Listener，它通过检查”tmp/“目录下是否存在java_pid{pid}来进行实现。如果已经存在了，则说明Attach机制已经准备就绪，可以接受客户端的命令了，这个时候客户端就可以通过connect连接到目标JVM进行命令的发送，比如可以发送“load”命令来加载Agent。如果java_pid{pid}文件还不存在，则需要通过sendQuitTo方法向目标JVM发送一个“SIGBREAK”信号，让它初始化Attach Listener线程并准备接受客户端连接。可以看到，发送了信号之后客户端会循环等待java_pid{pid}这个文件，之后再通过connect连接到目标JVM上。</p>
<h4 id=load-命令的实现>load 命令的实现</h4>
<p>下面来分析一下，“load”命令在JVM层面的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>jint</span> <span style=color:#000>load_agent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AttachOperation</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>outputStream</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// get agent name and options
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>agent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>absParam</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>options</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#8f5902;font-style:italic>// If loading a java agent then need to ensure that the java.instrument module is loaded
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strcmp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;instrument&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>THREAD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>ResourceMark</span> <span style=color:#000>rm</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>HandleMark</span> <span style=color:#000>hm</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>JavaValue</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T_OBJECT</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Handle</span> <span style=color:#000>h_module_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>java_lang_String</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>create_from_str</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java.instrument&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>JavaCalls</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>call_static</span><span style=color:#ce5c00;font-weight:700>(&amp;</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>SystemDictionary</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>module_Modules_klass</span><span style=color:#ce5c00;font-weight:700>(),</span><span style=color:#000>vmSymbols</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>loadModule_name</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>vmSymbols</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>loadModule_signature</span><span style=color:#ce5c00;font-weight:700>(),</span><span style=color:#000>h_module_name</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>JvmtiExport</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>load_agent_library</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>absParam</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>options</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个函数先确保加载了java.instrument模块，之后真正执行Agent加载的函数是 <a href=https://github.com/pandening/openjdk/blob/0301fc792ffd3c7b506ef78887af250e0e3ae09e/src/hotspot/share/prims/jvmtiExport.cpp#L2476>load_agent_library</a> ,这个函数的套路就是加载Agent动态链接库，如果是通过Java instrument API实现的Agent，则加载的是libinstrument动态链接库，然后通过libinstrument里面的代码实现运行agentmain方法的逻辑，这一部分内容和libinstrument实现premain方法运行的逻辑其实差不多，这里不再做分析。至此，我们对Java Agent技术已经有了一个全面而细致的了解。</p>
<h2 id=动态替换类字节码技术>动态替换类字节码技术</h2>
<h3 id=动态字节码修改的限制>动态字节码修改的限制</h3>
<p>上文中已经详细分析了Agent技术的实现，我们使用Java Instrumentation API来完成动态类修改的功能，在Instrumentation接口中，通过addTransformer方法来增加一个类转换器，类转换器由类ClassFileTransformer接口实现。ClassFileTransformer接口中唯一的方法transform用于实现类转换，当类被加载的时候，就会调用transform方法，进行类转换。在运行时，我们可以通过Instrumentation的redefineClasses方法进行类重定义，在方法上有一段注释需要特别注意：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>     <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>The</span> <span style=color:#000>redefinition</span> <span style=color:#000>may</span> <span style=color:#000>change</span> <span style=color:#000>method</span> <span style=color:#000>bodies</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>the</span> <span style=color:#000>constant</span> <span style=color:#000>pool</span> <span style=color:#000>and</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span>
     <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>The</span> <span style=color:#000>redefinition</span> <span style=color:#000>must</span> <span style=color:#000>not</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>remove</span> <span style=color:#000>or</span> <span style=color:#000>rename</span> <span style=color:#000>fields</span> <span style=color:#000>or</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>change</span> <span style=color:#000>the</span>
     <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>signatures</span> <span style=color:#000>of</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>or</span> <span style=color:#000>change</span> <span style=color:#000>inheritance</span><span style=color:#ce5c00;font-weight:700>.</span>  <span style=color:#000>These</span> <span style=color:#000>restrictions</span> <span style=color:#000>maybe</span> <span style=color:#000>be</span>
     <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>lifted</span> <span style=color:#000>in</span> <span style=color:#000>future</span> <span style=color:#000>versions</span><span style=color:#ce5c00;font-weight:700>.</span>  <span style=color:#000>The</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>file</span> <span style=color:#000>bytes</span> <span style=color:#000>are</span> <span style=color:#000>not</span> <span style=color:#000>checked</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>verified</span> <span style=color:#000>and</span> <span style=color:#000>installed</span>
     <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>until</span> <span style=color:#000>after</span> <span style=color:#000>the</span> <span style=color:#000>transformations</span> <span style=color:#000>have</span> <span style=color:#000>been</span> <span style=color:#000>applied</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>the</span> <span style=color:#000>resultant</span> <span style=color:#000>bytes</span> <span style=color:#000>are</span> <span style=color:#000>in</span>
     <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>error</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#000>method</span> <span style=color:#000>will</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>an</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span>
</code></pre></div><p>这里面提到，我们不可以增加、删除或者重命名字段和方法，改变方法的签名或者类的继承关系。认识到这一点很重要，当我们通过ASM获取到增强的字节码之后，如果增强后的字节码没有遵守这些规则，那么调用redefineClasses方法来进行类的重定义就会失败。那redefineClasses方法具体是怎么实现类的重定义的呢？它对运行时的JVM会造成什么样的影响呢？下面来分析redefineClasses的实现细节。</p>
<h3 id=重定义类字节码的实现细节>重定义类字节码的实现细节</h3>
<p>上文中我们提到，libinstrument动态链接库中，JPLISAgent不仅实现了Agent入口代码执行的路由，而且还是Java代码与JVMTI之间的一道桥梁。我们在Java代码中调用Java Instrumentation API的redefineClasses，其实会调用libinstrument中的相关代码，我们来分析一下这条路径。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>redefineClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassDefinition</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isRedefineClassesSupported</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;redefineClasses is not supported in this environment&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;null passed as &#39;definitions&#39; in redefineClasses&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>var2</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;element of &#39;definitions&#39; is null in redefineClasses&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>redefineClasses0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mNativeAgent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>redefineClasses0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassDefinition</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>这是InstrumentationImpl中的redefineClasses实现，该方法的具体实现依赖一个Native方法redefineClasses()，我们可以在libinstrument中找到这个Native方法的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>JNIEXPORT</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>JNICALL</span> <span style=color:#000>Java_sun_instrument_InstrumentationImpl_redefineClasses0</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JNIEnv</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jobject</span> <span style=color:#000>implThis</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jlong</span> <span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jobjectArray</span> <span style=color:#000>classDefinitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>redefineClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jnienv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JPLISAgent</span><span style=color:#ce5c00;font-weight:700>*)(</span><span style=color:#000>intptr_t</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>agent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>classDefinitions</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>redefineClasses这个函数的实现比较复杂，代码很长。下面是一段关键的代码片段：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124221819.png style=display:block;width:80% alt=NAME align=center> </div>
<p>可以看到，其实是调用了JVMTI的RetransformClasses函数来完成类的重定义细节。Java-debug-tool</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// class_count - pre-checked to be greater than or equal to 0
</span><span style=color:#8f5902;font-style:italic>// class_definitions - pre-checked for NULL
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>jvmtiError</span> <span style=color:#000>JvmtiEnv</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RedefineClasses</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jint</span> <span style=color:#000>class_count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>jvmtiClassDefinition</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>class_definitions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#8f5902;font-style:italic>//TODO: add locking
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>VM_RedefineClasses</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>class_count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>class_definitions</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>jvmti_class_load_kind_redefine</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#000>VMThread</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(&amp;</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>check_error</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic>/* end RedefineClasses */</span>
</code></pre></div><p>重定义类的请求会被JVM包装成一个VM_RedefineClasses类型的VM_Operation，VM_Operation是JVM内部的一些操作的基类，包括GC操作等。VM_Operation由VMThread来执行，新的VM_Operation操作会被添加到VMThread的运行队列中去，VMThread会不断从队列里面拉取VM_Operation并调用其doit等函数执行具体的操作。VM_RedefineClasses函数的流程较为复杂，下面是VM_RedefineClasses的大致流程：</p>
<ul>
<li>加载新的字节码，合并常量池，并且对新的字节码进行校验工作</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// Load the caller&#39;s new class definition(s) into _scratch_classes.
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Constant pool merging work is done here as needed. Also calls
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// compare_and_normalize_class_versions() to verify the class
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// definition(s).
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>jvmtiError</span> <span style=color:#000>load_new_class_versions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TRAPS</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><ul>
<li>清除方法上的断点</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// Remove all breakpoints in methods of this class
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>JvmtiBreakpoints</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>jvmti_breakpoints</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JvmtiCurrentBreakpoints</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>get_jvmti_breakpoints</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#000>jvmti_breakpoints</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clearall_in_class_at_safepoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>the_class</span><span style=color:#ce5c00;font-weight:700>());</span>
</code></pre></div><ul>
<li>JIT逆优化</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#8f5902;font-style:italic>// Deoptimize all compiled code that depends on this class
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>flush_dependent_code</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>the_class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>THREAD</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><ul>
<li>进行字节码替换工作，需要进行更新类itable/vtable等操作</li>
<li>进行类重定义通知</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#000>SystemDictionary</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>notice_modification</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>VM_RedefineClasses实现比较复杂的，详细实现可以参考 <a href=https://github.com/pandening/openjdk/blob/0301fc792ffd3c7b506ef78887af250e0e3ae09e/src/hotspot/share/prims/jvmtiEnv.cpp#L456>RedefineClasses的实现</a>。</p>
<h2 id=java-debug-tool设计与实现>Java-debug-tool设计与实现</h2>
<p>Java-debug-tool是一个使用Java Instrument API来实现的动态调试工具，它通过在目标JVM上启动一个TcpServer来和调试客户端通信。调试客户端通过命令行来发送调试命令给TcpServer，TcpServer中有专门用来处理命令的handler，handler处理完命令之后会将结果发送回客户端，客户端通过处理将调试结果展示出来。下面将详细介绍Java-debug-tool的整体设计和实现。</p>
<h3 id=整体架构>整体架构</h3>
<p>Java-debug-tool包括一个Java Agent和一个用于处理调试命令的核心API，核心API通过一个自定义的类加载器加载进来，以保证目标JVM的类不会被污染。整体上Java-debug-tool的设计是一个Client-Server的架构，命令客户端需要完整的完成一个命令之后才能继续执行下一个调试命令。Java-debug-tool支持多人同时进行调试，下面是整体架构图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124221903.png style=display:block;width:80% alt=NAME align=center> </div>
<p>下面对每一层做简单介绍：</p>
<ul>
<li>交互层：负责将程序员的输入转换成调试交互协议，并且将调试信息呈现出来。</li>
<li>连接管理层：负责管理客户端连接，从连接中读调试协议数据并解码，对调试结果编码并将其写到连接中去；同时将那些超时未活动的连接关闭。</li>
<li>业务逻辑层：实现调试命令处理，包括命令分发、数据收集、数据处理等过程。</li>
<li>基础实现层：Java-debug-tool实现的底层依赖，通过Java Instrumentation提供的API进行类查找、类重定义等能力，Java Instrumentation底层依赖JVMTI来完成具体的功能。</li>
</ul>
<p>在Agent被挂载到目标JVM上之后，Java-debug-tool会安排一个Spy在目标JVM内活动，这个Spy负责将目标JVM内部的相关调试数据转移到命令处理模块，命令处理模块会处理这些数据，然后给客户端返回调试结果。命令处理模块会增强目标类的字节码来达到数据获取的目的，多个客户端可以共享一份增强过的字节码，无需重复增强。下面从Java-debug-tool的字节码增强方案、命令设计与实现等角度详细说明。</p>
<h3 id=字节码增强方案>字节码增强方案</h3>
<p>Java-debug-tool使用字节码增强来获取到方法运行时的信息，比如方法入参、出参等，可以在不同的字节码位置进行增强，这种行为可以称为“插桩”，每个“桩”用于获取数据并将他转储出去。Java-debug-tool具备强大的插桩能力，不同的桩负责获取不同类别的数据，下面是Java-debug-tool目前所支持的“桩”：</p>
<ul>
<li>方法进入点：用于获取方法入参信息。</li>
<li>Fields获取点1：在方法执行前获取到对象的字段信息。</li>
<li>变量存储点：获取局部变量信息。</li>
<li>Fields获取点2：在方法退出前获取到对象的字段信息。</li>
<li>方法退出点：用于获取方法返回值。</li>
<li>抛出异常点：用于获取方法抛出的异常信息。</li>
</ul>
<p>通过上面这些代码桩，Java-debug-tool可以收集到丰富的方法执行信息，经过处理可以返回更加可视化的调试结果。</p>
<h4 id=字节码增强>字节码增强</h4>
<p>Java-debug-tool在实现上使用了ASM工具来进行字节码增强，并且每个插桩点都可以进行配置，如果不想要什么信息，则没必要进行对应的插桩操作。这种可配置的设计是非常有必要的，因为有时候我们仅仅是想要知道方法的入参和出参，但Java-debug-tool却给我们返回了所有的调试信息，这样我们就得在众多的输出中找到我们所关注的内容。如果可以进行配置，则除了入参点和出参点外其他的桩都不插，那么就可以快速看到我们想要的调试数据，这种设计的本质是为了让调试者更加专注。下面是Java-debug-tool的字节码增强工作方式：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124221935.png style=display:block;width:80% alt=NAME align=center> </div>
<p>如图4-2-1所示，当调试者发出调试命令之后，Java-debug-tool会识别命令并判断是否需要进行字节码增强，如果命令需要增强字节码，则判断当前类+当前方法是否已经被增强过。上文已经提到，字节码替换是有一定损耗的，这种具有损耗的操作发生的次数越少越好，所以字节码替换操作会被记录起来，后续命令直接使用即可，不需要重复进行字节码增强，字节码增强还涉及多个调试客户端的协同工作问题，当一个客户端增强了一个类的字节码之后，这个客户端就锁定了该字节码，其他客户端变成只读，无法对该类进行字节码增强，只有当持有锁的客户端主动释放锁或者断开连接之后，其他客户端才能继续增强该类的字节码。</p>
<p>字节码增强模块收到字节码增强请求之后，会判断每个增强点是否需要插桩，这个判断的根据就是上文提到的插桩配置，之后字节码增强模块会生成新的字节码，Java-debug-tool将执行字节码替换操作，之后就可以进行调试数据收集了。</p>
<p>经过字节码增强之后，原来的方法中会插入收集运行时数据的代码，这些代码在方法被调用的时候执行，获取到诸如方法入参、局部变量等信息，这些信息将传递给数据收集装置进行处理。数据收集的工作通过Advice完成，每个客户端同一时间只能注册一个Advice到Java-debug-tool调试模块上，多个客户端可以同时注册自己的Advice到调试模块上。Advice负责收集数据并进行判断，如果当前数据符合调试命令的要求，Java-debug-tool就会卸载这个Advice，Advice的数据就会被转移到Java-debug-tool的命令结果处理模块进行处理，并将结果发送到客户端。</p>
<h4 id=advice-的工作方式>Advice 的工作方式</h4>
<p>Advice是调试数据收集器，不同的调试策略会对应不同的Advice。Advice是工作在目标JVM的线程内部的，它需要轻量级和高效，意味着Advice不能做太过于复杂的事情，它的核心接口“match”用来判断本次收集到的调试数据是否满足调试需求。如果满足，那么Java-debug-tool就会将其卸载，否则会继续让他收集调试数据，这种“加载Advice” -> “卸载Advice”的工作模式具备很好的灵活性。</p>
<p>关于Advice，需要说明的另外一点就是线程安全，因为它加载之后会运行在目标JVM的线程中，目标JVM的方法极有可能是多线程访问的，这也就是说，Advice需要有能力处理多个线程同时访问方法的能力，如果Advice处理不当，则可能会收集到杂乱无章的调试数据。下面的图片展示了Advice和Java-debug-tool调试分析模块、目标方法执行以及调试客户端等模块的关系。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124221959.png style=display:block;width:80% alt=NAME align=center> </div>
<p>Advice的首次挂载由Java-debug-tool的命令处理器完成，当一次调试数据收集完成之后，调试数据处理模块会自动卸载Advice，然后进行判断，如果调试数据符合Advice的策略，则直接将数据交由数据处理模块进行处理，否则会清空调试数据，并再次将Advice挂载到目标方法上去，等待下一次调试数据。非首次挂载由调试数据处理模块进行，它借助Advice按需取数据，如果不符合需求，则继续挂载Advice来获取数据，否则对调试数据进行处理并返回给客户端。</p>
<h3 id=命令设计与实现>命令设计与实现</h3>
<h4 id=命令执行>命令执行</h4>
<p>上文已经完整的描述了Java-debug-tool的设计以及核心技术方案，本小节将详细介绍Java-debug-tool的命令设计与实现。首先需要将一个调试命令的执行流程描述清楚，下面是一张用来表示命令请求处理流程的图片：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124222025.png style=display:block;width:80% alt=NAME align=center> </div>
<p>图4-3-1简单的描述了Java-debug-tool的命令处理方式，客户端连接到服务端之后，会进行一些协议解析、协议认证、协议填充等工作，之后将进行命令分发。服务端如果发现客户端的命令不合法，则会立即返回错误信息，否则再进行命令处理。命令处理属于典型的三段式处理，前置命令处理、命令处理以及后置命令处理，同时会对命令处理过程中的异常信息进行捕获处理，三段式处理的好处是命令处理被拆成了多个阶段，多个阶段负责不同的职责。前置命令处理用来做一些命令权限控制的工作，并填充一些类似命令处理开始时间戳等信息，命令处理就是通过字节码增强，挂载Advice进行数据收集，再经过数据处理来产生命令结果的过程，后置处理则用来处理一些连接关闭、字节码解锁等事项。</p>
<p>Java-debug-tool允许客户端设置一个命令执行超时时间，超过这个时间则认为命令没有结果，如果客户端没有设置自己的超时时间，就使用默认的超时时间进行超时控制。Java-debug-tool通过设计了两阶段的超时检测机制来实现命令执行超时功能：首先，第一阶段超时触发，则Java-debug-tool会友好的警告命令处理模块处理时间已经超时，需要立即停止命令执行，这允许命令自己做一些现场清理工作，当然需要命令执行线程自己感知到这种超时警告；当第二阶段超时触发，则Java-debug-tool认为命令必须结束执行，会强行打断命令执行线程。超时机制的目的是为了不让命令执行太长时间，命令如果长时间没有收集到调试数据，则应该停止执行，并思考是否调试了一个错误的方法。当然，超时机制还可以定期清理那些因为未知原因断开连接的客户端持有的调试资源，比如字节码锁。</p>
<h4 id=获取方法执行视图>获取方法执行视图</h4>
<p>Java-debug-tool通过下面的信息来向调试者呈现出一次方法执行的视图：</p>
<ul>
<li>正在调试的方法信息。</li>
<li>方法调用堆栈。</li>
<li>调试耗时，包括对目标JVM造成的STW时间。</li>
<li>方法入参，包括入参的类型及参数值。</li>
<li>方法的执行路径。</li>
<li>代码执行耗时。</li>
<li>局部变量信息。</li>
<li>方法返回结果。</li>
<li>方法抛出的异常。</li>
<li>对象字段值快照。</li>
</ul>
<p>图4-3-2展示了Java-debug-tool获取到正在运行的方法的执行视图的信息。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124222053.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=与同类产品对比分析>与同类产品对比分析</h3>
<p>Java-debug-tool的同类产品主要是greys，其他类似的工具大部分都是基于greys进行的二次开发，所以直接选择greys来和Java-debug-tool进行对比。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124222109.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=总结>总结</h2>
<p>本文详细剖析了Java动态调试关键技术的实现细节，并介绍了我们基于Java动态调试技术结合实际故障排查场景进行的一点探索实践；动态调试技术为研发人员进行线上问题排查提供了一种新的思路，我们基于动态调试技术解决了传统断点调试存在的问题，使得可以将断点调试这种技术应用在线上，以线下调试的思维来进行线上调试，提高问题排查效率。</p>
<h2 id=参考文献>参考文献</h2>
<ul>
<li><a href=https://asm.ow2.io/asm4-guide.pdf>ASM 4 guide</a></li>
<li><a href=https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html>Java Virtual Machine Specification</a></li>
<li><a href=https://docs.oracle.com/javase/8/docs/platform/jvmti/jvmti.html>JVM Tool Interface</a></li>
<li><a href=https://alibaba.github.io/arthas/>alibaba arthas</a></li>
<li><a href=https://github.com/pandening/openjdk>openjdk</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-12291d649dc328488a60c3f171ad3b5c>6 - Arthas</h1>
<h2 id=简介>简介</h2>
<p><code>Arthas</code> 是Alibaba开源的Java诊断工具，深受开发者喜爱。</p>
<h3 id=能解决什么问题>能解决什么问题</h3>
<p>当你遇到以下类似问题而束手无策时，<code>Arthas</code>可以帮助你解决：</p>
<ul>
<li>这个类从哪个 jar 包加载的? 为什么会报各种类相关的 Exception?</li>
<li>我改的代码为什么没有执行到? 难道是我没 commit? 分支搞错了?</li>
<li>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗?</li>
<li>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！</li>
<li>是否有一个全局视角来查看系统的运行状况?</li>
<li>有什么办法可以监控到JVM的实时运行状态?</li>
</ul>
<p><code>Arthas</code>支持JDK 6+，支持Linux/Mac/Windows，采用命令行交互模式，同时提供丰富的 <code>Tab</code> 自动补全功能，进一步方便进行问题的定位和诊断。</p>
<h3 id=arthas资源推荐>Arthas资源推荐</h3>
<ul>
<li><a href=https://alibaba.github.io/arthas/>用户文档</a></li>
<li><a href="https://alibaba.github.io/arthas/arthas-tutorials?language=cn">官方在线教程</a></li>
<li><a href=https://alibaba.github.io/arthas/quick-start.html>快速入门</a></li>
<li><a href=https://alibaba.github.io/arthas/advanced-use.html>进阶使用</a></li>
<li><a href=https://alibaba.github.io/arthas/commands.html>命令列表</a></li>
<li><a href=https://alibaba.github.io/arthas/web-console.html>WebConsole</a></li>
<li><a href=https://alibaba.github.io/arthas/docker.html>Docker 集成</a></li>
<li><a href="https://github.com/alibaba/arthas/issues?q=label%3Auser-case">用户案例</a></li>
<li><a href="https://github.com/alibaba/arthas/issues?utf8=%E2%9C%93&q=label%3Aquestion-answered+">常见问题</a></li>
</ul>
<h3 id=技术基础>技术基础</h3>
<ul>
<li><a href=https://github.com/oldmanpushcart/greys-anatomy>greys-anatomy</a>: Arthas代码基于Greys二次开发而来，非常感谢Greys之前所有的工作，以及Greys原作者对Arthas提出的意见和建议！</li>
<li><a href=https://github.com/termd/termd>termd</a>: Arthas的命令行实现基于termd开发，是一款优秀的命令行程序开发框架，感谢termd提供了优秀的框架。</li>
<li><a href=https://github.com/crashub/crash>crash</a>: Arthas的文本渲染功能基于crash中的文本渲染功能开发，可以从<a href=https://github.com/crashub/crash/tree/1.3.2/shell>这里</a>看到源码，感谢crash在这方面所做的优秀工作。</li>
<li><a href=https://github.com/eclipse-vertx/vert.x/tree/master/src/main/java/io/vertx/core/cli>cli</a>: Arthas的命令行界面基于vert.x提供的cli库进行开发，感谢vert.x在这方面做的优秀工作。</li>
<li><a href=https://github.com/skalogs/SkaETL/tree/master/compiler>compiler</a> Arthas里的内存编绎器代码来源</li>
<li><a href=https://commons.apache.org/proper/commons-net/>Apache Commons Net</a> Arthas里的Telnet Client代码来源</li>
<li><code>JavaAgent</code>：运行在 main方法之前的拦截器，它内定的方法名叫 premain ，也就是说先执行 premain 方法然后再执行 main 方法</li>
<li><code>ASM</code>：一个通用的Java字节码操作和分析框架。它可以用于修改现有的类或直接以二进制形式动态生成类。ASM提供了一些常见的字节码转换和分析算法，可以从它们构建定制的复杂转换和代码分析工具。ASM提供了与其他Java字节码框架类似的功能，但是主要关注性能。因为它被设计和实现得尽可能小和快，所以非常适合在动态系统中使用(当然也可以以静态方式使用，例如在编译器中)</li>
</ul>
<h3 id=同类工具>同类工具</h3>
<ul>
<li>BTrace</li>
<li>美团 Java-debug-tool</li>
<li><a href=https://github.com/qunarcorp/bistoury>去哪儿Bistoury: 一个集成了Arthas的项目</a></li>
<li><a href=https://github.com/XhinLiang/arthas>一个使用MVEL脚本的fork</a></li>
</ul>
<h2 id=入门>入门</h2>
<h3 id=安装>安装</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>curl -O https://alibaba.github.io/arthas/arthas-boot.jar
java -jar arthas-boot.jar
</code></pre></div><h3 id=示例>示例</h3>
<h4 id=dashboard>Dashboard</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124224412.png style=display:block;width:80% alt=NAME align=center> </div>
<h4 id=thread>Thread</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ thread -n 3
&#34;as-command-execute-daemon&#34; Id=29 cpuUsage=75% RUNNABLE
    at sun.management.ThreadImpl.dumpThreads0(Native Method)
    at sun.management.ThreadImpl.getThreadInfo(ThreadImpl.java:440)
    at com.taobao.arthas.core.command.monitor200.ThreadCommand$1.action(ThreadCommand.java:58)
    at com.taobao.arthas.core.command.handler.AbstractCommandHandler.execute(AbstractCommandHandler.java:238)
    at com.taobao.arthas.core.command.handler.DefaultCommandHandler.handleCommand(DefaultCommandHandler.java:67)
    at com.taobao.arthas.core.server.ArthasServer$4.run(ArthasServer.java:276)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
    at java.lang.Thread.run(Thread.java:745)

    Number of locked synchronizers = 1
    - java.util.concurrent.ThreadPoolExecutor$Worker@6cd0b6f8

&#34;as-session-expire-daemon&#34; Id=25 cpuUsage=24% TIMED_WAITING
    at java.lang.Thread.sleep(Native Method)
    at com.taobao.arthas.core.server.DefaultSessionManager$2.run(DefaultSessionManager.java:85)

&#34;Reference Handler&#34; Id=2 cpuUsage=0% WAITING on java.lang.ref.Reference$Lock@69ba0f27
    at java.lang.Object.wait(Native Method)
    -  waiting on java.lang.ref.Reference$Lock@69ba0f27
    at java.lang.Object.wait(Object.java:503)
    at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)
</code></pre></div><h4 id=jad-反编译>jad 反编译</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a40000>$</span> <span style=color:#000>jad</span> <span style=color:#000>javax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>servlet</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Servlet</span>

<span style=color:#000>ClassLoader</span><span style=color:#000;font-weight:700>:</span>
<span style=color:#ce5c00;font-weight:700>+-</span><span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>net</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>URLClassLoader</span><span style=color:#a40000>@</span><span style=color:#0000cf;font-weight:700>6108</span><span style=color:#000>b2d7</span>
  <span style=color:#ce5c00;font-weight:700>+-</span><span style=color:#000>sun</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>misc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Launcher</span><span style=color:#a40000>$</span><span style=color:#000>AppClassLoader</span><span style=color:#a40000>@</span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#000>b4aac2</span>
    <span style=color:#ce5c00;font-weight:700>+-</span><span style=color:#000>sun</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>misc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Launcher</span><span style=color:#a40000>$</span><span style=color:#000>ExtClassLoader</span><span style=color:#a40000>@</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>ddf84b8</span>

<span style=color:#000>Location</span><span style=color:#000;font-weight:700>:</span>
<span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>xxx</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>work</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>lib</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>servlet</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>api</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>jar</span>

<span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic> * Decompiled with CFR 0_122.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>javax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>servlet</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>io</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>IOException</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>javax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>servlet</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServletConfig</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>javax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>servlet</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServletException</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>javax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>servlet</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServletRequest</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>javax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>servlet</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServletResponse</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Servlet</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>public</span> <span style=color:#000>void</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ServletConfig</span> <span style=color:#000>var1</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>throws</span> <span style=color:#000>ServletException</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#000>public</span> <span style=color:#000>ServletConfig</span> <span style=color:#000>getServletConfig</span><span style=color:#000;font-weight:700>();</span>

    <span style=color:#000>public</span> <span style=color:#000>void</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ServletRequest</span> <span style=color:#000>var1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ServletResponse</span> <span style=color:#000>var2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>throws</span> <span style=color:#000>ServletException</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>IOException</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#000>public</span> <span style=color:#000>String</span> <span style=color:#000>getServletInfo</span><span style=color:#000;font-weight:700>();</span>

    <span style=color:#000>public</span> <span style=color:#000>void</span> <span style=color:#000>destroy</span><span style=color:#000;font-weight:700>();</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h4 id=mc-编译-class>mc 编译 <code>.class</code></h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mc /tmp/Test.java
</code></pre></div><h4 id=redefine-加载外部-class-修改已加载类>redefine 加载外部 <code>.class</code> 修改已加载类</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>redefine /tmp/Test.class
redefine -c 327a647b /tmp/Test.class /tmp/Test\$Inner.class
</code></pre></div><h4 id=sc-查找已加载类>sc 查找已加载类</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ sc -d org.springframework.web.context.support.XmlWebApplicationContext
 class-info        org.springframework.web.context.support.XmlWebApplicationContext
 code-source       /Users/xxx/work/test/WEB-INF/lib/spring-web-3.2.11.RELEASE.jar
 name              org.springframework.web.context.support.XmlWebApplicationContext
 isInterface       false
 isAnnotation      false
 isEnum            false
 isAnonymousClass  false
 isArray           false
 isLocalClass      false
 isMemberClass     false
 isPrimitive       false
 isSynthetic       false
 simple-name       XmlWebApplicationContext
 modifier          public
 annotation
 interfaces
 super-class       +-org.springframework.web.context.support.AbstractRefreshableWebApplicationContext
                     +-org.springframework.context.support.AbstractRefreshableConfigApplicationContext
                       +-org.springframework.context.support.AbstractRefreshableApplicationContext
                         +-org.springframework.context.support.AbstractApplicationContext
                           +-org.springframework.core.io.DefaultResourceLoader
                             +-java.lang.Object
 class-loader      +-org.apache.catalina.loader.ParallelWebappClassLoader
                     +-java.net.URLClassLoader@6108b2d7
                       +-sun.misc.Launcher$AppClassLoader@18b4aac2
                         +-sun.misc.Launcher$ExtClassLoader@1ddf84b8
 classLoaderHash   25131501
</code></pre></div><h4 id=stack-查看调用栈>stack 查看调用栈</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ stack test.arthas.TestStack doGet
Press Ctrl+C to abort.
Affect(class-cnt:1 , method-cnt:1) cost in 286 ms.
ts=2018-09-18 10:11:45;thread_name=http-bio-8080-exec-10;id=d9;is_daemon=true;priority=5;TCCL=org.apache.catalina.loader.ParallelWebappClassLoader@25131501
    @test.arthas.TestStack.doGet()
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:624)
        at javax.servlet.http.HttpServlet.service(HttpServlet.java:731)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)
        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)
        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)
        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:110)
        ...
        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:169)
        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)
        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)
        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:451)
        at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1121)
        at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:637)
        at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:316)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
        at java.lang.Thread.run(Thread.java:745)
</code></pre></div><h4 id=trace-追踪方法调用>trace 追踪方法调用</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124224720.png style=display:block;width:80% alt=NAME align=center> </div>
<h4 id=watch-查看方法调用入参>watch 查看方法调用入参</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ watch test.arthas.TestWatch doGet {params[0], throwExp} -e
Press Ctrl+C to abort.
Affect(class-cnt:1 , method-cnt:1) cost in 65 ms.
ts=2018-09-18 10:26:28;result=@ArrayList[
    @RequestFacade[org.apache.catalina.connector.RequestFacade@79f922b2],
    @NullPointerException[java.lang.NullPointerException],
]
</code></pre></div><h4 id=monitor-监控方法调用统计信息>monitor 监控方法调用统计信息</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ monitor -c 5 org.apache.dubbo.demo.provider.DemoServiceImpl sayHello
Press Ctrl+C to abort.
Affect(class-cnt:1 , method-cnt:1) cost in 109 ms.
 timestamp            class                                           method    total  success  fail  avg-rt(ms)  fail-rate
----------------------------------------------------------------------------------------------------------------------------
 2018-09-20 09:45:32  org.apache.dubbo.demo.provider.DemoServiceImpl  sayHello  5      5        0     0.67        0.00%

 timestamp            class                                           method    total  success  fail  avg-rt(ms)  fail-rate
----------------------------------------------------------------------------------------------------------------------------
 2018-09-20 09:45:37  org.apache.dubbo.demo.provider.DemoServiceImpl  sayHello  5      5        0     1.00        0.00%

 timestamp            class                                           method    total  success  fail  avg-rt(ms)  fail-rate
----------------------------------------------------------------------------------------------------------------------------
 2018-09-20 09:45:42  org.apache.dubbo.demo.provider.DemoServiceImpl  sayHello  5      5        0     0.43        0.00%
</code></pre></div><h4 id=time-tunnel-记录调用现场以回放>time tunnel 记录调用现场以回放</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ tt -t org.apache.dubbo.demo.provider.DemoServiceImpl sayHello
Press Ctrl+C to abort.
Affect(class-cnt:1 , method-cnt:1) cost in 75 ms.
 INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD
-------------------------------------------------------------------------------------------------------------------------------------
 1000    2018-09-20 09:54:10  1.971195  true    false    0x55965cca     DemoServiceImpl                sayHello
 1001    2018-09-20 09:54:11  0.215685  true    false    0x55965cca     DemoServiceImpl                sayHello
 1002    2018-09-20 09:54:12  0.236303  true    false    0x55965cca     DemoServiceImpl                sayHello
 1003    2018-09-20 09:54:13  0.159598  true    false    0x55965cca     DemoServiceImpl                sayHello
 1004    2018-09-20 09:54:14  0.201982  true    false    0x55965cca     DemoServiceImpl                sayHello
 1005    2018-09-20 09:54:15  0.214205  true    false    0x55965cca     DemoServiceImpl                sayHello
 1006    2018-09-20 09:54:16  0.241863  true    false    0x55965cca     DemoServiceImpl                sayHello
 1007    2018-09-20 09:54:17  0.305747  true    false    0x55965cca     DemoServiceImpl                sayHello
 1008    2018-09-20 09:54:18  0.18468   true    false    0x55965cca     DemoServiceImpl                sayHello
</code></pre></div><h4 id=classloader-查看类加载信息>classloader 查看类加载信息</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ classloader
 name                                                  numberOfInstances  loadedCountTotal
 BootstrapClassLoader                                  1                  3346
 com.taobao.arthas.agent.ArthasClassloader             1                  1262
 java.net.URLClassLoader                               2                  1033
 org.apache.catalina.loader.ParallelWebappClassLoader  1                  628
 sun.reflect.DelegatingClassLoader                     166                166
 sun.misc.Launcher$AppClassLoader                      1                  31
 com.alibaba.fastjson.util.ASMClassLoader              6                  15
 sun.misc.Launcher$ExtClassLoader                      1                  7
 org.jvnet.hk2.internal.DelegatingClassLoader          2                  2
 sun.reflect.misc.MethodUtil                           1                  1
</code></pre></div><h4 id=web-console-基于-web-的控制台>web console 基于 web 的控制台</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124225002.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=命令集>命令集</h3>
<h4 id=基础命令>基础命令</h4>
<ul>
<li>help——查看命令帮助信息</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/cat.md>cat</a>——打印文件内容，和linux里的cat命令类似</li>
<li>[grep]](<a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/grep.md>https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/grep.md</a>)——匹配查找，和linux里的grep命令类似</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/pwd.md>pwd</a>——返回当前的工作目录，和linux命令类似</li>
<li>cls——清空当前屏幕区域</li>
<li>session——查看当前会话的信息</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/reset.md>reset</a>——重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端关闭时会重置所有增强过的类</li>
<li>version——输出当前目标 Java 进程所加载的 Arthas 版本号</li>
<li>history——打印命令历史</li>
<li>quit——退出当前 Arthas 客户端，其他 Arthas 客户端不受影响</li>
<li>stop/shutdown——关闭 Arthas 服务端，所有 Arthas 客户端全部退出</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/keymap.md>keymap</a>——Arthas快捷键列表及自定义快捷键</li>
</ul>
<h4 id=jvm-命令>JVM 命令</h4>
<ul>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/dashboard.md>dashboard</a>——当前系统的实时数据面板</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/thread.md>thread</a>——查看当前 JVM 的线程堆栈信息</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/jvm.md>jvm</a>——查看当前 JVM 的信息</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/sysprop.md>sysprop</a>——查看和修改JVM的系统属性</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/sysenv.md>sysenv</a>——查看JVM的环境变量</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/vmoption.md>vmoption</a>——查看和修改JVM里诊断相关的option</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/logger.md>logger</a>——查看和修改logger</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/getstatic.md>getstatic</a>——查看类的静态属性</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/ognl.md>ognl</a>——执行ognl表达式</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/mbean.md>mbean</a>——查看 Mbean 的信息</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/heapdump.md>heapdump</a>——dump java heap, 类似jmap命令的heap dump功能</li>
</ul>
<h4 id=classclassloader>class/classloader</h4>
<ul>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/sc.md>sc</a>——查看JVM已加载的类信息</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/sm.md>sm</a>——查看已加载类的方法信息</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/jad.md>jad</a>——反编译指定已加载类的源码</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/mc.md>mc</a>——内存编绎器，内存编绎<code>.java</code>文件为<code>.class</code>文件</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/redefine.md>redefine</a>——加载外部的<code>.class</code>文件，redefine到JVM里</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/dump.md>dump</a>——dump 已加载类的 byte code 到特定目录</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/classloader.md>classloader</a>——查看classloader的继承树，urls，类加载信息，使用classloader去getResource</li>
</ul>
<h4 id=monitorwatchtrace>monitor/watch/trace</h4>
<blockquote>
<p>这些命令，都通过字节码增强技术来实现的，会在指定类的方法中插入一些切面来实现数据统计和观测，因此在线上、预发使用时，请尽量明确需要观测的类、方法以及条件，诊断结束要执行 <code>shutdown</code> 或将增强过的类执行 <code>reset</code> 命令。</p>
</blockquote>
<ul>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/monitor.md>monitor</a>——方法执行监控</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/watch.md>watch</a>——方法执行数据观测</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/trace.md>trace</a>——方法内部调用路径，并输出方法路径上的每个节点上耗时</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/stack.md>stack</a>——输出当前方法被调用的调用路径</li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/tt.md>tt</a>——方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</li>
</ul>
<h4 id=options>options</h4>
<ul>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/options.md>options</a>——查看或设置Arthas全局开关</li>
</ul>
<h4 id=管道>管道</h4>
<p>Arthas支持使用管道对上述命令的结果进行进一步的处理，如<code>sm java.lang.String * | grep 'index'</code></p>
<ul>
<li>grep——搜索满足条件的结果</li>
<li>plaintext——将命令的结果去除ANSI颜色</li>
<li>wc——按行统计输出结果</li>
</ul>
<h4 id=后台异步任务>后台异步任务</h4>
<p>当线上出现偶发的问题，比如需要watch某个条件，而这个条件一天可能才会出现一次时，异步后台任务就派上用场了，详情请参考<a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/async.md>这里</a></p>
<ul>
<li>使用 > 将结果重写向到日志文件，使用 & 指定命令是后台运行，session断开不影响任务执行(生命周期默认为1天)</li>
<li>jobs——列出所有job</li>
<li>kill——强制终止任务</li>
<li>fg——将暂停的任务拉到前台执行</li>
<li>bg——将暂停的任务放到后台执行</li>
</ul>
<h4 id=用户数据回报>用户数据回报</h4>
<p>在<code>3.1.4</code>版本后，增加了用户数据回报功能，方便统一做安全或者历史数据统计。</p>
<p>在启动时，指定<code>stat-url</code>，就会回报执行的每一行命令，比如： <code>./as.sh --stat-url 'http://192.168.10.11:8080/api/stat'</code></p>
<p>在tunnel server里有一个示例的回报代码，用户可以自己在服务器上实现。</p>
<ul>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/https://github.com/alibaba/arthas/blob/master/tunnel-server/src/main/java/com/alibaba/arthas/tunnel/server/app/web/StatController.java>StatController.java</a></li>
</ul>
<h4 id=其他特性>其他特性</h4>
<ul>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/async.md>异步命令支持</a></li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/save-log.md>执行结果存日志</a></li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/batch-support.md>批处理的支持</a></li>
<li><a href=https://github.com/alibaba/arthas/blob/master/site/src/site/sphinx/https://github.com/alibaba/arthas/issues/11>ognl表达式的用法说明</a></li>
</ul>
<h2 id=应用实例>应用实例</h2>
<h3 id=查看最繁忙的线程以及是否有阻塞情况发生>查看最繁忙的线程，以及是否有阻塞情况发生?</h3>
<p>场景：我想看下查看最繁忙的线程，以及是否有阻塞情况发生? 常规查看线程，一般我们可以通过 top 等系统命令进行查看，但是那毕竟要很多个步骤，很麻烦。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>thread -n <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#8f5902;font-style:italic># 查看最繁忙的三个线程栈信息</span>
thread  <span style=color:#8f5902;font-style:italic># 以直观的方式展现所有的线程情况</span>
thread -b <span style=color:#8f5902;font-style:italic>#找出当前阻塞其他线程的线程</span>
</code></pre></div><h3 id=确认某个类是否已被系统加载>确认某个类是否已被系统加载?</h3>
<p>场景：我新写了一个类或者一个方法，我想知道新写的代码是否被部署了?</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># 即可以找到需要的类全路径，如果存在的话
sc *MyServlet

# 查看这个某个类所有的方法
sm pdai.tech.servlet.TestMyServlet *

# 查看某个方法的信息，如果存在的话
sm pdai.tech.servlet.TestMyServlet testMethod  
</code></pre></div><h3 id=如何查看一个class类的源码信息>如何查看一个class类的源码信息?</h3>
<p>场景：我新修改的内容在方法内部，而上一个步骤只能看到方法，这时候可以反编译看下源码</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># 直接反编译出java 源代码，包含一此额外信息的
jad pdai.tech.servlet.TestMyServlet
</code></pre></div><h3 id=重要如何跟踪某个方法的返回值入参->重要：如何跟踪某个方法的返回值、入参&mldr;. ?</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># 同时监控入参，返回值，及异常
watch pdai.tech.servlet.TestMyServlet testMethod &#34;{params, returnObj, throwExp}&#34; -e -x 2 
</code></pre></div><h3 id=如何看方法调用栈的信息>如何看方法调用栈的信息?</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>stack pdai.tech.servlet.TestMyServlet testMethod
</code></pre></div><h3 id=重要找到最耗时的方法调用>重要：找到最耗时的方法调用?</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># 执行的时候每个子调用的运行时长，可以找到最耗时的子调用。
stack pdai.tech.servlet.TestMyServlet testMethod
</code></pre></div><h3 id=重要如何临时更改代码运行>重要：如何临时更改代码运行?</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># 先反编译出class源码
jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java  

# 然后使用外部工具编辑内容
mc /tmp/UserController.java -d /tmp  # 再编译成class

# 最后，重新载入定义的类，就可以实时验证你的猜测了
redefine /tmp/com/example/demo/arthas/user/UserController.class
</code></pre></div><p>如上，是直接更改线上代码的方式，但是一般好像是编译不成功的。所以，最好是本地ide编译成 class文件后，再上传替换为好！</p>
<p>总之，已经完全不用重启和发布了！这个功能真的很方便，比起重启带来的代价，真的是不可比的。比如，重启时可能导致负载重分配，选主等等问题，就不是你能控制的了。</p>
<h3 id=场景我如何测试某个方法的性能问题>场景：我如何测试某个方法的性能问题?</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>monitor -c 5 demo.MathGame primeFactors
</code></pre></div><h3 id=场景spring-context>场景：Spring Context</h3>
<h4 id=通过请求处理器获取-context>通过请求处理器获取 Context</h4>
<p>如果已知服务接口被调用的较为频繁，可以通过请求处理器获取上下文。</p>
<p>首先通过 tt 记录某次请求的上下文：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod
</code></pre></div><p>当请求出现时，会出现记录：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ watch com.example.demo.Test * &#39;params[0]@sss&#39;
$ tt -t org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter invokeHandlerMethod
Press Ctrl+C to abort.
Affect(class-cnt:1 , method-cnt:1) cost in 101 ms.
 INDEX  TIMESTAMP         COST(ms  IS-RE  IS-EX  OBJECT       CLASS                     METHOD
                          )        T      P
------------------------------------------------------------------------------------------------------------------
 1000   2019-01-27 16:31  3.66744  true   false  0x4465cf70   RequestMappingHandlerAda  invokeHandlerMethod
        :54                                                   pter
</code></pre></div><p>然后可以用<code>tt</code>命令的<code>-i</code>参数来指定index，并且用<code>-w</code>参数来执行ognl表达式来获取spring context：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ tt -i 1000 -w &#39;target.getApplicationContext()&#39;
@AnnotationConfigEmbeddedWebApplicationContext[
    reader=@AnnotatedBeanDefinitionReader[org.springframework.context.annotation.AnnotatedBeanDefinitionReader@35dc90ec],
    scanner=@ClassPathBeanDefinitionScanner[org.springframework.context.annotation.ClassPathBeanDefinitionScanner@72078a14],
    annotatedClasses=null,
    basePackages=null,
]
Affect(row-cnt:1) cost in 7 ms.
</code></pre></div><p>然后从 context 中获取 bean：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ tt -i 1000 -w &#39;target.getApplicationContext().getBean(&#34;helloWorldService&#34;).getHelloMessage()&#39;
@String[Hello World]
Affect(row-cnt:1) cost in 5 ms.
</code></pre></div><h4 id=通过静态方法获取-context>通过静态方法获取 Context</h4>
<p>在很多代码里都有static函数或者static holder类，可以获取很多其它的对象。比如在Dubbo里通过<code>SpringExtensionFactory</code>获取spring context：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ ognl &#39;#context=@com.alibaba.dubbo.config.spring.extension.SpringExtensionFactory@contexts.iterator.next, 
#context.getBean(&#34;userServiceImpl&#34;).findUser(1)&#39;
@User[
    id=@Integer[1],
    name=@String[Deanna Borer],
]
</code></pre></div><h2 id=实现原理>实现原理</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124225642.png style=display:block;width:80% alt=NAME align=center> </div>
<h3 id=相关文章>相关文章</h3>
<ul>
<li><a href=https://www.jianshu.com/p/70c1c55f12ef>什么是 Arthas</a></li>
<li><a href=https://yq.aliyun.com/articles/704228>Arthas阅读</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a41d104c7e9d1e19fd5d27d5bf0f9159>7 - 本地调试</h1>
<h2 id=intellij-idea-debug>Intellij IDEA Debug</h2>
<p>如下是在IDEA中启动Debug模式，进入断点后的界面，我这里是Windows，可能和Mac的图标等会有些不一样。就简单说下图中标注的8个地方：</p>
<ul>
<li>① 以Debug模式启动服务，左边的一个按钮则是以Run模式启动。在开发中，我一般会直接启动Debug模式，方便随时调试代码。</li>
<li>② 断点：在左边行号栏单击左键，或者快捷键Ctrl+F8 打上/取消断点，断点行的颜色可自己去设置。</li>
<li>③ Debug窗口：访问请求到达第一个断点后，会自动激活Debug窗口。如果没有自动激活，可以去设置里设置，如图1.2。</li>
<li>④ 调试按钮：一共有8个按钮，调试的主要功能就对应着这几个按钮，鼠标悬停在按钮上可以查看对应的快捷键。在菜单栏Run里可以找到同样的对应的功能，如图1.4。</li>
<li>⑤ 服务按钮：可以在这里关闭/启动服务，设置断点等。</li>
<li>⑥ 方法调用栈：这里显示了该线程调试所经过的所有方法，勾选右上角的[Show All Frames]按钮，就不会显示其它类库的方法了，否则这里会有一大堆的方法。</li>
<li>⑦ Variables：在变量区可以查看当前断点之前的当前方法内的变量。</li>
<li>⑧ Watches：查看变量，可以将Variables区中的变量拖到Watches中查看</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124230835.png style=display:block;width:80% alt=NAME align=center> </div>
<p>在设置里勾选Show debug window on breakpoint，则请求进入到断点后自动激活Debug窗口</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124230857.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=基本应用>基本应用</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211124232202.png style=display:block;width:50% alt=NAME align=center> </div>
<p><code>Show Execution Point</code> (Alt + F10)：如果你的光标在其它行或其它页面，点击这个按钮可跳转到当前代码执行的行。</p>
<p><code>Step Over</code> (F8)：步过，一行一行地往下走，如果这一行上有方法不会进入方法。</p>
<p><code>Step Into</code> (F7)：步入，如果当前行有方法，可以进入方法内部，一般用于进入自定义方法内，不会进入官方类库的方法，如第25行的put方法。</p>
<p><code>Force Step Into</code> (Alt + Shift + F7)：强制步入，能进入任何方法，查看底层源码的时候可以用这个进入官方类库的方法。</p>
<p><code>Step Out</code> (Shift + F8)：步出，从步入的方法内退出到方法调用处，此时方法已执行完毕，只是还没有完成赋值。</p>
<p><code>Drop Frame</code> (默认无)：回退断点，后面章节详细说明。</p>
<p><code>Run to Cursor</code> (Alt + F9)：运行到光标处，你可以将光标定位到你需要查看的那一行，然后使用这个功能，代码会运行至光标行，而不需要打断点。</p>
<p><code>Evaluate Expression</code> (Alt + F8)：计算表达式，后面章节详细说明。</p>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>