<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.90.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Java I/0 | infilos.com</title><meta property="og:title" content="Java I/0">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Java I/0">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Java I/0">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Java I/0</h1>
<ul>
<li>1: <a href=#pg-4173475665554ac72b162bd9e768d99b>CH01-IO分类</a></li>
<li>2: <a href=#pg-132757708b0e03054ccc15b1ccda9394>CH02-装饰模式</a></li>
<li>3: <a href=#pg-747966313cf609a9b480dcb72763161b>CH03-InputStream</a></li>
<li>4: <a href=#pg-4678bab34901a915f5377636d14003c8>CH04-OutputStream</a></li>
<li>5: <a href=#pg-3711fc47d4bd344e88d2c026371a33d2>CH05-常用操作.md</a></li>
<li>6: <a href=#pg-dc8da535c70e975714d2f9e3a34111ac>CH06-IO实现</a></li>
<li>7: <a href=#pg-312904add31ff8ea8730fec11cef07bc>CH07-IO模型</a></li>
<li>8: <a href=#pg-3d6330bcf4302926c8990d2573910e68>CH08-BIO原理</a></li>
<li>9: <a href=#pg-37086be27cb4e2dc026ba972768fcb2d>CH09-NIO基础</a></li>
<li>10: <a href=#pg-da781159746dd7bd152d97f3a8350579>CH10-NIO原理</a></li>
<li>11: <a href=#pg-e8064dcc899de72ab1295366b642e4a2>CH11-AIO原理</a></li>
<li>12: <a href=#pg-48dbf55268518f9a2344d8bbc9093d0f>CH12-零拷贝</a></li>
<li>13: <a href=#pg-4b8f0dd10f10472f6fce3d8242ba0444>CH13-内存映射</a></li>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-4173475665554ac72b162bd9e768d99b>1 - CH01-IO分类</h1>
<h2 id=基于传输方式>基于传输方式</h2>
<p>从数据传输方式或者说是运输方式角度看，可以将 IO 类分为:</p>
<ul>
<li>字节流</li>
<li>字符流</li>
</ul>
<p><code>字节</code>是个计算机看的，<code>字符</code>才是给人看的。</p>
<h3 id=字节流>字节流</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213255.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=字符流>字符流</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213310.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=二者区别>二者区别</h3>
<ul>
<li>
<p>字节流读取单个字节，字符流读取单个字符(一个字符根据编码的不同，对应的字节也不同，如 UTF-8 编码是 3 个字节，中文编码是 2 个字节。)</p>
</li>
<li>
<p>字节流用来处理二进制文件(图片、MP3、视频文件)，字符流用来处理文本文件(可以看做是特殊的二进制文件，使用了某种编码，人可以阅读)。</p>
</li>
</ul>
<h3 id=字节---字符inputoutputstreamreaderwriter>字节 -> 字符：Input/OutputStreamReader/Writer</h3>
<ul>
<li>
<p>编码就是把字符转换为字节，而解码是把字节重新组合成字符。</p>
</li>
<li>
<p>如果编码和解码过程使用不同的编码方式那么就出现了乱码。</p>
<ul>
<li>GBK 编码中，中文字符占 2 个字节，英文字符占 1 个字节；</li>
<li>UTF-8 编码中，中文字符占 3 个字节，英文字符占 1 个字节；</li>
<li>UTF-16be 编码中，中文字符和英文字符都占 2 个字节。</li>
</ul>
</li>
<li>
<p>UTF-16be 中的 be 指的是 Big Endian，也就是大端。相应地也有 UTF-16le，le 指的是 Little Endian，也就是小端。</p>
</li>
</ul>
<p>Java 使用双字节编码 UTF-16be，这不是指 Java 只支持这一种编码方式，而是说 char 这种类型使用 UTF-16be 进行编码。char 类型占 16 位，也就是两个字节，Java 使用这种双字节编码是为了让一个中文或者一个英文都能使用一个 char 来存储。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213525.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=基于数据操作>基于数据操作</h2>
<p>从数据来源或操作对象角度看，IO 又可以按如下方式分类：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213615.png style=display:block;width:50% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-132757708b0e03054ccc15b1ccda9394>2 - CH02-装饰模式</h1>
<h2 id=装饰模式>装饰模式</h2>
<p>装饰者(Decorator)和具体组件(ConcreteComponent)都继承自组件(Component)，具体组件的方法实现不需要依赖于其它对象，而装饰者组合了一个组件，这样它可以装饰其它装饰者或者具体组件。</p>
<p>所谓装饰，就是把这个装饰者套在被装饰者之上，从而动态扩展被装饰者的功能。装饰者的方法有一部分是自己的，这属于它的功能，然后调用被装饰者的方法实现，从而也保留了被装饰者的功能。可以看到，具体组件应当是装饰层次的最低层，因为只有具体组件的方法实现不需要依赖于其它对象。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213844.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=io-装饰模式>IO 装饰模式</h2>
<p>以 InputStream 为例，</p>
<ul>
<li>InputStream 是抽象组件；</li>
<li>FileInputStream 是 InputStream 的子类，属于具体组件，提供了字节流的输入操作；</li>
<li>FilterInputStream 属于抽象装饰者，装饰者用于装饰组件，为组件提供额外的功能。例如 BufferedInputStream 为 FileInputStream 提供缓存的功能。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213913.png style=display:block;width:50% alt=NAME align=center> </div>
<p>实例化一个具有缓存功能的字节流对象时，只需要在 FileInputStream 对象上再套一层 BufferedInputStream 对象即可。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>FileInputStream</span> <span style=color:#000>fileInputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filePath</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>BufferedInputStream</span> <span style=color:#000>bufferedInputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileInputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>DataInputStream 装饰者提供了对更多数据类型进行输入的操作，比如 int、double 等基本类型。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-747966313cf609a9b480dcb72763161b>3 - CH03-InputStream</h1>
<h2 id=层级结构>层级结构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501214031.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=inputstream-抽象类>InputStream 抽象类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 读取数据
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> 
<span style=color:#8f5902;font-style:italic>// 将读取到的数据放在 byte 数组中，该方法实际上是根据下面的方法实现的，off 为 0，len 为数组的长度
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic>// 从第 off 位置读取 len 长度字节的数据放到 byte 数组中，流是以 -1 来判断是否读取结束的
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic>// 跳过指定个数的字节不读取，想想看电影跳过片头片尾
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 返回可读的字节数量
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 读取完，关闭流，释放资源
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic>// 标记读取位置，下次还可以从这里开始读取，使用前要看当前流是否支持，可以使用 markSupport() 方法判断
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 重置读取位置为上次 mark 标记的位置
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 判断当前流是否支持标记流，和上面两个方法配套使用
</span></code></pre></div><h2 id=源码实现>源码实现</h2>
<h3 id=inputstream>InputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InputStream</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Closeable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SKIP_BUFFER_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2048</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//用于skip方法，和skipBuffer相关
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>skipBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>// skipBuffer is initialized in skip(long), if needed.
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//从输入流中读取下一个字节，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//正常返回0-255，到达文件的末尾返回-1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//在流中还有数据，但是没有读到时该方法会阻塞(block)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//Java IO和New IO的区别就是阻塞流和非阻塞流
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//抽象方法！不同的子类不同的实现！
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>;</span>  
    
    <span style=color:#8f5902;font-style:italic>//将流中的数据读入放在byte数组的第off个位置先后的len个位置中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//返回值为放入字节的个数。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//这个方法在利用抽象方法read，某种意义上简单的Templete模式。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查输入是否正常。一般情况下，检查输入是方法设计的第一步
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>        
        <span style=color:#8f5902;font-style:italic>//读取下一个字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//到达文件的末端返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//返回的字节downcast                           
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//已经读取了一个字节                                                   
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                        
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//最多读取len个字节，所以要循环len次
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//每次循环从流中读取一个字节
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//由于read方法阻塞，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//所以read(byte[],int,int)也会阻塞
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//到达末尾，理所当然返回-1                                       
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#ce5c00;font-weight:700>}</span> 
                <span style=color:#8f5902;font-style:italic>//读到就放入byte数组中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ee</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

     <span style=color:#8f5902;font-style:italic>//利用上面的方法read(byte[] b)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>                          
    <span style=color:#8f5902;font-style:italic>//方法内部使用的、表示要跳过的字节数目，
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>    
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nr</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>skipBuffer</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#8f5902;font-style:italic>//初始化一个跳转的缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>skipBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>SKIP_BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>];</span>                   
        <span style=color:#8f5902;font-style:italic>//本地化的跳转缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>localSkipBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>skipBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>          
        <span style=color:#8f5902;font-style:italic>//检查输入参数，应该放在方法的开始                            
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>                             
        <span style=color:#8f5902;font-style:italic>//一共要跳过n个，每次跳过部分，循环       
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                      
            <span style=color:#000>nr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>localSkipBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SKIP_BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>//利用上面的read(byte[],int,int)方法尽量读取n个字节  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//读到流的末端，则返回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nr</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//没有完全读到需要的，则继续循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>nr</span><span style=color:#ce5c00;font-weight:700>;</span>                                       
        <span style=color:#ce5c00;font-weight:700>}</span>       
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//返回时要么全部读完，要么因为到达文件末端，读取了部分
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//查询流中还有多少可以读取的字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//该方法不会block。在java中抽象类方法的实现一般有以下几种方式: 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//1.抛出异常(java.util)；2.“弱”实现。像上面这种。子类在必要的时候覆盖它。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//3.“空”实现。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭当前流、同时释放与此流相关的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//关闭当前流、同时释放与此流相关的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{}</span>
    <span style=color:#8f5902;font-style:italic>//markSupport可以查询当前流是否支持mark
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{}</span>
    <span style=color:#8f5902;font-style:italic>//对mark过的流进行复位。只有当流支持mark时才可以使用此方法。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

                   <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mark/reset not supported&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//查询是否支持mark
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//绝大部分不支持，因此提供默认实现，返回false。子类有需要可以覆盖。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=filterinputstream>FilterInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilterInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//装饰器的代码特征: 被装饰的对象一般是装饰器的成员变量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//将要被装饰的字节输入流
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>FilterInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>   <span style=color:#8f5902;font-style:italic>//通过构造方法传入此被装饰的流
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//下面这些方法，完成最小的装饰――0装饰，只是调用被装饰流的方法而已
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>available</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>markSupported</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bytearrayinputstream>ByteArrayInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ByteArrayInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>                <span style=color:#8f5902;font-style:italic>//内部的buffer，一般通过构造器输入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>//当前位置的cursor。从0至byte数组的长度。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//byte[pos]就是read方法读取的字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mark</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#8f5902;font-style:italic>//mark的位置。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>              <span style=color:#8f5902;font-style:italic>//流中字节的数目。
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>//构造器，从一个byte[]创建一个ByteArrayInputStream
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//初始化流中的各个成员变量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>;</span>              
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//构造器
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//与上面不同
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mark</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//与上面不同
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//从流中读取下一个字节
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#8f5902;font-style:italic>//返回下一个位置的字节//流中没有数据则返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// ByteArrayInputStream要覆盖InputStream中可以看出其提供了该方法的实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//某些时候，父类不能完全实现子类的功能，父类的实现一般比较通用。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//当子类有更有效的方法时，我们会覆盖这些方法。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//首先检查输入参数的状态是否正确
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span> 
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>             <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>             <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//java中提供数据复制的方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//出于速度的原因！他们都用到System.arraycopy方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span> 
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//下面这个方法，在InputStream中也已经实现了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//但是当时是通过将字节读入一个buffer中实现的，好像效率低了一点。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//比InputStream中的方法简单、高效
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//当前位置，可以跳跃的字节数目
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#ce5c00;font-weight:700>}</span>       
        <span style=color:#8f5902;font-style:italic>//小于0，则不可以跳跃
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#ce5c00;font-weight:700>}</span>   
        <span style=color:#8f5902;font-style:italic>//跳跃后，当前位置变化                                 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                              
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>   
    <span style=color:#8f5902;font-style:italic>//查询流中还有多少字节没有读取。                                 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//ByteArrayInputStream支持mark所以返回true
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>                   

                   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#8f5902;font-style:italic>//在流中当前位置mark。      
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readAheadLimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>            
        <span style=color:#000>mark</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//重置流。即回到mark的位置。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭ByteArrayInputStream不会产生任何动作。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bufferedinputstream>BufferedInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BufferedInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FilterInputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>defaultBufferSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8192</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>//默认缓存的大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>  <span style=color:#8f5902;font-style:italic>//内部的缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>//buffer的大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#8f5902;font-style:italic>//buffer中cursor的位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>//mark的位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>//mark的范围
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//原子性更新。和一致性编程相关
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span>    
    <span style=color:#000>AtomicReferenceFieldUpdater</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>bufUpdater</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>AtomicReferenceFieldUpdater</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newUpdater</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;buf&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//检查输入流是否关闭，同时返回被包装流
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InputStream</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stream closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//检查buffer的状态，同时返回缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                       
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//不太可能发生的状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stream closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>    
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//构造器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//指定默认长度的buffer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultBufferSize</span><span style=color:#ce5c00;font-weight:700>);</span>                                                              
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                           
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//检查输入参数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>&lt;=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buffer size &lt;= 0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//创建指定长度的buffer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//从流中读取数据，填充如缓存中。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//得到buffer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>                            
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//mark位置小于0，此时pos为0
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//pos大于buffer的长度            
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> 
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>        
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>markpos</span><span style=color:#ce5c00;font-weight:700>;</span>                                                           
　　　　　　　　　 <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>markpos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sz</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sz</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                 
                <span style=color:#8f5902;font-style:italic>//buffer的长度大于marklimit时，mark失效
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> 
                <span style=color:#8f5902;font-style:italic>//丢弃buffer中的内容                                                                  
</span><span style=color:#8f5902;font-style:italic></span>　　　　　　　　　 <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                                    
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>                                                                         
                <span style=color:#8f5902;font-style:italic>//buffer的长度小于marklimit时对buffer扩容
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nsz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nsz</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>)</span> 
                    <span style=color:#000>nsz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//扩容为原来的2倍，太大则为marklimit大小
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>nsz</span><span style=color:#ce5c00;font-weight:700>];</span>                   
                    <span style=color:#8f5902;font-style:italic>//将buffer中的字节拷贝如扩容后的buf中    
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>        
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bufUpdater</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>    
                    <span style=color:#8f5902;font-style:italic>//在buffer在被操作时，不能取代此buffer
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stream closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>//将新buf赋值给buffer
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>;</span>                                                               
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//读取下一个字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#8f5902;font-style:italic>//到达buffer的末端    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                 
            <span style=color:#8f5902;font-style:italic>//就从流中读取数据，填充buffer 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                
　　　　　　　<span style=color:#8f5902;font-style:italic>//读过一次，没有数据则返回-1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                                
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//返回buffer中下一个位置的字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>()[</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>;</span>                           
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//将数据从流中读入buffer中
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                 
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//buffer中还剩的可读字符                                                                            
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//buffer中没有可以读取的数据时
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span><span style=color:#ce5c00;font-weight:700>&lt;=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>){</span>                                                                                        
            <span style=color:#8f5902;font-style:italic>//将输入流中的字节读入b中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>             
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//填充                                                                                               
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//从流中读取后，检查可以读取的数目
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cnt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>                                                  
        <span style=color:#8f5902;font-style:italic>//将当前buffer中的字节放入b的末端
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cnt</span><span style=color:#ce5c00;font-weight:700>);</span>            
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>cnt</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cnt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                     
　　　　　<span style=color:#8f5902;font-style:italic>// 检查buffer是否open
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//检查输入参数是否正确
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nread</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>nread</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>nread</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 检查buffer是否关闭
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>                                        
        <span style=color:#8f5902;font-style:italic>//检查输入参数是否正确
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>                 
        <span style=color:#8f5902;font-style:italic>//buffered中可以读取字节的数目
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>                    
        <span style=color:#8f5902;font-style:italic>//可以读取的小于0，则从流中读取
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                          
            <span style=color:#8f5902;font-style:italic>//mark小于0，则mark在流中 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>     
            <span style=color:#8f5902;font-style:italic>// 从流中读取数据，填充缓冲区。
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>();</span>                                  
            <span style=color:#8f5902;font-style:italic>//可以读的取字节为buffer的容量减当前位置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>                                   
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>       
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skipped</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>      
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>skipped</span><span style=color:#ce5c00;font-weight:700>;</span>                                       
　　　　　<span style=color:#8f5902;font-style:italic>//当前位置改变
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>skipped</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//该方法不会block！返回流中可以读取的字节的数目。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//该方法的返回值为缓存中的可读字节数目加流中可读字节数目的和
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>                 
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//当前位置处为mark位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>marklimit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 缓冲去关闭了，肯定就抛出异常！程序设计中经常的手段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Resetting to invalid mark&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>markpos</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//该流和ByteArrayInputStream一样都支持mark
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭当前流同时释放相应的系统资源。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bufUpdater</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// Else retry in case a new buf was CASed in fill()
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=pipedinputstream>PipedInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PipedInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//标识有读取方或写入方关闭
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>                                                             
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>closedByReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>//是否建立连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>connected</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                     
    <span style=color:#8f5902;font-style:italic>//标识哪个线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>readSide</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                                             
    <span style=color:#000>Thread</span> <span style=color:#000>writeSide</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//缓冲区的默认大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>PIPE_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>                         
    <span style=color:#8f5902;font-style:italic>//缓冲区
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>PIPE_SIZE</span><span style=color:#ce5c00;font-weight:700>];</span>                 
    <span style=color:#8f5902;font-style:italic>//下一个写入字节的位置。0代表空，in==out代表满
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>               
    <span style=color:#8f5902;font-style:italic>//下一个读取字节的位置
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>    
          
    <span style=color:#8f5902;font-style:italic>//给定源的输入流
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedOutputStream</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                
        <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//默认构造器，下部一定要connect源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedInputStream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#ce5c00;font-weight:700>}</span>                                                
    <span style=color:#8f5902;font-style:italic>//连接输入源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedOutputStream</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>               
        <span style=color:#8f5902;font-style:italic>//调用源的connect方法连接当前对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>                                                                           
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//只被PipedOuputStream调用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                  
        <span style=color:#8f5902;font-style:italic>//检查状态，写入
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                 
        <span style=color:#8f5902;font-style:italic>//永远是PipedOuputStream
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>                                                      
        <span style=color:#8f5902;font-style:italic>//输入和输出相等，等待空间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#000>awaitSpace</span><span style=color:#ce5c00;font-weight:700>();</span>                                                           
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//放入buffer相应的位置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xFF</span><span style=color:#ce5c00;font-weight:700>);</span>                                                             
        <span style=color:#8f5902;font-style:italic>//in为0表示buffer已空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#ce5c00;font-weight:700>}</span>                                             
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//从PipedOutputStream可以看出
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>                                   
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bytesToTransfer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytesToTransfer</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//满了，会通知读取的；空会通知写入
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#000>awaitSpace</span><span style=color:#ce5c00;font-weight:700>();</span>                                
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>bytesToTransfer</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bytesToTransfer</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>assert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>bytesToTransfer</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//检查当前状态，等待输入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                           
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>connected</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>closedByReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readSide</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>readSide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlive</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Read end dead&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>//Buffer已满，等待一段时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>awaitSpace</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                                              
        <span style=color:#8f5902;font-style:italic>//in==out表示满了，没有空间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                                             
            <span style=color:#8f5902;font-style:italic>//检查接受端的状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                       
            <span style=color:#8f5902;font-style:italic>//通知读取端
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                  
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InterruptedIOException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//通知所有等待的线程()已经接受到最后的字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>receivedLast</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>                  
        <span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>                             <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查一些内部状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>connected</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                              
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closedByReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>writeSide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlive</span><span style=color:#ce5c00;font-weight:700>()&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Write end dead&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//当前线程读取
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>readSide</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>                                            
        <span style=color:#8f5902;font-style:italic>//重复两次? ? ? 
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>trials</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                               
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//输入断关闭返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closedByWriter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>              <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#ce5c00;font-weight:700>}</span>                 
            <span style=color:#8f5902;font-style:italic>//状态错误
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>writeSide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlive</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>trials</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>         
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe broken&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>        <span style=color:#8f5902;font-style:italic>// 空了，通知写入端可以写入                                                                         try {
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InterruptedIOException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ret</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xFF</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>             <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//没有任何字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                 <span style=color:#ce5c00;font-weight:700>}</span>                             
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ret</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查输入参数的正确性
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                                 
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//读取下一个
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                 
        <span style=color:#8f5902;font-style:italic>//已经到达末尾了，返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#ce5c00;font-weight:700>}</span>                                            
        <span style=color:#8f5902;font-style:italic>//放入外部buffer中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                    
        <span style=color:#8f5902;font-style:italic>//return-len
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rlen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                            
        <span style=color:#8f5902;font-style:italic>//下一个in存在，且没有到达len
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>                                          
            <span style=color:#8f5902;font-style:italic>//依次放入外部buffer
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>rlen</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>++];</span>                                         
            <span style=color:#000>rlen</span><span style=color:#ce5c00;font-weight:700>++;</span>
            <span style=color:#8f5902;font-style:italic>//读到buffer的末尾，返回头部
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>         <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#ce5c00;font-weight:700>}</span>        
            <span style=color:#8f5902;font-style:italic>//读、写位置一致时，表示没有数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>               
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//返回填充的长度
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rlen</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                            
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//返回还有多少字节可以读取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>             
        <span style=color:#8f5902;font-style:italic>//到达末端，没有字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                                         
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//写入的和读出的一致，表示满
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>                                                               
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//写入的大于读出
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                                 
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#8f5902;font-style:italic>//写入的小于读出的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>                                                
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭当前流，同时释放与其相关的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                
        <span style=color:#8f5902;font-style:italic>//表示由输入流关闭
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>closedByReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>                                             
        <span style=color:#8f5902;font-style:italic>//同步化当前对象，in为-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#ce5c00;font-weight:700>}</span>        
    <span style=color:#ce5c00;font-weight:700>}</span>
        
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4678bab34901a915f5377636d14003c8>4 - CH04-OutputStream</h1>
<h2 id=outputstream-抽象类>OutputStream 抽象类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// 写入一个字节，可以看到这里的参数是一个 int 类型，对应上面的读方法，int 类型的 32 位，只有低 8 位才写入，高 24 位将舍弃。
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span>
<span style=color:#8f5902;font-style:italic>// 将数组中的所有字节写入，和上面对应的 read() 方法类似，实际调用的也是下面的方法。
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// 将 byte 数组从 off 位置开始，len 长度的字节写入
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic>// 强制刷新，将缓冲中的数据写入
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic>// 关闭输出流，流被关闭后就不能再输出数据了
</span></code></pre></div><h2 id=源码实现>源码实现</h2>
<h3 id=filteroutputstream>FilterOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * This class is the superclass of all classes that filter output
</span><span style=color:#8f5902;font-style:italic> * streams. These streams sit on top of an already existing output
</span><span style=color:#8f5902;font-style:italic> * stream (the &lt;i&gt;underlying&lt;/i&gt; output stream) which it uses as its
</span><span style=color:#8f5902;font-style:italic> * basic sink of data, but possibly transforming the data along the
</span><span style=color:#8f5902;font-style:italic> * way or providing additional functionality.
</span><span style=color:#8f5902;font-style:italic> * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic> * The class &lt;code&gt;FilterOutputStream&lt;/code&gt; itself simply overrides
</span><span style=color:#8f5902;font-style:italic> * all methods of &lt;code&gt;OutputStream&lt;/code&gt; with versions that pass
</span><span style=color:#8f5902;font-style:italic> * all requests to the underlying output stream. Subclasses of
</span><span style=color:#8f5902;font-style:italic> * &lt;code&gt;FilterOutputStream&lt;/code&gt; may further override some of these
</span><span style=color:#8f5902;font-style:italic> * methods as well as provide additional methods and fields.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  Jonathan Payne
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilterOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>OutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The underlying output stream to be filtered.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates an output stream filter built on top of the specified
</span><span style=color:#8f5902;font-style:italic>     * underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   out   the underlying output stream to be assigned to
</span><span style=color:#8f5902;font-style:italic>     *                the field &lt;tt&gt;this.out&lt;/tt&gt; for later use, or
</span><span style=color:#8f5902;font-style:italic>     *                &lt;code&gt;null&lt;/code&gt; if this instance is to be
</span><span style=color:#8f5902;font-style:italic>     *                created without an underlying stream.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FilterOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified &lt;code&gt;byte&lt;/code&gt; to this output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls the &lt;code&gt;write&lt;/code&gt; method of its underlying output stream,
</span><span style=color:#8f5902;font-style:italic>     * that is, it performs &lt;tt&gt;out.write(b)&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Implements the abstract &lt;tt&gt;write&lt;/tt&gt; method of &lt;tt&gt;OutputStream&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the &lt;code&gt;byte&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;b.length&lt;/code&gt; bytes to this output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls its &lt;code&gt;write&lt;/code&gt; method of three arguments with the
</span><span style=color:#8f5902;font-style:italic>     * arguments &lt;code&gt;b&lt;/code&gt;, &lt;code&gt;0&lt;/code&gt;, and
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;b.length&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Note that this method does not call the one-argument
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;write&lt;/code&gt; method of its underlying stream with the single
</span><span style=color:#8f5902;font-style:italic>     * argument &lt;code&gt;b&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the data to be written.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#write(byte[], int, int)
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;byte&lt;/code&gt; array starting at offset &lt;code&gt;off&lt;/code&gt; to
</span><span style=color:#8f5902;font-style:italic>     * this output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls the &lt;code&gt;write&lt;/code&gt; method of one argument on each
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;byte&lt;/code&gt; to output.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Note that this method does not call the &lt;code&gt;write&lt;/code&gt; method
</span><span style=color:#8f5902;font-style:italic>     * of its underlying input stream with the same arguments. Subclasses
</span><span style=color:#8f5902;font-style:italic>     * of &lt;code&gt;FilterOutputStream&lt;/code&gt; should provide a more efficient
</span><span style=color:#8f5902;font-style:italic>     * implementation of this method.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#write(int)
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Flushes this output stream and forces any buffered output bytes
</span><span style=color:#8f5902;font-style:italic>     * to be written out to the stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;flush&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls the &lt;code&gt;flush&lt;/code&gt; method of its underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#out
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Closes this output stream and releases any system resources
</span><span style=color:#8f5902;font-style:italic>     * associated with the stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;close&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls its &lt;code&gt;flush&lt;/code&gt; method, and then calls the
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;close&lt;/code&gt; method of its underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#flush()
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#out
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;try&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>ostream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bytearrayoutputstream>ByteArrayOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * This class implements an output stream in which the data is
</span><span style=color:#8f5902;font-style:italic> * written into a byte array. The buffer automatically grows as data
</span><span style=color:#8f5902;font-style:italic> * is written to it.
</span><span style=color:#8f5902;font-style:italic> * The data can be retrieved using &lt;code&gt;toByteArray()&lt;/code&gt; and
</span><span style=color:#8f5902;font-style:italic> * &lt;code&gt;toString()&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic> * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic> * Closing a &lt;tt&gt;ByteArrayOutputStream&lt;/tt&gt; has no effect. The methods in
</span><span style=color:#8f5902;font-style:italic> * this class can be called after the stream has been closed without
</span><span style=color:#8f5902;font-style:italic> * generating an &lt;tt&gt;IOException&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  Arthur van Hoff
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ByteArrayOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>OutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The buffer where data is stored.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The number of valid bytes in the buffer.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new byte array output stream. The buffer capacity is
</span><span style=color:#8f5902;font-style:italic>     * initially 32 bytes, though its size increases if necessary.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayOutputStream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>32</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new byte array output stream, with a buffer capacity of
</span><span style=color:#8f5902;font-style:italic>     * the specified size, in bytes.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   size   the initial size.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IllegalArgumentException if size is negative.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Negative initial size: &#34;</span>
                                               <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Increases the capacity if necessary to ensure that it can hold
</span><span style=color:#8f5902;font-style:italic>     * at least the number of elements specified by the minimum
</span><span style=color:#8f5902;font-style:italic>     * capacity argument.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param minCapacity the desired minimum capacity
</span><span style=color:#8f5902;font-style:italic>     * @throws OutOfMemoryError if {@code minCapacity &lt; 0}.  This is
</span><span style=color:#8f5902;font-style:italic>     * interpreted as a request for the unsatisfiably large capacity
</span><span style=color:#8f5902;font-style:italic>     * {@code (long) Integer.MAX_VALUE + (minCapacity - Integer.MAX_VALUE)}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensureCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// overflow-conscious code
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The maximum size of array to allocate.
</span><span style=color:#8f5902;font-style:italic>     * Some VMs reserve some header words in an array.
</span><span style=color:#8f5902;font-style:italic>     * Attempts to allocate larger arrays may result in
</span><span style=color:#8f5902;font-style:italic>     * OutOfMemoryError: Requested array size exceeds VM limit
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAX_ARRAY_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Increases the capacity to ensure that it can hold at least the
</span><span style=color:#8f5902;font-style:italic>     * number of elements specified by the minimum capacity argument.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param minCapacity the desired minimum capacity
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// overflow-conscious code
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>MAX_ARRAY_SIZE</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hugeCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hugeCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// overflow
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OutOfMemoryError</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
            <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span> <span style=color:#ce5c00;font-weight:700>:</span>
            <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified byte to this byte array output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   b   the byte to be written.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ensureCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified byte array
</span><span style=color:#8f5902;font-style:italic>     * starting at offset &lt;code&gt;off&lt;/code&gt; to this byte array output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param   off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param   len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>ensureCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the complete contents of this byte array output stream to
</span><span style=color:#8f5902;font-style:italic>     * the specified output stream argument, as if by calling the output
</span><span style=color:#8f5902;font-style:italic>     * stream&#39;s write method using &lt;code&gt;out.write(buf, 0, count)&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      out   the output stream to which to write the data.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writeTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Resets the &lt;code&gt;count&lt;/code&gt; field of this byte array output
</span><span style=color:#8f5902;font-style:italic>     * stream to zero, so that all currently accumulated output in the
</span><span style=color:#8f5902;font-style:italic>     * output stream is discarded. The output stream can be used again,
</span><span style=color:#8f5902;font-style:italic>     * reusing the already allocated buffer space.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.ByteArrayInputStream#count
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a newly allocated byte array. Its size is the current
</span><span style=color:#8f5902;font-style:italic>     * size of this output stream and the valid contents of the buffer
</span><span style=color:#8f5902;font-style:italic>     * have been copied into it.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return  the current contents of this output stream, as a byte array.
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.ByteArrayOutputStream#size()
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>toByteArray</span><span style=color:#ce5c00;font-weight:700>()[]</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Returns the current size of the buffer.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return  the value of the &lt;code&gt;count&lt;/code&gt; field, which is the number
</span><span style=color:#8f5902;font-style:italic>     *          of valid bytes in this output stream.
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.ByteArrayOutputStream#count
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Converts the buffer&#39;s contents into a string decoding bytes using the
</span><span style=color:#8f5902;font-style:italic>     * platform&#39;s default character set. The length of the new &lt;tt&gt;String&lt;/tt&gt;
</span><span style=color:#8f5902;font-style:italic>     * is a function of the character set, and hence may not be equal to the
</span><span style=color:#8f5902;font-style:italic>     * size of the buffer.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt; This method always replaces malformed-input and unmappable-character
</span><span style=color:#8f5902;font-style:italic>     * sequences with the default replacement string for the platform&#39;s
</span><span style=color:#8f5902;font-style:italic>     * default character set. The {@linkplain java.nio.charset.CharsetDecoder}
</span><span style=color:#8f5902;font-style:italic>     * class should be used when more control over the decoding process is
</span><span style=color:#8f5902;font-style:italic>     * required.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return String decoded from the buffer&#39;s contents.
</span><span style=color:#8f5902;font-style:italic>     * @since  JDK1.1
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Converts the buffer&#39;s contents into a string by decoding the bytes using
</span><span style=color:#8f5902;font-style:italic>     * the named {@link java.nio.charset.Charset charset}. The length of the new
</span><span style=color:#8f5902;font-style:italic>     * &lt;tt&gt;String&lt;/tt&gt; is a function of the charset, and hence may not be equal
</span><span style=color:#8f5902;font-style:italic>     * to the length of the byte array.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt; This method always replaces malformed-input and unmappable-character
</span><span style=color:#8f5902;font-style:italic>     * sequences with this charset&#39;s default replacement string. The {@link
</span><span style=color:#8f5902;font-style:italic>     * java.nio.charset.CharsetDecoder} class should be used when more control
</span><span style=color:#8f5902;font-style:italic>     * over the decoding process is required.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      charsetName  the name of a supported
</span><span style=color:#8f5902;font-style:italic>     *             {@link java.nio.charset.Charset charset}
</span><span style=color:#8f5902;font-style:italic>     * @return     String decoded from the buffer&#39;s contents.
</span><span style=color:#8f5902;font-style:italic>     * @exception  UnsupportedEncodingException
</span><span style=color:#8f5902;font-style:italic>     *             If the named charset is not supported
</span><span style=color:#8f5902;font-style:italic>     * @since      JDK1.1
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>charsetName</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>UnsupportedEncodingException</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>charsetName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a newly allocated string. Its size is the current size of
</span><span style=color:#8f5902;font-style:italic>     * the output stream and the valid contents of the buffer have been
</span><span style=color:#8f5902;font-style:italic>     * copied into it. Each character &lt;i&gt;c&lt;/i&gt; in the resulting string is
</span><span style=color:#8f5902;font-style:italic>     * constructed from the corresponding element &lt;i&gt;b&lt;/i&gt; in the byte
</span><span style=color:#8f5902;font-style:italic>     * array such that:
</span><span style=color:#8f5902;font-style:italic>     * &lt;blockquote&gt;&lt;pre&gt;
</span><span style=color:#8f5902;font-style:italic>     *     c == (char)(((hibyte &amp;amp; 0xff) &amp;lt;&amp;lt; 8) | (b &amp;amp; 0xff))
</span><span style=color:#8f5902;font-style:italic>     * &lt;/pre&gt;&lt;/blockquote&gt;
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @deprecated This method does not properly convert bytes into characters.
</span><span style=color:#8f5902;font-style:italic>     * As of JDK&amp;nbsp;1.1, the preferred way to do this is via the
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;toString(String enc)&lt;/code&gt; method, which takes an encoding-name
</span><span style=color:#8f5902;font-style:italic>     * argument, or the &lt;code&gt;toString()&lt;/code&gt; method, which uses the
</span><span style=color:#8f5902;font-style:italic>     * platform&#39;s default character encoding.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      hibyte    the high byte of each resulting Unicode character.
</span><span style=color:#8f5902;font-style:italic>     * @return     the current contents of the output stream, as a string.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.ByteArrayOutputStream#size()
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.ByteArrayOutputStream#toString(String)
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.ByteArrayOutputStream#toString()
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#5c35cc;font-weight:700>@Deprecated</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hibyte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hibyte</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Closing a &lt;tt&gt;ByteArrayOutputStream&lt;/tt&gt; has no effect. The methods in
</span><span style=color:#8f5902;font-style:italic>     * this class can be called after the stream has been closed without
</span><span style=color:#8f5902;font-style:italic>     * generating an &lt;tt&gt;IOException&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bufferedoutputstream>BufferedOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * The class implements a buffered output stream. By setting up such
</span><span style=color:#8f5902;font-style:italic> * an output stream, an application can write bytes to the underlying
</span><span style=color:#8f5902;font-style:italic> * output stream without necessarily causing a call to the underlying
</span><span style=color:#8f5902;font-style:italic> * system for each byte written.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  Arthur van Hoff
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BufferedOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FilterOutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The internal buffer where data is stored.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The number of valid bytes in the buffer. This value is always
</span><span style=color:#8f5902;font-style:italic>     * in the range &lt;tt&gt;0&lt;/tt&gt; through &lt;tt&gt;buf.length&lt;/tt&gt;; elements
</span><span style=color:#8f5902;font-style:italic>     * &lt;tt&gt;buf[0]&lt;/tt&gt; through &lt;tt&gt;buf[count-1]&lt;/tt&gt; contain valid
</span><span style=color:#8f5902;font-style:italic>     * byte data.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new buffered output stream to write data to the
</span><span style=color:#8f5902;font-style:italic>     * specified underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   out   the underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>8192</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new buffered output stream to write data to the
</span><span style=color:#8f5902;font-style:italic>     * specified underlying output stream with the specified buffer
</span><span style=color:#8f5902;font-style:italic>     * size.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   out    the underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     * @param   size   the buffer size.
</span><span style=color:#8f5902;font-style:italic>     * @exception IllegalArgumentException if size &amp;lt;= 0.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buffer size &lt;= 0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/** Flush the internal buffer */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified byte to this buffered output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the byte to be written.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified byte array
</span><span style=color:#8f5902;font-style:italic>     * starting at offset &lt;code&gt;off&lt;/code&gt; to this buffered output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt; Ordinarily this method stores bytes from the given array into this
</span><span style=color:#8f5902;font-style:italic>     * stream&#39;s buffer, flushing the buffer to the underlying output stream as
</span><span style=color:#8f5902;font-style:italic>     * needed.  If the requested length is at least as large as this stream&#39;s
</span><span style=color:#8f5902;font-style:italic>     * buffer, however, then this method will flush the buffer and write the
</span><span style=color:#8f5902;font-style:italic>     * bytes directly to the underlying output stream.  Thus redundant
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;BufferedOutputStream&lt;/code&gt;s will not copy data unnecessarily.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/* If the request length exceeds the size of the output buffer,
</span><span style=color:#8f5902;font-style:italic>               flush the output buffer and then write the data directly.
</span><span style=color:#8f5902;font-style:italic>               In this way buffered streams will cascade harmlessly. */</span>
            <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Flushes this buffered output stream. This forces any buffered
</span><span style=color:#8f5902;font-style:italic>     * output bytes to be written out to the underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#out
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=pipedoutputstream>PipedOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * A piped output stream can be connected to a piped input stream
</span><span style=color:#8f5902;font-style:italic> * to create a communications pipe. The piped output stream is the
</span><span style=color:#8f5902;font-style:italic> * sending end of the pipe. Typically, data is written to a
</span><span style=color:#8f5902;font-style:italic> * &lt;code&gt;PipedOutputStream&lt;/code&gt; object by one thread and data is
</span><span style=color:#8f5902;font-style:italic> * read from the connected &lt;code&gt;PipedInputStream&lt;/code&gt; by some
</span><span style=color:#8f5902;font-style:italic> * other thread. Attempting to use both objects from a single thread
</span><span style=color:#8f5902;font-style:italic> * is not recommended as it may deadlock the thread.
</span><span style=color:#8f5902;font-style:italic> * The pipe is said to be &lt;a name=BROKEN&gt; &lt;i&gt;broken&lt;/i&gt; &lt;/a&gt; if a
</span><span style=color:#8f5902;font-style:italic> * thread that was reading data bytes from the connected piped input
</span><span style=color:#8f5902;font-style:italic> * stream is no longer alive.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  James Gosling
</span><span style=color:#8f5902;font-style:italic> * @see     java.io.PipedInputStream
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PipedOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>OutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>/* REMIND: identification of the read and write sides needs to be
</span><span style=color:#8f5902;font-style:italic>           more sophisticated.  Either using thread groups (but what about
</span><span style=color:#8f5902;font-style:italic>           pipes within a thread?) or using finalization (but it may be a
</span><span style=color:#8f5902;font-style:italic>           long time until the next GC). */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PipedInputStream</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a piped output stream connected to the specified piped
</span><span style=color:#8f5902;font-style:italic>     * input stream. Data bytes written to this stream will then be
</span><span style=color:#8f5902;font-style:italic>     * available as input from &lt;code&gt;snk&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      snk   The piped input stream to connect to.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedInputStream</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a piped output stream that is not yet connected to a
</span><span style=color:#8f5902;font-style:italic>     * piped input stream. It must be connected to a piped input stream,
</span><span style=color:#8f5902;font-style:italic>     * either by the receiver or the sender, before being used.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.PipedInputStream#connect(java.io.PipedOutputStream)
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.PipedOutputStream#connect(java.io.PipedInputStream)
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedOutputStream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Connects this piped output stream to a receiver. If this object
</span><span style=color:#8f5902;font-style:italic>     * is already connected to some other piped input stream, an
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;IOException&lt;/code&gt; is thrown.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * If &lt;code&gt;snk&lt;/code&gt; is an unconnected piped input stream and
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;src&lt;/code&gt; is an unconnected piped output stream, they may
</span><span style=color:#8f5902;font-style:italic>     * be connected by either the call:
</span><span style=color:#8f5902;font-style:italic>     * &lt;blockquote&gt;&lt;pre&gt;
</span><span style=color:#8f5902;font-style:italic>     * src.connect(snk)&lt;/pre&gt;&lt;/blockquote&gt;
</span><span style=color:#8f5902;font-style:italic>     * or the call:
</span><span style=color:#8f5902;font-style:italic>     * &lt;blockquote&gt;&lt;pre&gt;
</span><span style=color:#8f5902;font-style:italic>     * snk.connect(src)&lt;/pre&gt;&lt;/blockquote&gt;
</span><span style=color:#8f5902;font-style:italic>     * The two calls have the same effect.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      snk   the piped input stream to connect to.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedInputStream</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>snk</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connected</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Already connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connected</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified &lt;code&gt;byte&lt;/code&gt; to the piped output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Implements the &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;OutputStream&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the &lt;code&gt;byte&lt;/code&gt; to be written.
</span><span style=color:#8f5902;font-style:italic>     * @exception IOException if the pipe is &lt;a href=#BROKEN&gt; broken&lt;/a&gt;,
</span><span style=color:#8f5902;font-style:italic>     *          {@link #connect(java.io.PipedInputStream) unconnected},
</span><span style=color:#8f5902;font-style:italic>     *          closed, or if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified byte array
</span><span style=color:#8f5902;font-style:italic>     * starting at offset &lt;code&gt;off&lt;/code&gt; to this piped output stream.
</span><span style=color:#8f5902;font-style:italic>     * This method blocks until all the bytes are written to the output
</span><span style=color:#8f5902;font-style:italic>     * stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     * @exception IOException if the pipe is &lt;a href=#BROKEN&gt; broken&lt;/a&gt;,
</span><span style=color:#8f5902;font-style:italic>     *          {@link #connect(java.io.PipedInputStream) unconnected},
</span><span style=color:#8f5902;font-style:italic>     *          closed, or if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
                   <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Flushes this output stream and forces any buffered output bytes
</span><span style=color:#8f5902;font-style:italic>     * to be written out.
</span><span style=color:#8f5902;font-style:italic>     * This will notify any readers that bytes are waiting in the pipe.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception IOException if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Closes this piped output stream and releases any system resources
</span><span style=color:#8f5902;font-style:italic>     * associated with this stream. This stream may no longer be used for
</span><span style=color:#8f5902;font-style:italic>     * writing bytes.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>receivedLast</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3711fc47d4bd344e88d2c026371a33d2>5 - CH05-常用操作.md</h1>
<h2 id=file>File</h2>
<p>递归地列出一个目录下所有文件:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>listAllFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>File</span> <span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exists</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFile</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>File</span> <span style=color:#000>file</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>listFiles</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>listAllFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=字节流>字节流</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>copyFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>FileInputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>FileOutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>20</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>];</span>

    <span style=color:#8f5902;font-style:italic>// read() 最多读取 buffer.length 个字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 返回的是实际读取的个数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 返回 -1 的时候表示读到 eof，即文件尾
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=逐行打印>逐行打印</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>readFileContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>filePath</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>FileReader</span> <span style=color:#000>fileReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filePath</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>BufferedReader</span> <span style=color:#000>bufferedReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileReader</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>String</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferedReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLine</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 装饰者模式使得 BufferedReader 组合了一个 Reader 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 在调用 BufferedReader 的 close() 方法时会去调用 Reader 的 close() 方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 因此只要一个 close() 调用即可
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bufferedReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=序列化>序列化</h2>
<h3 id=序列化--serializable--transient>序列化 & Serializable & transient</h3>
<p>序列化就是将一个对象转换成字节序列，方便存储和传输。</p>
<ul>
<li>序列化: ObjectOutputStream.writeObject()</li>
<li>反序列化: ObjectInputStream.readObject()</li>
</ul>
<p>不会对静态变量进行序列化，因为序列化只是保存对象的状态，静态变量属于类的状态。</p>
<h3 id=serializable><strong>Serializable</strong></h3>
<p>序列化的类需要实现 Serializable 接口，它只是一个标准，没有任何方法需要实现，但是如果不去实现它的话而进行序列化，会抛出异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>A</span> <span style=color:#000>a1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>objectFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file/a1&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ObjectOutputStream</span> <span style=color:#000>objectOutputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objectFile</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>objectOutputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>objectOutputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>ObjectInputStream</span> <span style=color:#000>objectInputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objectFile</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>A</span> <span style=color:#000>a2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>objectInputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>objectInputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;x = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;  &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;y = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=transient><strong>transient</strong></h3>
<p>transient 关键字可以使一些属性不会被序列化。</p>
<p>ArrayList 中存储数据的数组 elementData 是用 transient 修饰的，因为这个数组是动态扩展的，并不是所有的空间都被使用，因此就不需要所有的内容都被序列化。通过重写序列化和反序列化方法，使得可以只序列化数组中有内容的那部分数据。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=网络>网络</h2>
<h4 id=inetaddress>InetAddress</h4>
<p>没有公有的构造函数，只能通过静态方法来创建实例。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>InetAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>host</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>InetAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=url>URL</h4>
<p>可以直接从 URL 中读取字节流数据。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://www.baidu.com&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 字节流 */</span>
    <span style=color:#000>InputStream</span> <span style=color:#000>is</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openStream</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/* 字符流 */</span>
    <span style=color:#000>InputStreamReader</span> <span style=color:#000>isr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>is</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;utf-8&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 提供缓存功能 */</span>
    <span style=color:#000>BufferedReader</span> <span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isr</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>String</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>br</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLine</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>br</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=sockets>Sockets</h4>
<ul>
<li>ServerSocket: 服务器端类</li>
<li>Socket: 客户端类</li>
<li>服务器和客户端通过 InputStream 和 OutputStream 进行输入输出。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501214845.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=datagram>Datagram</h4>
<ul>
<li>DatagramSocket: 通信类</li>
<li>DatagramPacket: 数据包类</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dc8da535c70e975714d2f9e3a34111ac>6 - CH06-IO实现</h1>
<h2 id=概览>概览</h2>
<blockquote>
<p>说到 I/O，想必大家都不会陌生， I/O 英语全称：Input/Output，即<strong>输入/输出</strong>，通常<strong>指数据在内部存储器和外部存储器或其他周边设备之间的输入和输出</strong>。</p>
</blockquote>
<p>比如我们常用的 <strong>SD卡</strong>、<strong>U盘</strong>、<strong>移动硬盘</strong>等等存储文件的硬件设备，当我们将其插入电脑的 usb 硬件接口时，我们就可以从电脑中读取设备中的信息或者写入信息，这个过程就涉及到 I/O 的操作。</p>
<p>当然，涉及 I/O 的操作，不仅仅局限于硬件设备的读写，还要网络数据的传输，比如，我们在电脑上用浏览器搜索互联网上的信息，这个过程也涉及到 I/O 的操作。</p>
<p>无论是从磁盘中读写文件，还是在网络中传输数据，可以说 I/O 主要为处理<strong>人机交互</strong>、<strong>机与机交互</strong>中获取和交换信息提供的一套解决方案。</p>
<p>在 Java 的 IO 体系中，类将近有 80 个，位于<code>java.io</code>包下，感觉很复杂，但是这些类大致可以分成四组：</p>
<ul>
<li><strong>基于字节操作的 I/O 接口：InputStream 和 OutputStream</strong></li>
<li><strong>基于字符操作的 I/O 接口：Writer 和 Reader</strong></li>
<li><strong>基于磁盘操作的 I/O 接口：File</strong></li>
<li><strong>基于网络操作的 I/O 接口：Socket</strong></li>
</ul>
<p>前两组主要从<strong>传输数据的数据格式</strong>不同，进行分组；后两组主要从<strong>传输数据的方式</strong>不同，进行分组。</p>
<p>虽然 Socket 类并不在<code> java.io</code>包下，但是我们仍然把它们划分在一起，因为 I/O 的核心问题，要么是数据格式影响 I/O 操作，要么是传输方式影响 I/O 操作，<strong>也就是将什么样的数据写到什么地方的问题</strong>，I/O 只是人与机器或者机器与机器交互的手段，除了在它们能够完成这个交互功能外，我们关注的就是如何提高它的运行效率了，而<strong>数据格式</strong>和<strong>传输方式</strong>是影响效率最关键的因素。</p>
<h2 id=字节格式>字节格式</h2>
<p>基于字节的输入和输出操作接口分别是：InputStream 和 OutputStream 。</p>
<h3 id=字节输入流>字节输入流</h3>
<p>InputStream 输入流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130438.png style=display:block;width:50% alt=NAME align=center> </div>
<p>输入流根据数据节点类型和处理方式，分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130515.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=字节输出流>字节输出流</h4>
<p>OutputStream 输出流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130542.png style=display:block;width:50% alt=NAME align=center> </div>
<p>输出流根据数据节点类型和处理方式，也分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130602.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在这里就不详细的介绍各个子类的使用方法，有兴趣的朋友可以查看 JDK 的 API 说明文档，笔者也会在后期的文章会进行详细的介绍，这里只是重点想说一下，<strong>无论是输入还是输出，操作数据的方式可以组合使用，各个处理流的类并不是只操作固定的节点流</strong>，比如如下输出方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//将文件输出流包装到序列化输出流中，再将序列化输出流包装到缓冲中 OutputStream out = new BufferedOutputStream(new ObjectOutputStream(new FileOutputStream(new File(&#34;fileName&#34;)))； 
</span></code></pre></div><p>另外，<strong>输出流最终写到什么地方必须要指定</strong>，要么是写到硬盘中，要么是写到网络中，从图中可以发现，写网络实际上也是写文件，只不过写到网络中，需要经过底层操作系统将数据发送到其他的计算机中，而不是写入到本地硬盘中。</p>
<h2 id=字符格式>字符格式</h2>
<p><strong>不管是磁盘还是网络传输，最小的存储单元都是字节，而不是字符</strong>，所以 I/O 操作的都是字节而不是字符，但是为什么要有操作字符的 I/O 接口呢？</p>
<p>这是因为我们的程序中通常操作的数据都是以字符形式，<strong>为了程序操作更方便而提供一个直接写字符的 I/O 接口，仅此而已。</strong></p>
<p>基于字符的输入和输出操作接口分别是：Reader 和 Writer ，下图是字符的 I/O 操作接口涉及到的类结构图。</p>
<h4 id=字符输入流>字符输入流</h4>
<p>Reader 输入流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130732.png style=display:block;width:50% alt=NAME align=center> </div>
<p>同样的，输入流根据数据节点类型和处理方式，分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130744.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=字符输出流>字符输出流</h4>
<p>Writer 输出流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130808.png style=display:block;width:50% alt=NAME align=center> </div>
<p>同样的，输出流根据数据节点类型和处理方式分类，分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130821.png style=display:block;width:50% alt=NAME align=center> </div>
<p>不管是 Reader 还是 Writer 类，它们都只定义了读取或写入数据字符的方式，也就是说要么是读要么是写，但是并没有规定数据要写到哪去，写到哪去就是我们后面要讨论的基于磁盘或网络的工作机制。</p>
<h3 id=字节与字符的转化>字节与字符的转化</h3>
<p>刚刚我们说到，不管是磁盘还是网络传输，最小的存储单元都是字节，而不是字符，设计字符的原因是为了程序操作更方便，那么怎么将字符转化成字节或者将字节转化成字符呢？</p>
<p><strong>InputStreamReader 和 OutputStreamWriter 就是转化桥梁。</strong></p>
<h4 id=输入流转化过程>输入流转化过程</h4>
<p>输入流字符解码相关类结构的转化过程如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/1786534ce9b3483cb9a5914ef4a227f9.jpg style=display:block;width:50% alt=NAME align=center> </div>
<p>从图上可以看到，InputStreamReader 类是字节到字符的转化桥梁， 其中<code>StreamDecoder</code>指的是一个<strong>解码</strong>操作类，<code>Charset</code>指的是字符集。</p>
<p>InputStream 到 Reader 的过程需要指定编码字符集，否则将采用操作系统默认字符集，很可能会出现乱码问题，StreamDecoder 则是完成字节到字符的解码的实现类。</p>
<p>打开源码部分，<strong>InputStream 到 Reader 转化过程</strong>，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131002.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=输出流转化过程>输出流转化过程</h4>
<p>输出流转化过程也是类似，如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131023.png style=display:block;width:50% alt=NAME align=center> </div>
<p>通过 OutputStreamWriter 类完成字符到字节的编码过程，由 <code>StreamEncoder</code> 完成<strong>编码</strong>过程。</p>
<p>源码部分，<strong>Writer 到 OutputStream 转化过程</strong>，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131039.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=磁盘传输>磁盘传输</h2>
<p>前面介绍了Java I/O 的操作接口，这些接口主要定义了如何操作数据，以及介绍了操作数据格式的方式：字节流和字符流。</p>
<p><strong>还有一个关键问题就是数据写到何处，其中一个主要的处理方式就是将数据持久化到物理磁盘。</strong></p>
<p>我们知道数据在磁盘的唯一最小描述就是文件，也就是说上层应用程序只能通过文件来操作磁盘上的数据，文件也是操作系统和磁盘驱动器交互的一个最小单元。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131240.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li><strong>在 Java I/O 体系中，File 类是唯一代表磁盘文件本身的对象</strong>。</li>
<li>File 类定义了一些与平台无关的方法来操作文件，包括检查一个<strong>文件是否存在、创建、删除文件、重命名文件、判断文件的读写权限是否存在、设置和查询文件的最近修改时间</strong>等等操作。</li>
</ul>
<p>值得注意的是 Java 中通常的 File 并不代表一个真实存在的文件对象，当你通过指定一个路径描述符时，它就会返回一个代表这个路径相关联的一个<strong>虚拟对象</strong>，这个可能是一个真实存在的文件或者是一个包含多个文件的目录。</p>
<p>例如，读取一个文件内容，程序如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131318.png style=display:block;width:50% alt=NAME align=center> </div>
<p>以上面的程序为例，从硬盘中读取一段文本字符，操作流程如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131340.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当我们传入一个指定的文件名来创建 File 对象，通过 FileReader 来读取文件内容时，会自动创建一个<code>FileInputStream</code>对象来读取文件内容，也就是我们上文中所说的字节流来读取文件。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131455.png style=display:block;width:50% alt=NAME align=center> </div>
<p>紧接着，会创建一个<code>FileDescriptor</code>的对象，其实这个对象就是真正代表一个存在的文件对象的描述。可以通过<code>FileInputStream</code>对象调用<code>getFD() </code>方法获取真正与底层操作系统关联的文件描述。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131526.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由于我们需要读取的是字符格式，所以需要 <code>StreamDecoder</code> 类将<code>byte</code>解码为<code>char</code>格式，至于如何从磁盘驱动器上读取一段数据，由操作系统帮我们完成。</p>
<h2 id=网络传输>网络传输</h2>
<p>继续来说说数据写到何处的另一种处理方式：<strong>将数据写入互联网中以供其他电脑能访问</strong>。</p>
<h3 id=socket简介>Socket简介</h3>
<p>在现实中，Socket 这个概念没有一个具体的实体，它是描述计算机之间完成相互通信一种抽象定义。</p>
<p>打个比方，可以把 Socket 比作为两个城市之间的交通工具，有了它，就可以在城市之间来回穿梭了。并且，交通工具有多种，每种交通工具也有相应的交通规则。Socket 也一样，也有多种。大部分情况下我们使用的都是基于 TCP/IP 的流套接字，它是一种稳定的通信协议。</p>
<p>典型的基于 Socket 通信的应用程序场景，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132350.png style=display:block;width:50% alt=NAME align=center> </div>
<p>主机 A 的应用程序要想和主机 B 的应用程序通信，必须通过 Socket 建立连接，而建立 Socket 连接必须需要底层 TCP/IP 协议来建立 TCP 连接。</p>
<h3 id=建立通信链路>建立通信链路</h3>
<p>我们知道网络层使用的 IP 协议可以帮助我们根据 IP 地址来找到目标主机，但是一台主机上可能运行着多个应用程序，如何才能与指定的应用程序通信就要通过 TCP 或 UPD 的地址也就是端口号来指定。这样就可以通过一个 Socket 实例代表唯一一个主机上的一个应用程序的通信链路了。</p>
<p>为了准确无误地把数据送达目标处，<strong>TCP 协议采用了三次握手策略</strong>，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132449.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>
<p>SYN 全称为 Synchronize Sequence Numbers，<strong>表示同步序列编号</strong>，是 TCP/IP 建立连接时使用的握手信号。</p>
</li>
<li>
<p>ACK 全称为 Acknowledge character，即确认字符，<strong>表示发来的数据已确认接收无误</strong>。</p>
</li>
</ul>
<p>在客户机和服务器之间建立正常的 TCP 网络连接时，客户机首先发出一个 <strong>SYN 消息</strong>，服务器使用 <strong>SYN + ACK</strong> 应答表示接收到了这个消息，最后客户机再以 <strong>ACK</strong> 消息响应。</p>
<p>这样在客户机和服务器之间才能建立起可靠的 TCP 连接，数据才可以在客户机和服务器之间传递。</p>
<ul>
<li>发送端 –（发送带有 SYN 标志的数据包 ）–> 接受端（第一次握手）；</li>
<li>接受端 –（发送带有 SYN + ACK 标志的数据包）–> 发送端（第二次握手）；</li>
<li>发送端 –（发送带有 ACK 标志的数据包） –> 接受端（第三次握手）；</li>
</ul>
<p>完成三次握手之后，客户端应用程序与服务器应用程序就可以开始传送数据了。</p>
<h3 id=传输数据>传输数据</h3>
<p>当客户端要与服务端通信时，客户端首先要创建一个 Socket 实例，默认操作系统将为这个 Socket 实例分配一个没有被使用的本地端口号，并创建一个包含本地、远程地址和端口号的套接字数据结构，这个数据结构将一直保存在系统中直到这个连接关闭。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132616.png style=display:block;width:50% alt=NAME align=center> </div>
<p>与之对应的服务端，也将创建一个 ServerSocket 实例，ServerSocket 创建比较简单，只要指定的端口号没有被占用，一般实例创建都会成功，同时操作系统也会为 ServerSocket 实例创建一个底层数据结构，这个数据结构中包含指定监听的端口号和包含监听地址的通配符，通常情况下都是<code>*</code>即监听所有地址。</p>
<p>之后当调用 accept() 方法时，将进入阻塞(等待)状态，等待客户端的请求。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132704.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们先启动服务端程序，再运行客户端，服务端收到客户端发送的信息，服务端打印结果如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>服务端收到客户端发送的消息：Hello，我是客户端！
</code></pre></div><p>注意，客户端只有与服务端建立三次握手成功之后，才会发送数据，而 TCP/IP 握手过程，底层操作系统已经帮我们实现了！</p>
<ol>
<li>当连接已经建立成功，服务端和客户端都会拥有一个 Socket 实例，每个 Socket 实例都有一个 <strong>InputStream</strong> 和 <strong>OutputStream</strong>，正如我们前面所说的，网络 I/O 都是以字节流传输的，Socket 正是通过这两个对象来交换数据。</li>
<li>当 Socket 对象创建时，操作系统将会为 InputStream 和 OutputStream 分别分配一定大小的缓冲区，数据的写入和读取都是通过这个缓存区完成的。</li>
<li>写入端将数据写到 OutputStream 对应的 SendQ 队列中，当队列填满时，数据将被发送到另一端 InputStream 的 RecvQ 队列中，如果这时 RecvQ 已经满了，那么 OutputStream 的 write 方法将会阻塞直到 RecvQ 队列有足够的空间容纳 SendQ 发送的数据。</li>
</ol>
<p>值得特别注意的是，缓存区的大小以及写入端的速度和读取端的速度非常影响这个连接的数据传输效率，由于可能会发生阻塞，所以网络 I/O 与磁盘 I/O 在数据的写入和读取还要有一个协调的过程，如果两边同时传送数据时可能会产生死锁的问题。</p>
<p><strong>如何提高网络 IO 传输效率、保证数据传输的可靠，已经成了工程师们急需解决的问题。</strong></p>
<h3 id=io-工作方式>IO 工作方式</h3>
<p>在计算机中，IO 传输数据有三种工作方式，分别是 <strong>BIO、NIO、AIO</strong>。</p>
<p>在讲解 <strong>BIO、NIO、AIO</strong> 之前，我们先来回顾一下这几个概念：<strong>同步与异步，阻塞与非阻塞</strong>。</p>
<p><strong>同步与异步的区别</strong></p>
<ul>
<li>同步就是发起一个请求后，接受者未处理完请求之前，不返回结果。</li>
<li>异步就是发起一个请求后，立刻得到接受者的回应表示已接收到请求，但是接受者并没有处理完，接受者通常依靠事件回调等机制来通知请求者其处理结果。</li>
</ul>
<p><strong>阻塞和非阻塞的区别</strong></p>
<ul>
<li>阻塞就是请求者发起一个请求，一直等待其请求结果返回，也就是当前线程会被挂起，无法从事其他任务，只有当条件就绪才能继续。</li>
<li>非阻塞就是请求者发起一个请求，不用一直等着结果返回，可以先去干其他事情，当条件就绪的时候，就自动回来。</li>
</ul>
<p>而我们要讲的 <strong>BIO、NIO、AIO</strong> 就是<strong>同步与异步、阻塞与非阻塞</strong>的组合。</p>
<ul>
<li>BIO：同步阻塞 IO；</li>
<li>NIO：同步非阻塞 IO；</li>
<li>AIO：异步非阻塞 IO;</li>
</ul>
<h3 id=bio>BIO</h3>
<p>BIO 俗称同步阻塞 IO，一种非常传统的 IO 模型，比如我们上面所举的那个程序例子，就是一个典型的**同步阻塞 IO **的工作方式。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133132.png style=display:block;width:50% alt=NAME align=center> </div>
<p>采用 BIO 通信模型的服务端，通常由一个独立的 <strong>Acceptor</strong> 线程负责监听客户端的连接。</p>
<p>我们一般在服务端通过<code>while(true)</code>循环中会调用<code>accept() </code>方法等待监听客户端的连接，一旦接收到一个连接请求，就可以建立通信套接字进行读写操作，此时不能再接收其他客户端连接请求，只能等待同当前连接的客户端的操作执行完成， 不过可以通过多线程来支持多个客户端的连接。</p>
<p><strong>客户端多线程操作，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133226.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端多线程操作，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133258.png style=display:block;width:50% alt=NAME align=center> </div>
<p>服务端运行结果，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>服务端收到客户端发送的消息：Hello，我是第 2 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 4 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 3 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 0 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 1 个，客户端！
</code></pre></div><p>如果要让 BIO 通信模型能够同时处理多个客户端请求，就必须使用多线程，也就是说它在接收到客户端连接请求之后为每个客户端创建一个新的线程进行链路处理，处理完成之后，通过输出流返回应答给客户端，线程销毁。</p>
<p>这就是典型的<strong>一请求一应答</strong>通信模型 。</p>
<p>如果出现100、1000、甚至10000个用户同时访问服务器，这个时候，如果使用这种模型，那么服务端也会创建与之相同的线程数量，<strong>线程数急剧膨胀可能会导致线程堆栈溢出、创建新线程失败等问题，最终导致进程宕机或者僵死，不能对外提供服务</strong>。</p>
<p>当然，我们可以通过使用 Java 中 ThreadPoolExecutor 线程池机制来改善，让线程的创建和回收成本相对较低，保证了系统有限的资源的控制，<strong>实现了 N （客户端请求数量）大于 M （处理客户端请求的线程数量）的伪异步 I/O 模型。</strong></p>
<h3 id=伪异步-bio>伪异步 BIO</h3>
<p>为了解决同步阻塞 I/O 面临的一个链路需要一个线程处理的问题，后来有人对它的线程模型进行了优化，后端通过一个线程池来处理多个客户端的请求接入，形成客户端个数 M：线程池最大线程数 N 的比例关系，其中 M 可以远远大于 N，通过线程池可以灵活地调配线程资源，设置线程的最大值，防止由于海量并发接入导致资源耗尽。</p>
<p>伪异步IO模型图，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133620.png style=display:block;width:50% alt=NAME align=center> </div>
<p>采用线程池和任务队列可以实现一种叫做伪异步的 I/O 通信框架，当有新的客户端接入时，将客户端的 Socket 封装成一个 Task 投递到后端的线程池中进行处理。</p>
<p>Java 的线程池维护一个消息队列和 N 个活跃线程，对消息队列中的任务进行处理。</p>
<p><strong>客户端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133717.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133731.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>先启动服务端程序，再启动客户端程序，看看运行结果！</strong></p>
<p><strong>服务端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133834.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>客户端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133853.png style=display:block;width:50% alt=NAME align=center> </div>
<p>本例中测试的客户端数量是 30，服务端使用 java 线程池来处理任务，线程数量为 5 个，服务端不用为每个客户端都创建一个线程，由于线程池可以设置消息队列的大小和最大线程数，因此，它的资源占用是可控的，无论多少个客户端并发访问，都不会导致资源的耗尽和宕机。</p>
<p>在活动连接数不是特别高的情况下，这种模型是还不错，可以让每一个连接专注于自己的 I/O 并且编程模型简单，也不用过多考虑系统的过载、限流等问题。</p>
<p>但是，它的底层仍然是同步阻塞的 BIO 模型，当面对十万甚至百万级连接的时候，传统的 BIO 模型真的是无能为力的，我们需要一种更高效的 I/O 处理模型来应对更高的并发量。</p>
<h3 id=nio>NIO</h3>
<ul>
<li>
<p>NIO 中的 N 可以理解为 <strong>Non-blocking</strong>，一种同步非阻塞的 I/O 模型，在 Java 1.4 中引入，对应的在<code>java.nio</code>包下。</p>
</li>
<li>
<p>NIO 新增了 <strong>Channel、Selector、Buffer</strong> 等抽象概念，支持面向缓冲、基于通道的 I/O 操作方法。</p>
</li>
<li>
<p>NIO 提供了与传统 BIO 模型中的 <code>Socket</code> 和 <code>ServerSocket</code> 相对应的 <code>SocketChannel</code> 和 <code>ServerSocketChannel</code> 两种不同的套接字通道实现。</p>
</li>
<li>
<p>NIO 这两种通道都支持<strong>阻塞和非阻塞</strong>两种模式。阻塞模式使用就像传统中的支持一样，比较简单，但是性能和可靠性都不好；<strong>非阻塞模式正好与之相反</strong>。</p>
</li>
<li>
<p>对于低负载、低并发的应用程序，可以使用同步阻塞 I/O 来提升开发效率和更好的维护性；</p>
</li>
<li>
<p>对于高负载、高并发的（<strong>网络</strong>）应用，应使用 NIO 的非阻塞模式来开发。</p>
</li>
</ul>
<p>我们先看一下 NIO 涉及到的核心关联类图，如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134125.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图中有三个关键类：<strong>Channel 、Selector 和 Buffer</strong>，它们是 NIO 中的核心概念。</p>
<ul>
<li><strong>Channel：可以理解为通道；</strong></li>
<li><strong>Selector：可以理解为选择器；</strong></li>
<li><strong>Buffer：可以理解为数据缓冲流；</strong></li>
</ul>
<p>我们还是用前面的城市交通工具来继续形容 NIO 的工作方式，这里的 <strong>Channel</strong> 要比 <strong>Socket</strong> 更加具体，它可以比作为某种具体的交通工具，如汽车或是高铁、飞机等，而 <strong>Selector</strong> 可以比作为一个车站的车辆运行调度系统，它将负责监控每辆车的当前运行状态：是已经出站还是在路上等等，也就是说它可以轮询每个 <strong>Channel</strong> 的状态。</p>
<p>还有一个 <strong>Buffer</strong> 类，你可以将它看作为 IO 中 <strong>Stream</strong>，但是它比 IO 中的 <strong>Stream</strong> 更加具体化，我们可以将它比作为车上的座位，<strong>Channel</strong> 如果是汽车的话，那么 <strong>Buffer</strong> 就是汽车上的座位，<strong>Channel</strong> 如果是高铁，那么 <strong>Buffer</strong> 就是高铁上的座位，它始终是一个具体的概念，这一点与 <strong>Stream</strong> 不同。</p>
<p><strong>Socket 中的 Stream</strong> 只能代表是一个座位，至于是什么座位由你自己去想象，也就是说你在上车之前并不知道这个车上是否还有没有座位，也不知道上的是什么车，因为你并不能选择，这些信息都已经被封装在了运输工具（<strong>Socket</strong>）里面了。</p>
<p>NIO 引入了 <strong>Channel、Buffer 和 Selector</strong> 就是想把 IO 传输过程中涉及到的<strong>信息具体化</strong>，让程序员有机会去控制它们。</p>
<p>当我们进行传统的网络 IO 操作时，比如调用 write() 往 Socket 中的 SendQ 队列写数据时，当一次写的数据超过 SendQ 长度时，操作系统会按照 SendQ 的长度进行分割的，这个过程中需要将用户空间数据和内核地址空间进行切换，而这个切换不是程序员可以控制的，由底层操作系统来帮我们处理。</p>
<p>而在 Buffer 中，我们可以控制 Buffer 的 capacity（容量），并且是否扩容以及如何扩容都可以控制。</p>
<p>还是以上面的操作为例子，为了方便观看结果，本次的客户端线程请求数改成15个。</p>
<p><strong>客户端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134512.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134546.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>先启动服务端程序，再启动客户端程序，看看运行结果！</strong></p>
<p><strong>服务端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134718.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>客户端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134732.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>当然，客户端也不仅仅只限制于 IO 的写法，还可以使用<code>SocketChannel </code>来操作客户端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134752.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>从操作上可以看到，NIO 的操作比传统的 IO 操作要复杂的多！</strong></p>
<p><strong>Selector</strong> 被称为<strong>选择器</strong> ，当然你也可以翻译为<strong>多路复用器</strong> 。它是Java NIO 核心组件中的一个，用于检查一个或多个 <strong>Channel</strong>（通道）的状态是否处于<strong>连接就绪</strong>、<strong>接受就绪</strong>、<strong>可读就绪</strong>、<strong>可写就绪</strong>。</p>
<p>如此可以实现单线程管理多个 <strong>channels</strong>，也就是可以管理多个网络连接。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134831.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>使用 Selector 的好处在于：</strong> 相比传统方式使用多个线程来管理 IO，Selector 使用了更少的线程就可以处理通道了，并且实现网络高效传输！</p>
<p>虽然 java 中的 nio 传输比较快，为什么大家都不愿意用 JDK 原生 NIO 进行开发呢？</p>
<p>从上面的代码中大家都可以看出来，除了编程复杂、编程模型难之外，还有几个让人诟病的问题：</p>
<ul>
<li><strong>JDK 的 NIO 底层由 epoll 实现，该实现饱受诟病的空轮询 bug 会导致 cpu 飙升 100%！</strong></li>
<li><strong>项目庞大之后，自行实现的 NIO 很容易出现各类 bug，维护成本较高！</strong></li>
</ul>
<p><strong>但是，Google 的 Netty 框架的出现，很大程度上改善了 JDK 原生 NIO 所存在的一些让人难以忍受的问题</strong>。</p>
<h3 id=aio>AIO</h3>
<p>最后就是 AIO 了，全称 Asynchronous I/O，可以理解为异步 IO，也被称为 NIO 2，在 Java 7 中引入了 NIO 的改进版 NIO 2，它是异步非阻塞的 IO 模型，也就是我们现在所说的 AIO。</p>
<p>异步 IO 是<strong>基于事件和回调机制</strong>实现的，也就是应用操作之后会直接返回，不会堵塞在那里，当后台处理完成，操作系统会通知相应的线程进行后续的操作。</p>
<p><strong>客户端，程序示例：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502135052.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端，程序示例：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502135109.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这种组合方式用起来比较复杂，只有在一些非常复杂的分布式情况下使用，像集群之间的消息同步机制一般用这种 I/O 组合方式。如 Cassandra 的 Gossip 通信机制就是采用异步非阻塞的方式。</p>
<h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=http://www.justdojava.com/2019/12/18/java-io-1/>http://www.justdojava.com/2019/12/18/java-io-1/</a></li>
<li><a href=http://ifeve.com/java-io/>http://ifeve.com/java-io/</a></li>
<li><a href=http://ifeve.com/java-nio-all/>http://ifeve.com/java-nio-all/</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-312904add31ff8ea8730fec11cef07bc>7 - CH07-IO模型</h1>
<h2 id=用户空间与内核空间>用户空间与内核空间</h2>
<p>我们知道现在的操作系统都是采用虚拟存储器，那么对 32 位操作系统来说，它的寻址空间即虚拟存储空间为 4G，2 的 32 次方。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限。<strong>为了保证用户进程不能直接操作内核，保证内核的的安全，操作系统将虚拟内存空间划分为两部分，一部分是内核空间，一部分是用户空间。</strong></p>
<p>针对 Linux 操作系统而言，将最高的 1G 字节，即从虚拟地址 0xC0000000 到 0xFFFFFFFF 供内核使用，称为内核空间。而较低的 3G 字节，即从虚拟地址 0x00000000 到 0xBFFFFFFF，供进程使用，称为用户空间。每个进程都可以通过系统调用进入内核，因此 Linux 内核由系统内的所有进程共享。于是，<strong>从具体进程的角度看，每个进程可以拥有 4G 字节的虚拟空间</strong>。</p>
<p>有了用户空间和内核空间，整个 Linux 内部结构可以分为三个部分，从最底层到最上层依次是：<strong>硬件、内核空间、用户空间</strong>。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225144207.png style=display:block;width:50% alt=NAME align=center> </div>
<p>需要注意的细节是，从上图可以看出内核的组成：</p>
<ul>
<li>内核空间中存放的是内核代码和数据，而进程的用户空间存放的是用户程序的代码和数据。不管是内核空间还是用户空间，都处于虚拟空间之中。</li>
<li>Linux 使用两级保护机制：0 级供内核使用，3 级供用户程序使用。</li>
</ul>
<h2 id=服务端处理网络请求的流程>服务端处理网络请求的流程</h2>
<p>为了 OS 的安全性等考虑，进程是无法直接操作 IO 设备的，其<strong>必须通过系统调用来请求内核以协助完成 IO 动作，而内核会为每个 IO 设备维护一个 buffer</strong>。</p>
<p>整个请求过程为：</p>
<ol>
<li>用户进程发起请求；</li>
<li>内核接收到请求后；</li>
<li><strong>从 IO 设备中获取数据到 buffer 中</strong>；</li>
<li><strong>再将 buffer 中的数据 copy 到用户进程的地址空间</strong>；</li>
<li>该用户进程获取到数据后再响应客户端。</li>
</ol>
<p>服务端处理网络请求的典型流程图如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225151943.png style=display:block;width:80% alt=NAME align=center> </div>
<p>在请求过程中，数据从 IO 设备输入至 buffer 需要时间，从 buffer 复制将数据复制到用户进程也需要时间。因此<strong>根据在这两段时间内等待方式的不同，IO 动作可以分为以下五种</strong>：</p>
<ul>
<li>阻塞 IO，Blocking IO</li>
<li>非阻塞 IO，Non-Blocking IO</li>
<li>IO 复用，IO Multiplexing</li>
<li>信号驱动的 IO，Signal Driven IO</li>
<li>异步 IO，Asynchrnous IO</li>
</ul>
<blockquote>
<p>更多细节参考 &lt;Unix 网络编程>，6.2 节 “IO Models”。</p>
</blockquote>
<p>设计服务端并发模型时，主要有如下两个关键点：</p>
<ul>
<li>服务器如何管理连接，获取请求数据。</li>
<li>服务器如何处理请求。</li>
</ul>
<p>以上两个关键点最终都与操作系统的 I/O 模型以及线程(进程)模型相关，下面详细介绍这两个模型。</p>
<h2 id=阻塞非阻塞同步异步>阻塞/非阻塞、同步/异步</h2>
<h3 id=阻塞非阻塞><strong>阻塞/非阻塞</strong>：</h3>
<ul>
<li>阻塞调用是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才会返回。</li>
<li>非阻塞调用指在不能立刻得到结果之前，该调用不会阻塞当前线程。</li>
</ul>
<p>区别：</p>
<ul>
<li>两者的最大区别在于被调用方在收到请求到返回结果之前的这段时间内，调用方是否一直在等待。</li>
<li>阻塞是指调用方一直在等待而且别的事情什么都不做；非阻塞是指调用方先去忙别的事情。</li>
</ul>
<h3 id=同步异步><strong>同步/异步</strong>：</h3>
<ul>
<li>同步处理是指被调用方得到最终结果之后才返回给调用方；</li>
<li>异步处理是指被调用方先返回应答，然后再计算调用结果，计算完最终结果后再通知并返回给调用方。</li>
</ul>
<h3 id=区别与联系>区别与联系</h3>
<p><strong>阻塞、非阻塞和同步、异步其实针对的对象是不一样的</strong>：</p>
<ul>
<li>阻塞、非阻塞的讨论对象是调用者。</li>
<li>同步、异步的讨论对象是被调用者。</li>
</ul>
<h2 id=linux-网络-io-模型>Linux 网络 I/O 模型</h2>
<h3 id=recvfrom-函数>recvfrom 函数</h3>
<p>recvfrom 函数(经 Socket 接收数据)，这里把它视为系统调用。一个输入操作通常包括两个不同的阶段：</p>
<ul>
<li>等待数据准就绪。</li>
<li>从内核向应用进程复制数据。</li>
</ul>
<p>对于一个套接字上的输入操作，第一步通常涉及等待数据从网络中到达。当所等待分组到达时，它被复制到内核中的某个缓冲区。第二步就是把数据从内核缓冲区复制到应用进程缓冲区。</p>
<p>实际应用程序在通过系统调用完成上面的 2 步操作时，调用方式的阻塞、非阻塞，操作系统在处理应用程序请求时处理方式的同步、异步，可以分为 5 种 I/O 模型。</p>
<h3 id=阻塞式-io>阻塞式 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225202244.png style=display:block;width:80% alt=NAME align=center> </div>
<p>在阻塞式 IO 模型中，应用程序从调用 recvfrom 开始到它返回有数据报准备好这段时间是阻塞的，recvfrom 返回成功后，应用程序开始处理数据报。</p>
<ul>
<li>优点：程序实现简单，在阻塞等待数据期间，进程、线程挂起，基本不会占用 CPU 资源。</li>
<li>每个连接需要独立的进程、线程单独处理，当并发请求量大时为了维护程序，内存、线程切换开销很大，这种模型在实际生产中很少使用。</li>
</ul>
<h3 id=非阻塞-io>非阻塞 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225202544.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在非阻塞 IO 模型中，应用程序把一个套接口设置为非阻塞，就是告诉内核，当所有请求的 IO 操作无法完成时，不要将进程睡眠。</p>
<p>而是返回一个错误，应用程序基于 IO 操作函数，将会不断的轮询数据是否已经准备就绪，直到数据准备就绪。</p>
<ul>
<li>优点：不会阻塞在内核的等待数据过程，每次发起的 IO 请求可以立即返回，不会阻塞等待，实时性比较好。</li>
<li>缺点：轮询将会不断的询问内核，这将占用大量的 CPU 时间，系统资源利用率较低，所以一般 Web 服务器不会使用这种 IO 模型。</li>
</ul>
<h3 id=io-多路复用>IO 多路复用</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225202916.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在 IO 复用模型中，会用到 Select、Poll、Epoll 函数，这些函数会使进程阻塞，但是和阻塞 IO 有所不同。</p>
<p>这些函数可以同时阻塞多个 IO 操作，而且可以同时对多个读、写操作的 IO 函数进行检测，直到有数据可读或可写时，才会真正调用 IO 操作函数。</p>
<ul>
<li>优点：可以基于一个阻塞对象，同时在多个描述符上等待就绪，而不是使用多个线程(每个文件描述符一个线程)，这样可以大大节省系统资源。</li>
<li>当连接数较少时效率比“多线程+阻塞IO”的模式效率低，可能延迟更大，因为单个连接处理需要 2 次系统调用，占用时间会增加。</li>
</ul>
<h3 id=信号驱动-io>信号驱动 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225203258.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在信号驱动 IO 模型中，应用程序使用套接口进行信号驱动 IO，并安装一个信号处理函数，进程继续运行并不阻塞。</p>
<p>当数据准备好时，进程会收到一个 SIGIO 信号，可以在信号处理函数中调用 IO 操作函数处理数据。</p>
<ul>
<li>优点：线程没有在等待数据时被阻塞，可以提高资源利用率。</li>
<li>缺点：信号 IO 模式在大量 IO 操作时可能会因为信号队列溢出而导致无法通知。</li>
</ul>
<p>信号驱动 IO 尽管对于处理 UDP 套接字来说有用，即这种信号通知意味着到达了一个数据报，或者返回一个异步错误。</p>
<p>但是，对于 TCP 而言，信号驱动 IO 方式近乎无用。因为导致这种通知的条件为数众多，逐个进行判断会消耗很大的资源，与前几种方式相比优势尽失。</p>
<h3 id=异步-io>异步 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225203813.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由 POSIX 规范定义，应用程序告知内核启动某个操作，并让内核在整个操作完成后(包括将数据从内核拷贝到应用程序的缓冲区)通知应用程序。</p>
<p>这种模型与信号驱动模型的主要区别在于：信号驱动 IO 是由内核通知应用程序合适启动一个 IO 操作，而异步 IO 模型是由内核通知应用程序 IO 操作合适完成。</p>
<ul>
<li>优点：异步 IO 能够充分利用 DMA 特性，让 IO 操作与计算重叠。</li>
<li>缺点：需要实现真正的异步 IO，操作系统需要做大量的工作。当前 Windows 下通过 IOCP 实现了真正的异步 IO。</li>
</ul>
<p>而在 Linux 系统下直到 2.6 版本才引入，目前 AIO 并不完善，因此在 Linux 下实现并发网络编程时都是以 IO 复用模型为主。</p>
<h3 id=io-模型对比>IO 模型对比</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225204240.png style=display:block;width:50% alt=NAME align=center> </div>
<p>从上图可以看出，越往后，阻塞越少，理论上效率也最优。</p>
<p>这五种模型中，前四种属于同步 IO，因为其中真正的 IO 操作(recvfrom 函数调用)将阻塞进程/线程，只有异步 IO 模型才与 POSIX 定义的异步 IO 相匹配。</p>
<h2 id=进程线程模型>进程/线程模型</h2>
<p>介绍完服务器如何基于 IO 模型<strong>管理连接、获取输入数据</strong>，下面介绍服务器如何基于进程、线程模型来<strong>处理请求</strong>。</p>
<h3 id=传统阻塞-io-服务模型>传统阻塞 IO 服务模型</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225204551.png style=display:block;width:50% alt=NAME align=center> </div>
<p>特点：</p>
<ul>
<li>采用阻塞式 IO 模型获取输入数据。</li>
<li>每个连接都需要独立的线程完成数据输入的读取、业务处理、数据返回操作。</li>
</ul>
<p>存在问题：</p>
<ul>
<li>当请求的并发数较大时，需要创建大量线程来处理连接，系统资源占用较大。</li>
<li>当连接建立后，如果当前线程暂时没有数据可读，则线程就阻塞在 Read 操作上，造成线程资源浪费。</li>
</ul>
<h3 id=reactor-模式>Reactor 模式</h3>
<p>针对传统阻塞 IO 服务模型的 2 个缺点，比较常见的有如下解决方案：</p>
<ul>
<li><strong>基于 IO 复用模型</strong>，多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象上等待，无需阻塞等待所有连接。
<ul>
<li>当某条连接有新的数据可处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理。</li>
</ul>
</li>
<li><strong>基于线程池复用线程资源</strong>，不必再为每个连接创建线程，将连接完成后的业务处理任务分配给线程进行处理，一个线程可以多个连接的业务。</li>
</ul>
<p><strong>IO 复用模式结合线程池</strong>，就是 Reactor 模式的基本设计思想，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225205123.png style=display:block;width:50% alt=NAME align=center> </div>
<p>Reactor 模式，是指通过一个或多个输入同时传递给服务器来处理服务请求的事件驱动处理模式。</p>
<p>服务端程序处理传入的多路请求，并将它们同步分派给请求对应的处理线程，Reactor 模式也叫 Dispatcher 模式。</p>
<p>即 IO 多路复用以统一的方式监听事件，收到事件后分发(Dispatch 给某线程)，是编写高性能服务器的必备技术之一。</p>
<p>Reactor 模式有两个关键组件构成：</p>
<ul>
<li>Reactor：在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序对 IO 事件做出反应。它就像公司的电话接线员，接听来自客户的电话并将线路转移给适当的联系人。</li>
<li>Handlers：处理程序执行 IO 事件需要完成的实际组件，类似于客户想要与之交谈的客服坐席。Reactor 通过调度适当的处理程序来响应 IO 事件，处理程序执行非阻塞操作。</li>
</ul>
<p>根据 Reactor 的数量和处理资源池线程的数量不同，有 3 种典型的实现：</p>
<ul>
<li>单 Reactor 单线程</li>
<li>单 Reactor 多线程</li>
<li>主从 Reactor 多线程</li>
</ul>
<h4 id=单-reactor-单线程>单 Reactor 单线程</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225205947.png style=display:block;width:50% alt=NAME align=center> </div>
<p>其中，Select 是前面 IO 复用模型介绍的标准网络编程 API，可以实现应用程序通过一个阻塞多向监听多路连接请求，其他方案的示意图也类似。</p>
<p>方案说明：</p>
<ul>
<li>
<p>Reactor 对象通过 Select 监听客户端请求事件，收到事件后通过 Dispatch 进行分发。</p>
</li>
<li>
<p>如果是“建立连接”请求事件，则由 Acceptor 通过 Accept 处理连接请求，同时创建一个 Handler 对象来处理连接完成后的后续业务处理。</p>
</li>
<li>
<p>如果不是“建立连接”事件，则 Reactor 会分发调用“连接”对应的 Handler 来响应。</p>
</li>
<li>
<p>Handler 会完成 “Read->业务处理->Send” 的完整业务流程。</p>
</li>
<li>
<p>优点：模型简单，没有多线程、进程通信、竞争的问题，全部都在一个线程中完成。</p>
</li>
<li>
<p>缺点：性能问题，只有一个线程，无法完全发挥多个 CPU 的性能。Handler 在处理某个连接上的业务时，整个进程无法处理其他连接事件，很容易导致性能瓶颈。</p>
</li>
</ul>
<p>可靠性问题、线程意外跑飞、进入死循环，或导致整个系统的通信模块不可用，不能接收或处理外部消息，造成节点故障。</p>
<p>应用场景：客户端的数量有限，业务处理非常快，比如 Redis，业务处理的时间复杂度为 O(1)。</p>
<h4 id=单-reactor-多线程>单 Reactor 多线程</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225210742.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>
<p>Reactor 对象通过 Select 监控客户端请求事件，收到事件后通过 Dispatch 进行分发。</p>
</li>
<li>
<p>如果是建立连接请求事件，则由 Acceptor 通过 Accept 处理连接请求，同时创建一个 Handler 对象处理连接完成后续的各种事件。</p>
</li>
<li>
<p>如果不是建立连接事件，则 Reactor 会分发调用连接对应的 Handler 来响应。</p>
</li>
<li>
<p>Handler 只负责响应事件，不做具体业务处理，通过 Read 读取数据后，会分发给后面的 Worker 线程池进行业务处理。</p>
</li>
<li>
<p>Worker 线程池会分配独立的线程完成真正的业务处理，如何将响应结果发给 Handler 进行处理。</p>
</li>
<li>
<p>Handler 收到响应结果后通过 Send 将响应结果返回给 Client。</p>
</li>
<li>
<p>优点：可以充分利用多核 CPU 的处理能力。</p>
</li>
<li>
<p>缺点：</p>
<ul>
<li>多线程数据共享和访问比较复杂；</li>
<li>Reactor 承担所有事件的监听和响应，在单线程中运行，高并发场景下容易成为性能瓶颈。</li>
</ul>
</li>
</ul>
<h4 id=主从-reactor-多线程>主从 Reactor 多线程</h4>
<p>针对单 Reactor 多线程模型中，Reactor 在单线程中运行，高并发场景下容易成为性能瓶颈，可以让 Reactor 在多线程中运行。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225213435.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>
<p>Reactor 主线程 MainReactor 对象通过 Select 监控建立连接事件，收到事件后通过 Acceptor 接收，处理建立连接事件。</p>
</li>
<li>
<p>Acceptor 处理建立连接事件后，MainReactor 将连接分配 Reactor 子线程给 SubReactor 进行处理。</p>
</li>
<li>
<p>SubReactor 将连接加入连接队列进行监听，并创建一个 Handler 用于处理各种连接事件。</p>
</li>
<li>
<p>当有新的事件发生时，SubReactor 会调用连接对应的 Handler 进行响应。</p>
</li>
<li>
<p>Handler 通过 Read 读取数据后，会分发给后面的 Worker 线程池进行业务处理。</p>
</li>
<li>
<p>Worker 线程池会分配独立的线程完成真正的业务处理，如何将响应结果发给 Handler 进行处理。</p>
</li>
<li>
<p>Handler 收到响应结果后通过 Send 将响应结果返回给 Client。</p>
</li>
<li>
<p>优点：父线程与子线程的数据交互简单、职责明确，父线程只需要接收新连接，子线程完成后续的业务处理。</p>
</li>
</ul>
<p>父线程与子线程的数据交互简单，Reactor 主线程只需要把新连接传递给子线程即可，子线程无需返回数据。</p>
<p>这种模型在很多项目中广泛使用，包括 Nginx 主从 Reactor 多线程模型，Memcached 主从多线程。</p>
<h4 id=reactor-模式总结>Reactor 模式总结</h4>
<p>三种模式可以用一个比喻来理解：餐厅常常雇佣接待员负责迎接顾客，当顾客入座后，侍应生专门为这张桌子服务。</p>
<ul>
<li>单 Reactor 单线程：接待员和侍应生是同一个人，全程为顾客服务。</li>
<li>单 Reactor 多线程：一个接待员、多个侍应生，接待员只负责接待。</li>
<li>主从 Reactor：多个接待员，多个侍应生。</li>
</ul>
<p>Reactor 模式具有如下的优点：</p>
<ul>
<li>响应快：不必为单个同步时间所阻塞，虽然 Reactor 本身依然是同步的。</li>
<li>编程相对简单：可以最大程度的避免复杂的多线程及同步问题，并且避免了多线程的切换开销。</li>
<li>可扩展性：可以方便的通过增加 Reactor 实例个数来充分利用 CPU 资源。</li>
<li>可复用性：Reactor 模型本身与具体事件处理逻辑无关，具有很高的复用性。</li>
</ul>
<h3 id=proactor-模型>Proactor 模型</h3>
<p>在 Reactor 模式中，Reactor 等待某个事件、可应用或操作的状态发生(比如文件描述符可读、Socket 可读写)。</p>
<p>然后把该事件传递给事先注册的 Handler(事件处理函数或回调函数)，由后者来做实际的读写操作。</p>
<p>其中的读写操作都需要应用程序同步操作，所以 <strong>Reactor 是非阻塞同步网络模型</strong>。</p>
<p>如果把 IO 操作改为异步，即交给操作系统来完成 IO 操作，就能进一步提升性能，这就是异步网络模型 Proactor。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225214717.png style=display:block;width:50% alt=NAME align=center> </div>
<p>Proactor 是和异步 I/O 相关的，详细方案如下：</p>
<ul>
<li>ProactorInitiator 创建 Proactor 和 Handler 对象，并将 Proactor 和 Handler 都通过 AsyOptProcessor(Asynchronous Operation Processor) 注册到内核。</li>
<li>AsyOptProcessor 处理注册请求，并处理 I/O 操作。</li>
<li>AsyOptProcessor 完成 I/O 操作后通知 Proactor。</li>
<li>Proactor 根据不同的事件类型回调不同的 Handler 进行业务处理。</li>
<li>Handler 完成业务处理。</li>
</ul>
<p>可以看出 Proactor 和 Reactor 的区别：</p>
<ul>
<li>Reactor 是在事件发生时就通知事先注册的事件(读写在应用程序线程中处理完成)。</li>
<li>Proactor 是在事件发生时基于异步 I/O 完成读写操作(由内核完成)，待 I/O 操作完成后才回调应用程序的处理器来进行业务处理。</li>
</ul>
<p>理论上 Proactor 比 Reactor 效率更高，异步 I/O 更加充分发挥 DMA(Direct Memory Access，直接内存存取)的优势，但是有如下缺点：</p>
<ul>
<li><strong>编程复杂性</strong>：由于异步操作流程的事件的初始化和事件完成在时间和空间上都是相互分离的，因此开发异步应用程序更加复杂。应用程序还可能因为反向的流控而变得更加难以 Debug。</li>
<li><strong>内存使用</strong>：缓冲区在读或写操作的时间段内必须保持住，可能造成持续的不确定性，并且每个并发操作都要求有独立的缓存，相比 Reactor 模式，在 Socket 已经准备好读或写前，是不要求开辟缓存的。</li>
<li><strong>操作系统支持</strong>，Windows 下通过 IOCP 实现了真正的异步 I/O，而在 Linux 系统下，Linux 2.6 才引入，目前异步 I/O 还不完善。</li>
</ul>
<p>因此在 Linux 下实现高并发网络编程都是以 Reactor 模型为主。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3d6330bcf4302926c8990d2573910e68>8 - CH08-BIO原理</h1>
<h2 id=概览>概览</h2>
<p>BIO就是: blocking IO。最容易理解、最容易实现的IO工作方式，应用程序向操作系统请求网络IO操作，这时应用程序会一直等待；另一方面，操作系统收到请求后，也会等待，直到网络上有数据传到监听端口；操作系统在收集数据后，会把数据发送给应用程序；最后应用程序受到数据，并解除等待状态。</p>
<h2 id=概念>概念</h2>
<ul>
<li>
<p><code>阻塞IO</code> 和 <code>非阻塞IO</code></p>
<p>这两个概念是<code>程序级别</code>的。主要描述的是程序请求操作系统IO操作后，如果IO资源没有准备好，那么程序该如何处理的问题: 前者等待；后者继续执行(并且使用线程一直轮询，直到有IO资源准备好了)</p>
</li>
<li>
<p><code>同步IO</code> 和 <code>非同步IO</code></p>
<p>这两个概念是<code>操作系统级别</code>的。主要描述的是操作系统在收到程序请求IO操作后，如果IO资源没有准备好，该如何相应程序的问题: 前者不响应，直到IO资源准备好以后；后者返回一个标记(好让程序和自己知道以后的数据往哪里通知)，当IO资源准备好以后，再用事件机制返回给程序。</p>
</li>
</ul>
<h2 id=bio通信方式>BIO通信方式</h2>
<p>以前大多数网络通信方式都是阻塞模式的，即:</p>
<ul>
<li>客户端向服务器端发出请求后，客户端会一直等待(不会再做其他事情)，直到服务器端返回结果或者网络出现问题。</li>
<li>服务器端同样的，当在处理某个客户端A发来的请求时，另一个客户端B发来的请求会等待，直到服务器端的这个处理线程完成上一个处理。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501220158.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=传统的bio的问题>传统的BIO的问题</h3>
<ul>
<li>同一时间，服务器只能接受来自于客户端A的请求信息；虽然客户端A和客户端B的请求是同时进行的，但客户端B发送的请求信息只能等到服务器接受完A的请求数据后，才能被接受。</li>
<li>由于服务器一次只能处理一个客户端请求，当处理完成并返回后(或者异常时)，才能进行第二次请求的处理。很显然，这样的处理方式在高并发的情况下，是不能采用的。</li>
</ul>
<h3 id=多线程方式---伪异步方式>多线程方式 - 伪异步方式</h3>
<p>上面说的情况是服务器只有一个线程的情况，那么读者会直接提出我们可以使用多线程技术来解决这个问题:</p>
<ul>
<li>当服务器收到客户端X的请求后，(读取到所有请求数据后)将这个请求送入一个独立线程进行处理，然后主线程继续接受客户端Y的请求。</li>
<li>客户端一侧，也可以使用一个子线程和服务器端进行通信。这样客户端主线程的其他工作就不受影响了，当服务器端有响应信息的时候再由这个子线程通过 监听模式/观察模式(等其他设计模式)通知主线程。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221246.png style=display:block;width:50% alt=NAME align=center> </div>
<p>但是使用线程来解决这个问题实际上是有局限性的:</p>
<ul>
<li>虽然在服务器端，请求的处理交给了一个独立线程进行，但是操作系统通知accept()的方式还是单个的。也就是，实际上是服务器接收到数据报文后的“业务处理过程”可以多线程，但是数据报文的接受还是需要一个一个的来(下文的示例代码和debug过程我们可以明确看到这一点)</li>
<li>在linux系统中，可以创建的线程是有限的。我们可以通过cat /proc/sys/kernel/threads-max 命令查看可以创建的最大线程数。当然这个值是可以更改的，但是线程越多，CPU切换所需的时间也就越长，用来处理真正业务的需求也就越少。</li>
<li>创建一个线程是有较大的资源消耗的。JVM创建一个线程的时候，即使这个线程不做任何的工作，JVM都会分配一个堆栈空间。这个空间的大小默认为128K，您可以通过-Xss参数进行调整。当然您还可以使用ThreadPoolExecutor线程池来缓解线程的创建问题，但是又会造成BlockingQueue积压任务的持续增加，同样消耗了大量资源。</li>
<li>另外，如果您的应用程序大量使用长连接的话，线程是不会关闭的。这样系统资源的消耗更容易失控。 那么，如果你真想单纯使用线程解决阻塞的问题，那么您自己都可以算出来您一个服务器节点可以一次接受多大的并发了。看来，单纯使用线程解决这个问题不是最好的办法。</li>
</ul>
<h2 id=深入分析>深入分析</h2>
<p>BIO的问题关键不在于是否使用了多线程(包括线程池)处理这次请求，而在于accept()、read()的操作点都是被阻塞。要测试这个问题，也很简单。我们模拟了20个客户端(用20根线程模拟)，利用JAVA的同步计数器CountDownLatch，保证这20个客户都初始化完成后然后同时向服务器发送请求，然后我们来观察一下Server这边接受信息的情况。</p>
<h3 id=模拟20个客户端并发请求服务器端使用单线程>模拟20个客户端并发请求，服务器端使用单线程:</h3>
<p>客户端代码(SocketClientDaemon)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.CountDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketClientDaemon</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Integer</span> <span style=color:#000>clientNumber</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientNumber</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>//分别开始启动这20个客户端
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>clientNumber</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketClientRequestThread</span> <span style=color:#000>client</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>client</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//这个wait不涉及到具体的实验逻辑，只是为了保证守护线程在启动所有线程后，进入等待状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketClientDaemon</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketClientDaemon</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wait</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>客户端代码(SocketClientRequestThread模拟请求)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.OutputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.Socket</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.CountDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.Log</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.LogFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.log4j.BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 一个SocketClientRequestThread线程模拟一个客户端请求。
</span><span style=color:#8f5902;font-style:italic> * @author yinwenjie
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketClientRequestThread</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 日志
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 这个线层的编号
</span><span style=color:#8f5902;font-style:italic>     * @param countDownLatch
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>clientIndex</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * countDownLatch是java提供的同步计数器。
</span><span style=color:#8f5902;font-style:italic>     * 当计数器数值减为0时，所有受其影响而等待的线程将会被激活。这样保证模拟并发请求的真实性
</span><span style=color:#8f5902;font-style:italic>     * @param countDownLatch
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>clientIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clientIndex</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>OutputStream</span> <span style=color:#000>clientRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>clientResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Socket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>83</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>clientRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>clientResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//等待，直到SocketClientDaemon完成所有线程的启动，然后所有线程一起发送请求
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//发送请求信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>clientRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#4e9a06>&#34;这是第&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; 个客户端的请求。&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>clientRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//在这里等待，直到服务器返回信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;第&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;个客户端的请求发送完成，等待服务器返回信息&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//程序执行到这里，会一直等待服务器返回信息(注意，前提是in和out都不能close，如果close了就收不到服务器的反馈了)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>realLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clientResponse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;接收到来自服务器的信息:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientRequest</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>clientRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientResponse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>clientResponse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>服务器端(SocketServer1)单个线程</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.OutputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.ServerSocket</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.Socket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.Log</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.LogFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.log4j.BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketServer1</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 日志
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketServer1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ServerSocket</span> <span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerSocket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>83</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#8f5902;font-style:italic>//下面我们收取信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>InputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>OutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>Integer</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPort</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2048</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#8f5902;font-style:italic>//这里也会被阻塞，直到有数据准备好
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>realLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//读取信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>//下面打印信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>SocketServer1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;服务器收到来自于端口: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;的信息: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>//下面开始发送信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;回发响应信息！&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#8f5902;font-style:italic>//关闭
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketServer1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=多线程来优化服务器端>多线程来优化服务器端</h3>
<p>客户端代码和上文一样，最主要是更改服务器端的代码:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.OutputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.ServerSocket</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.Socket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.Log</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.LogFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.log4j.BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketServer2</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketServer2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ServerSocket</span> <span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerSocket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>83</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//当然业务处理过程可以交给一个线程(这里可以使用线程池),并且线程的创建是很耗资源的。
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//最终改变不了.accept()只能一个一个接受socket的情况,并且被阻塞的情况
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>SocketServerThread</span> <span style=color:#000>socketServerThread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>socketServerThread</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketServer2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 当然，接收到客户端的socket后，业务的处理过程可以交给一个线程来做。
</span><span style=color:#8f5902;font-style:italic> * 但还是改变不了socket被一个一个的做accept()的情况。
</span><span style=color:#8f5902;font-style:italic> * @author yinwenjie
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketServerThread</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 日志
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Socket</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SocketServerThread</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Socket</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>OutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//下面我们收取信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Integer</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPort</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#8f5902;font-style:italic>//使用线程，同样无法解决read方法的阻塞问题，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//也就是说read方法处同样会被阻塞，直到操作系统有数据准备好
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>realLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//读取信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>//下面打印信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;服务器收到来自于端口: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;的信息: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>//下面开始发送信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;回发响应信息！&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//试图关闭
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=优化效果>优化效果</h3>
<p>我们主要看一看服务器使用多线程处理时的情况:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221456.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=问题根源>问题根源</h3>
<p>那么重点的问题并不是“是否使用了多线程”，而是为什么accept()、read()方法会被阻塞。即: 异步IO模式 就是为了解决这样的并发性存在的。但是为了说清楚异步IO模式，在介绍IO模式的时候，我们就要首先了解清楚，什么是 阻塞式同步、非阻塞式同步、多路复用同步模式。</p>
<p>API文档中对于 serverSocket.accept() 方法的使用描述:</p>
<blockquote>
<p>Listens for a connection to be made to this socket and accepts it. The method blocks until a connection is made.</p>
</blockquote>
<p>serverSocket.accept()会被阻塞? 这里涉及到阻塞式同步IO的工作原理:</p>
<ul>
<li>服务器线程发起一个accept动作，询问操作系统 是否有新的socket套接字信息从端口X发送过来。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221526.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>注意，是询问操作系统。也就是说socket套接字的IO模式支持是基于操作系统的，那么自然同步IO/异步IO的支持就是需要操作系统级别的了。如下图:</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221543.png style=display:block;width:50% alt=NAME align=center> </div>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221553.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如果操作系统没有发现有套接字从指定的端口X来，那么操作系统就会等待。这样serverSocket.accept()方法就会一直等待。这就是为什么accept()方法为什么会阻塞: 它内部的实现是使用的操作系统级别的同步IO。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-37086be27cb4e2dc026ba972768fcb2d>9 - CH09-NIO基础</h1>
<p>Standard IO是对字节流的读写，在进行IO之前，首先创建一个流对象，流对象进行读写操作都是按字节 ，一个字节一个字节的来读或写。而NIO把IO抽象成块，类似磁盘的读写，每次IO操作的单位都是一个块，块被读入内存之后就是一个byte[]，NIO一次可以读或写多个字节。</p>
<h2 id=流与块>流与块</h2>
<p>I/O 与 NIO 最重要的区别是数据打包和传输的方式，I/O 以流的方式处理数据，而 NIO 以块的方式处理数据。</p>
<p>面向流的 I/O 一次处理一个字节数据: 一个输入流产生一个字节数据，一个输出流消费一个字节数据。为流式数据创建过滤器非常容易，链接几个过滤器，以便每个过滤器只负责复杂处理机制的一部分。不利的一面是，面向流的 I/O 通常相当慢。</p>
<p>面向块的 I/O 一次处理一个数据块，按块处理数据比按流处理数据要快得多。但是面向块的 I/O 缺少一些面向流的 I/O 所具有的优雅性和简单性。</p>
<p>I/O 包和 NIO 已经很好地集成了，java.io.* 已经以 NIO 为基础重新实现了，所以现在它可以利用 NIO 的一些特性。例如，java.io.* 包中的一些类包含以块的形式读写数据的方法，这使得即使在面向流的系统中，处理速度也会更快。</p>
<h2 id=通道与缓冲区>通道与缓冲区</h2>
<h3 id=通道>通道</h3>
<p>通道 Channel 是对原 I/O 包中的流的模拟，可以通过它读取和写入数据。</p>
<p>通道与流的不同之处在于，流只能在一个方向上移动(一个流必须是 InputStream 或者 OutputStream 的子类)，而通道是双向的，可以用于读、写或者同时用于读写。</p>
<p>通道包括以下类型:</p>
<ul>
<li>FileChannel: 从文件中读写数据；</li>
<li>DatagramChannel: 通过 UDP 读写网络中数据；</li>
<li>SocketChannel: 通过 TCP 读写网络中数据；</li>
<li>ServerSocketChannel: 可以监听新进来的 TCP 连接，对每一个新进来的连接都会创建一个 SocketChannel。</li>
</ul>
<h3 id=缓冲区>缓冲区</h3>
<p>发送给一个通道的所有数据都必须首先放到缓冲区中，同样地，从通道中读取的任何数据都要先读到缓冲区中。也就是说，不会直接对通道进行读写数据，而是要先经过缓冲区。</p>
<p>缓冲区实质上是一个数组，但它不仅仅是一个数组。缓冲区提供了对数据的结构化访问，而且还可以跟踪系统的读/写进程。</p>
<p>缓冲区包括以下类型:</p>
<ul>
<li>ByteBuffer</li>
<li>CharBuffer</li>
<li>ShortBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>FloatBuffer</li>
<li>DoubleBuffer</li>
</ul>
<h2 id=缓冲区状态变量>缓冲区状态变量</h2>
<ul>
<li>capacity: 最大容量；</li>
<li>position: 当前已经读写的字节数；</li>
<li>limit: 还可以读写的字节数。</li>
</ul>
<p>状态变量的改变过程举例:</p>
<p>① 新建一个大小为 8 个字节的缓冲区，此时 position 为 0，而 limit = capacity = 8。capacity 变量不会改变，下面的讨论会忽略它。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221838.png style=display:block;width:50% alt=NAME align=center> </div>
<p>② 从输入通道中读取 5 个字节数据写入缓冲区中，此时 position 移动设置为 5，limit 保持不变。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221857.png style=display:block;width:50% alt=NAME align=center> </div>
<p>③ 在将缓冲区的数据写到输出通道之前，需要先调用 flip() 方法，这个方法将 limit 设置为当前 position，并将 position 设置为 0。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221908.png style=display:block;width:50% alt=NAME align=center> </div>
<p>④ 从缓冲区中取 4 个字节到输出缓冲中，此时 position 设为 4。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221932.png style=display:block;width:50% alt=NAME align=center> </div>
<p>⑤ 最后需要调用 clear() 方法来清空缓冲区，此时 position 和 limit 都被设置为最初位置。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221945.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=文件-nio-实例>文件 NIO 实例</h2>
<p>以下展示了使用 NIO 快速复制文件的实例:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fastCopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/* 获得源文件的输入字节流 */</span>
    <span style=color:#000>FileInputStream</span> <span style=color:#000>fin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 获取输入字节流的文件通道 */</span>
    <span style=color:#000>FileChannel</span> <span style=color:#000>fcin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/* 获取目标文件的输出字节流 */</span>
    <span style=color:#000>FileOutputStream</span> <span style=color:#000>fout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 获取输出字节流的通道 */</span>
    <span style=color:#000>FileChannel</span> <span style=color:#000>fcout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/* 为缓冲区分配 1024 个字节 */</span>
    <span style=color:#000>ByteBuffer</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocateDirect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>/* 从输入通道中读取数据到缓冲区中 */</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fcin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>/* read() 返回 -1 表示 EOF */</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>/* 切换读写 */</span>
        <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>/* 把缓冲区的内容写入输出文件中 */</span>
        <span style=color:#000>fcout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>/* 清空缓冲区 */</span>
        <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=选择器>选择器</h2>
<p>NIO 常常被叫做非阻塞 IO，主要是因为 NIO 在网络通信中的非阻塞特性被广泛使用。</p>
<p>NIO 实现了 IO 多路复用中的 Reactor 模型，一个线程 Thread 使用一个选择器 Selector 通过轮询的方式去监听多个通道 Channel 上的事件，从而让一个线程就可以处理多个事件。</p>
<p>通过配置监听的通道 Channel 为非阻塞，那么当 Channel 上的 IO 事件还未到达时，就不会进入阻塞状态一直等待，而是继续轮询其它 Channel，找到 IO 事件已经到达的 Channel 执行。</p>
<p>因为创建和切换线程的开销很大，因此使用一个线程来处理多个事件而不是一个线程处理一个事件具有更好的性能。</p>
<p>应该注意的是，只有套接字 Channel 才能配置为非阻塞，而 FileChannel 不能，为 FileChannel 配置非阻塞也没有意义。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501222022.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=1-创建选择器>1. 创建选择器</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Selector</span> <span style=color:#000>selector</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=2-将通道注册到选择器上>2. 将通道注册到选择器上</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ssChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configureBlocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_ACCEPT</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>通道必须配置为非阻塞模式，否则使用选择器就没有任何意义了，因为如果通道在某个事件上被阻塞，那么服务器就不能响应其它事件，必须等待这个事件处理完毕才能去处理其它事件，显然这和选择器的作用背道而驰。</p>
<p>在将通道注册到选择器上时，还需要指定要注册的具体事件，主要有以下几类:</p>
<ul>
<li>SelectionKey.OP_CONNECT</li>
<li>SelectionKey.OP_ACCEPT</li>
<li>SelectionKey.OP_READ</li>
<li>SelectionKey.OP_WRITE</li>
</ul>
<p>它们在 SelectionKey 的定义如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_READ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_WRITE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_CONNECT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_ACCEPT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>可以看出每个事件可以被当成一个位域，从而组成事件集整数。例如:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>interestSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_READ</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_WRITE</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=监听事件>监听事件</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>使用 select() 来监听到达的事件，它会一直阻塞直到有至少一个事件到达。</p>
<h3 id=4-获取到达的事件>4. 获取到达的事件</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectedKeys</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAcceptable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=5-事件循环>5. 事件循环</h3>
<p>因为一次 select() 调用不能处理完所有的事件，并且服务器端有可能需要一直监听事件，因此服务器端处理事件的代码一般会放在一个死循环内。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectedKeys</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAcceptable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=套接字-nio-实例>套接字 NIO 实例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NIOServer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>Selector</span> <span style=color:#000>selector</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ssChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configureBlocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_ACCEPT</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>ServerSocket</span> <span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>InetSocketAddress</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InetSocketAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>8888</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectedKeys</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAcceptable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                    <span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ssChannel1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>();</span>

                    <span style=color:#8f5902;font-style:italic>// 服务器会为每个新连接创建一个 SocketChannel
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>SocketChannel</span> <span style=color:#000>sChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ssChannel1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configureBlocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#8f5902;font-style:italic>// 这个新连接主要用于从客户端读取数据
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_READ</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                    <span style=color:#000>SocketChannel</span> <span style=color:#000>sChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readDataFromSocketChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>readDataFromSocketChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>ByteBuffer</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>StringBuilder</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>limit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>limit</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dst</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>limit</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>limit</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NIOClient</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Socket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>8888</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>OutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;hello world&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=内存映射文件>内存映射文件</h2>
<p>内存映射文件 I/O 是一种读和写文件数据的方法，它可以比常规的基于流或者基于通道的 I/O 快得多。</p>
<p>向内存映射文件写入可能是危险的，只是改变数组的单个元素这样的简单操作，就可能会直接修改磁盘上的文件。修改数据与将数据保存到磁盘是没有分开的。</p>
<p>下面代码行将文件的前 1024 个字节映射到内存中，map() 方法返回一个 MappedByteBuffer，它是 ByteBuffer 的子类。因此，可以像使用其他任何 ByteBuffer 一样使用新映射的缓冲区，操作系统会在需要时负责执行映射。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MappedByteBuffer</span> <span style=color:#000>mbb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FileChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MapMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>READ_WRITE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h2 id=对比>对比</h2>
<p>NIO 与普通 I/O 的区别主要有以下两点:</p>
<ul>
<li>NIO 是非阻塞的</li>
<li>NIO 面向块，I/O 面向流</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-da781159746dd7bd152d97f3a8350579>10 - CH10-NIO原理</h1>
<h2 id=现实场景>现实场景</h2>
<p>我们试想一下这样的现实场景:</p>
<p>一个餐厅同时有100位客人到店，当然到店后第一件要做的事情就是点菜。但是问题来了，餐厅老板为了节约人力成本目前只有一位大堂服务员拿着唯一的一本菜单等待客人进行服务。</p>
<ul>
<li>那么最笨(但是最简单)的方法是(方法A)，无论有多少客人等待点餐，服务员都把仅有的一份菜单递给其中一位客人，然后站在客人身旁等待这个客人完成点菜过程。在记录客人点菜内容后，把点菜记录交给后堂厨师。然后是第二位客人。。。。然后是第三位客人。很明显，只有脑袋被门夹过的老板，才会这样设置服务流程。因为随后的80位客人，再等待超时后就会离店(还会给差评)。</li>
<li>于是还有一种办法(方法B)，老板马上新雇佣99名服务员，同时印制99本新的菜单。每一名服务员手持一本菜单负责一位客人(关键不只在于服务员，还在于菜单。因为没有菜单客人也无法点菜)。在客人点完菜后，记录点菜内容交给后堂厨师(当然为了更高效，后堂厨师最好也有100名)。这样每一位客人享受的就是VIP服务咯，当然客人不会走，但是人力成本可是一个大头哦(亏死你)。</li>
<li>另外一种办法(方法C)，就是改进点菜的方式，当客人到店后，自己申请一本菜单。想好自己要点的才后，就呼叫服务员。服务员站在自己身边后记录客人的菜单内容。将菜单递给厨师的过程也要进行改进，并不是每一份菜单记录好以后，都要交给后堂厨师。服务员可以记录号多份菜单后，同时交给厨师就行了。那么这种方式，对于老板来说人力成本是最低的；对于客人来说，虽然不再享受VIP服务并且要进行一定的等待，但是这些都是可接受的；对于服务员来说，基本上她的时间都没有浪费，基本上被老板压杆了最后一滴油水。</li>
</ul>
<p>如果您是老板，您会采用哪种方式呢?</p>
<p>到店情况: 并发量。到店情况不理想时，一个服务员一本菜单，当然是足够了。所以不同的老板在不同的场合下，将会灵活选择服务员和菜单的配置。</p>
<ul>
<li>客人: 客户端请求</li>
<li>点餐内容: 客户端发送的实际数据</li>
<li>老板: 操作系统</li>
<li>人力成本: 系统资源</li>
<li>菜单: 文件状态描述符。操作系统对于一个进程能够同时持有的文件状态描述符的个数是有限制的，在linux系统中$ulimit -n查看这个限制值，当然也是可以(并且应该)进行内核参数调整的。</li>
<li>服务员: 操作系统内核用于IO操作的线程(内核线程)</li>
<li>厨师: 应用程序线程(当然厨房就是应用程序进程咯)</li>
<li>餐单传递方式: 包括了阻塞式和非阻塞式两种。
<ul>
<li>方法A: 阻塞式/非阻塞式 同步IO</li>
<li>方法B: 使用线程进行处理的 阻塞式/非阻塞式 同步IO</li>
<li>方法C: 阻塞式/非阻塞式 多路复用IO</li>
</ul>
</li>
</ul>
<h2 id=典型的多路复用io实现>典型的多路复用IO实现</h2>
<p>目前流程的多路复用IO实现主要包括四种: <code>select</code>、<code>poll</code>、<code>epoll</code>、<code>kqueue</code>。下表是他们的一些重要特性的比较:</p>
<table>
<thead>
<tr>
<th>IO模型</th>
<th>相对性能</th>
<th>关键思路</th>
<th>操作系统</th>
<th>JAVA支持情况</th>
</tr>
</thead>
<tbody>
<tr>
<td>select</td>
<td>较高</td>
<td>Reactor</td>
<td>windows/Linux</td>
<td>支持,Reactor模式(反应器设计模式)。Linux操作系统的 kernels 2.4内核版本之前，默认使用select；而目前windows下对同步IO的支持，都是select模型</td>
</tr>
<tr>
<td>poll</td>
<td>较高</td>
<td>Reactor</td>
<td>Linux</td>
<td>Linux下的JAVA NIO框架，Linux kernels 2.6内核版本之前使用poll进行支持。也是使用的Reactor模式</td>
</tr>
<tr>
<td>epoll</td>
<td>高</td>
<td>Reactor/Proactor</td>
<td>Linux</td>
<td>Linux kernels 2.6内核版本及以后使用epoll进行支持；Linux kernels 2.6内核版本之前使用poll进行支持；另外一定注意，由于Linux下没有Windows下的IOCP技术提供真正的 异步IO 支持，所以Linux下使用epoll模拟异步IO</td>
</tr>
<tr>
<td>kqueue</td>
<td>高</td>
<td>Proactor</td>
<td>Linux</td>
<td>目前JAVA的版本不支持</td>
</tr>
</tbody>
</table>
<p>多路复用IO技术最适用的是“高并发”场景，所谓高并发是指1毫秒内至少同时有上千个连接请求准备好。其他情况下多路复用IO技术发挥不出来它的优势。另一方面，使用JAVA NIO进行功能实现，相对于传统的Socket套接字实现要复杂一些，所以实际应用中，需要根据自己的业务需求进行技术选择。</p>
<h2 id=reactor模型和proactor模型>Reactor模型和Proactor模型</h2>
<h2 id=java对多路复用io的支持>JAVA对多路复用IO的支持</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140322.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=重要概念-channel>重要概念: Channel</h3>
<p>通道，被建立的一个应用程序和操作系统交互事件、传递内容的渠道(注意是连接到操作系统)。一个通道会有一个专属的文件状态描述符。那么既然是和操作系统进行内容的传递，那么说明应用程序可以通过通道读取数据，也可以通过通道向操作系统写数据。</p>
<p>JDK API中的Channel的描述是:</p>
<blockquote>
<p>A channel represents an open connection to an entity such as a hardware device, a file, a network socket, or a program component that is capable of performing one or more distinct I/O operations, for example reading or writing.</p>
</blockquote>
<blockquote>
<p>A channel is either open or closed. A channel is open upon creation, and once closed it remains closed. Once a channel is closed, any attempt to invoke an I/O operation upon it will cause a ClosedChannelException to be thrown. Whether or not a channel is open may be tested by invoking its isOpen method.</p>
</blockquote>
<p>JAVA NIO 框架中，自有的Channel通道包括:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140348.png style=display:block;width:50% alt=NAME align=center> </div>
<p>所有被Selector(选择器)注册的通道，只能是继承了SelectableChannel类的子类。如上图所示</p>
<ul>
<li>ServerSocketChannel: 应用服务器程序的监听通道。只有通过这个通道，应用程序才能向操作系统注册支持“多路复用IO”的端口监听。同时支持UDP协议和TCP协议。</li>
<li>ScoketChannel: TCP Socket套接字的监听通道，一个Socket套接字对应了一个客户端IP: 端口 到 服务器IP: 端口的通信连接。</li>
<li>DatagramChannel: UDP 数据报文的监听通道。</li>
</ul>
<h3 id=重要概念-buffer>重要概念: Buffer</h3>
<p>数据缓存区: 在JAVA NIO 框架中，为了保证每个通道的数据读写速度JAVA NIO 框架为每一种需要支持数据读写的通道集成了Buffer的支持。</p>
<p>这句话怎么理解呢? 例如ServerSocketChannel通道它只支持对OP_ACCEPT事件的监听，所以它是不能直接进行网络数据内容的读写的。所以ServerSocketChannel是没有集成Buffer的。</p>
<p>Buffer有两种工作模式: 写模式和读模式。在读模式下，应用程序只能从Buffer中读取数据，不能进行写操作。但是在写模式下，应用程序是可以进行读操作的，这就表示可能会出现脏读的情况。所以一旦您决定要从Buffer中读取数据，一定要将Buffer的状态改为读模式。</p>
<p>如下图:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140412.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>position: 缓存区目前这在操作的数据块位置</li>
<li>limit: 缓存区最大可以进行操作的位置。缓存区的读写状态正式由这个属性控制的。</li>
<li>capacity: 缓存区的最大容量。这个容量是在缓存区创建时进行指定的。由于高并发时通道数量往往会很庞大，所以每一个缓存区的容量最好不要过大。</li>
</ul>
<p>在下文JAVA NIO框架的代码实例中，我们将进行Buffer缓存区操作的演示。</p>
<h3 id=重要概念-selector>重要概念: Selector</h3>
<p>Selector的英文含义是“选择器”，不过根据我们详细介绍的Selector的岗位职责，您可以把它称之为“轮询代理器”、“事件订阅器”、“channel容器管理机”都行。</p>
<ul>
<li>事件订阅和Channel管理</li>
</ul>
<p>应用程序将向Selector对象注册需要它关注的Channel，以及具体的某一个Channel会对哪些IO事件感兴趣。Selector中也会维护一个“已经注册的Channel”的容器。以下代码来自WindowsSelectorImpl实现类中，对已经注册的Channel的管理容器:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Initial capacity of the poll array
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INIT_CAP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>// Maximum number of sockets for select().
</span><span style=color:#8f5902;font-style:italic>// Should be INIT_CAP times a power of 2
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAX_SELECTABLE_FDS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// The list of SelectableChannels serviced by this Selector. Every mod
</span><span style=color:#8f5902;font-style:italic>// MAX_SELECTABLE_FDS entry is bogus, to align this array with the poll
</span><span style=color:#8f5902;font-style:italic>// array,  where the corresponding entry is occupied by the wakeupSocket
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SelectionKeyImpl</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>channelArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SelectionKeyImpl</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>INIT_CAP</span><span style=color:#ce5c00;font-weight:700>];</span>
</code></pre></div><ul>
<li>轮询代理</li>
</ul>
<p>应用层不再通过阻塞模式或者非阻塞模式直接询问操作系统“事件有没有发生”，而是由Selector代其询问。</p>
<ul>
<li>实现不同操作系统的支持</li>
</ul>
<p>之前已经提到过，多路复用IO技术 是需要操作系统进行支持的，其特点就是操作系统可以同时扫描同一个端口上不同网络连接的事件。所以作为上层的JVM，必须要为 不同操作系统的多路复用IO实现 编写不同的代码。同样我使用的测试环境是Windows，它对应的实现类是sun.nio.ch.WindowsSelectorImpl:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140645.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=java-nio-框架简要设计分析>JAVA NIO 框架简要设计分析</h3>
<p>通过上文的描述，我们知道了多路复用IO技术是操作系统的内核实现。在不同的操作系统，甚至同一系列操作系统的版本中所实现的多路复用IO技术都是不一样的。那么作为跨平台的JAVA JVM来说如何适应多种多样的多路复用IO技术实现呢? 面向对象的威力就显现出来了: 无论使用哪种实现方式，他们都会有“选择器”、“通道”、“缓存”这几个操作要素，那么可以为不同的多路复用IO技术创建一个统一的抽象组，并且为不同的操作系统进行具体的实现。JAVA NIO中对各种多路复用IO的支持，主要的基础是java.nio.channels.spi.SelectorProvider抽象类，其中的几个主要抽象方法包括:</p>
<ul>
<li>public abstract DatagramChannel openDatagramChannel(): 创建和这个操作系统匹配的UDP 通道实现。</li>
<li>public abstract AbstractSelector openSelector(): 创建和这个操作系统匹配的NIO选择器，就像上文所述，不同的操作系统，不同的版本所默认支持的NIO模型是不一样的。</li>
<li>public abstract ServerSocketChannel openServerSocketChannel(): 创建和这个NIO模型匹配的服务器端通道。</li>
<li>public abstract SocketChannel openSocketChannel(): 创建和这个NIO模型匹配的TCP Socket套接字通道(用来反映客户端的TCP连接)</li>
</ul>
<p>由于JAVA NIO框架的整个设计是很大的，所以我们只能还原一部分我们关心的问题。这里我们以JAVA NIO框架中对于不同多路复用IO技术的选择器 进行实例化创建的方式作为例子，以点窥豹观全局:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140712.png style=display:block;width:50% alt=NAME align=center> </div>
<p>很明显，不同的SelectorProvider实现对应了不同的 选择器。由具体的SelectorProvider实现进行创建。另外说明一下，实际上netty底层也是通过这个设计获得具体使用的NIO模型，我们后文讲解Netty时，会讲到这个问题。以下代码是Netty 4.0中NioServerSocketChannel进行实例化时的核心代码片段:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ServerSocketChannel</span> <span style=color:#000>newSocket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectorProvider</span> <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>            *  Use the {@link SelectorProvider} to open {@link SocketChannel} and so remove condition in
</span><span style=color:#8f5902;font-style:italic>            *  {@link SelectorProvider#provider()} which is called by each ServerSocketChannel.open() otherwise.
</span><span style=color:#8f5902;font-style:italic>            *
</span><span style=color:#8f5902;font-style:italic>            *  See &lt;a href=&#34;See https://github.com/netty/netty/issues/2308&#34;&gt;#2308&lt;/a&gt;.
</span><span style=color:#8f5902;font-style:italic>            */</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;Failed to open a server socket.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=多路复用io的优缺点>多路复用IO的优缺点</h2>
<p>不用再使用多线程来进行IO处理了(包括操作系统内核IO管理模块和应用程序进程而言)。当然实际业务的处理中，应用程序进程还是可以引入线程池技术的</p>
<p>同一个端口可以处理多种协议，例如，使用ServerSocketChannel测测的服务器端口监听，既可以处理TCP协议又可以处理UDP协议。</p>
<p>操作系统级别的优化: 多路复用IO技术可以是操作系统级别在一个端口上能够同时接受多个客户端的IO事件。同时具有之前我们讲到的阻塞式同步IO和非阻塞式同步IO的所有特点。Selector的一部分作用更相当于“轮询代理器”。</p>
<p>都是同步IO: 目前我们介绍的 阻塞式IO、非阻塞式IO甚至包括多路复用IO，这些都是基于操作系统级别对“同步IO”的实现。我们一直在说“同步IO”，一直都没有详细说，什么叫做“同步IO”。实际上一句话就可以说清楚: 只有上层(包括上层的某种代理机制)系统询问我是否有某个事件发生了，否则我不会主动告诉上层系统事件发生了。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e8064dcc899de72ab1295366b642e4a2>11 - CH11-AIO原理</h1>
<h2 id=异步io>异步IO</h2>
<p>上面两篇文章中，我们分别讲解了阻塞式同步IO、非阻塞式同步IO、多路复用IO 这三种IO模型，以及JAVA对于这三种IO模型的支持。重点说明了IO模型是由操作系统提供支持，且这三种IO模型都是同步IO，都是采用的“应用程序不询问我，我绝不会主动通知”的方式。</p>
<p>异步IO则是采用“订阅-通知”模式: 即应用程序向操作系统注册IO监听，然后继续做自己的事情。当操作系统发生IO事件，并且准备好数据后，在主动通知应用程序，触发相应的函数:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141006.png style=display:block;width:50% alt=NAME align=center> </div>
<p>和同步IO一样，异步IO也是由操作系统进行支持的。微软的windows系统提供了一种异步IO技术: IOCP(I/O Completion Port，I/O完成端口)；</p>
<p>Linux下由于没有这种异步IO技术，所以使用的是epoll(上文介绍过的一种多路复用IO技术的实现)对异步IO进行模拟。</p>
<h3 id=java-aio框架简析>JAVA AIO框架简析</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141030.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这里通过这个结构分析要告诉各位读者JAVA AIO中类设计和操作系统的相关性</p>
<p>在文中我们一再说明JAVA AIO框架在windows下使用windows IOCP技术，在Linux下使用epoll多路复用IO技术模拟异步IO，这个从JAVA AIO框架的部分类设计上就可以看出来。例如框架中，在Windows下负责实现套接字通道的具体类是“sun.nio.ch.WindowsAsynchronousSocketChannelImpl”，其引用的IOCP类型文档注释如是:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>* Windows implementation of AsynchronousChannelGroup encapsulating an I/O 
</span><span style=color:#8f5902;font-style:italic>* completion port. 
</span><span style=color:#8f5902;font-style:italic>*/</span>
</code></pre></div><p>如果您感兴趣，当然可以去看看全部完整代码(建议从“java.nio.channels.spi.AsynchronousChannelProvider”这个类看起)。</p>
<p>特别说明一下，请注意图中的“java.nio.channels.NetworkChannel”接口，这个接口同样被JAVA NIO框架实现了，如下图所示:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141056.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=要点讲解>要点讲解</h3>
<p>注意在JAVA NIO框架中，我们说到了一个重要概念“selector”(选择器)。它负责代替应用查询中所有已注册的通道到操作系统中进行IO事件轮询、管理当前注册的通道集合，定位发生事件的通道等操操作；但是在JAVA AIO框架中，由于应用程序不是“轮询”方式，而是订阅-通知方式，所以不再需要“selector”(选择器)了，改由channel通道直接到操作系统注册监听。</p>
<p>JAVA AIO框架中，只实现了两种网络IO通道“AsynchronousServerSocketChannel”(服务器监听通道)、“AsynchronousSocketChannel”(socket套接字通道)。但是无论哪种通道他们都有独立的fileDescriptor(文件标识符)、attachment(附件，附件可以使任意对象，类似“通道上下文”)，并被独立的SocketChannelReadHandle类实例引用。我们通过debug操作来看看它们的引用结构:</p>
<p>在测试过程中，我们启动了两个客户端(客户端用什么语言来写都行，用阻塞或者非阻塞方式也都行，只要是支持 TCP Socket套接字的就行，然后我们观察服务器端对这两个客户端通道的处理情况:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141123.png style=display:block;width:50% alt=NAME align=center> </div>
<p>可以看到，在服务器端分别为客户端1和客户端2创建的两个WindowsAsynchronousSocketChannelImpl对象为:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141141.png style=display:block;width:50% alt=NAME align=center> </div>
<p>客户端1: WindowsAsynchronousSocketChannelImpl: 760 | FileDescriptor: 762</p>
<p>客户端2: WindowsAsynchronousSocketChannelImpl: 792 | FileDescriptor: 797</p>
<p>接下来，我们让两个客户端发送信息到服务器端，并观察服务器端的处理情况。客户端1发来的消息和客户端2发来的消息，在服务器端的处理情况如下图所示:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141156.png style=display:block;width:50% alt=NAME align=center> </div>
<p>客户端1: WindowsAsynchronousSocketChannelImpl: 760 | FileDescriptor: 762 | SocketChannelReadHandle: 803 | HeapByteBuffer: 808</p>
<p>客户端2: WindowsAsynchronousSocketChannelImpl: 792 | FileDescriptor: 797 | SocketChannelReadHandle: 828 | HeapByteBuffer: 833</p>
<p>可以明显看到，服务器端处理每一个客户端通道所使用的SocketChannelReadHandle(处理器)对象都是独立的，并且所引用的SocketChannel对象都是独立的。</p>
<p>JAVA NIO和JAVA AIO框架，除了因为操作系统的实现不一样而去掉了Selector外，其他的重要概念都是存在的，例如上文中提到的Channel的概念，还有演示代码中使用的Buffer缓存方式。实际上JAVA NIO和JAVA AIO框架您可以看成是一套完整的“高并发IO处理”的实现。</p>
<h3 id=还有改进可能>还有改进可能</h3>
<p>当然，以上代码是示例代码，目标是为了让您了解JAVA AIO框架的基本使用。所以它还有很多改造的空间，例如:</p>
<p>在生产环境下，我们需要记录这个通道上“用户的登录信息”。那么这个需求可以使用JAVA AIO中的“附件”功能进行实现。</p>
<p>记住JAVA AIO 和 JAVA NIO 框架都是要使用线程池的(当然您也可以不用)，线程池的使用原则，一定是只有业务处理部分才使用，使用后马上结束线程的执行(还回线程池或者消灭它)。JAVA AIO框架中还有一个线程池，是拿给“通知处理器”使用的，这是因为JAVA AIO框架是基于“订阅-通知”模型的，“订阅”操作可以由主线程完成，但是您总不能要求在应用程序中并发的“通知”操作也在主线程上完成吧^_^。</p>
<p>最好的改进方式，当然就是使用Netty或者Mina咯</p>
<h2 id=为什么还有netty>为什么还有Netty</h2>
<ul>
<li>那么有的读者可能就会问，既然JAVA NIO / JAVA AIO已经实现了各主流操作系统的底层支持，那么为什么现在主流的JAVA NIO技术会是Netty和MINA呢? 答案很简单: 因为更好用，这里举几个方面的例子:</li>
<li>虽然JAVA NIO 和 JAVA AIO框架提供了 多路复用IO/异步IO的支持，但是并没有提供上层“信息格式”的良好封装。例如前两者并没有提供针对 Protocol Buffer、JSON这些信息格式的封装，但是Netty框架提供了这些数据格式封装(基于责任链模式的编码和解码功能)</li>
<li>要编写一个可靠的、易维护的、高性能的(注意它们的排序)NIO/AIO 服务器应用。除了框架本身要兼容实现各类操作系统的实现外。更重要的是它应该还要处理很多上层特有服务，例如: 客户端的权限、还有上面提到的信息格式封装、简单的数据读取。这些Netty框架都提供了响应的支持。</li>
<li>JAVA NIO框架存在一个poll/epoll bug: Selector doesn’t block on Selector.select(timeout)，不能block意味着CPU的使用率会变成100%(这是底层JNI的问题，上层要处理这个异常实际上也好办)。当然这个bug只有在Linux内核上才能重现。</li>
<li>这个问题在JDK 1.7版本中还没有被完全解决: <a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=2147719">http://bugs.java.com/bugdatabase/view_bug.do?bug_id=2147719</a>。虽然Netty 4.0中也是基于JAVA NIO框架进行封装的(上文中已经给出了Netty中NioServerSocketChannel类的介绍)，但是Netty已经将这个bug进行了处理。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-48dbf55268518f9a2344d8bbc9093d0f>12 - CH12-零拷贝</h1>
<p>CPU 并不执行将数据从一个存储区域拷贝到另一个存储区域这样的任务。通常用于在网络传输文件时节省 CPU 周期和内存带宽。</p>
<h2 id=缓存-io>缓存 IO</h2>
<p>缓存 IO 又被称为标准 IO，大多数文件系统的默认 IO 操作都是缓存 IO。在 Linux 的缓存 IO 机制中，操作系统会将 IO 的数据缓存在文件系统的页缓存(page cache)中，也就是说，数据会先被拷贝到操作系统内核的缓冲区中，然后才会从操作系统内核的缓冲区拷贝到应用程序的地址空间。</p>
<p>缓存 IO 的缺点：数据在传输过程中需要在应用程序地址空间和内核间进行多次数据复制操作，这些数据复制所带来的 CPU 及内存开销是非常大的。</p>
<h2 id=零拷贝技术分类>零拷贝技术分类</h2>
<p>零拷贝技术的发展很多样化，现有的零拷贝技术种类也非常多，而当前并没有一个适合于所有场景的零拷贝技术出现。对于 Linux 来说，现有的零拷贝技术也比较多，这些零拷贝技术大部分存在于不同的 Linux 内核版本，有些旧的技术在不同的 Linux 内核版本间得到了很大的发展或者已经渐渐被新的技术所代替。</p>
<p>本文针对这些零拷贝技术所适用的不同场景对它们进行了划分。概括起来，Linux 中的零拷贝技术主要有下面这几种：</p>
<ul>
<li>直接 I/O：对于这种数据传输方式来说，应用程序可以直接访问硬件存储，操作系统内核只是辅助数据传输：这类零拷贝技术针对的是操作系统内核并不需要对数据进行直接处理的情况，数据可以在应用程序地址空间的缓冲区和磁盘之间直接进行传输，完全不需要 Linux 操作系统内核提供的页缓存的支持。</li>
<li>在数据传输的过程中，避免数据在操作系统内核地址空间的缓冲区和用户应用程序地址空间的缓冲区之间进行拷贝。有的时候，应用程序在数据进行传输的过程中不需要对数据进行访问，那么，将数据从 Linux 的页缓存拷贝到用户进程的缓冲区中就可以完全避免，传输的数据在页缓存中就可以得到处理。在某些特殊的情况下，这种零拷贝技术可以获得较好的性能。Linux 中提供类似的系统调用主要有 mmap()，sendfile() 以及 splice()。</li>
<li>对数据在 Linux 的页缓存和用户进程的缓冲区之间的传输过程进行优化。该零拷贝技术侧重于灵活地处理数据在用户进程的缓冲区和操作系统的页缓存之间的拷贝操作。这种方法延续了传统的通信方式，但是更加灵活。在Linux 中，该方法主要利用了写时复制技术。</li>
</ul>
<p>前两类方法的目的主要是为了避免应用程序地址空间和操作系统内核地址空间这两者之间的缓冲区拷贝操作。这两类零拷贝技术通常适用在某些特殊的情况下，比如要传送的数据不需要经过操作系统内核的处理或者不需要经过应用程序的处理。第三类方法则继承了传统的应用程序地址空间和操作系统内核地址空间之间数据传输的概念，进而针对数据传输本身进行优化。我们知道，硬件和软件之间的数据传输可以通过使用 DMA 来进行，DMA 进行数据传输的过程中几乎不需要CPU参与，这样就可以把 CPU 解放出来去做更多其他的事情，但是当数据需要在用户地址空间的缓冲区和 Linux 操作系统内核的页缓存之间进行传输的时候，并没有类似DMA 这种工具可以使用，CPU 需要全程参与到这种数据拷贝操作中，所以这第三类方法的目的是可以有效地改善数据在用户地址空间和操作系统内核地址空间之间传递的效率。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225144400.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当应用程序访问某块数据时，操作系统首先会检查，是不是最近访问过此文件，文件内容是否缓存在内核缓冲区，如果是，操作系统则直接根据read系统调用提供的buf地址，将内核缓冲区的内容拷贝到buf所指定的用户空间缓冲区中去。如果不是，操作系统则首先将磁盘上的数据拷贝的内核缓冲区，这一步目前主要依靠DMA来传输，然后再把内核缓冲区上的内容拷贝到用户缓冲区中。 接下来，write系统调用再把用户缓冲区的内容拷贝到网络堆栈相关的内核缓冲区中，最后socket再把内核缓冲区的内容发送到网卡上。</p>
<p>从上图中可以看出，共产生了四次数据拷贝，即使使用了DMA来处理了与硬件的通讯，CPU仍然需要处理两次数据拷贝，与此同时，在用户态与内核态也发生了多次上下文切换，无疑也加重了CPU负担。</p>
<p>在此过程中，我们没有对文件内容做任何修改，那么在内核空间和用户空间来回拷贝数据无疑就是一种浪费，而零拷贝主要就是为了解决这种低效性。</p>
<h2 id=mmap让数据传输不需要经过user-space>mmap：让数据传输不需要经过user space</h2>
<p>我们减少拷贝次数的一种方法是调用mmap()来代替read调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mmap</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>diskfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sockfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>应用程序调用 <code>mmap()</code>，磁盘上的数据会通过 DMA被拷贝的内核缓冲区，接着操作系统会把这段内核缓冲区与应用程序共享，这样就不需要把内核缓冲区的内容往用户空间拷贝。应用程序再调用 write(),操作系统直接将内核缓冲区的内容拷贝到 socket缓冲区中，这一切都发生在内核态，最后， socket缓冲区再把数据发到网卡去。</p>
<p>如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225144413.png style=display:block;width:50% alt=NAME align=center> </div>
<p>使用mmap替代read很明显减少了一次拷贝，当拷贝数据量很大时，无疑提升了效率。但是使用 mmap是有代价的。当你使用 mmap时，你可能会遇到一些隐藏的陷阱。例如，当你的程序 map了一个文件，但是当这个文件被另一个进程截断(truncate)时, write系统调用会因为访问非法地址而被 SIGBUS信号终止。 SIGBUS信号默认会杀死你的进程并产生一个 coredump,如果你的服务器这样被中止了，那会产生一笔损失。</p>
<p>通常我们使用以下解决方案避免这种问题：</p>
<ul>
<li><strong>为SIGBUS信号建立信号处理程序</strong>：当遇到 SIGBUS信号时，信号处理程序简单地返回， write系统调用在被中断之前会返回已经写入的字节数，并且 errno会被设置成success,但是这是一种糟糕的处理办法，因为你并没有解决问题的实质核心。</li>
<li><strong>使用文件租借锁</strong>：通常我们使用这种方法，在文件描述符上使用租借锁，我们为文件向内核申请一个租借锁，当其它进程想要截断这个文件时，内核会向我们发送一个实时的 RT_SIGNAL_LEASE信号，告诉我们内核正在破坏你加持在文件上的读写锁。这样在程序访问非法内存并且被 SIGBUS杀死之前，你的 write系统调用会被中断。 write会返回已经写入的字节数，并且置 errno为success。 我们应该在 mmap文件之前加锁，并且在操作完文件后解锁：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fcntl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>diskfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>F_SETSIG</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>RT_SIGNAL_LEASE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>){</span>
	<span style=color:#000>perror</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;kernel lease set signal&#34;</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>/*  l_type can be F_RDLCK_F_WRLCK 加锁 */</span>
<span style=color:#8f5902;font-style:italic>/*  l_type can be F_UNLCK 解锁 */</span>
<span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fcntl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>diskfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>F_SETLEASE</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>l_type</span><span style=color:#000;font-weight:700>)){</span>
	<span style=color:#000>perror</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;kernel lease set_type&#34;</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://www.ibm.com/developerworks/cn/linux/l-cn-zerocopy1/>https://www.ibm.com/developerworks/cn/linux/l-cn-zerocopy1/</a></li>
<li><a href=https://www.jianshu.com/p/fad3339e3448>https://www.jianshu.com/p/fad3339e3448</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4b8f0dd10f10472f6fce3d8242ba0444>13 - CH13-内存映射</h1>
<p>内存映射文件非常特别，它允许Java程序直接从内存中读取文件内容，通过将整个或部分文件映射到内存，由操作系统来处理加载请求和写入文件，应用只需要和内存打交道，这使得IO操作非常快。加载内存映射文件所使用的内存在Java堆区之外。Java编程语言支持内存映射文件，通过java.nio包和MappedByteBuffer 可以从内存直接读写文件。</p>
<h2 id=内存映射文件>内存映射文件</h2>
<p>内存映射文件，是由一个文件到一块内存的映射。Win32提供了允许应用程序把文件映射到一个进程的函数 (CreateFileMapping)。内存映射文件与虚拟内存有些类似，通过内存映射文件可以保留一个地址空间的区域，同时将物理存储器提交给此区域，内存文件映射的物理存储器来自一个已经存在于磁盘上的文件，而且在对该文件进行操作之前必须首先对文件进行映射。使用内存映射文件处理存储于磁盘上的文件时，将不必再对文件执行I/O操作，使得内存映射文件在处理大数据量的文件时能起到相当重要的作用。</p>
<h2 id=内存映射-io>内存映射 IO</h2>
<p>在传统的文件IO操作中，我们都是调用操作系统提供的底层标准IO系统调用函数 read()、write() ，此时调用此函数的进程（在JAVA中即java进程）由当前的用户态切换到内核态，然后OS的内核代码负责将相应的文件数据读取到内核的IO缓冲区，然 后再把数据从内核IO缓冲区拷贝到进程的私有地址空间中去，这样便完成了一次IO操作。这么做是为了减少磁盘的IO操作，为了提高性能而考虑的，因为我们的程序访问一般都带有局部性，也就是所谓的局部性原理，在这里主要是指的空间局部性，即我们访问了文件的某一段数据，那么接下去很可能还会访问接下去的一段数据，由于磁盘IO操作的速度比直接 访问内存慢了好几个数量级，所以OS根据局部性原理会在一次 read()系统调用过程中预读更多的文件数据缓存在内核IO缓冲区中，当继续访问的文件数据在缓冲区中时便直接拷贝数据到进程私有空间，避免了再次的低 效率磁盘IO操作。其过程如下</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225235607.png style=display:block;width:50% alt=NAME align=center> </div>
<p>内存映射文件和之前说的 标准IO操作最大的不同之处就在于它虽然最终也是要从磁盘读取数据，但是它并不需要将数据读取到OS内核缓冲区，而是直接将进程的用户私有地址空间中的一 部分区域与文件对象建立起映射关系，就好像直接从内存中读、写文件一样，速度当然快了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225235633.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=内存映射的优缺点>内存映射的优缺点</h2>
<p>内存映射IO最大的优点可能在于性能，这对于建立高频电子交易系统尤其重要。内存映射文件通常比标准通过正常IO访问文件要快。另一个巨大的优势是内存映 射IO允许加载不能直接访问的潜在巨大文件 。经验表明，内存映射IO在大文件处理方面性能更加优异。尽管它也有不足——增加了页面错误的数目。由于操作系统只将一部分文件加载到内存，如果一个请求 页面没有在内存中，它将导致页面错误。同样它可以被用来在两个进程中共享数据。</p>
<h2 id=操作系统支持>操作系统支持</h2>
<p>大多数主流操作系统比如Windows平台，UNIX，Solaris和其他类UNIX操作系统都支持内存映射IO和64位架构，你几乎可以将所有文件映射到内存并通过JAVA编程语言直接访问。</p>
<h2 id=java-内存映射-io-的要点>Java 内存映射 IO 的要点</h2>
<ul>
<li>java通过java.nio包来支持内存映射IO。</li>
<li>内存映射文件主要用于性能敏感的应用，例如高频电子交易平台。</li>
<li>通过使用内存映射IO，你可以将大文件加载到内存。</li>
<li>内存映射文件可能导致页面请求错误，如果请求页面不在内存中的话。</li>
<li>映射文件区域的能力取决于于内存寻址的大小。在32位机器中，你不能访问超过4GB或2 ^ 32（以上的文件）。</li>
<li>内存映射IO比起Java中的IO流要快的多。</li>
<li>加载文件所使用的内存是Java堆区之外，并驻留共享内存，允许两个不同进程共享文件。</li>
<li>内存映射文件读写由操作系统完成，所以即使在将内容写入内存后java程序崩溃了，它将仍然会将它写入文件直到操作系统恢复。</li>
<li>出于性能考虑，推荐使用直接字节缓冲而不是非直接缓冲。</li>
<li>不要频繁调用MappedByteBuffer.force()方法，这个方法意味着强制操作系统将内存中的内容写入磁盘，所以如果你每次写入内存映射文件都调用force()方法，你将不会体会到使用映射字节缓冲的好处，相反，它(的性能)将类似于磁盘IO的性能。</li>
<li>万一发生了电源故障或主机故障，将会有很小的机率发生内存映射文件没有写入到磁盘，这意味着你可能会丢失关键数据。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>readFile3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//开始时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>BUFFER_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x300000</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>// 3M的缓冲  
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>File</span> <span style=color:#000>file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>MappedByteBuffer</span> <span style=color:#000>inputBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RandomAccessFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;r&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FileChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MapMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>READ_ONLY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fileLength</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// 读取大文件  
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dst</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>];</span><span style=color:#8f5902;font-style:italic>// 每次读出3M的内容  
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>fileLength</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>  
                        <span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inputBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>  
                        <span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inputBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#8f5902;font-style:italic>// 将得到的3M内容给Scanner，这里的XXX是指Scanner解析的分隔符  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Scanner</span> <span style=color:#000>scan</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Scanner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteArrayInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>useDelimiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#8f5902;font-style:italic>// 这里为对读取文本解析的方法  
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//结束时间
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;NIO 内存映射读大文件，总共耗时：&#34;</span><span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>)+</span><span style=color:#4e9a06>&#34;ms&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>