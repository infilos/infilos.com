<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.4">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>CH17-ConcurrentHashMap | infilos.com</title><meta property="og:title" content="CH17-ConcurrentHashMap">
<meta property="og:description" content="HashTable 为什么慢 Hashtable 之所以效率低下主要是因为其实现使用了 synchronized 关键字对 put 等操作进行加锁，而 synchronized 关键字加锁是对整个对象示例进行加锁，也就是说在进行 put 等修改 Hash 表的操作时，锁住了整个 Hash 表，从而使得其表现的效率低下。
JDK 1.7-ConcurrentHashMap 在 JDK 1.5~1.7 版本，Java 使用了分段锁机制实现 ConcurrentHashMap。
  简而言之，ConcurrentHashMap 在对象中保存了一个 Segment 数组，即将整个 Hash 表划分为多个分段；
  而每个 Segment 元素，即每个分段则类似于一个 Hashtable；
  这样，在执行 put 操作时首先根据 hash 算法定位到元素属于哪个 Segment，然后对该 Segment 加锁即可。
  因此，ConcurrentHashMap 在多线程并发编程中可是实现多线程 put 操作。
  数据结构 整个 ConcurrentHashMap 由一个个 Segment 组成，Segment 代表”部分“或”一段“的意思，所以很多地方都会将其描述为分段锁。注意，行文中，我很多地方用了“槽”来代表一个 segment。
简单理解就是，ConcurrentHashMap 是一个 Segment 数组，Segment 通过继承 ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。">
<meta property="og:type" content="article">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch17-concurrenthashmap/"><meta property="article:section" content="编程语言">
<meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="CH17-ConcurrentHashMap">
<meta itemprop=description content="HashTable 为什么慢 Hashtable 之所以效率低下主要是因为其实现使用了 synchronized 关键字对 put 等操作进行加锁，而 synchronized 关键字加锁是对整个对象示例进行加锁，也就是说在进行 put 等修改 Hash 表的操作时，锁住了整个 Hash 表，从而使得其表现的效率低下。
JDK 1.7-ConcurrentHashMap 在 JDK 1.5~1.7 版本，Java 使用了分段锁机制实现 ConcurrentHashMap。
  简而言之，ConcurrentHashMap 在对象中保存了一个 Segment 数组，即将整个 Hash 表划分为多个分段；
  而每个 Segment 元素，即每个分段则类似于一个 Hashtable；
  这样，在执行 put 操作时首先根据 hash 算法定位到元素属于哪个 Segment，然后对该 Segment 加锁即可。
  因此，ConcurrentHashMap 在多线程并发编程中可是实现多线程 put 操作。
  数据结构 整个 ConcurrentHashMap 由一个个 Segment 组成，Segment 代表”部分“或”一段“的意思，所以很多地方都会将其描述为分段锁。注意，行文中，我很多地方用了“槽”来代表一个 segment。
简单理解就是，ConcurrentHashMap 是一个 Segment 数组，Segment 通过继承 ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。">
<meta itemprop=wordCount content="3411">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="CH17-ConcurrentHashMap">
<meta name=twitter:description content="HashTable 为什么慢 Hashtable 之所以效率低下主要是因为其实现使用了 synchronized 关键字对 put 等操作进行加锁，而 synchronized 关键字加锁是对整个对象示例进行加锁，也就是说在进行 put 等修改 Hash 表的操作时，锁住了整个 Hash 表，从而使得其表现的效率低下。
JDK 1.7-ConcurrentHashMap 在 JDK 1.5~1.7 版本，Java 使用了分段锁机制实现 ConcurrentHashMap。
  简而言之，ConcurrentHashMap 在对象中保存了一个 Segment 数组，即将整个 Hash 表划分为多个分段；
  而每个 Segment 元素，即每个分段则类似于一个 Hashtable；
  这样，在执行 put 操作时首先根据 hash 算法定位到元素属于哪个 Segment，然后对该 Segment 加锁即可。
  因此，ConcurrentHashMap 在多线程并发编程中可是实现多线程 put 操作。
  数据结构 整个 ConcurrentHashMap 由一个个 Segment 组成，Segment 代表”部分“或”一段“的意思，所以很多地方都会将其描述为分段锁。注意，行文中，我很多地方用了“槽”来代表一个 segment。
简单理解就是，ConcurrentHashMap 是一个 Segment 数组，Segment 通过继承 ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86>
<span>基础</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80>
<span>语言</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93>
<span>框架库</span>
</a>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e6%95%b0%e6%8d%ae%e6%b2%bb%e7%90%86>数据治理</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e7%94%a8%e6%88%b7%e7%b3%bb%e7%bb%9f>用户系统</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84>
<span>模式架构</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
</div>
<div id=content-desktop></div>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e7bc96e7a88be8afade8a880-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-e7bc96e7a88be8afade8a880><span>编程语言</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e7bc96e7a88be8afade8a880java-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880java><span>Java 编程</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880javajava-base-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-base><span>Java 基础</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech01-e99da2e59091e5afb9e8b1a1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch01-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech01-e99da2e59091e5afb9e8b1a1><span>CH01-面向对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech02-e59fbae69cace79fa5e8af86-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch02-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech02-e59fbae69cace79fa5e8af86><span>CH02-基本知识</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech03-e59fbae69cace59bbee8b0b1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch03-%E5%9F%BA%E6%9C%AC%E5%9B%BE%E8%B0%B1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech03-e59fbae69cace59bbee8b0b1><span>CH03-基本图谱</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech04-e6b39be59e8be69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch04-%E6%B3%9B%E5%9E%8B%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech04-e6b39be59e8be69cbae588b6><span>CH04-泛型机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech05-e6b3a8e8a7a3e69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch05-%E6%B3%A8%E8%A7%A3%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech05-e6b3a8e8a7a3e69cbae588b6><span>CH05-注解机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech06-e5bc82e5b8b8e69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch06-%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech06-e5bc82e5b8b8e69cbae588b6><span>CH06-异常机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech07-e58f8de5b084e69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch07-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech07-e58f8de5b084e69cbae588b6><span>CH07-反射机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech08-spie69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch08-spi%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech08-spie69cbae588b6><span>CH08-SPI 机制</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880javajava-collection-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-collection><span>Java 集合</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch01-e99b86e59088e7bb93e69e84-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch01-%E9%9B%86%E5%90%88%E7%BB%93%E6%9E%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch01-e99b86e59088e7bb93e69e84><span>CH01-集合结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch02-arraylist-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch02-arraylist/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch02-arraylist><span>CH02-ArrayList</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch03-linkedlist-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch03-linkedlist/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch03-linkedlist><span>CH03-LinkedList</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch04-stack-queue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch04-stack-queue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch04-stack-queue><span>CH04-Stack-Queue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch05-priorityqueue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch05-priorityqueue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch05-priorityqueue><span>CH05-PriorityQueue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch06-hashset-map-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch06-hashset-map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch06-hashset-map><span>CH06-HashSet-Map</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch07-linkedhashset-map-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch07-linkedhashset-map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch07-linkedhashset-map><span>CH07-LinkedHashSet-Map</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch08-treeset-map-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch08-treeset-map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch08-treeset-map><span>CH08-TreeSet-Map</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch09-weakhashmap-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch09-weakhashmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch09-weakhashmap><span>CH09-WeakHashMap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch10-stream-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch10-stream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch10-stream><span>CH10-Stream</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e7bc96e7a88be8afade8a880javajava-concurrent-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-concurrent><span>Java 并发</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch01-e5b9b6e58f91e4bd93e7b3bb-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch01-%E5%B9%B6%E5%8F%91%E4%BD%93%E7%B3%BB/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch01-e5b9b6e58f91e4bd93e7b3bb><span>CH01-并发体系</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch02-e79086e8aebae59fbae7a180-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch02-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch02-e79086e8aebae59fbae7a180><span>CH02-理论基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch03-e7babfe7a88be59fbae7a180-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch03-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch03-e7babfe7a88be59fbae7a180-1><span>CH03-线程基础-1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch04-e7babfe7a88be59fbae7a180-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch04-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch04-e7babfe7a88be59fbae7a180-2><span>CH04-线程基础-2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch05-synchronized-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch05-synchronized/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch05-synchronized><span>CH05-Synchronized</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch06-volatile-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch06-volatile/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch06-volatile><span>CH06-Volatile</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch07-final-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch07-final/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch07-final><span>CH07-Final</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch08-e5b9b6e58f91e6a682e8a788-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch08-%E5%B9%B6%E5%8F%91%E6%A6%82%E8%A7%88/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch08-e5b9b6e58f91e6a682e8a788><span>CH08-并发概览</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch09-e5ba95e5b182e694afe69291-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch09-%E5%BA%95%E5%B1%82%E6%94%AF%E6%92%91/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch09-e5ba95e5b182e694afe69291><span>CH09-底层支撑</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch10-locksupport-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch10-locksupport/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch10-locksupport><span>CH10-LockSupport</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch11-aqs-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch11-aqs-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch11-aqs-1><span>CH11-AQS-1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch12-aqs-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch12-aqs-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch12-aqs-2><span>CH12-AQS-2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch13-aqs-3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch13-aqs-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch13-aqs-3><span>CH13-AQS-3</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch14-aqs-4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch14-aqs-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch14-aqs-4><span>CH14-AQS-4</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch15-reentrantlock-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch15-reentrantlock/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch15-reentrantlock><span>CH15-ReentrantLock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch16-reentrantreadwritelock-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch16-reentrantreadwritelock/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch16-reentrantreadwritelock><span>CH16-ReentrantReadWriteLock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch17-concurrenthashmap-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch17-concurrenthashmap/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch17-concurrenthashmap><span class=td-sidebar-nav-active-item>CH17-ConcurrentHashMap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch18-concurrentlinkedqueue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch18-concurrentlinkedqueue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch18-concurrentlinkedqueue><span>CH18-ConcurrentLinkedQueue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch19-blockingqueue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch19-blockingqueue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch19-blockingqueue><span>CH19-BlockingQueue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch20-futuretask-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch20-futuretask/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch20-futuretask><span>CH20-FutureTask</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch21-threadpoolexecutor-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch21-threadpoolexecutor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch21-threadpoolexecutor><span>CH21-ThreadPoolExecutor</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch22-scheduledthreadpoolexecutor-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch22-scheduledthreadpoolexecutor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch22-scheduledthreadpoolexecutor><span>CH22-ScheduledThreadPoolExecutor</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch23-forkjoin-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch23-forkjoin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch23-forkjoin><span>CH23-ForkJoin.md</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch24-countdownlatch-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch24-countdownlatch/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch24-countdownlatch><span>CH24-CountDownLatch</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch25-cyclicbarrier-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch25-cyclicbarrier/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch25-cyclicbarrier><span>CH25-CyclicBarrier</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch26-semaphore-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch26-semaphore/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch26-semaphore><span>CH26-Semaphore</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch27-phaser-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch27-phaser/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch27-phaser><span>CH27-Phaser</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch28-exchanger-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch28-exchanger/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch28-exchanger><span>CH28-Exchanger</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch29-threadlocal-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch29-threadlocal/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch29-threadlocal><span>CH29-ThreadLocal</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch30-alllocks-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch30-alllocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch30-alllocks><span>CH30-AllLocks</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch31-allqueues-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch31-allqueues/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch31-allqueues><span>CH31-AllQueues</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch32-allpools-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch32-allpools/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch32-allpools><span>CH32-AllPools</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880javajava-io-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-io><span>Java I/0</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch01-ioe58886e7b1bb-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch01-io%E5%88%86%E7%B1%BB/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch01-ioe58886e7b1bb><span>CH01-IO分类</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch02-e8a385e9a5b0e6a8a1e5bc8f-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch02-%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch02-e8a385e9a5b0e6a8a1e5bc8f><span>CH02-装饰模式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch03-inputstream-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch03-inputstream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch03-inputstream><span>CH03-InputStream</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch04-outputstream-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch04-outputstream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch04-outputstream><span>CH04-OutputStream</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch05-e5b8b8e794a8e6938de4bd9c-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch05-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch05-e5b8b8e794a8e6938de4bd9c><span>CH05-常用操作.md</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch06-ioe5ae9ee78eb0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch06-io%E5%AE%9E%E7%8E%B0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch06-ioe5ae9ee78eb0><span>CH06-IO实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch07-ioe6a8a1e59e8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch07-io%E6%A8%A1%E5%9E%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch07-ioe6a8a1e59e8b><span>CH07-IO模型</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch08-bioe58e9fe79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch08-bio%E5%8E%9F%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch08-bioe58e9fe79086><span>CH08-BIO原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch09-nioe59fbae7a180-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch09-nio%E5%9F%BA%E7%A1%80/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch09-nioe59fbae7a180><span>CH09-NIO基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch10-nioe58e9fe79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch10-nio%E5%8E%9F%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch10-nioe58e9fe79086><span>CH10-NIO原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch11-aioe58e9fe79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch11-aio%E5%8E%9F%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch11-aioe58e9fe79086><span>CH11-AIO原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch12-e99bb6e68bb7e8b49d-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch12-%E9%9B%B6%E6%8B%B7%E8%B4%9D/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch12-e99bb6e68bb7e8b49d><span>CH12-零拷贝</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch13-e58685e5ad98e698a0e5b084-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch13-%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch13-e58685e5ad98e698a0e5b084><span>CH13-内存映射</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880javajava-effective-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-effective/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-effective><span>Java Effective</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880jvm-core-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-core><span>JVM 核心</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm><span>JVM Core</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch01-jvme6a682e8a788-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch01-jvm%E6%A6%82%E8%A7%88/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch01-jvme6a682e8a788><span>CH01-JVM概览</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch02-jvme5ad97e88a82e7a081-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch02-jvm%E5%AD%97%E8%8A%82%E7%A0%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch02-jvme5ad97e88a82e7a081><span>CH02-JVM字节码</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch03-jvme7b1bbe58aa0e8bdbd-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch03-jvm%E7%B1%BB%E5%8A%A0%E8%BD%BD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch03-jvme7b1bbe58aa0e8bdbd><span>CH03-JVM类加载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch04-jvme58685e5ad98e7bb93e69e84-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch04-jvm%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch04-jvme58685e5ad98e7bb93e69e84><span>CH04-JVM内存结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch05-jvme58685e5ad98e6a8a1e59e8b-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch05-jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch05-jvme58685e5ad98e6a8a1e59e8b-1><span>CH05-JVM内存模型-1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch06-jvme58685e5ad98e6a8a1e59e8b-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch06-jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch06-jvme58685e5ad98e6a8a1e59e8b-2><span>CH06-JVM内存模型-2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch07-jvme59e83e59cbee59b9ee694b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch07-jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch07-jvme59e83e59cbee59b9ee694b6><span>CH07-JVM垃圾回收</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch08-jvm-g1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch08-jvm-g1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch08-jvm-g1><span>CH08-JVM-G1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch09-jvm-zgc-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch09-jvm-zgc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch09-jvm-zgc><span>CH09-JVM-ZGC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch10-jvme8b083e4bc98e58f82e695b0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch10-jvm%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch10-jvme8b083e4bc98e58f82e695b0><span>CH10-JVM调优参数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch11-jvm-oom-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch11-jvm-oom/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch11-jvm-oom><span>CH11-JVM-OOM</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch12-jvme7babfe7a88bdump-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch12-jvm%E7%BA%BF%E7%A8%8Bdump/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch12-jvme7babfe7a88bdump><span>CH12-JVM线程Dump</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch13-jvme8b083e8af95e591bde4bba4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch13-jvm%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch13-jvme8b083e8af95e591bde4bba4><span>CH13-JVM调试命令</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch14-jvme8b083e8af95e5b7a5e585b7-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch14-jvm%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch14-jvme8b083e8af95e5b7a5e585b7><span>CH14-JVM调试工具</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch15-jvme58aa8e68081e8b083e8af95-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch15-jvm%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch15-jvme58aa8e68081e8b083e8af95><span>CH15-JVM动态调试</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133><span>JSR 133</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch01-e68c87e4bba4e9878de68e92-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch01-%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch01-e68c87e4bba4e9878de68e92><span>CH01-指令重排</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch02-e58685e5ad98e5b18fe99a9c-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch02-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch02-e58685e5ad98e5b18fe99a9c><span>CH02-内存屏障</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch03-e5a49ae5a484e79086e599a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch03-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch03-e5a49ae5a484e79086e599a8><span>CH03-多处理器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch04-e5bc80e58f91e68c87e58d97-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch04-%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch04-e5bc80e58f91e68c87e58d97><span>CH04-开发指南</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-spec-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-spec><span>JMM 规范</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch01-jmme8a784e88c83-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch01-jmm%E8%A7%84%E8%8C%83/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch01-jmme8a784e88c83><span>CH01-JMM规范</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch02-jmme8a7a3e9878a-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch02-jmm%E8%A7%A3%E9%87%8A/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch02-jmme8a7a3e9878a><span>CH02-JMM Explain</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch03-jmme58e9fe58899-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch03-jmm%E5%8E%9F%E5%88%99/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch03-jmme58e9fe58899><span>CH03-JMM原则</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch04-jsr133-faq-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch04-jsr133-faq/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch04-jsr133-faq><span>CH04-JSR133-FAQ</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch05-jsr133-cook-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch05-jsr133-cook/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch05-jsr133-cook><span>CH05-JSR133-Cook</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2><span>JVM 深入理解 V2</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch01-e8b5b0e8bf9bjava-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch01-%E8%B5%B0%E8%BF%9Bjava/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch01-e8b5b0e8bf9bjava><span>CH01-走近 Java</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch02-e58685e5ad98e58cbae59f9fe4b88ee6baa2e587bae5bc82e5b8b8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch02-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E4%B8%8E%E6%BA%A2%E5%87%BA%E5%BC%82%E5%B8%B8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch02-e58685e5ad98e58cbae59f9fe4b88ee6baa2e587bae5bc82e5b8b8><span>CH02-内存区域与溢出</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch03-e59e83e59cbee694b6e99b86e4b88ee58886e9858de7ad96e795a5-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch03-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E4%B8%8E%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch03-e59e83e59cbee694b6e99b86e4b88ee58886e9858de7ad96e795a5><span>CH03-垃圾收集与分配策略</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch04-e680a7e883bde79b91e68ea7e4b88ee69585e99a9ce5a484e79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch04-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch04-e680a7e883bde79b91e68ea7e4b88ee69585e99a9ce5a484e79086><span>CH04-性能监控与故障处理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch05-e8b083e4bc98e6a188e4be8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch05-%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch05-e8b083e4bc98e6a188e4be8b><span>CH05-调优案例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch06-e7b1bbe69687e4bbb6e7bb93e69e84-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch06-%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch06-e7b1bbe69687e4bbb6e7bb93e69e84><span>CH06-类文件结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch07-e7b1bbe58aa0e8bdbde69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch07-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch07-e7b1bbe58aa0e8bdbde69cbae588b6><span>CH07-类加载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch08-e5ad97e88a82e7a081e689a7e8a18ce5bc95e6938e-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch08-e5ad97e88a82e7a081e689a7e8a18ce5bc95e6938e><span>CH08-字节码执行引擎</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch09-e6a188e4be8be4b88ee5ae9ee68898-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch09-%E6%A1%88%E4%BE%8B%E4%B8%8E%E5%AE%9E%E6%88%98/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch09-e6a188e4be8be4b88ee5ae9ee68898><span>CH09-案例与实战</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch10-e7bc96e8af91e69c9fe4bc98e58c96-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch10-%E7%BC%96%E8%AF%91%E6%9C%9F%E4%BC%98%E5%8C%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch10-e7bc96e8af91e69c9fe4bc98e58c96><span>CH10-编译期优化</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch11-e8bf90e8a18ce697b6e4bc98e58c96-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch11-%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BC%98%E5%8C%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch11-e8bf90e8a18ce697b6e4bc98e58c96><span>CH11-运行时优化</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch12-e58685e5ad98e6a8a1e59e8be4b88ee7babfe7a88b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch12-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch12-e58685e5ad98e6a8a1e59e8be4b88ee7babfe7a88b><span>CH12-内存模型与线程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch13-e7babfe7a88be5ae89e585a8e4b88ee99481e4bc98e58c96-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch13-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch13-e7babfe7a88be5ae89e585a8e4b88ee99481e4bc98e58c96><span>CH13-线程安全与锁优化</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-b-e68c87e4bba4e8a1a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/endix-b-%E6%8C%87%E4%BB%A4%E8%A1%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-b-e68c87e4bba4e8a1a8><span>Endix-B-字节码指令</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-c-e58f82e695b0e8a1a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/endix-c-%E5%8F%82%E6%95%B0%E8%A1%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-c-e58f82e695b0e8a1a8><span>Endix-C-虚拟机参数</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v3><span>JVM 深入理解 V3</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880jvm-concurrent-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrent><span>JVM 并发</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practice-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practice><span>Java 并发实战</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech01-e7ae80e4bb8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch01-%E7%AE%80%E4%BB%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech01-e7ae80e4bb8b><span>CH01-简介</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech02-e7babfe7a88be5ae89e585a8e680a7-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch02-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech02-e7babfe7a88be5ae89e585a8e680a7><span>CH02-线程安全性</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech03-e5afb9e8b1a1e585b1e4baab-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch03-%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech03-e5afb9e8b1a1e585b1e4baab><span>CH03-对象共享</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech04-e5afb9e8b1a1e7bb84e59088-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch04-%E5%AF%B9%E8%B1%A1%E7%BB%84%E5%90%88/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech04-e5afb9e8b1a1e7bb84e59088><span>CH04-对象组合</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech05-e59fbae7a180e69e84e5bbbae59d97-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch05-%E5%9F%BA%E7%A1%80%E6%9E%84%E5%BB%BA%E5%9D%97/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech05-e59fbae7a180e69e84e5bbbae59d97><span>CH05-基础构建块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech06-e4bbbbe58aa1e689a7e8a18c-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch06-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech06-e4bbbbe58aa1e689a7e8a18c><span>CH06-任务执行</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech07-e58f96e6b688e585b3e997ad-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch07-%E5%8F%96%E6%B6%88%E5%85%B3%E9%97%AD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech07-e58f96e6b688e585b3e997ad><span>CH07-取消关闭</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech08-e7babfe7a88be6b1a0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch08-%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech08-e7babfe7a88be6b1a0><span>CH08-线程池</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech09-guie5ba94e794a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch09-gui%E5%BA%94%E7%94%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech09-guie5ba94e794a8><span>CH09-GUI应用</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech10-e6b4bbe8b783e680a7e58db1e999a9-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch10-%E6%B4%BB%E8%B7%83%E6%80%A7%E5%8D%B1%E9%99%A9/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech10-e6b4bbe8b783e680a7e58db1e999a9><span>CH10-活跃性危险</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech11-e680a7e883bde4b88ee4bcb8e7bca9-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch11-%E6%80%A7%E8%83%BD%E4%B8%8E%E4%BC%B8%E7%BC%A9/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech11-e680a7e883bde4b88ee4bcb8e7bca9><span>CH11-性能与伸缩</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech12-e6b58be8af95-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch12-%E6%B5%8B%E8%AF%95/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech12-e6b58be8af95><span>CH12-测试</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech13-e698bee5bc8fe99481-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch13-%E6%98%BE%E5%BC%8F%E9%94%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech13-e698bee5bc8fe99481><span>CH13-显式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech14-e887aae5ae9ae4b989e689a9e5b195-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch14-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech14-e887aae5ae9ae4b989e689a9e5b195><span>CH14-自定义扩展</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech15-e58e9fe5ad90e4b88ee99d9ee998bbe5a19ee5908ce6ada5-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch15-%E5%8E%9F%E5%AD%90%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech15-e58e9fe5ad90e4b88ee99d9ee998bbe5a19ee5908ce6ada5><span>CH15-原子与非阻塞同步</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech16-e58685e5ad98e6a8a1e59e8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch16-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech16-e58685e5ad98e6a8a1e59e8b><span>CH16-内存模型</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-pattern-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-pattern/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-pattern><span>Java 并发模式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallel-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallel><span>深入理解并行</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch01-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch01><span>CH01-关于本书</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch02-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch02><span>CH02-简介</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch03-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch03><span>CH03-硬件特性</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch04-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch04><span>CH04-并行工具</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch05-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch05><span>CH05-计数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch06-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch06><span>CH06-分割同步设计</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch07-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch07><span>CH07-锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch08-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch08><span>CH08-数据所有权</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch09-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch09><span>CH09-延后处理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch10-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch10><span>CH10-数据结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch11-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch11><span>CH11-验证</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch12-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch12><span>CH12-形式验证</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch13-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch13><span>CH13-综合应用</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch14-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch14><span>CH14-高级同步</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch15-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch15><span>CH15-高级同步-内存序</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelendix-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/endix/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelendix><span>ENDIX-C-内存屏障</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-model-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-model><span>七并发模型</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch01-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch01><span>CH01-概述</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch02-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch02><span>CH02-线程与锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch03-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch03><span>CH03-函数式编程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch04-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch04><span>CH04-分离标识与状态</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch05-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch05><span>CH05-Actor</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch06-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch06><span>CH06-CSP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch07-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch07><span>CH07-数据并行</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch08-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch08><span>CH08-Lambda 架构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch09-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch09><span>CH09-未来方向</span></a>
</li>
</ul>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880scala-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880scala><span>Scala 编程</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-core-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880scalascala-core><span>Scala 精要</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corecase-class-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/case-class/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corecase-class><span>Case Class</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-system-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-system/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-system><span>类型系统</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/functional-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-1><span>函数式-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/functional-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-2><span>函数式-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-1><span>Future-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-2><span>Future-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-3><span>Future-集合</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-4><span>Future-Promise</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/implicits-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-1><span>Implicits-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/implicits-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-2><span>Implicits-进阶</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/trait-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-1><span>Trait-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/trait-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-2><span>Trait-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coretry-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/try/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretry><span>Try</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-1><span>Type-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-2><span>Type-进阶</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreprimitive-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/primitive/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreprimitive><span>Primitive</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corenumbers-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/numbers/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corenumbers><span>Numbers</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corestrings-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/strings/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corestrings><span>String</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corecontrol-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/control/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corecontrol><span>Control</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corepattern-match-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/pattern-match/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corepattern-match><span>Pattern Match</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-1><span>Class Object: 基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-2><span>Class Object: 类</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-3><span>Class Object: 方法</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-4><span>Class Object: 对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-5-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-5><span>函数式对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-6><span>整体类层级</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-7-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-7><span>组合继承</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corepackage-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/package/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corepackage><span>Package</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coresbt-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/sbt/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coresbt><span>SBT</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corepredef-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/predef/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corepredef><span>Predef</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreio-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/io/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreio><span>I/O</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corereserved-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/reserved/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corereserved><span>保留字</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreexception-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/exception/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreexception><span>Exception</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreannotation-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/annotation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreannotation><span>Inject Type</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-class-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-class/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-class><span>Type Class</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coremap-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coremap><span>Map Flatmap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coregeneric-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/generic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coregeneric><span>泛型型变</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corecommon-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/common/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corecommon><span>常见问题</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreplaceholder-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/placeholder/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreplaceholder><span>占位符</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coremulti-vars-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/multi-vars/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coremulti-vars><span>多变量赋值</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreconstructor-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/constructor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreconstructor><span>构造器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/functional/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional><span>函数式入门</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coremonoid-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/monoid/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coremonoid><span>Monoid</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corefunc-type-class-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/func-type-class/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunc-type-class><span>函数式与类型类</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-coreasync-programming-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/async-programming/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreasync-programming><span>异步编程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-corescala-style-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/scala-style/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corescala-style><span>战略Scala风格</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-func-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880scalascala-func><span>Scala 函数式</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch00-e7b2bee8a681-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch00-%E7%B2%BE%E8%A6%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch00-e7b2bee8a681><span>CH00-精要</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch01-e5ae9ae4b989-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch01-%E5%AE%9A%E4%B9%89/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch01-e5ae9ae4b989><span>CH01-定义</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch02-e587bde695b0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch02-%E5%87%BD%E6%95%B0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch02-e587bde695b0><span>CH02-函数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch03-e695b0e68dae-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch03-%E6%95%B0%E6%8D%AE/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch03-e695b0e68dae><span>CH03-数据</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch04-e5bc82e5b8b8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch04-%E5%BC%82%E5%B8%B8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch04-e5bc82e5b8b8><span>CH04-异常</span></a>
</li>
</ul>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880rust-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/rust/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880rust><span>Rust 编程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880golang-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/golang/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880golang><span>Golang 编程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880frontend-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontend><span>前端技术栈</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880frontendbrowser-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/browser/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontendbrowser><span>浏览器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880frontendhtml-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/html/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontendhtml><span>HTML5</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880frontendcss-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/css/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontendcss><span>CSS3</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880frontendjavascript-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/javascript/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontendjavascript><span>JavaScript</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880frontendtypescript-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/typescript/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontendtypescript><span>TypeScript</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880frontendvue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/vue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontendvue><span>Vue 3</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880frontendreact-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/frontend/react/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880frontendreact><span>React</span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/infilos/infilos.com/edit/master/content/zh/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java/java-concurrent/CH17-ConcurrentHashMap.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/infilos/infilos.com/new/master/content/zh/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java/java-concurrent/CH17-ConcurrentHashMap.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/infilos/infilos.com/issues/new?title=CH17-ConcurrentHashMap" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#hashtable-为什么慢>HashTable 为什么慢</a></li>
<li><a href=#jdk-17-concurrenthashmap>JDK 1.7-ConcurrentHashMap</a>
<ul>
<li><a href=#数据结构>数据结构</a></li>
<li><a href=#初始化>初始化</a></li>
<li><a href=#put-过程分析>put 过程分析</a></li>
</ul>
</li>
<li><a href=#jdk-18-concurrenthashmap>JDK 1.8-ConcurrentHashMap</a>
<ul>
<li><a href=#数据结构-1>数据结构</a></li>
<li><a href=#初始化-1>初始化</a></li>
<li><a href=#put-过程分析-1>put 过程分析</a></li>
</ul>
</li>
<li><a href=#对比总结>对比总结</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/>编程语言</a>
</li>
<li class=breadcrumb-item>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/>Java 编程</a>
</li>
<li class=breadcrumb-item>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/>Java 并发</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch17-concurrenthashmap/>CH17-ConcurrentHashMap</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>CH17-ConcurrentHashMap</h1>
<header class=article-meta>
</header>
<h2 id=hashtable-为什么慢>HashTable 为什么慢</h2>
<p>Hashtable 之所以效率低下主要是因为其实现使用了 synchronized 关键字对 put 等操作进行加锁，而 synchronized 关键字加锁是对整个对象示例进行加锁，也就是说在进行 put 等修改 Hash 表的操作时，锁住了整个 Hash 表，从而使得其表现的效率低下。</p>
<h2 id=jdk-17-concurrenthashmap>JDK 1.7-ConcurrentHashMap</h2>
<p>在 JDK 1.5~1.7 版本，Java 使用了分段锁机制实现 ConcurrentHashMap。</p>
<ul>
<li>
<p>简而言之，ConcurrentHashMap 在对象中保存了一个 Segment 数组，即将整个 Hash 表划分为多个分段；</p>
</li>
<li>
<p>而每个 Segment 元素，即每个分段则类似于一个 Hashtable；</p>
</li>
<li>
<p>这样，在执行 put 操作时首先根据 hash 算法定位到元素属于哪个 Segment，然后对该 Segment 加锁即可。</p>
</li>
<li>
<p>因此，ConcurrentHashMap 在多线程并发编程中可是实现多线程 put 操作。</p>
</li>
</ul>
<h3 id=数据结构>数据结构</h3>
<p>整个 ConcurrentHashMap 由一个个 Segment 组成，Segment 代表”部分“或”一段“的意思，所以很多地方都会将其描述为分段锁。注意，行文中，我很多地方用了“槽”来代表一个 segment。</p>
<p>简单理解就是，ConcurrentHashMap 是一个 Segment 数组，Segment 通过继承 ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427214612.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>concurrencyLevel：并行级别、Segment 数量。</li>
<li>默认为 16，即拥有 16 个 segments，理论上同时支持 16 个线程并发写，只要它们的操作分布在不同的 Segment 上。</li>
<li>该值可以在初始化时设定为其他值，但是一点设置不可修改。</li>
<li>每个 Segment 内部类似于 HashMap，但通过继承 ReentrantLock 来保证线程安全。</li>
</ul>
<h3 id=初始化>初始化</h3>
<ul>
<li>initialCapacity: 初始容量，这个值指的是整个 ConcurrentHashMap 的初始容量，实际操作的时候需要平均分给每个 Segment。</li>
<li>loadFactor: 负载因子，之前我们说了，Segment 数量不可变，所以这个负载因子是给每个 Segment 内部使用的。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span>
                         <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>concurrencyLevel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>loadFactor</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>concurrencyLevel</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>concurrencyLevel</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_SEGMENTS</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>concurrencyLevel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MAX_SEGMENTS</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Find power-of-two sizes best matching arguments
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sshift</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 计算并行级别 ssize，因为要保持并行级别是 2 的 n 次方
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>concurrencyLevel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>sshift</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 我们这里先不要那么烧脑，用默认值，concurrencyLevel 为 16，sshift 为 4
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 那么计算出 segmentShift 为 28，segmentMask 为 15，后面会用到这两个值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segmentShift</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>32</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>sshift</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segmentMask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// initialCapacity 是设置整个 map 初始的大小，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这里根据 initialCapacity 计算 Segment 数组中每个位置可以分到的大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 如 initialCapacity 为 64，那么每个 Segment 或称之为&#34;槽&#34;可以分到 4 个
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>ssize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 默认 MIN_SEGMENT_TABLE_CAPACITY 是 2，这个值也是有讲究的，因为这样的话，对于具体的槽上，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 插入一个元素不至于扩容，插入第二个的时候才会扩容
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MIN_SEGMENT_TABLE_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 创建 Segment 数组，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 并创建数组的第一个元素 segment[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s0</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>),</span>
                         <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>cap</span><span style=color:#ce5c00;font-weight:700>]);</span>
    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>ssize</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#8f5902;font-style:italic>// 往数组写入 segment[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// ordered write of segments[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segments</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当使用无参构造器创建 ConcurrentHashMap 实例时，初始化完成后的状态如下：</p>
<ul>
<li>Segment 数组长度为 16，不可以扩容</li>
<li><code>Segment[i]</code> 的默认大小为 2，负载因子是 0.75，得出初始阈值为 1.5，也就是以后插入第一个元素不会触发扩容，插入第二个会进行第一次扩容</li>
<li>这里初始化了 <code>segment[0]</code>，其他位置还是 null，至于为什么要初始化 <code>segment[0]</code>，后面的代码会介绍</li>
<li>当前 segmentShift 的值为 32 - 4 = 28，segmentMask 为 16 - 1 = 15，姑且把它们简单翻译为移位数和掩码，这两个值马上就会用到</li>
</ul>
<h3 id=put-过程分析>put 过程分析</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 1. 计算 key 的 hash 值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 2. 根据 hash 值找到 Segment 数组中的位置 j
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    hash 是 32 位，无符号右移 segmentShift(28) 位，剩下高 4 位，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    然后和 segmentMask(15) 做一次与操作，也就是说 j 是 hash 值的高 4 位，也就是槽的数组下标
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>segmentShift</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>segmentMask</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 刚刚说了，初始化的时候初始化了 segment[0]，但是其他位置还是 null，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// ensureSegment(j) 对 segment[j] 进行初始化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span>          <span style=color:#8f5902;font-style:italic>// nonvolatile; recheck
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>segments</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//  in ensureSegment
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ensureSegment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 3. 插入新值到 槽 s 中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>第一层操作较简单，基于 hash 值找到对应的 segment，之后执行 segment 内部的 put 操作。</p>
<p>Segment 内部由 数组+链表 构成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 在往该 segment 写入前，需要先获取该 segment 的独占锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    先看主流程，后面还会具体介绍这部分内容
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tryLock</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>scanAndLockForPut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>V</span> <span style=color:#000>oldValue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这个是 segment 内部的数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 再利用 hash 值，求应该放置的数组下标
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// first 是数组该位置处的链表的表头
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entryAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// 下面这串 for 循环虽然很长，不过也很好理解，想想该位置没有任何元素和已经存在一个链表这两种情况
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>K</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 覆盖旧值
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 继续顺着链表走
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// node 到底是不是 null，这个要看获取锁的过程，不过和这里都没有关系。
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 如果不为 null，那就直接将它设置为链表表头；如果是null，初始化并设置为链表表头。
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 如果超过了该 segment 的阈值，这个 segment 需要扩容
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>rehash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 扩容后面也会具体分析
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#8f5902;font-style:italic>// 没有达到阈值，将 node 放到数组 tab 的 index 位置，
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 其实就是将新的节点设置成原链表的表头
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>setEntryAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldValue</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由于有独占锁的保护，所以 segment 内部的操作并不复杂。</p>
<p>下面为其中的关键函数：</p>
<h4 id=初始化槽ensuresegment>初始化槽：ensureSegment</h4>
<p>ConcurrentHashMap 初始化的时候会初始化第一个槽 <code>segment[0]</code>，对于其他槽来说，在插入第一个值的时候才进行初始化。</p>
<p>这里需要考虑并发，因为很可能会有多个线程同时进来初始化同一个槽 <code>segment[k]</code>，不过只要有一个成功了就可以。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ensureSegment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segments</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// raw offset
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>seg</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这里看到为什么之前要初始化 segment[0] 了，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 使用当前 segment[0] 处的数组长度和负载因子来初始化 segment[k]
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 为什么要用“当前”，因为 segment[0] 可能早就扩容过了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>proto</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>proto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>lf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>proto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadFactor</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>lf</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// 初始化 segment[k] 内部的数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>cap</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 再次检查一遍该槽是否被其他线程初始化了。
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>lf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 使用 while 循环，内部用 CAS，当前线程成功设值或其他线程成功设值后，退出
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span>
                   <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>seg</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于并发操作使用 CAS 进行控制。</p>
<h4 id=获取写入锁-scanandlockforput>获取写入锁: scanAndLockForPut</h4>
<p>在往某个 segment 中 put 的时候，首先会调用 <code>node = tryLock() ? null : scanAndLockForPut(key, hash, value)</code>，也就是说先进行一次 tryLock() 快速获取该 segment 的独占锁，如果失败，那么进入到 scanAndLockForPut 这个方法来获取锁。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scanAndLockForPut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entryForHash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// negative while locating node
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 循环获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>tryLock</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// to recheck first below
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// speculatively create node
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 进到这里说明数组该位置的链表是空的，没有任何元素
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 当然，进到这里的另一个原因是 tryLock() 失败，所以该槽存在并发，不一定是该位置
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>// 顺着链表往下走
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 重试次数如果超过 MAX_SCAN_RETRIES(单核1多核64)，那么不抢了，进入到阻塞队列等待锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//    lock() 是阻塞方法，直到获取锁后返回
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_SCAN_RETRIES</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                 <span style=color:#8f5902;font-style:italic>// 这个时候是有大问题了，那就是有新的元素进到了链表，成为了新的表头
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#8f5902;font-style:italic>//     所以这边的策略是，相当于重新走一遍这个 scanAndLockForPut 方法
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entryForHash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// re-traverse if entry changed
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法有两个出口，一个是 tryLock() 成功了，循环终止，另一个就是重试次数超过了 MAX_SCAN_RETRIES，进到 lock() 方法，此方法会阻塞等待，直到成功拿到独占锁。</p>
<p>这个方法就是看似复杂，但是其实就是做了一件事，那就是获取该 segment 的独占锁，如果需要的话顺便实例化了一下 node。</p>
<h4 id=扩容rehash>扩容：rehash</h4>
<ul>
<li>
<p>segment 数组不能扩容，扩容是 segment 数组某个位置内部的数组 <code>HashEntry&lt;K,V>[] </code> 进行扩容，扩容后，容量为原来的 2 倍。</p>
</li>
<li>
<p>执行 put 时，如果判断该值的插入会导致 segment 的元素个数超过阈值，需要先扩容再插入。</p>
</li>
</ul>
<p>因为这时已经持有了 segment 的独占锁，因此无需再考虑并发：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 方法参数上的 node 是这次扩容后，需要添加到新的数组中的数据。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rehash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>oldTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 2 倍
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建新数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>newTable</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>newCapacity</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#8f5902;font-style:italic>// 新的掩码，如从 16 扩容到 32，那么 sizeMask 为 31，对应二进制 ‘000...00011111’
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizeMask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 遍历原数组，老套路，将原数组位置 i 处的链表拆分到 新数组位置 i 和 i+oldCap 两个位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// e 是链表的第一个元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 计算应该放置在新数组中的位置，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 假设原数组长度为 16，e 在 oldTable[3] 处，那么 idx 只可能是 3 或者是 3 + 16 = 19
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#8f5902;font-style:italic>// 该位置处只有一个元素，那比较好办
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Reuse consecutive sequence at same slot
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// e 是链表表头
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// idx 是当前链表的头结点 e 的新位置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lastIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>idx</span><span style=color:#ce5c00;font-weight:700>;</span>

                <span style=color:#8f5902;font-style:italic>// 下面这个 for 循环会找到一个 lastRun 节点，这个节点之后的所有元素是将要放到一起的
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                     <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                     <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>lastIdx</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>lastIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 将 lastRun 及其之后的所有节点组成的这个链表放到 lastIdx 这个位置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>lastIdx</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 下面的操作是处理 lastRun 之前的节点，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//    这些节点可能分配在另一个链表中，也可能分配到上面的那个链表中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>V</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 将新来的 node 放到新数组中刚刚的 两个链表之一 的 头部
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nodeIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// add the new node
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>nodeIndex</span><span style=color:#ce5c00;font-weight:700>]);</span>
    <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>nodeIndex</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扩容过程中有两个 for 循环。如果没有第一个 for 循环也是可以工作的，但是在首个 for 循环中，如果 lastRun 的后面还有比较多的节点，那么首次循环就值得。因为我们要克隆 lastRun 前面的节点，后面的一串节点跟着 lastRun 走就可以了，无需其他操作。</p>
<p>比较坏的情况是每次 lastRun 都是链表的最后一个元素或者很靠后的元素，那么就会比较浪费。基于 Doug Lea 的说法，如果使用默认的阈值，大约只有 1/6 的节点需要克隆。</p>
<h4 id=get-过程分析>get 过程分析</h4>
<ul>
<li>计算 hash 值，找到 segment 的数组下标，得到 segment</li>
<li>segment 中也是一个数组，根据 hash 找到数据中的位置</li>
<li>得到链表，顺着链表查找即可</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// manually integrate access methods to reduce overhead
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 1. hash 值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>segmentShift</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>segmentMask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 2. 根据 hash 找到对应的 segment
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>segments</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 3. 找到segment 内部数组相应位置的链表，遍历
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span>
                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)(((</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>TSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>TBASE</span><span style=color:#ce5c00;font-weight:700>);</span>
             <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>K</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=并发问题分析>并发问题分析</h4>
<ul>
<li>
<p>注意 get 操作并未加锁。</p>
</li>
<li>
<p>添加节点的操作 put 和删除节点的操作 remove 都是要加 segment 上的独占锁的，所以它们之间自然不会有问题。</p>
</li>
<li>
<p>我们需要考虑的问题就是 get 的时候在同一个 segment 中发生了 put 或 remove 操作。</p>
</li>
<li>
<p>put 操作的安全性：</p>
<ul>
<li>初始化槽，这个我们之前就说过了，使用了 CAS 来初始化 Segment 中的数组。</li>
<li>添加节点到链表的操作是插入到表头的，所以，如果这个时候 get 操作在链表遍历的过程已经到了中间，是不会影响的。当然，另一个并发问题就是 get 操作在 put 之后，需要保证刚刚插入表头的节点被读取，这个依赖于 setEntryAt 方法中使用的 UNSAFE.putOrderedObject。</li>
<li>扩容。扩容是新创建了数组，然后进行迁移数据，最后面将 newTable 设置给属性 table。所以，如果 get 操作此时也在进行，那么也没关系，如果 get 先行，那么就是在旧的 table 上做查询操作；而 put 先行，那么 put 操作的可见性保证就是 table 使用了 volatile 关键字。</li>
</ul>
</li>
<li>
<p>remove 操作的线程安全性：</p>
<ul>
<li>get 操作需要遍历链表，但是 remove 操作会"破坏"链表。</li>
<li>如果 remove 破坏的节点 get 操作已经过去了，那么这里不存在任何问题。</li>
<li>如果 remove 先破坏了一个节点，分两种情况考虑。
<ul>
<li>1、如果此节点是头结点，那么需要将头结点的 next 设置为数组该位置的元素，table 虽然使用了 volatile 修饰，但是 volatile 并不能提供数组内部操作的可见性保证，所以源码中使用了 UNSAFE 来操作数组，请看方法 setEntryAt。</li>
<li>2、如果要删除的节点不是头结点，它会将要删除节点的后继节点接到前驱节点中，这里的并发保证就是 next 属性是 volatile 的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=jdk-18-concurrenthashmap>JDK 1.8-ConcurrentHashMap</h2>
<p>在 JDK 1.7 之前，ConcurrentHashMap 是通过分段锁机制来实现的，所以其最大并发度受 Segment 的个数限制。因此，在 JDK1.8 中，ConcurrentHashMap 的实现原理摒弃了这种设计，而是选择了与 HashMap 类似的数组+链表+红黑树的方式实现，而加锁则采用 CAS 和 synchronized 实现。</p>
<h3 id=数据结构-1>数据结构</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427224730.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=初始化-1>初始化</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 这构造函数里，什么都不干
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span>
               <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>:</span>
               <span style=color:#000>tableSizeFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cap</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过提供的初始容量，计算了 sizeCtl，<code>sizeCtl = 【 (1.5 * initialCapacity + 1)，然后向上取最近的 2 的 n 次方】</code>，如果 initialCapacity 为 10，那么得到 sizeCtl 为 16，如果 initialCapacity 为 11，sizeCtl 为 32。</p>
<h3 id=put-过程分析-1>put 过程分析</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>putVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>V</span> <span style=color:#000>putVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 得到 hash 值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 用于记录相应链表的长度
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fh</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果数组&#34;空&#34;，进行数组初始化
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 初始化数组，后面会详细介绍
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initTable</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// 找该 hash 值对应的数组下标，得到第一个节点 f
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 如果数组该位置为空，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//    用一次 CAS 操作将这个新值放入其中即可，这个 put 操作差不多就结束了，可以拉到最后面了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//          如果 CAS 失败，那就是有并发操作，进到下一个循环就好了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>casTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span>
                         <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>// no lock when adding to empty bin
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// hash 居然可以等于 MOVED，这个需要到后面才能看明白，不过从名字上也能猜到，肯定是因为在扩容
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MOVED</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 帮助数据迁移，这个等到看完数据迁移部分的介绍后，再理解这个就很简单了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>helpTransfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 到这里就是说，f 是该位置的头结点，而且不为空
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#000>V</span> <span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 获取数组该位置的头结点的监视器锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 头结点的 hash 值大于 0，说明是链表
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// 用于累加，记录链表的长度
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#8f5902;font-style:italic>// 遍历链表
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>binCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>K</span> <span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#8f5902;font-style:italic>// 如果发现了&#34;相等&#34;的 key，判断是否要进行值覆盖，然后也就可以 break 了
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                                <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span>
                                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#8f5902;font-style:italic>// 到了链表的最末端，将这个新值放到链表的最后面
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                          <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 红黑树
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#8f5902;font-style:italic>// 调用红黑树的插值方法插入新节点
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>putTreeVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                       <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span>
                                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 判断是否要将链表转换为红黑树，临界值和 HashMap 一样，也是 8
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>TREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#8f5902;font-style:italic>// 这个方法和 HashMap 中稍微有一点点不同，那就是它不是一定会进行红黑树转换，
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 如果当前数组的长度小于 64，那么会选择进行数组扩容，而不是转换为红黑树
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>//    具体源码我们就不看了，扩容部分后面说
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>treeifyBin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldVal</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>binCount</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=初始化数组inittable>初始化数组：initTable</h4>
<p>初始化一个合适大小的数组，然后会设置 sizeCtl。初始化方法中的并发问题通过对 sizeCtl 执行一个 CAS 操作来控制的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>initTable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 初始化的&#34;功劳&#34;被其他线程&#34;抢去&#34;了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeCtl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>yield</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// lost initialization race; just spin
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// CAS 一下，将 sizeCtl 设置为 -1，代表抢到了锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// DEFAULT_CAPACITY 默认初始容量是 16
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>DEFAULT_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 初始化数组，长度为 16 或初始化时提供的长度
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;[</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#8f5902;font-style:italic>// 将这个数组赋值给 table，table 是 volatile 的
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 如果 n 为 16 的话，那么这里 sc = 12
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 其实就是 0.75 * n
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 设置 sizeCtl 为 sc，我们就当是 12 吧
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=链表转红黑树treeifybin>链表转红黑树：treeifyBin</h4>
<p>treeifyBin 不一定就会进行红黑树转换，也可能是仅仅做数组扩容。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>treeifyBin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// MIN_TREEIFY_CAPACITY 为 64
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 所以，如果数组长度小于 64 的时候，其实也就是 32 或者 16 或者更小的时候，会进行数组扩容
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MIN_TREEIFY_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 后面我们再详细分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tryPresize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// b 是头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 加锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 下面就是遍历链表，建立一颗红黑树
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span>
                            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>,</span>
                                              <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#000>hd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>else</span>
                            <span style=color:#000>tl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>tl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 将红黑树设置到数组相应位置中
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hd</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=扩容trypresize>扩容：tryPresize</h4>
<p>扩容也是做翻倍扩容的，扩容后数组容量为原来的 2 倍。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 首先要说明的是，方法参数 size 传进来的时候就已经翻了倍了
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>tryPresize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// c: size 的 1.5 倍，再加 1，再往上取最近的 2 的 n 次方。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>tableSizeFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeCtl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 这个 if 分支和之前说的初始化数组的代码基本上是一样的，在这里，我们可以不用管这块代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;[</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>];</span>
                        <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 0.75 * n
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 我没看懂 rs 的真正含义是什么，不过也关系不大
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resizeStamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>RESIZE_STAMP_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>MAX_RESIZERS</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#000>transferIndex</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 2. 用 CAS 将 sizeCtl 加 1，然后执行 transfer 方法
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//    此时 nextTab 不为 null
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#000>transfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 1. 将 sizeCtl 设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//     我是没看懂这个值真正的意义是什么? 不过可以计算出来的是，结果是一个比较大的负数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//  调用 transfer 方法，此时 nextTab 参数为 null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span>
                                         <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>RESIZE_STAMP_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>transfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法的核心在于 sizeCtl 值的操作，首先将其设置为一个负数，然后执行 transfer(tab, null)，再下一个循环将 sizeCtl 加 1，并执行 transfer(tab, nt)，之后可能是继续 sizeCtl 加 1，并执行 transfer(tab, nt)。</p>
<p>所以，可能的操作就是执行 1 次 transfer(tab, null) + 多次 transfer(tab, nt)，这里怎么结束循环的需要看完 transfer 源码才清楚。</p>
<h4 id=数据迁移transfer>数据迁移：transfer</h4>
<p>将原来的 tab 数组的元素迁移到新的 nextTab 数组中。</p>
<p>虽然我们之前说的 tryPresize 方法中多次调用 transfer 不涉及多线程，但是这个 transfer 方法可以在其他地方被调用，典型地，我们之前在说 put 方法的时候就说过了，请往上看 put 方法，是不是有个地方调用了 helpTransfer 方法，helpTransfer 方法会调用 transfer 方法的。</p>
<p>此方法支持多线程执行，外围调用此方法的时候，会保证第一个发起数据迁移的线程，nextTab 参数为 null，之后再调用此方法的时候，nextTab 不会为 null。</p>
<p>阅读源码之前，先要理解并发操作的机制。原数组长度为 n，所以我们有 n 个迁移任务，让每个线程每次负责一个小任务是最简单的，每做完一个任务再检测是否有其他没做完的任务，帮助迁移就可以了，而 Doug Lea 使用了一个 stride，简单理解就是步长，每个线程每次负责迁移其中的一部分，如每次迁移 16 个小任务。所以，我们就需要一个全局的调度者来安排哪个线程执行哪几个任务，这个就是属性 transferIndex 的作用。</p>
<p>第一个发起数据迁移的线程会将 transferIndex 指向原数组最后的位置，然后从后往前的 stride 个任务属于第一个线程，然后将 transferIndex 指向新的位置，再往前的 stride 个任务属于第二个线程，依此类推。当然，这里说的第二个线程不是真的一定指代了第二个线程，也可以是同一个线程，这个读者应该能理解吧。其实就是将一个大的迁移任务分为了一个个任务包。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>transfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stride</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// stride 在单核下直接等于 n，多核模式下为 (n&gt;&gt;&gt;3)/NCPU，最小值是 16
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// stride 可以理解为”步长“，有 n 个位置是需要进行迁移的，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//   将这 n 个任务分为多个任务包，每个任务包有 stride 个任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MIN_TRANSFER_STRIDE</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MIN_TRANSFER_STRIDE</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// subdivide range
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 如果 nextTab 为 null，先进行一次初始化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    前面我们说了，外围会保证第一个发起迁移的线程调用此方法时，参数 nextTab 为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//       之后参与迁移的线程调用此方法时，nextTab 不会为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 容量翻倍
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;[</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#000>nextTab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#8f5902;font-style:italic>// try to cope with OOME
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// nextTable 是 ConcurrentHashMap 中的属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>nextTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// transferIndex 也是 ConcurrentHashMap 的属性，用于控制迁移的位置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>transferIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// ForwardingNode 翻译过来就是正在被迁移的 Node
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这个构造方法会生成一个Node，key、value 和 next 都为 null，关键是 hash 为 MOVED
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 后面我们会看到，原数组中位置 i 处的节点完成迁移工作后，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    就会将位置 i 处设置为这个 ForwardingNode，用来告诉其他线程该位置已经处理过了
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    所以它其实相当于是一个标志。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ForwardingNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fwd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForwardingNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>);</span>


    <span style=color:#8f5902;font-style:italic>// advance 指的是做完了一个位置的迁移工作，可以准备做下一个位置的了
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>finishing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// to ensure sweep before committing nextTab
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 下面这个 for 循环，最难理解的在前面，而要看懂它们，应该先看懂后面的，然后再倒回来看
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     */</span>

    <span style=color:#8f5902;font-style:italic>// i 是位置索引，bound 是边界，注意是从后往前
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fh</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 下面这个 while 真的是不好理解
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// advance 为 true 表示可以进行下一个位置的迁移了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   简单理解结局: i 指向了 transferIndex，bound 指向了 transferIndex-stride
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>advance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextBound</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>bound</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>finishing</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#8f5902;font-style:italic>// 将 transferIndex 值赋给 nextIndex
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 这里 transferIndex 一旦小于等于 0，说明原数组的所有位置都有相应的线程去处理了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transferIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span>
                     <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TRANSFERINDEX</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextIndex</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>nextBound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>?</span>
                                   <span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 看括号中的代码，nextBound 是这次迁移任务的边界，注意，是从后往前
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextBound</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>nextn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>finishing</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 所有的迁移操作已经完成
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>nextTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 将新的 nextTab 赋值给 table 属性，完成迁移
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 重新计算 sizeCtl: n 是原数组长度，所以 sizeCtl 得出的值将是新数组长度的 0.75 倍
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 之前我们说过，sizeCtl 在迁移前会设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 然后，每有一个线程参与迁移就会将 sizeCtl 加 1，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 这里使用 CAS 操作对 sizeCtl 进行减 1，代表做完了属于自己的任务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeCtl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 任务结束，方法退出
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>resizeStamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>RESIZE_STAMP_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>

                <span style=color:#8f5902;font-style:italic>// 到这里，说明 (sc - 2) == resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 也就是说，所有的迁移任务都做完了，也就会进入到上面的 if(finishing){} 分支了
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>finishing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// recheck before commit
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 如果位置 i 处是空的，没有任何节点，那么放入刚刚初始化的 ForwardingNode ”空节点“
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>casTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fwd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 该位置处是一个 ForwardingNode，代表该位置已经迁移过了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MOVED</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// already processed
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 对数组该位置处的结点加锁，开始处理数组该位置处的迁移工作
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 头结点的 hash 大于 0，说明是链表的 Node 节点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 下面这一块和 Java7 中的 ConcurrentHashMap 迁移是差不多的，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// 需要将链表一分为二，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//   找到原链表中的 lastRun，然后 lastRun 及其之后的节点是一起进行迁移的
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//   lastRun 之前的节点需要进行克隆，然后分到两个链表中
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runBit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>runBit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>runBit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runBit</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ph</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>K</span> <span style=color:#000>pk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>V</span> <span style=color:#000>pv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ph</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                                <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>else</span>
                                <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#8f5902;font-style:italic>// 其中的一个链表放在新数组的位置 i
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 另一个链表放在新数组的位置 i+n
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fwd</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// advance 设置为 true，代表该位置已经迁移完毕
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 红黑树的迁移
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>first</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
                                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>else</span>
                                    <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>else</span>
                                    <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>hc</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#8f5902;font-style:italic>// 如果一分为二后，节点数少于 8，那么将红黑树转换回链表
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>UNTREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>untreeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>UNTREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>untreeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#8f5902;font-style:italic>// 将 ln 放置在新数组的位置 i
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 将 hn 放置在新数组的位置 i+n
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fwd</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// advance 设置为 true，代表该位置已经迁移完毕
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>transfer 这个方法并没有实现所有的迁移任务，每次调用这个方法只实现了 transferIndex 往前 stride 个位置的迁移工作，其他的需要由外围来控制。</p>
<h4 id=get-过程分析-1>get 过程分析</h4>
<ul>
<li>计算 hash 值</li>
<li>根据 hash 值找到数组对应位置: <code>(n - 1) & h</code></li>
<li>根据该位置处结点性质进行相应查找
<ul>
<li>如果该位置为 null，那么直接返回 null 就可以了</li>
<li>如果该位置处的节点刚好就是我们需要的，返回该节点的值即可</li>
<li>如果该位置节点的 hash 值小于 0，说明正在扩容，或者是红黑树，后面我们再介绍 find 方法</li>
<li>如果以上 3 条都不满足，那就是链表，进行遍历比对即可</li>
</ul>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eh</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>K</span> <span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 判断头结点是否就是我们需要的节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>eh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 如果头结点的 hash 小于 0，说明 正在扩容，或者该位置是红黑树
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eh</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 参考 ForwardingNode.find(int h, Object k) 和 TreeBin.find(int h, Object k)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 遍历链表
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>))))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当遇到扩容时的情况最为复杂，<code>ForwardingNode.find(int h, Object k)</code>。</p>
<h2 id=对比总结>对比总结</h2>
<ul>
<li><code>HashTable</code>: 使用了synchronized关键字对put等操作进行加锁;</li>
<li><code>ConcurrentHashMap JDK1.7</code>: 使用分段锁机制实现;</li>
<li><code>ConcurrentHashMap JDK1.8</code>: 则使用数组+链表+红黑树数据结构和 CAS 原子操作实现;</li>
</ul>
<style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style>
<div class=d-print-none>
<h2 class=feedback--title>Feedback</h2>
<p class=feedback--question>Was this page helpful?</p>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
Glad to hear it! Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
Sorry to hear that. Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
</div>
<script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script>
<br>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>