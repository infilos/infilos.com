<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Java 编程 | infilos.com</title><meta property="og:title" content="Java 编程">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Java 编程">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Java 编程">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Java 编程</h1>
<ul>
<li>1: <a href=#pg-e87b3b7fc869ab22ead004d98918ad7c>Java 基础</a></li>
<ul>
<li>1.1: <a href=#pg-e1db212d12351161d48050f0f381f7c4>CH01-面向对象</a></li>
<li>1.2: <a href=#pg-f726ea2046bedecf6cb9f08310041837>CH02-基本知识</a></li>
<li>1.3: <a href=#pg-4cad2acc9d30ff525a7e1eaa4c81f679>CH03-基本图谱</a></li>
<li>1.4: <a href=#pg-b55749cae60e608c7ca23e6a61d68cb6>CH04-泛型机制</a></li>
<li>1.5: <a href=#pg-b8f50da20bead099ffecc9e2ee818530>CH05-注解机制</a></li>
<li>1.6: <a href=#pg-f947a3a008aa40dbb8eed80c6ed1d899>CH06-异常机制</a></li>
<li>1.7: <a href=#pg-1782eebed124e635eda873f42d596c92>CH07-反射机制</a></li>
<li>1.8: <a href=#pg-4a27de20847a48405d85a4161174c1ee>CH08-SPI 机制</a></li>
</ul>
<li>2: <a href=#pg-61a3edbc37a3608cfbaf7dad804b84bd>Java 集合</a></li>
<ul>
<li>2.1: <a href=#pg-9e8a75006f7a17815de402a2a07ceaac>CH01-集合结构</a></li>
<li>2.2: <a href=#pg-c93c4bd7f10427b83bf9de2474281b19>CH02-ArrayList</a></li>
<li>2.3: <a href=#pg-48df1d0ce925ac81862ec101158004e8>CH03-LinkedList</a></li>
<li>2.4: <a href=#pg-9fb71bee1e68918221ae7c442ef8c2ca>CH04-Stack-Queue</a></li>
<li>2.5: <a href=#pg-b005967a957a79af16207594d64d8017>CH05-PriorityQueue</a></li>
<li>2.6: <a href=#pg-2e9b99aead949946dd62cc48fdb4f247>CH06-HashSet-Map</a></li>
<li>2.7: <a href=#pg-53c5ba778adbb04df8b45622790f8231>CH07-LinkedHashSet-Map</a></li>
<li>2.8: <a href=#pg-15698d282bde407a6dd9a4f3fda4c629>CH08-TreeSet-Map</a></li>
<li>2.9: <a href=#pg-6e1572f092a2c17050b065aec05eb034>CH09-WeakHashMap</a></li>
<li>2.10: <a href=#pg-b2b28a2eeff762b18c922f48171f8dad>CH10-Stream</a></li>
</ul>
<li>3: <a href=#pg-34b8c6c9295ab5995cbcb2a295585d4d>Java 并发</a></li>
<ul>
<li>3.1: <a href=#pg-7c0490b6cdb7ff67c6be189f867105c9>CH01-并发体系</a></li>
<li>3.2: <a href=#pg-47303cc651e0cdd38490eb35615745c3>CH02-理论基础</a></li>
<li>3.3: <a href=#pg-e37fa685905d1de3dca2b32c7a1d0e1b>CH03-线程基础-1</a></li>
<li>3.4: <a href=#pg-b193d3d94478cbb7e17e200365b58990>CH04-线程基础-2</a></li>
<li>3.5: <a href=#pg-d431221e8f0cabe00d8d94b77f6e6ab6>CH05-Synchronized</a></li>
<li>3.6: <a href=#pg-1bbc182fc446a6c4b1996a26750fd077>CH06-Volatile</a></li>
<li>3.7: <a href=#pg-3ee11dea81baaca403c02e74956c78a2>CH07-Final</a></li>
<li>3.8: <a href=#pg-bdeadf7ccd90143ff9704fb345ad97ba>CH08-并发概览</a></li>
<li>3.9: <a href=#pg-c0f6f1f6840e7affc5155f762a8ba992>CH09-底层支撑</a></li>
<li>3.10: <a href=#pg-80db2b14f8c02e7be596869ece7d2a75>CH10-LockSupport</a></li>
<li>3.11: <a href=#pg-8409cde600ff510299cf0be846fd86ee>CH11-AQS-1</a></li>
<li>3.12: <a href=#pg-1817bd7cc3e3b8a48c6490f4219e8da5>CH12-AQS-2</a></li>
<li>3.13: <a href=#pg-46c6c26f99517b8b1d24f8fe1476db99>CH13-AQS-3</a></li>
<li>3.14: <a href=#pg-dab1ea524b05e9095151a5c2175bc241>CH14-AQS-4</a></li>
<li>3.15: <a href=#pg-6f7a32f3c6c9033077c88534df6ab468>CH15-ReentrantLock</a></li>
<li>3.16: <a href=#pg-3973541e40ecf4ca74f5e9d2cfa03450>CH16-ReentrantReadWriteLock</a></li>
<li>3.17: <a href=#pg-1b6eb5029cdf6629aa1d3fbdfb2fb794>CH17-ConcurrentHashMap</a></li>
<li>3.18: <a href=#pg-025dc4d4563b49f365f1ecc48d1d8dc5>CH18-ConcurrentLinkedQueue</a></li>
<li>3.19: <a href=#pg-3dcb9474214521fb1ab9ff953293cf08>CH19-BlockingQueue</a></li>
<li>3.20: <a href=#pg-040f5febb6255d9c7888a75b8f58a9cd>CH20-FutureTask</a></li>
<li>3.21: <a href=#pg-20c03470e3b1a36fc96b69d803819a88>CH21-ThreadPoolExecutor</a></li>
<li>3.22: <a href=#pg-4b544e8d51a8d75a0f871301e03607db>CH22-ScheduledThreadPoolExecutor</a></li>
<li>3.23: <a href=#pg-531d2ce180397e0c2a4d70c4932f0d30>CH23-ForkJoin.md</a></li>
<li>3.24: <a href=#pg-03c625b3fd7b9bdaaced3bd5f37d36c8>CH24-CountDownLatch</a></li>
<li>3.25: <a href=#pg-dd4e073fa96cad559cb8dc0524a1a9de>CH25-CyclicBarrier</a></li>
<li>3.26: <a href=#pg-b07a58fa9f4dedb54298bb2cc5da3439>CH26-Semaphore</a></li>
<li>3.27: <a href=#pg-37b34c6bdf5b51ec490dd5294c89141c>CH27-Phaser</a></li>
<li>3.28: <a href=#pg-5949ad95de6afb94293992fe672e0f6d>CH28-Exchanger</a></li>
<li>3.29: <a href=#pg-7104a341429a4837715bda5d8e0fc2ae>CH29-ThreadLocal</a></li>
<li>3.30: <a href=#pg-d4935211dbea06024564929059669c15>CH30-AllLocks</a></li>
<li>3.31: <a href=#pg-6f75fdfc530ef3161ca338cc2e0bacf9>CH31-AllQueues</a></li>
<li>3.32: <a href=#pg-61244711dda16339cd68d75d5b154f5f>CH32-AllPools</a></li>
</ul>
<li>4: <a href=#pg-d258b6789f677fa5b5591143fd8b88fc>Java I/0</a></li>
<ul>
<li>4.1: <a href=#pg-4173475665554ac72b162bd9e768d99b>CH01-IO分类</a></li>
<li>4.2: <a href=#pg-132757708b0e03054ccc15b1ccda9394>CH02-装饰模式</a></li>
<li>4.3: <a href=#pg-747966313cf609a9b480dcb72763161b>CH03-InputStream</a></li>
<li>4.4: <a href=#pg-4678bab34901a915f5377636d14003c8>CH04-OutputStream</a></li>
<li>4.5: <a href=#pg-3711fc47d4bd344e88d2c026371a33d2>CH05-常用操作.md</a></li>
<li>4.6: <a href=#pg-dc8da535c70e975714d2f9e3a34111ac>CH06-IO实现</a></li>
<li>4.7: <a href=#pg-312904add31ff8ea8730fec11cef07bc>CH07-IO模型</a></li>
<li>4.8: <a href=#pg-3d6330bcf4302926c8990d2573910e68>CH08-BIO原理</a></li>
<li>4.9: <a href=#pg-37086be27cb4e2dc026ba972768fcb2d>CH09-NIO基础</a></li>
<li>4.10: <a href=#pg-da781159746dd7bd152d97f3a8350579>CH10-NIO原理</a></li>
<li>4.11: <a href=#pg-e8064dcc899de72ab1295366b642e4a2>CH11-AIO原理</a></li>
<li>4.12: <a href=#pg-48dbf55268518f9a2344d8bbc9093d0f>CH12-零拷贝</a></li>
<li>4.13: <a href=#pg-4b8f0dd10f10472f6fce3d8242ba0444>CH13-内存映射</a></li>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-e87b3b7fc869ab22ead004d98918ad7c>1 - Java 基础</h1>
</div>
<div class=td-content>
<h1 id=pg-e1db212d12351161d48050f0f381f7c4>1.1 - CH01-面向对象</h1>
<h2 id=三大特性>三大特性</h2>
<h3 id=封装>封装</h3>
<p>利用抽象数据类型将数据和基于数据的操作封装在一起，使其构成一个不可分割的独立实体。数据被保护在抽象数据类型的内部，尽可能的隐藏内部的细节，只保留一些对外接口使其与外部发生关系。用户无需知道对象内部的细节，但可以通过对象所提供的接口来访问对象。</p>
<blockquote>
<p>优点：</p>
<ul>
<li>减少耦合：可以独立的开发、测试、优化、使用、理解、修改</li>
<li>减少维护负担：可以更容易的被其他开发者理解，并且在调试的时候可以不影响其他模块</li>
<li>有效的调节性能：可以通过剖析确定哪些模块影响了系统的性能</li>
<li>提高软件的可重用性</li>
<li>降低了构建大型系统的风险：即使整个系统不可用，但是这些独立的模块却有可能是可用的</li>
</ul>
</blockquote>
<h3 id=继承>继承</h3>
<p>继承实现了 IS-A 关系，比如 Cat 和 Animal 就是一种 IS-A 关系，因此 Cat 可以继承自 Animal，从而获得属于 Animal 的非私有的属性和方法。</p>
<p>继承应该遵循里氏替换原则，子类对象必须能够替换掉父类对象(可以直接将子类对象看做是父类对象)。</p>
<p>Cat 可以当做 Animal 来使用，也就是说可以使用 Animal 引用 Cat 对象。父类引用指向子类对象称为 <strong>向上转型</strong>。</p>
<h3 id=多态>多态</h3>
<p>多态分为编译时多态和运行时多态：</p>
<blockquote>
<ul>
<li>编译时多态主要指方法的重载</li>
<li>运行时多态指程序中定义的对象引用所指向的具体类型在运行期才确定</li>
</ul>
</blockquote>
<p>运行时多态有三个条件：</p>
<blockquote>
<ul>
<li>继承</li>
<li>覆写</li>
<li>向上转型</li>
</ul>
</blockquote>
<h2 id=类图>类图</h2>
<h3 id=泛化关系>泛化关系</h3>
<p>Java extend。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407001857.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=实现关系>实现关系</h3>
<p>Java implement。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407002106.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=聚合关系>聚合关系</h3>
<p>表示整体由部分组成，但是整体和部分不是强依赖，整体不存在了部分还会存在。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/image-20210407002223139.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=组合关系>组合关系</h3>
<p>和聚合不同，组合中整体和部分是强依赖的，整体不存在了部分也不存在了。比如公司和部门，公司没了部门就不存在了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407002455.png style=display:block;width:30% alt=NAME align=center> </div>
<h3 id=关联关系>关联关系</h3>
<p>表示不同类对象之间有关联，这是一种静态关系，与运行过程的状态无关，在最开始就是可以确定的。因此也可以用一对一、一对多、多对一、多对多这种表述来表示。</p>
<p>比如学生和学校就是一种关联关系，一个学校可以有多个学生，但是一个学生只属于一个学校，因此这是一种多对一关系，在运行开始就能确定。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407003751.png style=display:block;width:20% alt=NAME align=center> </div>
<h3 id=依赖关系>依赖关系</h3>
<p>依赖关系是在运行中起作用的。A 类对 B 类的依赖关系主要有三种形式：</p>
<blockquote>
<ul>
<li>A 类是 B 类中的局部变量</li>
<li>A 类是 B 类方法中的参数</li>
<li>A 类向 B 类发送消息，从而影响 B 类</li>
</ul>
</blockquote>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210407004935.png style=display:block;width:20% alt=NAME align=center> </div>
<p>Vihicle 的 move 方法接收一个 MoveBehavior 对象作为参数来实现移动逻辑，而 MoveBehavior 可能的实现是向上或向下移动。</p>
<h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://www.pdai.tech/md/java/basic/java-basic-oop.html>Java 基础 - 面向对象</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f726ea2046bedecf6cb9f08310041837>1.2 - CH02-基本知识</h1>
<h2 id=数据类型>数据类型</h2>
<h3 id=包装类型>包装类型</h3>
<p>八个基本类型：</p>
<blockquote>
<ul>
<li>boolean：1</li>
<li>byte：8</li>
<li>char：16</li>
<li>short：16</li>
<li>int：32</li>
<li>float：32</li>
<li>long：64</li>
<li>double：64</li>
</ul>
</blockquote>
<p>基本类型都拥有对应的包装类型，它们之间的赋值使用自动装箱与拆箱完成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Integer</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>	<span style=color:#8f5902;font-style:italic>// 装箱
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>			<span style=color:#8f5902;font-style:italic>// 拆箱
</span></code></pre></div><h3 id=缓存池>缓存池</h3>
<p><code>new Integer(21)</code> 与 <code>Integer.valueOf(21)</code> 的区别在于：</p>
<ul>
<li>前者每次都会创建一个新的对象</li>
<li>后者会使用缓存池中的对象，多次调用会获得同一个对象的引用</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Integer</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Integer</span> <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>);</span>	<span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Integer</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Integer</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>	<span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p><code>valueOf()</code> 方法的实现比较简单，它会先判断值是否在缓存池中，有则返回否则新建并返回。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Integer</span> <span style=color:#000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>IngegerCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>low</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>high</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>IntegerCache</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>IngegerCache</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>low</span><span style=color:#ce5c00;font-weight:700>)];</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 Java 8 中，Integer 缓存池的大小默认为 -128 至 127。</p>
<p>编译器会<strong>在缓冲池范围内的基本类型</strong>自动装箱过程中调用 <code>valueOf</code> 方法，因此多个取值相同的 Integer 实例在使用自动装箱来创建时，会引用相同的对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Integer</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Integer</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>基本类型对应的缓冲池如下：</p>
<blockquote>
<p>boolean: true, false</p>
<p>all byte values</p>
<p>short values between -128 to 127</p>
<p>int values between -128 to 127</p>
<p>char in range \u0000 to \u007F</p>
</blockquote>
<h2 id=string>String</h2>
<h3 id=概览>概览</h3>
<p>String 被声明为 final，因此不可被继承。</p>
<p>其内部使用 char 数组存储数据，该数据也被声明为 final，表示该 value 数组初始化之后便不能再被修改。并且没有提供修改该数组的方法，因此可以保证 String 不可变。</p>
<h3 id=不可变的好处>不可变的好处</h3>
<ol>
<li><strong>可以缓存哈希值</strong></li>
</ol>
<p>因为 String 的 hash 值经常被使用，比如 String 作为 HashMap 的 key。不可变使得其 hash 值也不会变，因此仅需计算一次。</p>
<ol start=2>
<li>String Pool 的需要</li>
</ol>
<p>如果一个 String 对象已经被创建过了，那么就会从 String Pool 中取得引用。只有 String 是不可变的，才可能使用 String Pool。</p>
<ol start=3>
<li>安全性</li>
</ol>
<p>String 经常被作为参数类型，String 不可变性可以保证参数不可变。</p>
<ol start=4>
<li>线程安全</li>
</ol>
<p>不可变特性天生具备线程安全性，可以在多个线程中并发使用。</p>
<blockquote>
<p><a href=https://www.programcreek.com/2013/04/why-string-is-immutable-in-java/>Program Creek: Why String is immutable in Java?</a></p>
</blockquote>
<h3 id=string-stringbuffer-string-builder>String, StringBuffer, String Builder</h3>
<ul>
<li>可变性
<ul>
<li>String 不可变</li>
<li>StringBuffer、StringBuilder 可变</li>
</ul>
</li>
<li>线程安全
<ul>
<li>String 不可变，即线程安全</li>
<li>StringBuilder 非线程安全</li>
<li>StringBuffer 保证线程安全，内部使用 synchronized 实现同步</li>
</ul>
</li>
</ul>
<blockquote>
<p><a href=https://stackoverflow.com/questions/2971315/string-stringbuffer-and-stringbuilder>StackOverflow : String, StringBuffer, and StringBuilder</a></p>
</blockquote>
<h3 id=stirngintern>Stirng.intern()</h3>
<p>使用 <code>Stirng.intern()</code> 可以保证相同内容的字符串变量引用同一个内存对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f57900>著作权归https:</span><span style=color:#8f5902;font-style:italic>//pdai.tech所有。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>链接</span><span style=color:#a40000>：</span><span style=color:#000>https</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#8f5902;font-style:italic>//www.pdai.tech/md/java/basic/java-basic-lan-basic.html
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>String</span> <span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aaa&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>String</span> <span style=color:#000>s2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aaa&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s2</span><span style=color:#ce5c00;font-weight:700>);</span>           <span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>String</span> <span style=color:#000>s3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intern</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intern</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s3</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>如果直接使用 <code>"bbb"</code> 这种形式而非 new 来创建字符串实例，会自动将其放入 String Pool 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>String</span> <span style=color:#000>s4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bbb&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>String</span> <span style=color:#000>s5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bbb&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s4</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s5</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>在 Java 7 之前，字符串常量池被放在运行时常量池中，属于永久代。在 Java 7 中，字符串常量池被移到 Native Method 中。这是因为永久代的空间有限，在大量使用字符串的场景下会导致 OOM。</p>
<blockquote>
<ul>
<li><a href=https://stackoverflow.com/questions/10578984/what-is-string-interning>What is Java String interning? - Stack Overflow</a></li>
<li><a href=https://tech.meituan.com/in_depth_understanding_string_intern.html>深入解析 String#intern (opens new window) (meituan.com)</a></li>
</ul>
</blockquote>
<h2 id=运算>运算</h2>
<h3 id=参数传递>参数传递</h3>
<p>Java 中的参数是以<strong>值传递</strong>的形式传入方法中，而不是引用传递。(这里的值值得是引用的地址值)</p>
<p>以下代码中，<code>Dog dog</code> 是一个指针，存储的是对象的地址值。在将一个参数传入一个方法时，本质上是将对象的地址以值的形式传递到形参中。因此在方法中改变指针引用的对象，那么这两个指针将指向不同的对象，一方改变自身指向的对象不会对另一方产生影响。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>String</span> <span style=color:#000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PassByValueExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@4554617c
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@4554617c
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>          <span style=color:#8f5902;font-style:italic>// A
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span> <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@4554617c
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;B&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectAddress</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// Dog@74a14482
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>          <span style=color:#8f5902;font-style:italic>// B
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是如果在方法中改变对象的字段值，则会改变原对象的字段值，因为改变的是同一个地址指向的内容。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PassByValueExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Dog</span> <span style=color:#000>dog</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>          <span style=color:#8f5902;font-style:italic>// B
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span> <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>dog</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;B&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p><a href=https://stackoverflow.com/questions/40480/is-java-pass-by-reference-or-pass-by-value>StackOverflow: Is Java “pass-by-reference” or “pass-by-value”? </a></p>
</blockquote>
<h3 id=float-与-double>float 与 double</h3>
<p><code>1.1</code> 这样的字面量属于 double 类型，不能直接将其赋值给 float 变量，因为是向下转型。Java 不能隐式执行向下转型，因为会使得精度降低。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>1</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// error
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>1f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// right
</span></code></pre></div><h3 id=隐式类型转换>隐式类型转换</h3>
<p>因为字面量 <code>1</code> 是 int 类型，它比 short 类型精度要高，因此不能隐式的将 int 类型向下转型为 short 类型。</p>
<p>但是使用 <code>+=</code> 运算可以执行隐式类型转换：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>short</span> <span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>// s1 = s1 + 1;
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>这其实相当于将 <code>s1 + 1</code> 的计算结果执行了向下转型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><blockquote>
<p><a href=https://stackoverflow.com/questions/8710619/why-dont-javas-compound-assignment-operators-require-casting>StackOverflow : Why don&rsquo;t Java&rsquo;s +=, -=, *=, /= compound assignment operators require casting? </a></p>
</blockquote>
<h3 id=switch>switch</h3>
<p>从 Java 7 开始，可以在 switch 条件判断语句中使用 String 对象。</p>
<p>Switch 不支持 long，是因为 switch 的设计初衷是对那些只有极少数的几个值进行等值判断，如果值的范围过大，那么还是使用 if 比较合适。</p>
<blockquote>
<p><a href=https://stackoverflow.com/questions/2676210/why-cant-your-switch-statement-data-type-be-long-java>Why can&rsquo;t your switch statement data type be long, Java? - Stack Overflow</a></p>
</blockquote>
<h2 id=继承>继承</h2>
<h3 id=访问权限>访问权限</h3>
<p>Java 中有三个访问权限修饰符：private、protected、public，如果不加访问修饰符，则表示 package 范围内可见。</p>
<p>可以对类或类中的成员(字段/方法)添加修饰符。</p>
<ul>
<li>类可见表示其他类可以用这类来创建实例对象。(即通过类来引用成员)</li>
<li>成员可见表示其他类可以用这个类的实例对象访问到该成员。(即通过类实例来引用成员)</li>
</ul>
<p>protected 用于修饰成员，表示在继承体系中成员对于子类可见，但是该修饰符对于类没有作用。</p>
<p>设计良好的模块会隐藏所有实现细节，将其 API 和实现细节清晰的隔离开来。模块之间仅通过他们的 API 进行通信，一个模块不需要知道其他模块内部的具体细节，这个概念被称为信息隐藏或封装。因此访问权限应当尽可能的使每个类或成员不被外界访问。</p>
<p>如果子类的方法重写了父类的方法，那么子类中该方法的访问级别不允许低于父类的访问级别。这是为了确保可以在使用父类实例的地方都能使用子类实例，即子类实例提供了父类应该具体的能力，即里氏替换原则。</p>
<p>字段决不能是 public，因为这么做就是去了对这个字段修改行为的控制，外部可以对其执行任意修改。</p>
<p>如果是 package 范围或私有的嵌套类，那么直接暴露成员不会有太大的影响。</p>
<h3 id=抽象类与接口>抽象类与接口</h3>
<ol>
<li>抽象类</li>
</ol>
<p>抽象类和抽象方法使用 abstract 关键字声明。抽象类一般会包含抽象方法，抽象方法一定位于抽象类中。</p>
<p>抽象类和普通类之间最大的区别是，抽象类不能被实例化，需要继承抽象类并实例化子类。</p>
<ol start=2>
<li>接口</li>
</ol>
<p>接口是抽象类型的延伸，在 Java 8 之前，可以看做是一个完全抽象的类，即不能拥有任何实现方法。</p>
<p>从 Java 8 开始，接口也可以拥有默认的实现方法，这是因为不支持默认方法的接口的维护成本太高了。在此之前，如果一个接口想要添加新方法，那么要修改所有实现了该接口的类。</p>
<p>接口的成员都是 public 可见，并且不允许定义为 private 或 protected。</p>
<p>接口的字段默认都是 static final 的，即静态的。</p>
<ol start=3>
<li>比较</li>
</ol>
<ul>
<li>从设计层面看，抽象类提供了 IS-A 关系，那么就必须满足里氏替换原则，即子类对象必须能够替换所有父类对象。
<ul>
<li>接口更像是 LIKE-A 关系，它只是提供一种方法实现契约，并不要求接口和实现接口的类具有 IS-A 关系。</li>
</ul>
</li>
<li>从使用上来看，一个类可以实现多个接口，但不能同时继承多个抽象类。</li>
<li>接口的字段只能是 static final，抽象类没有该限制。</li>
<li>即可的成员只能是 public 可见，而抽象类的成员可以有多种范围可见。</li>
</ul>
<ol start=4>
<li>选择</li>
</ol>
<p>使用接口：</p>
<ul>
<li>需要让不相关的类都都实现一个方法，比如无关的类都可以实现 Comparable 接口中的 compareTo 方法。</li>
<li>需要使用多重继承。</li>
</ul>
<p>使用抽象类：</p>
<ul>
<li>需要在几个相关的类中共享代码。</li>
<li>需要能够控制继承的成员的访问权限，而非均为 public。</li>
<li>需要集成非静态和非常量字段。</li>
</ul>
<p>在很多情况下，接口优先于抽象类，因为接口没有抽象类严格的类层次结构要求，可以灵活的为一个类添加行为。并且从 Java 8 开始，接口也可以有默认的实现方法，使得修改接口的成本降低。</p>
<blockquote>
<ul>
<li><a href=https://www.ibm.com/developerworks/cn/java/l-javainterface-abstract/>深入理解 abstract class 和 interface (opens new window) (ibm.com)</a></li>
<li><a href=https://dzone.com/articles/when-to-use-abstract-class-and-intreface>When to Use Abstract Class and Interface (opens new window) (dzone.com)</a></li>
</ul>
</blockquote>
<h3 id=super>super</h3>
<ul>
<li>访问父类的构造函数：从而委托父类完成一些初始化工作。</li>
<li>方位父类的成员：如果子类重写了父类的某个方法实现，则可以通过 super 来引用父类原有的方法实现。</li>
</ul>
<blockquote>
<p><a href=https://docs.oracle.com/javase/tutorial/java/IandI/super.html>Using the Keyword super (opens new window) (oracle.com)</a></p>
</blockquote>
<h3 id=重写与重载>重写与重载</h3>
<ol>
<li>重写(overwrite)</li>
</ol>
<p>存在与继承体系中，子类实现了与父类在方法声明上完全相同的一个方法。</p>
<p>为了满足里氏替换原则，重写必须有以下两个限制：</p>
<ul>
<li>子类方法的访问权限不能低于父类方法</li>
<li>子类方法的返回类型必须是父类方法返回类型的原类型或其子类型。</li>
</ul>
<p>使用 <code>@Overwrite</code> 注解可以通过编译器来检查这两个限制是否满足。</p>
<ol start=2>
<li>重载(overload)</li>
</ol>
<p>存在与同一个类中，指多个方法的名称相同，但是参数类型、个数、顺序至少有一个不同。</p>
<p>如果仅返回值不同，其他都相同，不能认为是重载。</p>
<h2 id=object-通用方法>Object 通用方法</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#000>Object</span> <span style=color:#000>clone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notify</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>()</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finalize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Throwable</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</code></pre></div><h3 id=equals>equals</h3>
<ol>
<li>
<p>等价关系</p>
<ul>
<li>自反性：<code>x.equals(x)</code> 为 true</li>
<li>对称性：<code>x.equals(y) == y.equals(x)</code> 为 true</li>
<li>传递性：<code>x.equals(y) && y.equals(z)</code> 则 <code>x.equals(z)</code> 为 true</li>
<li>一致性：多次调用 equals 方法的结果不会变化</li>
<li>与 null 比较：任何不为 null 的对象 x 调用 <code>x.equals(null)</code> 均为 false</li>
</ul>
</li>
<li>
<p>equals 与 ==</p>
<ul>
<li>对于基本类型，== 判断值是否相等，基本类型没有 equals 方法</li>
<li>对于引用类型，== 判断两变量的引用是否相等，而 equals 则判断引用的对象是否等价</li>
</ul>
</li>
<li>
<p>实现</p>
<ul>
<li>检查是否为同一个对象的引用，如果是则直接返回 true</li>
<li>检查是否为同一个类型，不同直接返回 false</li>
<li>将 Object 转型</li>
<li>判断每个关键域是否相等</li>
</ul>
</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EqualExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>EqualExample</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>z</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>EqualExample</span> <span style=color:#000>that</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EqualExample</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>z</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>z</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=hashcode>hashCode</h3>
<p>hashCode 返回哈希值，而 equals 用于判断两个对象是否等价。等价的两个对象的哈希值也一定相等，但是哈希值相等的两个对象不一定等价。</p>
<p>在重写 equals 方法时应当总是重写 hashCode 以确保等价对象的哈希值也一定相等。</p>
<p>理想的哈希函数应该具有均匀性，不相等的对象应该均匀分布到所有可能的哈希值上。这就要求哈希函数能把所有域的值都考虑进来，可以将每个域都当做 R 进制的某一位，然后组成一个 R 进制的整数。R 一般取 31，因为它是一个奇素数，如果是偶数的话，当出现乘法溢出，信息就会丢失，因为与 2 相乘相当于左移一位。</p>
<p>一个数与 31 相乘可以转换成移位和减法操作：<code>31*X == (X&lt;&lt;5)-X</code>，编译器会自动执行该优化。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>17</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>31</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>31</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>31</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=tostring>toString</h3>
<p>默认返回的是对象的内存地址，如 <code>ToStringExample@4554617c</code>，其中 <code>@</code> 符号后面的值为散列码的无符号十六进制表示。</p>
<h3 id=clone>Clone</h3>
<ol>
<li>cloneable</li>
</ol>
<p><code>clone()</code> 是 Object 对象的 protected 方法，并非 public，如果一个类不显式的重新 clone 方法，其他类就无法直接去调用该类实例的 clone 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CloneExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>CloneExample</span> <span style=color:#000>clone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CloneExample</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>CloneExample</span> <span style=color:#000>e1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CloneExample</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>CloneExample</span> <span style=color:#000>e2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// will throw: CloneNotSupportedException
</span></code></pre></div><p>直接调用重写后的 clone 方法会抛出以上异常，这是因为 CloneExample 并未实现 Cloneable 接口。</p>
<p>注意，clone 并非 Cloneable 接口的方法，而是 Object 的一个 protected 方法。Cloneable 只是规定了：如果一个类没有实现 Cloneable 接口，直接调用 clone 方法时就会抛出该异常。</p>
<ol start=2>
<li>浅拷贝</li>
</ol>
<p>拷贝对象和原始对象的引用类型引用同一个对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 像上面一样实现 Cloneable 接口并重写 clone 方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ShallowCloneExample</span> <span style=color:#000>e1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ShallowCloneExample</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ShallowCloneExample</span> <span style=color:#000>e2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#000>e2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>e1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>11</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><ol start=3>
<li>深拷贝</li>
</ol>
<p>拷贝对象和原始对象的引用类型引用不同对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DeepCloneExample</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Cloneable</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>DeepCloneExample</span> <span style=color:#000>clone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>CloneNotSupportException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>DeepCloneExample</span> <span style=color:#000>cloned</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DeepCloneExample</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clone</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
      <span style=color:#000>cloned</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]=</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cloned</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol start=4>
<li>clone 的替代方案</li>
</ol>
<p>使用 clone 方法来拷贝对象既复杂又有风险，可能会抛出异常，并且还需要类型转换。可以基于 Effective Java 中的建议，通过拷贝构造函数或拷贝工厂来拷贝一个对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CloneConstructorExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CloneConstructorExample</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CloneConstructorExample</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CloneConstructorExample</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>original</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=关键字>关键字</h2>
<h3 id=final>final</h3>
<ol>
<li>变量</li>
</ol>
<p>声明数据为常量，可以为编译时常量，也可以是在运行时被初始化后不能修改的常量。</p>
<ul>
<li>对于基本类型，fianl 使数值不变</li>
<li>对于引用类型，final 使引用不变，即不能被重新赋值为别的对象，但是所引用对象的值可以被修改</li>
</ul>
<ol start=2>
<li>方法</li>
</ol>
<p>声明的方法不能被子类重写。</p>
<p>被 private 修饰的方法隐式的被指定为 fianl，如果在子类中定义的方法和基类中某个 private 方法签名一样，此时子类的方法并被重写基类方法，而是在子类中重新定义了一个新的方法。</p>
<ol start=3>
<li>类</li>
</ol>
<p>声明类不能被继承。</p>
<h3 id=static>static</h3>
<ol>
<li>静态变量</li>
</ol>
<p>静态变量：又称为类变量，该变量属于类，而非该类的实例，类的所有实例都共享该变量，并通过类名来引用该变量，在内存中仅有一份。</p>
<p>实例变量：每创建一个实例就会产生一个实例变量，它与该实例同生共死。</p>
<ol start=2>
<li>静态方法</li>
</ol>
<p>静态方法在类加载的时候就存在了，它不依赖于任何实例。所以静态方法必须要实现，也就是说他不能抽象方法。</p>
<p>只能访问所属类的静态字段(变量)和静态方法，方法中不能有 this 和 super 关键字。</p>
<ol start=3>
<li>静态语句块</li>
</ol>
<p>静态语句块将在类初始化时执行一次。</p>
<ol start=4>
<li>静态内部类</li>
</ol>
<p>非静态内部类属于外部类的实例，而静态内部类属于外部类本身，通过外部类来引用该静态内部类。</p>
<ol start=5>
<li>静态导包</li>
</ol>
<p>通过静态导包，可以在使用静态变量和方法时不用再逐个指明 ClassName，可一件简化代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import static</span> <span style=color:#000>com.xxx.ClassName.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><ol start=6>
<li>初始化顺序</li>
</ol>
<p>静态变量和语句块优先于实例变量和普通语句块，它们的顺序由代码中的编写顺序决定。然后才是构造函数。</p>
<p>存在集成的情况下，初始化顺序为：</p>
<ul>
<li>父类(静态变量、静态语句块)</li>
<li>子类(静态变量、静态语句块)</li>
<li>父类(实例变量、普通语句块)</li>
<li>父类(构造函数)</li>
<li>子类(实例变量、普通语句块)</li>
<li>子类(构造函数)</li>
</ul>
<h2 id=反射>反射</h2>
<p>每个类都有一个 Class 对象，包含了与类有关的信息。当编译一个新类时，会产生一个同名的 class 文件，该文件内存保存着 Class 对象。</p>
<p>类加载相当于 Class 对象的加载。类在第一次使用时才会动态加载到 JVM 中，或者使用 <code>Class.forName(...)</code> 主动加载一个类，该方法会返回一个 Class 对象。</p>
<p>反射可以在运行时提供类的信息，并且该类可以在运行时才被加载进来，甚至在编译期该类的 class 尚不存在。</p>
<p>Class 和 java.lang.reflect 一起为反射提供了支持，java.lang.reflect 类库主要包括以下三个类：</p>
<ul>
<li>Field：可以使用 get 和 set 方法读取或修改 Field 对象关联的字段。</li>
<li>Method：可以使用 invoke 方法滴啊用与 Method 对象关联的方法。</li>
<li>Constructor：可以使用 Constructor 创建新的对象。</li>
</ul>
<p>高级用法：</p>
<ul>
<li>
<p><strong>Extensibility Features</strong> : An application may make use of external, user-defined classes by creating instances of extensibility objects using their fully-qualified names.</p>
</li>
<li>
<p><strong>Class Browsers and Visual Development Environments</strong> : A class browser needs to be able to enumerate the members of classes. Visual development environments can benefit from making use of type information available in reflection to aid the developer in writing correct code.</p>
</li>
<li>
<p><strong>Debuggers and Test Tools</strong> : Debuggers need to be able to examine private members on classes. Test harnesses can make use of reflection to systematically call a discoverable set APIs defined on a class, to insure a high level of code coverage in a test suite.</p>
</li>
</ul>
<p>反射的缺点：</p>
<p>反射虽然强大但不应被直接使用。如果能够在不使用反射的情况下完成操作，则应避免使用反射。使用反射时应注意以下几点：</p>
<ul>
<li><strong>Performance Overhead</strong> : Because reflection involves types that are dynamically resolved, certain Java virtual machine optimizations can not be performed. Consequently, reflective operations have slower performance than their non-reflective counterparts, and should be avoided in sections of code which are called frequently in performance-sensitive applications.</li>
<li><strong>Security Restrictions</strong> : Reflection requires a runtime permission which may not be present when running under a security manager. This is in an important consideration for code which has to run in a restricted security context, such as in an Applet.</li>
<li><strong>Exposure of Internals</strong> :Since reflection allows code to perform operations that would be illegal in non-reflective code, such as accessing private fields and methods, the use of reflection can result in unexpected side-effects, which may render code dysfunctional and may destroy portability. Reflective code breaks abstractions and therefore may change behavior with upgrades of the platform.</li>
</ul>
<blockquote>
<ul>
<li><a href=https://docs.oracle.com/javase/tutorial/reflect/index.html>Trail: The Reflection API (opens new window) (oracle.com)</a></li>
<li><a href=http://www.sczyh30.com/posts/Java/java-reflection-1/>深入解析 Java 反射—基础 (opens new window) (sczyh30.com)</a></li>
</ul>
</blockquote>
<h2 id=异常>异常</h2>
<p>Throwable 可以用来表示任何可以作为异常抛出的类，分为两种：Error 和 Exception。其中 Error 用来表示 JVM 无法处理的错误，Exception 分为两种：</p>
<ul>
<li>受检异常：需要 try&mldr;catch 语句捕获并进行处理，并且可以从异常中恢复。</li>
<li>非受检异常：程序运行时错误，比如除零操作会引起 ArithmeticException，这时程序崩溃且无法恢复。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210412231249.png style=display:block;width:50% alt=NAME align=center> </div>
<blockquote>
<ul>
<li><a href=https://www.tianmaying.com/tutorial/Java-Exception>Java 入门之异常处理 (opens new window) (tianmaying.com)</a></li>
<li><a href=http://www.importnew.com/7383.html>Java 异常的面试问题及答案 -Part 1(importnew.com)</a></li>
</ul>
</blockquote>
<h2 id=泛型>泛型</h2>
<blockquote>
<ul>
<li><a href=http://www.importnew.com/24029.html>Java 泛型详解(importnew.com)</a></li>
<li><a href=https://cloud.tencent.com/developer/article/1033693>10 道 Java 泛型面试题 (tencent.com)</a></li>
</ul>
</blockquote>
<h2 id=注解>注解</h2>
<p>Java 注解是附加在代码中的一些元信息，用于一些工具在编译期、运行时执行解析并使用，起到说明、配置的功能。注解不会也不应该影响代码的实际逻辑，仅仅起到辅助性的作用。</p>
<h2 id=特性>特性</h2>
<h3 id=版本特性>版本特性</h3>
<p><strong>Java 8</strong></p>
<ul>
<li>Lambda Expressions</li>
<li>Pipelines and Streams</li>
<li>Date and Time API</li>
<li>Default Methods</li>
<li>Type Annotations</li>
<li>Nashhorn JavaScript Engine</li>
<li>Concurrent Accumulators</li>
<li>Parallel operations</li>
<li>PermGen Error Removed</li>
</ul>
<p><strong>Java 7</strong></p>
<ul>
<li>
<p>Strings in Switch Statement</p>
</li>
<li>
<p>Type Inference for Generic Instance Creation</p>
</li>
<li>
<p>Multiple Exception Handling</p>
</li>
<li>
<p>Support for Dynamic Languages</p>
</li>
<li>
<p>Try with Resources</p>
</li>
<li>
<p>Java nio Package</p>
</li>
<li>
<p>Binary Literals, Underscore in literals</p>
</li>
<li>
<p>Diamond Syntax</p>
</li>
</ul>
<h3 id=与-c>与 C++</h3>
<ul>
<li>Java 是纯粹的面向对象语言，所有的对象都继承自 Object，C++ 为了兼容 C 同时支持面向对象和面向过程。</li>
<li>Java 通过虚拟机实现跨平台特性，但是 C++ 依赖于特定的平台。</li>
<li>Java 没有指针，其引用可以理解为安全指针，而 C++ 具有与 C 一样的指针。</li>
<li>Java 支持自动垃圾回收，而 C++ 需要手动回收。</li>
<li>Java 不支持多重继承，只能通过实现多个接口到达相同的目的，而 C++ 支持多重继承。</li>
<li>Java 不支持操作符重载，虽然可以对两个 String 对象执行加法运算，但是是语言内置的操作，不属于操作符重载，而 C++ 可以。</li>
<li>Java 的 goto 是保留字，不可以使用，C++ 可以使用。</li>
<li>Java 不支持条件编译，C++ 通过 <code>#ifdef #ifndef</code> 等预处理制冷可以实现条件编译。</li>
</ul>
<blockquote>
<ul>
<li><a href=http://cs-fundamentals.com/tech-interview/java/differences-between-java-and-cpp.php>What are the main differences between Java and C++? (cs-fundamentals.com)</a></li>
</ul>
</blockquote>
<h3 id=jre-与-jdk>JRE 与 JDK</h3>
<ul>
<li>JRE 是 JVM 程序，Java 应用需要运行在 JRE 之上。</li>
<li>JDK 是 JRE 的超集，带有 JRE 和用于编写 Java 程序的工具，比如 javac。</li>
</ul>
<h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://www.pdai.tech/md/java/basic/java-basic-lan-basic.html>Java 基础 - 知识点 (pdai.tech)</a></li>
<li>Eckel B. Java 编程思想. 机械工业出版社, 2002</li>
<li>Bloch J. Effective java. Addison-Wesley Professional, 2017</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4cad2acc9d30ff525a7e1eaa4c81f679>1.3 - CH03-基本图谱</h1>
<h2 id=概述>概述</h2>
<ul>
<li>术语
<ul>
<li>JDK：Java 开发者工具，Java Developer&rsquo;s Kit</li>
<li>JRE：Java 运行时环境，Java Runtime Environment</li>
<li>JVM：Java 虚拟机，Java Vitual Machine</li>
<li>API：应用程序编程接口，Application Programming Interface</li>
</ul>
</li>
<li>IDE
<ul>
<li>Eclipse</li>
<li>Intellij IDEA</li>
</ul>
</li>
<li>程序构造块
<ul>
<li>package</li>
<li>import</li>
<li>class</li>
<li>main</li>
<li>大括号</li>
<li>语句</li>
<li>注释</li>
</ul>
</li>
<li>工作方式
<ul>
<li>先编译后执行
<ul>
<li>Java 扩平台的根本</li>
<li>编译生成中间代码</li>
<li>JVM 加载执行中间代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=语言核心>语言核心</h2>
<h3 id=语言元素>语言元素</h3>
<ul>
<li>关键字：有特殊含义的单词
<ul>
<li>48 个可用</li>
<li>2 个保留：goto，const</li>
</ul>
</li>
<li>标识符
<ul>
<li>字符、数字、下划线、<code>$</code></li>
<li>不能以数字开头</li>
<li>不能有<code>!</code>等特殊字符</li>
<li>不能是关键字</li>
<li>大小写敏感</li>
<li>驼峰风格</li>
</ul>
</li>
<li>运算符
<ul>
<li>赋值：<code>=</code></li>
<li>算术：<code>+,-,*,/,%</code></li>
<li>关系：<code>>,&lt;,>=,&lt;=,!=,==</code></li>
<li>短路：<code>&&,||</code></li>
<li>三目：<code>..?..:..</code></li>
<li>逻辑：<code>&,|,!</code></li>
<li>自增/减运：<code>++,--</code></li>
<li>下标运：<code>[]</code></li>
<li>类型运：<code>(ClassName)</code></li>
<li>其他：
<ul>
<li>new</li>
<li>instanceOf</li>
<li>位与</li>
<li>访问成员</li>
</ul>
</li>
</ul>
</li>
<li>字面量：
<ul>
<li>整形：122</li>
<li>实数：3.14，2.1E-3</li>
<li>字符：<code>'a'</code></li>
<li>字符串：<code>"b"</code></li>
<li>布尔：true</li>
<li>引用：null</li>
<li>类型：<code>int.class, String.class</code></li>
</ul>
</li>
<li>分隔符</li>
</ul>
<h3 id=变量常量>变量/常量</h3>
<h3 id=数据类型>数据类型</h3>
<ul>
<li>基本类型：
<ul>
<li>byte-1</li>
<li>short-2</li>
<li>int-4</li>
<li>long-8</li>
<li>float-4</li>
<li>double-8</li>
<li>boolean</li>
<li>char-2</li>
</ul>
</li>
<li>枚举类型：符号常量</li>
<li>引用类型：对象</li>
</ul>
<h2 id=字符串>字符串</h2>
<ul>
<li>创建
<ul>
<li><code>String str = new String("abc")</code></li>
<li><code>String str = "abc";</code></li>
</ul>
</li>
<li>操作</li>
</ul>
<h2 id=数组>数组</h2>
<ul>
<li>一维数组：<code>int[] a = [1,2,3]</code></li>
<li>二维数组：<code>int[][] a = [[1,2,3],[4,5,6]]</code></li>
</ul>
<h2 id=循环>循环</h2>
<ul>
<li>
<p>for</p>
</li>
<li>
<p>while</p>
</li>
<li>
<p>do-while</p>
</li>
</ul>
<h2 id=分支>分支</h2>
<ul>
<li>if-else</li>
<li>switch-case</li>
</ul>
<h2 id=faq>FAQ</h2>
<h3 id=使用哪种数据类型表示价格>使用哪种数据类型表示价格</h3>
<p>如果不是特别关心内存和性能的话，使用BigDecimal，否则使用预定义精度的 double 类型。</p>
<h3 id=怎么将-byte-转换为-string>怎么将 byte 转换为 String</h3>
<p>可以使用 String 接收 byte[] 参数的构造器来进行转换，需要注意的点是要使用的正确的编码，否则会使用平台默认编码，这个编码可能跟原来的编码相同，也可能不同。</p>
<h3 id=java-中怎样将-bytes-转换为-long-类型>Java 中怎样将 bytes 转换为 long 类型</h3>
<p>String接收bytes的构造器转成String，再 Long.parseLong。</p>
<h3 id=我们能将-int-强制转换为-byte-类型的变量吗>我们能将 int 强制转换为 byte 类型的变量吗</h3>
<p>是的，我们可以做强制转换，但是 Java 中 int 是 32 位的，而 byte 是 8 位的，所以，如果强制转化是，int 类型的高 24 位将会被丢弃，byte 类型的范围是从 -128 到 127。</p>
<h3 id=存在两个类b-继承-ac-继承-b我们能将-b-转换为-c-么-如-c--c-b>存在两个类，B 继承 A，C 继承 B，我们能将 B 转换为 C 么? 如 C = (C) B</h3>
<p>可以，向下转型。但是不建议使用，容易出现类型转型异常.</p>
<h3 id=哪个类包含-clone-方法-是-cloneable-还是-object>哪个类包含 clone 方法? 是 Cloneable 还是 Object?</h3>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/java/basic/java-basic-lan-sum.html</p>
<p>java.lang.Cloneable 是一个标示性接口，不包含任何方法，clone 方法在 object 类中定义。并且需要知道 clone() 方法是一个本地方法，这意味着它是由 c 或 c++ 或 其他本地语言实现的。</p>
<h3 id=java-中--操作符是线程安全的吗>Java 中 ++ 操作符是线程安全的吗?</h3>
<p>不是线程安全的操作。它涉及到多个指令，如读取变量值，增加，然后存储回内存，这个过程可能会出现多个线程交差。还会存在竞态条件(读取-修改-写入)。</p>
<h3 id=a--a--b-与-a--b-的区别>a = a + b 与 a += b 的区别</h3>
<p>+= 隐式的将加操作的结果类型强制转换为持有结果的类型。如果两这个整型相加，如 byte、short 或者 int，首先会将它们提升到 int 类型，然后在执行加法操作。</p>
<h3 id=我能在不进行强制转换的情况下将一个-double-值赋值给-long-类型的变量吗>我能在不进行强制转换的情况下将一个 double 值赋值给 long 类型的变量吗?</h3>
<p>不行，你不能在没有强制类型转换的前提下将一个 double 值赋值给 long 类型的变量，因为 double 类型的范围比 long 类型更广，所以必须要进行强制转换。</p>
<h3 id=301--03-将会返回什么-true-还是-false>3*0.1 == 0.3 将会返回什么? true 还是 false?</h3>
<p>false，因为有些浮点数不能完全精确的表示出来。</p>
<h3 id=int-和-integer-哪个会占用更多的内存>int 和 Integer 哪个会占用更多的内存?</h3>
<p>Integer 对象会占用更多的内存。Integer 是一个对象，需要存储对象的元数据。但是 int 是一个原始类型的数据，所以占用的空间更少。</p>
<h3 id=为什么-java-中的-string-是不可变的immutable>为什么 Java 中的 String 是不可变的(Immutable)?</h3>
<p>Java 中的 String 不可变是因为 Java 的设计者认为字符串使用非常频繁，将字符串设置为不可变可以允许多个客户端之间共享相同的字符串。更详细的内容参见答案。</p>
<h3 id=我们能在-switch-中使用-string-吗>我们能在 Switch 中使用 String 吗?</h3>
<p>从 Java 7 开始，我们可以在 switch case 中使用字符串，但这仅仅是一个语法糖。内部实现在 switch 中使用字符串的 hash code。</p>
<h3 id=java-中的构造器链是什么>Java 中的构造器链是什么?</h3>
<p>当你从一个构造器中调用另一个构造器，就是Java 中的构造器链。这种情况只在重载了类的构造器的时候才会出现。</p>
<h3 id=枚举类>枚举类</h3>
<p>JDK1.5出现 每个枚举值都需要调用一次构造函数</p>
<h3 id=什么是不可变对象immutable-object-java-中怎么创建一个不可变对象>什么是不可变对象(immutable object)? Java 中怎么创建一个不可变对象?</h3>
<p>不可变对象指对象一旦被创建，状态就不能再改变。任何修改都会创建一个新的对象，如 String、Integer及其它包装类。</p>
<ul>
<li>对象的状态在创建之后就不能发生改变，任何对它的改变都应该产生一个新的对象。</li>
<li>类的所有的属性都应该是final的。</li>
<li>对象必须被正确的创建，比如: 对象引用在对象创建过程中不能泄露(leak)。</li>
<li>对象应该是final的，以此来限制子类继承父类，以避免子类改变了父类的immutable特性。</li>
<li>如果类中包含mutable类对象，那么返回给客户端的时候，返回该对象的一个拷贝，而不是该对象本身(该条可以归为第一条中的一个特例)</li>
</ul>
<h3 id=我们能创建一个包含可变对象的不可变对象吗>我们能创建一个包含可变对象的不可变对象吗?</h3>
<p>是的，我们是可以创建一个包含可变对象的不可变对象的，你只需要谨慎一点，不要共享可变对象的引用就可以了，如果需要变化时，就返回原对象的一个拷贝。最常见的例子就是对象中包含一个日期对象的引用。</p>
<h3 id=有没有可能两个不相等的对象有有相同的-hashcode>有没有可能两个不相等的对象有有相同的 hashcode?</h3>
<p>有可能，两个不相等的对象可能会有相同的 hashcode 值，这就是为什么在 hashmap 中会有冲突。相等 hashcode 值的规定只是说如果两个对象相等，必须有相同的hashcode 值，但是没有关于不相等对象的任何规定。</p>
<h3 id=两个相同的对象会有不同的的-hash-code-吗>两个相同的对象会有不同的的 hash code 吗?</h3>
<p>不能，根据 hash code 的规定，这是不可能的。</p>
<h3 id=我们可以在-hashcode-中使用随机数字吗>我们可以在 hashcode() 中使用随机数字吗?</h3>
<p>不行，因为对象的 hashcode 值必须是相同的。</p>
<h3 id=java-中comparator-与-comparable-有什么不同>Java 中，Comparator 与 Comparable 有什么不同?</h3>
<p>Comparable 接口用于定义对象的自然顺序，而 comparator 通常用于定义用户定制的顺序。Comparable 总是只有一个，但是可以有多个 comparator 来定义对象的顺序。</p>
<h3 id=为什么在重写-equals-方法的时候需要重写-hashcode-方法>为什么在重写 equals 方法的时候需要重写 hashCode 方法?</h3>
<p>因为有强制的规范指定需要同时重写 hashcode 与 equal 是方法，许多容器类，如 HashMap、HashSet 都依赖于 hashcode 与 equals 的规定。</p>
<h3 id=ab和aequalsb有什么区别>“a==b”和”a.equals(b)”有什么区别?</h3>
<p>如果 a 和 b 都是对象，则 a==b 是比较两个对象的引用，只有当 a 和 b 指向的是堆中的同一个对象才会返回 true，而 a.equals(b) 是进行逻辑比较，所以通常需要重写该方法来提供逻辑一致性的比较。例如，String 类重写 equals() 方法，所以可以用于两个不同对象，但是包含的字母相同的比较。</p>
<h3 id=ahashcode-有什么用-与-aequalsb-有什么关系>a.hashCode() 有什么用? 与 a.equals(b) 有什么关系?</h3>
<p>hashCode() 方法是相应对象整型的 hash 值。它常用于基于 hash 的集合类，如 Hashtable、HashMap、LinkedHashMap等等。</p>
<p>它与 equals() 方法关系特别紧密。根据 Java 规范，两个使用 equal() 方法来判断相等的对象，必须具有相同的 hash code。</p>
<h3 id=finalfinalize-和-finally-的不同之处>final、finalize 和 finally 的不同之处?</h3>
<ul>
<li>final 是一个修饰符，可以修饰变量、方法和类。如果 final 修饰变量，意味着该变量的值在初始化后不能被改变。</li>
<li>Java 技术允许使用 finalize() 方法在垃圾收集器将对象从内存中清除出去之前做必要的清理工作。这个方法是由垃圾收集器在确定这个对象没有被引用时对这个对象调用的，但是什么时候调用 finalize 没有保证。</li>
<li>finally 是一个关键字，与 try 和 catch 一起用于异常的处理。finally 块一定会被执行，无论在 try 块中是否有发生异常。</li>
</ul>
<h3 id=java-中的编译期常量是什么-使用它又什么风险>Java 中的编译期常量是什么? 使用它又什么风险?</h3>
<p>变量也就是我们所说的编译期常量，这里的 public 可选的。实际上这些变量在编译时会被替换掉，因为编译器知道这些变量的值，并且知道这些变量在运行时不能改变。这种方式存在的一个问题是你使用了一个内部的或第三方库中的公有编译时常量，但是这个值后面被其他人改变了，但是你的客户端仍然在使用老的值，甚至你已经部署了一个新的jar。为了避免这种情况，当你在更新依赖 JAR 文件时，确保重新编译你的程序。</p>
<h3 id=静态内部类与顶级类有什么区别>静态内部类与顶级类有什么区别?</h3>
<p>一个公共的顶级类的源文件名称与类名相同，而嵌套静态类没有这个要求。一个嵌套类位于顶级类内部，需要使用顶级类的名称来引用嵌套静态类，如 HashMap.Entry 是一个嵌套静态类，HashMap 是一个顶级类，Entry是一个嵌套静态类。</p>
<h3 id=java-中serializable-与-externalizable-的区别>Java 中，Serializable 与 Externalizable 的区别?</h3>
<p>Serializable 接口是一个序列化 Java 类的接口，以便于它们可以在网络上传输或者可以将它们的状态保存在磁盘上，是 JVM 内嵌的默认序列化方式，成本高、脆弱而且不安全。Externalizable 允许你控制整个序列化过程，指定特定的二进制格式，增加安全机制。</p>
<h3 id=说出-jdk-17-中的三个新特性>说出 JDK 1.7 中的三个新特性?</h3>
<p>虽然 JDK 1.7 不像 JDK 5 和 8 一样的大版本，但是，还是有很多新的特性，如 try-with-resource 语句，这样你在使用流或者资源的时候，就不需要手动关闭，Java 会自动关闭。Fork-Join 池某种程度上实现 Java 版的 Map-reduce。允许 Switch 中有 String 变量和文本。菱形操作符(&lt;>)用于泛型推断，不再需要在变量声明的右边申明泛型，因此可以写出可读写更强、更简洁的代码。另一个值得一提的特性是改善异常处理，如允许在同一个 catch 块中捕获多个异常。</p>
<h3 id=说出-5-个-jdk-18-引入的新特性>说出 5 个 JDK 1.8 引入的新特性?</h3>
<p>Java 8 在 Java 历史上是一个开创新的版本，下面 JDK 8 中 5 个主要的特性: Lambda 表达式，允许像对象一样传递匿名函数 Stream API，充分利用现代多核 CPU，可以写出很简洁的代码 Date 与 Time API，最终，有一个稳定、简单的日期和时间库可供你使用 扩展方法，现在，接口中可以有静态、默认方法。 重复注解，现在你可以将相同的注解在同一类型上使用多次。</p>
<p>下述包含 Java 面试过程中关于 SOLID 的设计原则，OOP 基础，如类，对象，接口，继承，多态，封装，抽象以及更高级的一些概念，如组合、聚合及关联。也包含了 GOF 设计模式的问题。</p>
<h3 id=接口是什么-为什么要使用接口而不是直接使用具体类>接口是什么? 为什么要使用接口而不是直接使用具体类?</h3>
<p>接口用于定义 API。它定义了类必须得遵循的规则。同时，它提供了一种抽象，因为客户端只使用接口，这样可以有多重实现，如 List 接口，你可以使用可随机访问的 ArrayList，也可以使用方便插入和删除的 LinkedList。接口中不允许普通方法，以此来保证抽象，但是 Java 8 中你可以在接口声明静态方法和默认普通方法。</p>
<h3 id=java-中抽象类与接口之间有什么不同>Java 中，抽象类与接口之间有什么不同?</h3>
<p>Java 中，抽象类和接口有很多不同之处，但是最重要的一个是 Java 中限制一个类只能继承一个类，但是可以实现多个接口。抽象类可以很好的定义一个家族类的默认行为，而接口能更好的定义类型，有助于后面实现多态机制 参见第六条。</p>
<h3 id=object有哪些公用方法>Object有哪些公用方法?</h3>
<p>clone equals hashcode wait notify notifyall finalize toString getClass 除了clone和finalize其他均为公共方法。</p>
<p>11个方法，wait被重载了两次</p>
<h3 id=equals与的区别>equals与==的区别</h3>
<ul>
<li>== 是一个运算符 equals是Object类的方法</li>
<li>比较时的区别
<ul>
<li>用于基本类型的变量比较时: ==用于比较值是否相等，equals不能直接用于基本数据类型的比较，需要转换为其对应的包装类型。</li>
<li>用于引用类型的比较时。==和equals都是比较栈内存中的地址是否相等 。相等为true 否则为false。但是通常会重写equals方法去实现对象内容的比较。</li>
</ul>
</li>
</ul>
<h3 id=stringstringbuffer与stringbuilder的区别>String、StringBuffer与StringBuilder的区别</h3>
<p>第一点: 可变和适用范围。String对象是不可变的，而StringBuffer和StringBuilder是可变字符序列。每次对String的操作相当于生成一个新的String对象，而对StringBuffer和StringBuilder的操作是对对象本身的操作，而不会生成新的对象，所以对于频繁改变内容的字符串避免使用String，因为频繁的生成对象将会对系统性能产生影响。</p>
<p>第二点: 线程安全。String由于有final修饰，是immutable的，安全性是简单而纯粹的。StringBuilder和StringBuffer的区别在于StringBuilder不保证同步，也就是说如果需要线程安全需要使用StringBuffer，不需要同步的StringBuilder效率更高。</p>
<h3 id=接口与抽象类>接口与抽象类</h3>
<ul>
<li>一个子类只能继承一个抽象类,但能实现多个接口</li>
<li>抽象类可以有构造方法,接口没有构造方法</li>
<li>抽象类可以有普通成员变量,接口没有普通成员变量</li>
<li>抽象类和接口都可有静态成员变量,抽象类中静态成员变量访问类型任意，接口只能public static final(默认)</li>
<li>抽象类可以没有抽象方法,抽象类可以有普通方法,接口中都是抽象方法</li>
<li>抽象类可以有静态方法，接口不能有静态方法</li>
<li>抽象类中的方法可以是public、protected;接口方法只有public abstract</li>
</ul>
<h3 id=抽象类和最终类>抽象类和最终类</h3>
<p>抽象类可以没有抽象方法, 最终类可以没有最终方法</p>
<p>最终类不能被继承, 最终方法不能被重写(可以重载)</p>
<h3 id=异常>异常</h3>
<p>相关的关键字 throw、throws、try&mldr;catch、finally</p>
<ul>
<li>throws 用在方法签名上, 以便抛出的异常可以被调用者处理</li>
<li>throw 方法内部通过throw抛出异常</li>
<li>try 用于检测包住的语句块, 若有异常, catch子句捕获并执行catch块</li>
</ul>
<h3 id=关于finally>关于finally</h3>
<ul>
<li>finally不管有没有异常都要处理</li>
<li>当try和catch中有return时，finally仍然会执行，finally比return先执行</li>
<li>不管有木有异常抛出, finally在return返回前执行</li>
<li>finally是在return后面的表达式运算后执行的(此时并没有返回运算后的值，而是先把要返回的值保存起来，管finally中的代码怎么样，返回的值都不会改变，仍然是之前保存的值)，所以函数返回值是在finally执行前确定的</li>
</ul>
<p>注意: finally中最好不要包含return，否则程序会提前退出，返回值不是try或catch中保存的返回值</p>
<p>finally不执行的几种情况: 程序提前终止如调用了 System.exit、断电</p>
<h3 id=受检查异常和运行时异常>受检查异常和运行时异常</h3>
<ul>
<li>受检查的异常(checked exceptions),其必须被try&mldr;catch语句块所捕获, 或者在方法签名里通过throws子句声明。受检查的异常必须在编译时被捕捉处理,命名为Checked Exception是因为Java编译器要进行检查, Java虚拟机也要进行检查, 以确保这个规则得到遵守。</li>
<li>运行时异常(runtime exceptions), 需要程序员自己分析代码决定是否捕获和处理,比如空指针,被0除&mldr;</li>
<li>Error的，则属于严重错误，如系统崩溃、虚拟机错误、动态链接失败等，这些错误无法恢复或者不可能捕捉，将导致应用程序中断，Error不需要捕获。</li>
</ul>
<h3 id=super出现在父类的子类中有三种存在方式>super出现在父类的子类中。有三种存在方式</h3>
<ul>
<li>super.xxx(xxx为变量名或对象名)意思是获取父类中xxx的变量或引用</li>
<li>super.xxx(); (xxx为方法名)意思是直接访问并调用父类中的方法</li>
<li>super() 调用父类构造</li>
</ul>
<h3 id=this--super在构造方法中的区别>this() & super()在构造方法中的区别</h3>
<ul>
<li>调用super()必须写在子类构造方法的第一行, 否则编译不通过</li>
<li>super从子类调用父类构造, this在同一类中调用其他构造均需要放在第一行</li>
<li>尽管可以用this调用一个构造器, 却不能调用2个</li>
<li>this和super不能出现在同一个构造器中, 否则编译不通过</li>
<li>this()、super()都指的对象,不可以在static环境中使用</li>
<li>本质this指向本对象的指针。super是一个关键字</li>
</ul>
<h3 id=序列化>序列化</h3>
<p>声明为static和transient类型的数据不能被序列化， 反序列化需要一个无参构造函数</p>
<h3 id=java移位运算符>Java移位运算符</h3>
<ul>
<li><code>&lt;&lt;</code> :左移运算符,<code>x &lt;&lt; 1</code>,相当于x乘以2(不溢出的情况下),低位补0</li>
<li><code>>></code> :带符号右移,<code>x >> 1</code>,相当于x除以2,正数高位补0,负数高位补1</li>
<li><code>>>></code> :无符号右移,忽略符号位,空位都以0补齐</li>
</ul>
<h3 id=形参实参>形参&实参</h3>
<p>形式参数可被视为local variable.形参和局部变量一样都不能离开方法。只有在方法中使用，不会在方法外可见。 形式参数只能用final修饰符，其它任何修饰符都会引起编译器错误。但是用这个修饰符也有一定的限制，就是在方法中不能对参数做任何修改。不过一般情况下，一个方法的形参不用final修饰。只有在特殊情况下，那就是: 方法内部类。一个方法内的内部类如果使用了这个方法的参数或者局部变量的话，这个参数或局部变量应该是final。 形参的值在调用时根据调用者更改，实参则用自身的值更改形参的值(指针、引用皆在此列)，也就是说真正被传递的是实参。</p>
<h3 id=局部变量为什么要初始化>局部变量为什么要初始化</h3>
<p>局部变量是指类方法中的变量，必须初始化。局部变量运行时被分配在栈中，量大，生命周期短，如果虚拟机给每个局部变量都初始化一下，是一笔很大的开销，但变量不初始化为默认值就使用是不安全的。出于速度和安全性两个方面的综合考虑，解决方案就是虚拟机不初始化，但要求编写者一定要在使用前给变量赋值。</p>
<h3 id=java语言的鲁棒性>Java语言的鲁棒性</h3>
<p>Java在编译和运行程序时，都要对可能出现的问题进行检查，以消除错误的产生。它提供自动垃圾收集来进行内存管理，防止程序员在管理内存时容易产生的错误。通过集成的面向对象的例外处理机制，在编译时，Java揭示出可能出现但未被处理的异常，帮助程序员正确地进行选择以防止系统的崩溃。另外，Java在编译时还可捕获类型声明中的许多常见错误，防止动态运行时不匹配问题的出现。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b55749cae60e608c7ca23e6a61d68cb6>1.4 - CH04-泛型机制</h1>
<h2 id=概览>概览</h2>
<p>Java 的泛型特性由 JDK 1.5 引入，因此为了兼容之前的版本，Java 泛型的实现采用了“伪泛型”策略。即 Java 在语法上支持泛型，但是在编译阶段会执行“类型擦除(Type Erasure)”，将所有的泛型表示都替换为实际的类型，就像完全没有泛型一样。</p>
<p>泛型的本质是为了参数化类型，在不创建新类型的情况下，通过泛型指定的不同类型来控制形式化参数所限制的具体类型。也就是说在泛型的使用过程中，操作的数据类型被指定为一个参数，该类型参数可以用在类、接口、方法中，分别被称为泛型类、泛型接口、泛型方法。</p>
<p>引入泛型的最直接意义在于：</p>
<ul>
<li><strong>适用于多种数据类型执行相同的代码逻辑(代码复用)</strong>。</li>
<li>泛型中的类型在使用时指定，不需要强制类型转换(类型安全，由编译器执行检查)。</li>
</ul>
<h2 id=基本使用>基本使用</h2>
<h3 id=泛型类>泛型类</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getVar</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>var</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>point</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>pioint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setVar</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h3 id=泛型接口>泛型接口</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Info</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>T</span> <span style=color:#000>getVar</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InfoImpl</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Info</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=泛型方法>泛型方法</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Caster</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>castAs</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=泛型边界>泛型边界</h3>
<blockquote>
<ul>
<li>参考 “泛型型变-Scala”。</li>
</ul>
</blockquote>
<h2 id=泛型擦除>泛型擦除</h2>
<p>擦除原则：</p>
<ul>
<li>消除类型参数声明，即删除 <code>&lt;></code> 及其包围的部分。</li>
<li>根据类型参数的上下界推断并替换所有的类型参数为具体类型：
<ul>
<li>如果类型参数是无限制通配符或没有上下界限定则替换为 Object。</li>
<li>如果存在上下界限定则根据子类替换原则取类型参数的最左侧限定类型，即父类。</li>
</ul>
</li>
<li>为了保证类型安全，必要时插入强制类型转换代码。</li>
<li>自动产生“桥接方法”以保证类型擦除后的代码仍然具有泛型的“多态性”。</li>
</ul>
<p>如何执行类型擦除：</p>
<ul>
<li>
<p>参数类定义中的类型参数：无限制类型擦除</p>
<p>当类定义中类型参数没有任何限制时，直接将其替换为 Object，如 <code>&lt;T></code> 或 <code>&lt;?></code> 会被直接替换为 Object。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210413223040.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
<li>
<p>擦除类定义中的类型参数：有限制类型擦除</p>
<p>如果类定义中的类型参数有上下界限定，在擦除时将其替换为类型参数的上界或下界，如 <code>&lt;T extends Number></code> 和 <code>&lt;? extends Number></code> 会被替换为 Number，<code>&lt;? super Number></code> 会被替换为 Object。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210413223306.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
<li>
<p>擦除方法定义中的类型参数</p>
<p>原则和擦除类定义中的类型参数一致，这里仅擦除方法定义中的有限制类型参数为例。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210413223413.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
</ul>
<h3 id=如何证明类型擦除>如何证明类型擦除</h3>
<ul>
<li>
<p>原始类型相等</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div></li>
<li>
<p>通过反射添加其他类型的元素</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
<span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div></li>
</ul>
<h3 id=类型擦除后的原生类型raw-type>类型擦除后的原生类型(Raw Type)</h3>
<p><strong>原生类型</strong>为擦除掉泛型信息后，保留在字节码中的类型变量的真正类型，无论何时定义一个泛型类型，对应的原始类型都会自动提供，类型变量擦除，并使用其限定类型或 Object 替换。</p>
<h3 id=如何理解编译期检查>如何理解编译期检查</h3>
<p>Java 编译器首先<strong>检查</strong>代码中泛型的类型，然后再执行类型擦除，然后再执行编译。</p>
<p>基于代码的类型检查是如何进行的呢？</p>
<p>比如以下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//第一种 情况
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ArrayList</span> <span style=color:#000>list2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span> <span style=color:#8f5902;font-style:italic>//第二种 情况
</span></code></pre></div><p>以上代码可以编译通过，且不会出现变异警告。但是仅第一种可以实现与完全使用泛型参数一样的效果，第二种不行。</p>
<p>因为类型检查就是编译时完成的，<code>new ArrayList()</code> 只是在内存中开辟一个存储空间，可以存储任何类型的对象，而真正涉及类型检查的是它的引用，因为我们是通过引用 list1 来调用它的方法，比如调用其 add 方法，所以 list1 引用能能完成泛型类型的检查。而引用 list2 没有使用泛型，所以不行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>();</span> 
<span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译错误  
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>String</span> <span style=color:#000>str1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//返回类型就是String 
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>ArrayList</span> <span style=color:#000>list2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ist2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//返回类型就是Object
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;11&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译通过
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>22</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//编译错误
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>String</span> <span style=color:#000>str2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//返回类型就是String
</span></code></pre></div><p>因此可以得出，<strong>类型检查就是针对引用执行的检查，谁是一个引用，通过该引用调用泛型方法，就会对这个引用调用的方法进行类型检测，而无关它真正引用的对象</strong>。</p>
<h3 id=泛型多态桥接方法>泛型多态/桥接方法</h3>
<p>类型擦除会造成多态冲突，而 JVM 通过桥接方法类解决。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>  

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后实现一个子类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f57900>著作权归https:</span><span style=color:#8f5902;font-style:italic>//pdai.tech所有。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>链接</span><span style=color:#a40000>：</span><span style=color:#000>https</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#8f5902;font-style:italic>//www.pdai.tech/md/java/basic/java-basic-x-generic.html
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DateInter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>  

    <span style=color:#5c35cc;font-weight:700>@Override</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  

    <span style=color:#5c35cc;font-weight:700>@Override</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这个子类中，我们设定父类的泛型类型为<code>Pair&lt;Date></code>，在子类中，我们覆盖了父类的两个方法，我们的原意是这样的：将父类的泛型类型限定为 Date，那么父类里面的两个方法的参数都为 Date 类型。</p>
<p>实际上类型擦除后，父类的泛型类型全部变成了 Object，所以父类编译之后会成为如下形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pair</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span>  <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>这时子类中的两个重写方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Override</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>  
<span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#5c35cc;font-weight:700>@Override</span>  
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先是 setValue 方法，父类的类型是 Object，而子类的类型是 Date，参数类型不一样，如果是在普通的继承体系中，根本就不会是重写，而是重载。但是如果通过基于重载的形式以子类来调用父类的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>DateInter</span> <span style=color:#000>dateInter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DateInter</span><span style=color:#ce5c00;font-weight:700>();</span>  
<span style=color:#000>dateInter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>());</span>                  
<span style=color:#000>dateInter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//编译错误
</span></code></pre></div><p>如果是重载，那么子类中会有两个 setValue 方法，一个参数为 Object，一个参数为 Date，但编译错误可以得出这里实际上是重写。</p>
<p>原因是，当我们集成父类并设定其类型参数为 Date，期望将泛型类变成如下形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pair</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后在子类中重写参数类型为 Date 的两个方法，实现继承中的多态。</p>
<p>但是由于种种原因，JVM 并不能将泛型类型转换为 Date，只能将其擦除，称为原生类型 Object。这样我们本意是重写来实现多态，但类型擦除后只能变为了重载。从而导致类型擦除与多态的冲突。因此 JVM 决定通过桥接来解决该问题。</p>
<p>首先通过命令 <code>javap -c className</code> 的方式反编译 DateInter 子类的字节码，结果如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tao</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DateInter</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tao</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Date</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>  
  <span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tao</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DateInter</span><span style=color:#ce5c00;font-weight:700>();</span>  
    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>8</span>                  <span style=color:#8f5902;font-style:italic>// Method com/tao/test/Pair.&#34;&lt;init&gt;&#34;:()V  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Date</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//我们重写的setValue方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>  
       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>16</span>                 <span style=color:#8f5902;font-style:italic>// Method com/tao/test/Pair.setValue:(Ljava/lang/Object;)V  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Date</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>    <span style=color:#8f5902;font-style:italic>//我们重写的getValue方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokespecial</span> <span style=color:#a40000>#</span><span style=color:#000>23</span>                 <span style=color:#8f5902;font-style:italic>// Method com/tao/test/Pair.getValue:()Ljava/lang/Object;  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>     <span style=color:#a40000>#</span><span style=color:#000>26</span>                 <span style=color:#8f5902;font-style:italic>// class java/util/Date  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>areturn</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>     <span style=color:#8f5902;font-style:italic>//编译时由编译器生成的巧方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#a40000>#</span><span style=color:#000>28</span>                 <span style=color:#8f5902;font-style:italic>// Method getValue:()Ljava/util/Date 去调用我们重写的getValue方法;  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>areturn</span>  

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Object</span><span style=color:#ce5c00;font-weight:700>);</span>   <span style=color:#8f5902;font-style:italic>//编译时由编译器生成的巧方法  
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>:</span>  
       <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_0</span>  
       <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>aload_1</span>  
       <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>checkcast</span>     <span style=color:#a40000>#</span><span style=color:#000>26</span>                 <span style=color:#8f5902;font-style:italic>// class java/util/Date  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>invokevirtual</span> <span style=color:#a40000>#</span><span style=color:#000>30</span>                 <span style=color:#8f5902;font-style:italic>// Method setValue:(Ljava/util/Date; 去调用我们重写的setValue方法)V  
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>return</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从编译结果来看，我们原本要重写方法实际上成了 4 个方法，最后两个方法即为编译器自动生成的桥接方法。可以发现桥接方法的参数类型都是 Object，也就是说，子类中真正覆盖父类方法的就是这两个桥接方法。桥接方法的内部会执行类型转换并调用我们重写的那两个方法。</p>
<h3 id=基本类型不能作为泛型参数>基本类型不能作为泛型参数</h3>
<p>比如只能使用 <code>List&lt;Integer></code> 而不能使用 <code>List&lt;int></code>。因为当类型擦除后，List 的原生类型变为 Object，但是 Object 不能存储 int 值，只能是引用类型 Integer 的值。</p>
<p>然后实际操作中使用的 <code>list.add(1)</code>，则是基本类型的自动装箱机制。</p>
<h3 id=泛型类型不能实例化>泛型类型不能实例化</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>T</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>以上代码会直接报错。因为 Java 编译期没法确定泛型参数的实际类型，也就找不到对应的类的字节码文件，所以自然就不能完成编译。此外由于 T 被擦除为 Object，如果可以执行 <code>new T()</code>，则就变成了 <code>new Object()</code>，失去了代码的本意。</p>
<h3 id=泛型数组通过具体类型参数初始化>泛型数组：通过具体类型参数初始化</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>lsa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span> <span style=color:#8f5902;font-style:italic>// Not really allowed.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>oa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>li</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>oa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// Unsound, but passes run time store check
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// Run-time error ClassCastException.
</span></code></pre></div><p>由于擦除机制，上面代码可以给 <code>oa[1]</code> 赋值为 ArrayList 类型的变量也不会出现异常。但是在取出数据时要做一次类型转换，所以就会出现 ClassCastException。</p>
<p>如果可以执行泛型数组的声明则上面这种情况就不会出现任何警告和错误，只有在运行时才会报错，但是泛型的出现就是为了避免转型错误，所有 Java 支持泛型数组初始化则与初衷违背。</p>
<p>下面的代码是成立的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>lsa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>];</span> <span style=color:#8f5902;font-style:italic>// OK, array of unbounded wildcard type.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>oa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>li</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>oa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>li</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// Correct.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Integer</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>lsa</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// OK
</span></code></pre></div><p>所以说采用通配符的方式初始化泛型数组是允许的，因为对于通配符的方式是最后取出数据时才执行转型，符合预期逻辑。</p>
<p>Java 的泛型数组初始化时数组类型不能是具体的泛型类型，只能是通配符的形式，因为具体类型会导致可存入任意类型对象，在取出时会发生类型转换异常，会与泛型的设计思想冲突，而通配符形式本来就需要自己强转，符合预期。</p>
<h3 id=泛型数组正确的初始化数组实例>泛型数组：正确的初始化数组实例</h3>
<p>无论是 <code>new ArrayList[10]</code> 的形式还是通过泛型通配符的形式来初始化都存在转型异常风险。</p>
<p>在需要使用泛型数组时应尽量使用列表集合替代，此外也可以通过反射来创建一个具有指定类型的数组：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>create</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//...
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arrayToken</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayWithTypeToken</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrayToken</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>create</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=泛型类中的静态方法与静态变量>泛型类中的静态方法与静态变量</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>T</span> <span style=color:#000>one</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>//编译错误    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>T</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>one</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#8f5902;font-style:italic>//编译错误    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#ce5c00;font-weight:700>}</span>    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为泛型类中的类型参数是在定义对象时才指定的，而静态变量或静态方法不需要使用对象实例来调用。对象未被创建，如何确定该泛型参数的具体类型，所以错误。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>    

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>one</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#8f5902;font-style:italic>//这是正确的    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#ce5c00;font-weight:700>}</span>    
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意这里 show 方法的类型参数 T 并非 Test 类的类型参数 T。</p>
<h3 id=异常中使用泛型>异常中使用泛型</h3>
<ul>
<li>不能抛出也不能捕获泛型对象。继承 Throwable 时使用泛型也是非法的。
<ul>
<li>因为异常仅在运行时抛出，编译期擦除参数类型后无法区分不同具体类型的泛型异常。</li>
</ul>
</li>
<li>不能在 catch 子句中使用泛型变量
<ul>
<li>因为泛型信息会被擦除为原生类型，<code>catch(T e)</code> 会变成 <code>catch(Throwable e)</code></li>
<li>根据异常捕获原则，如果下面还有别的 catch 语句来处理其他异常类型，导致冲突。</li>
</ul>
</li>
<li>可以在声明中抛出参数啊类型的异常，<code>&lt;T extends Throwable> void do(T t) throws T</code></li>
</ul>
<h3 id=如何获取类型参数>如何获取类型参数</h3>
<p><code>java.lang.reflect.Type</code> 是 Java 中所有类型的公共高级接口，代表了所有 Java 中的类型。Type 体系中的类型包括：</p>
<ul>
<li>数组类型：GenericArrayType</li>
<li>参数化类型：ParameterizedType</li>
<li>类型变量：TypeVariable</li>
<li>通配符类型：WildcardType</li>
<li>原始类型：Class</li>
<li>基本类型：Class</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b8f50da20bead099ffecc9e2ee818530>1.5 - CH05-注解机制</h1>
<h2 id=概览>概览</h2>
<p>注解是 JDK 1.5 版本开始引入的一个特性，用于对代码进行说明，可以对包、类、接口、字段、方法参数、局部变量等进行注解。它主要的作用有以下四方面：</p>
<ul>
<li>
<p>生成文档，通过代码里标识的元数据生成javadoc文档。</p>
</li>
<li>
<p>编译检查，通过代码里标识的元数据让编译器在编译期间进行检查验证。</p>
</li>
<li>
<p>编译时动态处理，编译时通过代码里标识的元数据动态处理，例如动态生成代码。</p>
</li>
<li>
<p>运行时动态处理，运行时通过代码里标识的元数据动态处理，例如使用反射注入实例。</p>
</li>
</ul>
<p>比如：</p>
<ul>
<li><strong>Java自带的标准注解</strong>，包括<code>@Override</code>、<code>@Deprecated</code>和<code>@SuppressWarnings</code>，分别用于标明重写某个方法、标明某个类或方法过时、标明要忽略的警告，用这些注解标明后编译器就会进行检查。</li>
<li><strong>元注解</strong>，元注解是用于定义注解的注解，包括<code>@Retention</code>、<code>@Target</code>、<code>@Inherited</code>、<code>@Documented</code>，<code>@Retention</code>用于标明注解被保留的阶段，<code>@Target</code>用于标明注解使用的范围，<code>@Inherited</code>用于标明注解可继承，<code>@Documented</code>用于标明是否生成javadoc文档。</li>
<li><strong>自定义注解</strong>，可以根据自己的需求定义注解，并可用元注解对自定义注解进行注解。</li>
</ul>
<h3 id=内置注解>内置注解</h3>
<ul>
<li>@Override</li>
<li>@Deprecated</li>
<li>@SuppressWarnings</li>
</ul>
<h3 id=元注解>元注解</h3>
<ul>
<li>@Target</li>
<li>@Retention，@RetentionTarget</li>
<li>@Documented</li>
<li>@Inherited</li>
<li>@Repeatable</li>
<li>@Native</li>
</ul>
<h3 id=注解与反射接口>注解与反射接口</h3>
<p>通过反射工具包 <code>java.lang.reflect</code> 中的 <code>AnnotatedElement</code> 可以访问注解信息。注意仅在注解被声明为 RUNTIME 时，才能在运行时获取注解信息，当 class 文件被加载时保存在 class 文件中的注解信息才会被 JVM 读取。</p>
<p>AnnotatedElement 接口是所有成语元素的父接口，所有程序通过反射获得了某个类的 AnnotatedElement 对象之后，就可以调用该对象的方法来访问具体的注解信息：</p>
<ul>
<li><code>boolean isAnnotationPresent(Class&lt;?extends Annotation> annotationClass)</code></li>
<li><code>&lt;T extends Annotation> T getAnnotation(Class&lt;T> annotationClass)</code></li>
<li><code>Annotation[] getAnnotations()</code></li>
<li><code>&lt;T extends Annotation> T[] getAnnotationsByType(Class&lt;T> annotationClass)</code></li>
<li><code>&lt;T extends Annotation> T[] getDeclaredAnnotationsByType(Class&lt;T> annotationClass)</code></li>
<li><code>Annotation[] getDeclaredAnnotations()</code></li>
</ul>
<h3 id=自定义注解>自定义注解</h3>
<p>定义注解：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>METHOD</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>MyMethodAnnotation</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>description</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>default</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用注解：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestMethodAnnotation</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;toStringMethod&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>description</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;override toString method&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;Override toString method&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Deprecated</span>
    <span style=color:#5c35cc;font-weight:700>@MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;old static method&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>description</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;deprecated old static method&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>oldMethod</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;old method, don&#39;t use it.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;deprecation&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#5c35cc;font-weight:700>@MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>title</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;test method&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>description</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;suppress warning static method&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>genericsTest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>FileNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span> <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>oldMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>读取注解：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TestMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#4e9a06>&#34;com.pdai.java.annotation.TestMethodAnnotation&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethods</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 方法上是否有MyMethodAnnotation注解
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnnotationPresent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取并遍历方法上的所有注解
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Annotation</span> <span style=color:#000>anno</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredAnnotations</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Annotation in Method &#39;&#34;</span>
                        <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#39; : &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>anno</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 获取MyMethodAnnotation对象信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>MyMethodAnnotation</span> <span style=color:#000>methodAnno</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span>
                    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MyMethodAnnotation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodAnno</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>title</span><span style=color:#ce5c00;font-weight:700>());</span>

        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=注解特性>注解特性</h2>
<h3 id=java-8-新特性>Java 8 新特性</h3>
<ul>
<li>@Repeatable</li>
<li>@ElementType.TYPE_USE</li>
<li>@ElementType.TYPE_PARAMETER</li>
</ul>
<p>TYPE_USE 包括类型声明和类型参数声明，是为了方便设计者进行类型检查。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 自定义ElementType.TYPE_PARAMETER注解
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE_PARAMETER</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>MyNotEmpty</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 自定义ElementType.TYPE_USE注解
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Retention</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RetentionPolicy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RUNTIME</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#5c35cc;font-weight:700>@Target</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ElementType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TYPE_USE</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@interface</span> <span style=color:#000>MyNotNull</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 测试类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TypeParameterAndTypeUseAnnotation</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#5c35cc;font-weight:700>@MyNotEmpty</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;{</span>

  <span style=color:#8f5902;font-style:italic>//使用TYPE_PARAMETER类型，会编译不通过
</span><span style=color:#8f5902;font-style:italic>//		public @MyNotEmpty T test(@MyNotEmpty T a){
</span><span style=color:#8f5902;font-style:italic>//			new ArrayList&lt;@MyNotEmpty String&gt;();
</span><span style=color:#8f5902;font-style:italic>//				return a;
</span><span style=color:#8f5902;font-style:italic>//		}
</span><span style=color:#8f5902;font-style:italic></span>
  <span style=color:#8f5902;font-style:italic>//使用TYPE_USE类型，编译通过
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#5c35cc;font-weight:700>@MyNotNull</span> <span style=color:#000>T</span> <span style=color:#000>test2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@MyNotNull</span> <span style=color:#000>T</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#5c35cc;font-weight:700>@MyNotNull</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f947a3a008aa40dbb8eed80c6ed1d899>1.6 - CH06-异常机制</h1>
<h2 id=概览>概览</h2>
<p>Java 异常是 Java 提供的一种识别及响应错误的机制，Java 异常机制可以使程序中异常处理的代码和正常业务代码分离，保证程序代码更加优雅，并提高程序的健壮性。</p>
<h2 id=层次结构>层次结构</h2>
<p>异常是指非预期的各种状况，如：文件找不到、网络连接失败、非法参数等。异常是一个事件，它发生在程序运行期间，干扰了正常的指令流程。Java 通过 API 中 Throwable 类的众多子类描述各种不同的异常。因此，Java 异常都是对象，是 Throwable 子类的实例，描述了出现在一段编码中的错误条件。当条件生成时，错误将引发异常。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210414223305.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=throwable>Throwable</h3>
<p>Throwable 是 Java 语言中所有错误与异常的超类。</p>
<p>Throwable 包含两个子类：Error（错误）和 Exception（异常），它们通常用于指示发生了异常情况。</p>
<p>Throwable 包含了其线程创建时线程执行堆栈的快照，它提供了 printStackTrace() 等接口用于获取堆栈跟踪数据等信息。</p>
<h3 id=error>Error</h3>
<p>Error 类及其子类：程序中无法处理的错误，表示运行应用程序中出现了严重的错误。</p>
<p>此类错误一般表示代码运行时 JVM 出现问题。通常有 Virtual MachineError(虚拟机运行错误)、NoClassDefFoundError(类定义错误)等。比如 OutOfMemoryError：内存不足错误；StackOverflowError：栈溢出错误。此类错误发生时，JVM 将终止线程。</p>
<p>这些错误是不受检异常，非代码性错误。因此，当此类错误发生时，应用程序不应该去处理此类错误。按照 Java 惯例，我们是不应该实现任何新的 Error 子类的！</p>
<h3 id=exception>Exception</h3>
<p>程序本身可以捕获并且可以处理的异常。Exception 这种异常又分为两类：运行时异常和编译时异常。</p>
<ul>
<li>运行时异常
<ul>
<li>都是 RuntimeException 类及其子类异常，如 NullPointerException(空指针异常)、IndexOutOfBoundsException(下标越界异常)等，这些异常是不检查异常，程序中可以选择捕获处理，也可以不处理。这些异常一般是由程序逻辑错误引起的，程序应该从逻辑角度尽可能避免这类异常的发生。</li>
<li>运行时异常的特点是 Java 编译器不会检查它，也就是说，当程序中可能出现这类异常，即使没有用 try-catch 语句捕获它，也没有用 throws 子句声明抛出它，也会编译通过。</li>
</ul>
</li>
<li>编译期异常
<ul>
<li>是 RuntimeException 以外的异常，类型上都属于 Exception 类及其子类。从程序语法角度讲是必须进行处理的异常，如果不处理，程序就不能编译通过。如 IOException、SQLException 等以及用户自定义的 Exception 异常，一般情况下不自定义检查异常。</li>
</ul>
</li>
</ul>
<h3 id=受检异常非受检异常>受检异常/非受检异常</h3>
<ul>
<li>受检异常：编译器妖气必须处理的异常
<ul>
<li>正确的程序在运行中，很容易出现的、情理可容的异常状况。可查异常虽然是异常状况，但在一定程度上它的发生是可以预计的，而且一旦发生这种异常状况，就必须采取某种方式进行处理。</li>
<li>除了 RuntimeException 及其子类以外，其他的 Exception 类及其子类都属于受检异常。这种异常的特点是 Java 编译器会检查它，也就是说，当程序中可能出现这类异常，要么用 try-catch 语句捕获它，要么用 throws 子句声明抛出它，否则编译不会通过。</li>
</ul>
</li>
<li>非受检异常：编译器不强制要求检查的异常
<ul>
<li>包括运行时异常(RuntimeException与其子类)和错误(Error)。</li>
</ul>
</li>
</ul>
<h2 id=异常基础>异常基础</h2>
<h3 id=关键字>关键字</h3>
<ul>
<li>try：监听异常</li>
<li>catch：捕获异常</li>
<li>finally：总是执行</li>
<li>throw：抛出异常</li>
<li>throws：声明异常</li>
</ul>
<h3 id=异常捕获>异常捕获</h3>
<ul>
<li>try-catch</li>
<li>try-catch-finally</li>
<li>try-finally</li>
<li>try-with-resource: AutoCloseable</li>
</ul>
<h3 id=常见异常>常见异常</h3>
<ul>
<li>RuntimeException
<ul>
<li>ArrayIndexOutOfBoundsException：数组索引越界</li>
<li>ArithmeticException：除零异常</li>
<li>NullPointerException：空指针</li>
<li>ClassNotFoundException：类加载</li>
<li>NegativeArraySizeException：数组长度为负</li>
<li>ArrayStoreException：数组元素类型不兼容</li>
<li>SecurityException：安全性异常</li>
<li>IllegalArgumentException：非法参数</li>
</ul>
</li>
<li>IOException
<ul>
<li>IOException：输出输出流异常</li>
<li>EOFException：文件结束</li>
<li>FileNotFoundException：文件未找到</li>
</ul>
</li>
<li>Others
<ul>
<li>ClassCastException</li>
<li>SQLException</li>
<li>NoSuchFieldException</li>
<li>NoSuchMethodException</li>
<li>NumberFormatException</li>
<li>StringIndexOutOfBoundsException</li>
<li>IllegalAccessException</li>
<li>InstantiationException</li>
</ul>
</li>
</ul>
<h3 id=应用实践>应用实践</h3>
<ul>
<li>在恰当的级别处理异常，即知道该如何处理的地方及时处理异常。</li>
<li>解决问题并且重新调用产生异常的方法。</li>
<li>进行少许修补，然后绕过异常发生的地方继续执行。</li>
<li>用别的数据进行计算，以代替方法预计会返回的值。</li>
<li>把当前运行环境下能做的事尽量做完，然后把相同的异常重抛到更高层。</li>
<li>终止程序。</li>
<li>进行简化。</li>
<li>让类库和程序更安全。</li>
<li>不要通过异常来实现业务流程。</li>
</ul>
<h2 id=底层机制>底层机制</h2>
<h3 id=try-catch>try-catch</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>simpleTryCatch</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>testNPE</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 javap 的带编译后的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//javap -c Main
 public static void simpleTryCatch();
    Code:
       0: invokestatic  #3                  // Method testNPE:()V
       3: goto          11
       6: astore_0
       7: aload_0
       8: invokevirtual #5                  // Method java/lang/Exception.printStackTrace:()V
      11: return
    Exception table:
       from    to  target type
           0     3     6   Class java/lang/Exception
</code></pre></div><p>异常表中包含了一个或多个异常处理器的信息，内容如下：</p>
<ul>
<li>from：可能发生异常的起始点</li>
<li>to：可能发生异常的结束点</li>
<li>target：从 from 到 to 之间发生异常后异常处理器的位置</li>
<li>type：异常处理器所处理的异常类型</li>
</ul>
<p>当发生一个异常时：</p>
<ol>
<li>JVM 会在当前出现异常的方法中查找异常表，检查是否有合适的处理器</li>
<li>如果当前方法的异常表不为空，且异常符合表中 from to 的范围，同时 type 匹配，则 JVM 将调用位于 target 的处理器来处理异常</li>
<li>如果上一步没有找到处理器，则继续检查异常表中的下一项</li>
<li>如果当前异常表无法处理，则向上查找(弹栈)调用方法的调用点，并重复 1-3 步的操作。</li>
<li>如果所有栈帧都被弹出，仍然没有处理，则抛出异常给当前 Thread，Thread 会终止。</li>
<li>如果当前 Thread 为最后一个非守护线程，且异常未处理，则导致 JVM 终止运行。</li>
</ol>
<h3 id=try-catch-finally>try-catch-finally</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>simpleTryCatchFinally</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>testNPE</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Finally&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 javap 得到异常表部分：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public static void simpleTryCatchFinally();
    Code:
       0: invokestatic  #3                  // Method testNPE:()V
       3: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;
       6: ldc           #7                  // String Finally
       8: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      11: goto          41
      14: astore_0
      15: aload_0
      16: invokevirtual #5                  // Method java/lang/Exception.printStackTrace:()V
      19: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;
      22: ldc           #7                  // String Finally
      24: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      27: goto          41
      30: astore_1
      31: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;
      34: ldc           #7                  // String Finally
      36: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      39: aload_1
      40: athrow
      41: return
    Exception table:
       from    to  target type
           0     3    14   Class java/lang/Exception
           0     3    30   any
          14    19    30   any
</code></pre></div><ul>
<li>如果 0-3 之间发生了 Exception 异常，调用 14 位置的处理器。</li>
<li>如果 0-3 之间无论发生哪种异常，都调用 30 位置的处理器。</li>
<li>如果 14-19(catch) 之间无论发生什么异常，都调用 30 位置的处理器。</li>
</ul>
<p>注意异常表会代码中 finally 的部分同时在异常表的 catch 和 finally 部分注册，以实现无论是否发生异常都执行的逻辑。</p>
<h3 id=catch-先后顺序>catch 先后顺序</h3>
<p>先 catch 类层级较高的异常类型会导致编译错误。</p>
<h3 id=return-与-finally>return 与 finally</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>tryCatchReturn</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>testNPE</span><span style=color:#ce5c00;font-weight:700>();</span>
       <span style=color:#204a87;font-weight:700>return</span>  <span style=color:#4e9a06>&#34;OK&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;ERROR&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
       <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tryCatchReturn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里无论是否抛出一查，finally 部分都会执行。</p>
<h3 id=性能损耗>性能损耗</h3>
<p>创建一个异常对象是创建一个普通对象所需耗时的几十倍，抛出、捕获异常则是创建异常对象所需耗时的数倍。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1782eebed124e635eda873f42d596c92>1.7 - CH07-反射机制</h1>
<h2 id=反射基础>反射基础</h2>
<p>Runtime Type Identification(RTTI) 运行时类型识别，作用是在运行时识别一个对象的类型和类信息。主要有两种方式：</p>
<ul>
<li>传统的的 RTTI，它假设我们在编译期就知道了所有的类型。</li>
<li>反射机制，它允许我们在运行时发现和使用类的信息。</li>
</ul>
<h3 id=class-类>Class 类</h3>
<p>Class 类就像 String 类、Object 类一样，是一个实实在在的类，存在与 java.lang 包中。Class 类的实例表示 java 应用运行时的类(class ans enum)或接口(interface and annotation)，可以通过 <code>类名.class</code>、<code>类型.class</code>、<code>Class.forName(类名)</code>等方法获取 Class 类的对象实例。</p>
<p>数组同样也被映射为为 class 对象的一个类，所有具有相同元素类型和维数的数组都共享该 Class 对象。基本类型boolean，byte，char，short，int，long，float，double 和关键字 void 同样表现为 class 对象。</p>
<ul>
<li>Class 类也是类的一种，与 class 关键字是不一样的。</li>
<li>手动编写的类被编译后会产生一个 Class 对象，其表示的是创建的类的类型信息，而且这个 Class 对象保存在 同名.class 的文件中(字节码文件)</li>
<li>每个通过关键字 class 标识的类，在内存中有且只有一个与之对应的 Class 对象来描述其类型信息，无论创建多少个实例对象，其依据的都是用一个Class对象。</li>
<li>Class 类只有私有构造函数，因此对应 Class 对象只能由 JVM 创建和加载。</li>
<li>Class 类的对象作用是运行时提供或获得某个对象的类型信息。</li>
</ul>
<h3 id=类加载>类加载</h3>
<p>类加载流程：</p>
<ul>
<li>加载</li>
<li>连接
<ul>
<li>验证</li>
<li>准备</li>
<li>解析</li>
</ul>
</li>
<li>初始化</li>
<li>使用</li>
<li>卸载</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210414231732.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=反射应用>反射应用</h2>
<p>在Java中，Class类与java.lang.reflect类库一起对反射技术进行了全力的支持。在反射包中，我们常用的类主要有Constructor类表示的是Class 对象所表示的类的构造方法，利用它可以在运行时动态创建对象、Field表示Class对象所表示的类的成员变量，通过它可以在运行时动态修改成员变量的属性值(包含private)、Method表示Class对象所表示的类的成员方法，通过它可以动态调用对象的方法(包含private)，下面将对这几个重要类进行分别说明。</p>
<h3 id=class-对象>Class 对象</h3>
<ul>
<li>类名.class</li>
<li>对象.getClass()</li>
<li>完全限定名：Class.forName(全限定类名)</li>
</ul>
<h3 id=class-方法>Class 方法</h3>
<ul>
<li>forName()</li>
<li>Object.getClass()</li>
<li>getName()：类的全限定名，可用于 Class.forName</li>
<li>getSimpleName()：仅类名</li>
<li>getCanonicalName()：更易理解的完全限定名，数组时表示不同</li>
<li>isInterface()</li>
<li>getInterfaces()</li>
<li>getSupercalss()</li>
<li>newInstance()</li>
<li>getFields()</li>
<li>getDeclaredFields()</li>
<li>getConstructors()</li>
<li>&mldr;</li>
</ul>
<h3 id=constructor>Constructor</h3>
<h3 id=field>Field</h3>
<h3 id=method>Method</h3>
<h2 id=反射流程>反射流程</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloReflect</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 1. 使用外部配置的实现，进行动态加载类
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TempFunctionTest</span> <span style=color:#000>test</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TempFunctionTest</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.tester.HelloReflect&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sayHello</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;call directly&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 2. 根据配置的函数名，进行方法调用（不需要通用的接口抽象）
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TempFunctionTest</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sayHello&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;method invoke&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalAccessException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchMethodException</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationTargetException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>sayHello</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>word</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello,&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>word</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210414232506.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=反射获取类实例>反射获取类实例</h3>
<p>通过 Class 的静态方法，获取类信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 先通过反射，获取调用进来的类信息，从而获取当前的 classLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 调用native方法进行获取class信息
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>forName0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClassLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最后，JVM 会回调 ClassLoader 执行类加载：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// sun.misc.Launcher
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastIndexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>46</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var3</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SecurityManager</span> <span style=color:#000>var4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var4</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>var4</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>checkPackageAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var3</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ucp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>knownToNotExist</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span> <span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findLoadedClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ClassNotFoundException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// java.lang.ClassLoader
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ClassNotFoundException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 先获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getClassLoadingLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// First, check if the class has already been loaded
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 如果已经加载了的话，就不用再加载了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findLoadedClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 双亲委托加载
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findBootstrapClassOrNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ClassNotFoundException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// ClassNotFoundException thrown if class not found
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// from the non-null parent class loader
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 父类没有加载到时，再自己加载
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// If still not found, then invoke findClass in order
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// to find the class.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>findClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// this is the defining class loader; record the stats
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentDelegationTime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>t0</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFindClassTime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>addElapsedTimeFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PerfCounter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFindClasses</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>increment</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>resolveClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Object</span> <span style=color:#000>getClassLoadingLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parallelLockMap</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用 ConcurrentHashMap来保存锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>newLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parallelLockMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newLock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newLock</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>findLoadedClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>checkName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>findLoadedClass0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以下是 newInstance 的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 首先肯定是 Class.newInstance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalAccessException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUBLIC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// NOTE: the following code may not be strictly correct under
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// the current Java memory model.
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// Constructor lookup
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// newInstance() 其实相当于调用类的无参构造函数，所以，首先要找到其无参构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cachedConstructor</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 不允许调用 Class 的 newInstance() 方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;Can not call newInstance() on the Class for java.lang.Class&#34;</span>
            <span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取无参构造器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>empty</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{};</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getConstructor0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECLARED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// Disable accessibility checks on the constructor
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// since we have to do the security check here anyway
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// (the stack depth is wrong for the Constructor&#39;s
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// security check to work)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>security</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAccessible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>});</span>
            <span style=color:#000>cachedConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NoSuchMethodException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#c4a000>initCause</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tmpConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedConstructor</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Security check (same as in java.lang.reflect.Constructor)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>modifiers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tmpConstructor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>quickCheckMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newInstanceCallerCache</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ensureMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>newInstanceCallerCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// Run constructor
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 调用无参构造器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tmpConstructor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[])</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InvocationTargetException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>throwException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTargetException</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>// Not reached
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>newInstance 的主要逻辑：</p>
<ol>
<li>权限检测，如果不通过则直接报错</li>
<li>查找无参构造器，并将其缓存</li>
<li>调用具体方法的无参构造方法，生成实例并返回</li>
</ol>
<p>以下是获取构造器过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getConstructor0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>which</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>NoSuchMethodException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取所有构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>constructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>privateGetDeclaredConstructors</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>which</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PUBLIC</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>constructor</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>constructors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arrayContentsEq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getReflectionFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>copyConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchMethodException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&lt;init&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argumentTypesToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>获取构造器分为三步：</p>
<ol>
<li>先获取所有的 constructors, 然后执行参数类型比较；</li>
<li>如果存在匹配，通过 ReflectionFactory copy 一份 constructor 返回；</li>
<li>否则抛出 NoSuchMethodException;</li>
</ol>
<p>下面是获取所有构造器的过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 获取当前类所有的构造方法，通过jvm或者缓存
</span><span style=color:#8f5902;font-style:italic>// Returns an array of &#34;root&#34; constructors. These Constructor
</span><span style=color:#8f5902;font-style:italic>// objects must NOT be propagated to the outside world, but must
</span><span style=color:#8f5902;font-style:italic>// instead be copied via ReflectionFactory.copyConstructor.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>privateGetDeclaredConstructors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkInitted</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 调用 reflectionData(), 获取保存的信息，使用软引用保存，从而使内存不够可以回收
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>publicOnly</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publicConstructors</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredConstructors</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 存在缓存，则直接返回
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// No cached value available; request value from VM
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isInterface</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>temporaryRes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>temporaryRes</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用native方法从jvm获取构造器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getDeclaredConstructors0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 最后，将从jvm中读取的内容，存入缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publicConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredConstructors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Lazily create and cache ReflectionData
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>reflectionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflectionData</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>classRedefinedCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>useCaches</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#000>reflectionData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>redefinedCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// else no SoftReference or cleared SoftReference or stale ReflectionData
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// -&gt; create and replace new instance
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 新创建缓存，保存反射信息
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>oldReflectionData</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>useCaches</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 使用cas保证更新的线程安全性，所以反射是保证线程安全的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// try to CAS it...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Atomic</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>casReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>oldReflectionData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SoftReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 先使用CAS更新，如果更新成功，则立即返回，否则测查当前已被其他线程更新的情况，如果和自己想要更新的状态一致，则也算是成功了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>oldReflectionData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reflectionData</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>classRedefinedCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldReflectionData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldReflectionData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>redefinedCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>classRedefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>首先阐释缓存中获取</li>
<li>如果没有缓存，则从 JVM 中重新加载，并存入缓存，缓存使用软引用保存，保证内存可用。</li>
</ol>
<p>另外，使用 relactionData() 进行缓存保存；ReflectionData 的数据结构如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// reflection data that might get invalidated when JVM TI RedefineClasses() is called
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredFields</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>publicFields</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>publicMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>declaredConstructors</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>publicConstructors</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Intermediate results for getFields and getMethods
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Field</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredPublicFields</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>declaredPublicMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>interfaces</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// Value of classRedefinedCount when we created this ReflectionData instance
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>redefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>redefinedCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>redefinedCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>redefinedCount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>比较构造是否是要查找构造器，其实就是比较类型完全相等性，有一个不相等则返回 false。</p>
<p>最终通过以下逻辑获得构造器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>arrayContentsEq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>a2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.ReflectionFactory
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>/** Makes a copy of the passed constructor. The returned
</span><span style=color:#8f5902;font-style:italic>    constructor is a &#34;child&#34; of the passed one; see the comments
</span><span style=color:#8f5902;font-style:italic>    in Constructor.java for details. */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>copyConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>langReflectAccess</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>copyConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// java.lang.reflect.Constructor, copy 其实就是新new一个 Constructor 出来
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// This routine enables sharing of ConstructorAccessor objects
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// among Constructor objects which refer to the same underlying
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// method in the VM. (All of this contortion is only necessary
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// because of the &#34;accessibility&#34; bit in AccessibleObject,
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// which implicitly requires that new java.lang.reflect
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// objects be fabricated for each reflective call on Class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// objects.)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Can not copy a non-root Constructor&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Constructor</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>exceptionTypes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>slot</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>signature</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>annotations</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>parameterAnnotations</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// root 指向当前 constructor
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Might as well eagerly propagate this if already present
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>constructorAccessor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorAccessor</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后只需调用对应构造器的 newInstance 方法即可返回实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// return tmpConstructor.newInstance((Object[])null); 
</span><span style=color:#8f5902;font-style:italic>// java.lang.reflect.Constructor
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>initargs</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span>
           <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>override</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>quickCheckMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>checkAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>Modifier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ENUM</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Cannot reflectively create enum objects&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ConstructorAccessor</span> <span style=color:#000>ca</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>constructorAccessor</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>// read volatile
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ca</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ca</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>acquireConstructorAccessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>T</span> <span style=color:#000>inst</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ca</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initargs</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>inst</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.DelegatingConstructorAccessorImpl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span>
         <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span>
         <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.NativeConstructorAccessorImpl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InstantiationException</span><span style=color:#ce5c00;font-weight:700>,</span>
           <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span>
           <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// We can&#39;t inflate a constructor belonging to a vm-anonymous class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// because that kind of class can&#39;t be referred to by name, hence can&#39;t
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// be found from the generated bytecode.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>numInvocations</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ReflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inflationThreshold</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConstructorAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConstructorAccessorImpl</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
                <span style=color:#000>generateConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                    <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 调用native方法，进行调用 constructor
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newInstance0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>返回实例之后，可以根据实际需要执行类型转化，以调用具体类型的方法。</p>
<h3 id=反射获取方法>反射获取方法</h3>
<p>首先获取 Method：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// java.lang.Class
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Method</span> <span style=color:#000>getDeclaredMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;...</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>NoSuchMethodException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SecurityException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DECLARED</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>searchMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>privateGetDeclaredMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchMethodException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;.&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>argumentTypesToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>获取所有方法列表</li>
<li>更具方法名和方法列表，找到符合要求的方法</li>
<li>如果没有则抛出异常，有则返回方法</li>
</ol>
<p>首先获取类的所有方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Returns an array of &#34;root&#34; methods. These Method objects must NOT
</span><span style=color:#8f5902;font-style:italic>// be propagated to the outside world, but must instead be copied
</span><span style=color:#8f5902;font-style:italic>// via ReflectionFactory.copyMethod.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>privateGetDeclaredMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkInitted</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ReflectionData</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionData</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>publicOnly</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredPublicMethods</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredMethods</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// No cached value available; request value from VM
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filterMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>getDeclaredMethods0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>publicOnly</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredPublicMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>declaredMethods</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>与构造器类似，首先读取缓存，没有缓存则从 JVM 中获取。</p>
<p>不同的是，方法列表执行过滤 Reflection.filterMethods。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// sun.misc.Reflection
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filterMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>containingClass</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methodFilterMap</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Bootstrapping
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[])</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>methodFilterMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>containingClass</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// 可以过滤指定的方法，一般为空，如果要指定过滤，可以调用 registerMethodsToFilter(), 或者...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>filteredNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>filteredNames</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numNewMembers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span> <span style=color:#000>member</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>filteredName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>filteredNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>filteredName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>numNewMembers</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>newMembers</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span><span style=color:#ce5c00;font-weight:700>[])</span><span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>numNewMembers</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>destIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Member</span> <span style=color:#000>member</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>members</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>filteredName</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>filteredNames</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>filteredName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>shouldSkip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>shouldSkip</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>newMembers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>destIdx</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>newMembers</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后<strong>根据方法名和参数类型过滤指定方法返回</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Method</span> <span style=color:#000>searchMethods</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Method</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 使用常量池，避免重复创建String
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>String</span> <span style=color:#000>internedName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>intern</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Method</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methods</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>internedName</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>arrayContentsEq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span>
                <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>())))</span>
            <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getReflectionFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>copyMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在执行匹配的过程将会尝试最精确的匹配，最后会通过 ReflectionFactory.copy 返回方法。</p>
<h3 id=调用-methodinvoke>调用 method.invoke</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@CallerSensitive</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalAccessException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span>
       <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>override</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>quickCheckMemberAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Reflection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCallerClass</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>checkAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>MethodAccessor</span> <span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodAccessor</span><span style=color:#ce5c00;font-weight:700>;</span>             <span style=color:#8f5902;font-style:italic>// read volatile
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ma</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>acquireMethodAccessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ma</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 MethodAccessor 执行调用，而 MethodAccessor 为接口，在第一次使用时或调用 acquireMethodAccessor 新建实例。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// probably make the implementation more scalable.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MethodAccessor</span> <span style=color:#000>acquireMethodAccessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// First check to see if one has been created yet, and take it
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// if so
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>MethodAccessor</span> <span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethodAccessor</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 存在缓存时，存入 methodAccessor，否则调用 ReflectionFactory 创建新的 MethodAccessor
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>methodAccessor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Otherwise fabricate one and propagate it up to the root
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>tmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newMethodAccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>setMethodAccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tmp</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// sun.reflect.ReflectionFactory
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MethodAccessor</span> <span style=color:#000>newMethodAccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkInitted</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>noInflation</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
            <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                           <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>NativeMethodAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>=</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>两种 Accessor 的细节：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//     NativeMethodAccessorImpl / DelegatingMethodAccessorImpl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NativeMethodAccessorImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numInvocations</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>NativeMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// We can&#39;t inflate methods belonging to vm-anonymous classes because
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// that kind of class can&#39;t be referred to by name, hence can&#39;t be
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// found from the generated bytecode.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>numInvocations</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ReflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inflationThreshold</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
                    <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                                   <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setParent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#000>Object</span> <span style=color:#000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Method</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DelegatingMethodAccessorImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MethodAccessorImpl</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>DelegatingMethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delegate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>delegate</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>执行 method.invoke(obj, args) 时，滴啊用 DelegatingMethodAccessorImpl.invoke()，最后被委托到 NativeMethodAccessorImpl.invoke()：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InvocationTargetException</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// We can&#39;t inflate methods belonging to vm-anonymous classes because
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// that kind of class can&#39;t be referred to by name, hence can&#39;t be
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// found from the generated bytecode.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>numInvocations</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ReflectionFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inflationThreshold</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>ReflectUtil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isVMAnonymousClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MethodAccessorImpl</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessorImpl</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MethodAccessorGenerator</span><span style=color:#ce5c00;font-weight:700>().</span>
                <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaringClass</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getReturnType</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExceptionTypes</span><span style=color:#ce5c00;font-weight:700>(),</span>
                               <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getModifiers</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDelegate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// invoke0 是个 native 方法，由jvm进行调用业务方法。从而完成反射调用功能。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>invoke0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其中，generateMethod 是生成具体类的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** This routine is not thread-safe */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MethodAccessor</span> <span style=color:#000>generateMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>String</span>   <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span>   <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>checkedExceptions</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodAccessor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>generate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>declaringClass</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>parameterTypes</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>returnType</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>checkedExceptions</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>modifiers</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>generate 的实现中会出现：ClassDefiner.defineClass(xx, declaringClass.getClassLoader()).newInstance()。</p>
<p>在<code>ClassDefiner.defineClass</code>方法实现中，每被调用一次都会生成一个DelegatingClassLoader类加载器对象 ，这里每次都生成新的类加载器，是为了性能考虑，在某些情况下可以卸载这些生成的类，因为类的卸载是只有在类加载器可以被回收的情况下才会被回收的，如果用了原来的类加载器，那可能导致这些新创建的类一直无法被卸载。</p>
<p>而反射生成的类，有时候可能用了就可以卸载了，所以使用其独立的类加载器，从而使得更容易控制反射类的生命周期。</p>
<h3 id=反射汇总>反射汇总</h3>
<ol>
<li>反射类及反射方法的获取，都是通过从列表中搜寻查找匹配的方法，所以查找性能会随类的大小方法多少而变化；</li>
<li>每个类都会有一个与之对应的Class实例，从而每个类都可以获取method反射方法，并作用到其他实例身上；</li>
<li>反射也是考虑了线程安全；</li>
<li>反射使用软引用relectionData缓存class信息，避免每次重新从jvm获取带来的开销；</li>
<li>反射调用多次生成新代理Accessor, 而通过字节码生成的则考虑了卸载功能，所以会使用独立的类加载器；</li>
<li>当找到需要的方法，都会copy一份出来，而不是使用原来的实例，从而保证数据隔离；</li>
<li>调用反射方法，最终是由jvm执行invoke0()执行；</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4a27de20847a48405d85a4161174c1ee>1.8 - CH08-SPI 机制</h1>
<h2 id=概览>概览</h2>
<p>Service Provider Interface(SPI) 是 JDK 内置的服务发现机制，可以用来启用框架扩展或替换组件，主要用于框架。比如 java.sql.Driver 接口，不同的数据库厂商可以针对同一接口提供不同的实现，MySQL 和 PostgreSQL 分别为用户提供了不同的实现。</p>
<p>Java SPI 机制的主要思想是将装配的控制权移交到程序之外，目的在于解耦。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210415224103.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当服务的提供者提供了一种接口的实现后，需要在 classpath 下的 <code>META-INF/services/</code> 目录中创建一个以服务接口命名的文件，并在该文件中添加实现类的完全限定名。其他程序可以通过 ServiceLoader 查找这个 jar 包的配置文件，根据其中的实现类名加载并实例化，然后使用实现类提供的功能。</p>
<h2 id=示例>示例</h2>
<ol>
<li>
<p>定义接口</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Serach</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>serach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>keyword</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>实现接口</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FileSearch</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Search</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>search</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>keyword</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>...;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DatabaseSearch</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Search</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>search</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>keyword</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>...;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>在 <code>/resource/META-INF/services/</code> 目录下创建 <code>com.example.Search</code> 文件，在其中添加我们要使用的某个实现类的完全限定名，如<code>com.example.FileSearch</code>。</p>
</li>
<li>
<p>加载接口实现类</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Search</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>impls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SeraiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Serach</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Serach</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>itor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>impls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>itor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>()){</span>
  <span style=color:#000>Search</span> <span style=color:#000>search</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>itor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#000>search</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>search</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;keyword&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
</ol>
<h2 id=实际应用>实际应用</h2>
<h3 id=jdbc-drivermanager>JDBC DriverManager</h3>
<ul>
<li>JDBC 接口定义：首先 Java 中定义了接口 <code>java.sql.Driver</code>。</li>
<li>MySQL 实现类：在 mysql-connector-java-version.jar 中，可以找打 <code>META-INF/services</code> 目录查看其中的 <code>java.sql.Driver</code> 文件，其中定义了实现类名 <code>com.mysql.cj.jdbc.Driver</code>。</li>
<li>加载实现类：<code>DriverManager.getConnection(uil,username,password)</code>。</li>
</ul>
<p>DriverManager 的具体加载过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>loadInitialDrivers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>String</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jdbc.drivers&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			      <span style=color:#8f5902;font-style:italic>//使用SPI的ServiceLoader来加载接口的实现
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loadedDrivers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Driver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>driversIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loadedDrivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>driversIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>driversIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Do nothing
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>});</span>

    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DriverManager.initialize: jdbc.drivers = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>drivers</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>driversList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>drivers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;:&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;number of Drivers:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>driversList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>aDriver</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>driversList</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DriverManager.Initialize: loading &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>aDriver</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aDriver</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;DriverManager.Initialize: load failed: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>从系统变量中获取有关驱动的定义。</li>
<li>使用 SPI 获取驱动实现。</li>
<li>遍历 SPI 获取到的具体实现类，实例化各个实现类。</li>
<li>根据第一步得到的驱动列表实例化具体实现类。</li>
</ol>
<h3 id=common-logging>Common Logging</h3>
<p>通过 <code>LogFactory.getLog</code> 获取日志实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span> <span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>LogConfigurationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clazz</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>LogFactory 是一个抽象类，它负责加载具体的日志实现，具体过程为：</p>
<ol>
<li>从 JVM 系统属性获取相关配置</li>
<li>使用 SPI 查找得到 <code>org.apache.commons.logging.LogFactory</code> 实现</li>
<li>查找 classpath 根目录 <code>commons-logging.properties</code> 的属性是否设置特定的实现</li>
<li>使用默认实现类</li>
</ol>
<h3 id=eclipse-osgi-插件体系>Eclipse OSGI 插件体系</h3>
<p>Eclipse使用OSGi作为插件系统的基础，动态添加新插件和停止现有插件，以动态的方式管理组件生命周期。</p>
<p>一般来说，插件的文件结构必须在指定目录下包含以下三个文件：</p>
<ul>
<li><code>META-INF/MANIFEST.MF</code>: 项目基本配置信息，版本、名称、启动器等</li>
<li><code>build.properties</code>: 项目的编译配置信息，包括，源代码路径、输出路径</li>
<li><code>plugin.xml</code>：插件的操作配置信息，包含弹出菜单及点击菜单后对应的操作执行类等</li>
</ul>
<p>当eclipse启动时，会遍历plugins文件夹中的目录，扫描每个插件的清单文件<code>MANIFEST.MF</code>，并建立一个内部模型来记录它所找到的每个插件的信息，就实现了动态添加新的插件。</p>
<p>这也意味着是 eclipse 制定了一系列的规则，像是文件结构、类型、参数等。插件开发者遵循这些规则去开发自己的插件，eclipse并不需要知道插件具体是怎样开发的，只需要在启动的时候根据配置文件解析、加载到系统里就好了，是spi思想的一种体现。</p>
<h3 id=spring-factory>Spring Factory</h3>
<p>在 springboot 的自动装配过程中，最终会加载<code>META-INF/spring.factories</code>文件，而加载的过程是由<code>SpringFactoriesLoader</code>加载的。从 CLASSPATH 下的每个 Jar 包中搜寻所有<code>META-INF/spring.factories</code>配置文件，然后将解析 properties 文件，找到指定名称的配置后返回。需要注意的是，其实这里不仅仅是会去 ClassPath 路径下查找，会扫描所有路径下的 Jar 包，只不过这个文件只会在 Classpath 下的 jar 包中。</p>
<h2 id=实现原理>实现原理</h2>
<p>ServiceLoader 的具体实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ServiceLoader实现了Iterable接口，可以遍历所有的服务实现者
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>//查找配置文件的目录
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>PREFIX</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;META-INF/services/&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//表示要被加载的服务的类或接口
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//这个ClassLoader用来定位，加载，实例化服务提供者
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 访问控制上下文
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AccessControlContext</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 缓存已经被实例化的服务提供者，按照实例化的顺序存储
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>providers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

    <span style=color:#8f5902;font-style:italic>// 迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LazyIterator</span> <span style=color:#000>lookupIterator</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//重新加载，就相当于重新创建ServiceLoader了，用于新的服务提供者安装到正在运行的Java虚拟机中的情况。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reload</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//清空缓存中所有已实例化的服务提供者
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//新建一个迭代器，该迭代器会从头查找和实例化服务提供者
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>lookupIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LazyIterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//私有构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//使用指定的类加载器和服务创建服务加载器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//如果没有指定类加载器，使用系统类加载器，就是应用类加载器。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Service interface cannot be null&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>reload</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//解析失败处理的方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceConfigurationError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceConfigurationError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//解析服务提供者配置文件中的一行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//首先去掉注释校验，然后保存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//返回下一行行号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//重复的配置项和已经被实例化的配置项不会被保存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parseLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BufferedReader</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//读取一行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLine</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//#号代表注释行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ci</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;#&#39;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ci</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>substring</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ci</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trim</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;\t&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal configuration-file syntax&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>codePointAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isJavaIdentifierStart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal provider-class name: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>charCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>charCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>codePointAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Character</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isJavaIdentifierPart</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Illegal provider-class name: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//解析配置文件，解析指定的url配置文件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//使用parseLine方法进行解析，未被实例化的服务提供者会被保存到缓存中去
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>URL</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ServiceConfigurationError</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>BufferedReader</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>names</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;utf-8&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parseLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//服务提供者查找的迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LazyIterator</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//服务提供者接口
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//类加载器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Enumeration</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//保存实现类的url
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pending</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//保存实现类的全名
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//迭代器中下一个实现类的全名
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>LazyIterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>String</span> <span style=color:#000>fullName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PREFIX</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fullName</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>configs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getResources</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fullName</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>pending</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>pending</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>configs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasMoreElements</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>pending</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>configs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextElement</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pending</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>S</span> <span style=color:#000>nextService</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchElementException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>String</span> <span style=color:#000>cn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextName</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>nextName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAssignableFrom</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Provider &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>cn</span>  <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; not a subtype&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>S</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Boolean</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hasNextService</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>};</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>S</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextService</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>S</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextService</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>};</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AccessController</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doPrivileged</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//获取迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//返回遍历服务提供者的迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//以懒加载的方式加载可用的服务提供者
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//懒加载的实现是：解析配置文件和实例化服务提供者的工作由迭代器本身完成
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//按照实例化顺序返回已经缓存的服务提供者实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>knownProviders</span>
                <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>providers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>entrySet</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasNext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>knownProviders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lookupIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>S</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>knownProviders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>knownProviders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getValue</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lookupIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#ce5c00;font-weight:700>};</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//为指定的服务使用指定的类加载器来创建一个ServiceLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//使用线程上下文的类加载器来创建ServiceLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getContextClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//使用扩展类加载器为指定的服务创建ServiceLoader
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//只能找到并加载已经安装到当前Java虚拟机中的服务提供者，应用程序类路径中的服务提供者将被忽略
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>loadInstalled</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ClassLoader</span> <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ClassLoader</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>cl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParent</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ServiceLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>load</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;java.util.ServiceLoader[&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;]&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>SeriviceLoader 实现了 Iterable 接口，所有具有迭代器属性，即 hasNext 和 next。其中主要是调用 lookupIterator 的对应 hasNext 和 next 方法，lookupIterator 为懒加载迭代器。</li>
<li>LazyIterator 中的 hasNext 方法，静态变量 PREFIX 为 <code>META-INF/services</code> 目录。</li>
<li>通过反射 <code>Class.forName</code> 加载类对象，并通过 <code>newInstance</code> 方法创建实现类的实例，并将实例缓存，然后返回实例对象。</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-61a3edbc37a3608cfbaf7dad804b84bd>2 - Java 集合</h1>
</div>
<div class=td-content>
<h1 id=pg-9e8a75006f7a17815de402a2a07ceaac>2.1 - CH01-集合结构</h1>
<h2 id=层级结构>层级结构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210415234343.png style=display:block;width:100% alt=NAME align=center> </div>
<h2 id=选择参考>选择参考</h2>
<div align=center> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/选择 java 集合.jpeg" style=display:block;width:100% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c93c4bd7f10427b83bf9de2474281b19>2.2 - CH02-ArrayList</h1>
<h2 id=概述>概述</h2>
<ul>
<li>ArrayList 实现了 List 接口，是顺序型容器，允许 NULL 元素，底层结构为<strong>数组</strong>。</li>
<li>除了没有实现线程安全，其余实现与 Vector 类似。</li>
<li>拥有容量(capacity)属性，表示底层数组大小，实际元素个数不能大于容量。</li>
<li>容量不足以承载更多元素时，会执行扩容。</li>
<li>size、isEmpty、get、set 均可在常数时间内完成。</li>
<li>add 的时间开销与插入位置有关。</li>
<li>addAll 的时间开销与所要添加元素的个数成正比。</li>
<li>其余方法大多为线性时间。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210415235405.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=内部实现>内部实现</h2>
<h3 id=数据结构>数据结构</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>;</span> 

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=构造函数>构造函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f57900>著作权归https:</span><span style=color:#8f5902;font-style:italic>//pdai.tech所有。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>链接</span><span style=color:#a40000>：</span><span style=color:#000>https</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#8f5902;font-style:italic>//www.pdai.tech/md/java/collection/java-collection-ArrayList.html
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Illegal Capacity: &#34;</span><span style=color:#ce5c00;font-weight:700>+</span>
                                           <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 10
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// c.toArray might (incorrectly) not return Object[] (see 6260652)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// replace with empty array.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=自动扩容>自动扩容</h3>
<p>每当向数组中添加元素时，都要去检查添加后元素的个数是否会超出当前数组的长度，如果超出，数组将会进行扩容，以满足添加数据的需求。数组扩容通过一个公开的方法ensureCapacity(int minCapacity)来实现。在实际添加大量元素前，我也可以使用ensureCapacity来手动增加ArrayList实例的容量，以减少递增式再分配的数量。</p>
<p>数组进行扩容时，会将老数组中的元素重新拷贝一份到新的数组中，每次数组容量的增长大约是其原容量的 <strong>1.5</strong> 倍。这种操作的代价是很高的，因此在实际使用时，我们应该尽量避免数组容量的扩张。当我们可预知要保存的元素的多少时，要在构造ArrayList实例时，就指定其容量，以避免数组扩容的发生。或者根据实际需求，通过调用ensureCapacity方法来手动增加ArrayList实例的容量。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Increases the capacity of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance, if
</span><span style=color:#8f5902;font-style:italic> * necessary, to ensure that it can hold at least the number of elements
</span><span style=color:#8f5902;font-style:italic> * specified by the minimum capacity argument.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param   minCapacity   the desired minimum capacity
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensureCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minExpand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#8f5902;font-style:italic>// any size if not default element table
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span>
        <span style=color:#8f5902;font-style:italic>// larger than default for default empty table. It&#39;s already
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// supposed to be at default size.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>DEFAULT_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>minExpand</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ensureExplicitCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensureCapacityInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DEFAULT_CAPACITY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>ensureExplicitCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensureExplicitCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>

    <span style=color:#8f5902;font-style:italic>// overflow-conscious code
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * The maximum size of array to allocate.
</span><span style=color:#8f5902;font-style:italic> * Some VMs reserve some header words in an array.
</span><span style=color:#8f5902;font-style:italic> * Attempts to allocate larger arrays may result in
</span><span style=color:#8f5902;font-style:italic> * OutOfMemoryError: Requested array size exceeds VM limit
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAX_ARRAY_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Increases the capacity to ensure that it can hold at least the
</span><span style=color:#8f5902;font-style:italic> * number of elements specified by the minimum capacity argument.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param minCapacity the desired minimum capacity
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// overflow-conscious code
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>MAX_ARRAY_SIZE</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hugeCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// minCapacity is usually close to size, so this is a win:
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hugeCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// overflow
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OutOfMemoryError</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
        <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210415235949.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=addaddall>add/addAll</h3>
<p>添加单个元素的方法 <code>add(E e)</code> 和 <code>add(int index, E e)</code>，在执行之前都需要检查剩余容量，如果需要则自动扩容，即执行 grow 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ensureCapacityInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// Increments modCount!!
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>rangeCheckForAdd</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>ensureCapacityInternal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// Increments modCount!!
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416000249.png style=display:block;width:50% alt=NAME align=center> </div>
<p><code>add(int index, E e)</code> 首先需要移动元素，然后完成插入操作，因此具有线性时间的复杂度。</p>
<p><code>addAll()</code> 能够一次添加多个元素，根据添加的位置拥有两种版本的实现：</p>
<ul>
<li>向末尾添加：<code>addAll(Collection&lt;? extends E> c)</code></li>
<li>向指定位置添加：<code>addAll(int index, Collection&lt;? extends E> c)</code></li>
</ul>
<p>在插入之前也需要扩容检查，如果需要就执行扩容。如果插入指定位置，也需要移动元素。因此同时与插入元素的数据和插入的位置相关。</p>
<h3 id=set>set</h3>
<p>首先执行越界检查，然后对数组指定位置的元素赋值。</p>
<h3 id=get>get</h3>
<p>首先执行越界检查，然后数组指定位置的元素值，最后转换类型。</p>
<h3 id=remove>remove</h3>
<ul>
<li><code>remove(int index)</code> 删除指定位置的元素</li>
<li><code>remove(Object o)</code> 删除第一满足 equals 条件的元素</li>
</ul>
<p>remove 是 add 的逆操作，需要将删除位置之后的元素向前移动。</p>
<p>为了让 GC 起作用，必须显式的为最后一个位置赋值为 null，即解除引用。如果不设为 null，那么该位置将会继续引用原有的对象，除非被一个新的对象覆盖。</p>
<h3 id=trimtosize>trimToSize</h3>
<p>该方法可以将数组的容量调整为当前实际元素的个数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Trims the capacity of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance to be the
</span><span style=color:#8f5902;font-style:italic> * list&#39;s current size.  An application can use this operation to minimize
</span><span style=color:#8f5902;font-style:italic> * the storage of an &lt;tt&gt;ArrayList&lt;/tt&gt; instance.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>trimToSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>elementData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
          <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>EMPTY_ELEMENTDATA</span>
          <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=indexof-lastindexof>indexOf, lastIndexOf</h3>
<p>分别获取第一次和最后一次出现的元素位置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]==</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lastIndexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]==</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=fail-fast-机制>fail-fast 机制</h3>
<p>通过记录 modCount 的值，在面对并发修改时，迭代器很快就会完全失败，避免在将来某个不确定时间发生任意不确定行为。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-48df1d0ce925ac81862ec101158004e8>2.3 - CH03-LinkedList</h1>
<h2 id=概述>概述</h2>
<ul>
<li><em>LinkedList</em> 同时实现了 <em>List</em> 接口和 <em>Deque</em> 接口，也就是说它既可以看作一个顺序容器，又可以看作一个队列(<em>Queue</em>)，同时又可以看作一个栈(<em>Stack</em>)。</li>
<li>栈或队列，现在的首选是 <em>ArrayDeque</em>，它有着比 <em>LinkedList</em> (当作栈或队列使用时)有着更好的性能。</li>
<li>所有跟下标相关的操作都是线性时间。</li>
<li>在首段或者末尾删除元素只需要常数时间。</li>
<li>为追求效率 <em>LinkedList</em> 没有实现同步(synchronized)。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416002232.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=内部实现>内部实现</h2>
<h3 id=数据结构>数据结构</h3>
<ul>
<li>底层<strong>通过双向链表实现</strong>。</li>
<li>双向链表的每个节点用内部类 <em>Node</em> 表示。</li>
<li><em>LinkedList</em> 通过<code>first</code>和<code>last</code>引用分别指向链表的第一个和最后一个元素。</li>
<li>当链表为空的时候<code>first</code>和<code>last</code>都指向<code>null</code>。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Pointer to first node.
</span><span style=color:#8f5902;font-style:italic> * Invariant: (first == null &amp;&amp; last == null) ||
</span><span style=color:#8f5902;font-style:italic> *            (first.prev == null &amp;&amp; first.item != null)
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Pointer to last node.
</span><span style=color:#8f5902;font-style:italic> * Invariant: (first == null &amp;&amp; last == null) ||
</span><span style=color:#8f5902;font-style:italic> *            (last.next == null &amp;&amp; last.item != null)
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>E</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=构造函数>构造函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Constructs an empty list.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Constructs a list containing the elements of the specified
</span><span style=color:#8f5902;font-style:italic> * collection, in the order they are returned by the collection&#39;s
</span><span style=color:#8f5902;font-style:italic> * iterator.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param  c the collection whose elements are to be placed into this list
</span><span style=color:#8f5902;font-style:italic> * @throws NullPointerException if the specified collection is null
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=getfirst-getlast>getFirst, getLast</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f57900>著作权归https:</span><span style=color:#8f5902;font-style:italic>//pdai.tech所有。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>链接</span><span style=color:#a40000>：</span><span style=color:#000>https</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#8f5902;font-style:italic>//www.pdai.tech/md/java/collection/java-collection-LinkedList.html
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Returns the first element in this list.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @return the first element in this list
</span><span style=color:#8f5902;font-style:italic> * @throws NoSuchElementException if this list is empty
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>getFirst</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchElementException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Returns the last element in this list.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @return the last element in this list
</span><span style=color:#8f5902;font-style:italic> * @throws NoSuchElementException if this list is empty
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>getLast</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchElementException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=removefirest-removelast-removee-removeindex>removeFirest(), removeLast(), remove(e), remove(index)</h3>
<p>remove 可以删除首个 equals 指定对象的元素，或者删除指定位置的元素。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416002720.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=add>add</h3>
<p><strong><code>add(E e)</code></strong> 将在末尾添加元素，因为 last 指向链表的末尾元素，因此操作为常数时间，仅需修改几个相关的引用即可。</p>
<p><code>add(int index, E element)</code> 是在指定位置插入元素，首选需要线性查找到具体位置，然后修改相关引用，完成操作。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416003106.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=addall>addAll</h3>
<p>addAll(index, c) 实现方式并不是直接调用add(index,e)来实现，主要是因为效率的问题，另一个是fail-fast中modCount只会增加1次；</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Appends all of the elements in the specified collection to the end of
</span><span style=color:#8f5902;font-style:italic> * this list, in the order that they are returned by the specified
</span><span style=color:#8f5902;font-style:italic> * collection&#39;s iterator.  The behavior of this operation is undefined if
</span><span style=color:#8f5902;font-style:italic> * the specified collection is modified while the operation is in
</span><span style=color:#8f5902;font-style:italic> * progress.  (Note that this will occur if the specified collection is
</span><span style=color:#8f5902;font-style:italic> * this list, and it&#39;s nonempty.)
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param c collection containing elements to be added to this list
</span><span style=color:#8f5902;font-style:italic> * @return {@code true} if this list changed as a result of the call
</span><span style=color:#8f5902;font-style:italic> * @throws NullPointerException if the specified collection is null
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Inserts all of the elements in the specified collection into this
</span><span style=color:#8f5902;font-style:italic> * list, starting at the specified position.  Shifts the element
</span><span style=color:#8f5902;font-style:italic> * currently at that position (if any) and any subsequent elements to
</span><span style=color:#8f5902;font-style:italic> * the right (increases their indices).  The new elements will appear
</span><span style=color:#8f5902;font-style:italic> * in the list in the order that they are returned by the
</span><span style=color:#8f5902;font-style:italic> * specified collection&#39;s iterator.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @param index index at which to insert the first element
</span><span style=color:#8f5902;font-style:italic> *              from the specified collection
</span><span style=color:#8f5902;font-style:italic> * @param c collection containing elements to be added to this list
</span><span style=color:#8f5902;font-style:italic> * @return {@code true} if this list changed as a result of the call
</span><span style=color:#8f5902;font-style:italic> * @throws IndexOutOfBoundsException {@inheritDoc}
</span><span style=color:#8f5902;font-style:italic> * @throws NullPointerException if the specified collection is null
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkPositionIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numNew</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numNew</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>E</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>numNew</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=clear>clear</h3>
<p>为了让GC更快可以回收放置的元素，需要将node之间的引用关系赋值为 null。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Removes all of the elements from this list.
</span><span style=color:#8f5902;font-style:italic> * The list will be empty after this call returns.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Clearing all of the links between nodes is &#34;unnecessary&#34;, but:
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// - helps a generational GC if the discarded nodes inhabit
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//   more than one generation
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// - is sure to free memory even if there is a reachable Iterator
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=positional-access-方法>Positional Access 方法</h3>
<p>通过 index 获取元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkElementIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 index 赋值元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkElementIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>E</span> <span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldVal</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 index 插入元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkPositionIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>linkLast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#000>linkBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 index 删除元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>checkElementIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>unlink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=查找>查找</h3>
<p>即查找元素的下标，查找第一次出现元素值相等的 index，否则返回 -1：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>查找最后一次出现的元素则类似，区别是从 last 开始向前查找。</p>
<h3 id=queue-方法>Queue 方法</h3>
<ul>
<li>peek</li>
<li>element</li>
<li>poll</li>
<li>remove</li>
<li>offer</li>
</ul>
<h3 id=deque-方法>Deque 方法</h3>
<ul>
<li>offerFirst</li>
<li>offerLast</li>
<li>peekFirst</li>
<li>peekLast</li>
<li>pollFirst</li>
<li>pollLast</li>
<li>push</li>
<li>pop</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9fb71bee1e68918221ae7c442ef8c2ca>2.4 - CH04-Stack-Queue</h1>
<h2 id=概述>概述</h2>
<ul>
<li>Java 中存在 Stack 实现类，但没有提供 Queue 实现类，仅有一个 Queue 接口。</li>
<li>但是在需要使用栈时，Java 推荐的结果是更加高效的 ArrayQueue。</li>
<li>在需要使用队列时，首选是 ArrayQueue，其次是 LinkedList。</li>
</ul>
<h2 id=queue>Queue</h2>
<p>Queue 接口继承自 Collection 接口，除了最基本的 Collection 方法之外，还额外支持 insertion、extraction、inspection 操作。这里有两组格式共 6 个方法，一组是抛出异常的实现，一组是返回值的实现(或 null)。</p>
<table>
<thead>
<tr>
<th></th>
<th>Throws Exception</th>
<th>Returns special Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td>add(e)</td>
<td>offer(e)</td>
</tr>
<tr>
<td>Remove</td>
<td>remove()</td>
<td>poll()</td>
</tr>
<tr>
<td>Examine</td>
<td>element()</td>
<td>peek()</td>
</tr>
</tbody>
</table>
<h2 id=deque>Deque</h2>
<p>Deque 是 &ldquo;double ended queue&rdquo;，表示双向队列，英文读作 <code>deck</code>。Deque 继承自 Queue 接口，除了支持 Queue 的方法外，还支持 insert、remove、examine 操作。</p>
<p>由于 Deque 是双向的，所以可以支持队列的头尾操作，同时支持两种格式共 12 个方法：</p>
<table>
<thead>
<tr>
<th></th>
<th>First Element-Head</th>
<th></th>
<th>Last Element-Tail</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>Throws Exception</td>
<td>Special Value</td>
<td>Throws Exception</td>
<td>Speicial Value</td>
</tr>
<tr>
<td>Insert</td>
<td>addFirst(e)</td>
<td>offerFirst(e)</td>
<td>addLast(e)</td>
<td>offerLast(e)</td>
</tr>
<tr>
<td>Remove</td>
<td>removeFirst()</td>
<td>pollFirst()</td>
<td>removeLast()</td>
<td>pollLast()</td>
</tr>
<tr>
<td>Examine</td>
<td>getFirst()</td>
<td>peekFirst()</td>
<td>getLast()</td>
<td>peekLast()</td>
</tr>
</tbody>
</table>
<p>当把 Deque 当做 FIFO 来使用时，元素是从 deque 的尾部添加，从头部进行删除。所谓 Deque 的部分方法和 Queue 是等同的。</p>
<table>
<thead>
<tr>
<th>Queue Method</th>
<th>Equivalent Deque Method</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>add(e)</td>
<td>addLast(e)</td>
<td>向队尾添加元素，失败时抛异常</td>
</tr>
<tr>
<td>offer(e)</td>
<td>offerLast(e)</td>
<td>向队尾添加元素，失败时返回 false</td>
</tr>
<tr>
<td>remove()</td>
<td>removeFirst()</td>
<td>获取并删除队首元素，失败时抛异常</td>
</tr>
<tr>
<td>poll()</td>
<td>pollFirst()</td>
<td>获取并删除队首元素，失败时返回 null</td>
</tr>
<tr>
<td>element()</td>
<td>getFirst()</td>
<td>获取但不删除队首元素，失败时抛异常</td>
</tr>
<tr>
<td>peek()</td>
<td>peekFirst()</td>
<td>获取但不删除队首元素，失败时返回 null</td>
</tr>
</tbody>
</table>
<p>Deque 与 Stack 的对应方法：</p>
<table>
<thead>
<tr>
<th>Stack Method</th>
<th>Equivalent Deque Method</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>push(e)</td>
<td>addFirst(e)</td>
<td>向栈顶插入元素，失败则抛出异常</td>
</tr>
<tr>
<td>无</td>
<td>offerFirst(e)</td>
<td>向栈顶插入元素，失败则返回<code>false</code></td>
</tr>
<tr>
<td>pop()</td>
<td>removeFirst()</td>
<td>获取并删除栈顶元素，失败则抛出异常</td>
</tr>
<tr>
<td>无</td>
<td>pollFirst()</td>
<td>获取并删除栈顶元素，失败则返回<code>null</code></td>
</tr>
<tr>
<td>peek()</td>
<td>peekFirst()</td>
<td>获取但不删除栈顶元素，失败则抛出异常</td>
</tr>
<tr>
<td>无</td>
<td>peekFirst()</td>
<td>获取但不删除栈顶元素，失败则返回<code>null</code></td>
</tr>
</tbody>
</table>
<p>以上操作中，除非对容量有限制，否则添加操作是不会失败的。</p>
<h3 id=arraydeque>ArrayDeque</h3>
<p>ArrayDeque 底层为数组结构，为了满足可以同时在数组两端添加或删除元素，该数组必须是循环数组，即数组的任何一点都可能被看做起点或终点。</p>
<p>ArrayDeque 非线程安全，不能添加 null 元素。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416234951.png style=display:block;width:50% alt=NAME align=center> </div>
<p>head 指向首端第一个有效元素，tail 指向尾端第一个可以插入元素的空位。</p>
<p>因为是循环数组，所谓 head 的位置不一定是 0，tail 的位置也不一定总是比 head 的位置大。</p>
<h4 id=addfirst>addFirst</h4>
<p>在 Deque 首端添加元素，也就是在 head 前面添加元素，在空间足够且下标没有越界的情况下，只需要将 <code>elements[--head]=e</code> 即可。即将 head 的索引递减 1 的位置赋值为新加的元素。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416235158.png style=display:block;width:50% alt=NAME align=center> </div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//addFirst(E e)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//不允许放入null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//2.下标是否越界
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//1.空间是否够用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>doubleCapacity</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//扩容
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码中可以发现，空间问题是在插入之后开始解决的，因为 tail 总是指向下一个可插入的空位，也就意味着 elements 数组至少会存在一个空位，所以插入元素时不用先考虑空间问题。</p>
<p>下标越界的解决方法很简单，<code>head = (head -1) & (elements.length -1)</code>即可，这段代码相当于取余，同时解决了 head 值为负的情况。因为 <code>elements.length</code> 必须是 2 的指数倍，<code>elements -1</code> 就是二进制低位全为 1，跟 <code>head-1</code> 相与之后就起到了取模的作用，如果 <code>head-1</code>为负(-1)，则相当于对其取 <code>elements.length</code> 的补码。</p>
<p>对于扩容函数 <code>doubleCapacity</code>，其逻辑就是申请一个更大的数组(原数据的两倍空间)，然后复制原来的元素。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416235747.png style=display:block;width:50% alt=NAME align=center> </div>
<p>复制分为两次，第一次复制 head 右边的元素，第二次复制 head 左边的数据。</p>
<h4 id=addlast>addLast</h4>
<p>作用是在 <em>Deque</em> 的尾端插入元素，也就是在<code>tail</code>的位置插入元素，由于<code>tail</code>总是指向下一个可以插入的空位，因此只需要<code>elements[tail] = e;</code>即可。插入完成后再检查空间，如果空间已经用光，则调用<code>doubleCapacity()</code>进行扩容。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210416235929.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=poolfirst>poolFirst</h4>
<p>作用是删除并返回 <em>Deque</em> 首端元素，也即是<code>head</code>位置处的元素。如果容器不空，只需要直接返回<code>elements[head]</code>即可，当然还需要处理下标的问题。由于<code>ArrayDeque</code>中不允许放入<code>null</code>，当<code>elements[head] == null</code>时，意味着容器为空。</p>
<h4 id=polllast>pollLast</h4>
<p>作用是删除并返回<em>Deque</em>尾端元素，也即是<code>tail</code>位置前面的那个元素。</p>
<h4 id=peekfirst>peekFirst</h4>
<p>作用是返回但不删除<em>Deque</em>首端元素，也即是<code>head</code>位置处的元素，直接返回<code>elements[head]</code>即可。</p>
<h4 id=peeklast>peekLast</h4>
<p>作用是返回但不删除<em>Deque</em>尾端元素，也即是<code>tail</code>位置前面的那个元素。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b005967a957a79af16207594d64d8017>2.5 - CH05-PriorityQueue</h1>
<h2 id=概览>概览</h2>
<ul>
<li><strong>优先队列的作用是能保证每次取出的元素都是队列中权值最小的</strong>。</li>
<li><strong>元素大小的评判可以通过元素本身的自然顺序(natural ordering)，也可以通过构造时传入的比较器</strong>。</li>
<li>Java 中 <em>PriorityQueue</em> 实现了 <em>Queue</em> 接口，不允许放入<code>null</code>元素。</li>
<li>底层结构为堆，通过完全二叉树实现的小顶堆，表示可以通过数组作为实现结构。</li>
<li><em>PriorityQueue <em>的<code>peek()</code>和<code>element()</code>操作是常数时间，<code>add()</code>, <code>offer()</code>, 无参数的<code>remove()</code>以及<code>poll()</code>方法的时间复杂度都是</em>log(N)</em>。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210417000430.png style=display:block;width:50% alt=NAME align=center> </div>
<p>观察上图中每个元素的索引编号，会发现父节点与子节点的编号存在联系：</p>
<ul>
<li>leftNo = parentNo*2+1</li>
<li>rightNo = parentNo*2+2</li>
<li>parentNo = (nodeNo-1)/2</li>
</ul>
<p>通过这三个公式，可以轻易计算出某个节点的父节点以及子节点的索引编号。即可以通过数组来实现存储堆。</p>
<h2 id=方法实现>方法实现</h2>
<h3 id=add--offer>add & offer</h3>
<p>两者语义相同，都是相对列中添加元素，只是 Queue 接口规定二者对插入失败是的处理方式不同，前者抛出异常，后者返回 false。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210417000855.png style=display:block;width:50% alt=NAME align=center> </div>
<p>新加入的元素可能会破坏小顶堆的性质，因此需要进行必要的调整。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//offer(E e)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//不允许放入null元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//自动扩容
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//队列原来为空，这是插入的第一个元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#000>siftUp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//调整
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扩容函数 grow 类似于 ArrayList 中的 grow 函数，申请更大空间的数组并复制数据。</p>
<p><code>siftUp(int k, E x)</code> 方法用于插入元素 x 同时维持堆的特性：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//siftUp()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>siftUp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//parentNo = (nodeNo-1)/2
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//调用比较器的比较方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调整过程为：从 k 指定的位置开始，将 x 逐层与当前点的 parent 进行比较并交换，直到满足 <code>x >= queue[parent]</code> 为止。</p>
<h3 id=element--peek>element & peek</h3>
<p>语义完全相同，都是获取但不删除队首元素，也就是队列中权值最小的那个元素，二者唯一的区别是当方法失败时前者抛出异常，后者返回<code>null</code>。</p>
<p>根据小顶堆的性质，堆顶那个元素就是全局最小的那个；由于堆用数组表示，根据下标关系，<code>0</code>下标处的那个元素既是堆顶元素。所以<strong>直接返回数组<code>0</code>下标处的那个元素即可</strong>。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210417001629.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=remove--poll>remove & poll</h3>
<p>语义也完全相同，都是获取并删除队首元素，区别是当方法失败时前者抛出异常，后者返回<code>null</code>。</p>
<p>由于删除操作会改变队列的结构，为维护小顶堆的性质，需要进行必要的调整。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210417001703.png style=display:block;width:50% alt=NAME align=center> </div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#000>E</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span><span style=color:#8f5902;font-style:italic>//0下标处的那个元素就是最小的那个
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>E</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>siftDown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//调整
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码首先记录<code>0</code>下标处的元素，并用最后一个元素替换<code>0</code>下标位置的元素，之后调用<code>siftDown()</code>方法对堆进行调整，最后返回原来<code>0</code>下标处的那个元素(也就是最小的那个元素)。</p>
<p>重点是<code>siftDown(int k, E x)</code>方法，该方法的作用是<strong>从<code>k</code>指定的位置开始，将<code>x</code>逐层向下与当前点的左右孩子中较小的那个交换，直到<code>x</code>小于或等于左右孩子中的任何一个为止</strong>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//siftDown()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>siftDown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>half</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>half</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    	<span style=color:#8f5902;font-style:italic>//首先找到左右孩子中较小的那个，记录到c里，并用child记录其下标
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//leftNo = parentNo*2+1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compare</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//然后用c取代原来的值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=remove>remove</h3>
<p>用于删除队列中跟<code>o</code>相等的某一个元素(如果有多个相等，只删除一个)，该方法不是<em>Queue</em>接口内的方法，而是<em>Collection</em>接口的方法。由于删除操作会改变队列结构，所以要进行调整；又由于删除元素的位置可能是任意的，所以调整过程比其它函数稍加繁琐。具体来说，<code>remove(Object o)</code>可以分为2种情况: 1. 删除的是最后一个元素。直接删除即可，不需要调整。2. 删除的不是最后一个元素，从删除点开始以最后一个元素为参照调用一次<code>siftDown()</code>即可。此处不再赘述。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//remove(Object o)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>//通过遍历数组的方式找到第一个满足o.equals(queue[i])元素的下标
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>indexOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//情况1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>E</span> <span style=color:#000>moved</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>siftDown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>moved</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//情况2
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2e9b99aead949946dd62cc48fdb4f247>2.6 - CH06-HashSet-Map</h1>
<h2 id=概述>概述</h2>
<ul>
<li>HashSet 与 HashMap 在 Java 内部的实现类似，前者仅仅是对后者进行了封装。</li>
<li>HashMap 实现了 Map 接口，允许放入 null key 和 null value。</li>
<li>与 HashTable 的区别在于没有实现同步。</li>
<li>与 TreeMap 的区别在于不保证元素顺序。</li>
<li>采用冲突链表(Sepratate chaining with linked lists)解决哈希冲突。
<ul>
<li>另一种实现是开放地址方式(Open Addressing)。</li>
</ul>
</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418152835.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如果选择合适的哈希函数，put 与 get 方法可以在常数内完成。但是在对 HashMap 执行迭代时，需要遍历整个 table 以及后边跟的冲突链表。因此对于迭代频繁的场景，不宜将 HashMap 的初始大小设置的过大。</p>
<p>有两个参数可以影响 HashMap 的性能：初始容量(inital capacity)和负载系数(load factor)。</p>
<p>初始容量指定了初始 table 的大小，负载系数用来指定自动扩容的临界值。当 entry 的数量超过 <code>capacity * load-factor</code> 时，容器将自动扩容并重新哈希。对于插入元素较多的场景，将初始容量设置较大可以减少重新哈希的次数。</p>
<p>将对象放入到 HashSet 和 HashMap 时，有两个方法要格外留意：hashCode 和 equals。</p>
<p>hashCode 方法决定了对象会被放到哪个 bucket 中，当多个对象的哈希值冲突，equals 方法决定了这些对象是否是同一个对象。因此，如果要将自定义的对象放入到 HashMap 或 HashSet，需要重写 hashCode 和 equals 方法。</p>
<h2 id=hashmap>HashMap</h2>
<h3 id=get>get</h3>
<p><code>get(Object key)</code>方法根据指定的<code>key</code>值返回对应的<code>value</code>，该方法调用了<code>getEntry(Object key)</code>得到相应的<code>entry</code>，然后返回<code>entry.getValue()</code>。因此<code>getEntry()</code>是算法的核心。 算法思想是首先通过<code>hash()</code>函数得到对应<code>bucket</code>的下标，然后依次遍历冲突链表，通过<code>key.equals(k)</code>方法来判断是否是要找的那个<code>entry</code>。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418153601.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图中 <code>hash(k) & (table.length-1)</code> 等价于 <code>hash(k) % table.length</code>，原因是 HashMap 要求 <code>table.length</code> 均为 2 的指数，因此 <code>table.length -1</code> 就是二进制低位全是 1，跟 <code>hash(k)</code> 相与会将哈希值的高位全部抹掉，剩下的就是余数了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//getEntry()方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>......</span>
	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>&amp;(</span><span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)];</span><span style=color:#8f5902;font-style:italic>//得到冲突链表
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//依次遍历冲突链表中的每个entry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Object</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//依据equals()方法判断是否相等
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))))</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=put>put</h3>
<p><code>put(K key, V value)</code>方法是将指定的<code>key, value</code>对添加到<code>map</code>里。该方法首先会对<code>map</code>做一次查找，看是否包含该元组，如果已经包含则直接返回，查找过程类似于<code>getEntry()</code>方法；如果没有找到，则会通过<code>addEntry(int hash, K key, V value, int bucketIndex)</code>方法插入新的<code>entry</code>，插入方式为<strong>头插法</strong>。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418153949.png style=display:block;width:50% alt=NAME align=center> </div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//addEntry()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>]))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>resize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//自动扩容，并重新哈希
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>bucketIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//hash%table.length
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//在冲突链表头部插入新的entry
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=remove>remove</h3>
<p><code>remove(Object key)</code>的作用是删除<code>key</code>值对应的<code>entry</code>，该方法的具体逻辑是在<code>removeEntryForKey(Object key)</code>里实现的。<code>removeEntryForKey()</code>方法会首先找到<code>key</code>值对应的<code>entry</code>，然后删除该<code>entry</code>(修改链表的相应引用)。查找过程跟<code>getEntry()</code>过程类似。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418154043.png style=display:block;width:50% alt=NAME align=center> </div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//removeEntryForKey()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>removeEntryForKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>......</span>
	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>indexFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//hash&amp;(table.length-1)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span><span style=color:#8f5902;font-style:italic>//得到冲突链表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//遍历冲突链表
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Object</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//找到要删除的entry
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>--;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//删除的是冲突链表的第一个entry
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=hashset>HashSet</h2>
<p><em>HashSet</em>是对<em>HashMap</em>的简单包装，对<em>HashSet</em>的函数调用都会转换成合适的<em>HashMap</em>方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//HashSet是对HashMap的简单包装
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>......</span>
  <span style=color:#8f5902;font-style:italic>//HashSet里面有一个HashMap
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Dummy value to associate with an Object in the backing Map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>PRESENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//简单的方法转换
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PRESENT</span><span style=color:#ce5c00;font-weight:700>)==</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>......</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-53c5ba778adbb04df8b45622790f8231>2.7 - CH07-LinkedHashSet-Map</h1>
<h2 id=概述>概述</h2>
<ul>
<li>LinkedHashSet 和 LinkedHashMap 在 Java 中也是类似的实现，前者只是对后者的简单封装。</li>
<li>LinkedHashMap 实现了 Map 接口，允许放入 null key 和 null value。</li>
<li>同时满足 HashMap 和 linked list 的一些特性。</li>
<li>可以将 LinkedHashMap 看做是通过 linked list 增强的 HashMap。</li>
<li>LinkedHashMap 是 HashMap 的直接子类，二者唯一的区别是 LinkedHashMap 在 HashMap 的基础上，采用双向链表的形式将所有 entry 连接起来，以保证元素的迭代顺序和插入顺序相同。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418160718.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如上图，相比 HashMap，在 entry 部分多了个属性用于连接所有 entry。而 header 用于指向双向链表的头部。</p>
<p>这种结构体还有一个好处，迭代时不需要像 HashMap 那样遍历整个 table，只需要遍历 header 指向的双向链表即可。也就是说，LinkedHashMap 的迭代时间只和 entry 的数量相关，与 table 的大小无关。</p>
<p>有两个参数可以影响 LinkedHashMap 的性能：初始容量(inital capacity)和负载系数(load factor)。初始容量指定了 table 的大小，负载系数用来指定自动扩容的临界值。当<code>entry</code>的数量超过<code>capacity*load_factor</code>时，容器将自动扩容并重新哈希。对于插入元素较多的场景，将初始容量设大可以减少重新哈希的次数。</p>
<p>著作权归https://pdai.tech所有。 链接：https://www.pdai.tech/md/java/collection/java-map-LinkedHashMap&LinkedHashSet.html</p>
<p>将对象放入到<em>LinkedHashMap</em>或<em>LinkedHashSet</em>中时，有两个方法需要特别关心: <code>hashCode()</code>和<code>equals()</code>。<strong><code>hashCode()</code>方法决定了对象会被放到哪个<code>bucket</code>里，当多个对象的哈希值冲突时，<code>equals()</code>方法决定了这些对象是否是“同一个对象”</strong>。所以，如果要将自定义的对象放入到<code>LinkedHashMap</code>或<code>LinkedHashSet</code>中，需要重写 <code>hashCode()</code>和<code>equals()</code>方法。</p>
<h2 id=内部实现>内部实现</h2>
<h3 id=get>get</h3>
<p><code>get(Object key)</code>方法根据指定的<code>key</code>值返回对应的<code>value</code>。该方法跟<code>HashMap.get()</code>方法的流程几乎完全一样。</p>
<h3 id=put>put</h3>
<p><code>put(K key, V value)</code>方法是将指定的<code>key, value</code>对添加到<code>map</code>里。该方法首先会对<code>map</code>做一次查找，看是否包含该元组，如果已经包含则直接返回，查找过程类似于<code>get()</code>方法；如果没有找到，则会通过<code>addEntry(int hash, K key, V value, int bucketIndex)</code>方法插入新的<code>entry</code>。</p>
<p>注意这里的插入有两重含义：</p>
<ul>
<li>从 table 的角度看，新的 entry 需要插入到对应的 bucket 中，当有哈希冲突时，采用头插法将新的 entry 插入到冲突链表的头部。</li>
<li>从 header 的角度看，新的 entry 需要插入到双向链表大尾部。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418162108.png style=display:block;width:50% alt=NAME align=center> </div>
<p>addEntry 的实现逻辑：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// LinkedHashMap.addEntry()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>]))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>resize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// 自动扩容，并重新哈希
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>bucketIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// hash%table.length
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 1.在冲突链表头部插入新的entry
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>old</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>old</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>bucketIndex</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 2.在双向链表的尾部插入新的entry
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>header</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码中用到了 addBefore 方法将新的 entry 插入到双向链表头引用的 header 的前面，这样 e 就称为双向链表中的最后一个元素。addBefore 的实现逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// LinkedHashMap.Entry.addBefor()，将this插入到existingEntry的前面
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addBefore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>existingEntry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>after</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>existingEntry</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>before</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>existingEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>before</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>after</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>after</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>before</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述到吗只是简单的修改 entry 的引用就实现了整个逻辑。</p>
<h3 id=remove>remove</h3>
<p><code>remove(Object key)</code>的作用是删除<code>key</code>值对应的<code>entry</code>，该方法的具体逻辑是在<code>removeEntryForKey(Object key)</code>里实现的。<code>removeEntryForKey()</code>方法会首先找到<code>key</code>值对应的<code>entry</code>，然后删除该<code>entry</code>(修改链表的相应引用)。查找过程跟<code>get()</code>方法类似。</p>
<p>注意这里的删除也有两重含义：</p>
<ul>
<li>从 table 的角度看，需要将 entry 从对应的 bucket 中删除，如果对应的冲突链表不为空，需要修改冲突链表的引用。</li>
<li>从 header 的角度看，需要将该 entry 从双向链表中删除，同时修改链表中前置和后置元素的引用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418162444.png style=display:block;width:50% alt=NAME align=center> </div>
<p>removeEntryForKey 的实现逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// LinkedHashMap.removeEntryForKey()，删除key值对应的entry
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>removeEntryForKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>......</span>
	<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>indexFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// hash&amp;(table.length-1)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span><span style=color:#8f5902;font-style:italic>// 得到冲突链表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 遍历冲突链表
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Object</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 找到要删除的entry
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>--;</span>
            <span style=color:#8f5902;font-style:italic>// 1. 将e从对应bucket的冲突链表中删除
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 2. 将e从双向链表中删除
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>before</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>after</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>after</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>after</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>before</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>before</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=linkedhashset>LinkedHashSet</h2>
<p><em>LinkedHashSet</em>是对<em>LinkedHashMap</em>的简单包装，对<em>LinkedHashSet</em>的函数调用都会转换成合适的<em>LinkedHashMap</em>方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Cloneable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#8f5902;font-style:italic>// LinkedHashSet里面有一个LinkedHashMap
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>LinkedHashSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//简单的方法转换
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PRESENT</span><span style=color:#ce5c00;font-weight:700>)==</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>......</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=常用场景>常用场景</h2>
<p><em>LinkedHashMap</em>除了可以保证迭代顺序外，还有一个非常有用的用法: 可以轻松实现一个采用了FIFO替换策略的缓存。具体说来，LinkedHashMap有一个子类方法<code>protected boolean removeEldestEntry(Map.Entry&lt;K,V> eldest)</code>，该方法的作用是告诉Map是否要删除“最老”的Entry，所谓最老就是当前Map中最早插入的Entry，如果该方法返回<code>true</code>，最老的那个元素就会被删除。在每次插入新元素的之后LinkedHashMap会自动询问removeEldestEntry()是否要删除最老的元素。这样只需要在子类中重载该方法，当元素个数超过一定数量时让removeEldestEntry()返回true，就能够实现一个固定大小的FIFO策略的缓存。示例代码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FifoCache</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>LinkedHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FifoCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#5c35cc;font-weight:700>@Override</span>
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removeEldestEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>eldest</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-15698d282bde407a6dd9a4f3fda4c629>2.8 - CH08-TreeSet-Map</h1>
<h2 id=概述>概述</h2>
<ul>
<li>TreeSet 和 TreeMap 在 Java 中具有类似的实现，前者仅仅是对后者的简单封装。</li>
<li><em>TreeMap</em>实现了<em>SortedMap</em>接口，也就是说会按照<code>key</code>的大小顺序对<em>Map</em>中的元素进行排序，<code>key</code>大小的评判可以通过其本身的自然顺序(natural ordering)，也可以通过构造时传入的比较器(Comparator)。</li>
<li>*<strong>TreeMap*底层通过红黑树(Red-Black tree)实现</strong>，也就意味着<code>containsKey()</code>, <code>get()</code>, <code>put()</code>, <code>remove()</code>都有着<code>log(n)</code>的时间复杂度。</li>
<li>出于性能原因，<em>TreeMap</em>是非同步的(not synchronized)。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418163144.png style=display:block;width:50% alt=NAME align=center> </div>
<p>红黑树是一种近似平衡的二叉查找树，它能保证任何一个节点的左右子树的高度差不会超过二者中较低那个的一倍。</p>
<p>具体来说，红黑树是满足如下条件的二叉查找树：</p>
<ul>
<li>每个节点要么是红色，要么是黑色。</li>
<li>根节点必须是黑色。</li>
<li>红色节点不能有连续(父子节点均不能为红色)。</li>
<li>对于每个节点，从该节点至 null(树尾)的任何路径，都含有相同个数的黑色节点。</li>
</ul>
<p>在树的结构发生改变时(插入或删除)，往往会破坏上面的 3 和 4，需要执行调整以使得重新满足所有条件。</p>
<h2 id=树操作>树操作</h2>
<p>调整可以分为两类，颜色调整和结构调整。</p>
<h3 id=结构调整左旋>结构调整：左旋</h3>
<p>左旋的过程就是想 X 的右子树绕 X 向左方向(逆时针)旋转，使 X 的右子树称为 X 的父亲，同时修改相关节点的引用。旋转之后，二叉查找树的条件仍然满足。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418163757.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=结构调整右旋>结构调整：右旋</h3>
<p>右旋的过程是将 X 的左子树绕 X 向右方向(顺时针)旋转，使 X 的左子树称为 X 的父亲，同时修改相关的引用。旋转之后，二叉查找树的条件仍然满足。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418163954.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=寻找节点后继>寻找节点后继</h3>
<p>对二叉查找树，给定节点 T，其后继(树中大于 T 的最小元素)可以通过如下方式找到：</p>
<ul>
<li>T 的右子树不空，则 T 的后继是其右子树中最小的按个元素。</li>
<li>T 的右子树为空，则 T 的后继是其第一个向左走的父亲。</li>
</ul>
<p>该操作用于删除红黑树中的删除操作。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418164210.png style=display:block;width:50% alt=NAME align=center> </div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 寻找节点后继函数successor()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>TreeMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>successor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 1. t的右子树不空，则t的后继是其右子树中最小的那个元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 2. t的右孩子为空，则t的后继是其第一个向左走的祖先
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=内部实现>内部实现</h2>
<h3 id=get>get</h3>
<p><code>get(Object key)</code>方法根据指定的<code>key</code>值返回对应的<code>value</code>，该方法调用了<code>getEntry(Object key)</code>得到相应的<code>entry</code>，然后返回<code>entry.value</code>。因此<code>getEntry()</code>是算法的核心。算法思想是根据<code>key</code>的自然顺序(或者比较器顺序)对二叉查找树进行查找，直到找到满足<code>k.compareTo(p.key) == 0</code>的<code>entry</code>。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418164344.png style=display:block;width:50% alt=NAME align=center> </div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//getEntry()方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//不允许key值为null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//使用元素的自然顺序
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cmp</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//向左找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cmp</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//向右找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=put>put</h3>
<p><code>put(K key, V value)</code>方法是将指定的<code>key</code>, <code>value</code>对添加到<code>map</code>里。该方法首先会对<code>map</code>做一次查找，看是否包含该元组，如果已经包含则直接返回，查找过程类似于<code>getEntry()</code>方法；如果没有找到则会在红黑树中插入新的<code>entry</code>，如果插入之后破坏了红黑树的约束条件，还需要进行调整(旋转，改变某些节点的颜色)。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cmp</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//使用元素的自然顺序
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>cmp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cmp</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//向左找
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cmp</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//向右找
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//创建并插入新的entry
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cmp</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>fixAfterInsertion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//调整
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码首先在红黑树上找到合适的位置，然后创建新的 entry 并插入(插入的节点一定是叶子)。难点是调整函数 fixAfterInsertion，需要执行颜色调整和结构调整。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418164833.png style=display:block;width:50% alt=NAME align=center> </div>
<p>调整函数的具体实现如下，其中用到了前面提到的 rotateLeft 和 rotateRight 函数。通过代码我们可以看到，情况 2 其实是落在情况 3 内。情况 4~6 跟前三种情况是对称的，因此图解中没有展示后 3 种情况。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//红黑树调整函数fixAfterInsertion()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fixAfterInsertion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>color</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>color</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)));</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>              <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>                        <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>                 <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>                       <span style=color:#8f5902;font-style:italic>// 情况2
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>                         <span style=color:#8f5902;font-style:italic>// 情况2
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>              <span style=color:#8f5902;font-style:italic>// 情况3
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 情况3
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)));</span>        <span style=color:#8f5902;font-style:italic>// 情况3
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)));</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>              <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>                        <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>                 <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>                       <span style=color:#8f5902;font-style:italic>// 情况5
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>                        <span style=color:#8f5902;font-style:italic>// 情况5
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>              <span style=color:#8f5902;font-style:italic>// 情况6
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 情况6
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)));</span>         <span style=color:#8f5902;font-style:italic>// 情况6
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>color</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=remove>remove</h3>
<p><code>remove(Object key)</code>的作用是删除<code>key</code>值对应的<code>entry</code>，该方法首先通过上文中提到的<code>getEntry(Object key)</code>方法找到<code>key</code>值对应的<code>entry</code>，然后调用<code>deleteEntry(Entry&lt;K,V> entry)</code>删除对应的<code>entry</code>。由于删除操作会改变红黑树的结构，有可能破坏红黑树的约束条件，因此有可能要进行调整。</p>
<p><code>getEntry()</code>函数前面已经讲解过，这里重点放<code>deleteEntry()</code>上，该函数删除指定的<code>entry</code>并在红黑树的约束被破坏时进行调用<code>fixAfterDeletion(Entry&lt;K,V> x)</code>进行调整。</p>
<p><strong>由于红黑树是一棵增强版的二叉查找树，红黑树的删除操作跟普通二叉查找树的删除操作也就非常相似，唯一的区别是红黑树在节点删除之后可能需要进行调整</strong>。现在考虑一棵普通二叉查找树的删除过程，可以简单分为两种情况:</p>
<ol>
<li>
<p>删除节点 P 的左右子树都为空，或者只有一个子树为空。</p>
</li>
<li>
<p>删除节点 P 的左右子树都非空。</p>
</li>
</ol>
<p>对于上述情况1，处理起来比较简单，直接将p删除(左右子树都为空时)，或者用非空子树替代p(只有一棵子树非空时)；对于情况2，可以用p的后继s(树中大于x的最小的那个元素)代替p，然后使用情况1删除s(此时s一定满足情况1.可以画画看)。</p>
<p>基于以上逻辑，红黑树的节点删除函数<code>deleteEntry()</code>代码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 红黑树entry删除函数deleteEntry()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>deleteEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>--;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 2. 删除点p的左右子树都非空。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>successor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// 后继
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>replacement</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 1. 删除点p只有一棵子树非空。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>color</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>fixAfterDeletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>replacement</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// 调整
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 1. 删除点p的左右子树都为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>color</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>fixAfterDeletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// 调整
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述代码中占据大量代码行的，是用来修改父子节点间引用关系的代码，其逻辑并不难理解。下面着重讲解删除后调整函数<code>fixAfterDeletion()</code>。首先请思考一下，删除了哪些点才会导致调整？<strong>只有删除点是BLACK的时候，才会触发调整函数</strong>，因为删除RED节点不会破坏红黑树的任何约束，而删除BLACK节点会破坏规则4。</p>
<p>跟上文中讲过的<code>fixAfterInsertion()</code>函数一样，这里也要分成若干种情况。记住，<strong>无论有多少情况，具体的调整操作只有两种: 1.改变某些节点的颜色，2.对某些节点进行旋转。</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210418165249.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图的整体思路为：将情况 1 首先转换为情况 2，或者转换成 3 或 4。当然，该图解并不意味着调整情况一定是从情况 1 开始的。通过后续的代码我们会发现一些规则：</p>
<ul>
<li>如果是由情况 1 之后紧接着进入情况 2，那么情况 2 之后一定会退出循环(因为 X 为红色)。</li>
<li>一旦进入情况 3 和 4，一定会退出循环(因为 X 为 root)。</li>
</ul>
<p>删除后跳转函数 fixAfterDeletion 的具体实现如下，其中用到了上文中提到的<code>rotateLeft()</code>和<code>rotateRight()</code>函数。通过代码我们能够看到，情况3其实是落在情况4内的。情况5～情况8跟前四种情况是对称的，因此图解中并没有画出后四种情况，读者可以参考代码自行理解。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fixAfterDeletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>                   <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>             <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>                <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>             <span style=color:#8f5902;font-style:italic>// 情况1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>                     <span style=color:#8f5902;font-style:italic>// 情况2
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>                        <span style=color:#8f5902;font-style:italic>// 情况2
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>       <span style=color:#8f5902;font-style:italic>// 情况3
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>                 <span style=color:#8f5902;font-style:italic>// 情况3
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>);</span>                   <span style=color:#8f5902;font-style:italic>// 情况3
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>sib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>         <span style=color:#8f5902;font-style:italic>// 情况3
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)));</span>    <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>           <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>          <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>                <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;</span>                               <span style=color:#8f5902;font-style:italic>// 情况4
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 跟前四种情况对称
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>                   <span style=color:#8f5902;font-style:italic>// 情况5
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>             <span style=color:#8f5902;font-style:italic>// 情况5
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>               <span style=color:#8f5902;font-style:italic>// 情况5
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>              <span style=color:#8f5902;font-style:italic>// 情况5
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>                     <span style=color:#8f5902;font-style:italic>// 情况6
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>                        <span style=color:#8f5902;font-style:italic>// 情况6
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rightOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>      <span style=color:#8f5902;font-style:italic>// 情况7
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RED</span><span style=color:#ce5c00;font-weight:700>);</span>                 <span style=color:#8f5902;font-style:italic>// 情况7
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>rotateLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>);</span>                    <span style=color:#8f5902;font-style:italic>// 情况7
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>sib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>          <span style=color:#8f5902;font-style:italic>// 情况7
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>colorOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)));</span>    <span style=color:#8f5902;font-style:italic>// 情况8
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>           <span style=color:#8f5902;font-style:italic>// 情况8
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leftOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>           <span style=color:#8f5902;font-style:italic>// 情况8
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>rotateRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parentOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>));</span>               <span style=color:#8f5902;font-style:italic>// 情况8
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;</span>                               <span style=color:#8f5902;font-style:italic>// 情况8
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>setColor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLACK</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=treeset>TreeSet</h2>
<p>前面已经说过<code>TreeSet</code>是对<code>TreeMap</code>的简单包装，对<code>TreeSet</code>的函数调用都会转换成合适的<code>TreeMap</code>方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// TreeSet是对TreeMap的简单包装
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TreeSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>NavigableSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Cloneable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span>
<span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>NavigableMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Dummy value to associate with an Object in the backing Map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>PRESENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>TreeSet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;();</span><span style=color:#8f5902;font-style:italic>// TreeSet里面有一个TreeMap
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>......</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PRESENT</span><span style=color:#ce5c00;font-weight:700>)==</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>......</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6e1572f092a2c17050b065aec05eb034>2.9 - CH09-WeakHashMap</h1>
<h2 id=概述>概述</h2>
<p>它的特殊之处在于 <em>WeakHashMap</em> 里的<code>entry</code>可能会被GC自动删除，即使程序员没有调用<code>remove()</code>或者<code>clear()</code>方法。</p>
<p>当使用 <em>WeakHashMap</em> 时，即使没有显式的添加或删除任何元素，也可能发生如下情况:</p>
<ul>
<li>调用两次 size 方法所返回的结果不同。</li>
<li>调用两次 isEmpty 方法，第一次返回 false，第二次返回 true。</li>
<li>调用两次 containskey 方法，首次返回 true，第二次返回 false，尽管两次使用相同的 key。</li>
<li>调用两次 get 方法，首次返回 value，第二次返回 null，尽管两次使用相同的对象。</li>
</ul>
<p>这些特性尤其适用于需要缓存的场景。在缓存场景中，由于内存的局限，不能缓存所有对象，对象缓存命中可以提供系统效率，但缓存 MISS 也不会引起错误，因为可以通过计算重新得到。</p>
<p>Java 内存是通过 GC 自动管理的，GC 会在程序运行过程中自动判断哪些对象是可以被回收的，并在合适的时机执行内存释放。GC 判断某个对象释放可以被回收的依据是，释放有有效的引用指向该对象。如果没有有效引用指向该对象(即基本意味着不存在访问该对象的方式)，那么该对象就是可以被回收的。这里的有效应用并不包括弱引用。也就是说，虽然弱引用可以用来访问对象，但进行垃圾回收时弱引用并不会被考虑在内，仅有弱引用指向的对象仍然会被 GC 回收。</p>
<p>WeakHashMap 内部是通过弱引用来管理 entry 的，弱引用的特性应用到 WeakHashMap 上意味着什么呢？将一对 key value 放入到 WeakHashMap 中并不能避免该 key 被 GC 回收，除非在 WeakHashMap 在外还有对该 key 的强引用。</p>
<h3 id=具体实现>具体实现</h3>
<p>类似于 HashMap 和 HashSet。</p>
<h3 id=weakhashset>WeakHashSet</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>weakHashSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span>
  <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newSetFromMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WeakHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;());</span>
</code></pre></div><p>该工具方法可以直接将 Map 包装为 Set，只是对 Map 的简单封装。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Collections.newSetFromMap()用于将任何Map包装成一个Set
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newSetFromMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SetFromMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SetFromMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Serializable</span>
<span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// The backing map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// Its keySet
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SetFromMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Map is non-empty&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span>               <span style=color:#ce5c00;font-weight:700>{</span>        <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>()</span>                 <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()</span>          <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TRUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>()</span>     <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>toArray</span><span style=color:#ce5c00;font-weight:700>()</span>         <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span>          <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span>             <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>containsAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>containsAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>removeAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>retainAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>retainAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);}</span>
    <span style=color:#8f5902;font-style:italic>// addAll is the only inherited implementation
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>......</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b2b28a2eeff762b18c922f48171f8dad>2.10 - CH10-Stream</h1>
<p>Stream 是 JDK1.8 中首次引入的，距今已经过去了接近8年时间（JDK1.8正式版是2013年底发布的）。Stream 的引入一方面极大地简化了某些开发场景，另一方面也可能降低了编码的可读性（确实有不少人说到Stream会降低代码的可读性，但是在笔者看来，熟练使用之后反而觉得代码的可读性提高了）。这篇文章会花巨量篇幅，详细分析 Stream 的底层实现原理，参考的源码是 JDK11 的源码，其他版本 JDK 可能不适用于本文中的源码展示和相关例子。</p>
<h2 id=向前兼容>向前兼容</h2>
<p><code>Stream</code>是<code>JDK1.8</code>引入的，如要需要<code>JDK1.7</code>或者以前的代码也能在<code>JDK1.8</code>或以上运行，那么<code>Stream</code>的引入必定不能在原来已经发布的接口方法进行修改，否则必定会因为兼容性问题导致老版本的接口实现无法在新版本中运行（方法签名出现异常），猜测是基于这个问题引入了接口默认方法，也就是<code>default</code>关键字。查看源码可以发现，<code>ArrayList</code>的超类<code>Collection</code>和<code>Iterable</code>分别添加了数个<code>default</code>方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// java.util.Collection部分源码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Spliterators</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>StreamSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parallelStream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>StreamSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// java.lang.Iterable部分源码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Spliterators</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliteratorUnknownSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从直觉来看，这些新增的方法应该就是<code>Stream</code>实现的关键方法（后面会印证这不是直觉，而是查看源码的结果）。接口默认方法在使用上和实例方法一致，在实现上可以直接在接口方法中编写方法体，有点静态方法的意味，但是子类可以覆盖其实现（也就是接口默认方法在本接口中的实现有点像静态方法，可以被子类覆盖，使用上和实例方法一致）。这种实现方式，有可能是一种突破，也有可能是一种妥协，但是无论是妥协还是突破，都实现了向前兼容：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// JDK1.7中的java.lang.Iterable
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// JDK1.7中的Iterable实现
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyIterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>(){</span>
         <span style=color:#ce5c00;font-weight:700>....</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上，<code>MyIterable</code>在<code>JDK1.7</code>中定义，如果该类在<code>JDK1.8</code>中运行，那么调用其实例中的<code>forEach()</code>和<code>spliterator()</code>方法，相当于直接调用<code>JDK1.8</code>中的<code>Iterable</code>中的接口默认方法<code>forEach()</code>和<code>spliterator()</code>。当然受限于<code>JDK</code>版本，这里只能确保编译通过，旧功能正常使用，而无法在<code>JDK1.7</code>中使用<code>Stream</code>相关功能或者使用<code>default</code>方法关键字。总结这么多，就是想说明为什么使用<code>JDK7</code>开发和编译的代码可以在<code>JDK8</code>环境下运行。</p>
<h2 id=可拆分迭代器-spliterator>可拆分迭代器 Spliterator</h2>
<p><code>Stream</code>实现的基石是<code>Spliterator</code>，<code>Spliterator</code>是<code>splitable iterator</code>的缩写，意为"可拆分迭代器"，用于遍历指定数据源（例如数组、集合或者<code>IO Channel</code>等）中的元素，在设计上充分考虑了串行和并行的场景。上一节提到了<code>Collection</code>存在接口默认方法<code>spliterator()</code>，此方法会生成一个<code>Spliterator&lt;E></code>实例，意为着<strong>所有的集合子类都具备创建<code>Spliterator</code>实例的能力</strong>。<code>Stream</code>的实现在设计上和<code>Netty</code>中的<code>ChannelHandlerContext</code>十分相似，本质是一个链表，<strong>而<code>Spliterator</code>就是这个链表的<code>Head</code>节点</strong>（<code>Spliterator</code>实例就是一个流实例的头节点，后面分析具体的源码时候再具体展开）。</p>
<h3 id=spliterator-接口方法>Spliterator 接口方法</h3>
<p>接着看<code>Spliterator</code>接口定义的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>trySplit</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>estimateSize</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>getExactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SIZED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1L</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>estimateSize</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getComparator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>tryAdvance</strong></p>
<ul>
<li>方法签名：<code>boolean tryAdvance(Consumer&lt;? super T> action)</code></li>
<li>功能：如果<code>Spliterator</code>中存在剩余元素，则对其中的某个元素执行传入的<code>action</code>回调，并且返回<code>true</code>，否则返回<code>false</code>。如果<code>Spliterator</code>启用了<code>ORDERED</code>特性，会按照顺序（这里的顺序值可以类比为<code>ArrayList</code>中容器数组元素的下标，<code>ArrayList</code>中添加新元素是天然有序的，下标由零开始递增）处理下一个元素</li>
<li>例子：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>round</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>loop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;第%d轮回调Action,值:%d\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>round</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;第%d轮循环\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>第1轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>2</span>
<span style=color:#000>第1轮循环</span>
<span style=color:#000>第2轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1</span>
<span style=color:#000>第2轮循环</span>
<span style=color:#000>第3轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>3</span>
<span style=color:#000>第3轮循环</span>
</code></pre></div><p><strong>forEachRemaining</strong></p>
<ul>
<li>方法签名：<code>default void forEachRemaining(Consumer&lt;? super T> action)</code></li>
<li>功能：如果<code>Spliterator</code>中存在剩余元素，则对其中的<strong>所有剩余元素</strong>在<strong>当前线程中</strong>执行传入的<code>action</code>回调。如果<code>Spliterator</code>启用了<code>ORDERED</code>特性，会按照顺序处理剩余所有元素。这是一个接口默认方法，方法体比较粗暴，直接是一个死循环包裹着<code>tryAdvance()</code>方法，直到<code>false</code>退出循环</li>
<li>例子：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>round</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;第%d轮回调Action,值:%d\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>round</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>第1轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>2</span>
<span style=color:#000>第2轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1</span>
<span style=color:#000>第3轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>3</span>
</code></pre></div><p><strong>trySplit</strong></p>
<ul>
<li>方法签名：<code>Spliterator&lt;T> trySplit()</code></li>
<li>功能：如果当前的<code>Spliterator</code>是可分区（可分割）的，那么此方法将会返回一个全新的<code>Spliterator</code>实例，这个全新的<code>Spliterator</code>实例里面的元素不会被当前<code>Spliterator</code>实例中的元素覆盖（这里是直译了<code>API</code>注释，实际要表达的意思是：当前的<code>Spliterator</code>实例<code>X</code>是可分割的，<code>trySplit()</code>方法会分割<code>X</code>产生一个全新的<code>Spliterator</code>实例<code>Y</code>，原来的<code>X</code>所包含的元素（范围）也会收缩，类似于<code>X = [a,b,c,d] => X = [a,b], Y = [c,d]</code>；如果当前的<code>Spliterator</code>实例<code>X</code>是不可分割的，此方法会返回<code>NULL</code>），<strong>具体的分割算法由实现类决定</strong></li>
<li>例子：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>second</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trySplit</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;first spliterator item: %d\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>});</span>
    <span style=color:#000>second</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;second spliterator item: %d\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>first</span> <span style=color:#000>spliterator</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>4</span>
<span style=color:#000>first</span> <span style=color:#000>spliterator</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>1</span>
<span style=color:#000>second</span> <span style=color:#000>spliterator</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>2</span>
<span style=color:#000>second</span> <span style=color:#000>spliterator</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>3</span>
</code></pre></div><p><strong>estimateSize</strong></p>
<ul>
<li>方法签名：<code>long estimateSize()</code></li>
<li>功能：返回<code>forEachRemaining()</code>方法需要遍历的元素总量的估计值，如果样本个数是无限、计算成本过高或者未知，会直接返回<code>Long.MAX_VALUE</code></li>
<li>例子：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>estimateSize</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>4</span>
</code></pre></div><p><strong>getExactSizeIfKnown</strong></p>
<ul>
<li>方法签名：<code>default long getExactSizeIfKnown()</code></li>
<li>功能：如果当前的<code>Spliterator</code>具备<code>SIZED</code>特性（关于特性，下文再展开分析），那么直接调用<code>estimateSize()</code>方法，否则返回<code>-1</code></li>
<li>例子：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>4</span>
</code></pre></div><p><strong>int characteristics()</strong></p>
<ul>
<li>方法签名：<code>long estimateSize()</code></li>
<li>功能：当前的<code>Spliterator</code>具备的特性（集合），采用位运算，存储在<code>32</code>位整数中（关于特性，下文再展开分析）</li>
</ul>
<p><strong>hasCharacteristics</strong></p>
<ul>
<li>方法签名：<code>default boolean hasCharacteristics(int characteristics)</code></li>
<li>功能：判断当前的<code>Spliterator</code>是否具备传入的特性</li>
</ul>
<p><strong>getComparator</strong></p>
<ul>
<li>方法签名：<code>default Comparator&lt;? super T> getComparator()</code></li>
<li>功能：如果当前的<code>Spliterator</code>具备<code>SORTED</code>特性，则需要返回一个<code>Comparator</code>实例；如果<code>Spliterator</code>中的元素是天然有序（例如元素实现了<code>Comparable</code>接口），则返回<code>NULL</code>；其他情况直接抛出<code>IllegalStateException</code>异常</li>
</ul>
<h3 id=spliterator自分割>Spliterator自分割</h3>
<p><code>Spliterator#trySplit()</code>可以把一个既有的<code>Spliterator</code>实例分割为两个<code>Spliterator</code>实例，笔者这里把这种方式称为<code>Spliterator</code>自分割，示意图如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012223926.png style=display:block;width:80% alt=NAME align=center> </div>
<p>这里的分割在实现上可以采用两种方式：</p>
<ul>
<li>物理分割：对于<code>ArrayList</code>而言，把底层数组<strong>拷贝</strong>并且进行分割，用上面的例子来说相当于<code>X = [1,3,4,2] => X = [4,2], Y = [1,3]</code>，这样实现加上对于<code>ArrayList</code>中本身的元素容器数组，相当于多存了一份数据，显然不是十分合理</li>
<li>逻辑分割：对于<code>ArrayList</code>而言，由于元素容器数组天然有序，可以采用数组的索引（下标）进行分割，用上面的例子来说相当于<code>X = 索引表[0,1,2,3] => X = 索引表[2,3], Y = 索引表[0,1]</code>，这种方式是共享底层容器数组，只对元素索引进行分割，实现上比较简单而且相对合理</li>
</ul>
<p>参看<code>ArrayListSpliterator</code>的源码，可以分析其分割算法实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// ArrayList#spliterator()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayListSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// ArrayList中内部类ArrayListSpliterator
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayListSpliterator</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 当前的处理的元素索引值，其实是剩余元素的下边界值(包含)，在tryAdvance()或者trySplit()方法中被修改，一般初始值为0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 栅栏，其实是元素索引值的上边界值(不包含)，一般初始化的时候为-1，使用时具体值为元素索引值上边界加1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fence</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 预期的修改次数，一般初始化值等于modCount
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expectedModCount</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>ArrayListSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>origin</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fence</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expectedModCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>origin</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fence</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fence</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>expectedModCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expectedModCount</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取元素索引值的上边界值，如果小于0，则把hi和fence都赋值为(ArrayList中的)size，expectedModCount赋值为(ArrayList中的)modCount，返回上边界值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这里注意if条件中有赋值语句hi = fence，也就是此方法调用过程中临时变量hi总是重新赋值为fence，fence是ArrayListSpliterator实例中的成员属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getFence</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fence</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>expectedModCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fence</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// Spliterator自分割，这里采用了二分法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ArrayListSpliterator</span> <span style=color:#000>trySplit</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// hi等于当前ArrayListSpliterator实例中的fence变量，相当于获取剩余元素的上边界值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// lo等于当前ArrayListSpliterator实例中的index变量，相当于获取剩余元素的下边界值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// mid = (lo + hi) &gt;&gt;&gt; 1，这里的无符号右移动1位运算相当于(lo + hi)/2
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getFence</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 当lo &gt;= mid的时候为不可分割，返回NULL，否则，以index = lo,fence = mid和expectedModCount = expectedModCount创建一个新的ArrayListSpliterator
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这里有个细节之处，在新的ArrayListSpliterator构造参数中，当前的index被重新赋值为index = mid，这一点容易看漏，老程序员都喜欢做这样的赋值简化
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// lo &gt;= mid返回NULL的时候，不会创建新的ArrayListSpliterator，也不会修改当前ArrayListSpliterator中的参数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayListSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>expectedModCount</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// tryAdvance实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取迭代的上下边界
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getFence</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 由于前面分析下边界是包含关系，上边界是非包含关系，所以这里要i &lt; hi而不是i &lt;= hi
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 这里的elementData来自ArrayList中，也就是前文经常提到的元素数组容器，这里是直接通过元素索引访问容器中的数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>E</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#8f5902;font-style:italic>// 对传入的Action进行回调
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 并发修改异常判断
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>modCount</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>expectedModCount</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentModificationException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// forEachRemaining实现，这里没有采用默认实现，而是完全覆盖实现一个新方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这里会新建所需的中间变量，i为index的中间变量，hi为fence的中间变量，mc为expectedModCount的中间变量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mc</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 判断容器数组存在性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// hi、fence和mc初始化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fence</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>mc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expectedModCount</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 这里就是先做参数合法性校验，再遍历临时数组容器a中中[i,hi)的剩余元素对传入的Action进行回调
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 这里注意有一处隐蔽的赋值(index = hi)，下界被赋值为上界，意味着每个ArrayListSpliterator实例只能调用一次forEachRemaining()方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>E</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 这里校验ArrayList的modCount和mc是否一致，理论上在forEachRemaining()遍历期间，不能对数组容器进行元素的新增或者移除，一旦发生modCount更变会抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>modCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>mc</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentModificationException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取剩余元素估计值，就是用剩余元素索引上边界直接减去下边界
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>estimateSize</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getFence</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 具备ORDERED、SIZED和SUBSIZED特性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ORDERED</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZED</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SUBSIZED</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在阅读源码的时候务必注意，老一辈的程序员有时候会采用比较<strong>隐蔽</strong>的赋值方式，笔者认为需要展开一下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224007.png style=display:block;width:80% alt=NAME align=center> </div>
<p>第一处红圈位置在构建新的<code>ArrayListSpliterator</code>的时候，当前<code>ArrayListSpliterator</code>的<code>index</code>属性也被修改了，过程如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224026.png style=display:block;width:80% alt=NAME align=center> </div>
<p>第二处红圈位置，在<code>forEachRemaining()</code>方法调用时候做参数校验，并且<code>if</code>分支里面把<code>index</code>（下边界值）赋值为<code>hi</code>（上边界值），<strong>那么一个<code>ArrayListSpliterator</code>实例中的<code>forEachRemaining()</code>方法的遍历操作必定只会执行一次</strong>。可以这样验证一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>round</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[第一次遍历forEachRemaining]第%d轮回调Action,值:%d\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>round</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>round</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[第二次遍历forEachRemaining]第%d轮回调Action,值:%d\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>round</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>第一次遍历forEachRemaining</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000>第1轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>2</span>
<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>第一次遍历forEachRemaining</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000>第2轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1</span>
<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>第一次遍历forEachRemaining</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000>第3轮回调Action</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>值</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>3</span>
</code></pre></div><p>对于<code>ArrayListSpliterator</code>的实现可以确认下面几点：</p>
<ul>
<li>一个新的<code>ArrayListSpliterator</code>实例中的<code>forEachRemaining()</code>方法只能调用一次</li>
<li><code>ArrayListSpliterator</code>实例中的<code>forEachRemaining()</code>方法遍历元素的边界是<code>[index, fence)</code></li>
<li><code>ArrayListSpliterator</code>自分割的时候，分割出来的新<code>ArrayListSpliterator</code>负责处理元素下标小的分段（类比<code>fork</code>的左分支），而原<code>ArrayListSpliterator</code>负责处理元素下标大的分段（类比<code>fork</code>的右分支）</li>
<li><code>ArrayListSpliterator</code>提供的<code>estimateSize()</code>方法得到的分段元素剩余数量是一个准确值</li>
</ul>
<p>如果把上面的例子继续分割，可以得到下面的过程：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/stream-source-4.png style=display:block;width:80% alt=NAME align=center> </div>
<p><strong><code>Spliterator</code>自分割是并行流实现的基础</strong>，并行流计算过程其实就是<code>fork-join</code>的处理过程，<code>trySplit()</code>方法的实现决定了<code>fork</code>任务的粒度，每个<code>fork</code>任务进行计算的时候是并发安全的，这一点由线程封闭（线程栈封闭）保证，每一个<code>fork</code>任务计算完成最后的结果再由单个线程进行<code>join</code>操作，才能得到正确的结果。下面的例子是求整数<code>1 ~ 100</code>的和：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConcurrentSplitCalculateSum</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ForkTask</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ForkTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                        <span style=color:#000>CountDownLatch</span> <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>latch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;线程[%s]完成计算任务,当前段计算结果:%d,耗时:%d ms\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ForkTask</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tasks</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkTask</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>tasks</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>THREAD_NUM</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>101</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>spliteratorList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trySplit</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trySplit</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>z</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trySplit</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>spliteratorList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>spliteratorList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>spliteratorList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>spliteratorList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ForkTask</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tasks</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#000>CountDownLatch</span> <span style=color:#000>latch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>THREAD_NUM</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>THREAD_NUM</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>ForkTask</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForkTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliteratorList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fork-task-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>tasks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>tasks</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>join</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tasks</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;最终计算结果为:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>线程</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>fork</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000>完成计算任务</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>当前段计算结果</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1575</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>耗时</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>0</span> <span style=color:#000>ms</span>
<span style=color:#000>线程</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>fork</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000>完成计算任务</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>当前段计算结果</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>950</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>耗时</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1</span> <span style=color:#000>ms</span>
<span style=color:#000>线程</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>fork</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000>完成计算任务</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>当前段计算结果</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>325</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>耗时</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1</span> <span style=color:#000>ms</span>
<span style=color:#000>线程</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>fork</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000>完成计算任务</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>当前段计算结果</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>2200</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>耗时</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>1</span> <span style=color:#000>ms</span>
<span style=color:#f57900>最终计算结果为:</span><span style=color:#000>5050</span>
</code></pre></div><p>当然，最终并行流的计算用到了<code>ForkJoinPool</code>，并不像这个例子中这么粗暴地进行异步执行。关于并行流的实现下文会详细分析。</p>
<h3 id=spliterator-支持特性>Spliterator 支持特性</h3>
<p>某一个<code>Spliterator</code>实例支持的特性由方法<code>characteristics()</code>决定，这个方法返回的是一个<code>32</code>位数值，实际使用中会展开为<code>bit</code>数组，所有的特性分配在不同的位上，而<code>hasCharacteristics(int characteristics)</code>就是通过输入的具体特性值通过位运算判断该特性是否存在于<code>characteristics()</code>中。下面简化<code>characteristics</code>为<code>byte</code>分析一下这个技巧：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>假设：byte characteristics<span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#ce5c00;font-weight:700>=</span>&gt; 也就是最多8个位用于表示特性集合，如果每个位只表示一种特性，那么可以总共表示8种特性
特性X：0000 <span style=color:#0000cf;font-weight:700>0001</span>
特性Y：0000 <span style=color:#0000cf;font-weight:700>0010</span>
以此类推
假设：characteristics <span style=color:#ce5c00;font-weight:700>=</span> X <span style=color:#000;font-weight:700>|</span> <span style=color:#000>Y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000>0010</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0011</span>
那么：characteristics <span style=color:#000;font-weight:700>&amp;</span> <span style=color:#000>X</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0011</span> <span style=color:#000;font-weight:700>&amp;</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000>0001</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span>
判断characteristics是否包含X：<span style=color:#ce5c00;font-weight:700>(</span>characteristics <span style=color:#000;font-weight:700>&amp;</span> X<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> X
</code></pre></div><p>上面推断的过程就是<code>Spliterator</code>中特性判断方法的处理逻辑：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 返回特性集合
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#8f5902;font-style:italic>// 基于位运算判断特性集合中是否存在输入的特性
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里可以验证一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CharacteristicsCheck</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;是否存在ORDERED特性:%s\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hasCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ORDERED</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;是否存在SIZED特性:%s\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hasCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZED</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;是否存在DISTINCT特性:%s\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hasCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DISTINCT</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ORDERED</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZED</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f57900>是否存在ORDERED特性:</span><span style=color:#204a87;font-weight:700>true</span>
<span style=color:#f57900>是否存在SIZED特性:</span><span style=color:#204a87;font-weight:700>true</span>
<span style=color:#f57900>是否存在DISTINCT特性:</span><span style=color:#204a87;font-weight:700>false</span>
</code></pre></div><p>目前<code>Spliterator</code>支持的特性一共有<code>8</code>个，如下：</p>
<table>
<thead>
<tr>
<th style=text-align:center>特性</th>
<th style=text-align:center>十六进制值</th>
<th style=text-align:center>二进制值</th>
<th style=text-align:center>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center><code>DISTINCT</code></td>
<td style=text-align:center><code>0x00000001</code></td>
<td style=text-align:center><code>0000 0000 0000 0001</code></td>
<td style=text-align:center>去重，例如对于每对要处理的元素<code>(x,y)</code>，使用<code>!x.equals(y)</code>比较，<code>Spliterator</code>中去重实际上基于<code>Set</code>处理</td>
</tr>
<tr>
<td style=text-align:center><code>ORDERED</code></td>
<td style=text-align:center><code>0x00000010</code></td>
<td style=text-align:center><code>0000 0000 0001 0000</code></td>
<td style=text-align:center>（元素）顺序处理，可以理解为<code>trySplit()</code>、<code>tryAdvance()</code>和<code>forEachRemaining()</code>方法对所有元素处理都保证一个严格的前缀顺序</td>
</tr>
<tr>
<td style=text-align:center><code>SORTED</code></td>
<td style=text-align:center><code>0x00000004</code></td>
<td style=text-align:center><code>0000 0000 0000 0100</code></td>
<td style=text-align:center>排序，元素使用<code>getComparator()</code>方法提供的<code>Comparator</code>进行排序，如果定义了<code>SORTED</code>特性，则必须定义<code>ORDERED</code>特性</td>
</tr>
<tr>
<td style=text-align:center><code>SIZED</code></td>
<td style=text-align:center><code>0x00000040</code></td>
<td style=text-align:center><code>0000 0000 0100 0000</code></td>
<td style=text-align:center>（元素）预估数量，启用此特性，那么<code>Spliterator</code>拆分或者迭代之前，<code>estimateSize()</code>返回的是元素的准确数量</td>
</tr>
<tr>
<td style=text-align:center><code>NONNULL</code></td>
<td style=text-align:center><code>0x00000040</code></td>
<td style=text-align:center><code>0000 0001 0000 0000</code></td>
<td style=text-align:center>（元素）非<code>NULL</code>，数据源保证<code>Spliterator</code>需要处理的元素不能为<code>NULL</code>，最常用于并发容器中的集合、队列和<code>Map</code></td>
</tr>
<tr>
<td style=text-align:center><code>IMMUTABLE</code></td>
<td style=text-align:center><code>0x00000400</code></td>
<td style=text-align:center><code>0000 0100 0000 0000</code></td>
<td style=text-align:center>（元素）不可变，数据源不可被修改，也就是处理过程中元素不能被添加、替换和移除（更新属性是允许的）</td>
</tr>
<tr>
<td style=text-align:center><code>CONCURRENT</code></td>
<td style=text-align:center><code>0x00001000</code></td>
<td style=text-align:center><code>0001 0000 0000 0000</code></td>
<td style=text-align:center>（元素源）的修改是并发安全的，意味着多线程在数据源中添加、替换或者移除元素在不需要额外的同步条件下是并发安全的</td>
</tr>
<tr>
<td style=text-align:center><code>SUBSIZED</code></td>
<td style=text-align:center><code>0x00004000</code></td>
<td style=text-align:center><code>0100 0000 0000 0000</code></td>
<td style=text-align:center>（子<code>Spliterator</code>元素）预估数量，启用此特性，意味着通过<code>trySplit()</code>方法分割出来的所有子<code>Spliterator</code>（当前<code>Spliterator</code>分割后也属于子<code>Spliterator</code>）都启用<code>SIZED</code>特性</td>
</tr>
</tbody>
</table>
<blockquote>
<p>细心点观察可以发现：所有特性采用32位的整数存储，使用了隔1位存储的策略，位下标和特性的映射是：(0 => DISTINCT)、(3 => SORTED)、(5 => ORDERED)、(7=> SIZED)、(9 => NONNULL)、(11 => IMMUTABLE)、(13 => CONCURRENT)、(15 => SUBSIZED)</p>
</blockquote>
<p>所有特性的功能这里只概括了核心的定义，还有一些小字或者特例描述限于篇幅没有完全加上，这一点可以参考具体的源码中的<code>API</code>注释。这些特性最终会转化为<code>StreamOpFlag</code>再提供给<code>Stream</code>中的操作判断使用，由于<code>StreamOpFlag</code>会更加复杂，下文再进行详细分析。</p>
<h2 id=流的实现原理以及源码分析>流的实现原理以及源码分析</h2>
<p>由于流的实现是高度抽象的工程代码，所以在源码阅读上会有点困难。整个体系涉及到大量的接口、类和枚举，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224153.png style=display:block;width:80% alt=NAME align=center> </div>
<p>图中的顶层类结构图描述的就是流的流水线相关类继承关系，其中<code>IntStream</code>、<code>LongStream</code>和<code>DoubleStream</code>都是特化类型，分别针对于<code>Integer</code>、<code>Long</code>和<code>Double</code>三种类型，其他引用类型构建的<code>Pipeline</code>都是<code>ReferencePipeline</code>实例，因此笔者认为，<code>ReferencePipeline</code>（引用类型流水线）是流的核心数据结构，下面会基于<code>ReferencePipeline</code>的实现做深入分析。</p>
<h3 id=streamopflag源码分析>StreamOpFlag源码分析</h3>
<p><code>StreamOpFlag</code>是一个枚举，功能是存储<code>Stream</code>和操作的标志（<code>Flags corresponding to characteristics of streams and operations</code>，下称<code>Stream</code>标志），这些标志提供给<code>Stream</code>框架用于控制、定制化和优化计算。<code>Stream</code>标志可以用于描述与流相关联的若干不同实体的特征，这些实体包括：<code>Stream</code>的源、<code>Stream</code>的中间操作（<code>Op</code>）和<code>Stream</code>的终端操作（<code>Terminal Op</code>）。但是并非所有的<code>Stream</code>标志对所有的<code>Stream</code>实体都具备意义，目前这些实体和标志映射关系如下：</p>
<table>
<thead>
<tr>
<th style=text-align:center>Type(Stream Entity Type)</th>
<th style=text-align:center>DISTINCT</th>
<th style=text-align:center>SORTED</th>
<th style=text-align:center>ORDERED</th>
<th style=text-align:center>SIZED</th>
<th style=text-align:center>SHORT_CIRCUIT</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center><code>SPLITERATOR</code></td>
<td style=text-align:center>01</td>
<td style=text-align:center>01</td>
<td style=text-align:center>01</td>
<td style=text-align:center>01</td>
<td style=text-align:center>00</td>
</tr>
<tr>
<td style=text-align:center><code>STREAM</code></td>
<td style=text-align:center>01</td>
<td style=text-align:center>01</td>
<td style=text-align:center>01</td>
<td style=text-align:center>01</td>
<td style=text-align:center>00</td>
</tr>
<tr>
<td style=text-align:center><code>OP</code></td>
<td style=text-align:center>11</td>
<td style=text-align:center>11</td>
<td style=text-align:center>11</td>
<td style=text-align:center>10</td>
<td style=text-align:center>01</td>
</tr>
<tr>
<td style=text-align:center><code>TERMINAL_OP</code></td>
<td style=text-align:center>00</td>
<td style=text-align:center>00</td>
<td style=text-align:center>10</td>
<td style=text-align:center>00</td>
<td style=text-align:center>01</td>
</tr>
<tr>
<td style=text-align:center><code>UPSTREAM_TERMINAL_OP</code></td>
<td style=text-align:center>00</td>
<td style=text-align:center>00</td>
<td style=text-align:center>10</td>
<td style=text-align:center>00</td>
<td style=text-align:center>00</td>
</tr>
</tbody>
</table>
<p>其中：</p>
<ul>
<li>01：表示设置/注入</li>
<li>10：表示清除</li>
<li>11：表示保留</li>
<li>00：表示初始化值（默认填充值），这是一个关键点，<code>0</code>值表示绝对不会是某个类型的标志</li>
</ul>
<p><code>StreamOpFlag</code>的顶部注释中还有一个表格如下：</p>
<table>
<thead>
<tr>
<th style=text-align:center>-</th>
<th style=text-align:center>DISTINCT</th>
<th style=text-align:center>SORTED</th>
<th style=text-align:center>ORDERED</th>
<th style=text-align:center>SIZED</th>
<th style=text-align:center>SHORT_CIRCUIT</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Stream source（<code>Stream</code>的源）</td>
<td style=text-align:center>Y</td>
<td style=text-align:center>Y</td>
<td style=text-align:center>Y</td>
<td style=text-align:center>Y</td>
<td style=text-align:center>N</td>
</tr>
<tr>
<td style=text-align:center>Intermediate operation（中间操作）</td>
<td style=text-align:center>PCI</td>
<td style=text-align:center>PCI</td>
<td style=text-align:center>PCI</td>
<td style=text-align:center>PC</td>
<td style=text-align:center>PI</td>
</tr>
<tr>
<td style=text-align:center>Terminal operation（终结操作）</td>
<td style=text-align:center>N</td>
<td style=text-align:center>N</td>
<td style=text-align:center>PC</td>
<td style=text-align:center>N</td>
<td style=text-align:center>PI</td>
</tr>
</tbody>
</table>
<p>标记 <code>-></code> 含义：</p>
<ul>
<li><code>Y</code>：允许</li>
<li><code>N</code>：非法</li>
<li><code>P</code>：保留</li>
<li><code>C</code>：清除</li>
<li><code>I</code>：注入</li>
<li>组合<code>PCI</code>：可以保留、清除或者注入</li>
<li>组合<code>PC</code>：可以保留或者清除</li>
<li>组合<code>PI</code>：可以保留或者注入</li>
</ul>
<p>两个表格其实是在描述同一个结论，可以相互对照和理解，但是<strong>最终实现参照于第一个表的定义</strong>。注意一点：这里的<code>preserved</code>(<code>P</code>)表示保留的意思，如果<code>Stream</code>实体某个标志被赋值为<code>preserved</code>，意味着该实体可以使用此标志代表的特性。例如此小节第一个表格中的<code>OP</code>的<code>DISTINCT</code>、<code>SORTED</code>和<code>ORDERED</code>都赋值为<code>11</code>（<code>preserved</code>），意味着<code>OP</code>类型的实体允许使用去重、自然排序和顺序处理特性。回到源码部分，先看<code>StreamOpFlag</code>的核心属性和构造器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StreamOpFlag</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时忽略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 类型枚举，Stream相关实体类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Type</span> <span style=color:#ce5c00;font-weight:700>{</span>
         
        <span style=color:#8f5902;font-style:italic>// SPLITERATOR类型，关联所有和Spliterator相关的特性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>SPLITERATOR</span><span style=color:#ce5c00;font-weight:700>,</span>

        <span style=color:#8f5902;font-style:italic>// STREAM类型，关联所有和Stream相关的标志
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>STREAM</span><span style=color:#ce5c00;font-weight:700>,</span>

        <span style=color:#8f5902;font-style:italic>// STREAM类型，关联所有和Stream中间操作相关的标志
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>OP</span><span style=color:#ce5c00;font-weight:700>,</span>

        <span style=color:#8f5902;font-style:italic>// TERMINAL_OP类型，关联所有和Stream终结操作相关的标志
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>TERMINAL_OP</span><span style=color:#ce5c00;font-weight:700>,</span>

        <span style=color:#8f5902;font-style:italic>// UPSTREAM_TERMINAL_OP类型，关联所有在最后一个有状态操作边界上游传播的终止操作标志
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这个类型的意义直译有点拗口，不过实际上在JDK11源码中，这个类型没有被流相关功能引用，暂时可以忽略
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>UPSTREAM_TERMINAL_OP</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 设置/注入标志的bit模式，二进制数0001，十进制数1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SET_BITS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0b01</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 清除标志的bit模式，二进制数0010，十进制数2
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CLEAR_BITS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0b10</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 保留标志的bit模式，二进制数0011，十进制数3
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>PRESERVE_BITS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0b11</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 掩码建造器工厂方法，注意这个方法用于实例化MaskBuilder
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>MaskBuilder</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MaskBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EnumMap</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 私有静态内部类，掩码建造器，里面的map由上面的set(Type t)方法得知是EnumMap实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MaskBuilder</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Type -&gt; SET_BITS|CLEAR_BITS|PRESERVE_BITS|0
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>MaskBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
       
        <span style=color:#8f5902;font-style:italic>// 设置类型和对应的掩码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MaskBuilder</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 对类型添加/inject
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MaskBuilder</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SET_BITS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>MaskBuilder</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CLEAR_BITS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>MaskBuilder</span> <span style=color:#000>setAndClear</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PRESERVE_BITS</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 这里的build方法对于类型中的NULL掩码填充为0，然后把map返回
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIfAbsent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0b00</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 类型-&gt;掩码映射
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maskTable</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// bit的起始偏移量，控制下面set、clear和preserve的起始偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bitPosition</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// set/inject的bit set(map)，其实准确来说应该是一个表示set/inject的bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// clear的bit set(map)，其实准确来说应该是一个表示clear的bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// preserve的bit set(map)，其实准确来说应该是一个表示preserve的bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>preserve</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>position</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MaskBuilder</span> <span style=color:#000>maskBuilder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这里会基于MaskBuilder初始化内部的EnumMap
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maskTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>maskBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// Two bits per flag &lt;= 这里会把入参position放大一倍
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>position</span> <span style=color:#ce5c00;font-weight:700>*=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bitPosition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>position</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SET_BITS</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>position</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 设置/注入标志的bit模式左移2倍position
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CLEAR_BITS</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>position</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 清除标志的bit模式左移2倍position
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preserve</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PRESERVE_BITS</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>position</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 保留标志的bit模式左移2倍position
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略中间一些方法
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 下面这些静态变量就是直接返回标志对应的set/injec、清除和保留的bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to set or inject {@link #DISTINCT}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>IS_DISTINCT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DISTINCT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to clear {@link #DISTINCT}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NOT_DISTINCT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DISTINCT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to set or inject {@link #SORTED}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>IS_SORTED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to clear {@link #SORTED}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NOT_SORTED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to set or inject {@link #ORDERED}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>IS_ORDERED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ORDERED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to clear {@link #ORDERED}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NOT_ORDERED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ORDERED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to set {@link #SIZED}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>IS_SIZED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SIZED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to clear {@link #SIZED}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NOT_SIZED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SIZED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The bit value to inject {@link #SHORT_CIRCUIT}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>IS_SHORT_CIRCUIT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SHORT_CIRCUIT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>又因为<code>StreamOpFlag</code>是一个枚举，一个枚举成员是一个独立的标志，而一个标志会对多个<code>Stream</code>实体类型产生作用，所以它的一个成员描述的是上面实体和标志映射关系的一个列（竖着看）：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224245.png style=display:block;width:80% alt=NAME align=center> </div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>// 纵向看
DISTINCT Flag:
maskTable: <span style=color:#ce5c00;font-weight:700>{</span>
    SPLITERATOR:           <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    STREAM:                <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    OP:                    <span style=color:#0000cf;font-weight:700>0000</span> 0011,
    TERMINAL_OP:           <span style=color:#0000cf;font-weight:700>0000</span> 0000,
    UPSTREAM_TERMINAL_OP:  <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>
<span style=color:#ce5c00;font-weight:700>}</span>
position<span style=color:#ce5c00;font-weight:700>(</span>input<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>0</span>
bitPosition:     <span style=color:#0000cf;font-weight:700>0</span>
set:             <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span>
clear:           <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0010</span>
preserve:        <span style=color:#000>3</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0011</span>

SORTED Flag:
maskTable: <span style=color:#ce5c00;font-weight:700>{</span>
    SPLITERATOR:           <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    STREAM:                <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    OP:                    <span style=color:#0000cf;font-weight:700>0000</span> 0011,
    TERMINAL_OP:           <span style=color:#0000cf;font-weight:700>0000</span> 0000,
    UPSTREAM_TERMINAL_OP:  <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>
<span style=color:#ce5c00;font-weight:700>}</span>
position<span style=color:#ce5c00;font-weight:700>(</span>input<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>1</span> 
bitPosition:     <span style=color:#0000cf;font-weight:700>2</span>
set:             <span style=color:#000>4</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0100</span>
clear:           <span style=color:#000>8</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>1000</span>
preserve:       <span style=color:#000>12</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>1100</span>

ORDERED Flag:
maskTable: <span style=color:#ce5c00;font-weight:700>{</span>
    SPLITERATOR:           <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    STREAM:                <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    OP:                    <span style=color:#0000cf;font-weight:700>0000</span> 0011,
    TERMINAL_OP:           <span style=color:#0000cf;font-weight:700>0000</span> 0010,
    UPSTREAM_TERMINAL_OP:  <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0010</span>
<span style=color:#ce5c00;font-weight:700>}</span>
position<span style=color:#ce5c00;font-weight:700>(</span>input<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>2</span>
bitPosition:     <span style=color:#0000cf;font-weight:700>4</span> 
set:            <span style=color:#000>16</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#0000cf;font-weight:700>0000</span>
clear:          <span style=color:#000>32</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0010</span> <span style=color:#0000cf;font-weight:700>0000</span>
preserve:       <span style=color:#000>48</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0011</span> <span style=color:#0000cf;font-weight:700>0000</span>

SIZED Flag:
maskTable: <span style=color:#ce5c00;font-weight:700>{</span>
    SPLITERATOR:           <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    STREAM:                <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    OP:                    <span style=color:#0000cf;font-weight:700>0000</span> 0010,
    TERMINAL_OP:           <span style=color:#0000cf;font-weight:700>0000</span> 0000,
    UPSTREAM_TERMINAL_OP:  <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>
<span style=color:#ce5c00;font-weight:700>}</span>
position<span style=color:#ce5c00;font-weight:700>(</span>input<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>3</span>
bitPosition:     <span style=color:#0000cf;font-weight:700>6</span> 
set:            <span style=color:#000>64</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0100</span> <span style=color:#0000cf;font-weight:700>0000</span>
clear:         <span style=color:#000>128</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>1000</span> <span style=color:#0000cf;font-weight:700>0000</span>
preserve:      <span style=color:#000>192</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>1100</span> <span style=color:#0000cf;font-weight:700>0000</span>

SHORT_CIRCUIT Flag:
maskTable: <span style=color:#ce5c00;font-weight:700>{</span>
    SPLITERATOR:           <span style=color:#0000cf;font-weight:700>0000</span> 0000,
    STREAM:                <span style=color:#0000cf;font-weight:700>0000</span> 0000,
    OP:                    <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    TERMINAL_OP:           <span style=color:#0000cf;font-weight:700>0000</span> 0001,
    UPSTREAM_TERMINAL_OP:  <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>
<span style=color:#ce5c00;font-weight:700>}</span>
position<span style=color:#ce5c00;font-weight:700>(</span>input<span style=color:#ce5c00;font-weight:700>)</span>: <span style=color:#0000cf;font-weight:700>12</span>
bitPosition:     <span style=color:#0000cf;font-weight:700>24</span> 
set:       <span style=color:#000>16777216</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>
clear:     <span style=color:#000>33554432</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0010</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>   
preserve:  <span style=color:#000>50331648</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0011</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>
</code></pre></div><p>接着就用到按位与（<code>&</code>）和按位或（<code>|</code>）的操作，假设<code>A = 0001</code>、<code>B = 0010</code>、<code>C = 1000</code>，那么：</p>
<ul>
<li><code>A|B = A | B = 0001 | 0010 = 0011</code>（按位或，<code>1|0=1, 0|1=1,0|0 =0,1|1=1</code>）</li>
<li><code>A&B = A & B = 0001 | 0010 = 0000</code>（按位与，<code>1|0=0, 0|1=0,0|0 =0,1|1=1</code>）</li>
<li><code>MASK = A | B | C = 0001 | 0010 | 1000 = 1011</code></li>
<li>那么判断<code>A|B</code>是否包含<code>A</code>的条件为：<code>A == (A|B & A)</code></li>
<li>那么判断<code>MASK</code>是否包含<code>A</code>的条件为：<code>A == MASK & A</code></li>
</ul>
<p>这里把<code>StreamOpFlag</code>中的枚举套用进去分析：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DISTINCT_SET</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0b0001</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SORTED_CLEAR</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0b1000</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 支持DISTINCT标志和不支持SORTED标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DISTINCT_SET</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>SORTED_CLEAR</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toBinaryString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;支持DISTINCT标志:%s\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>DISTINCT_SET</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DISTINCT_SET</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;不支持SORTED标志:%s\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SORTED_CLEAR</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SORTED_CLEAR</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>1001</span>
<span style=color:#f57900>支持DISTINCT标志:</span><span style=color:#204a87;font-weight:700>true</span>
<span style=color:#f57900>不支持SORTED标志:</span><span style=color:#204a87;font-weight:700>true</span>
</code></pre></div><p>由于<code>StreamOpFlag</code>的修饰符是默认，不能直接使用，可以把它的代码拷贝出来修改包名验证里面的功能：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DISTINCT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DISTINCT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DISTINCT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 输出
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>true</span>
<span style=color:#204a87;font-weight:700>true</span>
</code></pre></div><p>下面这些方法就是基于这些运算特性而定义的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StreamOpFlag</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时忽略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 返回当前StreamOpFlag的set/inject的bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 返回当前StreamOpFlag的清除的bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 这里判断当前StreamOpFlag类型-&gt;标记映射中Stream类型的标记，如果大于0说明不是初始化状态，那么当前StreamOpFlag就是Stream相关的标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isStreamFlag</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>maskTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STREAM</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 这里就用到按位与判断输入的flags中是否设置当前StreamOpFlag(StreamOpFlag.set)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>preserve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 这里就用到按位与判断输入的flags中是否清除当前StreamOpFlag(StreamOpFlag.clear)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCleared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>preserve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 这里就用到按位与判断输入的flags中是否保留当前StreamOpFlag(StreamOpFlag.clear)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isPreserved</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>preserve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>preserve</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 判断当前的Stream实体类型是否可以设置本标志，要求Stream实体类型的标志位为set或者preserve，按位与要大于0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>canSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>maskTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SET_BITS</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时忽略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里有个特殊操作，位运算的时候采用了<code>(flags & preserve)</code>，理由是：同一个标志中的同一个<code>Stream</code>实体类型只可能存在<code>set/inject</code>、<code>clear</code>和<code>preserve</code>的其中一种，也就是同一个<code>flags</code>中不可能同时存在<code>StreamOpFlag.SORTED.set</code>和<code>StreamOpFlag.SORTED.clear</code>，从语义上已经矛盾，而<code>set/inject</code>、<code>clear</code>和<code>preserve</code>在<code>bit map</code>中的大小（为<code>2</code>位）和位置已经是固定的，<code>preserve</code>在设计的时候为<code>0b11</code>刚好<code>2</code>位取反，因此可以特化为（这个特化也让判断更加严谨）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#ce5c00;font-weight:700>(</span>flags <span style=color:#000;font-weight:700>&amp;</span> <span style=color:#204a87>set</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>set</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>(</span>flags <span style=color:#000;font-weight:700>&amp;</span> preserve<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>set</span>
<span style=color:#ce5c00;font-weight:700>(</span>flags <span style=color:#000;font-weight:700>&amp;</span> clear<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>clear</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>(</span>flags <span style=color:#000;font-weight:700>&amp;</span> preserve<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> clear
<span style=color:#ce5c00;font-weight:700>(</span>flags <span style=color:#000;font-weight:700>&amp;</span> preserve<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>preserve</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>(</span>flags <span style=color:#000;font-weight:700>&amp;</span> preserve<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> preserve
</code></pre></div><p>分析这么多，总的来说，就是想通过一个<code>32</code>位整数，每<code>2</code>位分别表示<code>3</code>种状态，那么一个完整的<code>Flags</code>（标志集合）一共可以表示<code>16</code>种标志（<code>position=[0,15]</code>，可以查看<code>API</code>注释，<code>[4,11]</code>和<code>[13,15]</code>的位置是未需实现或者预留的，属于<code>gap</code>）。接着分析掩码<code>Mask</code>的计算过程例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>// 横向看<span style=color:#ce5c00;font-weight:700>(</span>位移动运算符优先级高于与或，例如&lt;&lt;的优先级比<span style=color:#000;font-weight:700>|</span>高<span style=color:#ce5c00;font-weight:700>)</span>
SPLITERATOR_CHARACTERISTICS_MASK:
mask<span style=color:#ce5c00;font-weight:700>(</span>init<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
mask<span style=color:#ce5c00;font-weight:700>(</span>DISTINCT,SPLITERATOR<span style=color:#ce5c00;font-weight:700>[</span>DISTINCT<span style=color:#ce5c00;font-weight:700>]=</span>01,bitPosition<span style=color:#ce5c00;font-weight:700>=</span>0<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#4e9a06>&lt;&lt; 0 = 0</span><span style=color:#0000cf;font-weight:700>000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000>0001</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span>
mask<span style=color:#ce5c00;font-weight:700>(</span>SORTED,SPLITERATOR<span style=color:#ce5c00;font-weight:700>[</span>SORTED<span style=color:#ce5c00;font-weight:700>]=</span>01,bitPosition<span style=color:#ce5c00;font-weight:700>=</span>2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#4e9a06>&lt;&lt; 2 = 0000 0001 | 0000 0100 = 0000 0101
</span><span style=color:#4e9a06>mask(ORDERED,SPLITERATOR[ORDERED]=01,bitPosition=4) = 0000 0101 | 0000 0001 &lt;&lt; 4 = 0000 0101 | 0001 0000 = 0001 0101
</span><span style=color:#4e9a06>mask(SIZED,SPLITERATOR[SIZED]=01,bitPosition=6) = 0001 0101 | 0000 0001 &lt;&lt; 6 = 0001 0101 | 0100 0000 = 0101 0101
</span><span style=color:#4e9a06>mask(SHORT_CIRCUIT,SPLITERATOR[SHORT_CIRCUIT]=00,bitPosition=2</span>4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0101</span> <span style=color:#0000cf;font-weight:700>0101</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#4e9a06>&lt;&lt; 24 = 0101 0101 | 0000 0000 = 0101 0101
</span><span style=color:#4e9a06>mask(final) = 0000 0000 0000 0000 0000 0000 0101 0101(二进制)、85(十进制)
</span><span style=color:#4e9a06>
</span><span style=color:#4e9a06>STREAM_MASK:
</span><span style=color:#4e9a06>mask(init) = 0
</span><span style=color:#4e9a06>mask(DISTINCT,SPLITERATOR[DISTINCT]=01,bitPosition=0) = 0000 0000 | 0000 0001 &lt;&lt; 0 = 0000 0000 | 0000 0001 = 0000 0001
</span><span style=color:#4e9a06>mask(SORTED,SPLITERATOR[SORTED]=01,bitPosition=2) = 0000 0001 | 0000 0001 &lt;&lt; 2 = 0000 0001 | 0000 0100 = 0000 0101
</span><span style=color:#4e9a06>mask(ORDERED,SPLITERATOR[ORDERED]=01,bitPosition=4) = 0000 0101 | 0000 0001 &lt;&lt; 4 = 0000 0101 | 0001 0000 = 0001 0101
</span><span style=color:#4e9a06>mask(SIZED,SPLITERATOR[SIZED]=01,bitPosition=6) = 0001 0101 | 0000 0001 &lt;&lt; 6 = 0001 0101 | 0100 0000 = 0101 0101
</span><span style=color:#4e9a06>mask(SHORT_CIRCUIT,SPLITERATOR[SHORT_CIRCUIT]=00,bitPosition=24</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0101</span> <span style=color:#0000cf;font-weight:700>0101</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#4e9a06>&lt;&lt; 24 = 0101 0101 | 0000 0000 = 0101 0101
</span><span style=color:#4e9a06>mask(final) = 0000 0000 0000 0000 0000 0000 0101 0101(二进制)、85(十进制)
</span><span style=color:#4e9a06>
</span><span style=color:#4e9a06>OP_MASK:
</span><span style=color:#4e9a06>mask(init) = 0
</span><span style=color:#4e9a06>mask(DISTINCT,SPLITERATOR[DISTINCT]=11,bitPosition=0) = 0000 0000 | 0000 0011 &lt;&lt; 0 = 0000 0000 | 0000 0011 = 0000 0011
</span><span style=color:#4e9a06>mask(SORTED,SPLITERATOR[SORTED]=11,bitPosition=2) = 0000 0011 | 0000 0011 &lt;&lt; 2 = 0000 0011 | 0000 1100 = 0000 1111
</span><span style=color:#4e9a06>mask(ORDERED,SPLITERATOR[ORDERED]=11,bitPosition=4) = 0000 1111 | 0000 0011 &lt;&lt; 4 = 0000 1111 | 0011 0000 = 0011 1111
</span><span style=color:#4e9a06>mask(SIZED,SPLITERATOR[SIZED]=10,bitPosition=6) = 0011 1111 | 0000 0010 &lt;&lt; 6 = 0011 1111 | 1000 0000 = 1011 1111
</span><span style=color:#4e9a06>mask(SHORT_CIRCUIT,SPLITERATOR[SHORT_CIRCUIT]=01,bitPosition=24</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1011</span> <span style=color:#0000cf;font-weight:700>1111</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#4e9a06>&lt;&lt; 24 = 1011 1111 | 0100 0000 0000 0000 0000 0000 0000 = 0100 0000 0000 0000 0000 1011 1111
</span><span style=color:#4e9a06>mask(final) = 0000 0000 1000 0000 0000 0000 1011 1111(二进制)、16777407(十进制)
</span><span style=color:#4e9a06>
</span><span style=color:#4e9a06>TERMINAL_OP_MASK:
</span><span style=color:#4e9a06>mask(init) = 0
</span><span style=color:#4e9a06>mask(DISTINCT,SPLITERATOR[DISTINCT]=00,bitPosition=0) = 0000 0000 | 0000 0000 &lt;&lt; 0 = 0000 0000 | 0000 0000 = 0000 0000
</span><span style=color:#4e9a06>mask(SORTED,SPLITERATOR[SORTED]=00,bitPosition=2) = 0000 0000 | 0000 0000 &lt;&lt; 2 = 0000 0000 | 0000 0000 = 0000 0000
</span><span style=color:#4e9a06>mask(ORDERED,SPLITERATOR[ORDERED]=10,bitPosition=4) = 0000 0000 | 0000 0010 &lt;&lt; 4 = 0000 0000 | 0010 0000 = 0010 0000
</span><span style=color:#4e9a06>mask(SIZED,SPLITERATOR[SIZED]=00,bitPosition=6) = 0010 0000 | 0000 0000 &lt;&lt; 6 = 0010 0000 | 0000 0000 = 0010 0000
</span><span style=color:#4e9a06>mask(SHORT_CIRCUIT,SPLITERATOR[SHORT_CIRCUIT]=01,bitPosition=24</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0010</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#4e9a06>&lt;&lt; 24 = 0010 0000 | 0001 0000 0000 0000 0000 0000 0000 = 0001 0000 0000 0000 0000 0010 0000
</span><span style=color:#4e9a06>mask(final) = 0000 0001 0000 0000 0000 0000 0010 0000(二进制)、1677724</span>8<span style=color:#ce5c00;font-weight:700>(</span>十进制<span style=color:#ce5c00;font-weight:700>)</span>

UPSTREAM_TERMINAL_OP_MASK:
mask<span style=color:#ce5c00;font-weight:700>(</span>init<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
mask<span style=color:#ce5c00;font-weight:700>(</span>DISTINCT,SPLITERATOR<span style=color:#ce5c00;font-weight:700>[</span>DISTINCT<span style=color:#ce5c00;font-weight:700>]=</span>00,bitPosition<span style=color:#ce5c00;font-weight:700>=</span>0<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#4e9a06>&lt;&lt; 0 = 0</span><span style=color:#0000cf;font-weight:700>000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000>0000</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span>
mask<span style=color:#ce5c00;font-weight:700>(</span>SORTED,SPLITERATOR<span style=color:#ce5c00;font-weight:700>[</span>SORTED<span style=color:#ce5c00;font-weight:700>]=</span>00,bitPosition<span style=color:#ce5c00;font-weight:700>=</span>2<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#4e9a06>&lt;&lt; 2 = 0000 0000 | 0000 0000 = 0000 0000
</span><span style=color:#4e9a06>mask(ORDERED,SPLITERATOR[ORDERED]=10,bitPosition=4) = 0000 0000 | 0000 0010 &lt;&lt; 4 = 0000 0000 | 0010 0000 = 0010 0000
</span><span style=color:#4e9a06>mask(SIZED,SPLITERATOR[SIZED]=00,bitPosition=6) = 0010 0000 | 0000 0000 &lt;&lt; 6 = 0010 0000 | 0000 0000 = 0010 0000
</span><span style=color:#4e9a06>mask(SHORT_CIRCUIT,SPLITERATOR[SHORT_CIRCUIT]=00,bitPosition=2</span>4<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0010</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#0000cf;font-weight:700>0000</span> <span style=color:#4e9a06>&lt;&lt; 24 = 0010 0000 | 0000 0000 = 0010 0000
</span><span style=color:#4e9a06>mask(final) = 0000 0000 0000 0000 0000 0000 0010 0000(二进制)、32</span><span style=color:#ce5c00;font-weight:700>(</span>十进制<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>相关的方法和属性如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StreamOpFlag</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// SPLITERATOR类型的标志bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SPLITERATOR_CHARACTERISTICS_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SPLITERATOR</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// STREAM类型的标志bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>STREAM_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STREAM</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// OP类型的标志bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// TERMINAL_OP类型的标志bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>TERMINAL_OP_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TERMINAL_OP</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// UPSTREAM_TERMINAL_OP类型的标志bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>UPSTREAM_TERMINAL_OP_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UPSTREAM_TERMINAL_OP</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 基于Stream类型，创建对应类型填充所有标志的bit map
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>createMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Type</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span> <span style=color:#000>flag</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>mask</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>flag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maskTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>flag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bitPosition</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 构造一个标志本身的掩码，就是所有标志都采用保留位表示，目前作为flags == 0时候的初始值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>FLAG_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>createFlagMask</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造一个包含全部标志中的preserve位的bit map，按照目前来看是暂时是一个固定值，二进制表示为0011 0000 0000 0000 0000 1111 1111
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>createFlagMask</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span> <span style=color:#000>flag</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>values</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>mask</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>flag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>preserve</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 构造一个Stream类型包含全部标志中的set位的bit map，这里直接使用了STREAM_MASK，按照目前来看是暂时是一个固定值，二进制表示为0000 0000 0000 0000 0000 0000 0101 0101
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>FLAG_MASK_IS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STREAM_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 构造一个Stream类型包含全部标志中的clear位的bit map，按照目前来看是暂时是一个固定值，二进制表示为0000 0000 0000 0000 0000 0000 1010 1010
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>FLAG_MASK_NOT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STREAM_MASK</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 初始化操作的标志bit map，目前来看就是Stream的头节点初始化时候需要合并在flags里面的初始化值，照目前来看是暂时是一个固定值，二进制表示为0000 0000 0000 0000 0000 0000 1111 1111
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INITIAL_OPS_VALUE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>FLAG_MASK_IS</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>FLAG_MASK_NOT</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>SPLITERATOR_CHARACTERISTICS_MASK</code>等<code>5</code>个成员（见上面的<code>Mask</code>计算例子）其实就是预先计算好对应的<code>Stream</code>实体类型的<strong>所有<code>StreamOpFlag</code>标志</strong>的<code>bit map</code>，也就是之前那个展示<code>Stream</code>的类型和标志的映射图的"横向"展示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224314.png style=display:block;width:80% alt=NAME align=center> </div>
<p>前面的分析已经相对详细，过程非常复杂，但是更复杂的<code>Mask</code>应用还在后面的方法。<code>Mask</code>的初始化就是提供给标志的合并（<code>combine</code>）和转化（从<code>Spliterator</code>中的<code>characteristics</code>转化为<code>flags</code>）操作的，见下面的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StreamOpFlag</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 这个方法完全没有注释，只使用在下面的combineOpFlags()方法中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 从源码来看
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 入参flags == 0的时候，那么直接返回0011 0000 0000 0000 0000 1111 1111
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 入参flags != 0的时候，那么会把当前flags的所有set/inject、clear和preserve所在位在bit map中全部置为0，然后其他位全部置为1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
               <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>FLAG_MASK</span>
               <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>~(</span><span style=color:#000>flags</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>FLAG_MASK_IS</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>FLAG_MASK_NOT</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 合并新的flags和前一个flags，这里还是用到老套路先和Mask按位与，再进行一次按位或
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 作为Stream的头节点的时候，prevCombOpFlags必须为INITIAL_OPS_VALUE
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>combineOpFlags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newStreamOrOpFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>prevCombOpFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 0x01 or 0x10 nibbles are transformed to 0x11
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 0x00 nibbles remain unchanged
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// Then all the bits are flipped
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// Then the result is logically or&#39;ed with the operation flags.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prevCombOpFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newStreamOrOpFlags</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>newStreamOrOpFlags</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 通过合并后的flags，转换出Stream类型的flags
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>toStreamFlags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>combOpFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// By flipping the nibbles 0x11 become 0x00 and 0x01 become 0x10
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// Shift left 1 to restore set flags and mask off anything other than the set flags
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>((~</span><span style=color:#000>combOpFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>FLAG_MASK_IS</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>combOpFlags</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// Stream的标志转换为Spliterator的characteristics
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>toCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>streamFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>streamFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SPLITERATOR_CHARACTERISTICS_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// Spliterator的characteristics转换为Stream的标志，入参是Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fromCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>characteristics</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>characteristics</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getComparator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Do not propagate the SORTED characteristic if it does not correspond
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// to a natural sort order
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>characteristics</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SPLITERATOR_CHARACTERISTICS_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>characteristics</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SPLITERATOR_CHARACTERISTICS_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// Spliterator的characteristics转换为Stream的标志，入参是Spliterator的characteristics
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fromCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>characteristics</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SPLITERATOR_CHARACTERISTICS_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的位运算很复杂，只展示简单的计算结果和相关功能：</p>
<ul>
<li><code>combineOpFlags()</code>：用于合并新的<code>flags</code>和上一个<code>flags</code>，因为<code>Stream</code>的数据结构是一个<code>Pipeline</code>，后继节点需要合并前驱节点的<code>flags</code>，例如前驱节点<code>flags</code>是<code>ORDERED.set</code>，当前新加入<code>Pipeline</code>的节点（后继节点）的新<code>flags</code>为<code>SIZED.set</code>，那么在后继节点中应该合并前驱节点的标志，简单想象为<code>SIZED.set | ORDERED.set</code>，如果是头节点，那么初始化头节点时候的<code>flags</code>要合并<code>INITIAL_OPS_VALUE</code>，这里举个例子：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ORDERED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>DISTINCT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SIZED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;left:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toBinaryString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;right:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toBinaryString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;right mask:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toBinaryString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>)));</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;combine:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toBinaryString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>combineOpFlags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>)));</span>

<span style=color:#8f5902;font-style:italic>// 输出结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#f57900>left:</span><span style=color:#000>1010001</span>
<span style=color:#f57900>right:</span><span style=color:#000>10001000</span>
<span style=color:#000>right</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>11111111111111111111111100110011</span>
<span style=color:#f57900>combine:</span><span style=color:#000>10011001</span>
</code></pre></div><ul>
<li><code>characteristics</code>的转化问题：<code>Spliterator</code>中的<code>characteristics</code>可以通过简单的按位与转换为<code>flags</code>的原因是<code>Spliterator</code>中的<code>characteristics</code>在设计时候本身就是和<code>StreamOpFlag</code>匹配的，准确来说就是<code>bit map</code>的位分布是匹配的，所以直接与<code>SPLITERATOR_CHARACTERISTICS_MASK</code>做按位与即可，见下面的例子：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>// 这里简单点只展示8 bit
SPLITERATOR_CHARACTERISTICS_MASK: <span style=color:#0000cf;font-weight:700>0101</span> <span style=color:#0000cf;font-weight:700>0101</span>
Spliterator.ORDERED:              <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#0000cf;font-weight:700>0000</span>
StreamOpFlag.ORDERED.set:         <span style=color:#0000cf;font-weight:700>0001</span> <span style=color:#0000cf;font-weight:700>0000</span>
</code></pre></div><p>至此，已经分析完<code>StreamOpFlag</code>的完整实现，<code>Mask</code>相关的方法限于篇幅就不打算详细展开，下面会开始分析<code>Stream</code>中的"流水线"结构实现，因为习惯问题，下文的"标志"和"特性"两个词语会混用。</p>
<h2 id=referencepipeline源码分析>ReferencePipeline源码分析</h2>
<p>既然<code>Stream</code>具备流的特性，那么就需要一个链式数据结构，让元素能够从<code>Source</code>一直往下"流动"和传递到每一个链节点，实现这种场景的常用数据结构就是双向链表（考虑需要回溯，单向链表不太合适），目前比较著名的实现有<code>AQS</code>和<code>Netty</code>中的<code>ChannelHandlerContext</code>。例如<code>Netty</code>中的流水线<code>ChannelPipeline</code>设计如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224358.png style=display:block;width:80% alt=NAME align=center> </div>
<p>对于这个双向链表的数据结构，<code>Stream</code>中对应的类就是<code>AbstractPipeline</code>，核心实现类在<code>ReferencePipeline</code>和<code>ReferencePipeline</code>的内部类。</p>
<h3 id=主要接口>主要接口</h3>
<p>先简单展示<code>AbstractPipeline</code>的核心父类方法定义，主要接父类是<code>Stream</code>、<code>BaseStream</code>和<code>PipelineHelper</code>：</p>
<ul>
<li><code>Stream</code>代表一个支持串行和并行聚合操作集合的元素序列，此顶层接口提供了流中间操作、终结操作和一些静态工厂方法的定义（由于方法太多，这里不全部列举），这个接口本质是一个建造器类型接口（对接中间操作来说），可以构成一个多中间操作，单终结操作的链，例如：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 忽略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 过滤Op
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Predicate</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 映射Op
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 终结操作 - 遍历
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 忽略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// init
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Stream</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buildStream</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#8f5902;font-style:italic>// chain: head -&gt; filter(Op) -&gt; map(Op) -&gt; forEach(Terminal Op)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>()</span>
</code></pre></div><ul>
<li><code>BaseStream</code>：<code>Stream</code>的基础接口，定义流的迭代器、流的等效变体（并发处理变体、同步处理变体和不支持顺序处理元素变体）、并发和同步判断以及关闭相关方法</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// T是元素类型，S是BaseStream&lt;T, S&gt;类型
</span><span style=color:#8f5902;font-style:italic>// 流的基础接口，这里的流指定的支持同步执行和异步执行的聚合操作的元素序列
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AutoCloseable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回一个当前Stream实例中所有元素的迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这是一个终结操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回一个当前Stream实例中所有元素的可拆分迭代器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 当前的Stream实例是否支持并发
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回一个等效的同步处理的Stream实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>S</span> <span style=color:#000>sequential</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回一个等效的并发处理的Stream实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>S</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回一个等效的不支持StreamOpFlag.ORDERED特性的Stream实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 或者说支持StreamOpFlag.NOT_ORDERED的特性，也就返回的变体Stream在处理元素的时候不需要顺序处理
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>S</span> <span style=color:#000>unordered</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回一个添加了close处理器的Stream实例，close处理器会在下面的close方法中回调
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>S</span> <span style=color:#000>onClose</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>closeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 关闭当前Stream实例，回调关联本Stream的所有close处理器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li><code>PipelineHelper</code>：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 获取流的流水线的数据源的&#34;形状&#34;，其实就是数据源元素的类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 主要有四种类型：REFERENCE（除了int、long和double之外的引用类型）、INT_VALUE、LONG_VALUE和DOUBLE_VALUE
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>StreamShape</span> <span style=color:#000>getSourceShape</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// 获取合并流和流操作的标志，合并的标志包括流的数据源标志、中间操作标志和终结操作标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 从实现上看是当前流管道节点合并前面所有节点和自身节点标志的所有标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getStreamAndOpFlags</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// 如果当前的流管道节点的合并标志集合支持SIZED，则调用Spliterator.getExactSizeIfKnown()返回数据源中的准确元素数量，否则返回-1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>exactOutputSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 相当于调用下面的方法组合：copyInto(wrapSink(sink), spliterator)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>S</span> <span style=color:#000>wrapAndCopyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 发送所有来自Spliterator中的元素到Sink中，如果支持SHORT_CIRCUIT标志，则会调用copyIntoWithCancel
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 发送所有来自Spliterator中的元素到Sink中，Sink处理完每个元素后会检查Sink#cancellationRequested()方法的状态去判断是否中断推送元素的操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>copyIntoWithCancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 创建接收元素类型为P_IN的Sink实例，实现PipelineHelper中描述的所有中间操作，用这个Sink去包装传入的Sink实例（传入的Sink实例的元素类型为PipelineHelper的输出类型P_OUT）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 包装传入的spliterator，从源码来看，在Stream链的头节点调用会直接返回传入的实例，如果在非头节点调用会委托到StreamSpliterators.WrappingSpliterator()方法进行包装
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这个方法在源码中没有API注释
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrapSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 构造一个兼容当前Stream元素&#34;形状&#34;的Node.Builder实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 从源码来看直接委托到Nodes.builder()方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>makeNodeBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// Stream流水线所有阶段(节点)应用于数据源Spliterator，输出的元素作为结果收集起来转化为Node实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 此方法应用于toArray()方法的计算，本质上是一个终结操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意一点（重复<code>3</code>次）：</p>
<ul>
<li>这里把同步流称为同步处理|执行的流，&ldquo;并行流"称为并发处理|执行的流，因为并行流有歧义，<strong>实际上只是并发执行，不是并行执行</strong></li>
<li>这里把同步流称为同步处理|执行的流，&ldquo;并行流"称为并发处理|执行的流，因为并行流有歧义，<strong>实际上只是并发执行，不是并行执行</strong></li>
<li>这里把同步流称为同步处理|执行的流，&ldquo;并行流"称为并发处理|执行的流，因为并行流有歧义，<strong>实际上只是并发执行，不是并行执行</strong></li>
</ul>
<h3 id=sink-和引用类型链>Sink 和引用类型链</h3>
<p><code>PipelineHelper</code>的几个方法中存在<code>Sink</code>这个接口，上一节没有分析，这一小节会详细展开。<code>Stream</code>在构建的时候虽然是一个双向链表的结构，但是在最终应用终结操作的时候，会把所有操作转化为引用类型链（<code>ChainedReference</code>），记得之前也提到过这种类似于多层包装器的编程模式，简化一下模型如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WrapperApp</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Wrapper</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doAction</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>AtomicInteger</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Wrapper</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wrapper [depth =&gt; %d] invoke\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>Wrapper</span> <span style=color:#000>second</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doAction</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wrapper [depth =&gt; %d] invoke\n&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
        <span style=color:#000>second</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doAction</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 控制台输出
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>wrapper</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>depth</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>invoke</span>
<span style=color:#000>wrapper</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>depth</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>invoke</span>
</code></pre></div><p>上面的例子有点突兀，两个不同<code>Sink</code>的实现可以做到无感知融合，举另一个例子如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>downstream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferenceChain</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * sink chain
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;&gt;</span> <span style=color:#000>sinkBuilders</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * current sink
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sinkReference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ReferenceChain</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Predicate</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//filter
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>sinkBuilders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prevSink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>sinkReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentSink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>prevSink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OUT</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>};</span>
            <span style=color:#000>sinkReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentSink</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>currentSink</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ReferenceChain</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>function</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// map
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>sinkBuilders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prevSink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>sinkReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>currentSink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>prevSink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#5c35cc;font-weight:700>@Override</span>
                <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OUT</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>function</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>};</span>
            <span style=color:#000>sinkReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentSink</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>currentSink</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEachPrint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>forEachPrint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEachPrint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 这个是类似于terminal op
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>sinkReference</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>stage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 反向包装 -&gt; 正向遍历
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>sinkBuilders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>supplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sinkBuilders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>stage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 正向包装 -&gt; 反向遍历
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sinkBuilders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>--)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>supplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sinkBuilders</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>stage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>finalStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stage</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>finalStage</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>12</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ReferenceChain</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>chain</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReferenceChain</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#8f5902;font-style:italic>// filter -&gt; map -&gt; for each
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachPrint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 输出结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>24</span>
</code></pre></div><p>执行的流程如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224506.png style=display:block;width:80% alt=NAME align=center> </div>
<p>多层包装器的编程模式的核心要领就是：</p>
<ul>
<li>绝大部分操作可以转换为<code>java.util.function.Consumer</code>的实现，也就是实现<code>accept(T t)</code>方法完成对传入的元素进行处理</li>
<li>先处理的<code>Sink</code>总是以后处理的<code>Sink</code>为入参，在自身处理方法中判断和回调传入的<code>Sink</code>的处理方法回调，也就是构建引用链的时候，需要从后往前构建，这种方式的实现逻辑可以参考<code>AbstractPipeline#wrapSink()</code>，例如：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 目标顺序：filter -&gt; map
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Sink</span> <span style=color:#000>mapSink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputSink</span><span style=color:#ce5c00;font-weight:700>){</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Function</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>inputSink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>Sink</span> <span style=color:#000>filterSink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapSink</span><span style=color:#ce5c00;font-weight:700>){</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Predicate</span> <span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>)){</span>
            <span style=color:#000>mapSink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ele</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>由上一点得知，一般来说，最后的终结操作会应用在引用链的第一个<code>Sink</code>上</li>
</ul>
<p>上面的代码并非笔者虚构出来，可见<code>java.util.stream.Sink</code>的源码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 继承自Consumer，主要是继承函数式接口方法void accept(T t)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 重置当前Sink的状态（为了接收一个新的数据集），传入的size是推送到downstream的准确数据量，无法评估数据量则传入-1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{}</span>

    <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{}</span>

    <span style=color:#8f5902;font-style:italic>// 返回true的时候表示当前的Sink不会接收数据
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancellationRequested</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 特化方法，接受一个int类型的值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;called wrong accept method&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 特化方法，接受一个long类型的值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;called wrong accept method&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 特化方法，接受一个double类型的值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;called wrong accept method&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 引用类型链，准确来说是Sink链
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>// 下一个Sink
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>downstream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>end</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancellationRequested</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancellationRequested</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 暂时忽略Int、Long、Double的特化类型场景
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果用过<code>RxJava</code>或者<code>Project-Reactor</code>，<code>Sink</code>更像是<code>Subscriber</code>，多个<code>Subscriber</code>组成了<code>ChainedReference</code>（<code>Sink Chain</code>，可以理解为一个复合的<code>Subscriber</code>），而<code>Terminal Op</code>则类似于<code>Publisher</code>，只有在<code>Subscriber</code>订阅<code>Publisher</code>的时候才会进行数据的处理，这里是应用了<code>Reactive</code>编程模式。</p>
<h3 id=abstractpipeline和referencepipeline的实现>AbstractPipeline和ReferencePipeline的实现</h3>
<p><code>AbstractPipeline</code>和<code>ReferencePipeline</code>都是抽象类，<code>AbstractPipeline</code>用于构建<code>Pipeline</code>的数据结构，提供一些<code>Shape</code>相关的抽象方法给<code>ReferencePipeline</code>实现，而<code>ReferencePipeline</code>就是<code>Stream</code>中<code>Pipeline</code>的基础类型，从源码上看，<code>Stream</code>链式（管道式）结构的头节点和操作节点都是<code>ReferencePipeline</code>的子类。先看<code>AbstractPipeline</code>的成员变量和构造函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 流管道链式结构的头节点（只有当前的AbstractPipeline引用是头节点，此变量才会被赋值，非头节点为NULL）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AbstractPipeline</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 流管道链式结构的upstream，也就是上一个节点，如果是头节点此引用为NULL
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AbstractPipeline</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 合并数据源的标志和操作标志的掩码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sourceOrOpFlags</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 流管道链式结构的下一个节点，如果是头节点此引用为NULL
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>AbstractPipeline</span> <span style=color:#000>nextStage</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 流的深度
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 串行执行的流中，表示当前流管道实例中中间操作节点的个数（除去头节点和终结操作）
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 并发执行的流中，表示当前流管道实例中中间操作节点和前一个有状态操作节点之间的节点个数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>depth</span><span style=color:#ce5c00;font-weight:700>;</span>
     
    <span style=color:#8f5902;font-style:italic>// 合并了所有数据源的标志、操作标志和当前的节点(AbstractPipeline)实例的标志，也就是当前的节点可以基于此属性得知所有支持的标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 数据源的Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 数据源的Spliterator实例封装的Supplier实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>sourceSupplier</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 标记当前的流节点是否被连接或者消费掉，不能重复连接或者重复消费
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 标记当前的流管道链式结构中是否存在有状态的操作节点，这个属性只会在头节点中有效
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>sourceAnyStateful</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 数据源关闭动作，这个属性只会在头节点中有效，由sourceStage持有
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Runnable</span> <span style=color:#000>sourceCloseAction</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 标记当前流是否并发执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 流管道结构头节点的父构造方法，使用数据源的Spliterator实例封装的Supplier实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 头节点的前驱节点置为NULL
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 合并传入的源标志和流标志的掩码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceOrOpFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STREAM_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// The following is an optimization of:
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// StreamOpFlag.combineOpFlags(sourceOrOpFlags, StreamOpFlag.INITIAL_OPS_VALUE);
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 初始化合并标志集合为sourceOrOpFlags和所有流操作标志的初始化值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(~(</span><span style=color:#000>sourceOrOpFlags</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INITIAL_OPS_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 深度设置为0
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parallel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 流管道结构头节点的父构造方法，使用数据源的Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span>
                     <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 头节点的前驱节点置为NULL
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 合并传入的源标志和流标志的掩码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceOrOpFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>STREAM_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// The following is an optimization of:
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// StreamOpFlag.combineOpFlags(sourceOrOpFlags, StreamOpFlag.INITIAL_OPS_VALUE);
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 初始化合并标志集合为sourceOrOpFlags和所有流操作标志的初始化值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(~(</span><span style=color:#000>sourceOrOpFlags</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>INITIAL_OPS_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parallel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 流管道结构中间操作节点的父构造方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;?,</span> <span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 设置前驱节点的后继节点引用为当前的AbstractPipeline实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 设置前驱节点引用为传入的前驱节点实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 合并传入的中间操作标志和流操作标志的掩码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceOrOpFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>opFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 合并标志集合为传入的标志和前驱节点的标志集合
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combineOpFlags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 赋值sourceStage为前驱节点的sourceStage
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceStage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceStage</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#8f5902;font-style:italic>// 标记当前的流存在有状态操作
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceAnyStateful</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 深度设置为前驱节点深度加1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>至此，可以看出流管道的数据结构：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224552.png style=display:block;width:80% alt=NAME align=center> </div>
<p><code>Terminal Op</code>不参与管道链式结构的构建。接着看<code>AbstractPipeline</code>中的终结求值方法（<code>Terminal evaluation methods</code>）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 基于终结操作进行求值，这个是Stream执行的常用核心方法，常用于collect()这类终结操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>R</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TerminalOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>getOutputShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inputShape</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 判断linkedOrConsumed，以防多次终结求值，也就是每个终结操作只能执行一次
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        
        <span style=color:#8f5902;font-style:italic>// 如果当前流支持并发执行，则委托到TerminalOp.evaluateParallel()，如果当前流只支持同步执行，则委托到TerminalOp.evaluateSequential()
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这里注意传入到TerminalOp中的方法参数分别是this(PipelineHelper类型)和数据源Spliterator
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>()</span>
               <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpFlags</span><span style=color:#ce5c00;font-weight:700>()))</span>
               <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateSequential</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpFlags</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 基于当前的流实例转换为最终的Node实例，传入的IntFunction用于创建数组实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 此终结方法一般用于toArray()这类终结操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evaluateToArrayNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// If the last intermediate operation is stateful then
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// evaluate directly to avoid an extra collection step
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 当前流支持并发执行，并且最后一个中间操作是有状态，则委托到opEvaluateParallel()，否则委托到evaluate()，这两个都是AbstractPipeline中的方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>previousStage</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Set the depth of this, last, pipeline stage to zero to slice the
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// pipeline such that this operation will not be included in the
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// upstream slice and upstream operations will not be included
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// in this slice
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>opEvaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 这个方法比较简单，就是获取当前流的数据源所在的Spliterator，并且确保流已经消费，一般用于forEach()这类终结操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sourceStageSpliterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_CONSUMED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 省略其他方法  
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>AbstractPipeline</code>中实现了<code>BaseStream</code>的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 设置头节点的parallel属性为false，返回自身实例，表示当前的流是同步执行的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>S</span> <span style=color:#000>sequential</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parallel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 设置头节点的parallel属性为true，返回自身实例，表示当前的流是并发执行的
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>S</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parallel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 流关闭操作，设置linkedOrConsumed为true，数据源的Spliterator相关引用置为NULL，置空并且回调sourceCloseAction钩子实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceCloseAction</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Runnable</span> <span style=color:#000>closeAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceCloseAction</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceCloseAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>closeAction</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回一个添加了close处理器的Stream实例，close处理器会在下面的close方法中回调
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 如果本来持有的引用sourceStage.sourceCloseAction非空，会使用传入的closeHandler与sourceStage.sourceCloseAction进行合并
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>S</span> <span style=color:#000>onClose</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>closeHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Runnable</span> <span style=color:#000>existingHandler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceCloseAction</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceCloseAction</span> <span style=color:#ce5c00;font-weight:700>=</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>existingHandler</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>closeHandler</span>
                <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Streams</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>composeWithExceptions</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>existingHandler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>closeHandler</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#8f5902;font-style:italic>// Primitive specialization use co-variant overrides, hence is not final
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 返回当前流实例中所有元素的Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 标记当前节点被链接或者消费
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果当前节点为头节点，那么返回sourceStage.sourceSpliterator或者延时加载的sourceStage.sourceSupplier(延时加载封装由lazySpliterator实现)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;)</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lazySpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_CONSUMED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 如果当前节点不是头节点，重新对sourceSpliterator进行包装，包装后的实例为WrappingSpliterator
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 当前流实例是否并发执行，从头节点的parallel属性进行判断
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parallel</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 从当前combinedFlags中获取数据源标志和所有流中间操作标志的集合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getStreamFlags</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toStreamFlags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Get the source spliterator for this pipeline stage.  For a sequential or
</span><span style=color:#8f5902;font-style:italic>     * stateless parallel pipeline, this is the source spliterator.  For a
</span><span style=color:#8f5902;font-style:italic>     * stateful parallel pipeline, this is a spliterator describing the results
</span><span style=color:#8f5902;font-style:italic>     * of all computations up to and including the most recent stateful
</span><span style=color:#8f5902;font-style:italic>     * operation.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>terminalFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 从sourceStage.sourceSpliterator或者sourceStage.sourceSupplier中获取当前流实例中的Spliterator实例，确保必定存在，否则抛出IllegalStateException
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSupplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_CONSUMED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 下面这段逻辑是对于并发执行并且存在有状态操作的节点，那么需要重新计算节点的深度和节点的合并标志集合
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这里只提一下计算过程，从头节点的后继节点开始遍历到当前节点，如果被遍历的节点时有状态的，那么对depth、combinedFlags和spliterator会进行重新计算
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// depth一旦出现有状态节点就会重置为0，然后从1重新开始增加
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// combinedFlags会重新合并sourceOrOpFlags、SHORT_CIRCUIT(如果sourceOrOpFlags支持)和Spliterator.SIZED
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// spliterator简单来看就是从并发执行的toArray()=&gt;Array数组=&gt;Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceAnyStateful</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Adapt the source spliterator, evaluating each stateful op
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// in the pipeline up to and including this pipeline stage.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// The depth and flags of each pipeline stage are adjusted accordingly.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>AbstractPipeline</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sourceStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextStage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
                 <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                 <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextStage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>thisOpFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceOrOpFlags</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SHORT_CIRCUIT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thisOpFlags</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// Clear the short circuit flag for next pipeline stage
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// This stage encapsulates short-circuiting, the next
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// stage may not have any short-circuit operations, and
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// if so spliterator.forEachRemaining should be used
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// for traversal
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>thisOpFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>thisOpFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IS_SHORT_CIRCUIT</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>opEvaluateParallelLazy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#8f5902;font-style:italic>// Inject or clear SIZED on the source pipeline stage
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// based on the stage&#39;s spliterator
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>thisOpFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasCharacteristics</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZED</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thisOpFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_SIZED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IS_SIZED</span>
                            <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thisOpFlags</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IS_SIZED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_SIZED</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>depth</span><span style=color:#ce5c00;font-weight:700>++;</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combineOpFlags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thisOpFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 如果传入的terminalFlags标志不为0，则当前节点的combinedFlags会合并terminalFlags
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalFlags</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Apply flags from the terminal operation to last pipeline stage
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>combinedFlags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combineOpFlags</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>AbstractPipeline</code>中实现了<code>PipelineHelper</code>的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 获取数据源元素的类型，这里的类型包括引用、int、double和float
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 其实实现上就是获取depth&lt;=0的第一个节点的输出类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span> 
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StreamShape</span> <span style=color:#000>getSourceShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>AbstractPipeline</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputShape</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 基于当前节点的标志集合判断和返回流中待处理的元素数量，无法获取则返回-1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>exactOutputSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStreamAndOpFlags</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 通过流管道链式结构构建元素引用链，再遍历元素引用链
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>S</span> <span style=color:#000>wrapAndCopyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 遍历元素引用链
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 当前节点不支持SHORT_CIRCUIT(短路)特性，则直接遍历元素引用链，不支持短路跳出
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SHORT_CIRCUIT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getStreamAndOpFlags</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>end</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 支持短路(中途取消)遍历元素引用链
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>copyIntoWithCancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 支持短路(中途取消)遍历元素引用链
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>copyIntoWithCancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
        <span style=color:#000>AbstractPipeline</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 基于当前节点，获取流管道链式结构中第最后一个depth=0的前驱节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getExactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>// 委托到forEachWithCancel()进行遍历
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancelled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachWithCancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>wrappedSink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>end</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cancelled</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回当前节点的标志集合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getStreamAndOpFlags</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 当前节点标志集合中是否支持ORDERED
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isOrdered</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ORDERED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
     
    <span style=color:#8f5902;font-style:italic>// 构建元素引用链，生成一个多重包装的Sink(WrapSink)，这里的逻辑可以看前面的分析章节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 这里遍历的时候，总是从当前节点向前驱节点遍历，也就是传入的sink实例总是包裹在最里面一层执行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>AbstractPipeline</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>opWrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 包装数据源的Spliterator，如果depth=0，则直接返回sourceSpliterator，否则返回的是延迟加载的WrappingSpliterator
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrapSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>depth</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 计算Node实例，这个方法用于toArray()方法系列，是一个终结操作，下面会另开章节详细分析
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// @@@ Optimize if op of this pipeline stage is a stateful op
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>evaluateToNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>makeNodeBuilder</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>exactOutputSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapAndCopyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nb</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法    
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>AbstractPipeline</code>中剩余的待如<code>XXYYZZPipeline</code>等子类实现的抽象方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>BaseStream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 获取当前流的输出&#34;形状&#34;，REFERENCE、INT_VALUE、LONG_VALUE或者DOUBLE_VALUE
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>StreamShape</span> <span style=color:#000>getOutputShape</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// 收集当前流的所有输出元素，转化为一个适配当前流输出&#34;形状&#34;的Node实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evaluateToNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                               <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                               <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flattenTree</span><span style=color:#ce5c00;font-weight:700>,</span>
                                               <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 包装Spliterator为WrappingSpliterator实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 包装Spliterator为DelegatingSpliterator实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span>
                                            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 基于Sink遍历Spliterator中的元素，支持取消操作，简单理解就是支持cancel的tryAdvance方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>forEachWithCancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 返回Node的建造器实例，用于toArray方法系列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>makeNodeBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 判断当前的操作(节点)是否有状态，如果是有状态的操作，必须覆盖opEvaluateParallel方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 当前操作生成的结果会作为传入的Sink实例的入参，这是一个包装Sink的过程，通俗理解就是之前提到的元素引用链添加一个新的链节点，这个方法算是流执行的一个核心方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opWrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>    
    
    <span style=color:#8f5902;font-style:italic>// 并发执行的操作节点求值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opEvaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                          <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                          <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Parallel evaluation is not supported&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 并发执行的操作节点惰性求值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opEvaluateParallelLazy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                     <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>opEvaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]).</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略其他方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里提到的抽象方法<code>opWrapSink()</code>其实就是元素引用链的添加链节点的方法，它的实现逻辑见子类，这里只考虑非特化子类<code>ReferencePipeline</code>的部分源码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 构造函数，用于头节点，传入基于Supplier封装的Spliterator实例作为数据源，数据源的标志集合和是否支持并发执行的判断标记
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 构造函数，用于头节点，传入Spliterator实例作为数据源，数据源的标志集合和是否支持并发执行的判断标记
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 构造函数，用于中间节点，传入上一个流管道节点的实例(前驱节点)和当前操作节点支持的标志集合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;?,</span> <span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 这里流的输出&#34;形状&#34;固定为REFERENCE
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StreamShape</span> <span style=color:#000>getOutputShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>StreamShape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFERENCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 转换当前流实例为Node实例，应用于toArray方法，后面详细分析终结操作的时候再展开
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evaluateToNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flattenTree</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flattenTree</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 包装Spliterator=&gt;WrappingSpliterator
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StreamSpliterators</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>WrappingSpliterator</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 包装Spliterator=&gt;DelegatingSpliterator，实现惰性加载
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lazySpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StreamSpliterators</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DelegatingSpliterator</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 遍历Spliterator中的元素，基于传入的Sink实例进行处理，支持Cancel操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>forEachWithCancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancelled</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>cancelled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancellationRequested</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cancelled</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造Node建造器实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>makeNodeBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#8f5902;font-style:italic>// 基于当前流的Spliterator生成迭代器实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>iterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Spliterators</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 省略其他OP的代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 流管道结构的头节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Head</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>// 构造函数，用于头节点，传入基于Supplier封装的Spliterator实例作为数据源，数据源的标志集合和是否支持并发执行的判断标记
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Head</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;&gt;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span>
             <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 构造函数，用于头节点，传入Spliterator实例作为数据源，数据源的标志集合和是否支持并发执行的判断标记
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Head</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span>
             <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parallel</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 不支持判断是否状态操作
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 不支持包装Sink实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opWrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 区分同步异步执行forEach，同步则简单理解为调用Spliterator.forEachRemaining，异步则调用终结操作forEach
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>sourceStageSpliterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 区分同步异步执行forEachOrdered，同步则简单理解为调用Spliterator.forEachRemaining，异步则调用终结操作forEachOrdered
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEachOrdered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>sourceStageSpliterator</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachOrdered</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 无状态操作节点的父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StatelessOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>// 基于上一个节点引用、输入元素&#34;形状&#34;和当前节点支持的标志集合创建StatelessOp实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>StatelessOp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;?,</span> <span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>StreamShape</span> <span style=color:#000>inputShape</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>inputShape</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 操作状态标记设置为无状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 有状态操作节点的父类
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StatefulOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// 基于上一个节点引用、输入元素&#34;形状&#34;和当前节点支持的标志集合创建StatefulOp实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>StatefulOp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;?,</span> <span style=color:#000>E_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#000>StreamShape</span> <span style=color:#000>inputShape</span><span style=color:#ce5c00;font-weight:700>,</span>
                   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>opFlags</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>inputShape</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 操作状态标记设置为有状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 前面也提到，节点操作异步求值的方法在无状态节点下必须覆盖，这里重新把这个方法抽象，子类必须实现
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opEvaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                       <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                       <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><p>这里重重重点分析一下<code>ReferencePipeline</code>中的<code>wrapSink</code>方法实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>wrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>AbstractPipeline</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depth</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>opWrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combinedFlags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>入参是一个<code>Sink</code>实例，返回值也是一个<code>Sink</code>实例，里面的<code>for</code>循环是基于当前的<code>AbstractPipeline</code>节点向前遍历，直到<code>depth</code>为<code>0</code>的节点跳出循环，而<code>depth</code>为<code>0</code>意味着该节点必定为头节点，也就是该循环是遍历当前节点到头节点的后继节点，<code>Sink</code>是"向前包装的&rdquo;，也就是处于链后面的节点<code>Sink</code>总是会作为其前驱节点的<code>opWrapSink()</code>方法的入参，在同步执行流求值计算的时候，前驱节点的<code>Sink</code>处理完元素后就会通过<code>downstream</code>引用（其实就是后驱节点的<code>Sink</code>）调用其<code>accept()</code>把元素或者处理完的元素结果传递进去，激活下一个<code>Sink</code>，以此类推。另外，<code>ReferencePipeline</code>的三个内部类<code>Head</code>、<code>StatelessOp</code>和<code>StatefulOp</code>就是流的节点类，其中只有<code>Head</code>是非抽象类，代表流管道结构（或者说双向链表结构）的头节点，<code>StatelessOp</code>（无状态操作）和<code>StatefulOp</code>（有状态操作）的子类构成了流管道结构的操作节点或者是终结操作。在忽略是否有状态操作的前提下看<code>ReferencePipeline</code>，它只是流数据结构的承载体，表面上看到的双向链表结构在流的求值计算过程中并不会进行直接遍历每个节点进行求值，而是先转化成一个多层包装的<code>Sink</code>，也就是前文笔者提到的元素引用链后者前一句分析的<code>Sink</code>元素处理以及传递，正确来说应该是一个<code>Sink</code>栈或者<code>Sink</code>包装器，它的实现可以类比为现实生活中的洋葱，或者编程模式中的<code>AOP</code>编程模式。形象一点的描述如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Head<span style=color:#ce5c00;font-weight:700>(</span>Spliterator<span style=color:#ce5c00;font-weight:700>)</span> -&gt; Op<span style=color:#ce5c00;font-weight:700>(</span>filter<span style=color:#ce5c00;font-weight:700>)</span> -&gt; Op<span style=color:#ce5c00;font-weight:700>(</span>map<span style=color:#ce5c00;font-weight:700>)</span> -&gt; Op<span style=color:#ce5c00;font-weight:700>(</span>sorted<span style=color:#ce5c00;font-weight:700>)</span> -&gt; Terminal Op<span style=color:#ce5c00;font-weight:700>(</span>forEach<span style=color:#ce5c00;font-weight:700>)</span>

↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
forEach ele in Spliterator: 
    Sink<span style=color:#ce5c00;font-weight:700>[</span>filter<span style=color:#ce5c00;font-weight:700>](</span>ele<span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>if</span> filter <span style=color:#000>process</span> <span style=color:#ce5c00;font-weight:700>==</span> true: 
            Sink<span style=color:#ce5c00;font-weight:700>[</span>map<span style=color:#ce5c00;font-weight:700>](</span>ele<span style=color:#ce5c00;font-weight:700>){</span>
                <span style=color:#000>ele</span> <span style=color:#ce5c00;font-weight:700>=</span> mapper<span style=color:#ce5c00;font-weight:700>(</span>ele<span style=color:#ce5c00;font-weight:700>)</span>
                Sink<span style=color:#ce5c00;font-weight:700>[</span>sorted<span style=color:#ce5c00;font-weight:700>](</span>ele<span style=color:#ce5c00;font-weight:700>){</span>

                    var array 

                    begin: 
          
                    accept<span style=color:#ce5c00;font-weight:700>(</span>ele<span style=color:#ce5c00;font-weight:700>)</span>:
                      add ele to array

                    end:
                      sort ele in array                      
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>终结操作<code>forEach</code>是目前分析源码中最简单的实现，下面会详细分析每种终结操作的实现细节。</p>
<h3 id=流中间操作的源码实现>流中间操作的源码实现</h3>
<p>限于篇幅，这里只能挑选一部分的中间<code>Op</code>进行分析。流的中间操作基本都是由<code>BaseStream</code>接口定义，在<code>ReferencePipeline</code>中进行实现，这里挑选比较常用的<code>filter</code>、<code>map</code>和<code>sorted</code>进行分析。先看<code>filter</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// filter操作，泛型参数Predicate类型接受一个任意类型(这里考虑到泛型擦除)的元素，输出布尔值，它是一个无状态操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Predicate</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 这里注意到，StatelessOp的第一个参数是指upstream，也就是理解为上一个节点，这里使用了this，意味着upstream为当前的ReferencePipeline实例，元素&#34;形状&#34;为引用类型，操作标志位不支持SIZED
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 在AbstractPipeline，previousStage指向了this，当前的节点就是StatelessOp[filter]实例，那么前驱节点this的后继节点引用nextStage就指向了StatelessOp[filter]实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 也就是StatelessOp[filter].previousStage = this; this.nextStage = StatelessOp[filter];  ===&gt; 也就是这个看起来简单的new StatelessOp()其实已经把自身加入到管道中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StatelessOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StreamShape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFERENCE</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_SIZED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opWrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 这里通知下一个节点的Sink.begin()，由于filter方法不感知元素数量，所以传值-1
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>begin</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>

                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>P_OUT</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 基于输入的Predicate实例判断当前处理元素是否符合判断，只有判断结果为true才会把元素原封不动直接传递到下一个Sink
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>test</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span>
                            <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>};</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接着是<code>map</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// map操作，基于传入的Function实例做映射转换(P_OUT-&gt;R)，它是一个无状态操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// upstream为当前的ReferencePipeline实例，元素&#34;形状&#34;为引用类型，操作标志位不支持SORTED和DISTINCT
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StatelessOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StreamShape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFERENCE</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_SORTED</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_DISTINCT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opWrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ChainedReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#5c35cc;font-weight:700>@Override</span>
                    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>P_OUT</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 基于传入的Function实例转换元素后把转换结果传递到下一个Sink
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>};</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后是<code>sorted</code>，<code>sorted</code>操作会相对复杂一点：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// sorted操作，基于传入的Comparator实例对处理的元素进行排序，从源码中看，它是一个有状态操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sorted</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>SortedOps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// SortedOps工具类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SortedOps</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 构建排序操作的链节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>makeRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;?,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OfRef</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 有状态的排序操作节点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OfRef</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>StatefulOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>// 是否自然排序，不定义Comparator实例的时候为true，否则为false
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isNaturalSort</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 用于排序的Comparator实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 自然排序情况下的构造方法，元素&#34;形状&#34;为引用类型，操作标志位不支持ORDERED和SORTED
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>OfRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;?,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StreamShape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFERENCE</span><span style=color:#ce5c00;font-weight:700>,</span>
                  <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IS_ORDERED</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IS_SORTED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNaturalSort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// Comparator实例赋值为Comparator.naturalOrder()，本质是基于Object中的equals或者子类覆盖Object中的equals方法进行元素排序
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>comp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>naturalOrder</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>comparator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>comp</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 非自然排序情况下的构造方法，需要传入Comparator实例，元素&#34;形状&#34;为引用类型，操作标志位不支持ORDERED和SORTED
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>OfRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;?,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>upstream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>StreamShape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFERENCE</span><span style=color:#ce5c00;font-weight:700>,</span>
                  <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IS_ORDERED</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_SORTED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNaturalSort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>comparator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opWrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// If the input is already naturally sorted and this operation
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// also naturally sorted then this is a no-op
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 流中的所有元素本身已经按照自然顺序排序，并且没有定义Comparator实例，则不需要进行排序，所以no op就行
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isNaturalSort</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flags</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#8f5902;font-style:italic>// 知道要处理的元素的确切数量，使用数组进行排序
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SizedRefSortingSink</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>// 不知道要处理的元素的确切数量，使用ArrayList进行排序
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RefSortingSink</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 这里是并行执行流中toArray方法的实现，暂不分析
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>opEvaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// If the input is already naturally sorted and this operation
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// naturally sorts then collect the output
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SORTED</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStreamAndOpFlags</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>isNaturalSort</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// @@@ Weak two-pass parallel implementation; parallel collect, parallel sort
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>flattenedData</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>asArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parallelSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flattenedData</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flattenedData</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 这里考虑到篇幅太长，SizedRefSortingSink和RefSortingSink的源码不复杂，只展开RefSortingSink进行分析
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 无法确认待处理元素确切数量时候用于元素排序的Sink实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RefSortingSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractRefSortingSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// 临时ArrayList实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
        
        <span style=color:#8f5902;font-style:italic>// 构造函数，需要的参数为下一个Sink引用和Comparator实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>RefSortingSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Comparator</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BAD_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 基于传入的size是否大于0，大于等于0用于作为initialCapacity构建ArrayList，小于0则构建默认initialCapacity的ArrayList，赋值到临时变量list
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;((</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 临时的ArrayList实例基于Comparator实例进行潘旭
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>comparator</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 下一个Sink节点的激活，区分是否支持取消操作
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cancellationRequestedCalled</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancellationRequested</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>downstream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>end</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 激活下一个Sink完成后，临时的ArrayList实例置为NULL，便于GC回收
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 当前Sink处理元素直接添加到临时的ArrayList实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>    

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>sorted</code>操作有个比较显著的特点，一般的<code>Sink</code>处理完自身的逻辑，会在<code>accept()</code>方法激活下一个<code>Sink</code>引用，但是它在<code>accept()</code>方法中只做元素的累积（<strong>元素富集</strong>），在<code>end()</code>方法进行最终的排序操作和模仿<code>Spliterator</code>的两个元素遍历方法向<code>downstream</code>推送待处理的元素。示意图如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224652.png style=display:block;width:80% alt=NAME align=center> </div>
<p>其他中间操作的实现逻辑是大致相同的。</p>
<h2 id=同步执行流终结操作的源码实现>同步执行流终结操作的源码实现</h2>
<p>限于篇幅，这里只能挑选一部分的<code>Terminal Op</code>进行分析，<strong>简单起见只分析同步执行的场景</strong>，这里挑选最典型和最复杂的<code>froEach()</code>和<code>collect()</code>，还有比较独特的<code>toArray()</code>方法。先看<code>froEach()</code>方法的实现过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 遍历元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForEachOps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 基于终结操作的求值方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>R</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TerminalOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>getOutputShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>inputShape</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 确保只会执行一次，linkedOrConsumed是流管道结构最后一个节点的属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 这里暂且只分析同步执行的流的终结操作，终结操作节点的标志会合并到流最后一个节点的combinedFlags中，执行的关键就是evaluateSequential方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>()</span>
               <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpFlags</span><span style=color:#ce5c00;font-weight:700>()))</span>
               <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>evaluateSequential</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOpFlags</span><span style=color:#ce5c00;font-weight:700>()));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码  
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// ForEachOps类，TerminalOp接口的定义比较简单，这里不展开
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ForEachOps</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 构造变量元素的终结操作实例，传入的元素是T类型，结果是Void类型(返回NULL，或者说是没有返回值，毕竟是一个元素遍历过程)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 参数为一个Consumer接口实例和一个标记是否顺序处理元素的布尔值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>TerminalOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>makeRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachOp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfRef</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>action</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 遍历元素操作的终结操作实现，同时它是一个适配器，适配TerminalSink(Sink)接口
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ForEachOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TerminalOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>TerminalSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// 标记是否顺序处理元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ForEachOp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ordered</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// TerminalOp
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#8f5902;font-style:italic>// 终结操作节点的标志集合，如果ordered为true则返回0，否则返回StreamOpFlag.NOT_ORDERED，表示不支持顺序处理元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getOpFlags</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ordered</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_ORDERED</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 同步遍历和处理元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Void</span> <span style=color:#000>evaluateSequential</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 以当前的ForEachOp实例作为最后一个Sink添加到Sink链(也就是前面经常说的元素引用链)，然后对Sink链进行遍历
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapAndCopyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 并发遍历和处理元素，这里暂不分析
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Void</span> <span style=color:#000>evaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                         <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachOrderedTask</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// TerminalSink
</span><span style=color:#8f5902;font-style:italic></span>         
        <span style=color:#8f5902;font-style:italic>// 实现TerminalSink的方法，实际上TerminalSink继承接口Supplier，这里是实现了Supplier接口的get()方法，由于PipelineHelper.wrapAndCopyInto()方法会返回最后一个Sink的引用，这里其实就是evaluateSequential()中的返回值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Void</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// ForEachOp的静态内部类，引用类型的ForEachOp的最终实现，依赖入参遍历元素处理的最后一步回调Consumer实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>OfRef</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ForEachOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#8f5902;font-style:italic>// 最后的遍历回调的Consumer句柄
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#000>OfRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 遍历元素回调操作
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>forEach</code>终结操作实现上，自身这个操作并不会构成流的链式结构的一部分，也就是它不是一个<code>AbstractPipeline</code>的子类实例，而是构建一个回调<code>Consumer</code>实例操作的一个<code>Sink</code>实例（准确来说是<code>TerminalSink</code>）实例，这里暂且叫<code>forEach terminal sink</code>，通过流最后一个操作节点的<code>wrapSink()</code>方法，把<code>forEach terminal sink</code>添加到<code>Sink</code>链的尾部，通过流最后一个操作节点的<code>copyInto()</code>方法进行元素遍历，按照<code>copyInto()</code>方法的套路，只要多层包装的<code>Sink</code>方法在回调其实现方法的时候总是激活<code>downstream</code>的前提下，执行的顺序就是流链式结构定义的操作节点顺序，而<code>forEach</code>最后添加的<code>Consumer</code>实例一定就是最后回调的。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224739.png style=display:block;width:80% alt=NAME align=center> </div>
<p>接着分析<code>collect()</code>方法的实现，先看<code>Collector</code>接口的定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// T：需要进行reduce操作的输入元素类型
</span><span style=color:#8f5902;font-style:italic>// A：reduce操作中可变累加对象的类型，可以简单理解为累加操作中，累加到Container&lt;A&gt;中的可变对象类型
</span><span style=color:#8f5902;font-style:italic>// R：reduce操作结果类型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 注释中称为Container，用于承载最终结果的可变容器，而此方法的Supplier实例持有的是创建Container实例的get()方法实现，后面称为Supplier
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 也就是一般使用如：Supplier&lt;Container&gt; supplier = () -&gt; new Container();
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// Accumulator，翻译为累加器，用于处理值并且把处理结果传递(累加)到Container中，后面称为Accumulator
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>BiConsumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// Combiner，翻译为合并器，真实泛型类型为BinaryOperator&lt;A,A,A&gt;，BiFunction的子类，接收两个部分的结果并且合并为一个结果，后面称为Combiner
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这个方法可以把一个参数的状态转移到另一个参数，然后返回更新状态后的参数，例如：(arg1, arg2) -&gt; {arg2.state = arg1.state; return arg2;}
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 可以把一个参数的状态转移到另一个参数，然后返回一个新的容器，例如：(arg1, arg2) -&gt; {arg2.state = arg1.state; return new Container(arg2);}
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>BinaryOperator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// Finisher，直接翻译感觉意义不合理，实际上就是做最后一步转换工作的处理器，后面称为Finisher
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>finisher</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// Collector支持的特性集合，见枚举Characteristics
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>// 这里忽略两个Collector的静态工厂方法，因为并不常用
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Characteristics</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>// 标记Collector支持并发执行，一般和并发容器相关
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>CONCURRENT</span><span style=color:#ce5c00;font-weight:700>,</span>
        
        <span style=color:#8f5902;font-style:italic>// 标记Collector处理元素时候无序
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>UNORDERED</span><span style=color:#ce5c00;font-weight:700>,</span>
       
        <span style=color:#8f5902;font-style:italic>// 标记Collector的输入和输出元素是同类型，也就是Finisher在实现上R -&gt; A可以等效于A -&gt; R，unchecked cast会成功(也就是类型强转可以成功)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 在这种场景下，对于Container来说其实类型强制转换也是等效的，也就是Supplier&lt;A&gt;和Supplier&lt;R&gt;得出的Container是同一种类型的Container
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>IDENTITY_FINISH</span>
    <span style=color:#ce5c00;font-weight:700>}</span>    
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Collector的实现Collectors.CollectorImpl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Collectors</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 这一大堆常量就是预设的多种特性组合，CH_NOID比较特殊，是空集合，也就是Collector三种特性都不支持
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>CH_CONCURRENT_ID</span>
            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONCURRENT</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                     <span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNORDERED</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                     <span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IDENTITY_FINISH</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>CH_CONCURRENT_NOID</span>
            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONCURRENT</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                     <span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNORDERED</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>CH_ID</span>
            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IDENTITY_FINISH</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>CH_UNORDERED_ID</span>
            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNORDERED</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                     <span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IDENTITY_FINISH</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>CH_NOID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>emptySet</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>CH_UNORDERED_NOID</span>
            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNORDERED</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Collectors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略大量代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 静态类，Collector的实现，实现其实就是Supplier、Accumulator、Combiner、Finisher和Characteristics集合的成员属性承载
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CollectorImpl</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BiConsumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BinaryOperator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>finisher</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>CollectorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>BiConsumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>BinaryOperator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>finisher</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>supplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combiner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>finisher</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>finisher</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>characteristics</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>CollectorImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>BiConsumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>BinaryOperator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>castingIdentity</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BiConsumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BinaryOperator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>finisher</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>finisher</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Characteristics</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>characteristics</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略大量代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// IDENTITY_FINISH特性下，Finisher的实现，也就是之前提到的A-&gt;R和R-&gt;A等效，可以强转
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Function</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>castingIdentity</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 省略大量代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>collect()</code>方法的求值执行入口在<code>ReferencePipeline</code>中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// ReferencePipeline
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 基于Collector实例进行求值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>R</span> <span style=color:#000>collect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>A</span> <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 并发求值场景暂不考虑
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>()</span>
                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>characteristics</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONCURRENT</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isOrdered</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>characteristics</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNORDERED</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>container</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>supplier</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>BiConsumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>accumulator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulator</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 这里就是同步执行场景下的求值过程，这里可以看出其实所有Collector的求值都是Reduce操作
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>container</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ReduceOps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>makeRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 如果Collector的Finisher输入类型和输出类型相同，所以Supplier&lt;A&gt;和Supplier&lt;R&gt;得出的Container是同一种类型的Container，可以直接类型转换，否则就要调用Collector中的Finisher进行最后一步处理
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>characteristics</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IDENTITY_FINISH</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>container</span>
                <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>finisher</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

     <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// ReduceOps
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReduceOps</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReduceOps</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 引用类型Reduce操作创建TerminalOp实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>TerminalOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
    <span style=color:#000>makeRef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Supplier
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>supplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>requireNonNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>supplier</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// Accumulator
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BiConsumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>accumulator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accumulator</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// Combiner
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>BinaryOperator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>combiner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>combiner</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// 这里注意一点，ReducingSink是方法makeRef中的内部类，作用域只在方法内，它是封装为TerminalOp最终转化为Sink链中最后一个Sink实例的类型
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReducingSink</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Box</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
                <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>AccumulatingSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReducingSink</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 这里把从Supplier创建的新Container实例存放在父类Box的状态属性中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 处理元素，Accumulator处理状态(容器实例)和元素，这里可以想象，如果state为一个ArrayList实例，这里的accept()实现可能为add(ele)操作
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>accumulator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>combine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ReducingSink</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// Combiner合并两个状态(容器实例)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>combiner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReduceOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>I</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReducingSink</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>StreamShape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFERENCE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ReducingSink</span> <span style=color:#000>makeSink</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReducingSink</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getOpFlags</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>characteristics</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Characteristics</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>UNORDERED</span><span style=color:#ce5c00;font-weight:700>)</span>
                       <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NOT_ORDERED</span>
                       <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>};</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 继承自接口TerminalSink，主要添加了combine()抽象方法，用于合并元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>AccumulatingSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>K</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AccumulatingSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
            <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>TerminalSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>combine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 状态盒，用于持有和获取状态，状态属性的修饰符为default，包内的类实例都能修改
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Box</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>U</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>Box</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{}</span> <span style=color:#8f5902;font-style:italic>// Avoid creation of special accessor
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>U</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// ReduceOp的最终实现，这个就是Reduce操作终结操作的实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReduceOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AccumulatingSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
            <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TerminalOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// 流输入元素&#34;形状&#34;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StreamShape</span> <span style=color:#000>inputShape</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>ReduceOp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StreamShape</span> <span style=color:#000>shape</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>inputShape</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>shape</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 抽象方法，让子类生成终结操作的Sink
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#000>S</span> <span style=color:#000>makeSink</span><span style=color:#ce5c00;font-weight:700>();</span>
        
        <span style=color:#8f5902;font-style:italic>// 获取流输入元素&#34;形状&#34;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StreamShape</span> <span style=color:#000>inputShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>inputShape</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 同步执行求值，还是相似的思路，使用wrapAndCopyInto()进行Sink链构建和元素遍历
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>R</span> <span style=color:#000>evaluateSequential</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                           <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 以当前的ReduceOp实例的makeSink()返回的Sink实例作为最后一个Sink添加到Sink链(也就是前面经常说的元素引用链)，然后对Sink链进行遍历
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 这里向上一步一步推演思考，最终get()方法执行完毕拿到的结果就是ReducingSink父类Box中的state变量，也就是容器实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapAndCopyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>makeSink</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> 
        
        <span style=color:#8f5902;font-style:italic>// 异步执行求值，暂时忽略
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>R</span> <span style=color:#000>evaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                         <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReduceTask</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接着就看<code>Collector</code>的静态工厂方法，看一些常用的<code>Collector</code>实例是如何构建的，例如看<code>Collectors.toList()</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Supplier =&gt; () -&gt; new ArrayList&lt;T&gt;();  // 初始化ArrayList
</span><span style=color:#8f5902;font-style:italic>// Accumulator =&gt; (list,number) -&gt; list.add(number);  // 往ArrayList中添加元素
</span><span style=color:#8f5902;font-style:italic>// Combiner =&gt;  (left, right) -&gt; { left.addAll(right); return left;}  // 合并ArrayList
</span><span style=color:#8f5902;font-style:italic>// Finisher =&gt; X -&gt; X;  // 输入什么就返回什么，这里实际返回的是ArrayList
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#000>Collector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>toList</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CollectorImpl</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;((</span><span style=color:#000>Supplier</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;)</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#204a87;font-weight:700>new</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>},</span>
                                <span style=color:#000>CH_ID</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>把过程画成流程图如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224804.png style=display:block;width:80% alt=NAME align=center> </div>
<p>甚至可以更通俗地用伪代码表示<code>Collector</code>这类<code>Terminal Op</code>的执行过程（还是以<code>Collectors.toList()</code>为例）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>Supplier</span> <span style=color:#000>supplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#000>Container</span> <span style=color:#000>container</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>Box</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>Box</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>supplier</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>(=&gt;</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Box</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#a40000>↓↓↓↓↓↓↓↓↓</span><span style=color:#000>甚至更加通俗的过程如下</span><span style=color:#a40000>↓↓↓↓↓↓↓↓↓↓↓↓↓↓</span>

<span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>container</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#f57900>loop:</span>
  <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>也就是虽然工程化的代码看起来很复杂，最终的实现就是简单的：初始化<code>ArrayList</code>实例由<code>state</code>属性持有，遍历处理元素的时候把元素添加到<code>state</code>中，最终返回<code>state</code>。最后看<code>toArray()</code>的方法实现（下面的方法代码没有按照实际的位置贴出，笔者把零散的代码块放在一起方便分析）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReferencePipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractPipeline</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Stream</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 流的所有元素转换为数组，这里的IntFunction有一种比较特殊的用法，就是用于创建数组实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 例如IntFunction&lt;String[]&gt; f = String::new; String[] arry = f.apply(2);  相当于String[] arry = new String[2];
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        
        <span style=color:#8f5902;font-style:italic>// 这里主动擦除了IntFunction的类型，只要保证求值的过程是正确，最终可以做类型强转
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rawtypes&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>IntFunction</span> <span style=color:#000>rawGenerator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 委托到evaluateToArrayNode()方法进行计算
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flatten</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>evaluateToArrayNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rawGenerator</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>rawGenerator</span><span style=color:#ce5c00;font-weight:700>)</span>
                              <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rawGenerator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>    
    
    <span style=color:#8f5902;font-style:italic>// 流的所有元素转换为Object数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>toArray</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]::</span><span style=color:#204a87;font-weight:700>new</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 流元素求值转换为ArrayNode
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evaluateToArrayNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 确保不会处理多次
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>linkedOrConsumed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MSG_STREAM_LINKED</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>linkedOrConsumed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 并发执行暂时跳过
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>previousStage</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>opIsStateful</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>depth</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>opEvaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>previousStage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sourceSpliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 最终的转换Node的方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evaluate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_IN</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 并发执行暂时跳过
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isParallel</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// @@@ Optimize if op of this pipeline stage is a stateful op
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>evaluateToNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 兜兜转换还是回到了wrapAndCopyInto()方法，遍历Sink链，所以基本可以得知Node.Builder是Sink的一个实现
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>makeNodeBuilder</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#000>exactOutputSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>wrapAndCopyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nb</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取Node的建造器实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>makeNodeBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>P_OUT</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Node接口定义
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取待处理的元素封装成的Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 遍历当前Node实例中所有待处理的元素，回调到Consumer实例中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>// 获取当前Node实例的所有子Node的个数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getChildCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 获取当前Node实例的子Node实例，入参i是子Node的索引
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getChild</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 分割当前Node实例的一个部分，生成一个新的sub Node，类似于ArrayList中的subList方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>truncate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>from</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>to</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>from</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>to</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>to</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>from</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>nodeBuilder</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>nodeBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>from</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>});</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>to</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>forEachRemaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeBuilder</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nodeBuilder</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>nodeBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>end</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nodeBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 创建一个包含当前Node实例所有元素的元素数组视图
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>asArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>);</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回Node实例基于Stream的元素&#34;形状&#34;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>StreamShape</span> <span style=color:#000>getShape</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>StreamShape</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>REFERENCE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 获取当前Node实例包含的元素个数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#8f5902;font-style:italic>// Node建造器，注意这个Node.Builder接口是继承自Sink，那么其子类实现都可以添加到Sink链中作为一个节点(终结节点)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// 创建Node实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// 基于Integer元素类型的特化类型Node.Builder
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OfInt</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfInt</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfInt</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 基于Long元素类型的特化类型Node.Builder
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OfLong</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfLong</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfLong</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 基于Double元素类型的特化类型Node.Builder
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>OfDouble</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfDouble</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfDouble</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

     <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#8f5902;font-style:italic>// 这里下面的方法来源于Nodes类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Nodes</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>   
    <span style=color:#8f5902;font-style:italic>// Node扁平化处理，如果传入的Node实例存在子Node实例，则使用fork-join对Node进行分割和并发计算，结果添加到IntFunction生成的数组中，如果不存在子Node，直接返回传入的Node实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 关于并发计算部分暂时不分析
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChildCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BAD_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ToArrayTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OfRef</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 创建Node的建造器实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 当知道待处理元素的准确数量并且小于允许创建的数组的最大长度MAX_ARRAY_SIZE(Integer.MAX_VALUE - 8)，使用FixedNodeBuilder(固定长度数组Node建造器)，否则使用SpinedNodeBuilder实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exactSizeIfKnown</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>exactSizeIfKnown</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span>
               <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FixedNodeBuilder</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>exactSizeIfKnown</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span>
               <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> 

    <span style=color:#8f5902;font-style:italic>// 创建Node的建造器实例，使用SpinedNodeBuilder的实例，此SpinedNode支持元素添加，但是不支持元素移除
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SpinedNodeBuilder</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 固定长度固定长度数组Node实现(也就是最终的Node实现是一个ArrayNode，最终的容器为一个T类型元素的数组T[])
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FixedNodeBuilder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ArrayNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
            <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// 基于size(元素个数，或者说创建数组的长度)和数组创建方法IntFunction构建FixedNodeBuilder实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>FixedNodeBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>assert</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 返回当前FixedNodeBuilder实例，判断数组元素计数值curSize必须大于等于实际数组容器中元素的个数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>curSize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Current size %d is less than fixed size %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                              <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// Sink的begin方法回调，传入的size必须和数组长度相等，因为后面的accept()方法会执行size此
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>begin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Begin size %d is not equal to fixed size %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                            <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 重置数组元素计数值为0
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>curSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// Sink的accept方法回调，当数组元素计数值小于数组长度，直接向数组下标curSize++添加传入的元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>curSize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Accept exceeded fixed size of %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                              <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// Sink的end方法回调，再次判断数组元素计数值curSize必须大于等于实际数组容器中元素的个数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>curSize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;End size %d is less than fixed size %d&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                              <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 返回FixedNodeBuilder当前信息，当前处理的下标和当前数组中所有的元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;FixedNodeBuilder[%d][%s]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                 <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// Node实现，容器为一个固定长度的数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// 数组容器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 数组容器中当前元素的个数，这个值是一个固定值，或者在FixedNodeBuilder的accept()方法回调中递增
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        
        <span style=color:#8f5902;font-style:italic>// 基于size和数组创建的工厂IntFunction构建ArrayNode实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>ArrayNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BAD_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 创建szie长度的数组容器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>curSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 这个方法是基于一个现成的数组创建ArrayNode实例，直接改变数组的引用为array，元素个数curSize置为输入参数长度
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ArrayNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>curSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// Node - 接下来是Node接口的实现
</span><span style=color:#8f5902;font-style:italic></span>        
        <span style=color:#8f5902;font-style:italic>// 基于数组实例，起始索引0和结束索引curSize构造一个全新的Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliterator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 拷贝array中的元素到外部传入的dest数组中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>destOffset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>dest</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>destOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 返回元素数组视图，这里直接返回array引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>asArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>generator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 获取array中的元素个数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 遍历array，每个元素回调Consumer实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// 返回ArrayNode当前信息，当前处理的下标和当前数组中所有的元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ArrayNode[%d][%s]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
                                 <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>curSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>很多集合容器的<code>Spliterator</code>其实并不支持<code>SIZED</code>特性，其实<code>Node</code>的最终实现很多情况下都是<code>Nodes.SpinedNodeBuilder</code>，因为<code>SpinedNodeBuilder</code>重实现实现了数组扩容和<code>Spliterator</code>基于数组进行分割的方法，源码相对复杂（特别是<code>spliterator()</code>方法），这里挑部分进行分析，由于<code>SpinedNodeBuilder</code>绝大部分方法都是使用父类<code>SpinedBuffer</code>中的实现，这里可以直接分析<code>SpinedBuffer</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// SpinedBuffer的当前数组在超过了元素数量阈值之后，会拆分为多个数组块，存储到spine中，而curChunk引用指向的是当前处理的数组块
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SpinedBuffer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractSpinedBuffer</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>// 当前的数组块
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 所有数组块
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[][]</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造函数，指定初始化容量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>SpinedBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>curChunk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>initialChunkPower</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

     <span style=color:#8f5902;font-style:italic>// 构造函数，指定默认初始化容量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>SpinedBuffer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>curChunk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>initialChunkPower</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 拷贝当前SpinedBuffer中的数组元素到传入的数组实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 计算最终的offset，区分单个chunk和多个chunk的情况
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>finalOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>finalOffset</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>finalOffset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;does not fit&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 单个chunk的情况，由curChunk最接拷贝
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spineIndex</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>elementIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 多个chunk的情况，由遍历spine并且对每个chunk进行拷贝
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// full chunks
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>spineIndex</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>elementIndex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回数组元素视图，基于IntFunction构建数组实例，使用copyInto()方法进行元素拷贝
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>asArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IntFunction</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>arrayFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Nodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BAD_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arrayFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 清空SpinedBuffer，清空分块元素和所有引用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clear</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spine</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>curChunk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
                <span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>spine</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>priorElementCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>elementIndex</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
                <span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>elementIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>spineIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
      
    <span style=color:#8f5902;font-style:italic>// 遍历元素回调Consumer，分别遍历spine和curChunk
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// completed chunks, if any
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>spineIndex</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>++)</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>])</span>
                <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// current chunk
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>elementIndex</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
            <span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// Consumer的accept实现，最终会作为Sink接口的accept方法调用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>accept</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 如果当前分块(第一个)的元素已经满了，就初始化spine，然后元素添加到spine[0]中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elementIndex</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>inflateSpine</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 然后元素添加到spine[0]中的元素已经满了，就新增spine[n]，把元素放进spine[n]中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spineIndex</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>spineIndex</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>increaseCapacity</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>elementIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>spineIndex</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 当前的chunk更新为最新的chunk，就是spine中的最新一个chunk
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>curChunk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>spineIndex</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 当前的curChunk添加元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>curChunk</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>elementIndex</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>源码已经基本分析完毕，下面还是用一个例子转化为流程图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224830.png style=display:block;width:80% alt=NAME align=center> </div>
<h2 id=流并发执行的源码实现>流并发执行的源码实现</h2>
<p>如果流实例调用了<code>parallel()</code>，注释中提到会返回一个异步执行流的变体，实际上并没有构造变体，只是把<code>sourceStage.parallel</code>标记为<code>true</code>，异步求值的基本过程是：构建流管道结构的时候和同步求值的过程一致，构建完<code>Sink</code>链之后，<code>Spliterator</code>会使用特定算法基于<code>trySplit()</code>进行自分割，自分割算法由具体的子类决定，例如<code>ArrayList</code>采用的就是二分法，分割完成后每个<code>Spliterator</code>持有所有元素中的一小部分，然后把每个<code>Spliterator</code>作为<code>sourceSpliterator</code>在<code>fork-join</code>线程池中执行<code>Sink</code>链，得到多个部分的结果在当前调用线程中聚合，得到最终结果。这里用到的技巧就是：线程封闭和<code>fork-join</code>。因为不同<code>Terminal Op</code>的并发求值过程大同小异，这里只分析<code>forEach</code>并发执行的实现。首先展示一个使用<code>fork-join</code>线程池的简单例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MapReduceApp</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 数组中每个元素*2，再求和
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Integer</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Mapper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>T</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Reducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>T</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S</span> <span style=color:#000>second</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Mapper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Reducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sibling</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#000>T</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>Mapper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>Reducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reducer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>Mapper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>Reducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reducer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>compute</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>right</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>mid</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sibling</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sibling</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 创建子任务父任务的pending计数器加1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setPendingCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 提交右子任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fork</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 在当前线程计算左子任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compute</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mapper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>]);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 叶子节点完成，尝试合并其他兄弟节点的结果，会调用onCompletion方法
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>tryComplete</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getRawResult</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onCompletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>caller</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>child</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>caller</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>MapReducer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sib</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sibling</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 合并子任务结果，只有两个子任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>Objects</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reducer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>child</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sib</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里简单使用了<code>fork-join</code>编写了一个简易的<code>MapReduce</code>应用，<code>main</code>方法中运行的是数组<code>[1,2,3,4]</code>中的所有元素先映射为<code>i -> i * 2</code>，再进行<code>reduce</code>（求和）的过程，代码中也是简单使用二分法对原始的<code>array</code>进行分割，当最终的任务只包含一个元素，也就是<code>lo &lt; hi</code>且<code>hi - lo == 1</code>的时候，会基于单个元素调用<code>Mapper</code>的方法进行完成通知<code>tryComplete()</code>，任务完成会最终通知<code>onCompletion()</code>方法，<code>Reducer</code>就是在此方法中进行结果的聚合操作。对于流的并发求值来说，过程是类似的，<code>ForEachOp</code>中最终调用<code>ForEachOrderedTask</code>或者<code>ForEachTask</code>，这里挑选<code>ForEachTask</code>进行分析：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ForEachOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>TerminalOp</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>TerminalSink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Void</span> <span style=color:#000>evaluateParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                                        <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ordered</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachOrderedTask</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#8f5902;font-style:italic>// 最终是调用ForEachTask的invoke方法，invoke会阻塞到所有fork任务执行完，获取最终的结果
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wrapSink</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 暂时省略其他代码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// ForEachOps类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ForEachOps</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ForEachOps</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// forEach的fork-join任务实现，没有覆盖getRawResult()方法，最终只会返回NULL
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>// Spliterator实例，如果是父任务则代表所有待处理的元素，如果是子任务则是一个分割后的新Spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// Sink链实例
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 流管道引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 目标数量，其实是每个任务处理元素数量的建议值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>targetSize</span><span style=color:#ce5c00;font-weight:700>;</span>
        
        <span style=color:#8f5902;font-style:italic>// 这个构造器是提供给父(根)任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipelineHelper</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>helper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 这个构造器是提供给子任务，所以需要父任务的引用和一个分割后的新Spliterator实例作为参数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>targetSize</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>helper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>helper</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// Similar to AbstractTask but doesn&#39;t need to track child tasks
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 实现compute方法，用于分割Spliterator成多个子任务，这里不需要跟踪所有子任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>compute</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 神奇的赋值，相当于Spliterator&lt;S&gt; rightSplit = spliterator; Spliterator&lt;S&gt; leftSplit;
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// rightSplit总是指向当前的spliterator实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Spliterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rightSplit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spliterator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>leftSplit</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 这里也是神奇的赋值，相当于long sizeEstimate = rightSplit.estimateSize(); long sizeThreshold;
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>sizeEstimate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rightSplit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>estimateSize</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>sizeThreshold</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// sizeThreshold赋值为targetSize
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sizeThreshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>targetSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>// 基于Spliterator分割后的右分支实例的元素数量重新赋值sizeThreshold和targetSize
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 计算方式是待处理元素数量/(fork-join线程池并行度&lt;&lt;2)或者1(当前一个计算方式结果为0的时候)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>targetSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeThreshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AbstractTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>suggestTargetSize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizeEstimate</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 当前的流是否支持SHORT_CIRCUIT，也就是短路特性
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isShortCircuit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StreamOpFlag</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SHORT_CIRCUIT</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isKnown</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStreamAndOpFlags</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#8f5902;font-style:italic>// 当前的任务是否fork右分支
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>forkRight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// taskSink作为Sink的临时变量
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Sink</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>taskSink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 当前任务的临时变量
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// Spliterator分割和创建新的fork任务ForEachTask，前提是不支持短路或者Sink不支持取消
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isShortCircuit</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>taskSink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancellationRequested</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 当前的任务中的Spliterator(rightSplit)中的待处理元素小于等于每个任务应该处理的元素阈值或者再分割后得到NULL，则不需要再分割，直接基于rightSplit和Sink链执行循环处理元素
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sizeEstimate</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>sizeThreshold</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leftSplit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rightSplit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trySplit</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 这里就是遍历rightSplit元素回调Sink链的操作
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>helper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyInto</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>taskSink</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rightSplit</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// rightSplit还能分割，则基于分割后的leftSplit和以当前任务作为父任务创建一个新的fork任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>leftTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>leftSplit</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 待处理子任务加1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addToPendingCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 需要fork的任务实例临时变量
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ForEachTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>taskToFork</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 因为rightSplit总是分割Spliterator后对应原来的Spliterator引用，而leftSplit总是trySplit()后生成的新的Spliterator
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 所以这里leftSplit也需要作为rightSplit进行分割，通俗来说就是周星驰007那把梅花间足发射的枪
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>forkRight</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 这里交换leftSplit为rightSplit，所以forkRight设置为false，下一轮循环相当于fork left
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>forkRight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>rightSplit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leftSplit</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>taskToFork</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 赋值下一轮的父Task为当前的fork task
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leftTask</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>forkRight</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>taskToFork</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>leftTask</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 添加fork任务到任务队列中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>taskToFork</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fork</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 其实这里是更新剩余待分割的Spliterator中的所有元素数量到sizeEstimate
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sizeEstimate</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rightSplit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>estimateSize</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 置空spliterator实例并且传播任务完成状态，等待所有任务执行完成
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>spliterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>propagateCompletion</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上面的源码分析看起来可能比较难理解，这里举个简单的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stream</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>parallel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>forEach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这段代码中最终转换成<code>ForEachTask</code>中评估后得到的<code>targetSize = sizeThreshold == 1</code>，当前调用线程会参与计算，会执行<code>3</code>次<code>fork</code>，也就是一共有<code>4</code>个处理流程实例(也就是原始的<code>Spliterator</code>实例最终会分割出<code>3</code>个全新的<code>Spliterator</code>实例，加上自身一个<code>4</code>个<code>Spliterator</code>实例)，每个处理流程实例只处理<code>1</code>个元素，对应的流程图如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224905.png style=display:block;width:80% alt=NAME align=center> </div>
<p>最终的计算结果是调用<code>CountedCompleter.invoke()</code>方法获取的，此方法会阻塞直到所有子任务处理完成，当然<code>forEach</code>终结操作不需要返回值，所以没有实现<code>getRawResult()</code>方法，这里只是为了阻塞到所有任务执行完毕才解除调用线程的阻塞状态。</p>
<h2 id=状态操作与短路操作>状态操作与短路操作</h2>
<p><code>Stream</code>中按照<strong>中间操作</strong>是否有状态可以把这些操作分为<strong>无状态操作</strong>和<strong>有状态操作</strong>。<code>Stream</code>中按照<strong>终结操作</strong>是否支持短路特性可以把这些操作分为<strong>非短路操作</strong>和<strong>短路操作</strong>。理解如下：</p>
<ul>
<li>无状态操作：当前操作节点处理元素完成后，在满足前提条件下直接把结果传递到下一个操作节点，也就是操作内部不存在状态也不需要保存状态，例如<code>filter</code>、<code>map</code>等操作</li>
<li>有状态操作：处理元素的时候，依赖于节点的内部状态对元素进行累积，当处理一个新的元素的时候，其实可以感知到所有处理过的元素的历史状态，这个"状态"其实更像是缓冲区的概念，例如<code>sort</code>、<code>limit</code>等操作，以<code>sort</code>操作为例，一般是把所有待处理的元素全部添加到一个容器如<code>ArrayList</code>，再进行所有元素的排序，然后再重新模拟<code>Spliterator</code>把元素推送到后一个节点</li>
<li>非短路（终结）操作：终结操作在处理元素时候不能基于短路条件提前中断处理并且返回，也就是必须处理所有的元素，如<code>forEach</code></li>
<li>短路（终结）操作：终结操作在处理元素时候允许基于短路条件提前中断处理并且返回，但是最终实现中是有可能遍历完所有的元素中，只是在处理方法中基于前置的短路条件跳过了实际的处理过程，如<code>anyMatch</code>（实际上<code>anyMatch</code>会遍历完所有的元素，不过在命中了短路条件下，元素回调<code>Sink.accept()</code>方法时候会基于<code>stop</code>短路标记跳过具体的处理流程）</li>
</ul>
<p>这里不展开源码进行分析，仅仅展示一个经常见到的<code>Stream</code>操作汇总表如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20211012224943.png style=display:block;width:80% alt=NAME align=center> </div>
<p>这里还有两点要注意：</p>
<ul>
<li>从源码上看部分中间操作也是支持短路的，例如<code>slice</code>和<code>while</code>相关操作</li>
<li>从源码上看<code>find</code>相关终结操作中<code>findFirst</code>、<code>findAny</code>均支持和判断<code>StreamOpFlag.SHORT_CIRCUIT</code>，而<code>match</code>相关终结操作是通过内部的临时状态<code>stop</code>和<code>value</code>进行短路控制</li>
</ul>
<h2 id=总结>总结</h2>
<p>前前后后写了十多万字，其实也仅仅相对浅层次介绍了<code>Stream</code>的基本实现，笔者认为很多没分析到的中间操作实现和终结操作实现，特别是并发执行的终结操作实现是十分复杂的，多线程环境下需要进行一些想象和多处<code>DEBUG</code>定位执行位置和推演执行的过程。简单总结一下：</p>
<ul>
<li><code>JDK</code>中<code>Stream</code>的实现是精炼的高度工程化代码</li>
<li><code>Stream</code>的载体虽然是<code>AbstractPipeline</code>，管道结构，但是只用其形，实际求值操作之前会转化为一个多层包裹的<code>Sink</code>结构，也就是前文一直说的<code>Sink</code>链，从编程模式来看，应用的是<code>Reactor</code>编程模式</li>
<li><code>Stream</code>目前支持的固有求值执行结构一定是<code>Head(Source Spliterator) -> Op -> Op ... -> Terminal Op</code>的形式，这算是一个局限性，没有办法做到像<code>LINQ</code>那样可以灵活实现类似内存视图的功能</li>
<li><code>Stream</code>目前支持并发求值方案是针对<code>Source Spliterator</code>进行分割，封装<code>Terminal Op</code>和固定<code>Sink</code>链构造的<code>ForkJoinTask</code>进行并发计算，调用线程和<code>fork-join</code>线程池中的工作线程都可以参与求值过程，笔者认为这部分是<code>Stream</code>中除了那些标志集合位运算外最复杂的实现</li>
<li><code>Stream</code>实现的功能是一个突破，也有人说过此功能是一个"早产儿&rdquo;，在此希望<code>JDK</code>能够在矛盾螺旋中前进和发展</li>
</ul>
<h2 id=reference>Reference</h2>
<ul>
<li>原文链接：<a href=https://www.cnblogs.com/throwable/p/15371609.html>https://www.cnblogs.com/throwable/p/15371609.html</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-34b8c6c9295ab5995cbcb2a295585d4d>3 - Java 并发</h1>
</div>
<div class=td-content>
<h1 id=pg-7c0490b6cdb7ff67c6be189f867105c9>3.1 - CH01-并发体系</h1>
<h2 id=理论基础>理论基础</h2>
<ul>
<li>为什么需要多线程</li>
<li>什么是线程不安全</li>
<li>并发问题的根源
<ul>
<li>可见性</li>
<li>原子性</li>
<li>有序性</li>
</ul>
</li>
<li>Java 提供的方案
<ul>
<li>关键字
<ul>
<li>volatile</li>
<li>synchronized</li>
<li>final</li>
</ul>
</li>
<li>内存模型
<ul>
<li>Happens Before 规则</li>
<li>锁优化</li>
</ul>
</li>
</ul>
</li>
<li>线程安全的范围
<ul>
<li>不可变</li>
<li>绝对线程安全</li>
<li>相对线程安全</li>
<li>线程兼容</li>
<li>线程对立</li>
</ul>
</li>
<li>实现方法
<ul>
<li>互斥同步
<ul>
<li>synchronized</li>
<li>ReentrantLock</li>
</ul>
</li>
<li>非阻塞同步
<ul>
<li>CAS</li>
<li>Atomic Class</li>
</ul>
</li>
<li>无同步方案
<ul>
<li>栈封闭</li>
<li>ThreadLocal</li>
<li>可重入代码 Reentrant Code</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=线程基础>线程基础</h2>
<ul>
<li>线程状态转换
<ul>
<li>新建 New</li>
<li>可运行 Runnable</li>
<li>阻塞 Blocking</li>
<li>无限期等待 Waiting</li>
<li>限期等待 Timed Waiting</li>
<li>终止 Terminated</li>
</ul>
</li>
<li>线程使用方式
<ul>
<li>实现 Runnable 接口</li>
<li>继承 Thread 类</li>
<li>实现 Callable 接口</li>
</ul>
</li>
<li>线程基础机制
<ul>
<li>Executor</li>
<li>Daemon</li>
<li>sleep</li>
<li>yield</li>
</ul>
</li>
<li>线程中断
<ul>
<li>InterruptedException</li>
<li>interrupted()</li>
<li>Executor 的中断操作</li>
</ul>
</li>
<li>线程互斥同步
<ul>
<li>synchronized</li>
<li>ReentrantLock</li>
</ul>
</li>
<li>线程协作
<ul>
<li>join()</li>
<li>wait() notify() notifyAll()</li>
<li>await() signal() signalAll()</li>
</ul>
</li>
</ul>
<h2 id=并发工具>并发工具</h2>
<ul>
<li>Locks
<ul>
<li>Lock 接口</li>
<li>AQS</li>
<li>Condition</li>
<li>LockSupport</li>
<li>重入锁 ReentrantLock</li>
<li>读写锁 ReadWriteLock</li>
</ul>
</li>
<li>Collections
<ul>
<li>ConcurrentHashMap</li>
<li>ConcurrentLinkedQueue</li>
<li>BlockingQueue</li>
<li>CopyOnWriteArrayList</li>
</ul>
</li>
<li>Executors
<ul>
<li>Executor</li>
<li>ForkJoin</li>
<li>ThreadPoolExecutor</li>
<li>FutureTask</li>
</ul>
</li>
<li>Atomic
<ul>
<li>基本类型
<ul>
<li>AtomicBoolean</li>
<li>AtomicInteger</li>
<li>AtomicLong</li>
</ul>
</li>
<li>Array
<ul>
<li>AtomicBooleanArray</li>
<li>AtomicIntegerArray</li>
<li>AtomicLongArray</li>
</ul>
</li>
<li>Reference
<ul>
<li>AtomicReference</li>
<li>AtomicMarkedReference</li>
<li>AtomicStampedReference</li>
</ul>
</li>
<li>FieldUpdater
<ul>
<li>AtomicIntegerFiledUpdater</li>
<li>AtomicLongFiledUpdater</li>
<li>AtomicReferenceFiledUpdater</li>
</ul>
</li>
</ul>
</li>
<li>Tools
<ul>
<li>CountDownLatch</li>
<li>CyclicBarrier</li>
<li>Semaphore</li>
<li>Excahnger</li>
</ul>
</li>
</ul>
<h2 id=并发本质>并发本质</h2>
<ul>
<li>协作
<ul>
<li>管理
<ul>
<li>Lock & Condition</li>
<li>synchronized</li>
</ul>
</li>
<li>信号量 Semaphone</li>
<li>CountDownLatch</li>
<li>CyclicBarrier</li>
<li>Pharser</li>
<li>Exchanger</li>
</ul>
</li>
<li>分工
<ul>
<li>Executor 与 ThreadPool</li>
<li>ForkJoin</li>
<li>Future</li>
<li>模式
<ul>
<li>Guarded Suspension</li>
<li>ThreadPerMessage</li>
<li>Balking</li>
<li>Worker Thread</li>
<li>两阶段终止</li>
<li>生产消费</li>
</ul>
</li>
</ul>
</li>
<li>互斥
<ul>
<li>无锁
<ul>
<li>CAS</li>
<li>Atomic</li>
<li>模式
<ul>
<li>Imutablity</li>
<li>CopyOnWrite</li>
<li>ThreadLocal</li>
</ul>
</li>
</ul>
</li>
<li>互斥锁
<ul>
<li>synchronized</li>
<li>Lock</li>
<li>ReadWriteLock</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=并发模式>并发模式</h2>
<h2 id=框架案例>框架案例</h2>
<ul>
<li>Guava RateLimitor</li>
<li>Netty</li>
<li>Disrutor</li>
<li>HikariCP</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-47303cc651e0cdd38490eb35615745c3>3.2 - CH02-理论基础</h1>
<h2 id=多线程的优势>多线程的优势</h2>
<p>CPU、内存、IO 设备的速度存在巨大差异，为了合理利用 CPU 的高性能，平衡三者之间的速度差异，计算机体系结构、操作系统、编译程序实现了相关优化：</p>
<ul>
<li>CPU 增加了缓存，以平衡与内存的速度差异——导致了可见性问题</li>
<li>操作系统提供了进程、线程，以分时复用 CPU，进而均衡 CPU 与 IO 设备之间的速度差异——导致原子性问题</li>
<li>编译程序优化了指令执行顺序，使缓存能够得到更合理的利用——导致了有序性问题</li>
</ul>
<h2 id=线程不安全>线程不安全</h2>
<p>如果多个线程对同一份数据执行读写而不采取同步措施的话，可能导致混乱(非预期)的操作结果。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadUnsafeCounter</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>++;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Bootstrap</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>threadSize</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ThreadUnsafeCounter</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadUnsafeCounter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>CountDownLatch</span> <span style=color:#000>latch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>threadSize</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>ExecutorService</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCachedThreadPool</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>threadSize</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++){</span>
      <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>latch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>counter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// will always &lt; 1000
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=并发三要素>并发三要素</h2>
<h3 id=可见性cpu-缓存>可见性：CPU 缓存</h3>
<blockquote>
<p>可见性：一个线程对共享变量的修改，其他线程能够立即看到。</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// thread 1
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// thread 2
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>如果 CPU1 执行 Thread1、CPU2 执行 Thread2。当 Thread1 执行 <code>i=10</code> 时，会首先将 i 的初始值加载到 CPU1 的高速缓存中，然后赋值为 10，那么在 CPU1 的高速缓存中 i 的值变为了 10，却被没有被立即写回主存。</p>
<p>此时 Thread2 执行 <code>j=i</code>，首先去主存读取 i 的值加载到 CPU2 的高速缓存，(这时主存中 i 的值仍未 0)，这就导致 j 的值为 0，而非 10。</p>
<h3 id=原子性分时复用>原子性：分时复用</h3>
<blockquote>
<p>原子性：一个操作或多个操作那么全都执行，要么全不执行，不会被任何因素打断。</p>
</blockquote>
<h3 id=有序性指令重排序>有序性：指令重排序</h3>
<blockquote>
<p>有序性：程序执行的顺序完全按照代码的先后顺序执行。</p>
</blockquote>
<p>程序执行时为了提高性能，编译器和处理器通常会对执行进行重排序，分为三种类型：</p>
<ol>
<li>
<p>编译器优化：编译器再不改变单线程程序语义的前提下，重新安排语句的执行顺序。</p>
</li>
<li>
<p>指令级并行：现代处理器采用了指令级并行技术来将多条指令重叠执行。如果不存在数据依赖，处理器可以改变语句对应机器指令的执行顺序。</p>
</li>
<li>
<p>内存系统重排序：由于处理器通过高速缓存读写缓冲区，是的加载和存储操作看上去实在乱序执行。</p>
</li>
</ol>
<p>从 Java 代码到最终要执行的指令序列，会经历以上三种重排序。</p>
<ul>
<li>第一种属于编译器重排序，2、3 属于处理器重排序。</li>
<li>这些重排序可能会导致多线程程序出现内存可见性问题。对于编译器，JMM 中的编译器重排序规则会禁止特定类型的重排序操作。</li>
<li>对于处理器重排序，JMM 的处理器重排序规则会要求 Java 编译器在生成指令序列时，插入特定类型的内存屏障指令，通过这些内存屏障指令来禁止特定类型的处理器重排序操作。</li>
</ul>
<h2 id=java-如何解决并发问题jmm>Java 如何解决并发问题：JMM</h2>
<h3 id=核心知识点>核心知识点</h3>
<p>Java 内存模型规范了 JVM 如何提供按需禁用编译和缓存优化的方法。</p>
<ul>
<li>volatile、synchronized、final 关键字</li>
<li>Happens Before 规则</li>
</ul>
<h3 id=可见性有序性原子性>可见性、有序性、原子性</h3>
<ul>
<li>原子性：Java 中通过 synchronized 和 Lock 实现原子性保证。</li>
<li>可见性：Java 中通过 volatie 提供可见性保证。
<ul>
<li>synchronized 和 Lock 保证同一时刻只有一个线程获取锁然后执行代码，释放锁前或将数据刷新到主存。</li>
</ul>
</li>
<li>有序性：Java 中通过 volatile 保证一定的有序性。
<ul>
<li>synchronized 和 Lock 保证同一时刻只有一个线程执行，相当于多个线程顺序执行代码，即有序执行。</li>
</ul>
</li>
</ul>
<h3 id=volatilesynchronizedfinal>volatile、synchronized、final</h3>
<ul>
<li><a href>synchronized</a></li>
<li><a href>volatile</a></li>
<li><a href>final</a></li>
</ul>
<h3 id=happens-before>Happens Before</h3>
<p>除了 volatile、synchronized、Lock 能够保证有序性，JVM 还规定了先行发生规则，使一个操作无需显式控制即可保证先于另一个操作发生。</p>
<ol>
<li>
<p>单一线程：Single Thread Rule</p>
<ul>
<li>
<p>在一个线程内，程序中前面的操作先于后面的操作。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210420233332.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
</ul>
</li>
<li>
<p>管程锁定：Monitor Lock Rule</p>
<ul>
<li>一个 unlock 操作先于后面对一个锁的 lock 操作。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210420233423.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
<li>
<p>Volatile 变量：Volatile Variable Rule</p>
<ul>
<li>
<p>对一个 volatile 变量的写操作先于对该变量的读操作。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210420233511.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
</ul>
</li>
<li>
<p>线程启动：Thread Start Rule</p>
<ul>
<li>
<p>Thread 对象的 start 方法先于该线程的每一个动作。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210420233610.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
</ul>
</li>
<li>
<p>线程加入：Thread Join Rule</p>
<ul>
<li>
<p>Thread 对象的结束先于 join 方法返回。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210420233700.png style=display:block;width:50% alt=NAME align=center> </div>
</li>
</ul>
</li>
<li>
<p>线程中断：Thread Interruption Rule</p>
<ul>
<li>对线程 interrupt 方法的调用先于检测到中断的代码执行。</li>
</ul>
</li>
<li>
<p>对象终结：Finalizer Rule</p>
<ul>
<li>对象构造函数执行完成先于 finalize 方法开始。</li>
</ul>
</li>
<li>
<p>传递性：Transitivity</p>
<ul>
<li>如果操作 A 先于 B，B 先于 C，那么 A 先于 C。</li>
</ul>
</li>
</ol>
<h2 id=线程安全安全程度>线程安全：安全程度</h2>
<p>一个类可以被多个线程安全调用时，该类就是线程安全的。</p>
<p>将共享数据按照安全程度的强弱来划分安全强度的等级：</p>
<ul>
<li>不可变</li>
<li>绝对线程安全</li>
<li>相对线程安全</li>
<li>线程兼容</li>
<li>线程对立</li>
</ul>
<h3 id=不可变>不可变</h3>
<p>不可变(Immutable)的对象一定是线程安全的，不需要再采取任何的线程安全保障措施。只要一个不可变的对象被正确地构建出来，永远也不会看到它在多个线程之中处于不一致的状态。</p>
<ul>
<li>
<p>final 关键字修饰的基本数据类型</p>
</li>
<li>
<p>String</p>
</li>
<li>
<p>枚举类型</p>
</li>
<li>
<p>Number 部分子类，如 Long 和 Double 等数值包装类型，BigInteger 和 BigDecimal 等大数据类型。但同为 Number 的原子类 AtomicInteger 和 AtomicLong 则是可变的。</p>
</li>
<li>
<p>Collections.unmodifiableXXX() 先对原始的集合进行拷贝，需要对集合进行修改的方法都直接抛出异常。</p>
</li>
</ul>
<h3 id=绝对线程安全>绝对线程安全</h3>
<p>不管运行时环境如何，调用者都不需要任何额外的同步措施。</p>
<h3 id=相对线程安全>相对线程安全</h3>
<p>相对线程安全需要保证对这个对象单独的操作是线程安全的，在调用的时候不需要做额外的保障措施。但是对于一些特定顺序的连续调用，就可能需要在调用端使用额外的同步手段来保证调用的正确性。</p>
<p>在 Java 语言中，大部分的线程安全类都属于这种类型，例如 Vector、HashTable、Collections 的 synchronizedCollection() 方法包装的集合等。</p>
<h3 id=线程兼容>线程兼容</h3>
<p>线程兼容是指对象本身并不是线程安全的，但是可以通过在调用端正确地使用同步手段来保证对象在并发环境中可以安全地使用，我们平常说一个类不是线程安全的，绝大多数时候指的是这一种情况。Java API 中大部分的类都是属于线程兼容的，如与前面的 Vector 和 HashTable 相对应的集合类 ArrayList 和 HashMap 等。</p>
<h3 id=线程对立>线程对立</h3>
<p>线程对立是指无论调用端是否采取了同步措施，都无法在多线程环境中并发使用的代码。由于 Java 语言天生就具备多线程特性，线程对立这种排斥多线程的代码是很少出现的，而且通常都是有害的，应当尽量避免。</p>
<h2 id=线程安全实现>线程安全：实现</h2>
<h3 id=互斥同步阻塞同步>互斥同步—阻塞同步</h3>
<ul>
<li>synchronized</li>
<li>ReentrantLock</li>
</ul>
<h3 id=非阻塞同步>非阻塞同步</h3>
<p>互斥同步最主要的问题就是线程阻塞和唤醒所带来的性能问题，因此这种同步也称为阻塞同步。</p>
<p>互斥同步属于一种悲观的并发策略，总是认为只要不去做正确的同步措施，那就肯定会出现问题。无论共享数据是否真的会出现竞争，它都要进行加锁(这里讨论的是概念模型，实际上虚拟机会优化掉很大一部分不必要的加锁)、用户态核心态转换、维护锁计数器和检查是否有被阻塞的线程需要唤醒等操作。</p>
<ul>
<li>CAS</li>
</ul>
<p>随着硬件指令集的发展，我们可以使用基于冲突检测的乐观并发策略: 先进行操作，如果没有其它线程争用共享数据，那操作就成功了，否则采取补偿措施(不断地重试，直到成功为止)。这种乐观的并发策略的许多实现都不需要将线程阻塞，因此这种同步操作称为非阻塞同步。</p>
<p>乐观锁需要操作和冲突检测这两个步骤具备原子性，这里就不能再使用互斥同步来保证了，只能靠硬件来完成。硬件支持的原子性操作最典型的是: 比较并交换(Compare-and-Swap，CAS)。CAS 指令需要有 3 个参数，分别是内存地址 V、旧的预期值 A 和新值 B。当执行操作时，只有当 V 的值等于 A，才将 V 的值更新为 B。</p>
<ul>
<li>AtomicInteger</li>
</ul>
<p>J.U.C 包里面的整数原子类 AtomicInteger，其中的 compareAndSet() 和 getAndIncrement() 等方法都使用了 Unsafe 类的 CAS 操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndAddInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>valueOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndAddInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var4</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getIntVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>var1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>var5</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>var4</span><span style=color:#ce5c00;font-weight:700>));</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>var5</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>var1 指示对象内存地址，var2 指示该字段相对对象内存地址的偏移，var4 指示操作需要加的数值，这里为 1。通过 getIntVolatile(var1, var2) 得到旧的预期值，通过调用 compareAndSwapInt() 来进行 CAS 比较，如果该字段内存地址中的值等于 var5，那么就更新内存地址为 var1+var2 的变量为 var5+var4。</p>
<p>可以看到 getAndAddInt() 在一个循环中进行，发生冲突的做法是不断的进行重试。</p>
<ul>
<li>ABA</li>
</ul>
<p>如果一个变量初次读取的时候是 A 值，它的值被改成了 B，后来又被改回为 A，那 CAS 操作就会误认为它从来没有被改变过。</p>
<p>J.U.C 包提供了一个带有标记的原子引用类 AtomicStampedReference 来解决这个问题，它可以通过控制变量值的版本来保证 CAS 的正确性。大部分情况下 ABA 问题不会影响程序并发的正确性，如果需要解决 ABA 问题，改用传统的互斥同步可能会比原子类更高效。</p>
<h3 id=无同步方案>无同步方案</h3>
<p>要保证线程安全，并不是一定就要进行同步。如果一个方法本来就不涉及共享数据，那它自然就无须任何同步措施去保证正确性。</p>
<ul>
<li>栈封闭</li>
</ul>
<p>多个线程访问同一个方法的局部变量时，不会出现线程安全问题，因为局部变量存储在虚拟机栈中，属于线程私有的。</p>
<ul>
<li>ThreadLocal</li>
</ul>
<p>如果一段代码中所需要的数据必须与其他代码共享，那就看看这些共享数据的代码是否能保证在同一个线程中执行。如果能保证，我们就可以把共享数据的可见范围限制在同一个线程之内，这样，无须同步也能保证线程之间不出现数据争用的问题。</p>
<p>符合这种特点的应用并不少见，大部分使用消费队列的架构模式(如“生产者-消费者”模式)都会将产品的消费过程尽量在一个线程中消费完。其中最重要的一个应用实例就是经典 Web 交互模型中的“一个请求对应一个服务器线程”(Thread-per-Request)的处理方式，这种处理方式的广泛应用使得很多 Web 服务端应用都可以使用线程本地存储来解决线程安全问题。</p>
<p>可以使用 java.lang.ThreadLocal 类来实现线程本地存储功能。每个 Thread 都有一个 ThreadLocal.ThreadLocalMap 对象，Thread 类中就定义了 ThreadLocal.ThreadLocalMap 成员。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/* ThreadLocal values pertaining to this thread. This map is maintained
</span><span style=color:#8f5902;font-style:italic> * by the ThreadLocal class. */</span>
<span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ThreadLocalMap</span> <span style=color:#000>threadLocals</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>ThreadLocal 从理论上讲并不是用来解决多线程并发问题的，因为根本不存在多线程竞争。</p>
<ul>
<li>可重入代码</li>
</ul>
<p>这种代码也叫做纯代码(Pure Code)，可以在代码执行的任何时刻中断它，转而去执行另外一段代码(包括递归调用它本身)，而在控制权返回后，原来的程序不会出现任何错误。</p>
<p>可重入代码有一些共同的特征，例如不依赖存储在堆上的数据和公用的系统资源、用到的状态量都由参数中传入、不调用非可重入的方法等。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e37fa685905d1de3dca2b32c7a1d0e1b>3.3 - CH03-线程基础-1</h1>
<h2 id=线程状态>线程状态</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421002313.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>New：新建，创建后尚未启动。</li>
<li>Runnable：可运行，可能正在运行，也可能在等待 CPU 时间片。
<ul>
<li>包含操作系统线程状态的 Running 和 Ready。</li>
</ul>
</li>
<li>Blocking：等待获取一个排它锁，如果其他线程释放了锁就会结束该状态。</li>
<li>Waiting：无限期等待，需要其他线程唤醒，否则不会分配 CPU 时间片。
<ul>
<li>未设置 Timeout 参数的 Object.wait 方法，需要 Object.notify 或 Object.notifyAll 唤醒</li>
<li>未设置 Timeout 参数的 Thread.join 方法，被调用的线程执行完毕</li>
<li>LockSupport.park 调用</li>
</ul>
</li>
<li>Timed Waiting：限时等待，在一定时间后自动唤醒。
<ul>
<li>调用 Thread.sleep 方法，线程睡眠</li>
<li>设置了 Timeout 参数调用 Object.wait 进入限期等待，挂起线程
<ul>
<li>睡眠和挂起用于表述行为，阻塞和等待用于描述状态</li>
<li>阻塞和等待的区别在于，阻塞是被动的，等待的是一个排它锁，锁的释放由其他线程决定。</li>
<li>等待是祖东的，等待的是一个时间点，是线程自身通过 Thread.sleep 或 Object.wait 主动触发的等待。</li>
</ul>
</li>
<li>设置了 Timeout 参数调用 Thread.join 方法</li>
<li>LockSupport.parkNanos</li>
<li>LockSupport.parkUntil</li>
</ul>
</li>
<li>Terminated：死亡，线程结束任务之后自然死亡，或异常导致任务终止而死亡</li>
</ul>
<h2 id=应用方式>应用方式</h2>
<ul>
<li>实现 Runnable 接口：无返回值</li>
<li>实现 Callable 接口：有返回值</li>
<li>继承 Thread 类</li>
</ul>
<p>实现 Runnable 后 Callable 接口的类只能被当做是一个可以在线程中执行的任务，并不是真正意义上的线程实例，因此最后还是需要通过 Thread 类来调用。即任务是通过线程来执行的。</p>
<h2 id=线程机制>线程机制</h2>
<h3 id=executor>Executor</h3>
<p>Executor 管理多个异步任务的执行，而无需开发者显式管理线程的生命周期。这里的异步是指多个任务的执行互不干扰，不需要执行同步操作。</p>
<ul>
<li>CachedThreadPool：每个任务创建一个线程</li>
<li>FixedThreadPool：所有任务共用固定数量的线程</li>
<li>SingleThreadExecutor：仅有一个线程的 FixedThreadPool</li>
</ul>
<h3 id=daemon>Daemon</h3>
<p>守护线程是程序运行时在后台提供服务的线程，不属于程序中必要的部分，非必须。</p>
<ul>
<li>当所有非守护线程结束时，程序即终止，同时会杀死所有守护线程。</li>
<li>main 属于非守护线程。</li>
<li>通过 setDaemon 方法将一个线程设置为守护线程。</li>
</ul>
<h3 id=sleep>sleep</h3>
<p>Thread.sleep(millisec) 方法会休眠当前正在执行的线程，millisec 单位为毫秒。</p>
<p>sleep() 可能会抛出 InterruptedException，因为异常不能跨线程传播回 main() 中，因此必须在本地进行处理。线程任务可能出现的其它异常也同样需要在本地进行处理。</p>
<h3 id=yield>yield</h3>
<p>对静态方法 Thread.yield() 的调用表示当前线程已经完成了生命周期中最重要的部分，可以切换给其它线程来执行。该方法只是对线程调度器的一个建议，而且也只是建议具有相同优先级的其它线程可以运行。</p>
<h2 id=线程中断>线程中断</h2>
<p>一个线程执行完毕之后会自动结束，如果在运行过程中发生异常也会提前结束。</p>
<h3 id=interruptedexception>InterruptedException</h3>
<p>通过调用一个线程的 interrupt() 来中断该线程，如果该线程处于阻塞、限期等待或者无限期等待状态，那么就会抛出 InterruptedException，从而提前结束该线程。但是不能中断 I/O 阻塞和 synchronized 锁阻塞。</p>
<p>对于以下代码，在 main() 中启动一个线程之后再中断它，由于线程中调用了 Thread.sleep() 方法，因此会抛出一个 InterruptedException，从而提前结束线程，不执行之后的语句。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InterruptExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread1</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#5c35cc;font-weight:700>@Override</span>
      <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2000</span><span style=color:#ce5c00;font-weight:700>);</span>
              <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Thread run&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span> <span style=color:#000>thread1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread1</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>thread1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>thread1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Main run&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// 在线程 sleep 期间中断，“Thread run” 将不会被打印
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>Main</span> <span style=color:#000>run</span>
    <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sleep</span> <span style=color:#000>interrupted</span>
    <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Native</span> <span style=color:#000>Method</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>at</span> <span style=color:#000>InterruptExample</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lambda$main$0</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptExample</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>at</span> <span style=color:#000>InterruptExample$$Lambda$1</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>713338599</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Unknown</span> <span style=color:#000>Source</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>java</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#000>745</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=interrupted>interrupted</h3>
<p>如果一个线程的 run() 方法执行一个无限循环，并且没有执行 sleep() 等会抛出 InterruptedException 的操作，那么调用线程的 interrupt() 方法就无法使线程提前结束。</p>
<p>但是调用 interrupt() 方法会设置线程的中断标记，此时调用 interrupted() 方法会返回 true。因此可以在循环体中使用 interrupted() 方法来判断线程是否处于中断状态，从而提前结束线程。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InterruptExample</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread2</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#5c35cc;font-weight:700>@Override</span>
      <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#8f5902;font-style:italic>// ..
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Thread end&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span> <span style=color:#000>thread2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread2</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>thread2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>thread2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// Thread end
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=executor-中断操作>Executor 中断操作</h3>
<p>调用 Executor 的 shutdown() 方法会等待线程都执行完毕之后再关闭，但是如果调用的是 shutdownNow() 方法，则相当于调用每个线程的 interrupt() 方法。</p>
<p>以下使用 Lambda 创建线程，相当于创建了一个匿名内部线程。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCachedThreadPool</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Thread run&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdownNow</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Main run&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#8f5902;font-style:italic>// 在线程 sleep 期间被中断，不会打印 &#34;Thread run&#34;
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Main</span> <span style=color:#000>run</span>
<span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sleep</span> <span style=color:#000>interrupted</span>
</code></pre></div><p>如果想要中断 Executor 中的一个线程，可以通过 submit 方法提交一个任务，然后返回一个 Future 对象，调用该 Future 对象的 cancel 方法即可中断对应线程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>future</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// ..
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>});</span>
<span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h2 id=线程同步互斥>线程同步：互斥</h2>
<p>Java 提供了两种锁机制来控制多个线程对共享资源的互斥访问，第一个是 JVM 实现的 synchronized，而另一个是 JDK 实现的 ReentrantLock。</p>
<h3 id=synchronized>synchronized</h3>
<ul>
<li>同步代码块
<ul>
<li>只作用于同一个对象实例，比如 new Object()，如果调用两个对象上的同步代码块，就不会进行同步。</li>
</ul>
</li>
<li>同步方法
<ul>
<li>它和同步代码块一样，作用于同一个对象。只是作用在了该方法所属的实例。</li>
</ul>
</li>
<li>同步类
<ul>
<li>作用于整个类，也就是说两个线程调用同一个类的不同对象上的这种同步语句，也会进行同步。</li>
</ul>
</li>
<li>同步静态方法
<ul>
<li>作用于整个类。</li>
</ul>
</li>
</ul>
<h3 id=reentrantlock>ReentrantLock</h3>
<p>ReentrantLock 是 java.util.concurrent(J.U.C)包中的锁。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f57900>著作权归https:</span><span style=color:#8f5902;font-style:italic>//pdai.tech所有。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>链接</span><span style=color:#a40000>：</span><span style=color:#000>https</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#8f5902;font-style:italic>//www.pdai.tech/md/java/thread/java-thread-x-thread-basic.html
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>func</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 确保释放锁，从而避免发生死锁。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=基本对比>基本对比</h3>
<ul>
<li>实现层次：
<ul>
<li>synchronized 是 JVM 实现的，而 ReentrantLock 是 JDK 实现的。</li>
</ul>
</li>
<li>性能：
<ul>
<li>新版本 Java 对 synchronized 进行了很多优化，例如自旋锁等，synchronized 与 ReentrantLock 大致相同。</li>
</ul>
</li>
<li>等待可中断：
<ul>
<li>当持有锁的线程长期不释放锁的时候，正在等待的线程可以选择放弃等待，改为处理其他事情。</li>
<li>ReentrantLock 可中断，而 synchronized 不行。</li>
</ul>
</li>
<li>公平锁
<ul>
<li>公平锁是指多个线程在等待同一个锁时，必须按照申请锁的时间顺序来依次获得锁。</li>
<li>synchronized 中的锁是非公平的，ReentrantLock 默认情况下也是非公平的，但是也可以是公平的。</li>
</ul>
</li>
<li>锁绑定多个条件
<ul>
<li>一个 ReentrantLock 可以同时绑定多个 Condition 对象。</li>
</ul>
</li>
</ul>
<h3 id=应用选择>应用选择</h3>
<p>除非需要使用 ReentrantLock 的高级功能，否则优先使用 synchronized。这是因为 synchronized 是 JVM 实现的一种锁机制，JVM 原生地支持它，而 ReentrantLock 不是所有的 JDK 版本都支持。并且使用 synchronized 不用担心没有释放锁而导致死锁问题，因为 JVM 会确保锁的释放。</p>
<h2 id=线程协作>线程协作</h2>
<p>当多个线程可以一起工作去解决某个问题时，如果某些部分必须在其它部分之前完成，那么就需要对线程进行协调。</p>
<h3 id=join>join</h3>
<p>在线程中调用另一个线程的 join() 方法，会将当前线程挂起，而不是忙等待，直到目标线程结束。</p>
<h3 id=waitnotifynotifyall>wait、notify、notifyAll</h3>
<p>调用 wait() 使得线程等待某个条件满足，线程在等待时会被挂起，当其他线程的运行使得这个条件满足时，其它线程会调用 notify() 或者 notifyAll() 来唤醒挂起的线程。</p>
<p>它们都属于 Object 的一部分，而不属于 Thread。</p>
<p>只能用在同步方法或者同步控制块中使用，否则会在运行时抛出 IllegalMonitorStateExeception。</p>
<p>使用 wait() 挂起期间，线程会释放锁。这是因为，如果没有释放锁，那么其它线程就无法进入对象的同步方法或者同步控制块中，那么就无法执行 notify() 或者 notifyAll() 来唤醒挂起的线程，造成死锁。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitNotifyExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>after</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCachedThreadPool</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>WaitNotifyExample</span> <span style=color:#000>example</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WaitNotifyExample</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>after</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>before</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// before
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// after
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>wait() 和 sleep() 的区别</strong></p>
<ul>
<li>wait() 是 Object 的方法，而 sleep() 是 Thread 的静态方法；</li>
<li>wait() 会释放锁，sleep() 不会。</li>
</ul>
<h3 id=await-signal-signalall>await() signal() signalAll()</h3>
<p>JUC 类库中提供了 Condition 类来实现线程之间的协调，可以在 Condition 上调用 await() 方法使线程等待，其它线程调用 signal() 或 signalAll() 方法唤醒等待的线程。相比于 wait() 这种等待方式，await() 可以指定等待的条件，因此更加灵活。</p>
<p>使用 Lock 来获取一个 Condition 对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AwaitSignalExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Condition</span> <span style=color:#000>condition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCondition</span><span style=color:#ce5c00;font-weight:700>();</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
          <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>signalAll</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>after</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCachedThreadPool</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>AwaitSignalExample</span> <span style=color:#000>example</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AwaitSignalExample</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>after</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>before</span><span style=color:#ce5c00;font-weight:700>());</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// before
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// after
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b193d3d94478cbb7e17e200365b58990>3.4 - CH04-线程基础-2</h1>
<h2 id=create-thread>Create Thread</h2>
<ul>
<li>What happens when creating a Thread instance</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Thread</span> <span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(){</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// code
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>};</span> 
<span style=color:#8f5902;font-style:italic>// at this point the thread is in NEW state, all you have a simple java object, 
</span><span style=color:#8f5902;font-style:italic>// no actual thread is created
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#8f5902;font-style:italic>// when start() is invoked, at some unspecified point in the near future 
</span><span style=color:#8f5902;font-style:italic>// the thread will go into RUNNABLE state, this means an actual thread will be created.  
</span><span style=color:#8f5902;font-style:italic>// That can happen before start() returns.
</span></code></pre></div><ul>
<li>通过 <code>new </code> 创建线程时，你只是创建了一个 Thread 类的实例，该 Thread 实例的状态为 NEW。</li>
<li>通过 <code>thread.start()</code> 调用线程时，该 Thread 实例的状态将会在未来某个时刻变为 RUNNABLE，这表示 OS 级别的线程将被创建，这部分工作由 JVM 完成。</li>
</ul>
<h2 id=用户空间--内核空间>用户空间 & 内核空间</h2>
<p>在操作系统中，内存通常会被分成用户空间（User space）与内核空间（Kernel space）这两个部分。当进程/线程运行在用户空间时就处于用户态，运行在内核空间时就处于内核态：</p>
<ul>
<li>运行在内核态的程序可以访问用户空间和内核空间，或者说它可以访问计算机的任何资源，不受限制，为所欲为，例如协调 CPU 资源，分配内存资源，提供稳定的环境供应用程序运行等</li>
<li>而应用程序基本都是运行在用户态的，或者说用户态就是提供应用程序运行的空间。运行在用户态的程序只能访问用户空间</li>
</ul>
<h3 id=那为什么要区分用户态和内核态呢><strong>那为什么要区分用户态和内核态呢</strong>？</h3>
<p>早期操作系统是不区分用户态和内核态的，也就是说应用程序可以访问任意内存空间，如果程序不稳定常常会让系统崩溃，比如清除了操作系统的内存数据。为此大佬们设计出了一套规则：对于那些比较危险的操作需要切到内核态才能运行，比如 CPU、内存、设备等资源管理器程序就应该在内核态运行，否则安全性没有保证。</p>
<p><strong>用户态的程序不能随意操作内核地址空间，这样有效地防止了操作系统程序受到应用程序的侵害</strong>。</p>
<p>那如果处于用户态的程序想要访问内核空间的话怎么办呢？就需要进行系统调用从用户态切换到内核态。</p>
<h2 id=操作系统线程>操作系统线程</h2>
<h3 id=在用户空间实现线程>在用户空间实现线程</h3>
<p>在<strong>早期</strong>的操作系统中，所有的线程都是在用户空间下实现的，操作系统只能看到线程所属的进程，而不能看到线程。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429212415.png style=display:block;width:50% alt=NAME align=center> </div>
<p>从我们开发者的角度来理解用户级线程就是说：在这种模型下，我们需要自己定义线程的数据结构、创建、销毁、调度和维护等，这些线程运行在操作系统的某个进程内，然后操作系统直接对进程进行调度。</p>
<p>这种方式的好处一目了然，首先第一点，就是即使操作系统原生不支持线程，我们也可以通过库函数来支持线程；第二点，线程的调度只发生在用户态，避免了操作系统从内核态到用户态的转换开销。</p>
<p>当然缺点也很明显：由于操作系统看不见线程，不知道线程的存在，而 CPU 的时间片切换是以进程为维度的，所以如果进程中某个线程进行了耗时比较长的操作，那么由于用户空间中没有时钟中断机制，就会导致此进程中的其它线程因为得不到 CPU 资源而长时间的持续等待；另外，如果某个线程进行系统调用时比如缺页中断而导致了线程阻塞，此时操作系统也会阻塞住整个进程，即使这个进程中其它线程还在工作。</p>
<h3 id=在内核空间中实现线程>在内核空间中实现线程</h3>
<p>所谓内核级线程就是运行在内核空间的线程， 直接由内核负责，只能由内核来完成线程的调度。</p>
<p>每个内核线程可以视为内核的一个分身，这样操作系统就有能力同时处理多件事情，<strong>支持多线程的内核就叫做多线程内核</strong>（Multi-Threads Kernel）。</p>
<p>从我们开发者的角度来理解内核级线程就是说：我们可以直接使用操作系统中已经内置好的线程，线程的创建、销毁、调度和维护等，都是直接由操作系统的内核来实现，我们只需要使用系统调用就好了，不需要像用户级线程那样自己设计线程调度等。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429212532.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图画的是 1：1 的线程模型，所谓线程模型，也就是用户线程和内核线程之间的关联方式，线程模型当然不止 1：1 这一种，下面我们来详细解释以下这三种多线程模型：</p>
<h4 id=1-多对一线程模型><strong>1. 多对一线程模型</strong>：</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429212627.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>在多对一模型中，多个用户级线程映射到某一个内核线程上</li>
<li>线程管理由用户空间中的线程库处理，这非常有效</li>
<li>但是，如果进行了阻塞系统调用，那么即使其他用户线程能够继续，整个进程也会阻塞</li>
<li>由于单个内核线程只能在单个 CPU 上运行，因此多对一模型不允许在多个 CPU 之间拆分单个进程</li>
</ul>
<p>从并发性角度来总结下，虽然多对一模型允许开发人员创建任意多的用户线程，但是由于内核只能一次调度一个线程，所以并未增加并发性。现在已经几乎没有操作系统来使用这个模型了，因为它无法利用多个处理核。</p>
<h4 id=2-一对一线程模型><strong>2. 一对一线程模型</strong>：</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/88c73a25-6223-4b64-98cc-9284552ed1e1.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>一对一模型克服了多对一模型的问题</li>
<li>一对一模型创建一个单独的内核线程来处理每个用户线程</li>
<li>但是，管理一对一模型的开销更大，涉及更多开销和减慢系统速度</li>
<li>此模型的大多数实现都限制了可以创建的线程数</li>
</ul>
<p>从并发性角度来总结下，虽然一对一模型提供了更大的并发性，但是开发人员应注意不要在应用程序内创建太多线程（有时系统可能会限制创建线程的数量），因为管理一对一模型的开销更大。</p>
<h4 id=3-多对多线程模型><strong>3. 多对多线程模型</strong>：</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429212753.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>多对多模型将任意数量的用户线程复用到相同或更少数量的内核线程上，结合了一对一和多对一模型的最佳特性</li>
<li>用户对创建的线程数没有限制</li>
<li>阻止内核系统调用不会阻止整个进程</li>
<li>进程可以分布在多个处理器上</li>
<li>可以为各个进程分配可变数量的内核线程，具体取决于存在的 CPU 数量和其他因素</li>
</ul>
<h2 id=java-thread>Java Thread</h2>
<p>在上面的模型介绍中，我们提到了通过线程库来创建、管理线程，那么什么是线程库呢？</p>
<p><strong>线程库就是为开发人员提供创建和管理线程的一套 API</strong>。</p>
<p>当然，线程库不仅可以在用户空间中实现，还可以在内核空间中实现。前者涉及仅在用户空间内实现的 API 函数，没有内核支持。后者涉及系统调用，也就是说调用库中的一个 API 函数将会导致对内核的系统调用，并且需要具有线程库支持的内核。</p>
<p>下面简单介绍下三个主要的线程库：</p>
<ol>
<li>
<p>POSIX Pthreads：可以作为用户或内核库提供，作为 POSIX 标准的扩展</p>
</li>
<li>
<p>Win32 线程：用于 Window 操作系统的内核级线程库</p>
</li>
<li>
<p>Java 线程：<strong>Java 线程 API 通常采用宿主系统的线程库来实现</strong>，也就是说在 Win 系统上，Java 线程 API 通常采用 Win API 来实现，在 UNIX 类系统上，采用 Pthread 来实现。</p>
</li>
</ol>
<p>事实上，<strong>在 JDK 1.2 之前</strong>，Java 线程是基于称为 &ldquo;绿色线程&rdquo;（Green Threads）的用户级线程实现的，也就是说程序员大佬们为 JVM 开发了自己的一套线程库或者说线程管理机制。</p>
<p>而<strong>在 JDK 1.2 及以后</strong>，JVM 选择了更加稳定且方便使用的操作系统原生的内核级线程，通过系统调用，将线程的调度交给了操作系统内核。而对于不同的操作系统来说，它们本身的设计思路基本上是完全不一样的，因此它们各自对于线程的设计也存在种种差异，所以 JVM 中明确声明了：<strong>虚拟机中的线程状态，不反应任何操作系统中的线程状态</strong>。</p>
<p>也就是说，在 JDK 1.2 及之后的版本中，Java 的线程很大程度上依赖于操作系统采用什么样的线程模型，这点在不同的平台上没有办法达成一致，JVM 规范中也并未限定 Java 线程需要使用哪种线程模型来实现，可能是一对一，也可能是多对多或多对一。</p>
<p>总结来说，<strong>现今 Java 中线程的本质，其实就是操作系统中的线程，其线程库和线程模型很大程度上依赖于操作系统（宿主系统）的具体实现，比如在 Windows 中 Java 就是基于 Wind32 线程库来管理线程，且 Windows 采用的是一对一的线程模型</strong>。</p>
<h2 id=java线程调度>Java线程调度</h2>
<p>线程调度是指系统为线程分配处理使用权的过程，调度主要方式有两种，分别是<strong>协同式（Cooperative Threads-Scheduling）线程调度</strong>和<strong>抢占式（Preemptive Threads-Scheduling）线程调度</strong>。</p>
<ul>
<li><strong>协同式线程调度</strong>：线程的执行时间由线程本身来控制，线程把自己的工作执行完了之后，要主动通知系统切换到另外一个线程上去。
<strong>优点</strong>：实现简单，切换操作对线程自己是可知的，所以一般没有什么线程同步问题。
<strong>缺点</strong>：线程执行时间不可控制，甚至如果一个线程的代码编写有问题，一直不告知系统进行线程切换，那么程序就会一直阻塞在那里。</li>
<li><strong>抢占式线程调度</strong>：每个线程将由系统来分配执行时间，线程的切换不由线程本身来决定。
<strong>优点</strong>：可以主动让出执行时间（例如Java的<code>Thread::yield()</code>方法），并且线程的执行时间是系统可控的，也不会有一个线程导致整个系统阻塞的问题。
<strong>缺点</strong>：无法主动获取执行时间。</li>
</ul>
<p>Java使用的就是抢占式线程调度，虽然这种方式的线程调度是系统自己的完成的，但是我们可以给操作系统一些建议，就是通过设置线程优先级来实现。Java语言一共设置了10个级别的线程优先级。在两个线程同时处于Ready状态时，优先级越高的线程越容易被系统选择执行。</p>
<blockquote>
<p><strong>不过由于各个系统的提供的优先级数量不一致，所以导致Java提供的10个级别的线程优先级并不见得能与各系统的优先级都一一对应</strong>。</p>
</blockquote>
<h3 id=java-线程状态转换>Java 线程状态转换</h3>
<p>Java语言定义了6种线程状态，在任意一个时间点钟，一个线程只能有且只有其中的一种状态，并且可以通过特定的方法在不同状态之间切换。</p>
<ul>
<li><strong>新建（New）</strong>：创建后尚未启动的线程处于这种状态。</li>
<li><strong>运行（Runnable）</strong>：包括操作系统线程状态中的Running和Ready，也就是处理此状态的线程有可能正在执行，也有可能正在等待着操作系统为它分配执行时间。</li>
<li><strong>无限期等待（Waiting）</strong>：处于这种状态的线程不会被分配处理器执行时间，它们要等待被其他线程显示唤醒。
以下方法会让线程陷入无限期等待状态：
<strong>1</strong>、没有设置Timeout参数的<code>Object::wait()</code>方法；
<strong>2</strong>、没有设置Timeout参数的<code>Thread::join()</code>方法；
<strong>3</strong>、<code>LockSupport::park()</code>方法。</li>
<li><strong>限期等待（Timed Waiting）</strong>：处于这种状态的线程也不会被分配处理器执行时间，不过无须等待被其他线程显式唤醒，在一定时间之后它们会由系统自动唤醒。
以下方法会让线程进入限期等待状态：
<strong>1</strong>、<code>Thread::sleep()</code>方法；
<strong>2</strong>、设置了Timeout参数的<code>Object::wait()</code>方法；
<strong>3</strong>、设置了Timeout参数的<code>Thread::join()</code>方法；
<strong>4</strong>、<code>LockSupport::parkNanos()</code>方法；
<strong>5</strong>、<code>LockSupport::parkUntil()</code>方法；</li>
<li><strong>阻塞（Blocked）</strong>：线程被阻塞了，“阻塞状态”与“等待状态”的区别是“阻塞状态”在等待着获取到一个排他锁，这个事件将在另外一个线程放弃这个锁的时候发生；而“等待状态”则是在等待一段时间 ，或者唤醒动作发生。在程序进入同步区域的时候，线程将进入这种状态。</li>
<li><strong>结束（Terminated）</strong>：已终止线程的线程状态，线程已经结束执行。</li>
</ul>
<h3 id=threadsleep>Thread.sleep</h3>
<p>如果执行了 Thread.sleep, 底层的执行流程:</p>
<ol>
<li>JVM 调用底层 OS 的线程 API</li>
<li>因为 JVM 采用关于内核线性一对一的线程模型, JVM 会要求操作系统在执行的时间内将线程的使用权归还给 CPU</li>
<li>一旦休眠时间到期, OS 调度器将会通过中断来唤醒线程, 并为线性分配 CPU 时间片以恢复该线程的执行</li>
</ol>
<p>这里的关键点是， JVM 层面的这个线程在休眠期间是完全无法被复用的。</p>
<ul>
<li>
<p>但是一个 JVM 内部能够创建的线程数量是有限的的，创建过多则会引起 OOM。</p>
<ul>
<li>java.lang.OutOfMemoryError : unable to create new native Thread</li>
</ul>
</li>
<li>
<p>JVM 中的每个线程都会带来昂贵的内存开销，它会附带一个线程栈。</p>
</li>
<li>
<p>太多的 JVM 线程将产生开销，因为上下文切换非常昂贵，而且它们共享有限的硬件资源。</p>
</li>
<li>
<p><a href=https://medium.com/@daniel.sebban/how-to-thread-sleep-without-blocking-on-the-jvm-3bc3fac08011>How to Thread.sleep without blocking on the JVM | by Daniel Sebban | Medium</a></p>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d431221e8f0cabe00d8d94b77f6e6ab6>3.5 - CH05-Synchronized</h1>
<h2 id=应用实践>应用实践</h2>
<ul>
<li>一把锁同时只能被一个线程获取，没有获得锁的线程只能等待。</li>
<li>每个对象实例都有自己的锁(this)，该锁不同实例之间互不影响。</li>
<li>synchronized 修饰的方法，物理方法成功还是抛出异常，都会释放锁。</li>
</ul>
<h3 id=对象锁>对象锁</h3>
<p>包含实例方法锁(this)和同步代码块锁(自定义)。</p>
<ul>
<li>
<p>代码块形式：手动设置锁定对象，也可以是 this，也可以是自定义的(对象实例)锁。</p>
<ul>
<li><code>syhchronized(this)</code></li>
<li><code>synchronized(object)</code>，比如 <code>new Object()</code> 作为一个实例锁。</li>
</ul>
</li>
<li>
<p>方法锁形式：修饰实例的方法，锁对象是 this。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Example</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;example...&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
</ul>
<h3 id=类锁>类锁</h3>
<p>指 synchronized 修饰静态的方法或指定锁对象为 Class 对象。</p>
<ul>
<li>
<p>静态方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Example</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;example...&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>Class 对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Example</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>synchronized</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Example</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;example...&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
</ul>
<h2 id=原理分析>原理分析</h2>
<h3 id=加锁-解锁>加锁-解锁</h3>
<p>创建如下代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SynchronizedDemo2</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>method1</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用 javac 命令编译生成 class 文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>javac SynchronizedDemo2.java
</code></pre></div><p>使用 javap 命令反编译查看 class 文件的信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>javap -verbose SynchronizedDemo2.class
</code></pre></div><p>得到如下信息：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421212545.png style=display:block;width:50% alt=NAME align=center> </div>
<p>mointorenter 和 moniterexit 指令，会在程序执行时，使其锁计数器加一或减一。每个对象在同一时间只有一个 mointor(锁) 与其相关联，而一个 mointor 在同一时间只能被一个线程获得，一个对象在尝试获得与该对象关联的 monitor 锁的所有权时，monitorenter 指令会发生如下三种情况之一：</p>
<ul>
<li>mointor 计数器为 0，意味着目前尚未被某个线程获得，该线程会立即获得锁并将计数器加一，一旦执行加一，别的线程要想再获取就需要等待。</li>
<li>如果该线程已经拿到了该 mointor 锁的所有权，又重入了这把锁，锁计数器会继续累加一，值变为 2，随着重入次数的增加，计数值会一直累加。</li>
<li>如果该 monitor 锁已经被其他线程获得，当前线程等待锁被释放。</li>
</ul>
<p>monitorexit 指令将释放对应 monitor 锁的所有权，释放过程很简单，即将 monitor 的计数器减一，如果结果不为 0，则表示当前是重入获得的锁，当前线程还继续持有该锁的所有权，如果计数器为 0，则表示当前线程不再拥有该 monitor 的所有权，即释放了锁。</p>
<p>下图描绘了真个过程：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421213356.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图可以看出，任意线程对 Object 的访问，首先要获得 Object 的监视锁，如果获取失败，该线程就会进入同步状态，线程状态变为 Blocked，当 Object 的监视器占有者释放后，在同步队列中的线程就有就会获取到该监视器。</p>
<h3 id=可冲入加锁次数计数器>可冲入：加锁次数计数器</h3>
<p>在同一个线程中，线程不需要再次获取通一把锁。synchronized 先天具有重入性。每个对象拥有一个计数器，当线程获取对象 monitor 锁后，计数器就会加一，释放锁后就会减一。</p>
<h3 id=可见性保证内存模型与-happens-before>可见性保证：内存模型与 happens-before</h3>
<p>synchronized 的 happens-before 规则，即监视器锁规则：(一个线程)对同一个监视器解锁，happens-before 于(另一个线程)对该监视器加锁。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MonitorDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>++;</span>                                <span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>                                       <span style=color:#8f5902;font-style:italic>// 3
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#8f5902;font-style:italic>// 4
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>                         <span style=color:#8f5902;font-style:italic>// 5
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>                                      <span style=color:#8f5902;font-style:italic>// 6
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421214040.png style=display:block;width:50% alt=NAME align=center> </div>
<p>图中每个箭头的两个节点之间都是 happens-before 关系。黑色箭头由程序顺序规则推导得出，红色为监视器锁规则推导而出：<strong>线程 A 释放锁先于线程 B 获得锁</strong>。蓝色则是通过程序顺序规则和监视器锁规则推测出来的 happens-before 关系，通过传递性规则进一步推导出 happens-before 规则。</p>
<p>根据 happens-before 的定义：如果 A 先于 B，则 A 的执行顺序先于 B，并且 A 的执行结果对 B 可见。</p>
<p>线程 A 先对共享变量 +1，由 2 先于 5 得知线程 A 的执行结果对 B 可见，即 B 读取到 a 的值为 1。</p>
<h2 id=jvm-锁优化>JVM 锁优化</h2>
<p>JVM 在执行 monitorenter 和 monitorexit 这些指令时，依赖于底层操作系统的 Mutex Lock(互斥锁)，但是由于 Mutex Lock 需要挂起当前线程，并从用户态切换到内核态来执行，这种切换的代价昂贵。然而在大部分的实际情况中，同步方法是运行在单线程环境(无锁竞争环境)，如果每次都调用 Mutex Lock 则会严重影响性能。</p>
<p>JDK 1.6 引入了大量优化来提升性能：</p>
<ul>
<li>锁粗化：减少不必要的紧连在一起的加锁、解锁操作，将多个连续的小锁扩展为一个更大的锁。</li>
<li>锁消除：通过运行时 JIT 编译器的逃逸分析来消除一些没有在当前同步块以外被其他线程共享的数据的锁保护，通过逃逸分析也可以在线程本地 Stack 上进行空间对象的分配(通知还可以减少 Heap 上垃圾收集的开销)。</li>
<li>轻量级锁：实现的原理是基于这样的假设，即在真是情况下程序中的大部分同步代码一般都属于无锁竞争状态(单线程执行环境)，在无锁竞争的情况下完全可以避免调用操作系统层次的重量级互斥锁，取而代之的是在 monitorenter 和 monitorexit 之间依靠一条 CAS 原子指令就可以完成加锁解锁操作。但存在锁竞争时，执行 CAS 指令失败的线程将再去调用操作系统互斥锁进入阻塞状态，当锁被释放时再被唤醒。</li>
<li>偏向锁：为了在无锁竞争的情况下，避免在加锁过程中执行不必要的 CAS 原子指令，因为 CAS 指令虽然轻于OS 互斥锁，但还是存在(相对)可观的本地延迟。</li>
<li>适应性自旋：当线程在获取轻量级锁的过程中，如果 CAS 执行失败，在进入与 monitor 相关联的 OS 互斥锁之前，首先进入忙等待(自旋-Spinning)，然后再次尝试 CAS，当尝试一定次数知乎仍然失败，再去调用与该 mointor 相关的 OS 互斥锁，进入阻塞状态。</li>
</ul>
<h3 id=锁的类型>锁的类型</h3>
<p>Java 1.6 中 synchronized 同步锁，共有 4 种状态：无锁、偏向锁、轻量锁、重量锁。</p>
<p>会随着竞争状况逐渐升级。锁可以升级但不能降级，目的是为了提高获取锁和释放锁的效率。</p>
<h3 id=自旋锁自适应自旋>自旋锁、自适应自旋</h3>
<h4 id=自旋锁>自旋锁</h4>
<blockquote>
<p>在多线程竞争锁时，当一个线程获取锁时，它会阻塞所有正在竞争的线程，这样对性能带来了极大的影响。在挂起线程和恢复线程的操作都需要转入内核态中完成，这些操作对系统的并发性能带来了很大的压力。同时HotSpot团队注意到在很多情况下，共享数据的锁定状态只会持续很短的一段时间，为了这段时间去挂起和回复阻塞线程并不值得。在如今多处理器环境下，完全可以让另一个没有获取到锁的线程在门外等待一会(自旋)，但不放弃CPU的执行时间。等待持有锁的线程是否很快就会释放锁。为了让线程等待，我们只需要让线程执行一个忙循环(自旋)，这便是自旋锁由来的原因。</p>
</blockquote>
<p>自旋锁早在JDK1.4 中就引入了，只是当时默认时关闭的。在JDK 1.6后默认为开启状态。自旋锁本质上与阻塞并不相同，先不考虑其对多处理器的要求，如果锁占用的时间非常的短，那么自旋锁的新能会非常的好，相反，其会带来更多的性能开销(因为在线程自旋时，始终会占用CPU的时间片，如果锁占用的时间太长，那么自旋的线程会白白消耗掉CPU资源)。因此自旋等待的时间必须要有一定的限度，如果自选超过了限定的次数仍然没有成功获取到锁，就应该使用传统的方式去挂起线程了，在JDK定义中，自旋锁默认的自旋次数为10次，用户可以使用参数<code>-XX:PreBlockSpin</code>来更改。</p>
<p>可是现在又出现了一个问题：如果线程锁在线程自旋刚结束就释放掉了锁，那么是不是有点得不偿失。所以这时候我们需要更加聪明的锁来实现更加灵活的自旋。来提高并发的性能。</p>
<h4 id=自适应自旋>自适应自旋</h4>
<p>在JDK 1.6中引入了自适应自旋锁。这就意味着自旋的时间不再固定了，而是由前一次在同一个锁上的自旋 时间及锁的拥有者的状态来决定的。如果在同一个锁对象上，自旋等待刚刚成功获取过锁，并且持有锁的线程正在运行中，那么JVM会认为该锁自旋获取到锁的可能性很大，会自动增加等待时间。比如增加到100次循环。相反，如果对于某个锁，自旋很少成功获取锁。那再以后要获取这个锁时将可能省略掉自旋过程，以避免浪费处理器资源。有了自适应自旋，JVM对程序的锁的状态预测会越来越准备，JVM也会越来越聪明。</p>
<h3 id=锁消除>锁消除</h3>
<p>锁消除是指虚拟机即时编译器在运行过冲中，对一些在代码上要求同步、但是被检测到不可能存在共享数据竞争的锁进行消除。锁消除的主要判定依据来源于逃逸分析的数据支持。意思就是：JVM 会判断在一段程序中的同步数据明显不会逃逸出去从而被其他线程访问到，那 JVM 就把它们当作栈上数据对待，认为这些数据是线程独有的，不需要加同步。此时就会进行锁消除。</p>
<p>当然在实际开发中，我们很清楚的知道那些地方是线程独有的，不需要加同步锁，但是在 Java API 中有很多方法都是加了同步的，那么此时 JVM 会判断这段代码是否需要加锁。如果数据并不会逃逸，则会进行锁消除。比如如下操作：在操作 String 类型数据时，由于 String 是一个不可变类，对字符串的连接操作总是通过生成的新的 String 对象。因此 Javac 编译器会对 String 连接做自动优化。在 JDK 1.5 之前会使用 StringBuffer 对象的连续 append() 操作，在 JDK 1.5 及以后的版本中，会转化为 StringBuidler 对象的连续 append() 操作。</p>
<h3 id=锁粗化>锁粗化</h3>
<p>原则上，我们都知道在加同步锁时，尽可能的将同步块的作用范围限制到尽量小的范围(只在共享数据的实际作用域中才进行同步，这样是为了使得需要同步的操作数量尽可能变小。在存在锁同步竞争中，也可以使得等待锁的线程尽早的拿到锁。</p>
<p>大部分上述情况是正确的，但是如果存在连串的一系列操作都对同一个对象反复加锁和解锁，甚至加锁操作时出现在循环体中的，那即使没有线程竞争，频繁地进行互斥同步操作也会导致不必要地性能操作。</p>
<h3 id=轻量锁>轻量锁</h3>
<p>在 JDK 1.6 之后引入的轻量级锁，需要注意的是轻量级锁并不是替代重量级锁的，而是对在大多数情况下同步块并不会有竞争出现时提供的一种优化。它可以减少重量级锁对线程的阻塞带来地线程开销。从而提高并发性能。</p>
<p>如果要理解轻量级锁，那么必须先要了解 HotSpot 虚拟机中对象头地内存布局。在对象头中(<code>Object Header</code>)存在两部分。第一部分用于存储对象自身的运行时数据，<code>HashCode</code>、<code>GC Age</code>、<code>锁标记位</code>、<code>是否为偏向锁</code>等。一般为32位或者64位(视操作系统位数定)。官方称之为<code>Mark Word</code>，它是实现轻量级锁和偏向锁的关键。 另外一部分存储的是指向方法区对象类型数据的指针(<code>Klass Point</code>)，如果对象是数组的话，还会有一个额外的部分用于存储数据的长度。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421225702.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如上图所示，如果当前对象没有被锁定，那么锁标志位为 01 状态，JVM 在指向当前线程时，首先会在当前线程帧栈中创建锁记录 Lock Record 的空间，用于存储锁对象目前的 Mark Word 的拷贝。</p>
<p>然后，虚拟机使用 CAS 操作将标记字段 Mark Word 拷贝到锁记录中，并将 Mark Word 更新为指向 Lock Record 的指针。如果更新成功了，那么这个线程就有了使用该对象的锁，并且对象 Mark Word 的所标志位更新为(Mark Word 中最后为 2 bit) 00，即表示该对象处于轻量级锁定状态，如图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421230130.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如果更新操作失败，JVM 会检查当前 Mark Word 中是否存在指向当前线程帧栈的指针，如果有，则表示锁已经被获取，可以直接使用。如果没有，则说明该锁已经被其他线程抢占，如果有两条以上的线程同时经常一个锁，那么轻量级锁就不再有效，直接升级为重量级锁，没有获得锁的线程会被阻塞。此时，锁的标志位为 10，Mark Word 中存储的是指向重量级锁的指针。</p>
<p>轻量级锁解锁时，会使用原子的 CAS 操作将 Displaced Mark Word 替换会对象头中，如果成功，则表示没有发生竞争，如果失败，则表示当前锁存在竞争关系。锁就会升级为重量级锁。</p>
<p>两个线程同时抢占锁，导致锁升级的流程如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421230457.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=偏向锁>偏向锁</h3>
<blockquote>
<p>在大多数实际环境中，锁不仅不存在多线程竞争，而且总是由同一个线程多次获取，那么在同一个线程反复加锁解锁的过程中，其中并没有对锁的竞争，这样一来，多次加锁解锁带来了不必要的性能开销。</p>
<p>为了解决这一问题，HotSpot 的作者在 Java SE 1.6 中对 Synchronized 进行了优化，引入了偏向锁。</p>
</blockquote>
<p>当一个线程访问同步块并获取锁时，会在对象头和帧栈中的锁记录里存储偏向锁偏向的线程 ID，以后该线程在进入和退出同步块时不需要进行 CAS 操作来加锁和解锁。只需要简单的测试一下对象头的 Mark Word 中是否保存了指向当前线程的偏向锁。如果成功，表示线程已经获得了锁。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421230911.png style=display:block;width:50% alt=NAME align=center> </div>
<p>偏向锁使用了一种等待竞争出现时才会释放锁的机制。当其他线程尝试获取偏向锁时，持有偏向锁的线程才会释放锁。但是偏向锁的撤销需要等到全局安全点(即当前线程没有正在执行的字节码)。</p>
<p>它首先会暂停拥有偏向锁的线程，然后检查持有偏向锁的线程是否还活着。如果线程不处于活动状态，直接将对象头设置为无锁状态。如果活着，JVM 会遍历帧栈中的锁记录，帧栈中的锁记录和对象头要么偏向于其他线程，要么恢复到无锁状态或者标记对象不适合作为偏向锁。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210421231251.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=锁对比>锁对比</h3>
<table>
<thead>
<tr>
<th>锁</th>
<th>优点</th>
<th>缺点</th>
<th>场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>偏向锁</td>
<td>加锁解锁不需要 CAS，没有额外性能开销</td>
<td>如果线程间存在竞争，撤销锁会带来额外开销</td>
<td>仅一个线程访问同步块</td>
</tr>
<tr>
<td>轻量锁</td>
<td>竞争的线程不会阻塞，提供响应速度</td>
<td>如果线程始终得到到锁，自旋会消耗性能</td>
<td>同步块执行速度非常快</td>
</tr>
<tr>
<td>重量锁</td>
<td>线程竞争不适用自旋，不会消耗 CPU</td>
<td>线程阻塞、响应慢、频繁加解锁开销大</td>
<td>追求吞吐量，同步块执行速度慢</td>
</tr>
</tbody>
</table>
<h2 id=synchronized-与-lock>Synchronized 与 Lock</h2>
<h3 id=synchronized-的缺陷>Synchronized 的缺陷</h3>
<ul>
<li>效率低：锁的释放情况少，只有代码指向完或抛出异常时才会解锁；试图获取锁时不能设置超时，不能中断正在使用锁的线程，而 Lock 可以中断或设置超时。</li>
<li>不灵活：加锁和解锁的时机单一，每个锁仅有一个单一的条件(对象实例)，Lock 更加灵活。</li>
<li>无法感知是否获得锁：Lock 可以显式获取状态，然后基于状态执行判断。</li>
</ul>
<h3 id=相比-lock>相比 Lock</h3>
<p>Lock 的方法：</p>
<ul>
<li>lock：加锁</li>
<li>unlock：解锁</li>
<li>tryLock：尝试加锁，返回布尔值</li>
<li>tryLock(long,TimeUnit)：尝试加锁，设定超时</li>
</ul>
<p>多线程竞争锁时，其余未获得锁的线程只能不停的尝试加锁，而不能中断，高并发情况下会导致性能下降。</p>
<p>ReentrantLock 的 lockInterruptibly() 方法可以优先考虑响应中断。 一个线程等待时间过长，它可以中断自己，然后 ReentrantLock 响应这个中断，不再让这个线程继续等待。有了这个机制，使用 ReentrantLock 时就不会像 synchronized 那样产生死锁了。</p>
<h3 id=注意事项>注意事项</h3>
<p>Synchronized 由 JVM 实现，无需显式控制加解锁逻辑。</p>
<ul>
<li>锁对象不能为空，因为锁的信息都保存在对象头里</li>
<li>作用域不宜过大，影响程序执行的速度，控制范围过大，编写代码也容易出错</li>
<li>避免死锁</li>
<li>在能选择的情况下，既不要用 Lock 也不要用 synchronized 关键字，用 JUC 包中的各种各样的类，如果不用该包下的类，在满足业务的情况下，可以使用 synchronized 关键，避免手动操作引起错误</li>
<li><strong>synchronized 是公平锁吗？</strong>
<ul>
<li>实际上是非公平的，新来的线程有可能立即获得监视器，而在等待区中等候已久的线程可能再次等待。</li>
<li>但这种抢占的方式可以预防饥饿。</li>
</ul>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1bbc182fc446a6c4b1996a26750fd077>3.6 - CH06-Volatile</h1>
<h2 id=基本作用>基本作用</h2>
<h3 id=防止重排序>防止重排序</h3>
<p>比如一个对象构造过程的场景，实例化一个对象可以分为 3 个步骤：</p>
<ol>
<li>分配内存空间</li>
<li>初始化对象</li>
<li>将内存空间的地址赋值给对应的引用</li>
</ol>
<p>但是由于操作系统可以“对指令进行重排序”，所以上面的过程可能会被转换为：</p>
<ol>
<li>分配内存空间</li>
<li>将内存空间的地址赋值给对应的引用</li>
<li>初始化对象</li>
</ol>
<p>这样一来，多线程环境下可能将一个尚未初始化的对象引用暴露到外部，从而导致非预期的行为。</p>
<p>因此为了防止该过程的重排序，我们可以将变量设置为 volatile 类型的变量。</p>
<h3 id=实现可见性>实现可见性</h3>
<p>可见性问题主要指一个线程修改了共享变量值，而另一个线程却看不到。引起可见性问题的主要原因是每个线程拥有自己的一个高速缓存区——线程工作内存。volatile 能有效的解决这个问题。</p>
<h3 id=保证原子性单次读写>保证原子性：单次读/写</h3>
<p>基于 volatile 保证单次的读/写操作具有原子性的理解，你将能够理解如下两个问题：</p>
<h4 id=i-为什么不能保证原子性>i++ 为什么不能保证原子性</h4>
<p>对 volatile 变量的单次读/写操作可以保证原子性的，如 long 和 double 类型变量，但是并不能保证 i++ 这种操作的原子性，因为本质上 i++ 是读、写两次操作，包括三步骤：</p>
<ul>
<li>读取 i 的值。</li>
<li>对 i 加 1。</li>
<li>将 i 的值写回内存。 volatile 是无法保证这三个操作是具有原子性的，我们可以通过 AtomicInteger 或者 Synchronized 来保证 +1 操作的原子性。 注：上面几段代码中多处执行了 Thread.sleep() 方法，目的是为了增加并发问题的产生几率，无其他作用。</li>
</ul>
<h4 id=共享的-long-和-double-变量的为什么要用-volatile>共享的 long 和 double 变量的为什么要用 volatile?</h4>
<p>因为 long 和 double 两种数据类型的操作可分为高 32 位和低 32 位两部分，因此普通的 long 或 double 类型读/写可能不是原子的。因此，鼓励大家将共享的 long 和 double 变量设置为 volatile 类型，这样能保证任何情况下对 long 和 double 的单次读/写操作都具有原子性。</p>
<p>目前各种平台下的商用虚拟机都选择把 64 位数据的读写操作作为原子操作来对待，因此我们在编写代码时一般不把 long 和 double 变量专门声明为 volatile 多数情况下也是不会错的。</p>
<h2 id=实现原理>实现原理</h2>
<h3 id=实现可见性-1>实现可见性</h3>
<blockquote>
<p>volatile 变量的内存可见性是基于内存屏障(Memory Barrier)实现。</p>
<ul>
<li>内存屏障，又称内存栅栏，是一个 CPU 指令。</li>
<li>在程序运行时，为了提高执行性能，编译器和处理器会对指令进行重排序，JMM 为了保证在不同的编译器和 CPU 上有相同的结果，通过插入特定类型的内存屏障来禁止特定类型的编译器重排序和处理器重排序。</li>
<li>插入一条内存屏障会告诉编译器和 CPU：不管什么指令都不能和这条 Memory Barrier 指令执行重排序。</li>
</ul>
</blockquote>
<p>比如代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Test</span> <span style=color:#000>test</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>update</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过 hsdis 和 jitwatch 工具可以得到编译后的汇编代码:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>......
  0x0000000002951563: and    $0xffffffffffffff87,%rdi
  0x0000000002951567: je     0x00000000029515f8
  0x000000000295156d: test   $0x7,%rdi
  0x0000000002951574: jne    0x00000000029515bd
  0x0000000002951576: test   $0x300,%rdi
  0x000000000295157d: jne    0x000000000295159c
  0x000000000295157f: and    $0x37f,%rax
  0x0000000002951586: mov    %rax,%rdi
  0x0000000002951589: or     %r15,%rdi
  0x000000000295158c: lock cmpxchg %rdi,(%rdx)  //在 volatile 修饰的共享变量进行写操作的时候会多出 lock 前缀的指令
  0x0000000002951591: jne    0x0000000002951a15
  0x0000000002951597: jmpq   0x00000000029515f8
  0x000000000295159c: mov    0x8(%rdx),%edi
  0x000000000295159f: shl    $0x3,%rdi
  0x00000000029515a3: mov    0xa8(%rdi),%rdi
  0x00000000029515aa: or     %r15,%rdi
......
</code></pre></div><p>lock 前缀的指令在多核处理器下会引发两件事情:</p>
<ul>
<li>将当前处理器缓存行的数据写回到系统内存。</li>
<li>写回内存的操作会使在其他 CPU 里缓存了该内存地址的额数据无效。</li>
</ul>
<p>为了提高处理速度，处理器不直接和内存进行通信，而是先将系统内存的数据读到内部缓存(L1，L2 或其他)后再进行操作，但操作完不知道何时会写到内存。</p>
<p>如果对声明了 volatile 的变量进行写操作，JVM 就会向处理器发送一条 lock 前缀的指令，将这个变量所在缓存行的数据写回到系统内存。</p>
<p>为了保证各个处理器的缓存是一致的，实现了缓存一致性协议(MESI)，每个处理器通过嗅探在总线上传播的数据来检查自己缓存的值是不是过期了，当处理器发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行设置成无效状态，当处理器对这个数据进行修改操作的时候，会重新从系统内存中把数据读到处理器缓存里。</p>
<p>所有多核处理器下还会完成：当处理器发现本地缓存失效后，就会从内存中重读该变量数据，即可以获取当前最新值。</p>
<p>volatile 变量通过这样的机制就使得每个线程都能获得该变量的最新值。</p>
<h4 id=lock-指令>lock 指令</h4>
<p>在 Pentium 和早期的 IA-32 处理器中，lock 前缀会使处理器执行当前指令时产生一个 LOCK# 信号，会对总线进行锁定，其它 CPU 对内存的读写请求都会被阻塞，直到锁释放。 后来的处理器，加锁操作是由高速缓存锁代替总线锁来处理。 因为锁总线的开销比较大，锁总线期间其他 CPU 没法访问内存。 这种场景多缓存的数据一致通过缓存一致性协议(MESI)来保证。</p>
<h4 id=缓存一致性>缓存一致性</h4>
<p>缓存是分段(line)的，一个段对应一块存储空间，称之为缓存行，它是 CPU 缓存中可分配的最小存储单元，大小 32 字节、64 字节、128 字节不等，这与 CPU 架构有关，通常来说是 64 字节。 LOCK# 因为锁总线效率太低，因此使用了多组缓存。 为了使其行为看起来如同一组缓存那样。因而设计了 缓存一致性协议。</p>
<p>缓存一致性协议有多种，但是日常处理的大多数计算机设备都属于 " 嗅探(snooping)" 协议。 所有内存的传输都发生在一条共享的总线上，而所有的处理器都能看到这条总线。 缓存本身是独立的，但是内存是共享资源，所有的内存访问都要经过仲裁(同一个指令周期中，只有一个 CPU 缓存可以读写内存)。 CPU 缓存不仅仅在做内存传输的时候才与总线打交道，而是不停在嗅探总线上发生的数据交换，跟踪其他缓存在做什么。 当一个缓存代表它所属的处理器去读写内存时，其它处理器都会得到通知，它们以此来使自己的缓存保持同步。 只要某个处理器写内存，其它处理器马上知道这块内存在它们的缓存段中已经失效。</p>
<h3 id=实现有序性>实现有序性</h3>
<h4 id=volatile-与-happens-before-的关系>volatile 与 happens-before 的关系</h4>
<p>happens-before 规则中有一条是 volatile 变量规则：对一个 volatile 域的写，先于任意后续对这个 volatile 域的读。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//假设线程A执行writer方法，线程B执行reader方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VolatileExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>flag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>              <span style=color:#8f5902;font-style:italic>// 1 线程A修改共享变量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>flag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 2 线程A写volatile变量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> 
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>flag</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>         <span style=color:#8f5902;font-style:italic>// 3 线程B读同一个volatile变量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>          <span style=color:#8f5902;font-style:italic>// 4 线程B读共享变量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#a40000>……</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>根据 happens-before 规则，上面过程会建立 3 类 happens-before 关系。</p>
<ul>
<li>根据程序次序规则：1 先于 2，且 3 先于 4。</li>
<li>根据 volatile 规则：2 先于 3。</li>
<li>根据 happens-before 传递性：1 先于 4。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210422000755.png style=display:block;width:50% alt=NAME align=center> </div>
<p>因为以上规则，当线程 A 将 volatile 变量 flag 更改为 true 后，线程 B 能够迅速感知。</p>
<h4 id=volatile-禁止重排序>volatile 禁止重排序</h4>
<p>为了性能优化，JMM 在不改变正确语义的前提下，会允许编译器和处理器对指令序列进行重排序。JMM 提供了内存屏障阻止这种重排序。</p>
<p>Java 编译器会在生成指令系列时在适当的位置会插入内存屏障指令来禁止特定类型的处理器重排序。</p>
<p>JMM 会针对编译器制定 volatile 重排序规则表。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210422000852.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图中 NO 表示禁止重排序。</p>
<p>为了实现 volatile 内存语义，编译器在生成字节码时，会在指令序列中插入内存屏障来禁止特定类型的重排序。</p>
<p>对于编译器来说，发现一个最优布置来最小化插入内存屏障的总数几乎是不可能的，为此，JVM 采取了保守策略：</p>
<ul>
<li>在每个 volatile 写操作前插入 StoreStore 屏障。</li>
<li>在每个 volatile 写操作后插入 StoreLoad 屏障。</li>
<li>在每个 volatile 读操作后插入 LoadLoad 屏障。</li>
<li>在每个 volatile 读操作后插入 LoadStore 屏障。</li>
</ul>
<p>volatile 写是在前后分别插入屏障，而读是在后面插入两个内存屏障。</p>
<ul>
<li>StoreStore：禁止上面的普通写和下面的 volatile 写重排序。</li>
<li>StoreLoad：防止上面的 volatile 写与下面可能出现的 volatile 读/写重排序。</li>
<li>LoadLoad：禁止下面所有的普通读操作和上面的 volatile 读重排序。</li>
<li>LoadStore：禁止下面所有的普通下和上面的 volatile 读重排序。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210422221455.png style=display:block;width:50% alt=NAME align=center> </div>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210422221504.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=应用场景>应用场景</h2>
<p>使用 volatile 时必须具备的条件：</p>
<ul>
<li>对变量的写操作不依赖于当前值。</li>
<li>该变量没有包含在其他变量的不变式中。</li>
<li>只有在状态真正独立于成语其他内容时才能使用 volatile。</li>
</ul>
<h3 id=模式-1状态标志>模式-1：状态标志</h3>
<p>或许实现 volatile 变量的规范应用仅仅是通过一个布尔状态标志，用于指示发生了一个重要的一次性事件，比如初始化完成或已经停机，即对变量的简单读写：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shutdownRequested</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shutdown</span><span style=color:#ce5c00;font-weight:700>(){}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>shutdownRequested</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#8f5902;font-style:italic>// execute something
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=模式-2一次性安全发布>模式-2：一次性安全发布</h3>
<p>缺乏同步会导致无法实现可见性，这会使得确定何时写入对象引用而不是原始值变得更加困难。在缺乏同步的情况下，可能会遇到某个对象引用的更新值(由另一个线程写入)和该对象状态的旧值同时存在。</p>
<p>这就是著名的双检锁问题的根源，其中对象引用在没有同步的情况下进行读操作，产生的问题是可能看到一个更新的引用，但是也可能看到尚未构造完成的对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BackgroundFloobleLoader</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Flooble</span> <span style=color:#000>theFlooble</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>initInBackground</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// do lots of stuff
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>theFlooble</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Flooble</span><span style=color:#ce5c00;font-weight:700>();</span>  <span style=color:#8f5902;font-style:italic>// this is the only write to theFlooble
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
 
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SomeOtherClass</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doWork</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
            <span style=color:#8f5902;font-style:italic>// do some stuff...
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// use the Flooble, but only if it is ready
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>floobleLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>theFlooble</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> 
                <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>floobleLoader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>theFlooble</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=模式-3独立观察>模式-3：独立观察</h3>
<p>安全使用 volatile 的另一种简单模式是定期 发布 观察结果供程序内部使用。例如，假设有一种环境传感器能够感觉环境温度。一个后台线程可能会每隔几秒读取一次该传感器，并更新包含当前文档的 volatile 变量。然后，其他线程可以读取这个变量，从而随时能够看到最新的温度值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserManager</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>String</span> <span style=color:#000>lastUser</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>authenticate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>valid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>passwordIsValid</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>valid</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>User</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>activeUsers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>lastUser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>valid</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=模式-4volatile-bean>模式-4：volatile bean</h3>
<p>在 volatile bean 模式中，JavaBean 的所有数据成员都是 volatile 类型的，并且 getter 和 setter 方法必须非常普通 —— 除了获取或设置相应的属性外，不能包含任何逻辑。此外，对于对象引用的数据成员，引用的对象必须是有效不可变的。(这将禁止具有数组值的属性，因为当数组引用被声明为 volatile 时，只有引用而不是数组本身具有 volatile 语义)。对于任何 volatile 变量，不变式或约束都不能包含 JavaBean 属性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ThreadSafe</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>String</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFirstName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getLastName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAge</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>age</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=模式-5开销较低的读写锁策略>模式-5：开销较低的读写锁策略</h3>
<p>volatile 的功能还不足以实现计数器。因为 ++x 实际上是三种操作(读、添加、存储)的简单组合，如果多个线程凑巧试图同时对 volatile 计数器执行增量操作，那么它的更新值有可能会丢失。 如果读操作远远超过写操作，可以结合使用内部锁和 volatile 变量来减少公共代码路径的开销。 安全的计数器使用 synchronized 确保增量操作是原子的，并使用 volatile 保证当前结果的可见性。如果更新不频繁的话，该方法可实现更好的性能，因为读路径的开销仅仅涉及 volatile 读操作，这通常要优于一个无竞争的锁获取的开销。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@ThreadSafe</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CheesyCounter</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Employs the cheap read-write lock trick
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// All mutative operations MUST be done with the &#39;this&#39; lock held
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@GuardedBy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;this&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>increment</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=模式-6双重检查>模式-6：双重检查</h3>
<p>单例模式的一种实现方式，但很多人会忽略 volatile 关键字，因为没有该关键字，程序也可以很好的运行，只不过代码的稳定性总不是 100%，说不定在未来的某个时刻，隐藏的 bug 就出来了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Singleton</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Singleton</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Singleton</span> <span style=color:#000>getInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>syschronized</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Singleton</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>instance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Singleton</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3ee11dea81baaca403c02e74956c78a2>3.7 - CH07-Final</h1>
<h2 id=基本用法>基本用法</h2>
<h3 id=修饰类>修饰类</h3>
<p>当某个类的整体定义为 final 时，就表明了你不能打算继承该类，而且也不允许别人这么做。即这个类是不能有子类的。</p>
<p>final 类中的所有方法都隐式为 final，因为无法覆写他们，所以在 final 类中给任何方法添加 final 关键字是没有任何意义的。</p>
<h3 id=修饰方法>修饰方法</h3>
<ul>
<li>private 方法是隐式的 final，即不能被子类重写</li>
<li>final 方法是可以被重载的</li>
</ul>
<h4 id=private-final>private final</h4>
<p>类中所有 private 方法都隐式地指定为 final 的，由于无法取用 private 方法，所以也就不能覆盖它。可以对 private 方法增添 final 关键字，但这样做并没有什么好处。</p>
<h4 id=final-方法可以被重载>final 方法可以被重载</h4>
<h3 id=修饰参数>修饰参数</h3>
<p>Java 允许在参数列表中以声明的方式将参数指明为 final，这意味这你无法在方法中更改参数引用所指向的对象。这个特性主要用来向匿名内部类传递数据。</p>
<h3 id=修饰字段>修饰字段</h3>
<h4 id=并非所有的-fianl-字段都是编译期常量>并非所有的 fianl 字段都是编译期常量</h4>
<p>比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Example</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Random</span> <span style=color:#000>random</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Random</span><span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>random</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextInt</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的字段 value 并不能在编译期推导出实际的值，而是在运行时由 random 决定。</p>
<h4 id=static-final>static final</h4>
<p>static final 字段只是占用一段不能改变的存储空间，它必须在定义的时候进行赋值，否则编译期无法同步。</p>
<h4 id=blank-final>blank final</h4>
<p>Java 允许生成空白 final，也就是说被声明为 final 但又没有给出定值的字段，但是必须在该字段被使用之前被赋值，这给予我们两种选择：</p>
<ul>
<li>在定义处进行赋值(这不是空白 final)</li>
<li>在构造器中进行赋值，保证了该值在被使用之前赋值。</li>
</ul>
<h2 id=重排序规则>重排序规则</h2>
<h3 id=final-域为基本类型>final 域为基本类型</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FinalDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>  										<span style=color:#8f5902;font-style:italic>//普通域
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span> 								<span style=color:#8f5902;font-style:italic>//final域
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>FinalDemo</span> <span style=color:#000>finalDemo</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//静态域
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FinalDemo</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 1. 写普通域
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 2. 写final域
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>finalDemo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FinalDemo</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>FinalDemo</span> <span style=color:#000>demo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>finalDemo</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 3.读对象引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>demo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>a</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>//4.读普通域
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>demo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>b</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>//5.读final域
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>假设线程 A 执行 writer 方法，线程 B 执行 reader 方法。</p>
<h4 id=写操作>写操作</h4>
<p>写 final 域的重排序规则禁止对 final 域的写操作重排序到构造函数之外，该规则的实现主要包含两个方面：</p>
<ul>
<li>JMM 禁止编译器把 final 域的写重排序到构造函数之外。</li>
<li>编译器会在 final 域写之后，构造函数 return 之前，插入一个 storestore 屏障。
<ul>
<li>该屏障可以禁止处理器将 final 域的写重排序到构造函数之外。</li>
</ul>
</li>
</ul>
<p>writer 方法分析：</p>
<ul>
<li>构造了一个 FinalDemo 对象。</li>
<li>把这个对象复制给成员变量 finalDemo。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425210946.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由于 a，b 之间没有依赖，普通域 a 可能会被重排序到构造函数之外，线程 B 肯呢个读到普通变量 a 初始化之前的值(零值)，即引起错误。</p>
<p>而 final 域变量 b，根据重排序规则，会禁止 final 修饰的变量 b 被重排序到构造函数之外，因此 b 会在构造函数内完成赋值，线程 B 可以读到正确赋值后的 b 变量。</p>
<p>因此，写 final 域的重排序规则可以确保：在对象引用被任意线程可见之前，对象的 final 域已经被正确初始化过了，而普通域就不具有这个保障。</p>
<h4 id=读操作>读操作</h4>
<p>读 final 域的重排序规则为：在一个线程中，初次读对象引用和初次读该对象包含的 final 域，JMM 会禁止这两个操作的重排序。(仅针对处理器)，处理器会在读 final 域操作之前插入一个 LoadLoad 屏障。</p>
<p>实际上，度对象的引用和读对象的 final 域存在间接依赖性，一般处理器不会对这两个操作执行重排序。但是不能排除有些处理器会执行重排序，因此，该规则就是针对这些处理器设定的。</p>
<p>reader 方法分析：</p>
<ul>
<li>初次读引用变量 finalDemo；</li>
<li>初次读引用变量 finalDemo 的普通域；</li>
<li>初次读引用变量 finalDemo 的 fianl 域 b；</li>
</ul>
<p>假设线程A写过程没有重排序，那么线程A和线程B有一种的可能执行时序为下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425211720.png style=display:block;width:50% alt=NAME align=center> </div>
<p>读对象的普通域被排序到读对象引用之前，就会出现线程 B 还未多读到对象引用就在读取该对象的普票域变量，这显然是错误操作。</p>
<p>而 final 域的读操作就限定了在读 final 域变量前就已经读到了该对象的引用，从而避免这种错误。</p>
<p>读 final 域的重排序规则可以保证：在读取一个对象的 fianl 域之前，一定会先读取该 final 域所属的对象引用。</p>
<h3 id=final-域为引用类型>final 域为引用类型</h3>
<h4 id=对-final-修饰对象的成员域执行写操作>对 final 修饰对象的成员域执行写操作</h4>
<p>针对引用数据类型，final域写针对编译器和处理器重排序增加了这样的约束：在构造函数内对一个final修饰的对象的成员域的写入，与随后在构造函数之外把这个被构造的对象的引用赋给一个引用变量，这两个操作是不能被重排序的。注意这里的是“增加”也就说前面对final基本数据类型的重排序规则在这里还是使用。这句话是比较拗口的，下面结合实例来看。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FinalReferenceDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>FinalReferenceDemo</span> <span style=color:#000>finalReferenceDemo</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FinalReferenceDemo</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arrays</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>  <span style=color:#8f5902;font-style:italic>//1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>//2
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writerOne</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>finalReferenceDemo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FinalReferenceDemo</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//3
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writerTwo</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//4
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>finalReferenceDemo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>//5
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>finalReferenceDemo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arrays</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>  <span style=color:#8f5902;font-style:italic>//6
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>针对上面的实例程序，线程线程A执行wirterOne方法，执行完后线程B执行writerTwo方法，然后线程C执行reader方法。下图就以这种执行时序出现的一种情况来讨论(耐心看完才有收获)。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425212130.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由于对final域的写禁止重排序到构造方法外，因此1和3不能被重排序。由于一个final域的引用对象的成员域写入不能与随后将这个被构造出来的对象赋给引用变量重排序，因此2和3不能重排序。</p>
<h4 id=对final-修饰的对象的成员域执行读操作>对final 修饰的对象的成员域执行读操作</h4>
<p>JMM可以确保线程C至少能看到写线程A对final引用的对象的成员域的写入，即能看下 <code>arrays[0] = 1</code>，而写线程B对数组元素的写入可能看到可能看不到。JMM不保证线程B的写入对线程C可见，线程B和线程C之间存在数据竞争，此时的结果是不可预知的。如果可见的，可使用锁或者volatile。</p>
<h3 id=final-重排序总结>final 重排序总结</h3>
<ul>
<li>基本数据类型
<ul>
<li>禁止 final 域写与构造函数重排序，即禁止 final 域重排序到构造方法之外，从而保证该对象对所有线程可见时，该对象的 final 域全部已经初始化过。</li>
<li>禁止初次读取该对象的引用与读取该对象 fianl 域的重排序。</li>
</ul>
</li>
<li>引用数据类型
<ul>
<li>相比基本数据类型增加额外规则</li>
<li>禁止在构造函数对一个 final 修饰的对象的成员域的写入与随后将这个被构造的对象的引用复制给引用变量重排序。</li>
<li>即：现在构造函数中完成对 final 修饰的引用类型的字段赋值，再将该引用对象整体复制给 final 修饰的变量。</li>
</ul>
</li>
</ul>
<h2 id=深入理解>深入理解</h2>
<h3 id=实现原理>实现原理</h3>
<ul>
<li>写 final 域会要求编译器在 final 域写之后，构造函数返回前插入一个 StoreStore 屏障。</li>
<li>读 final 域的重排序规则会要求编译器在读 final 域的操作前插入一个 LoadLoad 屏障。</li>
</ul>
<h3 id=为什么-final-引用不能从构造函数中逸出>为什么 final 引用不能从构造函数中逸出</h3>
<p>上面对final域写重排序规则可以确保我们在使用一个对象引用的时候该对象的final域已经在构造函数被初始化过了。</p>
<p>但是这里其实是有一个前提条件的，也就是：在构造函数，不能让这个被构造的对象被其他线程可见，也就是说该对象引用不能在构造函数中“逸出”。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FinalReferenceEscapeDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>FinalReferenceEscapeDemo</span> <span style=color:#000>referenceDemo</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FinalReferenceEscapeDemo</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>referenceDemo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//2
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FinalReferenceEscapeDemo</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reader</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>referenceDemo</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>//3
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>temp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>referenceDemo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>a</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//4
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425212940.png style=display:block;width:50% alt=NAME align=center> </div>
<p>假设一个线程A执行writer方法另一个线程执行reader方法。因为构造函数中操作1和2之间没有数据依赖性，1和2可以重排序，先执行了2，这个时候引用对象referenceDemo是个没有完全初始化的对象，而当线程B去读取该对象时就会出错。尽管依然满足了final域写重排序规则：在引用对象对所有线程可见时，其final域已经完全初始化成功。但是，引用对象“this”逸出，该代码依然存在线程安全的问题。</p>
<h3 id=使用-final-的限制条件和局限性>使用 final 的限制条件和局限性</h3>
<ul>
<li>当声明一个 final 成员时，必须在构造函数退出前设置它的值。</li>
<li>或者，将指向对象的成员声明为 final 只能将该引用设为不可变的，而非所指的对象。</li>
<li>如果一个对象将会在多个线程中访问并且你并没有将其成员声明为 final，则必须提供其他方式保证线程安全。
<ul>
<li>比如声明成员为 volatile，使用 synchronized 或者显式 Lock 控制所有该成员的访问。</li>
</ul>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-bdeadf7ccd90143ff9704fb345ad97ba>3.8 - CH08-并发概览</h1>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425214213.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=locks--tools>Locks & Tools</h2>
<h3 id=层级结构>层级结构</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425214322.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=接口condition>接口：Condition</h3>
<p>Condition 为接口类型，它将 Object 监视器方法(wait、notify 和 notifyAll)分解成截然不同的对象，以便通过将这些对象与任意 Lock 实现组合使用，为每个对象提供多个等待集 (wait-set)。其中，Lock 替代了 synchronized 方法和语句的使用，Condition 替代了 Object 监视器方法的使用。可以通过 await(),signal() 来休眠/唤醒线程。</p>
<h3 id=接口lock>接口：Lock</h3>
<p>Lock 为接口类型，Lock 提供了比使用 synchronized 方法和语句可获得的更广泛的锁定操作。允许更灵活的结构，可以具有差别很大的属性，可以支持多个相关的 Condition 对象。</p>
<h3 id=接口readwritelock>接口：ReadWriteLock</h3>
<p>维护了一对相关的锁，一个用于只读操作，另一个用于写入操作。只要没有 writer，读取锁可以由多个 reader 线程同时保持。写入锁是独占的。</p>
<h3 id=抽象类abstractownablesynchonizer>抽象类：AbstractOwnableSynchonizer</h3>
<p>可以由线程以独占方式拥有的同步器。此类为创建锁和相关同步器(伴随着所有权的概念)提供了基础。AbstractOwnableSynchronizer 类本身不管理或使用此信息。但是，子类和工具可以使用适当维护的值帮助控制和监视访问以及提供诊断。</p>
<h3 id=抽象类longabstractqueuedlongsynchronizer>抽象类(long)：AbstractQueuedLongSynchronizer</h3>
<p>以 long 形式维护同步状态的一个 AbstractQueuedSynchronizer 版本。此类具有的结构、属性和方法与 AbstractQueuedSynchronizer 完全相同，但所有与状态相关的参数和结果都定义为 long 而不是 int。当创建需要 64 位状态的多级别锁和屏障等同步器时，此类很有用。</p>
<h3 id=抽象类intabstractqueuedsynchonizer>抽象类(int)：AbstractQueuedSynchonizer</h3>
<p>其为实现依赖于先进先出 (FIFO) 等待队列的阻塞锁和相关同步器(信号量、事件，等等)提供一个框架。此类的设计目标是成为依靠单个原子 int 值来表示状态的大多数同步器的一个有用基础。</p>
<h3 id=锁工具类locksupport>锁工具类：LockSupport</h3>
<p>LockSupport为常用类，用来创建锁和其他同步类的基本线程阻塞原语。LockSupport的功能和"Thread中的 Thread.suspend()和Thread.resume()有点类似"，LockSupport中的park() 和 unpark() 的作用分别是阻塞线程和解除阻塞线程。但是park()和unpark()不会遇到“Thread.suspend 和 Thread.resume所可能引发的死锁”问题。</p>
<h3 id=锁常用类reentrantlock>锁常用类：ReentrantLock</h3>
<p>它是一个可重入的互斥锁 Lock，它具有与使用 synchronized 方法和语句所访问的隐式监视器锁相同的一些基本行为和语义，但功能更强大。</p>
<h3 id=锁常用类-reentrantreadwritelock>锁常用类: ReentrantReadWriteLock</h3>
<p>ReentrantReadWriteLock是读写锁接口ReadWriteLock的实现类，它包括Lock子类ReadLock和WriteLock。ReadLock是共享锁，WriteLock是独占锁。</p>
<h3 id=锁常用类-stampedlock>锁常用类: StampedLock</h3>
<p>它是 java8 在 java.util.concurrent.locks 新增的一个 API。StampedLock 控制锁有三种模式(写，读，乐观读)，一个 StampedLock 状态是由版本和模式两个部分组成，锁获取方法返回一个数字作为票据 stamp，它用相应的锁状态表示并控制访问，数字 0 表示没有写锁被授权访问。在读锁上分为悲观锁和乐观锁。</p>
<h3 id=工具常用类-countdownlatch>工具常用类: CountDownLatch</h3>
<p>它是一个同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许一个或多个线程一直等待。</p>
<h3 id=工具常用类-cyclicbarrier>工具常用类: CyclicBarrier</h3>
<p>CyclicBarrier 为常用类，其是一个同步辅助类，它允许一组线程互相等待，直到到达某个公共屏障点 (common barrier point)。在涉及一组固定大小的线程的程序中，这些线程必须不时地互相等待，此时 CyclicBarrier 很有用。因为该 barrier 在释放等待线程后可以重用，所以称它为循环的 barrier。</p>
<h3 id=工具常用类-phaser>工具常用类: Phaser</h3>
<p>Phaser 是 JDK 7 新增的一个同步辅助类，它可以实现 CyclicBarrier 和 CountDownLatch 类似的功能，而且它支持对任务的动态调整，并支持分层结构来达到更高的吞吐量。</p>
<h3 id=工具常用类-semaphore>工具常用类: Semaphore</h3>
<p>Semaphore 为常用类，其是一个计数信号量，从概念上讲，信号量维护了一个许可集。如有必要，在许可可用前会阻塞每一个 acquire()，然后再获取该许可。每个 release() 添加一个许可，从而可能释放一个正在阻塞的获取者。但是，不使用实际的许可对象，Semaphore 只对可用许可的号码进行计数，并采取相应的行动。通常用于限制可以访问某些资源(物理或逻辑的)的线程数目。</p>
<h3 id=工具常用类-exchanger>工具常用类: Exchanger</h3>
<p>Exchanger 是用于线程协作的工具类, 主要用于两个线程之间的数据交换。它提供一个同步点，在这个同步点，两个线程可以交换彼此的数据。这两个线程通过 exchange() 方法交换数据，当一个线程先执行 exchange() 方法后，它会一直等待第二个线程也执行 exchange() 方法，当这两个线程到达同步点时，这两个线程就可以交换数据了。</p>
<h2 id=collections-并发集合>Collections: 并发集合</h2>
<h3 id=层级结构-1>层级结构</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425215322.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=queue-arrayblockingqueue>Queue: ArrayBlockingQueue</h3>
<p>一个由数组支持的有界阻塞队列。此队列按 FIFO(先进先出)原则对元素进行排序。队列的头部是在队列中存在时间最长的元素。队列的尾部是在队列中存在时间最短的元素。新元素插入到队列的尾部，队列获取操作则是从队列头部开始获得元素。</p>
<h3 id=queue-linkedblockingqueue>Queue: LinkedBlockingQueue</h3>
<p>一个基于已链接节点的、范围任意的 blocking queue。此队列按 FIFO(先进先出)排序元素。队列的头部 是在队列中时间最长的元素。队列的尾部 是在队列中时间最短的元素。新元素插入到队列的尾部，并且队列获取操作会获得位于队列头部的元素。链接队列的吞吐量通常要高于基于数组的队列，但是在大多数并发应用程序中，其可预知的性能要低。</p>
<h3 id=queue-linkedblockingdeque>Queue: LinkedBlockingDeque</h3>
<p>一个基于已链接节点的、任选范围的阻塞双端队列。</p>
<h3 id=queue-concurrentlinkedqueue>Queue: ConcurrentLinkedQueue</h3>
<p>一个基于链接节点的无界线程安全队列。此队列按照 FIFO(先进先出)原则对元素进行排序。队列的头部 是队列中时间最长的元素。队列的尾部 是队列中时间最短的元素。新的元素插入到队列的尾部，队列获取操作从队列头部获得元素。当多个线程共享访问一个公共 collection 时，ConcurrentLinkedQueue 是一个恰当的选择。此队列不允许使用 null 元素。</p>
<h3 id=queue-concurrentlinkeddeque>Queue: ConcurrentLinkedDeque</h3>
<p>是双向链表实现的无界队列，该队列同时支持FIFO和FILO两种操作方式。</p>
<h3 id=queue-delayqueue>Queue: DelayQueue</h3>
<p>延时无界阻塞队列，使用 Lock 机制实现并发访问。队列里只允许放可以“延期”的元素，队列中的 head 是最先“到期”的元素。如果队里中没有元素到“到期”，那么就算队列中有元素也不能获取到。</p>
<h3 id=queue-priorityblockingqueue>Queue: PriorityBlockingQueue</h3>
<p>无界优先级阻塞队列，使用 Lock 机制实现并发访问。priorityQueue 的线程安全版，不允许存放 null 值，依赖于 comparable 的排序，不允许存放不可比较的对象类型。</p>
<h3 id=queue-synchronousqueue>Queue: SynchronousQueue</h3>
<p>没有容量的同步队列，通过CAS实现并发访问，支持FIFO和FILO</p>
<h3 id=queue-linkedtransferqueue>Queue: LinkedTransferQueue</h3>
<p>JDK 7新增，单向链表实现的无界阻塞队列，通过CAS实现并发访问，队列元素使用 FIFO(先进先出)方式。LinkedTransferQueue可以说是ConcurrentLinkedQueue、SynchronousQueue(公平模式)和LinkedBlockingQueue的超集, 它不仅仅综合了这几个类的功能，同时也提供了更高效的实现。</p>
<h3 id=list-copyonwritearraylist>List: CopyOnWriteArrayList</h3>
<p>ArrayList 的一个线程安全的变体，其中所有可变操作(add、set 等等)都是通过对底层数组进行一次新的复制来实现的。这一般需要很大的开销，但是当遍历操作的数量大大超过可变操作的数量时，这种方法可能比其他替代方法更 有效。在不能或不想进行同步遍历，但又需要从并发线程中排除冲突时，它也很有用。</p>
<h3 id=set-copyonwritearrayset>Set: CopyOnWriteArraySet</h3>
<p>对其所有操作使用内部CopyOnWriteArrayList的Set。即将所有操作转发至CopyOnWriteArayList来进行操作，能够保证线程安全。在add时，会调用addIfAbsent，由于每次add时都要进行数组遍历，因此性能会略低于CopyOnWriteArrayList。</p>
<h3 id=set-concurrentskiplistset>Set: ConcurrentSkipListSet</h3>
<p>一个基于ConcurrentSkipListMap 的可缩放并发 NavigableSet 实现。set 的元素可以根据它们的自然顺序进行排序，也可以根据创建 set 时所提供的 Comparator 进行排序，具体取决于使用的构造方法。</p>
<h3 id=map-concurrenthashmap>Map: ConcurrentHashMap</h3>
<p>是线程安全HashMap的。ConcurrentHashMap在JDK 7之前是通过Lock和segment(分段锁)实现，JDK 8 之后改为CAS+synchronized来保证并发安全。</p>
<h3 id=map-concurrentskiplistmap>Map: ConcurrentSkipListMap</h3>
<p>线程安全的有序的哈希表(相当于线程安全的TreeMap);映射可以根据键的自然顺序进行排序，也可以根据创建映射时所提供的 Comparator 进行排序，具体取决于使用的构造方法。</p>
<h2 id=atomic-原子类>Atomic: 原子类</h2>
<p>其基本的特性就是在多线程环境下，当有多个线程同时执行这些类的实例包含的方法时，具有排他性，即当某个线程进入方法，执行其中的指令时，不会被其他线程打断，而别的线程就像自旋锁一样，一直等到该方法执行完成，才由JVM从等待队列中选择一个另一个线程进入，这只是一种逻辑上的理解。实际上是借助硬件的相关指令来实现的，不会阻塞线程(或者说只是在硬件级别上阻塞了)。</p>
<h3 id=基础类型atomicbooleanatomicintegeratomiclong>基础类型：AtomicBoolean、AtomicInteger、AtomicLong</h3>
<h3 id=数组atomicintegerarrayatomiclongarraybooleanarray>数组：AtomicIntegerArray，AtomicLongArray，BooleanArray</h3>
<h3 id=引用atomicreferenceatomicmarkedreferenceatomicstampedreference>引用：AtomicReference，AtomicMarkedReference，AtomicStampedReference</h3>
<h3 id=fieldupdateratomiclongfieldupdateratomicintegerfieldupdateratomicreferencefieldupdater>FieldUpdater：AtomicLongFieldUpdater，AtomicIntegerFieldUpdater，AtomicReferenceFieldUpdater</h3>
<h2 id=executors线程池>Executors：线程池</h2>
<h3 id=层级结构-2>层级结构</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425220210.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=接口executor>接口：Executor</h3>
<p>Executor 接口提供一种将任务提交与每个任务将如何运行的机制(包括线程使用的细节、调度等)分离开来的方法。通常使用 Executor 而不是显式地创建线程。</p>
<h3 id=executorservice>ExecutorService</h3>
<p>ExecutorService 继承自 Executor 接口，ExecutorService 提供了管理终止的方法，以及可为跟踪一个或多个异步任务执行状况而生成 Future 的方法。 可以关闭 ExecutorService，这将导致其停止接受新任务。关闭后，执行程序将最后终止，这时没有任务在执行，也没有任务在等待执行，并且无法提交新任务。</p>
<h3 id=scheduledexecutorservice>ScheduledExecutorService</h3>
<p>ScheduledExecutorService继承自ExecutorService接口，可安排在给定的延迟后运行或定期执行的命令。</p>
<h3 id=abstractexecutorservice>AbstractExecutorService</h3>
<p>AbstractExecutorService 继承自 ExecutorService 接口，其提供 ExecutorService 执行方法的默认实现。此类使用 newTaskFor 返回的 RunnableFuture 实现 submit、invokeAny 和 invokeAll 方法，默认情况下，RunnableFuture 是此包中提供的 FutureTask 类。</p>
<h3 id=futuretask>FutureTask</h3>
<p>FutureTask 为 Future 提供了基础实现，如获取任务执行结果(get)和取消任务(cancel)等。如果任务尚未完成，获取任务执行结果时将会阻塞。一旦执行结束，任务就不能被重启或取消(除非使用runAndReset执行计算)。FutureTask 常用来封装 Callable 和 Runnable，也可以作为一个任务提交到线程池中执行。除了作为一个独立的类之外，此类也提供了一些功能性函数供我们创建自定义 task 类使用。FutureTask 的线程安全由CAS来保证。</p>
<h3 id=核心-threadpoolexecutor>核心: ThreadPoolExecutor</h3>
<p>ThreadPoolExecutor 实现了 AbstractExecutorService 接口，也是一个 ExecutorService，它使用可能的几个池线程之一执行每个提交的任务，通常使用 Executors 工厂方法配置。 线程池可以解决两个不同问题: 由于减少了每个任务调用的开销，它们通常可以在执行大量异步任务时提供增强的性能，并且还可以提供绑定和管理资源(包括执行任务集时使用的线程)的方法。每个 ThreadPoolExecutor 还维护着一些基本的统计数据，如完成的任务数。</p>
<h3 id=核心-scheduledthreadexecutor>核心: ScheduledThreadExecutor</h3>
<p>ScheduledThreadPoolExecutor 实现 ScheduledExecutorService 接口，可安排在给定的延迟后运行命令，或者定期执行命令。需要多个辅助线程时，或者要求 ThreadPoolExecutor 具有额外的灵活性或功能时，此类要优于 Timer。</p>
<h3 id=核心-forkjoin框架>核心: Fork/Join框架</h3>
<p>ForkJoinPool 是JDK 7 加入的一个线程池类。Fork/Join 技术是分治算法(Divide-and-Conquer)的并行实现，它是一项可以获得良好的并行性能的简单且高效的设计技术。目的是为了帮助我们更好地利用多处理器带来的好处，使用所有可用的运算能力来提升应用的性能。</p>
<h3 id=工具类-executors>工具类: Executors</h3>
<p>Executors 是一个工具类，用其可以创建 ExecutorService、ScheduledExecutorService、ThreadFactory、Callable 等对象。它的使用融入到了 ThreadPoolExecutor, ScheduledThreadExecutor 和 ForkJoinPool 中。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c0f6f1f6840e7affc5155f762a8ba992>3.9 - CH09-底层支撑</h1>
<h2 id=cas>CAS</h2>
<p>现在安全的实现方法：</p>
<ul>
<li>互斥同步：synchronized、ReentrantLock</li>
<li>非阻塞同步：CAS、Atomic-</li>
<li>无同步方案：栈封闭、TreadLocal、可重入代码</li>
</ul>
<h3 id=什么是-cas>什么是 CAS</h3>
<p>CAS 的全称为 Compare-And-Swap，直译就是对比交换。<strong>是一条 CPU 的原子指令</strong>，其作用是让 CPU 先进行比较两个值是否相等，然后原子地更新某个位置的值，经过调查发现，其实现方式是基于硬件平台的汇编指令，就是说 CAS 是靠硬件实现的，JVM 只是封装了汇编调用，那些 AtomicInteger 类便是使用了这些封装后的接口。</p>
<p>简单解释：CAS操作需要输入两个数值，一个旧值(期望操作前的值)和一个新值，在操作期间先比较下在旧值有没有发生变化，如果没有发生变化，才交换成新值，发生了变化则不交换。</p>
<p>CAS 操作是原子性的，所以多线程并发使用 CAS 更新数据时，可以不使用锁。JDK 中大量使用了 CAS 来更新数据而防止加锁(synchronized 重量级锁)来保持原子更新。</p>
<h3 id=应用示例>应用示例</h3>
<p>如果不使用CAS，在高并发下，多线程同时修改一个变量的值我们需要synchronized加锁(可能有人说可以用Lock加锁，Lock底层的AQS也是基于CAS进行获取锁的)。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>java中为我们提供了AtomicInteger 原子类(底层基于CAS进行更新数据的)，不需要加锁就在多线程并发场景下实现数据的一致性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span>  <span style=color:#000>AtomicInteger</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAndGet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=cas-问题>CAS 问题</h3>
<p>CAS 方式为乐观锁，synchronized 为悲观锁。因此使用 CAS 解决并发问题通常情况下性能更优。</p>
<p>但使用 CAS 方式也会有几个问题：</p>
<h4 id=aba-问题>ABA 问题</h4>
<p>因为 CAS 需要在操作值的时候，检查值有没有发生变化，比如没有发生变化则更新，但是如果一个值原来是 A，变成了 B，又变成了 A，那么使用 CAS 进行检查时则会发现它的值没有发生变化，但是实际上却变化了。</p>
<p>ABA 问题的解决思路就是使用版本号。在变量前面追加上版本号，每次变量更新的时候把版本号加1，那么 A->B->A 就会变成 1A->2B->3A。</p>
<p>从 Java 1.5 开始，JDK 的 Atomic 包里提供了一个类 AtomicStampedReference 来解决 ABA 问题。这个类的 compareAndSet 方法的作用是首先检查当前引用是否等于预期引用，并且检查当前标志是否等于预期标志，如果全部相等，则以原子方式将该引用和该标志的值设置为给定的更新值。</p>
<h3 id=循环时间长开销大>循环时间长开销大</h3>
<p>自旋 CAS 如果长时间不成功，会给 CPU 带来非常大的执行开销。如果 JVM 能支持处理器提供的 pause 指令，那么效率会有一定的提升。</p>
<p>pause 指令有两个作用：</p>
<ul>
<li>第一，它可以延迟流水线执行命令(de-pipeline)，使 CPU 不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零；</li>
<li>第二，它可以避免在退出循环的时候因内存顺序冲突(Memory Order Violation)而引起 CPU 流水线被清空(CPU Pipeline Flush)，从而提高 CPU 的执行效率。</li>
</ul>
<h3 id=仅作用于单个变量>仅作用于单个变量</h3>
<p>当对一个共享变量执行操作时，我们可以使用循环 CAS 的方式来保证原子操作，但是对多个共享变量操作时，循环 CAS 就无法保证操作的原子性，这个时候就可以用锁。</p>
<p>还有一个取巧的办法，就是把多个共享变量合并成一个共享变量来操作。比如，有两个共享变量 i = 2，j = a，合并一下 ij = 2a，然后用 CAS 来操作 ij。</p>
<p>从 Java 1.5 开始，JDK 提供了 AtomicReference 类来保证引用对象之间的原子性，就可以把多个变量放在一个对象里来进行 CAS 操作。</p>
<h2 id=unsafe-类>UnSafe 类</h2>
<p>Java 原子类是通过 UnSafe 类实现的。</p>
<p>Unsafe 是位于 sun.misc 包下的一个类，主要提供一些用于执行低级别、不安全操作的方法，如直接访问系统内存资源、自主管理内存资源等，这些方法在提升 Java 运行效率、增强 Java 语言底层资源操作能力方面起到了很大的作用。</p>
<p>但由于 Unsafe 类使 Java 语言拥有了类似 C 语言指针一样操作内存空间的能力，这无疑也增加了程序发生相关指针问题的风险。在程序中过度、不正确使用 Unsafe 类会使得程序出错的概率变大，使得 Java 这种安全的语言变得不再“安全”，因此对 Unsafe 的使用一定要慎重。</p>
<p>这个类尽管里面的方法都是 public 的，但是并没有办法使用它们，JDK API 文档也没有提供任何关于这个类的方法的解释。总而言之，对于 Unsafe 类的使用都是受限制的，只有授信的代码才能获得该类的实例，当然 JDK 库里面的类是可以随意使用的。</p>
<p>功能概览：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210425222809.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=unsafe-与-cas>UnSafe 与 CAS</h3>
<p>内部使用自旋的方式进行CAS更新(while循环进行CAS更新，如果更新失败，则循环再次重试)。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndAddInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>paramInt</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>do</span>
    <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getIntVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>paramInt</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>getAndAddLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>do</span>
    <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getLongVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>paramLong2</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndSetInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>paramInt</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>do</span>
    <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getIntVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramInt</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>getAndSetLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>do</span>
    <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getLongVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong2</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>getAndSetObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>paramObject2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Object</span> <span style=color:#000>localObject</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>do</span>
    <span style=color:#000>localObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>paramObject1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>localObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>paramObject2</span><span style=color:#ce5c00;font-weight:700>));</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>localObject</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从 UnSafe 类中发现，原子操作仅提供了三个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>paramObject2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>paramObject3</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>paramInt1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>paramInt2</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>paramObject</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong3</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h3 id=unsafe-底层>UnSafe 底层</h3>
<p>查看 Unsafe的compareAndSwap- 方法来实现 CAS 操作，它是一个本地方法，实现位于 unsafe.cpp 中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>UNSAFE_ENTRY</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>jboolean</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Unsafe_CompareAndSwapInt</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>JNIEnv</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>env</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jobject</span> <span style=color:#000>unsafe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jobject</span> <span style=color:#000>obj</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jlong</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jint</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jint</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>))</span>
  <span style=color:#000>UnsafeWrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Unsafe_CompareAndSwapInt&#34;</span><span style=color:#000;font-weight:700>);</span>
  <span style=color:#000>oop</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>JNIHandles</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>resolve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span><span style=color:#000;font-weight:700>);</span>
  <span style=color:#000>jint</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>addr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>jint</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>index_oop_from_field_offset_long</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>offset</span><span style=color:#000;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>jint</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>Atomic</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>cmpxchg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>addr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000>UNSAFE_END</span>
</code></pre></div><p>可以看到它通过 <code>Atomic::cmpxchg</code> 来实现比较和替换操作。其中参数x是即将更新的值，参数e是原内存的值。</p>
<p>如果是Linux的x86，<code>Atomic::cmpxchg</code>方法的实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>inline</span> <span style=color:#000>jint</span> <span style=color:#000>Atomic</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>cmpxchg</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>jint</span> <span style=color:#000>exchange_value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>jint</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>dest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jint</span> <span style=color:#000>compare_value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>is_MP</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000>__asm__</span> <span style=color:#000>volatile</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>LOCK_IF_MP</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>)</span> <span style=color:#4e9a06>&#34;cmpxchgl %1,(%3)&#34;</span>
                    <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;=a&#34;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>exchange_value</span><span style=color:#000;font-weight:700>)</span>
                    <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;r&#34;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>exchange_value</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#34;a&#34;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>compare_value</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#34;r&#34;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>dest</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#34;r&#34;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>mp</span><span style=color:#000;font-weight:700>)</span>
                    <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cc&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;memory&#34;</span><span style=color:#000;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exchange_value</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>而 windows 的 x86 的实现如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>inline</span> <span style=color:#000>jint</span> <span style=color:#000>Atomic</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>cmpxchg</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>jint</span> <span style=color:#000>exchange_value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>jint</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>dest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>jint</span> <span style=color:#000>compare_value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>isMP</span><span style=color:#000;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//判断是否是多处理器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_asm</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>mov</span> <span style=color:#000>edx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dest</span>
        <span style=color:#000>mov</span> <span style=color:#000>ecx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>exchange_value</span>
        <span style=color:#000>mov</span> <span style=color:#000>eax</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>compare_value</span>
        <span style=color:#000>LOCK_IF_MP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mp</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000>cmpxchg</span> <span style=color:#000>dword</span> <span style=color:#000>ptr</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>edx</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>ecx</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Adding a lock prefix to an instruction on MP machine
</span><span style=color:#8f5902;font-style:italic>// VC++ doesn&#39;t like the lock prefix to be on a single line
</span><span style=color:#8f5902;font-style:italic>// so we can&#39;t insert a label after the lock prefix.
</span><span style=color:#8f5902;font-style:italic>// By emitting a lock prefix, we can define a label after it.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#define LOCK_IF_MP(mp) __asm cmp mp, 0  \
</span><span style=color:#8f5902;font-style:italic>                       __asm je L0      \
</span><span style=color:#8f5902;font-style:italic>                       __asm _emit 0xF0 \
</span><span style=color:#8f5902;font-style:italic>                       __asm L0:
</span></code></pre></div><p>如果是多处理器，为 cmpxchg 指令添加 lock 前缀。反之，就省略 lock 前缀(单处理器会不需要 lock 前缀提供的内存屏障效果)。这里的 lock 前缀就是使用了处理器的总线锁(最新的处理器都使用缓存锁代替总线锁来提高性能)。</p>
<blockquote>
<p><code>cmpxchg(void* ptr, int old, int new)</code>，如果 ptr 和 old 的值一样，则把 new 写到 ptr 内存，否则返回 ptr 的值，整个操作是原子的。在 Intel 平台下，会用 lock cmpxchg 来实现，使用 lock 触发缓存锁，这样另一个线程想访问 ptr 的内存，就会被 block 住。</p>
</blockquote>
<h3 id=unsafe-其他功能>UnSafe 其他功能</h3>
<p>Unsafe 提供了硬件级别的操作，比如说获取某个属性在内存中的位置，比如说修改对象的字段值，即使它是私有的。不过 Java 本身就是为了屏蔽底层的差异，对于一般的开发而言也很少会有这样的需求。</p>
<p>举两个例子，比方说：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>staticFieldOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Field</span> <span style=color:#000>paramField</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>这个方法可以用来获取给定的 paramField 的内存地址偏移量，这个值对于给定的 field 是唯一的且是固定不变的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arrayBaseOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span> <span style=color:#000>paramClass</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arrayIndexScale</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Class</span> <span style=color:#000>paramClass</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>前一个方法是用来获取数组第一个元素的偏移地址，后一个方法是用来获取数组的转换因子即数组中元素的增量地址的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>allocateMemory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>reallocateMemory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong2</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>freeMemory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>paramLong</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>分别用来分配内存，扩充内存和释放内存的。</p>
<h2 id=atomicinteger>AtomicInteger</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#a40000>：</span><span style=color:#000>获取当前的值</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newValue</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#a40000>：</span><span style=color:#000>获取当前的值</span><span style=color:#a40000>，</span><span style=color:#000>并设置新的值</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndIncrement</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#a40000>：</span><span style=color:#000>获取当前的值</span><span style=color:#a40000>，</span><span style=color:#000>并自增</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndDecrement</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#a40000>：</span><span style=color:#000>获取当前的值</span><span style=color:#a40000>，</span><span style=color:#000>并自减</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndAdd</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delta</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#a40000>：</span><span style=color:#000>获取当前的值</span><span style=color:#a40000>，</span><span style=color:#000>并加上预期的值</span>
<span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>lazySet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newValue</span><span style=color:#ce5c00;font-weight:700>):</span> <span style=color:#000>最终会设置成newValue</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>使用lazySet设置值后</span><span style=color:#a40000>，</span><span style=color:#000>可能导致其他线程在之后的一小段时间内还是可以读到旧的值</span><span style=color:#a40000>。</span>
</code></pre></div><h3 id=源码解析>源码解析</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AtomicInteger</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Number</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Unsafe</span> <span style=color:#000>unsafe</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>valueOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//用于获取value字段相对当前对象的“起始地址”的偏移量
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>valueOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;value&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>//返回当前值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//递增加detla
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getAndAdd</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>delta</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//三个参数，1、当前的实例 2、value实例变量的偏移量 3、当前value要加上的数(value+delta)。
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndAddInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>valueOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delta</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//递增加1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>incrementAndGet</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndAddInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>valueOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>AtomicInteger 底层用的是volatile的变量和CAS来进行更改数据的：</p>
<ul>
<li>volatile 保证线程的可见性，多线程并发时，一个线程修改数据，可以保证其它线程立马看到修改后的值</li>
<li>CAS 保证数据更新的原子性</li>
</ul>
<h2 id=所有原子类>所有原子类</h2>
<h3 id=原子基本类型>原子基本类型</h3>
<p>使用原子的方式更新基本类型，Atomic 包共有 3 个类：</p>
<ul>
<li>AtomicBoolean</li>
<li>AtomicInteger</li>
<li>AtomicLong</li>
</ul>
<h3 id=原子数组>原子数组</h3>
<p>通过原子的方式更新数组里的某个元素，Atomic 包提供了以下的 4 个类：</p>
<ul>
<li>AtomicIntegerArray</li>
<li>AtomicLongArray</li>
<li>AtomicReferenceArray</li>
</ul>
<p>常用方法：</p>
<ul>
<li><code>get(int index)</code></li>
<li><code>compareAndSet(int i, E expect, E update)</code></li>
</ul>
<h3 id=原子引用>原子引用</h3>
<ul>
<li>AtomicReference: 原子更新引用类型。</li>
<li>AtomicStampedReference: 原子更新引用类型, 内部使用Pair来存储元素值及其版本号。</li>
<li>AtomicMarkableReferce: 原子更新带有标记位的引用类型。</li>
</ul>
<p>都是基于 UnSafe 实现，但 AtomicReferenceFieldUpdater 所更新的字段必须使用 volatile 修饰。</p>
<h3 id=原子字段更新>原子字段更新</h3>
<ul>
<li>
<p>AtomicIntegerFieldUpdater: 原子更新整型的字段的更新器。</p>
</li>
<li>
<p>AtomicLongFieldUpdater: 原子更新长整型字段的更新器。</p>
</li>
<li>
<p>AtomicStampedFieldUpdater: 原子更新带有版本号的引用类型。</p>
</li>
<li>
<p>AtomicReferenceFieldUpdater: 上面已经说过此处不在赘述。</p>
</li>
</ul>
<p>以上均为基于反射的原子更新字段的值，要想原子地更新字段类需要两步:</p>
<ul>
<li>第一步，因为原子更新字段类都是抽象类，每次使用的时候必须使用静态方法newUpdater()创建一个更新器，并且需要设置想要更新的类和属性。</li>
<li>第二步，更新类的字段必须使用public volatile修饰。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TestAtomicIntegerFieldUpdater</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#000>TestAtomicIntegerFieldUpdater</span> <span style=color:#000>tIA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TestAtomicIntegerFieldUpdater</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>tIA</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doIt</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AtomicIntegerFieldUpdater</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DataDemo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>updater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>AtomicIntegerFieldUpdater</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newUpdater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DataDemo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doIt</span><span style=color:#ce5c00;font-weight:700>(){</span>
        <span style=color:#000>DataDemo</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataDemo</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;publicVar = &#34;</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#000>updater</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;publicVar&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getAndAdd</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DataDemo</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>publicVar</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>protectedVar</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span>  <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>privateVar</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>staticVar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//public  final int finalVar = 11;
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Integer</span> <span style=color:#000>integerVar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>19</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Long</span> <span style=color:#000>longVar</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>18L</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>AtomicIntegerFieldUpdater 应用约束：</p>
<ul>
<li>字段必须是 volatile 类型的，在线程之间共享变量时保证立即可见。</li>
<li>字段的描述类型(修饰符public/protected/default/private)是与调用者与操作对象字段的关系一致。
<ul>
<li>也就是说调用者能够直接操作对象字段，那么就可以反射进行原子操作。但是对于父类的字段，子类是不能直接操作的，尽管子类可以访问父类的字段。</li>
</ul>
</li>
<li>只能是实例变量，不能是类变量，也就是说不能加 static 关键字。</li>
<li>只能是可修改变量，不能使 final 变量，因为 final 的语义就是不可修改。
<ul>
<li>实际上 final 的语义和 volatile 是有冲突的，这两个关键字不能同时存在。</li>
</ul>
</li>
<li>对于 AtomicIntegerFieldUpdater 和 AtomicLongFieldUpdater 只能修改 int/long 类型的字段，不能修改其包装类型(Integer/Long)。
<ul>
<li>如果要修改包装类型就需要使用 AtomicReferenceFieldUpdater。</li>
</ul>
</li>
</ul>
<h2 id=atomicstampedreference-与-aba>AtomicStampedReference 与 ABA</h2>
<p>AtomicStampedReference 主要维护包含一个对象引用以及一个可以自动更新的整数 &ldquo;stamp&rdquo; 的 pair 对象来解决 ABA 问题。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AtomicStampedReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//维护对象引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>stamp</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//用于标志版本
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>stamp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reference</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stamp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>stamp</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>stamp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>reference</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stamp</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pair</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>....</span>
    
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>      * expectedReference ：更新之前的原始值
</span><span style=color:#8f5902;font-style:italic>      * newReference : 将要更新的新值
</span><span style=color:#8f5902;font-style:italic>      * expectedStamp : 期待更新的标志版本
</span><span style=color:#8f5902;font-style:italic>      * newStamp : 将要更新的标志版本
</span><span style=color:#8f5902;font-style:italic>      */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span> <span style=color:#000>expectedReference</span><span style=color:#ce5c00;font-weight:700>,</span>
                             <span style=color:#000>V</span>   <span style=color:#000>newReference</span><span style=color:#ce5c00;font-weight:700>,</span>
                             <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expectedStamp</span><span style=color:#ce5c00;font-weight:700>,</span>
                             <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newStamp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取当前的(元素值，版本号)对
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pair</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span>
            <span style=color:#8f5902;font-style:italic>// 引用没变
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expectedReference</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reference</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#8f5902;font-style:italic>// 版本号没变
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>expectedStamp</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stamp</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#8f5902;font-style:italic>// 新引用等于旧引用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>newReference</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reference</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#8f5902;font-style:italic>// 新版本号等于旧版本号
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>newStamp</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stamp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#8f5902;font-style:italic>// 构造新的Pair对象并CAS更新
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>casPair</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>of</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newReference</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newStamp</span><span style=color:#ce5c00;font-weight:700>)));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>casPair</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cmp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 调用Unsafe的compareAndSwapObject()方法CAS更新pair的引用为新引用
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pairOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cmp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>如果元素值和版本号都没有变化，并且和新的也相同，返回true；</li>
<li>如果元素值和版本号都没有变化，并且和新的不完全相同，就构造一个新的Pair对象并执行CAS更新pair。</li>
</ul>
<p>可以看到，java中的实现跟我们上面讲的ABA的解决方法是一致的。</p>
<ul>
<li>首先，使用版本号控制；</li>
<li>其次，不重复使用节点(Pair)的引用，每次都新建一个新的Pair来作为CAS比较的对象，而不是复用旧的；</li>
<li>最后，外部传入元素值及版本号，而不是节点(Pair)的引用。</li>
</ul>
<h3 id=atomicmarkablereference>AtomicMarkableReference</h3>
<p>AtomicMarkableReference，它不是维护一个版本号，而是维护一个boolean类型的标记，标记值有修改。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-80db2b14f8c02e7be596869ece7d2a75>3.10 - CH10-LockSupport</h1>
<h2 id=功能介绍>功能介绍</h2>
<p>LockSupport 是用来创建锁和其他同步类的基本<strong>线程阻塞原语</strong>。</p>
<ul>
<li>当调用 LockSupport.park 时，当前线程会等待直至获取许可；</li>
<li>当调用 LockSupport.unpack 时，必须把扥带获取许可的线程作为参数传递，以使其恢复运行。</li>
</ul>
<h2 id=源码分析>源码分析</h2>
<h3 id=基本属性>基本属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LockSupport</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Hotspot implementation via intrinsics API
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 表示内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>parkBlockerOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 表示内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>SEED</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 表示内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>PROBE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 表示内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>SECONDARY</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取Unsafe实例
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>UNSAFE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 线程类类型
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>tk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 获取Thread的parkBlocker字段的内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>parkBlockerOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;parkBlocker&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 获取Thread的threadLocalRandomSeed字段的内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SEED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;threadLocalRandomSeed&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 获取Thread的threadLocalRandomProbe字段的内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>PROBE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;threadLocalRandomProbe&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>// 获取Thread的threadLocalRandomSecondarySeed字段的内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SECONDARY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;threadLocalRandomSecondarySeed&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=构造函数>构造函数</h3>
<p>仅有一个私有构造函数，无法被实例化。</p>
<h3 id=核心函数>核心函数</h3>
<p>LockSupport的核心函数都是基于Unsafe类中定义的park和unpark函数，下面给出两个函数的定义:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAbsolute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>native</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><ul>
<li>park 函数：阻塞线程，该线程在下列情况发生之前都会被阻塞：
<ul>
<li>调用 unpark 函数，释放该线程的许可。</li>
<li>该线程被中断。</li>
<li>设置的时间到期，如果 time 为 0 则表示无限等待。</li>
</ul>
</li>
<li>unpark 函数：释放线程的许可，使调用 park 的线程恢复执行。调用时要确保线性仍然活着。</li>
</ul>
<h4 id=park>park</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>park</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#a40000>；</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>blocker</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#a40000>；</span>

<span style=color:#8f5902;font-style:italic>// 第二个函数的实现
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>blocker</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置Blocker
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setBlocker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>blocker</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 重新可运行后再此设置Blocker
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setBlocker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调用 park 函数时，首先获取当前线程，然后设置当前线程的 parkBlocker 字段，即调用 setBlocker 方法，之后调用 UnSafe.park，之后再调用 setBlocker 方法。</p>
<p>调用 park 函数式，当前线程首先设置好 parkBlocker 字段，然后调用 UnSafe.park，此后，当前线程就阻塞了，开始等待该线程的 unpark 函数被调用，所以后面的一个 setBlocker 函数无法执行；unpack 函数被调用后，该线程获得许可，就可以接着执行第二个 setBlocker，把该线程的 parkBlocker 设为 null，即完成了整个 park 函数的逻辑。</p>
<p>如果没有第二个 setBlocker，那么之后没有调用 park(blocker)，而直接调用 getBlocker 函数时，会得到原来设置的 blocker，显然不符合逻辑。总之，必须要保证 park 执行完成之后，blocker 被设为 null。</p>
<p>说明: 调用了park函数后，会禁用当前线程，除非许可可用。在以下三种情况之一发生之前，当前线程都将处于休眠状态，即下列情况发生时，当前线程会获取许可，可以继续运行。</p>
<ul>
<li>其他某个线程将当前线程作为目标调用 unpark。</li>
<li>其他某个线程中断当前线程。</li>
<li>该调用不合逻辑地(即毫无理由地)返回。</li>
</ul>
<h4 id=parknanos>parkNanos</h4>
<p>此函数表示在许可可用前禁用当前线程，并最多等待指定的等待时间。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parkNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>blocker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 时间大于0
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 获取当前线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 设置Blocker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>setBlocker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>blocker</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 获取许可，并设置了时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 设置许可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>setBlocker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=parkuntil>parkUntil</h4>
<p>此函数表示在指定的时限前禁用当前线程，除非许可可用, 具体函数如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>parkUntil</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>blocker</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置Blocker
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setBlocker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>blocker</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置Blocker为null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setBlocker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=unpark>unpark</h4>
<p>此函数表示如果给定线程的许可尚不可用，则使其可用。如果线程在 park 上受阻塞，则它将解除其阻塞状态。否则，保证下一次调用 park 不会受阻塞。如果给定线程尚未启动，则无法保证此操作有任何效果。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 线程为不空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 释放该线程许可
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=应用示例>应用示例</h2>
<h3 id=使用waitnotify实现线程同步>使用wait/notify实现线程同步</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before notify&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>            
            <span style=color:#000>notify</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after notify&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>    
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitAndNotifyDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>myThread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>();</span>            
        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myThread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>        
                <span style=color:#000>myThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 主线程睡眠3s
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before wait&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 阻塞主线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>myThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wait</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after wait&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>            
        <span style=color:#ce5c00;font-weight:700>}</span>        
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>before</span> <span style=color:#000>wait</span>
<span style=color:#000>before</span> <span style=color:#000>notify</span>
<span style=color:#000>after</span> <span style=color:#000>notify</span>
<span style=color:#000>after</span> <span style=color:#000>wait</span>
</code></pre></div><div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426011314.png style=display:block;width:50% alt=NAME align=center> </div>
<p>使用wait/notify实现同步时，必须先调用wait，后调用notify，如果先调用notify，再调用wait，将起不了作用。</p>
<h3 id=使用parkunpark实现线程同步>使用park/unpark实现线程同步</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.LockSupport</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before unpark&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 获取blocker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Blocker info &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBlocker</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#8f5902;font-style:italic>// 释放许可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 休眠500ms，保证先执行park中的setBlocker(t, null);
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 再次获取blocker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Blocker info &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBlocker</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>));</span>

        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after unpark&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>myThread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>myThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before park&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ParkAndUnparkDemo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after park&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>before</span> <span style=color:#000>park</span>
<span style=color:#000>before</span> <span style=color:#000>unpark</span>
<span style=color:#000>Blocker</span> <span style=color:#000>info</span> <span style=color:#000>ParkAndUnparkDemo</span>
<span style=color:#000>after</span> <span style=color:#000>park</span>
<span style=color:#000>Blocker</span> <span style=color:#000>info</span> <span style=color:#204a87;font-weight:700>null</span>
<span style=color:#000>after</span> <span style=color:#000>unpark</span>
</code></pre></div><p>本程序先执行park，然后在执行unpark，进行同步，并且在unpark的前后都调用了getBlocker，可以看到两次的结果不一样，并且第二次调用的结果为null，这是因为在调用unpark之后，执行了Lock.park(Object blocker)函数中的setBlocker(t, null)函数，所以第二次调用getBlocker时为null。</p>
<h3 id=中断响应>中断响应</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.LockSupport</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>object</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before interrupt&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>        
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 休眠3s
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>    
        <span style=color:#000>Thread</span> <span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>object</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 中断线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after interrupt&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InterruptDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>myThread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>myThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;before park&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ParkAndUnparkDemo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;after park&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>before</span> <span style=color:#000>park</span>
<span style=color:#000>before</span> <span style=color:#000>interrupt</span>
<span style=color:#000>after</span> <span style=color:#000>interrupt</span>
<span style=color:#000>after</span> <span style=color:#000>park</span>
</code></pre></div><p>可以看到，在主线程调用park阻塞后，在myThread线程中发出了中断信号，此时主线程会继续运行，也就是说明此时interrupt起到的作用与unpark一样。</p>
<h2 id=深入理解>深入理解</h2>
<h3 id=threadsleep-和-objectwait-的区别>Thread.sleep() 和 Object.wait() 的区别</h3>
<ul>
<li>Thread.sleep()不会释放占有的锁，Object.wait()会释放占有的锁；</li>
<li>Thread.sleep()必须传入时间，Object.wait()可传可不传，不传表示一直阻塞下去；</li>
<li>Thread.sleep()到时间了会自动唤醒，然后继续执行；</li>
<li>Object.wait()不带时间的，需要另一个线程使用Object.notify()唤醒；</li>
<li>Object.wait()带时间的，假如没有被notify，到时间了会自动唤醒，这时又分好两种情况：
<ul>
<li>一是立即获取到了锁，线程自然会继续执行；</li>
<li>二是没有立即获取锁，线程进入同步队列等待获取锁；</li>
</ul>
</li>
</ul>
<p>他们俩最大的区别就是Thread.sleep()不会释放锁资源，Object.wait()会释放锁资源。</p>
<h3 id=objectwait-和-conditionawait-的区别>Object.wait() 和 Condition.await() 的区别</h3>
<p>Object.wait()和Condition.await()的原理是基本一致的，不同的是Condition.await()底层是调用LockSupport.park()来实现阻塞当前线程的。</p>
<p>实际上，它在阻塞当前线程之前还干了两件事，一是把当前线程添加到条件队列中，二是“完全”释放锁，也就是让state状态变量变为0，然后才是调用LockSupport.park()阻塞当前线程。</p>
<h3 id=threadsleep和locksupportpark的区别>Thread.sleep()和LockSupport.park()的区别</h3>
<p>LockSupport.park()还有几个兄弟方法——parkNanos()、parkUtil()等，我们这里说的park()方法统称这一类方法。</p>
<ul>
<li>从功能上来说，Thread.sleep()和LockSupport.park()方法类似，都是阻塞当前线程的执行，且都不会释放当前线程占有的锁资源；</li>
<li>Thread.sleep()没法从外部唤醒，只能自己醒过来；</li>
<li>LockSupport.park()方法可以被另一个线程调用LockSupport.unpark()方法唤醒；</li>
<li>Thread.sleep()方法声明上抛出了InterruptedException中断异常，所以调用者需要捕获这个异常或者再抛出；</li>
<li>LockSupport.park()方法不需要捕获中断异常；</li>
<li>Thread.sleep()本身就是一个native方法；</li>
<li>LockSupport.park()底层是调用的Unsafe的native方法；</li>
</ul>
<h3 id=objectwait和locksupportpark的区别>Object.wait()和LockSupport.park()的区别</h3>
<p>二者都会阻塞当前线程的运行：</p>
<ul>
<li>Object.wait()方法需要在synchronized块中执行；</li>
<li>LockSupport.park()可以在任意地方执行；</li>
<li>Object.wait()方法声明抛出了中断异常，调用者需要捕获或者再抛出；</li>
<li>LockSupport.park()不需要捕获中断异常；</li>
<li>Object.wait()不带超时的，需要另一个线程执行notify()来唤醒，但不一定继续执行后续内容；</li>
<li>LockSupport.park()不带超时的，需要另一个线程执行unpark()来唤醒，一定会继续执行后续内容；</li>
<li>如果在wait()之前执行了notify()会怎样? 抛出IllegalMonitorStateException异常；</li>
<li>如果在park()之前执行了unpark()会怎样? 线程不会被阻塞，直接跳过park()，继续执行后续内容；</li>
</ul>
<p>park()/unpark()底层的原理是“二元信号量”，你可以把它相像成只有一个许可证的Semaphore，只不过这个信号量在重复执行unpark()的时候也不会再增加许可证，最多只有一个许可证。</p>
<h3 id=locksupportpark会释放锁资源吗>LockSupport.park()会释放锁资源吗?</h3>
<p>不会，它只负责阻塞当前线程，释放锁资源实际上是在Condition的await()方法中实现的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8409cde600ff510299cf0be846fd86ee>3.11 - CH11-AQS-1</h1>
<h2 id=abstractqueuedsynchronizer>AbstractQueuedSynchronizer</h2>
<p>AQS 是一个用来构建锁和同步器的框架，使用 AQS 能够简单高效的构造出应用广泛的同步器，比如 ReentrantLock、Semaphore，其他诸如 ReentrantReadWriteLock、SynchronousQueue、FutureTask 等也是基于 AQS 实现的。我们自己也可以基于 AQS 构造满足自己需要的同步器。</p>
<h3 id=核心思想>核心思想</h3>
<ul>
<li>如果被请求的共享资源空闲，则将当前请求资源的线程设置为有效的工作线程，并且将共享资源设置为锁定状态。</li>
<li>如果被请求的共享资源被占用，那么就需要一套线程阻塞等待以及被唤醒时锁分配的机制。
<ul>
<li>AQS 使用 CLH 队列锁实现了该机制，将暂时获取不到锁的线程加入到队列中。</li>
<li>AQS 使用一个 int 成员变量表示同步状态，通过内置的 FIFO 队列来完成获取资源线程的排队工作。</li>
<li>AQS 使用 CAS 对该同步状态执行原子操作以实现值的修改，并使用 volatile 保证该状态的可见性。</li>
</ul>
</li>
</ul>
<blockquote>
<p>CLH(Craig,Landin,and Hagersten) 队列是一个虚拟的双向队列(即不存在队列实例、仅存在结点之间的关联关系)。AQS是将每条请求共享资源的线程封装成一个 CLH 锁队列的一个结点(Node)来实现锁的分配。</p>
</blockquote>
<p>状态信息通过 protected 范围的方法执行操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//返回同步状态的当前值
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
 <span style=color:#8f5902;font-style:italic>// 设置同步状态的值
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newState</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//原子地(CAS操作)将同步状态值设置为给定值update如果当前同步状态的值等于expect(期望值)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expect</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>expect</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=资源共享方式>资源共享方式</h3>
<ul>
<li>独占(Exclusive)：只有一个线程能够执行，如 ReentrantLock。又可以分为公平锁和非公平锁：
<ul>
<li>公平锁：按照线程在队列中的排队顺序，先到者先获得锁。</li>
<li>非公平锁：当线程要获得锁时，无视队列顺序直接抢锁，谁抢到随获取。</li>
</ul>
</li>
<li>共享(Share)：多个线程可以同时执行，如 Semaphore、CountDownLatch。</li>
</ul>
<p>而 ReentrantReadWriteLock 可以看做是对以上两种方式的组合，因为它允许多个线程同时对一个资源执行读，但仅能有一个线程执行写。</p>
<p>不同的自定义同步器争用共享资源的方式不同。自定义同步器在实现时只需要实现共享资源 state 的获取与释放方式即可，至于具体线程等待队列的维护(如获取资源失败后入队/唤醒出队等)，AQS 已经在上层实现了。</p>
<h3 id=aqs-底层使用的模板方法模式>AQS 底层使用的模板方法模式</h3>
<p>同步器的设计基于模板方法模式，自定义同步器时继承 AQS 并重写指定的方法即可：</p>
<ul>
<li>isHeldExclusively：判断线程是否正在独占资源，只有用到 condition 才需要实现。</li>
<li>tryAcquire(int)：独占获取资源，成功失败返回 ture、false。</li>
<li>tryRelease(int)：独占释放资源，成功失败返回 true、false。</li>
<li>tryAcquireShared(int)：共享获取资源，失败为负，为 0 表示成功但没有剩余可用资源，为正表示成且有可用资源。</li>
<li>tryReleaseShared(int)：共享释放资源，成功失败返回 true、false。</li>
</ul>
<p>相关细节：</p>
<ul>
<li>默认情况下，每个方法都能抛出 UnsupportedException。</li>
<li>所有方法的实现必须是内部线程安全的，并且应该简短且不阻塞。</li>
<li>其他方法均为 final，所以仅有以上方法可以被其他类使用。</li>
</ul>
<p>以 ReentrantLock 为例：</p>
<ul>
<li>初始状态 state 为 0，表示未锁定状态。</li>
<li>A 线程 lock 时，会调用 tryAcquire 独占锁定并将 state+1。</li>
<li>此后其他线程再 tryAcquire 时会失败，直到 A 线程 unlock 并将 state=0(释放锁)为止。</li>
<li>在 A 线程释放锁之前，A 线程可以重复获取此锁(state 累加)，即可重入。
<ul>
<li>获取多次就要释放多次，直至 state 为 0 才表示释放锁。</li>
</ul>
</li>
</ul>
<h2 id=数据结构>数据结构</h2>
<ul>
<li>AQS 底层使用 CLH，将每条请求共享资源的线程封装为 CLH 队列的一个节点。</li>
<li>其中同步队列 Sync Queue 为双向链表，包括 head 和 tail 节点，head 节点主要用作后续的调度。</li>
<li>其中 Condition Queue 不是必须，是一个单向链表，只有使用 Condition 时，才会使用该队列。
<ul>
<li>并且可能会有多个 Condition Queue。</li>
</ul>
</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-juc-aqs-1.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=源码分析>源码分析</h2>
<h3 id=层级结构>层级结构</h3>
<p>AQS 继承抽象类 AbstractOwnableSynchronizer，实现了 Serializable 接口，支持序列化。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractOwnableSynchronizer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>// 版本序列号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3737899427754241961L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 构造方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>AbstractOwnableSynchronizer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 独占模式下的线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Thread</span> <span style=color:#000>exclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 设置独占线程 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>exclusiveOwnerThread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取独占线程 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Thread</span> <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>exclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>其中可以“设置独占资源线程”和“获取独占资源线程”，分别为 setExclusiveOwnerThread 与 getExclusiveOwnerThread 方法，这两个方法会被子类调用。</li>
<li>其中有两个内部类，Node、ConditionObject。</li>
</ul>
<h3 id=内部类node>内部类：Node</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 模式，分为共享与独占
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 共享模式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>SHARED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 独占模式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>EXCLUSIVE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>        
    <span style=color:#8f5902;font-style:italic>// 结点状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// CANCELLED，值为1，表示当前的线程被取消
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// SIGNAL，值为-1，表示当前节点的后继节点包含的线程需要运行，也就是unpark
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// CONDITION，值为-2，表示当前节点在等待condition，也就是在condition队列中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// PROPAGATE，值为-3，表示当前场景下后续的acquireShared能够得以执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 值为0，表示当前节点在sync队列中，等待着获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CANCELLED</span> <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SIGNAL</span>    <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CONDITION</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>PROPAGATE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>        

    <span style=color:#8f5902;font-style:italic>// 结点状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>waitStatus</span><span style=color:#ce5c00;font-weight:700>;</span>        
    <span style=color:#8f5902;font-style:italic>// 前驱结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>// 后继结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>        
    <span style=color:#8f5902;font-style:italic>// 结点所对应的线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>        
    <span style=color:#8f5902;font-style:italic>// 下一个等待者
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 结点是否在共享模式下等待
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isShared</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SHARED</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取前驱结点，若前驱结点为空，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>predecessor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>NullPointerException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存前驱结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 前驱结点为空，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#8f5902;font-style:italic>// 前驱结点不为空，返回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 无参构造方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#8f5902;font-style:italic>// Used to establish initial head or SHARED marker
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#8f5902;font-style:italic>// Used by addWaiter
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>waitStatus</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Used by Condition
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waitStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>每个被阻塞的线程都会被封装为一个 Node 节点并放入队列。</li>
<li>每个节点包含了一个 Thread 类型的引用，并且每个节点都有一个状态，状态如下：
<ul>
<li>CANCELLED：1，当前线程被取消。</li>
<li>SIGNAL：-1，当前节点的后继节点中的线程需要运行，需要进行 unpark 操作。</li>
<li>CONDITION：-2，当前节点在等待 condition，即 condition queue 中。</li>
<li>PROPAGATE：-3，当前场景下后续的 acquireSHared 能够得以执行。</li>
<li>0：当前节点在 sync queue 中，等待获取锁。</li>
</ul>
</li>
</ul>
<h3 id=内部类conditionobject>内部类：ConditionObject</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 内部类
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConditionObject</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Condition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1173984872572414699L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/** First node of condition queue. */</span>
    <span style=color:#8f5902;font-style:italic>// condition队列的头结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Node</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/** Last node of condition queue. */</span>
    <span style=color:#8f5902;font-style:italic>// condition队列的尾结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Node</span> <span style=color:#000>lastWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Creates a new {@code ConditionObject} instance.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 构造方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConditionObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// Internal methods
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Adds a new waiter to wait queue.
</span><span style=color:#8f5902;font-style:italic>        * @return its new wait node
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 添加新的waiter到wait队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Node</span> <span style=color:#000>addConditionWaiter</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存尾结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// If lastWaiter is cancelled, clean out.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONDITION</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 尾结点不为空，并且尾结点的状态不为CONDITION
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 清除状态为CONDITION的结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>unlinkCancelledWaiters</span><span style=color:#ce5c00;font-weight:700>();</span> 
            <span style=color:#8f5902;font-style:italic>// 将最后一个结点重新赋值给t
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 新建一个结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONDITION</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 尾结点为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 设置condition队列的头结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>firstWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#8f5902;font-style:italic>// 尾结点不为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 设置为节点的nextWaiter域为node结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 更新condition队列的尾结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>lastWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Removes and transfers nodes until hit non-cancelled one or
</span><span style=color:#8f5902;font-style:italic>        * null. Split out from signal in part to encourage compilers
</span><span style=color:#8f5902;font-style:italic>        * to inline the case of no waiters.
</span><span style=color:#8f5902;font-style:italic>        * @param first (non-null) the first node on condition queue
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doSignal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 该节点的nextWaiter为空
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置尾结点为空
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>lastWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 设置first结点的nextWaiter域
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>transferForSignal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 将结点从condition队列转移到sync队列失败并且condition队列中的头结点不为空，一直循环
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Removes and transfers all nodes.
</span><span style=color:#8f5902;font-style:italic>        * @param first (non-null) the first node on condition queue
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doSignalAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// condition队列的头结点尾结点都设置为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>lastWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取first结点的nextWaiter域结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Node</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 设置first结点的nextWaiter域为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 将first结点从condition队列转移到sync队列
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>transferForSignal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 重新设置first
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Unlinks cancelled waiter nodes from condition queue.
</span><span style=color:#8f5902;font-style:italic>        * Called only while holding lock. This is called when
</span><span style=color:#8f5902;font-style:italic>        * cancellation occurred during condition wait, and upon
</span><span style=color:#8f5902;font-style:italic>        * insertion of a new waiter when lastWaiter is seen to have
</span><span style=color:#8f5902;font-style:italic>        * been cancelled. This method is needed to avoid garbage
</span><span style=color:#8f5902;font-style:italic>        * retention in the absence of signals. So even though it may
</span><span style=color:#8f5902;font-style:italic>        * require a full traversal, it comes into play only when
</span><span style=color:#8f5902;font-style:italic>        * timeouts or cancellations occur in the absence of
</span><span style=color:#8f5902;font-style:italic>        * signals. It traverses all nodes rather than stopping at a
</span><span style=color:#8f5902;font-style:italic>        * particular target to unlink all pointers to garbage nodes
</span><span style=color:#8f5902;font-style:italic>        * without requiring many re-traversals during cancellation
</span><span style=color:#8f5902;font-style:italic>        * storms.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 从condition队列中清除状态为CANCEL的结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>unlinkCancelledWaiters</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存condition队列头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Node</span> <span style=color:#000>trail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// t不为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 下一个结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Node</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONDITION</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// t结点的状态不为CONDTION状态
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置t节点的额nextWaiter域为空
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trail</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// trail为空
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 重新设置condition队列的头结点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>firstWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#8f5902;font-style:italic>// trail不为空
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 设置trail结点的nextWaiter域为next结点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>trail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// next结点为空
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 设置condition队列的尾结点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>lastWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>trail</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#8f5902;font-style:italic>// t结点的状态为CONDTION状态
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置trail结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>trail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 设置t结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// public methods
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Moves the longest-waiting thread, if one exists, from the
</span><span style=color:#8f5902;font-style:italic>        * wait queue for this condition to the wait queue for the
</span><span style=color:#8f5902;font-style:italic>        * owning lock.
</span><span style=color:#8f5902;font-style:italic>        *
</span><span style=color:#8f5902;font-style:italic>        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}
</span><span style=color:#8f5902;font-style:italic>        *         returns {@code false}
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 唤醒一个等待线程。如果所有的线程都在等待此条件，则选择其中的一个唤醒。在从 await 返回之前，该线程必须重新获取锁。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>signal</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 不被当前线程独占，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 保存condition队列头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 头结点不为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 唤醒一个等待线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>doSignal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Moves all threads from the wait queue for this condition to
</span><span style=color:#8f5902;font-style:italic>        * the wait queue for the owning lock.
</span><span style=color:#8f5902;font-style:italic>        *
</span><span style=color:#8f5902;font-style:italic>        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}
</span><span style=color:#8f5902;font-style:italic>        *         returns {@code false}
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 唤醒所有等待线程。如果所有的线程都在等待此条件，则唤醒所有线程。在从 await 返回之前，每个线程都必须重新获取锁。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>signalAll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 不被当前线程独占，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 保存condition队列头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 头结点不为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 唤醒所有等待线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>doSignalAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Implements uninterruptible condition wait.
</span><span style=color:#8f5902;font-style:italic>        * &lt;ol&gt;
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Save lock state returned by {@link #getState}.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Invoke {@link #release} with saved state as argument,
</span><span style=color:#8f5902;font-style:italic>        *      throwing IllegalMonitorStateException if it fails.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Block until signalled.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Reacquire by invoking specialized version of
</span><span style=color:#8f5902;font-style:italic>        *      {@link #acquire} with saved state as argument.
</span><span style=color:#8f5902;font-style:italic>        * &lt;/ol&gt;
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号之前一直处于等待状态，不响应中断
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>awaitUninterruptibly</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 添加一个结点到等待队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>addConditionWaiter</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取释放的状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>savedState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullyRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isOnSyncQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 阻塞当前线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 当前线程被中断
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置interrupted状态
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquireQueued</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>savedState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>interrupted</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>selfInterrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * For interruptible waits, we need to track whether to throw
</span><span style=color:#8f5902;font-style:italic>        * InterruptedException, if interrupted while blocked on
</span><span style=color:#8f5902;font-style:italic>        * condition, versus reinterrupt current thread, if
</span><span style=color:#8f5902;font-style:italic>        * interrupted while blocked waiting to re-acquire.
</span><span style=color:#8f5902;font-style:italic>        */</span>

    <span style=color:#8f5902;font-style:italic>/** Mode meaning to reinterrupt on exit from wait */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>REINTERRUPT</span> <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/** Mode meaning to throw InterruptedException on exit from wait */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>THROW_IE</span>    <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Checks for interrupt, returning THROW_IE if interrupted
</span><span style=color:#8f5902;font-style:italic>        * before signalled, REINTERRUPT if after signalled, or
</span><span style=color:#8f5902;font-style:italic>        * 0 if not interrupted.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>checkInterruptWhileWaiting</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transferAfterCancelledWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>THROW_IE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>REINTERRUPT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
            <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Throws InterruptedException, reinterrupts current thread, or
</span><span style=color:#8f5902;font-style:italic>        * does nothing, depending on mode.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reportInterruptAfterWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>interruptMode</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>THROW_IE</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>REINTERRUPT</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>selfInterrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Implements interruptible condition wait.
</span><span style=color:#8f5902;font-style:italic>        * &lt;ol&gt;
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If current thread is interrupted, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Save lock state returned by {@link #getState}.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Invoke {@link #release} with saved state as argument,
</span><span style=color:#8f5902;font-style:italic>        *      throwing IllegalMonitorStateException if it fails.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Block until signalled or interrupted.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Reacquire by invoking specialized version of
</span><span style=color:#8f5902;font-style:italic>        *      {@link #acquire} with saved state as argument.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;/ol&gt;
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// // 等待，当前线程在接到信号或被中断之前一直处于等待状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 当前线程被中断，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 在wait队列上添加一个结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>addConditionWaiter</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>savedState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullyRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isOnSyncQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 阻塞当前线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkInterruptWhileWaiting</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 检查结点等待时的中断类型
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquireQueued</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>savedState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>THROW_IE</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>REINTERRUPT</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// clean up if cancelled
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>unlinkCancelledWaiters</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>reportInterruptAfterWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Implements timed condition wait.
</span><span style=color:#8f5902;font-style:italic>        * &lt;ol&gt;
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If current thread is interrupted, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Save lock state returned by {@link #getState}.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Invoke {@link #release} with saved state as argument,
</span><span style=color:#8f5902;font-style:italic>        *      throwing IllegalMonitorStateException if it fails.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Block until signalled, interrupted, or timed out.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Reacquire by invoking specialized version of
</span><span style=color:#8f5902;font-style:italic>        *      {@link #acquire} with saved state as argument.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;/ol&gt;
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>awaitNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nanosTimeout</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>addConditionWaiter</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>savedState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullyRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>nanosTimeout</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isOnSyncQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanosTimeout</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>transferAfterCancelledWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanosTimeout</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>spinForTimeoutThreshold</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parkNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nanosTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkInterruptWhileWaiting</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>nanosTimeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquireQueued</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>savedState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>THROW_IE</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>REINTERRUPT</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>unlinkCancelledWaiters</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>reportInterruptAfterWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Implements absolute timed condition wait.
</span><span style=color:#8f5902;font-style:italic>        * &lt;ol&gt;
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If current thread is interrupted, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Save lock state returned by {@link #getState}.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Invoke {@link #release} with saved state as argument,
</span><span style=color:#8f5902;font-style:italic>        *      throwing IllegalMonitorStateException if it fails.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Block until signalled, interrupted, or timed out.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Reacquire by invoking specialized version of
</span><span style=color:#8f5902;font-style:italic>        *      {@link #acquire} with saved state as argument.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If timed out while blocked in step 4, return false, else true.
</span><span style=color:#8f5902;font-style:italic>        * &lt;/ol&gt;
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号、被中断或到达指定最后期限之前一直处于等待状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>awaitUntil</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>abstime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>addConditionWaiter</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>savedState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullyRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timedout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isOnSyncQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>abstime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>timedout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transferAfterCancelledWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parkUntil</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>abstime</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkInterruptWhileWaiting</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquireQueued</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>savedState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>THROW_IE</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>REINTERRUPT</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>unlinkCancelledWaiters</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>reportInterruptAfterWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>timedout</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Implements timed condition wait.
</span><span style=color:#8f5902;font-style:italic>        * &lt;ol&gt;
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If current thread is interrupted, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Save lock state returned by {@link #getState}.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Invoke {@link #release} with saved state as argument,
</span><span style=color:#8f5902;font-style:italic>        *      throwing IllegalMonitorStateException if it fails.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Block until signalled, interrupted, or timed out.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; Reacquire by invoking specialized version of
</span><span style=color:#8f5902;font-style:italic>        *      {@link #acquire} with saved state as argument.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If interrupted while blocked in step 4, throw InterruptedException.
</span><span style=color:#8f5902;font-style:italic>        * &lt;li&gt; If timed out while blocked in step 4, return false, else true.
</span><span style=color:#8f5902;font-style:italic>        * &lt;/ol&gt;
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态。此方法在行为上等效于: awaitNanos(unit.toNanos(time)) &gt; 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nanosTimeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>addConditionWaiter</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>savedState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fullyRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>nanosTimeout</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timedout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isOnSyncQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanosTimeout</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>timedout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transferAfterCancelledWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanosTimeout</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>spinForTimeoutThreshold</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parkNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nanosTimeout</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkInterruptWhileWaiting</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>nanosTimeout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquireQueued</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>savedState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>THROW_IE</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>REINTERRUPT</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>unlinkCancelledWaiters</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>reportInterruptAfterWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interruptMode</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>timedout</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//  support for instrumentation
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Returns true if this condition was created by the given
</span><span style=color:#8f5902;font-style:italic>        * synchronization object.
</span><span style=color:#8f5902;font-style:italic>        *
</span><span style=color:#8f5902;font-style:italic>        * @return {@code true} if owned
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isOwnedBy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractQueuedSynchronizer</span> <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sync</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>AbstractQueuedSynchronizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>this</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Queries whether any threads are waiting on this condition.
</span><span style=color:#8f5902;font-style:italic>        * Implements {@link AbstractQueuedSynchronizer#hasWaiters(ConditionObject)}.
</span><span style=color:#8f5902;font-style:italic>        *
</span><span style=color:#8f5902;font-style:italic>        * @return {@code true} if there are any waiting threads
</span><span style=color:#8f5902;font-style:italic>        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}
</span><span style=color:#8f5902;font-style:italic>        *         returns {@code false}
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>//  查询是否有正在等待此条件的任何线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasWaiters</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONDITION</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Returns an estimate of the number of threads waiting on
</span><span style=color:#8f5902;font-style:italic>        * this condition.
</span><span style=color:#8f5902;font-style:italic>        * Implements {@link AbstractQueuedSynchronizer#getWaitQueueLength(ConditionObject)}.
</span><span style=color:#8f5902;font-style:italic>        *
</span><span style=color:#8f5902;font-style:italic>        * @return the estimated number of waiting threads
</span><span style=color:#8f5902;font-style:italic>        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}
</span><span style=color:#8f5902;font-style:italic>        *         returns {@code false}
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 返回正在等待此条件的线程数估计值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getWaitQueueLength</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONDITION</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Returns a collection containing those threads that may be
</span><span style=color:#8f5902;font-style:italic>        * waiting on this Condition.
</span><span style=color:#8f5902;font-style:italic>        * Implements {@link AbstractQueuedSynchronizer#getWaitingThreads(ConditionObject)}.
</span><span style=color:#8f5902;font-style:italic>        *
</span><span style=color:#8f5902;font-style:italic>        * @return the collection of threads
</span><span style=color:#8f5902;font-style:italic>        * @throws IllegalMonitorStateException if {@link #isHeldExclusively}
</span><span style=color:#8f5902;font-style:italic>        *         returns {@code false}
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 返回包含那些可能正在等待此条件的线程集合
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getWaitingThreads</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONDITION</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该类实现了 Condition 接口，Condition 接口定义了条件操作的规范：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Condition</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号或被中断之前一直处于等待状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号之前一直处于等待状态，不响应中断
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>awaitUninterruptibly</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>//等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>awaitNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nanosTimeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号、被中断或到达指定等待时间之前一直处于等待状态。此方法在行为上等效于: awaitNanos(unit.toNanos(time)) &gt; 0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 等待，当前线程在接到信号、被中断或到达指定最后期限之前一直处于等待状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>awaitUntil</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 唤醒一个等待线程。如果所有的线程都在等待此条件，则选择其中的一个唤醒。在从 await 返回之前，该线程必须重新获取锁。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>signal</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 唤醒所有等待线程。如果所有的线程都在等待此条件，则唤醒所有线程。在从 await 返回之前，每个线程都必须重新获取锁。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>signalAll</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=类的属性>类的属性</h3>
<p>属性中包含了头结点 head，为节点 tail，状态 state，自旋时间 spinForTimeoutThreshold，以及 AQS 抽象的属性在内存中的便宜地址，通过该便宜地址，可以获取和设置属性的值，同时该包括一个静态初始化块，用于加载内存偏移地址：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractQueuedSynchronizer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractOwnableSynchronizer</span>
    <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>    
    <span style=color:#8f5902;font-style:italic>// 版本号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>7373984972572414691L</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>// 头结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>// 尾结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>// 状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>// 自旋时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>spinForTimeoutThreshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1000L</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// Unsafe类实例
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Unsafe</span> <span style=color:#000>unsafe</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// state内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// head内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>headOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// state内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tailOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// tail内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>waitStatusOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// next内存偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 静态初始化块
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>stateOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractQueuedSynchronizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;state&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>headOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractQueuedSynchronizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;head&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>tailOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AbstractQueuedSynchronizer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tail&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>waitStatusOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;waitStatus&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>nextOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;next&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>

        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=类的构造方法>类的构造方法</h3>
<p>该类构造方法为抽象构造方法，仅供子类调用。</p>
<h3 id=类的核心方法acquire>类的核心方法：acquire</h3>
<p>该方法以独占模式获取(资源)，忽略中断，即线程在aquire过程中，中断此线程是无效的。源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>acquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>tryAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>acquireQueued</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addWaiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EXCLUSIVE</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#000>selfInterrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>线程在调用 tryAcquire 时的流程如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426234229.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>首先调用 tryAcquire 方法，线程会尝试在独占模式下获取对象状态。
<ul>
<li>此方法会查询是否允许它在独占模式下获取对象状态，如果允许则获取。</li>
<li>在 AQS 源码中会默认抛出一个异常，即需要子类重写该方法以实现需要的逻辑。</li>
</ul>
</li>
<li>若 tryAcquire 失败，则调用 addWaiter 方法，addWaiter 方法完成的功能是将调用此方法的线程封装成为一个节点并放入 Sync Queue。</li>
<li>调用 acquireQueued 方法，此方法完成的功能是 Sync Queue 中的节点不断尝试获取资源，成功失败返回 true、false。</li>
<li>调用 tryAcquire 默认实现是抛出异常，因此需要继承者实现。</li>
</ul>
<p>首先是 addWaiter 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 添加等待者
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Node</span> <span style=color:#000>addWaiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 新生成一个结点，默认为独占模式
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// Try the fast path of enq; backup to full enq on failure
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 保存尾结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 尾结点不为空，即已经被初始化
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 将node结点的prev域连接到尾结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetTail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 比较pred是否为尾结点，是则将尾结点设置为node 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 设置尾结点的next域为node
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 返回新生成的结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>enq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 尾结点为空(即还没有被初始化过)，或者是compareAndSetTail操作失败，则入队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>addWaiter 方法使用快速添加的方式往 sync queue 尾部添加结点，如果 sync queue 队列还没有初始化，则会使用 enq 插入队列中，enq 方法源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Node</span> <span style=color:#000>enq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环，确保结点能够成功入队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 保存尾结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 尾结点为空，即还没被初始化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#8f5902;font-style:italic>// 头结点为空，并设置头结点为新生成的结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 头结点与尾结点都指向同一个新生结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 尾结点不为空，即已经被初始化过
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 将node结点的prev域连接到尾结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> 
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetTail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 比较结点t是否为尾结点，若是则将尾结点设置为node
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置尾结点的next域为node
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span> 
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 返回尾结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>enq 方法会使用无限循环来确保节点的成功插入。</p>
<p>acquireQueue方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// sync队列中的结点在独占且忽略中断的模式下获取(资源)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>acquireQueued</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 标志
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>failed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 中断标志
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取node节点的前驱结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>predecessor</span><span style=color:#ce5c00;font-weight:700>();</span> 
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>tryAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 前驱为头结点并且成功获得锁
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 设置头结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// help GC
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>failed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 设置标志
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>interrupted</span><span style=color:#ce5c00;font-weight:700>;</span> 
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shouldParkAfterFailedAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#000>parkAndCheckInterrupt</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>cancelAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先获取当前节点的前驱节点，如果前驱节点是头结点并且能够获取(资源)，代表该当前节点能够占有锁，设置头结点为当前节点，返回。否则，调用shouldParkAfterFailedAcquire和parkAndCheckInterrupt方法，首先，我们看shouldParkAfterFailedAcquire方法，代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 当获取(资源)失败后，检查并且更新结点状态
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>shouldParkAfterFailedAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取前驱结点的状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 状态为SIGNAL，为-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>            * This node has already set status asking a release
</span><span style=color:#8f5902;font-style:italic>            * to signal it, so it can safely park.
</span><span style=color:#8f5902;font-style:italic>            */</span>
        <span style=color:#8f5902;font-style:italic>// 可以进行park操作
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 表示状态为CANCELLED，为1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>            * Predecessor was cancelled. Skip over predecessors and
</span><span style=color:#8f5902;font-style:italic>            * indicate retry.
</span><span style=color:#8f5902;font-style:italic>            */</span>
        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 找到pred结点前面最近的一个状态不为CANCELLED的结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 赋值pred结点的next域
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 为PROPAGATE -3 或者是0 表示无状态,(为CONDITION -2时，表示此节点在condition queue中) 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>            * waitStatus must be 0 or PROPAGATE.  Indicate that we
</span><span style=color:#8f5902;font-style:italic>            * need a signal, but don&#39;t park yet.  Caller will need to
</span><span style=color:#8f5902;font-style:italic>            * retry to make sure it cannot acquire before parking.
</span><span style=color:#8f5902;font-style:italic>            */</span>
        <span style=color:#8f5902;font-style:italic>// 比较并设置前驱结点的状态为SIGNAL
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>);</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 不能进行park操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>只有当该节点的前驱结点的状态为SIGNAL时，才可以对该结点所封装的线程进行park操作。否则，将不能进行park操作。再看parkAndCheckInterrupt方法，源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 进行park操作并且返回该线程是否被中断
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>parkAndCheckInterrupt</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 在许可可用之前禁用当前线程，并且设置了blocker
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 当前线程是否已被中断，并清除中断标记位
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>parkAndCheckInterrupt方法里的逻辑是首先执行park操作，即禁用当前线程，然后返回该线程是否已经被中断。再看final块中的cancelAcquire方法，其源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 取消继续获取(资源)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>cancelAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Ignore if node doesn&#39;t exist
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// node为空，返回
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 设置node结点的thread为空
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// Skip cancelled predecessors
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 保存node的前驱结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 找到node前驱结点中第一个状态小于0的结点，即不为CANCELLED状态的结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// predNext is the apparent node to unsplice. CASes below will
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// fail if not, in which case, we lost race vs another cancel
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// or signal, so no further action is necessary.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 获取pred结点的下一个结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>predNext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// Can use unconditional write instead of CAS here.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// After this atomic step, other Nodes can skip past us.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Before, we are free of interference from other threads.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 设置node结点的状态为CANCELLED
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CANCELLED</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// If we are the tail, remove ourselves.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>compareAndSetTail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// node结点为尾结点，则设置尾结点为pred结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 比较并设置pred结点的next节点为null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>compareAndSetNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>predNext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span> 
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// node结点不为尾结点，或者比较设置不成功
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// If successor needs signal, try to set pred&#39;s next-link
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// so it will get one. Otherwise wake it up to propagate.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// (pred结点不为头结点，并且pred结点的状态为SIGNAL)或者 
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#8f5902;font-style:italic>// pred结点状态小于等于0，并且比较并设置等待状态为SIGNAL成功，并且pred结点所封装的线程不为空
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 保存结点的后继
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Node</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 后继不为空并且后继的状态小于等于0
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>compareAndSetNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>predNext</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 比较并设置pred.next = next;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>unparkSuccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 释放node的前一个结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// help GC
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法完成的功能就是取消当前线程对资源的获取，即设置该结点的状态为CANCELLED，接着我们再看unparkSuccessor方法，源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 释放后继结点
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>unparkSuccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * If status is negative (i.e., possibly needing signal) try
</span><span style=color:#8f5902;font-style:italic>        * to clear in anticipation of signalling.  It is OK if this
</span><span style=color:#8f5902;font-style:italic>        * fails or if status is changed by waiting thread.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 获取node结点的等待状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 状态值小于0，为SIGNAL -1 或 CONDITION -2 或 PROPAGATE -3
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 比较并且设置结点等待状态，设置为0
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * Thread to unpark is held in successor, which is normally
</span><span style=color:#8f5902;font-style:italic>        * just the next node.  But if cancelled or apparently null,
</span><span style=color:#8f5902;font-style:italic>        * traverse backwards from tail to find the actual
</span><span style=color:#8f5902;font-style:italic>        * non-cancelled successor.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 获取node节点的下一个结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 下一个结点为空或者下一个节点的等待状态大于0，即为CANCELLED
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// s赋值为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#8f5902;font-style:italic>// 从尾结点开始从后往前开始遍历
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 找到等待状态小于等于0的结点，找到最前的状态小于等于0的结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 保存结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 该结点不为为空，释放许可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法的作用就是为了释放node节点的后继结点。</p>
<p>对于cancelAcquire与unparkSuccessor方法，如下示意图可以清晰的表示:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426235112.png style=display:block;width:50% alt=NAME align=center> </div>
<p>其中node为参数，在执行完cancelAcquire方法后的效果就是unpark了s结点所包含的t4线程。</p>
<p>现在，再来看acquireQueued方法的整个的逻辑。逻辑如下:</p>
<ol>
<li>
<p>判断结点的前驱是否为head并且是否成功获取(资源)。</p>
</li>
<li>
<p>若步骤1均满足，则设置结点为head，之后会判断是否finally模块，然后返回。</p>
</li>
<li>
<p>若步骤2不满足，则判断是否需要park当前线程，是否需要park当前线程的逻辑是判断结点的前驱结点的状态是否为SIGNAL，若是，则park当前结点，否则，不进行park操作。</p>
</li>
<li>
<p>若park了当前线程，之后某个线程对本线程unpark后，并且本线程也获得机会运行。那么，将会继续进行步骤 1 的判断。</p>
</li>
</ol>
<h3 id=类的核心方法release>类的核心方法：release</h3>
<p>以独占模式释放资源：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>release</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 释放成功
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 保存头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 头结点不为空并且头结点状态不为0
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>unparkSuccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//释放头结点的后继结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其中，tryRelease的默认实现是抛出异常，需要具体的子类实现，如果tryRelease成功，那么如果头结点不为空并且头结点的状态不为0，则释放头结点的后继结点，unparkSuccessor方法已经分析过，不再累赘。</p>
<p>对于其他方法我们也可以分析，与前面分析的方法大同小异，所以，不再累赘。</p>
<h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://www.infoq.cn/article/BVPvyVxjKM8ZSTSpTi0L>AQS-CLH 锁</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1817bd7cc3e3b8a48c6490f4219e8da5>3.12 - CH12-AQS-2</h1>
<h2 id=应用示例>应用示例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.Lock</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.ReentrantLock</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; running&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractQueuedSynchonizerDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Lock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        
        <span style=color:#000>MyThread</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>    
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 前后随机
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>running</span>
<span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>running</span>
</code></pre></div><p>从示例可知，线程t1与t2共用了一把锁，即同一个lock。可能会存在如下一种时序：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426235454.png style=display:block;width:50% alt=NAME align=center> </div>
<p>首先 t1 线程调用 lock.lock 操作，然后 t2 再执行 lock.lock 操作，然后 t1 执行 lock.unlock，最后 t2 执行 lock.unlock。基于这样的时序尝试分析 AQS 内部的机制。</p>
<ul>
<li>t1 线程调用 lock.lock 操作：</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426235655.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>t2 再执行 lock.lock 操作：</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426235730.png style=display:block;width:50% alt=NAME align=center> </div>
<p>进过一系列方法调用，最后达到的状态是 t2 被禁用，因此调用了 LockSupport.lock。</p>
<ul>
<li>t1线程调用lock.unlock：</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426235830.png style=display:block;width:50% alt=NAME align=center> </div>
<p>t1线程中调用lock.unlock后，经过一系列的调用，最终的状态是释放了许可，因为调用了LockSupport.unpark。这时，t2线程就可以继续运行了。此时，会继续恢复t2线程运行环境，继续执行LockSupport.park后面的语句，即进一步调用如下。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426235856.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在上一步调用了LockSupport.unpark后，t2线程恢复运行，则运行parkAndCheckInterrupt，之后，继续运行acquireQueued方法，最后达到的状态是头结点head与尾结点tail均指向了t2线程所在的结点，并且之前的头结点已经从sync队列中断开了。</p>
<ul>
<li>t2线程调用lock.unlock，其方法调用顺序如下，只给出了主要的方法调用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210426235925.png style=display:block;width:50% alt=NAME align=center> </div>
<p>t2线程执行lock.unlock后，最终达到的状态还是与之前的状态一样。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-46c6c26f99517b8b1d24f8fe1476db99>3.13 - CH13-AQS-3</h1>
<h2 id=应用实例>应用实例</h2>
<p>下面我们结合Condition实现生产者与消费者，来进一步分析AbstractQueuedSynchronizer的内部工作机制。</p>
<p>Depot(仓库)类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.Condition</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.Lock</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.ReentrantLock</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Depot</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>capacity</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Condition</span> <span style=color:#000>fullCondition</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Condition</span> <span style=color:#000>emptyCondition</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Depot</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>capacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>capacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>capacity</span><span style=color:#ce5c00;font-weight:700>;</span>    
        <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>fullCondition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCondition</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>emptyCondition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCondition</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>produce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>capacity</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; before await&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>fullCondition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; after await&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>inc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>capacity</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>capacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>inc</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>inc</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;produce = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>inc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, size = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>emptyCondition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>signal</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>            
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; before await&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>emptyCondition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; after await&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>dec</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>left</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>dec</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>dec</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;consume = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dec</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;, size = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>fullCondition</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>signal</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>测试类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Consumer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Depot</span> <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Depot</span> <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>no</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; consume thread&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Producer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Depot</span> <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Producer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Depot</span> <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>depot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>produce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            
            <span style=color:#5c35cc;font-weight:700>@Override</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>produce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>no</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>no</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; produce thread&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReentrantLockDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Depot</span> <span style=color:#000>depot</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Depot</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Producer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>produce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Producer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>produce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>200</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>depot</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>consume</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>200</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行结果(随机)：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>produce</span> <span style=color:#ce5c00;font-weight:700>=</span> 500, <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>500</span>
Thread<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>200</span> produce thread,5,main<span style=color:#ce5c00;font-weight:700>]</span> before await
<span style=color:#000>consume</span> <span style=color:#ce5c00;font-weight:700>=</span> 500, <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
Thread<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>200</span> consume thread,5,main<span style=color:#ce5c00;font-weight:700>]</span> before await
Thread<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>200</span> produce thread,5,main<span style=color:#ce5c00;font-weight:700>]</span> after await
<span style=color:#000>produce</span> <span style=color:#ce5c00;font-weight:700>=</span> 200, <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>200</span>
Thread<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>200</span> consume thread,5,main<span style=color:#ce5c00;font-weight:700>]</span> after await
<span style=color:#000>consume</span> <span style=color:#ce5c00;font-weight:700>=</span> 200, <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</code></pre></div><p>根据结果，我们猜测一种可能的时序如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000103.png style=display:block;width:50% alt=NAME align=center> </div>
<p>p1代表produce 500的那个线程，p2代表produce 200的那个线程，c1代表consume 500的那个线程，c2代表consume 200的那个线程。</p>
<ul>
<li>p1线程调用lock.lock，获得锁，继续运行，方法调用顺序在前面已经给出。</li>
<li>p2线程调用lock.lock，由前面的分析可得到如下的最终状态。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000133.png style=display:block;width:50% alt=NAME align=center> </div>
<p>p2线程调用lock.lock后，会禁止p2线程的继续运行，因为执行了LockSupport.park操作。</p>
<ul>
<li>c1线程调用lock.lock，由前面的分析得到如下的最终状态。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000153.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最终c1线程会在sync queue队列的尾部，并且其结点的前驱结点(包含p2的结点)的waitStatus变为了SIGNAL。</p>
<ul>
<li>c2线程调用lock.lock，由前面的分析得到如下的最终状态。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000215.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最终c1线程会在sync queue队列的尾部，并且其结点的前驱结点(包含c1的结点)的waitStatus变为了SIGNAL。</p>
<ul>
<li>p1线程执行emptyCondition.signal，其方法调用顺序如下，只给出了主要的方法调用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000235.png style=display:block;width:50% alt=NAME align=center> </div>
<p>AQS.CO表示AbstractQueuedSynchronizer.ConditionObject类。此时调用signal方法不会产生任何其他效果。</p>
<ul>
<li>p1线程执行lock.unlock，根据前面的分析可知，最终的状态如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000259.png style=display:block;width:50% alt=NAME align=center> </div>
<p>此时，p2线程所在的结点为头结点，并且其他两个线程(c1、c2)依旧被禁止，所以，此时p2线程继续运行，执行用户逻辑。</p>
<ul>
<li>p2线程执行fullCondition.await，其方法调用顺序如下，只给出了主要的方法调用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000318.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最终到达的状态是新生成了一个结点，包含了p2线程，此结点在condition queue中；并且sync queue中p2线程被禁止了，因为在执行了LockSupport.park操作。从方法一些调用可知，在await操作中线程会释放锁资源，供其他线程获取。同时，head结点后继结点的包含的线程的许可被释放了，故其可以继续运行。由于此时，只有c1线程可以运行，故运行c1。</p>
<ul>
<li>继续运行c1线程，c1线程由于之前被park了，所以此时恢复，继续之前的步骤，即还是执行前面提到的acquireQueued方法，之后，c1判断自己的前驱结点为head，并且可以获取锁资源，最终到达的状态如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000409.png style=display:block;width:50% alt=NAME align=center> </div>
<p>其中，head设置为包含c1线程的结点，c1继续运行。</p>
<ul>
<li>c1线程执行fullCondtion.signal，其方法调用顺序如下，只给出了主要的方法调用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000431.png style=display:block;width:50% alt=NAME align=center> </div>
<p>signal方法达到的最终结果是将包含p2线程的结点从condition queue中转移到sync queue中，之后condition queue为null，之前的尾结点的状态变为SIGNAL。</p>
<ul>
<li>c1线程执行lock.unlock操作，根据之前的分析，经历的状态变化如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000459.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最终c2线程会获取锁资源，继续运行用户逻辑。</p>
<ul>
<li>c2线程执行emptyCondition.await，由前面的第七步分析，可知最终的状态如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000518.png style=display:block;width:50% alt=NAME align=center> </div>
<p>await操作将会生成一个结点放入condition queue中与之前的一个condition queue是不相同的，并且unpark头结点后面的结点，即包含线程p2的结点。</p>
<ul>
<li>p2线程被unpark，故可以继续运行，经过CPU调度后，p2继续运行，之后p2线程在AQS:await方法中被park，继续AQS.CO:await方法的运行，其方法调用顺序如下，只给出了主要的方法调用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000544.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>p2继续运行，执行emptyCondition.signal，根据第九步分析可知，最终到达的状态如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000619.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最终，将condition queue中的结点转移到sync queue中，并添加至尾部，condition queue会为空，并且将head的状态设置为SIGNAL。</p>
<ul>
<li>p2线程执行lock.unlock操作，根据前面的分析可知，最后的到达的状态如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427000652.png style=display:block;width:50% alt=NAME align=center> </div>
<p>unlock操作会释放c2线程的许可，并且将头结点设置为c2线程所在的结点。</p>
<ul>
<li>c2线程继续运行，执行fullCondition. signal，由于此时fullCondition的condition queue已经不存在任何结点了，故其不会产生作用。</li>
<li>c2执行lock.unlock，由于c2是sync队列中最后一个结点，故其不会再调用unparkSuccessor了，直接返回true。即整个流程就完成了。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dab1ea524b05e9095151a5c2175bc241>3.14 - CH14-AQS-4</h1>
<h2 id=aqs-总结>AQS 总结</h2>
<p>最核心的就是sync queue的分析。</p>
<ul>
<li>每个节点都是由前驱节点唤醒。</li>
<li>如果节点发现前驱节点是 head 并且尝试获取成功，则会轮到该线程执行。</li>
<li>condition queue 中的节点想 sync queue 中转移是通过 signal 操作完成的。</li>
<li>当节点状态为 SIGNAL 时，表示后面的节点需要运行。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6f7a32f3c6c9033077c88534df6ab468>3.15 - CH15-ReentrantLock</h1>
<h2 id=源码分析>源码分析</h2>
<h3 id=层级结构>层级结构</h3>
<p>ReentrantLock实现了Lock接口，Lock接口中定义了lock与unlock相关操作，并且还存在newCondition方法，表示生成一个条件。</p>
<h3 id=内部类>内部类</h3>
<p>ReentrantLock总共有三个内部类，并且三个内部类是紧密相关的，下面先看三个类的关系。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003039.png style=display:block;width:50% alt=NAME align=center> </div>
<p>ReentrantLock类内部总共存在Sync、NonfairSync、FairSync三个类，NonfairSync与FairSync类继承自Sync类，Sync类继承自AbstractQueuedSynchronizer抽象类。下面逐个进行分析。</p>
<h4 id=内部类sync>内部类：Sync</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Sync</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractQueuedSynchronizer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 序列号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>5179523762034025860L</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    
    <span style=color:#8f5902;font-style:italic>// 非公平方式获取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>nonfairTryAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 当前线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Thread</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 表示没有线程正在竞争该锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 比较并设置状态成功，状态0表示锁没有被占用
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置当前线程独占
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span> 
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 成功
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 当前线程拥有该锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 增加重入次数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// overflow
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Maximum lock count exceeded&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 设置状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextc</span><span style=color:#ce5c00;font-weight:700>);</span> 
            <span style=color:#8f5902;font-style:italic>// 成功
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 失败
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 试图在共享模式下获取对象状态，此方法应该查询是否允许它在共享模式下获取对象状态，如果允许，则获取它
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 当前线程不为独占线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 抛出异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 释放标识
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>free</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span> 
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>free</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 已经释放，清空独占
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>setExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span> 
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 设置标识
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span> 
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>free</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 判断资源是否被当前线程占有
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// While we must in general read state before owner,
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// we don&#39;t need to do so to check if current thread is owner
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 新生一个条件
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ConditionObject</span> <span style=color:#000>newCondition</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConditionObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// Methods relayed from outer class
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 返回资源的占用线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Thread</span> <span style=color:#000>getOwner</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>        
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 返回状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getHoldCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>            
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 资源是否被占用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isLocked</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>        
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Reconstitutes the instance from a stream (that is, deserializes it).
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 自定义反序列化逻辑
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>readObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ObjectInputStream</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>IOException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>defaultReadObject</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// reset to unlocked state
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>　　
</code></pre></div><p>其中的方法及作用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003143.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=内部类nonfairsync>内部类：NonfairSync</h4>
<p>NonfairSync类继承了Sync类，表示采用非公平策略获取锁，其实现了Sync类中抽象的lock方法，源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 非公平锁
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NonfairSync</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sync</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>7316153563782823691L</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 获得锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 比较并设置状态成功，状态0表示锁没有被占用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 把当前线程设置独占了锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>setExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#8f5902;font-style:italic>// 锁已经被占用，或者set失败
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 以独占模式获取对象，忽略中断
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>acquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nonfairTryAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从lock方法的源码可知，每一次都尝试获取锁，而并不会按照公平等待的原则进行等待，让等待时间最久的线程获得锁。</p>
<h4 id=内部类fairsync>内部类：FairSync</h4>
<p>FairSync类也继承了Sync类，表示采用公平策略获取锁，其实现了Sync类中的抽象lock方法，源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 公平锁
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FairSync</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sync</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本序列化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>3000897897090466540L</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 以独占模式获取对象，忽略中断
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>acquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Fair version of tryAcquire.  Don&#39;t grant access unless
</span><span style=color:#8f5902;font-style:italic>        * recursive call or no waiters or is first.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 尝试公平获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取当前线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Thread</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 状态为0
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>hasQueuedPredecessors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 不存在已经等待更久的线程并且比较并且设置状态成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置当前线程独占
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>setExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 状态不为0，即资源已经被线程占据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 下一个状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 超过了int的表示范围
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Maximum lock count exceeded&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 设置状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当资源空闲时，它总是会先判断sync队列(AbstractQueuedSynchronizer中的数据结构)是否有等待时间更长的线程，如果存在，则将该线程加入到等待队列的尾部，实现了公平获取原则。</p>
<p>其中，FairSync类的lock的方法调用如下，只给出了主要的方法。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003402.png style=display:block;width:50% alt=NAME align=center> </div>
<p>可以看出只要资源被其他线程占用，该线程就会添加到sync queue中的尾部，而不会先尝试获取资源。这也是和Nonfair最大的区别，Nonfair每一次都会尝试去获取资源，如果此时该资源恰好被释放，则会被当前线程获取，这就造成了不公平的现象，当获取不成功，再加入队列尾部。</p>
<h3 id=类的属性>类的属性</h3>
<p>ReentrantLock类的sync非常重要，对ReentrantLock类的操作大部分都直接转化为对Sync和AQS类的操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReentrantLock</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Lock</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 序列号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>7373984872572414699L</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>// 同步队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sync</span> <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=构造函数>构造函数</h3>
<ul>
<li>ReentrantLock()型构造函数：默认采用非公平策略获取锁</li>
<li>ReentrantLock(boolean)型构造函数：true 表示采用公平策略获取锁，否则采用非公平策略</li>
</ul>
<h3 id=核心函数>核心函数</h3>
<p>通过分析ReentrantLock的源码，可知对其操作都转化为对Sync对象的操作，由于Sync继承了AQS，所以基本上都可以转化为对AQS的操作。如将ReentrantLock的lock函数转化为对Sync的lock函数的调用，而具体会根据采用的策略(如公平策略或者非公平策略)的不同而调用到Sync的不同子类。</p>
<h2 id=应用示例>应用示例</h2>
<h3 id=公平锁>公平锁</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.Lock</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.ReentrantLock</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Lock</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; running&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>500</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractQueuedSynchonizerDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Lock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#000>MyThread</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>);</span>        
        <span style=color:#000>MyThread</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t3&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>    
        <span style=color:#000>t3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 随机结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>running</span>
<span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>running</span>
<span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>t3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>running</span>
</code></pre></div><p>该示例使用的是公平策略，由结果可知，可能会存在如下一种时序。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003736.png style=display:block;width:50% alt=NAME align=center> </div>
<p>首先，t1线程的lock操作 -> t2线程的lock操作 -> t3线程的lock操作 -> t1线程的unlock操作 -> t2线程的unlock操作 -> t3线程的unlock操作。根据这个时序图来进一步分析源码的工作流程。</p>
<ul>
<li>t1线程执行lock.lock，下图给出了方法调用中的主要方法。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003805.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由调用流程可知，t1线程成功获取了资源，可以继续执行。</p>
<ul>
<li>t2线程执行lock.lock，下图给出了方法调用中的主要方法。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003826.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由上图可知，最后的结果是t2线程会被禁止，因为调用了LockSupport.park。</p>
<ul>
<li>t3线程执行lock.lock，下图给出了方法调用中的主要方法。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003849.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由上图可知，最后的结果是t3线程会被禁止，因为调用了LockSupport.park。</p>
<ul>
<li>t1线程调用了lock.unlock，下图给出了方法调用中的主要方法。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003910.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如上图所示，最后，head的状态会变为0，t2线程会被unpark，即t2线程可以继续运行。此时t3线程还是被禁止。</p>
<ul>
<li>t2获得cpu资源，继续运行，由于t2之前被park了，现在需要恢复之前的状态，下图给出了方法调用中的主要方法。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003931.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在setHead函数中会将head设置为之前head的下一个结点，并且将pre域与thread域都设置为null，在acquireQueued返回之前，sync queue就只有两个结点了。</p>
<ul>
<li>t2执行lock.unlock，下图给出了方法调用中的主要方法。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427003953.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由上图可知，最终unpark t3线程，让t3线程可以继续运行。</p>
<ul>
<li>t3线程获取cpu资源，恢复之前的状态，继续运行。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427004012.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最终达到的状态是sync queue中只剩下了一个结点，并且该节点除了状态为0外，其余均为null。</p>
<ul>
<li>t3执行lock.unlock，下图给出了方法调用中的主要方法。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427004030.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最后的状态和之前的状态是一样的，队列中有一个空节点，头结点为尾节点均指向它。</p>
<p>使用公平策略和Condition的情况可以参考上一篇关于AQS的源码示例分析部分，不再累赘。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3973541e40ecf4ca74f5e9d2cfa03450>3.16 - CH16-ReentrantReadWriteLock</h1>
<h2 id=数据结构>数据结构</h2>
<p>其实现是基于 ReentrantLock 和 AQS，因此底层基于 AQS 的数据结构。</p>
<h2 id=源码分析>源码分析</h2>
<h3 id=层级结构>层级结构</h3>
<ul>
<li>ReentrantReadWriteLock 实现了 ReadWriteLock 接口，ReadWriteLock 接口定义了获取读锁和写锁的规范，需要实现类来提供具体实现；</li>
<li>同时实现了 Serializable 接口，表示可以进行序列化。</li>
</ul>
<h3 id=内部类>内部类</h3>
<p>内部有 5 个类，5 个内部类之间互相关联，关系如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427210531.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=内部类sync>内部类：Sync</h3>
<p>Sync 直接继承了 AQS，它的内部又有两个内部类，分别为 HoldCounter 和 ThreadLocalHoldCounter，其中 HoldCounter 主要与读锁配套使用。</p>
<p>HoldCounter 源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 计数器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HoldCounter</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 计数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Use id, not reference, to avoid garbage retention
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 获取当前线程的TID属性的值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getThreadId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>count 表示某个读线程重入的次数</li>
<li>tid 表示该线程的 tid 字段值，线程的唯一标识</li>
</ul>
<p>ThreadLocalHoldCounter 源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 本地线程计数器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ThreadLocalHoldCounter</span>
    <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>HoldCounter</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 重写初始化方法，在没有进行set的情况下，获取的都是该HoldCounter值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>HoldCounter</span> <span style=color:#000>initialValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HoldCounter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ThreadLocalHoldCounter 重写了 ThreadLocal 的 initialValue 方法，ThreadLocal 类可以将线程与对象进行关联。在没有执行 set 的情况下，get 到的均为 initialValue 方法中生成的 HolderCounter 对象。</p>
<p>Sync 类的属性：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Sync</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractQueuedSynchronizer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本序列号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>6317671515068378041L</span><span style=color:#ce5c00;font-weight:700>;</span>        
    <span style=color:#8f5902;font-style:italic>// 高16位为读锁，低16位为写锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SHARED_SHIFT</span>   <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 读锁单位
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SHARED_UNIT</span>    <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SHARED_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 读锁最大数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAX_COUNT</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SHARED_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 写锁最大数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>EXCLUSIVE_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SHARED_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 本地线程计数器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>ThreadLocalHoldCounter</span> <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 缓存的计数器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>HoldCounter</span> <span style=color:#000>cachedHoldCounter</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Thread</span> <span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 第一个读线程的计数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>firstReaderHoldCount</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>属性中包括了读锁和写锁线程的最大数量、本地线程计数器等。</li>
</ul>
<p>Sync 类的构造函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 构造函数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Sync</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 本地线程计数器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>readHolds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadLocalHoldCounter</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置AQS的状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>// ensures visibility of readHolds
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>在 Sync 类的构造函数中设置了本地线程计数器和 AQS 的状态 state。</li>
</ul>
<h3 id=内部类sync-核心函数>内部类：Sync 核心函数</h3>
<p>ReentrantReadWriteLock 的大部分操作都会交由 Sync 对象执行。以下是 Sync 的主要函数：</p>
<h4 id=sharedcount>sharedCount：</h4>
<ul>
<li>表示占有读锁的线程数量</li>
<li><code>static int sharedCount(int c) { return c >>> SHARED_SHIFT; }</code></li>
<li>直接将 state 右移 16 位，就可以得到读锁的线程数量，因为 state 的高 16 位表示读锁，低 16 位表示写锁的线程数量。</li>
</ul>
<p>exclusiveCount：</p>
<ul>
<li>表示占有写锁的线程数量</li>
<li><code>static int exclusiveCount(int c) { return c & EXCLUSIVE_MASK; }</code></li>
<li>直接将 state 和 <code>(2^16 - 1)</code> 做与运算，等效于将 state 模上 2^16，写锁线程数量由低 16 位表示。</li>
</ul>
<h4 id=tryrelease>tryRelease：</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>* Note that tryRelease and tryAcquire can be called by
</span><span style=color:#8f5902;font-style:italic>* Conditions. So it is possible that their arguments contain
</span><span style=color:#8f5902;font-style:italic>* both read and write holds that are all released during a
</span><span style=color:#8f5902;font-style:italic>* condition wait and re-established in tryAcquire.
</span><span style=color:#8f5902;font-style:italic>*/</span>

<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 判断是否伪独占线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 计算释放资源后的写锁的数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>free</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exclusiveCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextc</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 是否释放成功
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>free</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>setExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 设置独占线程为空
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextc</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 设置状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>free</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>用于释放写锁资源，首先会判断该线程是否为独占线程，如果不是独占线程，则抛出异常；否则，计算释放资源后的写锁数量，如果为 0 则表示释放成功，资源不再被占用，否则表示资源仍被占用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427211637.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=tryacquire>tryAcquire：</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * Walkthrough:
</span><span style=color:#8f5902;font-style:italic>        * 1. If read count nonzero or write count nonzero
</span><span style=color:#8f5902;font-style:italic>        *    and owner is a different thread, fail.
</span><span style=color:#8f5902;font-style:italic>        * 2. If count would saturate, fail. (This can only
</span><span style=color:#8f5902;font-style:italic>        *    happen if count is already nonzero.)
</span><span style=color:#8f5902;font-style:italic>        * 3. Otherwise, this thread is eligible for lock if
</span><span style=color:#8f5902;font-style:italic>        *    it is either a reentrant acquire or
</span><span style=color:#8f5902;font-style:italic>        *    queue policy allows it. If so, update state
</span><span style=color:#8f5902;font-style:italic>        *    and set owner.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 获取当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 写线程数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exclusiveCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 状态不为0
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// (Note: if c != 0 and w == 0 then shared count != 0)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 写线程数量为0或者当前线程没有占有独占资源
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>exclusiveCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_COUNT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 判断是否超过最高写线程数量
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Maximum lock count exceeded&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// Reentrant acquire
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 设置AQS状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writerShouldBlock</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span>
        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 写线程是否应该被阻塞
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 设置独占线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>用于获取写锁。首先获取 state，判断如果为 0 表示此时没有读锁线程，再判断写线程是否应该被阻塞，而在非公平策略下总是不会被阻塞，在公平策略下会进行判断(判断同步队列中是否已有等待时间更长的线程，存在则被阻塞，否则无需组织)，之后设置状态 state 并返回 true。</p>
<p>如果 state 不为 0，表示此时存在读锁或写锁线程，弱写锁线程数量为 0 或当前线程为独占锁线程则返回 false，表示不成功。否则，判断写线程的重入次数是否大于了最大值，若是则抛出异常，否则设置状态 state 并返回 true，表示成功。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427212013.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=tryreleaseshared>tryReleaseShared：</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryReleaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>unused</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 当前线程为第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// assert firstReaderHoldCount &gt; 0;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstReaderHoldCount</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 读线程占用的资源数为1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#8f5902;font-style:italic>// 减少占用的资源
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>firstReaderHoldCount</span><span style=color:#ce5c00;font-weight:700>--;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 当前线程不为第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 获取缓存的计数器
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HoldCounter</span> <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedHoldCounter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tid</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>getThreadId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 计数器为空或者计数器的tid不为当前正在运行的线程的tid
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取当前线程对应的计数器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取计数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 计数小于等于1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 移除
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 计数小于等于0，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>unmatchedUnlockException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 减少计数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>SHARED_UNIT</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 比较并进行设置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// Releasing the read lock has no effect on readers,
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// but it may allow waiting writers to proceed if
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// both read and write locks are now free.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数表示读锁线程释放锁。首先判断当前线程是否为第一个读线程 firstReader，若是，则判断第一个读线程占有的资源数 firstReaderHoldCount 是否为 1，若是，则设置第一个读线程 firstReader 为空，否则，将第一个读线程占有的资源数 firstReaderHoldCount 减1；若当前线程不是第一个读线程，那么首先会获取缓存计数器(上一个读锁线程对应的计数器 )，若计数器为空或者 tid 不等于当前线程的 tid 值，则获取当前线程的计数器，如果计数器的计数 count 小于等于1，则移除当前线程对应的计数器，如果计数器的计数 count 小于等于 0，则抛出异常，之后再减少计数即可。无论何种情况，都会进入无限循环，该循环可以确保成功设置状态 state。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427212206.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=tryacquireshared>tryAcquireShared</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>IllegalMonitorStateException</span> <span style=color:#000>unmatchedUnlockException</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#4e9a06>&#34;attempt to unlock read lock, not locked by current thread&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 共享模式下获取资源
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>unused</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * Walkthrough:
</span><span style=color:#8f5902;font-style:italic>        * 1. If write lock held by another thread, fail.
</span><span style=color:#8f5902;font-style:italic>        * 2. Otherwise, this thread is eligible for
</span><span style=color:#8f5902;font-style:italic>        *    lock wrt state, so ask if it should block
</span><span style=color:#8f5902;font-style:italic>        *    because of queue policy. If not, try
</span><span style=color:#8f5902;font-style:italic>        *    to grant by CASing state and updating count.
</span><span style=color:#8f5902;font-style:italic>        *    Note that step does not check for reentrant
</span><span style=color:#8f5902;font-style:italic>        *    acquires, which is postponed to full version
</span><span style=color:#8f5902;font-style:italic>        *    to avoid having to check hold count in
</span><span style=color:#8f5902;font-style:italic>        *    the more typical non-reentrant case.
</span><span style=color:#8f5902;font-style:italic>        * 3. If step 2 fails either because thread
</span><span style=color:#8f5902;font-style:italic>        *    apparently not eligible or CAS fails or count
</span><span style=color:#8f5902;font-style:italic>        *    saturated, chain to version with full retry loop.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 获取当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exclusiveCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 写线程数不为0并且占有资源的不是当前线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 读锁数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sharedCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>readerShouldBlock</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MAX_COUNT</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SHARED_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 读线程是否应该被阻塞、并且小于最大值、并且比较设置成功
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 读锁数量为0
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 设置第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 读线程占用的资源数为1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>firstReaderHoldCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 当前线程为第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 占用资源数加1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>firstReaderHoldCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 读锁数量不为0并且不为当前线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取计数器
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>HoldCounter</span> <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedHoldCounter</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tid</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>getThreadId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 计数器为空或者计数器的tid不为当前正在运行的线程的tid
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 获取当前线程对应的计数器
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>cachedHoldCounter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 计数为0
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span><span style=color:#ce5c00;font-weight:700>++;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fullTryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数表示读锁线程获取读锁。首先判断写锁是否为 0 并且当前线程不占有独占锁，直接返回；否则，判断读线程是否需要被阻塞并且读锁数量是否小于最大值并且比较设置状态成功，若当前没有读锁，则设置第一个读线程 firstReade r和 firstReaderHoldCount；若当前线程线程为第一个读线程，则增加 firstReaderHoldCount；否则，将设置当前线程对应的 HoldCounter 对象的值。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427212314.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=fulltryacquireshared>fullTryAcquireShared</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fullTryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * This code is in part redundant with that in
</span><span style=color:#8f5902;font-style:italic>        * tryAcquireShared but is simpler overall by not
</span><span style=color:#8f5902;font-style:italic>        * complicating tryAcquireShared with interactions between
</span><span style=color:#8f5902;font-style:italic>        * retries and lazily reading hold counts.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#000>HoldCounter</span> <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exclusiveCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 写线程数量不为0
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getExclusiveOwnerThread</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 不为当前线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// else we hold the exclusive lock; blocking here
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// would cause deadlock.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readerShouldBlock</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 写线程数量为0并且读线程被阻塞
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// Make sure we&#39;re not acquiring read lock reentrantly
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 当前线程为第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// assert firstReaderHoldCount &gt; 0;
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 当前线程不为第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 计数器不为空
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedHoldCounter</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tid</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>getThreadId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 计数器为空或者计数器的tid不为当前正在运行的线程的tid
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MAX_COUNT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 读锁数量为最大值，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Maximum lock count exceeded&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SHARED_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 比较并且设置成功
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sharedCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 读线程数量为0
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置第一个读线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>firstReaderHoldCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstReader</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>firstReaderHoldCount</span><span style=color:#ce5c00;font-weight:700>++;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cachedHoldCounter</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tid</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>getThreadId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#000>rh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>readHolds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span><span style=color:#ce5c00;font-weight:700>++;</span>
                <span style=color:#000>cachedHoldCounter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rh</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// cache for release
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 tryAcquireShared 函数中，如果下列三个条件不满足(读线程是否应该被阻塞、小于最大值、比较设置成功)则会进行 fullTryAcquireShared 函数中，它用来保证相关操作可以成功。其逻辑与 tryAcquireShared 逻辑类似，不再累赘。</p>
<p>而其他内部类的操作基本上都是转化到了对Sync对象的操作，在此不再累赘。</p>
<h3 id=类属性>类属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReentrantReadWriteLock</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ReadWriteLock</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本序列号    
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>6992448646407690164L</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>// 读锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantReadWriteLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ReadLock</span> <span style=color:#000>readerLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 写锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantReadWriteLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>WriteLock</span> <span style=color:#000>writerLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 同步队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sync</span> <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 线程ID的偏移地址
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>TID_OFFSET</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>UNSAFE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>tk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 获取线程的tid字段的内存地址
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>TID_OFFSET</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tid&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>
<p>包括了一个 ReentrantReadWriteLock.ReadLock 对象，表示读锁；</p>
</li>
<li>
<p>一个ReentrantReadWriteLock.WriteLock对象，表示写锁；</p>
</li>
<li>
<p>一个Sync对象，表示同步队列。</p>
</li>
</ul>
<h3 id=类的构造函数>类的构造函数</h3>
<ul>
<li>ReentrantReadWriteLock()
<ul>
<li>默认非公平策略</li>
</ul>
</li>
<li>ReentrantReadWriteLock(boolean)
<ul>
<li>true：公平策略</li>
<li>false：非公平策略</li>
</ul>
</li>
</ul>
<h3 id=类的核心函数>类的核心函数</h3>
<p>对ReentrantReadWriteLock的操作基本上都转化为了对Sync对象的操作。</p>
<h2 id=应用示例>应用示例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.locks.ReentrantReadWriteLock</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReentrantReadWriteLock</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ReadThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReentrantReadWriteLock</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rrwLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; trying to lock&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; lock successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>5000</span><span style=color:#ce5c00;font-weight:700>);</span>        
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; unlock successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ReentrantReadWriteLock</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>WriteThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ReentrantReadWriteLock</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rrwLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; trying to lock&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeLock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; lock successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>    
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeLock</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; unlock successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReentrantReadWriteLockDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ReentrantReadWriteLock</span> <span style=color:#000>rrwLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantReadWriteLock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ReadThread</span> <span style=color:#000>rt1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReadThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rt1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ReadThread</span> <span style=color:#000>rt2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReadThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;rt2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>WriteThread</span> <span style=color:#000>wt1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WriteThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;wt1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rrwLock</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>rt1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>rt2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>wt1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>rt1</span> <span style=color:#000>trying</span> <span style=color:#000>to</span> <span style=color:#000>lock</span>
<span style=color:#000>rt2</span> <span style=color:#000>trying</span> <span style=color:#000>to</span> <span style=color:#000>lock</span>
<span style=color:#000>wt1</span> <span style=color:#000>trying</span> <span style=color:#000>to</span> <span style=color:#000>lock</span>
<span style=color:#000>rt1</span> <span style=color:#000>lock</span> <span style=color:#000>successfully</span>
<span style=color:#000>rt2</span> <span style=color:#000>lock</span> <span style=color:#000>successfully</span>
<span style=color:#000>rt1</span> <span style=color:#000>unlock</span> <span style=color:#000>successfully</span>
<span style=color:#000>rt2</span> <span style=color:#000>unlock</span> <span style=color:#000>successfully</span>
<span style=color:#000>wt1</span> <span style=color:#000>lock</span> <span style=color:#000>successfully</span>
<span style=color:#000>wt1</span> <span style=color:#000>unlock</span> <span style=color:#000>successfully</span>
</code></pre></div><p>程序中生成了一个ReentrantReadWriteLock对象，并且设置了两个读线程，一个写线程。根据结果，可能存在如下的时序图。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-readwritelock-6.png style=display:block;width:50% alt=NAME align=center> </div>
<p>rt1 线程执行 rrwLock.readLock().lock 操作的调用链路：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427212905.png style=display:block;width:50% alt=NAME align=center> </div>
<p>此时 AQS 的状态 state 为 2^16，表示当前读线程数量为 1。</p>
<p>rt2 线程执行 rrwLock.readLock().lock 操作，主要的函数调用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427213005.png style=display:block;width:50% alt=NAME align=center> </div>
<p>此时，在同步队列 Sync queue 中存在两个结点，并且 wt1 线程会被禁止运行。</p>
<p>rt1 线程执行 rrwLock.readLock().unlock 操作，主要的函数调用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427213041.png style=display:block;width:50% alt=NAME align=center> </div>
<p>此时，AQS的state为2^16次方，表示还有一个读线程。</p>
<p>rt2 线程执行 rrwLock.readLock().unlock 操作，主要的函数调用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427213112.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当 rt2 线程执行 unlock 操作后，AQS 的 state 为 0，并且 wt1 线程将会被 unpark，其获得 CPU 资源就可以运行。</p>
<p>wt1线程获得CPU资源，继续运行，需要恢复。由于之前acquireQueued函数中的parkAndCheckInterrupt函数中被禁止的，所以，恢复到parkAndCheckInterrupt函数中，主要的函数调用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427213146.png style=display:block;width:50% alt=NAME align=center> </div>
<p>最后，sync queue 队列中只有一个结点，并且头结点尾节点均指向它，AQS 的 state 值为 1，表示此时有一个写线程。</p>
<p>wt1 执行 rrwLock.writeLock().unlock 操作，主要的函数调用如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427213218.png style=display:block;width:50% alt=NAME align=center> </div>
<p>此时，AQS 的 state 为 0，表示没有任何读线程或者写线程了。并且 Sync queue 结构与上一个状态的结构相同，没有变化。</p>
<h2 id=深入理解>深入理解</h2>
<h3 id=什么是锁升级降级>什么是锁升级、降级</h3>
<p>锁降级指的是写锁降级成为读锁。如果当前线程拥有写锁，然后将其释放，最后再获取读锁，这种分段完成的过程不能称之为锁降级。</p>
<p>锁降级是指把持住(当前拥有的)写锁，再获取到读锁，随后释放(先前拥有的)写锁的过程。</p>
<p>因为数据不常变化，所以多个线程可以并发地进行数据处理，当数据变更后，如果当前线程感知到数据变化，则进行数据的准备工作，同时其他处理线程被阻塞，直到当前线程完成数据的准备工作，如代码如下所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>processData</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>readLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 必须先释放读锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>readLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 锁降级从写锁获取到开始
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>writeLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 准备数据的流程(略)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>update</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>readLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>writeLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 锁降级完成，写锁降级为读锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 使用数据的流程(略)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>readLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>上述示例中，当数据发生变更后，update 变量(布尔类型且volatile修饰)被设置为 false，此时所有访问 processData() 方法的线程都能够感知到变化，但只有一个线程能够获取到写锁，其他线程会被阻塞在读锁和写锁的 lock() 方法上。当前线程获取写锁完成数据准备之后，再获取读锁，随后释放写锁，完成锁降级。</p>
<p>锁降级中读锁的获取是否必要呢? 答案是必要的。主要是为了保证数据的可见性，如果当前线程不获取读锁而是直接释放写锁，假设此刻另一个线程(记作线程T)获取了写锁并修改了数据，那么当前线程无法感知线程T的数据更新。如果当前线程获取读锁，即遵循锁降级的步骤，则线程T将会被阻塞，直到当前线程使用数据并释放读锁之后，线程T才能获取写锁进行数据更新。</p>
<p>RentrantReadWriteLock不支持锁升级(把持读锁、获取写锁，最后释放读锁的过程)。目的也是保证数据可见性，如果读锁已被多个线程获取，其中任意线程成功获取了写锁并更新了数据，则其更新对其他获取到读锁的线程是不可见的。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1b6eb5029cdf6629aa1d3fbdfb2fb794>3.17 - CH17-ConcurrentHashMap</h1>
<h2 id=hashtable-为什么慢>HashTable 为什么慢</h2>
<p>Hashtable 之所以效率低下主要是因为其实现使用了 synchronized 关键字对 put 等操作进行加锁，而 synchronized 关键字加锁是对整个对象示例进行加锁，也就是说在进行 put 等修改 Hash 表的操作时，锁住了整个 Hash 表，从而使得其表现的效率低下。</p>
<h2 id=jdk-17-concurrenthashmap>JDK 1.7-ConcurrentHashMap</h2>
<p>在 JDK 1.5~1.7 版本，Java 使用了分段锁机制实现 ConcurrentHashMap。</p>
<ul>
<li>
<p>简而言之，ConcurrentHashMap 在对象中保存了一个 Segment 数组，即将整个 Hash 表划分为多个分段；</p>
</li>
<li>
<p>而每个 Segment 元素，即每个分段则类似于一个 Hashtable；</p>
</li>
<li>
<p>这样，在执行 put 操作时首先根据 hash 算法定位到元素属于哪个 Segment，然后对该 Segment 加锁即可。</p>
</li>
<li>
<p>因此，ConcurrentHashMap 在多线程并发编程中可是实现多线程 put 操作。</p>
</li>
</ul>
<h3 id=数据结构>数据结构</h3>
<p>整个 ConcurrentHashMap 由一个个 Segment 组成，Segment 代表”部分“或”一段“的意思，所以很多地方都会将其描述为分段锁。注意，行文中，我很多地方用了“槽”来代表一个 segment。</p>
<p>简单理解就是，ConcurrentHashMap 是一个 Segment 数组，Segment 通过继承 ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427214612.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>concurrencyLevel：并行级别、Segment 数量。</li>
<li>默认为 16，即拥有 16 个 segments，理论上同时支持 16 个线程并发写，只要它们的操作分布在不同的 Segment 上。</li>
<li>该值可以在初始化时设定为其他值，但是一点设置不可修改。</li>
<li>每个 Segment 内部类似于 HashMap，但通过继承 ReentrantLock 来保证线程安全。</li>
</ul>
<h3 id=初始化>初始化</h3>
<ul>
<li>initialCapacity: 初始容量，这个值指的是整个 ConcurrentHashMap 的初始容量，实际操作的时候需要平均分给每个 Segment。</li>
<li>loadFactor: 负载因子，之前我们说了，Segment 数量不可变，所以这个负载因子是给每个 Segment 内部使用的。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>,</span>
                         <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>concurrencyLevel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>loadFactor</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>concurrencyLevel</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>concurrencyLevel</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_SEGMENTS</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>concurrencyLevel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MAX_SEGMENTS</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// Find power-of-two sizes best matching arguments
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sshift</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 计算并行级别 ssize，因为要保持并行级别是 2 的 n 次方
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>concurrencyLevel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>sshift</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 我们这里先不要那么烧脑，用默认值，concurrencyLevel 为 16，sshift 为 4
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 那么计算出 segmentShift 为 28，segmentMask 为 15，后面会用到这两个值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segmentShift</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>32</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>sshift</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segmentMask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// initialCapacity 是设置整个 map 初始的大小，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这里根据 initialCapacity 计算 Segment 数组中每个位置可以分到的大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 如 initialCapacity 为 64，那么每个 Segment 或称之为&#34;槽&#34;可以分到 4 个
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>ssize</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ssize</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 默认 MIN_SEGMENT_TABLE_CAPACITY 是 2，这个值也是有讲究的，因为这样的话，对于具体的槽上，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 插入一个元素不至于扩容，插入第二个的时候才会扩容
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MIN_SEGMENT_TABLE_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 创建 Segment 数组，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 并创建数组的第一个元素 segment[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s0</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>),</span>
                         <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>cap</span><span style=color:#ce5c00;font-weight:700>]);</span>
    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>ssize</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#8f5902;font-style:italic>// 往数组写入 segment[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// ordered write of segments[0]
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segments</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当使用无参构造器创建 ConcurrentHashMap 实例时，初始化完成后的状态如下：</p>
<ul>
<li>Segment 数组长度为 16，不可以扩容</li>
<li><code>Segment[i]</code> 的默认大小为 2，负载因子是 0.75，得出初始阈值为 1.5，也就是以后插入第一个元素不会触发扩容，插入第二个会进行第一次扩容</li>
<li>这里初始化了 <code>segment[0]</code>，其他位置还是 null，至于为什么要初始化 <code>segment[0]</code>，后面的代码会介绍</li>
<li>当前 segmentShift 的值为 32 - 4 = 28，segmentMask 为 16 - 1 = 15，姑且把它们简单翻译为移位数和掩码，这两个值马上就会用到</li>
</ul>
<h3 id=put-过程分析>put 过程分析</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 1. 计算 key 的 hash 值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 2. 根据 hash 值找到 Segment 数组中的位置 j
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    hash 是 32 位，无符号右移 segmentShift(28) 位，剩下高 4 位，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    然后和 segmentMask(15) 做一次与操作，也就是说 j 是 hash 值的高 4 位，也就是槽的数组下标
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>segmentShift</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>segmentMask</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 刚刚说了，初始化的时候初始化了 segment[0]，但是其他位置还是 null，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// ensureSegment(j) 对 segment[j] 进行初始化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span>          <span style=color:#8f5902;font-style:italic>// nonvolatile; recheck
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>segments</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//  in ensureSegment
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ensureSegment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 3. 插入新值到 槽 s 中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>第一层操作较简单，基于 hash 值找到对应的 segment，之后执行 segment 内部的 put 操作。</p>
<p>Segment 内部由 数组+链表 构成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 在往该 segment 写入前，需要先获取该 segment 的独占锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    先看主流程，后面还会具体介绍这部分内容
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tryLock</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>scanAndLockForPut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>V</span> <span style=color:#000>oldValue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这个是 segment 内部的数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 再利用 hash 值，求应该放置的数组下标
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// first 是数组该位置处的链表的表头
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entryAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// 下面这串 for 循环虽然很长，不过也很好理解，想想该位置没有任何元素和已经存在一个链表这两种情况
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>K</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 覆盖旧值
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 继续顺着链表走
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// node 到底是不是 null，这个要看获取锁的过程，不过和这里都没有关系。
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 如果不为 null，那就直接将它设置为链表表头；如果是null，初始化并设置为链表表头。
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 如果超过了该 segment 的阈值，这个 segment 需要扩容
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>rehash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 扩容后面也会具体分析
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#8f5902;font-style:italic>// 没有达到阈值，将 node 放到数组 tab 的 index 位置，
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 其实就是将新的节点设置成原链表的表头
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>setEntryAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>modCount</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>oldValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 解锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldValue</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>由于有独占锁的保护，所以 segment 内部的操作并不复杂。</p>
<p>下面为其中的关键函数：</p>
<h4 id=初始化槽ensuresegment>初始化槽：ensureSegment</h4>
<p>ConcurrentHashMap 初始化的时候会初始化第一个槽 <code>segment[0]</code>，对于其他槽来说，在插入第一个值的时候才进行初始化。</p>
<p>这里需要考虑并发，因为很可能会有多个线程同时进来初始化同一个槽 <code>segment[k]</code>，不过只要有一个成功了就可以。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ensureSegment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>segments</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// raw offset
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>seg</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这里看到为什么之前要初始化 segment[0] 了，
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 使用当前 segment[0] 处的数组长度和负载因子来初始化 segment[k]
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 为什么要用“当前”，因为 segment[0] 可能早就扩容过了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>proto</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>proto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>lf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>proto</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>loadFactor</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>lf</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// 初始化 segment[k] 内部的数组
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>cap</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 再次检查一遍该槽是否被其他线程初始化了。
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>lf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 使用 while 循环，内部用 CAS，当前线程成功设值或其他线程成功设值后，退出
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span>
                   <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>seg</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>seg</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对于并发操作使用 CAS 进行控制。</p>
<h4 id=获取写入锁-scanandlockforput>获取写入锁: scanAndLockForPut</h4>
<p>在往某个 segment 中 put 的时候，首先会调用 <code>node = tryLock() ? null : scanAndLockForPut(key, hash, value)</code>，也就是说先进行一次 tryLock() 快速获取该 segment 的独占锁，如果失败，那么进入到 scanAndLockForPut 这个方法来获取锁。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>scanAndLockForPut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entryForHash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// negative while locating node
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 循环获取锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>tryLock</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// to recheck first below
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// speculatively create node
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 进到这里说明数组该位置的链表是空的，没有任何元素
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 当然，进到这里的另一个原因是 tryLock() 失败，所以该槽存在并发，不一定是该位置
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>// 顺着链表往下走
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 重试次数如果超过 MAX_SCAN_RETRIES(单核1多核64)，那么不抢了，进入到阻塞队列等待锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//    lock() 是阻塞方法，直到获取锁后返回
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_SCAN_RETRIES</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                 <span style=color:#8f5902;font-style:italic>// 这个时候是有大问题了，那就是有新的元素进到了链表，成为了新的表头
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#8f5902;font-style:italic>//     所以这边的策略是，相当于重新走一遍这个 scanAndLockForPut 方法
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>entryForHash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// re-traverse if entry changed
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>retries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法有两个出口，一个是 tryLock() 成功了，循环终止，另一个就是重试次数超过了 MAX_SCAN_RETRIES，进到 lock() 方法，此方法会阻塞等待，直到成功拿到独占锁。</p>
<p>这个方法就是看似复杂，但是其实就是做了一件事，那就是获取该 segment 的独占锁，如果需要的话顺便实例化了一下 node。</p>
<h4 id=扩容rehash>扩容：rehash</h4>
<ul>
<li>
<p>segment 数组不能扩容，扩容是 segment 数组某个位置内部的数组 <code>HashEntry&lt;K,V>[] </code> 进行扩容，扩容后，容量为原来的 2 倍。</p>
</li>
<li>
<p>执行 put 时，如果判断该值的插入会导致 segment 的元素个数超过阈值，需要先扩容再插入。</p>
</li>
</ul>
<p>因为这时已经持有了 segment 的独占锁，因此无需再考虑并发：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 方法参数上的 node 是这次扩容后，需要添加到新的数组中的数据。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rehash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>oldTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldTable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 2 倍
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>threshold</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>loadFactor</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 创建新数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>newTable</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>newCapacity</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#8f5902;font-style:italic>// 新的掩码，如从 16 扩容到 32，那么 sizeMask 为 31，对应二进制 ‘000...00011111’
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sizeMask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// 遍历原数组，老套路，将原数组位置 i 处的链表拆分到 新数组位置 i 和 i+oldCap 两个位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// e 是链表的第一个元素
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 计算应该放置在新数组中的位置，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 假设原数组长度为 16，e 在 oldTable[3] 处，那么 idx 只可能是 3 或者是 3 + 16 = 19
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#8f5902;font-style:italic>// 该位置处只有一个元素，那比较好办
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Reuse consecutive sequence at same slot
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// e 是链表表头
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// idx 是当前链表的头结点 e 的新位置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lastIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>idx</span><span style=color:#ce5c00;font-weight:700>;</span>

                <span style=color:#8f5902;font-style:italic>// 下面这个 for 循环会找到一个 lastRun 节点，这个节点之后的所有元素是将要放到一起的
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                     <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                     <span style=color:#000>last</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>lastIdx</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>lastIdx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>last</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>// 将 lastRun 及其之后的所有节点组成的这个链表放到 lastIdx 这个位置
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>lastIdx</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 下面的操作是处理 lastRun 之前的节点，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//    这些节点可能分配在另一个链表中，也可能分配到上面的那个链表中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>V</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 将新来的 node 放到新数组中刚刚的 两个链表之一 的 头部
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nodeIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>sizeMask</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// add the new node
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>nodeIndex</span><span style=color:#ce5c00;font-weight:700>]);</span>
    <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>nodeIndex</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newTable</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扩容过程中有两个 for 循环。如果没有第一个 for 循环也是可以工作的，但是在首个 for 循环中，如果 lastRun 的后面还有比较多的节点，那么首次循环就值得。因为我们要克隆 lastRun 前面的节点，后面的一串节点跟着 lastRun 走就可以了，无需其他操作。</p>
<p>比较坏的情况是每次 lastRun 都是链表的最后一个元素或者很靠后的元素，那么就会比较浪费。基于 Doug Lea 的说法，如果使用默认的阈值，大约只有 1/6 的节点需要克隆。</p>
<h4 id=get-过程分析>get 过程分析</h4>
<ul>
<li>计算 hash 值，找到 segment 的数组下标，得到 segment</li>
<li>segment 中也是一个数组，根据 hash 找到数据中的位置</li>
<li>得到链表，顺着链表查找即可</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// manually integrate access methods to reduce overhead
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 1. hash 值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>u</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>segmentShift</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>segmentMask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>SSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SBASE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 2. 根据 hash 找到对应的 segment
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Segment</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>segments</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>u</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 3. 找到segment 内部数组相应位置的链表，遍历
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HashEntry</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span>
                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)(((</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>TSHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>TBASE</span><span style=color:#ce5c00;font-weight:700>);</span>
             <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>K</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=并发问题分析>并发问题分析</h4>
<ul>
<li>
<p>注意 get 操作并未加锁。</p>
</li>
<li>
<p>添加节点的操作 put 和删除节点的操作 remove 都是要加 segment 上的独占锁的，所以它们之间自然不会有问题。</p>
</li>
<li>
<p>我们需要考虑的问题就是 get 的时候在同一个 segment 中发生了 put 或 remove 操作。</p>
</li>
<li>
<p>put 操作的安全性：</p>
<ul>
<li>初始化槽，这个我们之前就说过了，使用了 CAS 来初始化 Segment 中的数组。</li>
<li>添加节点到链表的操作是插入到表头的，所以，如果这个时候 get 操作在链表遍历的过程已经到了中间，是不会影响的。当然，另一个并发问题就是 get 操作在 put 之后，需要保证刚刚插入表头的节点被读取，这个依赖于 setEntryAt 方法中使用的 UNSAFE.putOrderedObject。</li>
<li>扩容。扩容是新创建了数组，然后进行迁移数据，最后面将 newTable 设置给属性 table。所以，如果 get 操作此时也在进行，那么也没关系，如果 get 先行，那么就是在旧的 table 上做查询操作；而 put 先行，那么 put 操作的可见性保证就是 table 使用了 volatile 关键字。</li>
</ul>
</li>
<li>
<p>remove 操作的线程安全性：</p>
<ul>
<li>get 操作需要遍历链表，但是 remove 操作会"破坏"链表。</li>
<li>如果 remove 破坏的节点 get 操作已经过去了，那么这里不存在任何问题。</li>
<li>如果 remove 先破坏了一个节点，分两种情况考虑。
<ul>
<li>1、如果此节点是头结点，那么需要将头结点的 next 设置为数组该位置的元素，table 虽然使用了 volatile 修饰，但是 volatile 并不能提供数组内部操作的可见性保证，所以源码中使用了 UNSAFE 来操作数组，请看方法 setEntryAt。</li>
<li>2、如果要删除的节点不是头结点，它会将要删除节点的后继节点接到前驱节点中，这里的并发保证就是 next 属性是 volatile 的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=jdk-18-concurrenthashmap>JDK 1.8-ConcurrentHashMap</h2>
<p>在 JDK 1.7 之前，ConcurrentHashMap 是通过分段锁机制来实现的，所以其最大并发度受 Segment 的个数限制。因此，在 JDK1.8 中，ConcurrentHashMap 的实现原理摒弃了这种设计，而是选择了与 HashMap 类似的数组+链表+红黑树的方式实现，而加锁则采用 CAS 和 synchronized 实现。</p>
<h3 id=数据结构-1>数据结构</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427224730.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=初始化-1>初始化</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 这构造函数里，什么都不干
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>initialCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cap</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span>
               <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>:</span>
               <span style=color:#000>tableSizeFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cap</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过提供的初始容量，计算了 sizeCtl，<code>sizeCtl = 【 (1.5 * initialCapacity + 1)，然后向上取最近的 2 的 n 次方】</code>，如果 initialCapacity 为 10，那么得到 sizeCtl 为 16，如果 initialCapacity 为 11，sizeCtl 为 32。</p>
<h3 id=put-过程分析-1>put 过程分析</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>putVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>V</span> <span style=color:#000>putVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>K</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 得到 hash 值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#8f5902;font-style:italic>// 用于记录相应链表的长度
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fh</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 如果数组&#34;空&#34;，进行数组初始化
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 初始化数组，后面会详细介绍
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initTable</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// 找该 hash 值对应的数组下标，得到第一个节点 f
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 如果数组该位置为空，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//    用一次 CAS 操作将这个新值放入其中即可，这个 put 操作差不多就结束了，可以拉到最后面了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//          如果 CAS 失败，那就是有并发操作，进到下一个循环就好了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>casTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span>
                         <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>// no lock when adding to empty bin
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// hash 居然可以等于 MOVED，这个需要到后面才能看明白，不过从名字上也能猜到，肯定是因为在扩容
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MOVED</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 帮助数据迁移，这个等到看完数据迁移部分的介绍后，再理解这个就很简单了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>helpTransfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 到这里就是说，f 是该位置的头结点，而且不为空
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#000>V</span> <span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 获取数组该位置的头结点的监视器锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 头结点的 hash 值大于 0，说明是链表
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// 用于累加，记录链表的长度
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#8f5902;font-style:italic>// 遍历链表
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>binCount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>K</span> <span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#8f5902;font-style:italic>// 如果发现了&#34;相等&#34;的 key，判断是否要进行值覆盖，然后也就可以 break 了
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                                <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span>
                                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#8f5902;font-style:italic>// 到了链表的最末端，将这个新值放到链表的最后面
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                          <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 红黑树
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#8f5902;font-style:italic>// 调用红黑树的插值方法插入新节点
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>putTreeVal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                       <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>onlyIfAbsent</span><span style=color:#ce5c00;font-weight:700>)</span>
                                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 判断是否要将链表转换为红黑树，临界值和 HashMap 一样，也是 8
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>binCount</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>TREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#8f5902;font-style:italic>// 这个方法和 HashMap 中稍微有一点点不同，那就是它不是一定会进行红黑树转换，
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 如果当前数组的长度小于 64，那么会选择进行数组扩容，而不是转换为红黑树
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>//    具体源码我们就不看了，扩容部分后面说
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>treeifyBin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldVal</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>oldVal</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>addCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>binCount</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=初始化数组inittable>初始化数组：initTable</h4>
<p>初始化一个合适大小的数组，然后会设置 sizeCtl。初始化方法中的并发问题通过对 sizeCtl 执行一个 CAS 操作来控制的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>initTable</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 初始化的&#34;功劳&#34;被其他线程&#34;抢去&#34;了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeCtl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>yield</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// lost initialization race; just spin
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// CAS 一下，将 sizeCtl 设置为 -1，代表抢到了锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// DEFAULT_CAPACITY 默认初始容量是 16
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>DEFAULT_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 初始化数组，长度为 16 或初始化时提供的长度
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;[</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#8f5902;font-style:italic>// 将这个数组赋值给 table，table 是 volatile 的
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 如果 n 为 16 的话，那么这里 sc = 12
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 其实就是 0.75 * n
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 设置 sizeCtl 为 sc，我们就当是 12 吧
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=链表转红黑树treeifybin>链表转红黑树：treeifyBin</h4>
<p>treeifyBin 不一定就会进行红黑树转换，也可能是仅仅做数组扩容。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>treeifyBin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// MIN_TREEIFY_CAPACITY 为 64
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 所以，如果数组长度小于 64 的时候，其实也就是 32 或者 16 或者更小的时候，会进行数组扩容
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MIN_TREEIFY_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 后面我们再详细分析这个方法
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tryPresize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// b 是头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 加锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>// 下面就是遍历链表，建立一颗红黑树
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span>
                            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>,</span>
                                              <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#000>hd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>else</span>
                            <span style=color:#000>tl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>tl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>// 将红黑树设置到数组相应位置中
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hd</span><span style=color:#ce5c00;font-weight:700>));</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=扩容trypresize>扩容：tryPresize</h4>
<p>扩容也是做翻倍扩容的，扩容后数组容量为原来的 2 倍。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 首先要说明的是，方法参数 size 传进来的时候就已经翻了倍了
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>tryPresize</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// c: size 的 1.5 倍，再加 1，再往上取最近的 2 的 n 次方。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>MAXIMUM_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>tableSizeFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeCtl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 这个 if 分支和之前说的初始化数组的代码基本上是一样的，在这里，我们可以不用管这块代码
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;[</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>];</span>
                        <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 0.75 * n
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MAXIMUM_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 我没看懂 rs 的真正含义是什么，不过也关系不大
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>resizeStamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>RESIZE_STAMP_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>MAX_RESIZERS</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#000>transferIndex</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 2. 用 CAS 将 sizeCtl 加 1，然后执行 transfer 方法
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//    此时 nextTab 不为 null
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#000>transfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// 1. 将 sizeCtl 设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//     我是没看懂这个值真正的意义是什么? 不过可以计算出来的是，结果是一个比较大的负数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//  调用 transfer 方法，此时 nextTab 参数为 null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>,</span>
                                         <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>RESIZE_STAMP_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>transfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法的核心在于 sizeCtl 值的操作，首先将其设置为一个负数，然后执行 transfer(tab, null)，再下一个循环将 sizeCtl 加 1，并执行 transfer(tab, nt)，之后可能是继续 sizeCtl 加 1，并执行 transfer(tab, nt)。</p>
<p>所以，可能的操作就是执行 1 次 transfer(tab, null) + 多次 transfer(tab, nt)，这里怎么结束循环的需要看完 transfer 源码才清楚。</p>
<h4 id=数据迁移transfer>数据迁移：transfer</h4>
<p>将原来的 tab 数组的元素迁移到新的 nextTab 数组中。</p>
<p>虽然我们之前说的 tryPresize 方法中多次调用 transfer 不涉及多线程，但是这个 transfer 方法可以在其他地方被调用，典型地，我们之前在说 put 方法的时候就说过了，请往上看 put 方法，是不是有个地方调用了 helpTransfer 方法，helpTransfer 方法会调用 transfer 方法的。</p>
<p>此方法支持多线程执行，外围调用此方法的时候，会保证第一个发起数据迁移的线程，nextTab 参数为 null，之后再调用此方法的时候，nextTab 不会为 null。</p>
<p>阅读源码之前，先要理解并发操作的机制。原数组长度为 n，所以我们有 n 个迁移任务，让每个线程每次负责一个小任务是最简单的，每做完一个任务再检测是否有其他没做完的任务，帮助迁移就可以了，而 Doug Lea 使用了一个 stride，简单理解就是步长，每个线程每次负责迁移其中的一部分，如每次迁移 16 个小任务。所以，我们就需要一个全局的调度者来安排哪个线程执行哪几个任务，这个就是属性 transferIndex 的作用。</p>
<p>第一个发起数据迁移的线程会将 transferIndex 指向原数组最后的位置，然后从后往前的 stride 个任务属于第一个线程，然后将 transferIndex 指向新的位置，再往前的 stride 个任务属于第二个线程，依此类推。当然，这里说的第二个线程不是真的一定指代了第二个线程，也可以是同一个线程，这个读者应该能理解吧。其实就是将一个大的迁移任务分为了一个个任务包。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>transfer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stride</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// stride 在单核下直接等于 n，多核模式下为 (n&gt;&gt;&gt;3)/NCPU，最小值是 16
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// stride 可以理解为”步长“，有 n 个位置是需要进行迁移的，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//   将这 n 个任务分为多个任务包，每个任务包有 stride 个任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>MIN_TRANSFER_STRIDE</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MIN_TRANSFER_STRIDE</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// subdivide range
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>// 如果 nextTab 为 null，先进行一次初始化
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    前面我们说了，外围会保证第一个发起迁移的线程调用此方法时，参数 nextTab 为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//       之后参与迁移的线程调用此方法时，nextTab 不会为 null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 容量翻倍
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>nt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[])</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;?,?&gt;[</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#000>nextTab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nt</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#8f5902;font-style:italic>// try to cope with OOME
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// nextTable 是 ConcurrentHashMap 中的属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>nextTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// transferIndex 也是 ConcurrentHashMap 的属性，用于控制迁移的位置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>transferIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>// ForwardingNode 翻译过来就是正在被迁移的 Node
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这个构造方法会生成一个Node，key、value 和 next 都为 null，关键是 hash 为 MOVED
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 后面我们会看到，原数组中位置 i 处的节点完成迁移工作后，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    就会将位置 i 处设置为这个 ForwardingNode，用来告诉其他线程该位置已经处理过了
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//    所以它其实相当于是一个标志。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ForwardingNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fwd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForwardingNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>);</span>


    <span style=color:#8f5902;font-style:italic>// advance 指的是做完了一个位置的迁移工作，可以准备做下一个位置的了
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>finishing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// to ensure sweep before committing nextTab
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * 下面这个 for 循环，最难理解的在前面，而要看懂它们，应该先看懂后面的，然后再倒回来看
</span><span style=color:#8f5902;font-style:italic>     * 
</span><span style=color:#8f5902;font-style:italic>     */</span>

    <span style=color:#8f5902;font-style:italic>// i 是位置索引，bound 是边界，注意是从后往前
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>fh</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 下面这个 while 真的是不好理解
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// advance 为 true 表示可以进行下一个位置的迁移了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   简单理解结局: i 指向了 transferIndex，bound 指向了 transferIndex-stride
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>advance</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextIndex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextBound</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>bound</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>finishing</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#8f5902;font-style:italic>// 将 transferIndex 值赋给 nextIndex
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 这里 transferIndex 一旦小于等于 0，说明原数组的所有位置都有相应的线程去处理了
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>transferIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span>
                     <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TRANSFERINDEX</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextIndex</span><span style=color:#ce5c00;font-weight:700>,</span>
                      <span style=color:#000>nextBound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>?</span>
                                   <span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>stride</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 看括号中的代码，nextBound 是这次迁移任务的边界，注意，是从后往前
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>bound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextBound</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextIndex</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>nextn</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>finishing</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 所有的迁移操作已经完成
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>nextTable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 将新的 nextTab 赋值给 table 属性，完成迁移
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>table</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 重新计算 sizeCtl: n 是原数组长度，所以 sizeCtl 得出的值将是新数组长度的 0.75 倍
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>sizeCtl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#8f5902;font-style:italic>// 之前我们说过，sizeCtl 在迁移前会设置为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 然后，每有一个线程参与迁移就会将 sizeCtl 加 1，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 这里使用 CAS 操作对 sizeCtl 进行减 1，代表做完了属于自己的任务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SIZECTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sizeCtl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 任务结束，方法退出
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sc</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>resizeStamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>RESIZE_STAMP_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>

                <span style=color:#8f5902;font-style:italic>// 到这里，说明 (sc - 2) == resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 也就是说，所有的迁移任务都做完了，也就会进入到上面的 if(finishing){} 分支了
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>finishing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// recheck before commit
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 如果位置 i 处是空的，没有任何节点，那么放入刚刚初始化的 ForwardingNode ”空节点“
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>casTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fwd</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 该位置处是一个 ForwardingNode，代表该位置已经迁移过了
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>MOVED</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// already processed
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 对数组该位置处的结点加锁，开始处理数组该位置处的迁移工作
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// 头结点的 hash 大于 0，说明是链表的 Node 节点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 下面这一块和 Java7 中的 ConcurrentHashMap 迁移是差不多的，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// 需要将链表一分为二，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//   找到原链表中的 lastRun，然后 lastRun 及其之后的节点是一起进行迁移的
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//   lastRun 之前的节点需要进行克隆，然后分到两个链表中
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runBit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fh</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>runBit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>runBit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>lastRun</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runBit</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>lastRun</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ph</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>K</span> <span style=color:#000>pk</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>V</span> <span style=color:#000>pv</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ph</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                                <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>else</span>
                                <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>ph</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pk</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pv</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#8f5902;font-style:italic>// 其中的一个链表放在新数组的位置 i
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 另一个链表放在新数组的位置 i+n
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fwd</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// advance 设置为 true，代表该位置已经迁移完毕
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 红黑树的迁移
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;)</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>first</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
                                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>lo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>else</span>
                                    <span style=color:#000>loTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>loTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>lc</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                                    <span style=color:#000>hi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#204a87;font-weight:700>else</span>
                                    <span style=color:#000>hiTail</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#000>hiTail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
                                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>hc</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#8f5902;font-style:italic>// 如果一分为二后，节点数少于 8，那么将红黑树转换回链表
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>ln</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>UNTREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>untreeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>lo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>hn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hc</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>UNTREEIFY_THRESHOLD</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>untreeify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lc</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TreeBin</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>hi</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>

                        <span style=color:#8f5902;font-style:italic>// 将 ln 放置在新数组的位置 i
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ln</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 将 hn 放置在新数组的位置 i+n
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hn</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// 将原数组该位置处设置为 fwd，代表该位置已经处理完毕，
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>//    其他线程一旦看到该位置的 hash 值为 MOVED，就不会进行迁移了
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>setTabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fwd</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// advance 设置为 true，代表该位置已经迁移完毕
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>advance</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>transfer 这个方法并没有实现所有的迁移任务，每次调用这个方法只实现了 transferIndex 往前 stride 个位置的迁移工作，其他的需要由外围来控制。</p>
<h4 id=get-过程分析-1>get 过程分析</h4>
<ul>
<li>计算 hash 值</li>
<li>根据 hash 值找到数组对应位置: <code>(n - 1) & h</code></li>
<li>根据该位置处结点性质进行相应查找
<ul>
<li>如果该位置为 null，那么直接返回 null 就可以了</li>
<li>如果该位置处的节点刚好就是我们需要的，返回该节点的值即可</li>
<li>如果该位置节点的 hash 值小于 0，说明正在扩容，或者是红黑树，后面我们再介绍 find 方法</li>
<li>如果以上 3 条都不满足，那就是链表，进行遍历比对即可</li>
</ul>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;[]</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>K</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eh</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>K</span> <span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tabAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 判断头结点是否就是我们需要的节点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>eh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>)))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 如果头结点的 hash 小于 0，说明 正在扩容，或者该位置是红黑树
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>eh</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 参考 ForwardingNode.find(int h, Object k) 和 TreeBin.find(int h, Object k)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// 遍历链表
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ek</span><span style=color:#ce5c00;font-weight:700>))))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>val</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当遇到扩容时的情况最为复杂，<code>ForwardingNode.find(int h, Object k)</code>。</p>
<h2 id=对比总结>对比总结</h2>
<ul>
<li><code>HashTable</code>: 使用了synchronized关键字对put等操作进行加锁;</li>
<li><code>ConcurrentHashMap JDK1.7</code>: 使用分段锁机制实现;</li>
<li><code>ConcurrentHashMap JDK1.8</code>: 则使用数组+链表+红黑树数据结构和 CAS 原子操作实现;</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-025dc4d4563b49f365f1ecc48d1d8dc5>3.18 - CH18-ConcurrentLinkedQueue</h1>
<ul>
<li>基于链接节点的无界线程安全队列。</li>
<li>此队列按照 FIFO(先进先出)原则对元素进行排序。</li>
<li>队列的头部是队列中时间最长的元素。</li>
<li>队列的尾部是队列中时间最短的元素。</li>
<li>新的元素插入到队列的尾部，队列获取操作从队列头部获得元素。</li>
<li>当多个线程共享访问一个公共 collection 时，ConcurrentLinkedQueue 是一个恰当的选择。</li>
<li>此队列不允许使用 null 元素。</li>
</ul>
<h2 id=数据结构>数据结构</h2>
<p>与 LinkedBlockingQueue 的数据结构相同，都是使用的链表结构。ConcurrentLinkedQueue 的数据结构如下:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427230324.png style=display:block;width:50% alt=NAME align=center> </div>
<p>ConcurrentLinkedQueue 采用的链表结构，并且包含有一个头结点和一个尾结点。</p>
<h2 id=源码分析>源码分析</h2>
<h3 id=层级结构>层级结构</h3>
<ul>
<li>
<p>继承了抽象类 AbstractQueue，AbstractQueue 定义了对队列的基本操作；</p>
</li>
<li>
<p>同时实现了 Queue 接口，Queue 定义了对队列的基本操作，</p>
</li>
<li>
<p>同时，还实现了 Serializable 接口，表示可以被序列化。</p>
</li>
</ul>
<h3 id=内部类>内部类</h3>
<p>Node 类表示链表结点，用于存放元素，包含 item 域和 next 域，item 域表示元素，next 域表示下一个结点，其利用反射机制和 CAS 机制来更新 item 域和 next 域，保证原子性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>E</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// next域
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>        * Constructs a new node.  Uses relaxed write because item can
</span><span style=color:#8f5902;font-style:italic>        * only be seen after publication via casNext.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 构造函数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置item的值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 比较并替换item值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>casItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>cmp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>itemOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cmp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>lazySetNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置next域的值，并不会保证修改对其他线程立即可见
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 比较并替换next域的值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>casNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cmp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cmp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>val</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// Unsafe mechanics
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 反射机制
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// item域的偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>itemOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// next域的偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nextOffset</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>UNSAFE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>itemOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;item&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>nextOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;next&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=类的属性>类的属性</h3>
<p>属性中包含了 head 域和 tail 域，表示链表的头结点和尾结点，同时，ConcurrentLinkedQueue 也使用了反射机制和 CAS 机制来更新头结点和尾结点，保证原子性。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
        <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本序列号        
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>196745693267521676L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 反射机制
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// head域的偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>headOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// tail域的偏移量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>tailOffset</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>UNSAFE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sun</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>misc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Unsafe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUnsafe</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>headOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;head&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#000>tailOffset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>objectFieldOffset</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getDeclaredField</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tail&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 头结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 尾结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=类的构造函数>类的构造函数</h3>
<ul>
<li><code>ConcurrentLinkedQueue()</code>型构造函数
<ul>
<li>该构造函数用于创建一个最初为空的 ConcurrentLinkedQueue，头结点与尾结点指向同一个结点，该结点的item域为null，next域也为null。</li>
</ul>
</li>
<li><code>ConcurrentLinkedQueue(Collection&lt;? extends E>)</code>型构造函数
<ul>
<li>该构造函数用于创建一个最初包含给定 collection 元素的 ConcurrentLinkedQueue，按照此 collection 迭代器的遍历顺序来添加元素。</li>
</ul>
</li>
</ul>
<h3 id=核心函数>核心函数</h3>
<h4 id=offer>offer</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 元素不为null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>checkNotNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 新生一个结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>newNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// q为p结点的下一个结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// q结点为null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// p is last node
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>casNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 比较并进行替换p结点的next域
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// Successful CAS is the linearization point
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// for e to become an element of this queue,
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// and for newNode to become &#34;live&#34;.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// p不等于t结点，不一致    // hop two nodes at a time
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 比较并替换尾结点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>casTail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newNode</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// Failure is OK.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 返回
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// Lost CAS race to another thread; re-read next
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// p结点等于q结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// We have fallen off list.  If tail is unchanged, it
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// will also be off-list, in which case we need to
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// jump to head, from which all live nodes are always
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// reachable.  Else the new tail is a better bet.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 原来的尾结点与现在的尾结点是否相等，若相等，则p赋值为head，否则，赋值为现在的尾结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#8f5902;font-style:italic>// Check for tail updates after two hops.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 重新赋值p结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>offer 函数用于将指定元素插入此队列的尾部。下面模拟 offer 函数的操作，队列状态的变化(假设单线程添加元素，连续添加10、20两个元素)。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427230742.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>若ConcurrentLinkedQueue的初始状态如上图所示，即队列为空。单线程添加元素，此时，添加元素10，则状态如下所示</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427230818.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>如上图所示，添加元素10后，tail没有变化，还是指向之前的结点，继续添加元素20，则状态如下所示</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427230844.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>如上图所示，添加元素20后，tail指向了最新添加的结点。</li>
</ul>
<h4 id=poll>poll</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>restartFromHead</span><span style=color:#ce5c00;font-weight:700>:</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 保存头结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// item项
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>E</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>casItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// item不为null并且比较并替换item成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// Successful CAS is the linearization point
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// for item to be removed from this queue.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// p不等于h    // hop two nodes at a time
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 更新头结点
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>updateHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span> 
                <span style=color:#8f5902;font-style:italic>// 返回item
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// q结点为null
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 更新头结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>updateHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// p等于q
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 继续循环
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>continue</span> <span style=color:#000>restartFromHead</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>// p赋值为q
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数用于获取并移除此队列的头，如果此队列为空，则返回 null。</p>
<p>下面模拟 poll 函数的操作，队列状态的变化(假设单线程操作，状态为之前 offer10、20 后的状态，poll 两次)。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427230945.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>队列初始状态如上图所示，在poll操作后，队列的状态如下图所示</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427231003.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>如上图可知，poll操作后，head改变了，并且head所指向的结点的item变为了null。再进行一次poll操作，队列的状态如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/java-thread-x-juc-concurrentlinkedqueue-7.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>如上图可知，poll操作后，head结点没有变化，只是指示的结点的item域变成了null。</li>
</ul>
<h4 id=remove>remove</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 元素为null，返回
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>o</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 获取第一个存活的结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 第一个存活结点的item值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>E</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>o</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>casItem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 找到item相等的结点，并且将该结点的item设置为null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// p的后继结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// pred不为null并且next不为null
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 比较并替换next域
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>casNext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// pred赋值为p
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数用于从队列中移除指定元素的单个实例(如果存在)。其中，会调用到first函数和succ函数，first函数的源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>restartFromHead</span><span style=color:#ce5c00;font-weight:700>:</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环，确保成功
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// p结点的item域是否为null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasItem</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasItem</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// item不为null或者next域为null
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 更新头结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>updateHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 返回结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>hasItem</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// p等于q
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 继续从头结点开始
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>continue</span> <span style=color:#000>restartFromHead</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>// p赋值为q
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>first函数用于找到链表中第一个存活的结点。</p>
<p>succ函数源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// p结点的next域
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 如果next域为自身，则返回头结点，否则，返回next
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>succ用于获取结点的下一个结点。如果结点的next域指向自身，则返回head头结点，否则，返回next结点。</p>
<p>下面模拟remove函数的操作，队列状态的变化(假设单线程操作，状态为之前offer10、20后的状态，执行remove(10)、remove(20)操作)。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427231240.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>如上图所示，为ConcurrentLinkedQueue的初始状态，remove(10)后的状态如下图所示</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427231305.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>如上图所示，当执行remove(10)后，head指向了head结点之前指向的结点的下一个结点，并且head结点的item域置为null。继续执行remove(20)，状态如下图所示</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427231320.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>如上图所示，执行remove(20)后，head与tail指向同一个结点，item域为null。</li>
</ul>
<h4 id=size>size</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 计数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 从第一个存活的结点开始往后遍历
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 结点的item域不为null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// Collection.size() spec says to max out
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 增加计数，若达到最大值，则跳出循环
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 返回大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数用于返回ConcurrenLinkedQueue的大小，从第一个存活的结点(first)开始，往后遍历链表，当结点的item域不为null时，增加计数，之后返回大小。</p>
<h2 id=应用示例>应用示例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PutThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PutThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;add &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>GetThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>GetThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;poll &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>());</span>
                <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConcurrentLinkedQueueDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>clq</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentLinkedQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#000>PutThread</span> <span style=color:#000>p1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PutThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>GetThread</span> <span style=color:#000>g1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>GetThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clq</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>g1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>GetThread 线程不会因为 ConcurrentLinkedQueue 队列为空而等待，而是直接返回 null，所以当实现队列不空时，等待时，则需要用户自己实现等待逻辑。</p>
<h2 id=深入理解>深入理解</h2>
<h3 id=hops延迟更新策略>HOPS：延迟更新策略</h3>
<p>通过上面对offer和poll方法的分析，我们发现tail和head是延迟更新的，两者更新触发时机为：</p>
<ul>
<li><code>tail更新触发时机</code>：当tail指向的节点的下一个节点不为null的时候，会执行定位队列真正的队尾节点的操作，找到队尾节点后完成插入之后才会通过casTail进行tail更新；当tail指向的节点的下一个节点为null的时候，只插入节点不更新tail。</li>
<li><code>head更新触发时机</code>：当head指向的节点的item域为null的时候，会执行定位队列真正的队头节点的操作，找到队头节点后完成删除之后才会通过updateHead进行head更新；当head指向的节点的item域不为null的时候，只删除节点不更新head。</li>
</ul>
<p>并且在更新操作时，源码中会有注释为：<code>hop two nodes at a time</code>。所以这种延迟更新的策略就被叫做HOPS的大概原因是这个，从上面更新时的状态图可以看出，head和tail的更新是“跳着的”即中间总是间隔了一个。那么这样设计的意图是什么呢?</p>
<p>如果让tail永远作为队列的队尾节点，实现的代码量会更少，而且逻辑更易懂。但是，这样做有一个缺点，如果大量的入队操作，每次都要执行CAS进行tail的更新，汇总起来对性能也会是大大的损耗。如果能减少CAS更新的操作，无疑可以大大提升入队的操作效率，所以doug lea大师每间隔1次(tail和队尾节点的距离为1)进行才利用CAS更新tail。对head的更新也是同样的道理，虽然，这样设计会多出在循环中定位队尾节点，但总体来说读的操作效率要远远高于写的性能，因此，多出来的在循环中定位尾节点的操作的性能损耗相对而言是很小的。</p>
<h3 id=适用场景>适用场景</h3>
<p>通过无锁来做到了更高的并发量，是个高性能的队列，但是使用场景相对不如阻塞队列常见，毕竟取数据也要不停的去循环，不如阻塞的逻辑好设计，但是在并发量特别大的情况下，是个不错的选择，性能上好很多，而且这个队列的设计也是特别费力，尤其的使用的改良算法和对哨兵的处理。整体的思路都是比较严谨的，这个也是使用了无锁造成的，我们自己使用无锁的条件的话，这个队列是个不错的参考。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3dcb9474214521fb1ab9ff953293cf08>3.19 - CH19-BlockingQueue</h1>
<h2 id=blockingqueue>BlockingQueue</h2>
<p>通常用于一个线程生产对象，而另外一个线程消费这些对象的场景。下图是对这个原理的阐述:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427232026.png style=display:block;width:50% alt=NAME align=center> </div>
<p>一个线程将会持续生产新对象并将其插入到队列之中，直到队列达到它所能容纳的临界点。也就是说，它是有限的。如果该阻塞队列到达了其临界点，负责生产的线程将会在往里边插入新对象时发生阻塞。它会一直处于阻塞之中，直到负责消费的线程从队列中拿走一个对象。 负责消费的线程将会一直从该阻塞队列中拿出对象。如果消费线程尝试去从一个空的队列中提取对象的话，这个消费线程将会处于阻塞之中，直到一个生产线程把一个对象丢进队列。</p>
<h3 id=操作方法>操作方法</h3>
<p>具有 4 组不同的方法用于插入、移除以及对队列中的元素进行检查。如果请求的操作不能得到立即执行的话，每个方法的表现也不同。这些方法如下:</p>
<table>
<thead>
<tr>
<th></th>
<th>抛异常</th>
<th>布尔值</th>
<th>阻塞</th>
<th>超时</th>
</tr>
</thead>
<tbody>
<tr>
<td>插入</td>
<td>add(o)</td>
<td>offer(o)</td>
<td>put(o)</td>
<td>offer(o,timeout,timeunit)</td>
</tr>
<tr>
<td>移除</td>
<td>remove(o)</td>
<td>poll(o)</td>
<td>take(o)</td>
<td>poll(timeout,timeunit)</td>
</tr>
<tr>
<td>检查</td>
<td>element(o)</td>
<td>peek(o)</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>抛异常：如果试图的操作无法立即执行，抛一个异常。</li>
<li>特定值：如果试图的操作无法立即执行，返回一个特定的值(常常是 true / false)。</li>
<li>阻塞：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行。</li>
<li>超时：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功(典型的是 true / false)。</li>
</ul>
<p>无法向一个 BlockingQueue 中插入 null。如果你试图插入 null，BlockingQueue 将会抛出一个 NullPointerException。</p>
<p>可以访问到 BlockingQueue 中的所有元素，而不仅仅是开始和结束的元素。比如说，你将一个对象放入队列之中以等待处理，但你的应用想要将其取消掉。那么你可以调用诸如 remove(o) 方法来将队列之中的特定对象进行移除。但是这么干效率并不高(译者注: 基于队列的数据结构，获取除开始或结束位置的其他对象的效率不会太高)，因此你尽量不要用这一类的方法，除非你确实不得不那么做。</p>
<h2 id=blockingdeque>BlockingDeque</h2>
<p>BlockingDeque 接口表示一个线程安放入和提取实例的双端队列。</p>
<p>BlockingDeque 类是一个双端队列，在不能够插入元素时，它将阻塞住试图插入元素的线程；在不能够抽取元素时，它将阻塞住试图抽取的线程。 deque(双端队列) 是 &ldquo;Double Ended Queue&rdquo; 的缩写。因此，双端队列是一个你可以从任意一端插入或者抽取元素的队列。</p>
<p>在线程既是一个队列的生产者又是这个队列的消费者的时候可以使用到 BlockingDeque。如果生产者线程需要在队列的两端都可以插入数据，消费者线程需要在队列的两端都可以移除数据，这个时候也可以使用 BlockingDeque。BlockingDeque 图解:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210427232657.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=操作方法-1>操作方法</h3>
<p>一个 BlockingDeque - 线程在双端队列的两端都可以插入和提取元素。 一个线程生产元素，并把它们插入到队列的任意一端。如果双端队列已满，插入线程将被阻塞，直到一个移除线程从该队列中移出了一个元素。如果双端队列为空，移除线程将被阻塞，直到一个插入线程向该队列插入了一个新元素。</p>
<p>BlockingDeque 具有 4 组不同的方法用于插入、移除以及对双端队列中的元素进行检查。如果请求的操作不能得到立即执行的话，每个方法的表现也不同。这些方法如下:</p>
<table>
<thead>
<tr>
<th></th>
<th>抛异常</th>
<th>布尔值</th>
<th>阻塞</th>
<th>超时</th>
</tr>
</thead>
<tbody>
<tr>
<td>队首-插入</td>
<td>addFirst(o)</td>
<td>offerFirst(o)</td>
<td>putFirst(o)</td>
<td>offerFirst(o, timeout, timeunit)</td>
</tr>
<tr>
<td>队首-移除</td>
<td>removeFirst(o)</td>
<td>pollFirst(o)</td>
<td>takeFirst(o)</td>
<td>pollFirst(timeout, timeunit)</td>
</tr>
<tr>
<td>队首-检查</td>
<td>getFirst(o)</td>
<td>peekFirst(o)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>队尾-插入</td>
<td>addLast(o)</td>
<td>offerLast(o)</td>
<td>putLast(o)</td>
<td>offerLast(o, timeout, timeunit)</td>
</tr>
<tr>
<td>队尾-移除</td>
<td>removeLast(o)</td>
<td>pollLast(o)</td>
<td>takeLast(o)</td>
<td>pollLast(timeout, timeunit)</td>
</tr>
<tr>
<td>队尾-检查</td>
<td>getLast(o)</td>
<td>peekLast(o)</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>抛异常：如果试图的操作无法立即执行，抛一个异常。</li>
<li>特定值：如果试图的操作无法立即执行，返回一个特定的值(常常是 true / false)。</li>
<li>阻塞：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行。</li>
<li>超时：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功(典型的是 true / false)。</li>
</ul>
<h2 id=blockingqueue--blockingdeque>BlockingQueue & BlockingDeque</h2>
<p>BlockingDeque 接口继承自 BlockingQueue 接口。这就意味着你可以像使用一个 BlockingQueue 那样使用 BlockingDeque。如果你这么干的话，各种插入方法将会把新元素添加到双端队列的尾端，而移除方法将会把双端队列的首端的元素移除。正如 BlockingQueue 接口的插入和移除方法一样。</p>
<h2 id=应用实例>应用实例</h2>
<p>这里是一个 Java 中使用 BlockingQueue 的示例。本示例使用的是 BlockingQueue 接口的 ArrayBlockingQueue 实现。 首先，BlockingQueueExample 类分别在两个独立的线程中启动了一个 Producer 和 一个 Consumer。Producer 向一个共享的 BlockingQueue 中注入字符串，而 Consumer 则会从中把它们拿出来。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BlockingQueueExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
 
        <span style=color:#000>BlockingQueue</span> <span style=color:#000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayBlockingQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
 
        <span style=color:#000>Producer</span> <span style=color:#000>producer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Producer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Consumer</span> <span style=color:#000>consumer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>);</span>
 
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>producer</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>consumer</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
 
        <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>4000</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以下是 Producer 类。注意它在每次 put() 调用时是如何休眠一秒钟的。这将导致 Consumer 在等待队列中对象的时候发生阻塞。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Producer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>{</span>
 
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BlockingQueue</span> <span style=color:#000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Producer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BlockingQueue</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;3&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以下是 Consumer 类。它只是把对象从队列中抽取出来，然后将它们打印到 System.out。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Consumer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>{</span>
 
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BlockingQueue</span> <span style=color:#000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BlockingQueue</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=arrayblockingqueue>ArrayBlockingQueue</h2>
<p>ArrayBlockingQueue 类实现了 BlockingQueue 接口。</p>
<p>ArrayBlockingQueue 是一个有界的阻塞队列，其内部实现是将对象放到一个数组里。有界也就意味着，它不能够存储无限多数量的元素。它有一个同一时间能够存储元素数量的上限。你可以在对其初始化的时候设定这个上限，但之后就无法对这个上限进行修改了。</p>
<p>ArrayBlockingQueue 内部以 FIFO(先进先出)的顺序对元素进行存储。队列中的头元素在所有元素之中是放入时间最久的那个，而尾元素则是最短的那个。</p>
<h2 id=delayqueue>DelayQueue</h2>
<p>DelayQueue 实现了 BlockingQueue 接口。</p>
<p>DelayQueue是一个无界的 BlockingQueue，用于放置实现了 Delayed 接口的对象，其中的对象只能在其到期时才能从队列中取走。这种队列是有序的，即队头对象的延迟到期时间最长。</p>
<p>元素进入队列后，先进行排序，然后，只有 getDelay 也就是剩余时间为0的时候，该元素才有资格被消费者从队列中取出来，所以构造函数一般都有一个时间传入。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Delayed</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Delayed</span><span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>getDelay</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeUnit</span> <span style=color:#000>timeUnit</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>传递给 getDelay 方法的 getDelay 实例是一个枚举类型，它表明了将要延迟的时间段。</p>
<p>Delayed 接口也继承了 java.lang.Comparable 接口，这也就意味着 Delayed 对象之间可以进行对比。这个可能在对 DelayQueue 队列中的元素进行排序时有用，因此它们可以根据过期时间进行有序释放。 以下是使用 DelayQueue 的例子:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DelayQueueExample</span> <span style=color:#ce5c00;font-weight:700>{</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>DelayQueue</span> <span style=color:#000>queue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelayQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Delayed</span> <span style=color:#000>element1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelayedElement</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>element1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>Delayed</span> <span style=color:#000>element2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=linkedblocingqueue>LinkedBlocingQueue</h2>
<p>LinkedBlockingQueue 类实现了 BlockingQueue 接口。</p>
<p>LinkedBlockingQueue 内部以一个链式结构(链接节点)对其元素进行存储。如果需要的话，这一链式结构可以选择一个上限。如果没有定义上限，将使用 Integer.MAX_VALUE 作为上限。</p>
<p>LinkedBlockingQueue 内部以 FIFO(先进先出)的顺序对元素进行存储。队列中的头元素在所有元素之中是放入时间最久的那个，而尾元素则是最短的那个。</p>
<h2 id=priorityblockingqueue>PriorityBlockingQueue</h2>
<p>PriorityBlockingQueue 类实现了 BlockingQueue 接口。</p>
<p>PriorityBlockingQueue 是一个无界的并发队列。它使用了和类 java.util.PriorityQueue 一样的排序规则。你无法向这个队列中插入 null 值。 所有插入到 PriorityBlockingQueue 的元素必须实现 java.lang.Comparable 接口。因此该队列中元素的排序就取决于你自己的 Comparable 实现。 注意 PriorityBlockingQueue 对于具有相等优先级(compare() == 0)的元素并不强制任何特定行为。</p>
<p>同时注意，如果你从一个 PriorityBlockingQueue 获得一个 Iterator 的话，该 Iterator 并不能保证它对元素的遍历是以优先级为序的。</p>
<h2 id=synchronousqueue>SynchronousQueue</h2>
<p>SynchronousQueue 类实现了 BlockingQueue 接口。</p>
<p>SynchronousQueue 是一个特殊的队列，它的内部同时只能够容纳单个元素。如果该队列已有一元素的话，试图向队列中插入一个新元素的线程将会阻塞，直到另一个线程将该元素从队列中抽走。同样，如果该队列为空，试图向队列中抽取一个元素的线程将会阻塞，直到另一个线程向队列中插入了一条新的元素。 据此，把这个类称作一个队列显然是夸大其词了。它更多像是一个汇合点。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-040f5febb6255d9c7888a75b8f58a9cd>3.20 - CH20-FutureTask</h1>
<h2 id=概览>概览</h2>
<ul>
<li>FutureTask 为 Future 提供了基础实现，如获取任务执行结果(get)和取消任务等。</li>
<li>如果任务尚未完成，获取任务执行结果时将会阻塞。</li>
<li>一旦执行结束，任务就不能被重启或取消(除非使用runAndReset执行计算)。</li>
<li>FutureTask 常用来封装 Callable 和 Runnable，也可以作为一个任务提交到线程池中执行。</li>
<li>除了作为一个独立的类之外，此类也提供了一些功能性函数供我们创建自定义 task 类使用。</li>
<li>FutureTask 的线程安全由 CAS 来保证。</li>
</ul>
<h2 id=层级结构>层级结构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210428222223.png style=display:block;width:50% alt=NAME align=center> </div>
<p>FutureTask 实现了 RunnableFuture 接口，则 RunnableFuture 接口继承了 Runnable 接口和 Future 接口，所以 FutureTask 既能当做一个 Runnable 直接被 Thread 执行，也能作为 Future 用来得到 Callable 的计算结果。</p>
<h2 id=源码分析>源码分析</h2>
<h3 id=callable-接口>Callable 接口</h3>
<p>Callable 是个泛型接口，泛型V就是要 call() 方法返回的类型。对比 Runnable 接口，Runnable 不会返回数据也不能抛出异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Computes a result, or throws an exception if unable to do so.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return computed result
</span><span style=color:#8f5902;font-style:italic>     * @throws Exception if unable to compute a result
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#000>V</span> <span style=color:#000>call</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=future-接口>Future 接口</h3>
<p>Future 接口代表异步计算的结果，通过 Future 接口提供的方法可以查看异步计算是否执行完成，或者等待执行结果并获取执行结果，同时还可以取消执行。Future 接口的定义如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>mayInterruptIfRunning</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCancelled</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isDone</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutionException</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutionException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeoutException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>cancel：取消异步任务的执行。
<ul>
<li>如果异步任务已经完成或者已经被取消，或者由于某些原因不能取消，则会返回 false。</li>
<li>如果任务还没有被执行，则会返回 true 并且异步任务不会被执行。</li>
<li>如果任务已经开始执行了但是还没有执行完成：
<ul>
<li>若 mayInterruptIfRunning 为 true，则会立即中断执行任务的线程并返回 true；</li>
<li>若 mayInterruptIfRunning 为 false，则会返回 true 且不会中断任务执行线程。</li>
</ul>
</li>
</ul>
</li>
<li>isCanceled：判断任务是否被取消。
<ul>
<li>如果任务在结束(正常执行结束或者执行异常结束)前被取消则返回 true，</li>
<li>否则返回 false。</li>
</ul>
</li>
<li>isDone：判断任务是否已经完成。
<ul>
<li>如果完成则返回 true，否则返回 false。</li>
<li>任务执行过程中发生异常、任务被取消也属于任务已完成，也会返回true。</li>
</ul>
</li>
<li>get：获取任务执行结果。
<ul>
<li>如果任务还没完成则会阻塞等待直到任务执行完成。</li>
<li>如果任务被取消则会抛出 CancellationException 异常。</li>
<li>如果任务执行过程发生异常则会抛出 ExecutionException 异常。</li>
<li>如果阻塞等待过程中被中断则会抛出 InterruptedException 异常。</li>
</ul>
</li>
<li>get(timeout,timeunit)：带超时时间的 get() 版本。
<ul>
<li>如果阻塞等待过程中超时则会抛出 TimeoutException 异常。</li>
</ul>
</li>
</ul>
<h3 id=核心属性>核心属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#8f5902;font-style:italic>//内部持有的callable任务，运行完毕后置空
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>callable</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//从get()中返回的结果或抛出的异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>outcome</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// non-volatile, protected by state reads/writes
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>//运行callable的线程
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Thread</span> <span style=color:#000>runner</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//使用Treiber栈保存等待线程
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>WaitNode</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//任务状态
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NEW</span>          <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>COMPLETING</span>   <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NORMAL</span>       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>EXCEPTIONAL</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CANCELLED</span>    <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INTERRUPTING</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INTERRUPTED</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>其中的状态值 state 使用 volatile 修饰，以确保任何一个线程对状态的修改立即会对其他线程可见。</p>
<p>7 种具体状态表示：</p>
<ul>
<li>NEW：初始状态，表示这个是新任务或者尚未被执行完的任务。</li>
<li>COMPLETING：任务已经执行完成或者执行任务的时候发生异常。
<ul>
<li>但是任务执行结果或者异常原因还没有保存到 outcome 字段时，状态由 NEW 变为 COMPLETING。</li>
<li>outcome字段用来保存任务执行结果，如果发生异常，则用来保存异常原因。</li>
<li>该状态持续时间较短，属于中间状态。</li>
</ul>
</li>
<li>NORMAL：任务已经执行完成并且任务执行结果已经保存到 outcome 字段，状态会从 COMPLETING 转换到 NORMAL。
<ul>
<li>这是一个最终态。</li>
</ul>
</li>
<li>EXCEPTIONAL：任务执行发生异常并且异常原因已经保存到 outcome 字段中后，状态会从 COMPLETING 转换到 EXCEPTIONAL。
<ul>
<li>这是一个最终态。</li>
</ul>
</li>
<li>CANCELED：任务还没开始执行或者已经开始执行但是还没有执行完成的时候，用户调用了 <code>cancel(false)</code> 方法取消任务且不中断任务执行线程，这个时候状态会从 NEW 转化为 CANCELLED 状态。
<ul>
<li>这是一个最终态。</li>
</ul>
</li>
<li>INTERRUPTING：任务还没开始执行或者已经执行但是还没有执行完成的时候，用户调用了 <code>cancel(true)</code> 方法取消任务并且要中断任务执行线程但是还没有中断任务执行线程之前，状态会从 NEW 转化为 INTERRUPTING。
<ul>
<li>这是一个中间状态。</li>
</ul>
</li>
<li>INTERRUPTED：调用 interrupt() 中断任务执行线程之后状态会从 INTERRUPTING 转换到 INTERRUPTED。
<ul>
<li>这是一个最终态。</li>
<li>所有值大于 COMPLETING 的状态都表示任务已经执行完成(任务正常执行完成，任务执行异常或者任务被取消)。</li>
</ul>
</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210428223530.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=构造函数>构造函数</h3>
<h4 id=futuretaskcallablev-callable><code>FutureTask(Callable&lt;V> callable)</code></h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FutureTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>callable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>callable</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>callable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>callable</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NEW</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// ensure visibility of callable
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>该构造函数会把传入的 Callable 变量保存在t his.callable 字段中。</li>
<li>该字段定义为<code>private Callable&lt;V> callable</code>; 用来保存底层的调用，在被执行完成以后会指向 null。</li>
<li>接着会初始化 state 字段为 NEW。</li>
</ul>
<h4 id=futuretaskrunnable-runnable-v-result><code>FutureTask(Runnable runnable, V result)</code></h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FutureTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>callable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>callable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>NEW</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// ensure visibility of callable
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>这个构造函数会把传入的 Runnable 封装成一个 Callable 对象保存在 callable 字段中。</li>
<li>同时如果任务执行成功的话就会返回传入的 result。</li>
<li>如果不需要返回值的话可以传入一个 null 作为 result。</li>
<li>Executors.callable() 的功能是把 Runnable 转换成 Callable。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>callable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
       <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RunnableAdapter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 适配器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里采用了适配器模式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RunnableAdapter</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>RunnableAdapter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>call</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的适配器只是简单实现了 Callable 接口，在 call 中调用 Runnable.run 方法，然后把传入的 result 作为返回值返回调用。</p>
<p>在 new 了一个 FutureTask 之后，接下来就是在另一个线程中执行该 Task，无论是通过直接 new 一个 Thread 还是通过线程池，执行的都是 run 方法。</p>
<h3 id=核心方法run>核心方法：run</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//新建任务，CAS替换runner为当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NEW</span> <span style=color:#ce5c00;font-weight:700>||</span>
        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>runnerOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                                     <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>()))</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>callable</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>NEW</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>V</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>ran</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>call</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>ran</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>ran</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>setException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ran</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//设置执行结果
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// runner must be non-null until state is settled to
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// prevent concurrent calls to run()
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>runner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// state must be re-read after nulling runner to prevent
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// leaked interrupts
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>INTERRUPTING</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>handlePossibleCancellationInterrupt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//处理中断逻辑
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>运行任务：如果任务状态为NEW状态，则利用CAS修改为当前线程。执行完毕调用set(result)方法设置执行结果。set(result)源码如下：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NEW</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>COMPLETING</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>outcome</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NORMAL</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// final state
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>finishCompletion</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//执行完毕，唤醒等待线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>首先利用cas修改state状态为COMPLETING，设置返回结果，然后使用 lazySet(UNSAFE.putOrderedInt)的方式设置state状态为NORMAL。结果设置完毕后，调用finishCompletion()方法唤醒等待线程，源码如下：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>finishCompletion</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// assert state &gt; COMPLETING;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WaitNode</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>waitersOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//移除等待线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//自旋遍历等待线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//唤醒等待线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>WaitNode</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// unlink to help gc
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//任务完成后调用函数，自定义扩展
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>done</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>callable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// to reduce footprint
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>回到run方法，如果在 run 期间被中断，此时需要调用handlePossibleCancellationInterrupt方法来处理中断逻辑，确保任何中断(例如cancel(true))只停留在当前run或runAndReset的任务中，源码如下：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>handlePossibleCancellationInterrupt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//在中断者中断线程之前可能会延迟，所以我们只需要让出CPU时间片自旋等待
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>INTERRUPTING</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>INTERRUPTING</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>yield</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// wait out pending interrupt
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=核心方法get>核心方法：get</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//获取执行结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutionException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>COMPLETING</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>awaitDone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>report</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>FutureTask 通过get()方法获取任务执行结果。如果任务处于未完成的状态(<code>state &lt;= COMPLETING</code>)，就调用awaitDone方法(后面单独讲解)等待任务完成。任务完成后，通过report方法获取执行结果或抛出执行期间的异常。report源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//返回执行结果或抛出异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>V</span> <span style=color:#000>report</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ExecutionException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>outcome</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>CANCELLED</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CancellationException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExecutionException</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=核心方法awaitdoneboolean-timed-long-nanos>核心方法：awaitDone(boolean timed, long nanos)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitDone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>WaitNode</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>queued</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//自旋
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//获取并清除中断状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>removeWaiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//移除等待WaitNode
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>COMPLETING</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//置空等待节点的线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>COMPLETING</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// cannot time out yet
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>yield</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WaitNode</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>queued</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//CAS修改waiter
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>queued</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>waitersOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>removeWaiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//超时，移除等待节点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parkNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//阻塞当前线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//阻塞当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>awaitDone 用于等待任务完成，或任务因为中断或超时而终止。返回任务的完成状态。函数执行逻辑如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeWaiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WaitNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//首先置空线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>retry</span><span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>          <span style=color:#8f5902;font-style:italic>// restart on removeWaiter race
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//依次遍历查找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WaitNode</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>waiters</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// check for race
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>continue</span> <span style=color:#000>retry</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>waitersOffset</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>//cas替换
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>continue</span> <span style=color:#000>retry</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>加入当前线程状态为结束(state>COMPLETING)，则根据需要置空等待节点的线程，并返回 Future 状态；</li>
<li>如果当前状态为正在完成(COMPLETING)，说明此时 Future 还不能做出超时动作，为任务让出CPU执行时间片；</li>
<li>如果state为NEW，先新建一个WaitNode，然后CAS修改当前waiters；</li>
<li>如果等待超时，则调用removeWaiter移除等待节点，返回任务状态；如果设置了超时时间但是尚未超时，则park阻塞当前线程；</li>
<li>其他情况直接阻塞当前线程。</li>
</ul>
<h3 id=核心方法cancelboolean-mayinterruptifrunning>核心方法：cancel(boolean mayInterruptIfRunning)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>mayInterruptIfRunning</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//如果当前Future状态为NEW，根据参数修改Future状态为INTERRUPTING或CANCELLED
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>NEW</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
          <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NEW</span><span style=color:#ce5c00;font-weight:700>,</span>
              <span style=color:#000>mayInterruptIfRunning</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>INTERRUPTING</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>CANCELLED</span><span style=color:#ce5c00;font-weight:700>)))</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#8f5902;font-style:italic>// in case call to interrupt throws exception
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mayInterruptIfRunning</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//可以在运行时中断
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runner</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// final state
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>INTERRUPTED</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>finishCompletion</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//移除并唤醒所有等待线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>尝试取消任务。如果任务已经完成或已经被取消，此操作会失败。</p>
<ul>
<li>如果当前Future状态为NEW，根据参数修改Future状态为INTERRUPTING或CANCELLED。</li>
<li>如果当前状态不为NEW，则根据参数mayInterruptIfRunning决定是否在任务运行中也可以中断。中断操作完成后，调用finishCompletion移除并唤醒所有等待线程。</li>
</ul>
<h2 id=应用实例>应用实例</h2>
<h3 id=future--executorservice>Future & ExecutorService</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FutureDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>ExecutorService</span> <span style=color:#000>executorService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCachedThreadPool</span><span style=color:#ce5c00;font-weight:700>();</span>
          <span style=color:#000>Future</span> <span style=color:#000>future</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>executorService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#5c35cc;font-weight:700>@Override</span>
              <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>call</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
                  <span style=color:#000>Long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
                  <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                      <span style=color:#000>Long</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
                     <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                         <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                     <span style=color:#ce5c00;font-weight:700>}</span>
                 <span style=color:#ce5c00;font-weight:700>}</span>
             <span style=color:#ce5c00;font-weight:700>}</span>
         <span style=color:#ce5c00;font-weight:700>});</span>
  
         <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#000>Integer</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
             <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
         <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>){</span>
             <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
         <span style=color:#ce5c00;font-weight:700>}</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=futuretask--executorservice>FutureTask & ExecutorService</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ExecutorService</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCachedThreadPool</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>Task</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>FutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>futureTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futureTask</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=future--thread>Future & Thread</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.*</span><span style=color:#ce5c00;font-weight:700>;</span>
 
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CallDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>ExecutionException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 2. 新建FutureTask,需要一个实现了Callable接口的类的实例作为构造函数参数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>FutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>futureTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#8f5902;font-style:italic>// 3. 新建Thread对象并启动
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Thread</span> <span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futureTask</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Task thread&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
 
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
 
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Thread [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] is running&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
 
        <span style=color:#8f5902;font-style:italic>// 4. 调用isDone()判断任务是否结束
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>futureTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isDone</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Task is not done&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 5. 调用get()方法获取任务结果,如果任务没有执行完成则阻塞等待
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>futureTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
 
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;result is &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>
 
    <span style=color:#ce5c00;font-weight:700>}</span>
 
    <span style=color:#8f5902;font-style:italic>// 1. 继承Callable接口,实现call()方法,泛型参数为要返回的类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Task</span>  <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
 
        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Integer</span> <span style=color:#000>call</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Thread [&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;] is running&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>100</span><span style=color:#ce5c00;font-weight:700>;++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
 
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-20c03470e3b1a36fc96b69d803819a88>3.21 - CH21-ThreadPoolExecutor</h1>
<h2 id=线程池的作用>线程池的作用</h2>
<ul>
<li>降低资源消耗：线程无限制的创建，使用完毕后消耗</li>
<li>提高响应速度：无需频繁新建线程</li>
<li>提高线程的可管理性</li>
</ul>
<h2 id=应用详解>应用详解</h2>
<ul>
<li>
<p>线程池即一个线程集合 workerSet 和一个阻塞队列 workQueue。</p>
</li>
<li>
<p>当用户向线程池提交一个任务时，线程池会先将任务放入 workQueue 中。</p>
</li>
<li>
<p>workerSet 中的线程会不断的从 workQueue 中获取任务并执行。</p>
</li>
<li>
<p>当 workQueue 中没有任务时，worker 则会阻塞，直到队列中有任务了再开始执行。</p>
</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429002916.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=executor-原理>Executor 原理</h3>
<p>当一个线程提交至线程池后：</p>
<ol>
<li>线程池首先判断当前运行的线程数量是否少于与 corePoolSize。如果是则新建工作线程来执行任务，否则进入 2。</li>
<li>判断 BlockingQueue 是否已满，如果没满，则将任务放入 BlockingQueue，否则进入 3。</li>
<li>如果新建线程会使当前线程珊瑚粮超过 maximumPoolSize，则交给 RejectedExecutionHandler 来处理。</li>
</ol>
<p>当 ThreadPoolExecutor 新建线程时，通过 CAS 来更新线程池的状态 ctl。</p>
<h3 id=参数>参数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maximumPoolSize</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>keepAliveTime</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>BlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>,</span>
                          <span style=color:#000>RejectedExecutionHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><ul>
<li>corePoolSize：核心线程数。
<ul>
<li>当提交一个任务时，线程池新建线程来执行任务，直到线程数量等于 corePoolSize，即使存在空闲线程。</li>
<li>如果当前线程数量等于 corePoolSize，提交的任务将会被保存到阻塞队列，等待执行。</li>
<li>如果执行了线程池的 prestartAllCoreThreads 方法，线程池会提前创建并开启所有核心线程。</li>
</ul>
</li>
<li>workQueue：用于保存需要被执行的任务，可选的队列类型有：
<ul>
<li>ArrayBlockingQueue：基于数组结构，按 FIFO 排序任务。</li>
<li>LinkedBlockingQueue：基于链表结构，按 FIFO 排序任务，吞吐量高于 ArrayBlockingQueue。
<ul>
<li>比 ArrayBlockingQueue 在插入、删除元素时性能更优，但 put、take 时均需加锁。</li>
</ul>
</li>
<li>SynchronousQueue：不存储元素的阻塞队列，每个插入操作必须等待另一个线程调用移除操作，否则插入操作将一直阻塞，吞吐量高于 LinkedBlockingQueue。
<ul>
<li>使用无锁算法，基于节点状态执行判断，无需使用锁，核心是 Transfer.transfer。</li>
</ul>
</li>
<li>PriorityBlockingQueue：具有优先级的无界阻塞队列。</li>
</ul>
</li>
<li>maximumPoolSize：允许的最大线程数量。
<ul>
<li>如果阻塞队列已满后继续提交任务，则需创建新的线程来执行任务，前提是线程数小于最大允许数量。</li>
<li>当阻塞队列是无界队列时，则最大允许数量不起作用。</li>
</ul>
</li>
<li>keepAliveTime：线程空闲存活时间。
<ul>
<li>即当线程没有执行任务时，该线程继续存活的时间。</li>
<li>默认情况下，该参数只有在线程数量大于 corePoolSize 时才起效。</li>
<li>超过空闲存活时间的现场将被终止。</li>
</ul>
</li>
<li>unit：线程空闲存活时间的时间单位。</li>
<li>threadFactory：创建线程的工厂，通过自定义工厂可以设置线程的属性，如名称、demaon。</li>
<li>handler：线程池饱和策略。如果队列已满且没有空闲线程，如果继续提交任务，必须采取一种策略来处理该任务，共有四种策略：
<ul>
<li>AbortPolicy：直接抛出异常，默认策略。</li>
<li>CallerRunPolicy：用调用者线程来执行任务。</li>
<li>DiscardOldestPolicy：丢弃队列中较靠前的任务，以执行当前任务。</li>
<li>DiscardPolicy：直接丢弃任务。</li>
<li>支持自定义饱和策略，比如记录日志会持久化存储任务信息。</li>
</ul>
</li>
</ul>
<h3 id=类型>类型</h3>
<h4 id=newfixedthreadpool>newFixedThreadPool</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>newFixedThreadPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nThreads</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nThreads</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nThreads</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>固定线程数量(corePoolSize)。</li>
<li>即使线程池没有可执行的任务，也不会终止线程。</li>
<li>采用无界队列 LinkedBlockingQueue(Integer.MAX_VALUE)，潜在问题：
<ul>
<li>线程数量不会超过 corePoolSize，导致 maximumPoolSize 和 keepAliveTIme 参数失效。</li>
<li>采用无界队列导致永远不会拒绝提交的任务，导致饱和策略失效。</li>
</ul>
</li>
</ul>
<h4 id=newsinglethreadexecutor>newSingleThreadExecutor</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>newSingleThreadExecutor</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FinalizableDelegatedExecutorService</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MILLISECONDS</span><span style=color:#ce5c00;font-weight:700>,</span>
                                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LinkedBlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;()));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>初始化的线程池中仅一个线程，如果该线程异常结束，会新建线程以继续执行任务。</li>
<li>该唯一线程可以保证顺序处理队列中的任务。</li>
<li>基于无界队列，因此饱和策略失效。</li>
</ul>
<h4 id=newcachedthreadpool>newCachedThreadPool</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>newCachedThreadPool</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#000>60L</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>,</span>
                                    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SynchronousQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;());</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>线程数最多可达 Integer.MAX_VALUE。</li>
<li>内部使用 SynchronousQueue 作为阻塞队列。</li>
<li>线程空间时间超过最大空闲时长会终止线程。</li>
<li>如果提交任务没有可用线程，则新建线程。</li>
<li>执行过程与前两个线程池不同：
<ul>
<li>主线程调用 SynchronousQueue.offer 添加 task，如果此时线程池中有空闲线程尝试读取队列中的任务，即调用 SynchronousQueue.poll，则主线程将该 task 交给空闲线程。否则进入下一步。</li>
<li>当线程池为空或没有空闲线程，则新建线程。</li>
<li>执行完任务的线程如果在 60 秒内空间，则被终止，因此长时间空闲的线程池不会持有任何线程资源。</li>
</ul>
</li>
</ul>
<h3 id=关闭线程池>关闭线程池</h3>
<p>遍历线程池中的所有线程，然后逐个调用线程的 interrupt 方法来中断线程。</p>
<h4 id=关闭方式shutdown>关闭方式：shutdown</h4>
<p>将线程池里的线程状态设置成SHUTDOWN状态, 然后中断所有没有正在执行任务的线程。</p>
<h4 id=关闭方式shutdownnow>关闭方式：shutdownNow</h4>
<p>将线程池里的线程状态设置成STOP状态, 然后停止所有正在执行或暂停任务的线程。</p>
<p>只要调用这两个关闭方法中的任意一个, isShutDown() 返回true. 当所有任务都成功关闭了, isTerminated()返回true。</p>
<h2 id=threadpoolexecutor>ThreadPoolExecutor</h2>
<h3 id=关键属性>关键属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//这个属性是用来存放 当前运行的worker数量以及线程池状态的
</span><span style=color:#8f5902;font-style:italic>//int是32位的，这里把int的高3位拿来充当线程池状态的标志位,后29位拿来充当当前运行worker的数量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>ctl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctlOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RUNNING</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#8f5902;font-style:italic>//存放任务的阻塞队列
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>BlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//worker的集合,用set来存放
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Worker</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>workers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Worker</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
<span style=color:#8f5902;font-style:italic>//历史达到的worker数最大值
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>largestPoolSize</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//当队列满了并且worker的数量达到maxSize的时候,执行具体的拒绝策略
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>RejectedExecutionHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//超出coreSize的worker的生存时间
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>keepAliveTime</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//常驻worker的数量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//最大worker的数量,一般当workQueue满了才会用到这个参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maximumPoolSize</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=内部状态>内部状态</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>ctl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctlOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RUNNING</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>COUNT_BITS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIZE</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CAPACITY</span>   <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>COUNT_BITS</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// runState is stored in the high-order bits
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>RUNNING</span>    <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>COUNT_BITS</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SHUTDOWN</span>   <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>COUNT_BITS</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>STOP</span>       <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>COUNT_BITS</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>TIDYING</span>    <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>COUNT_BITS</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>TERMINATED</span> <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#000>3</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>COUNT_BITS</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// Packing and unpacking ctl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runStateOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>workerCountOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ctlOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>wc</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>wc</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其中AtomicInteger变量ctl的功能非常强大: 利用低29位表示线程池中线程数，通过高3位表示线程池的运行状态:</p>
<ul>
<li>RUNNING: -1 &#171; COUNT_BITS，即高3位为111，该状态的线程池会接收新任务，并处理阻塞队列中的任务；</li>
<li>SHUTDOWN: 0 &#171; COUNT_BITS，即高3位为000，该状态的线程池不会接收新任务，但会处理阻塞队列中的任务；</li>
<li>STOP : 1 &#171; COUNT_BITS，即高3位为001，该状态的线程不会接收新任务，也不会处理阻塞队列中的任务，而且会中断正在运行的任务；</li>
<li>TIDYING : 2 &#171; COUNT_BITS，即高3位为010, 所有的任务都已经终止；</li>
<li>TERMINATED: 3 &#171; COUNT_BITS，即高3位为011, terminated()方法已经执行完成</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429010149.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=执行过程>执行过程</h3>
<blockquote>
<p>execute –> addWorker –> runworker(getTask)</p>
</blockquote>
<ul>
<li>线程池的工作线程通过Woker类实现，在ReentrantLock锁的保证下，把Woker实例插入到HashSet后，并启动Woker中的线程。</li>
<li>从Woker类的构造方法实现可以发现: 线程工厂在创建线程thread时，将Woker实例本身this作为参数传入，当执行start方法启动线程thread时，本质是执行了Worker的runWorker方法。</li>
<li>firstTask执行完成之后，通过getTask方法从阻塞队列中获取等待的任务，如果队列中没有任务，getTask方法会被阻塞并挂起，不会占用cpu资源；</li>
</ul>
<h4 id=execute-方法>execute 方法</h4>
<p>ThreadPoolExecutor.execute(task)实现了Executor.execute(task)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>     * Proceed in 3 steps:
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * 1. If fewer than corePoolSize threads are running, try to
</span><span style=color:#8f5902;font-style:italic>     * start a new thread with the given command as its first
</span><span style=color:#8f5902;font-style:italic>     * task.  The call to addWorker atomically checks runState and
</span><span style=color:#8f5902;font-style:italic>     * workerCount, and so prevents false alarms that would add
</span><span style=color:#8f5902;font-style:italic>     * threads when it shouldn&#39;t, by returning false.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * 2. If a task can be successfully queued, then we still need
</span><span style=color:#8f5902;font-style:italic>     * to double-check whether we should have added a thread
</span><span style=color:#8f5902;font-style:italic>     * (because existing ones died since last checking) or that
</span><span style=color:#8f5902;font-style:italic>     * the pool shut down since entry into this method. So we
</span><span style=color:#8f5902;font-style:italic>     * recheck state and if necessary roll back the enqueuing if
</span><span style=color:#8f5902;font-style:italic>     * stopped, or start a new thread if there are none.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * 3. If we cannot queue task, then we try to add a new
</span><span style=color:#8f5902;font-style:italic>     * thread.  If it fails, we know we are shut down or saturated
</span><span style=color:#8f5902;font-style:italic>     * and so reject the task.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>workerCountOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
    <span style=color:#8f5902;font-style:italic>//workerCountOf获取线程池的当前线程数；小于corePoolSize，执行addWorker创建新线程执行command任务
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// double check: c, recheck
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 线程池处于RUNNING状态，把提交的任务成功放入阻塞队列中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isRunning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>recheck</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// recheck and if necessary 回滚到入队操作前，即倘若线程池shutdown状态，就remove(command)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//如果线程池没有RUNNING，成功从阻塞队列中删除任务，执行reject方法处理任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span> <span style=color:#000>isRunning</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#000>reject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//线程池处于running状态，但是没有线程，则创建线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>workerCountOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>recheck</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>addWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 往线程池中创建新的线程失败，则reject任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>addWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#000>reject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>为什么需要double check线程池的状态?</li>
</ul>
<p>在多线程环境下，线程池的状态时刻在变化，而ctl.get()是非原子操作，很有可能刚获取了线程池状态后线程池状态就改变了。判断是否将command加入workque是线程池之前的状态。倘若没有double check，万一线程池处于非running状态(在多线程环境下很有可能发生)，那么command永远不会执行。</p>
<h4 id=addworker-方法>addWorker 方法</h4>
<p>从方法execute的实现可以看出: addWorker主要负责创建新的线程并执行任务。</p>
<p>线程池创建新线程执行任务时，需要获取全局锁:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>mainLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>addWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>firstTask</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>core</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// CAS更新线程池数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>retry</span><span style=color:#ce5c00;font-weight:700>:</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runStateOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// Check if queue empty only if necessary.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>SHUTDOWN</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SHUTDOWN</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#000>firstTask</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()))</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workerCountOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>CAPACITY</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>core</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>corePoolSize</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>maximumPoolSize</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndIncrementWorkerCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#204a87;font-weight:700>break</span> <span style=color:#000>retry</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>  <span style=color:#8f5902;font-style:italic>// Re-read ctl
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runStateOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>continue</span> <span style=color:#000>retry</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// else CAS failed due to workerCount change; retry inner loop
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>workerStarted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>workerAdded</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Worker</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Worker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstTask</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 线程池重入锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>mainLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mainLock</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// Recheck while holding lock.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// Back out on ThreadFactory failure or if
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// shut down before lock acquired.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runStateOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>SHUTDOWN</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>SHUTDOWN</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>firstTask</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlive</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// precheck that t is startable
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalThreadStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>workers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>largestPoolSize</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>largestPoolSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>workerAdded</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>workerAdded</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>  <span style=color:#8f5902;font-style:italic>// 线程启动，执行任务(Worker.thread(firstTask).start());
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>workerStarted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span> <span style=color:#000>workerStarted</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>addWorkerFailed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>workerStarted</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=workerrunworker-方法>Worker.runWorker 方法</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Worker</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractQueuedSynchronizer</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#000>Worker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>firstTask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// inhibit interrupts until runWorker
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstTask</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getThreadFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>newThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 创建线程
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#ce5c00;font-weight:700>}</span>
     <span style=color:#8f5902;font-style:italic>/** Delegates main run loop to outer runWorker  */</span>
     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
         <span style=color:#000>runWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
     <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>继承了AQS类，可以方便的实现工作线程的中止操作；</li>
<li>实现了Runnable接口，可以将自身作为一个任务在工作线程中执行；</li>
<li>当前提交的任务firstTask作为参数传入Worker的构造方法；</li>
</ul>
<p>一些属性还有构造方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//运行的线程,前面addWorker方法中就是直接通过启动这个线程来启动这个worker
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Thread</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//当一个worker刚创建的时候,就先尝试执行这个任务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Runnable</span> <span style=color:#000>firstTask</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//记录完成任务的数量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>completedTasks</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#000>Worker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>firstTask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// inhibit interrupts until runWorker
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstTask</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//创建一个Thread,将自己设置给他,后面这个thread启动的时候,也就是执行worker的run方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getThreadFactory</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>newThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>   
</code></pre></div><p>runWorker方法是线程池的核心:</p>
<ul>
<li>线程启动之后，通过unlock方法释放锁，设置AQS的state为0，表示运行可中断；</li>
<li>Worker执行firstTask或从workQueue中获取任务
<ul>
<li>进行加锁操作，保证thread不被其他线程中断(除非线程池被中断)</li>
<li>检查线程池状态，倘若线程池处于中断状态，当前线程将中断。</li>
<li>执行beforeExecute</li>
<li>执行任务的run方法</li>
<li>执行afterExecute方法</li>
<li>解锁操作</li>
</ul>
</li>
</ul>
<p>通过getTask方法从阻塞队列中获取等待的任务，如果队列中没有任务，getTask方法会被阻塞并挂起，不会占用cpu资源；</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>runWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Worker</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span> <span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Runnable</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstTask</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// allow interrupts
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>completedAbruptly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 先执行firstTask，再从workerQueue中取task(getTask())
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getTask</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// If pool is stopping, ensure thread is interrupted;
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// if not, ensure thread is not interrupted.  This
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// requires a recheck in second case to deal with
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// shutdownNow race while clearing interrupt
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>runStateAtLeast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>STOP</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#000>runStateAtLeast</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>STOP</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterrupted</span><span style=color:#ce5c00;font-weight:700>())</span>
                <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>beforeExecute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>Throwable</span> <span style=color:#000>thrown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RuntimeException</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>thrown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Error</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>thrown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>thrown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>afterExecute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>thrown</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>completedTasks</span><span style=color:#ce5c00;font-weight:700>++;</span>
                <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>completedAbruptly</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>processWorkerExit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>completedAbruptly</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=gettask-方法>getTask 方法</h4>
<p>下面来看一下getTask()方法，这里面涉及到keepAliveTime的使用，从这个方法我们可以看出先吃池是怎么让超过corePoolSize的那部分worker销毁的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Runnable</span> <span style=color:#000>getTask</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timedOut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// Did the last poll() time out?
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runStateOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// Check if queue empty only if necessary.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>SHUTDOWN</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>STOP</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>decrementWorkerCount</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workerCountOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>// Are workers subject to culling?
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>allowCoreThreadTimeOut</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>maximumPoolSize</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>timedOut</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndDecrementWorkerCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Runnable</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>?</span>
                <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keepAliveTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NANOSECONDS</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>timedOut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>retry</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>timedOut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意这里一段代码是keepAliveTime起作用的关键:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>allowCoreThreadTimeOut</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>Runnable</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>?</span>
                <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>poll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keepAliveTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NANOSECONDS</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
                <span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>take</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><ul>
<li>allowCoreThreadTimeOut为false，线程即使空闲也不会被销毁；</li>
<li>倘若为ture，在keepAliveTime内仍空闲则会被销毁。</li>
</ul>
<p>如果线程允许空闲等待而不被销毁timed == false，workQueue.take任务:</p>
<p>如果阻塞队列为空，当前线程会被挂起等待；</p>
<p>当队列中有任务加入时，线程被唤醒，take方法返回任务，并执行；</p>
<p>如果线程不允许无休止空闲timed == true, workQueue.poll任务: 如果在keepAliveTime时间内，阻塞队列还是没有任务，则返回null；</p>
<h3 id=提交过程>提交过程</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429011328.png style=display:block;width:50% alt=NAME align=center> </div>
<ol>
<li>submit任务，等待线程池execute</li>
<li>执行FutureTask类的get方法时，会把主线程封装成WaitNode节点并保存在waiters链表中， 并阻塞等待运行结果；</li>
<li>FutureTask任务执行完成后，通过UNSAFE设置waiters相应的waitNode为null，并通过LockSupport类unpark方法唤醒主线程；</li>
</ol>
<p>在实际业务场景中，Future和Callable基本是成对出现的，Callable负责产生结果，Future负责获取结果。</p>
<ol>
<li>Callable接口类似于Runnable，只是Runnable没有返回值。</li>
<li>Callable任务除了返回正常结果之外，如果发生异常，该异常也会被返回，即Future可以拿到异步执行任务各种结果；</li>
<li>Future.get方法会导致主线程阻塞，直到Callable任务执行完成；</li>
</ol>
<h4 id=submit-方法>submit 方法</h4>
<p>AbstractExecutorService.submit()实现了ExecutorService.submit() 可以获取执行完的返回值, 而ThreadPoolExecutor 是AbstractExecutorService.submit()的子类，所以submit方法也是ThreadPoolExecutor的方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// submit()在ExecutorService中的定义
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Callable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>T</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// submit方法在AbstractExecutorService中的实现
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 通过submit方法提交的Callable任务会被封装成了一个FutureTask对象。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>RunnableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ftask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>newTaskFor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ftask</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ftask</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通过submit方法提交的Callable任务会被封装成了一个FutureTask对象。通过Executor.execute方法提交FutureTask到线程池中等待被执行，最终执行的是FutureTask的run方法；</p>
<h3 id=关闭过程>关闭过程</h3>
<p>shutdown方法会将线程池的状态设置为SHUTDOWN,线程池进入这个状态后,就拒绝再接受任务,然后会将剩余的任务全部执行完：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>mainLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mainLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查是否可以关闭线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkShutdownAccess</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//设置线程池状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>advanceRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SHUTDOWN</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//尝试中断worker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>interruptIdleWorkers</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>//预留方法,留给子类实现
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>onShutdown</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// hook for ScheduledThreadPoolExecutor
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>tryTerminate</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>interruptIdleWorkers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>interruptIdleWorkers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>interruptIdleWorkers</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>onlyOne</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>mainLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mainLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//遍历所有的worker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Worker</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>workers</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//先尝试调用w.tryLock(),如果获取到锁,就说明worker是空闲的,就可以直接中断它
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//注意的是,worker自己本身实现了AQS同步框架,然后实现的类似锁的功能
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//它实现的锁是不可重入的,所以如果worker在执行任务的时候,会先进行加锁,这里tryLock()就会返回false
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterrupted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryLock</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SecurityException</span> <span style=color:#000>ignore</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>onlyOne</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>shutdownNow做的比较绝，它先将线程池状态设置为STOP，然后拒绝所有提交的任务。最后中断左右正在运行中的worker,然后清空任务队列。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>shutdownNow</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tasks</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>mainLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mainLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkShutdownAccess</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//检测权限
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>advanceRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>STOP</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//中断所有的worker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>interruptWorkers</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//清空任务队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>tasks</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>drainQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>tryTerminate</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>tasks</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>interruptWorkers</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>mainLock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mainLock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//遍历所有worker，然后调用中断方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Worker</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>workers</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interruptIfStarted</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>mainLock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=配置线程池需要考虑因素>配置线程池需要考虑因素</h3>
<p>从任务的优先级，任务的执行时间长短，任务的性质(CPU密集/ IO密集)，任务的依赖关系这四个角度来分析。并且近可能地使用有界的工作队列。</p>
<p>性质不同的任务可用使用不同规模的线程池分开处理:</p>
<ul>
<li>CPU密集型: 尽可能少的线程，Ncpu+1</li>
<li>IO密集型: 尽可能多的线程, Ncpu*2，比如数据库连接池</li>
<li>混合型: CPU密集型的任务与IO密集型任务的执行时间差别较小，拆分为两个线程池；否则没有必要拆分。</li>
</ul>
<h3 id=监控线程池的状态>监控线程池的状态</h3>
<p>可以使用ThreadPoolExecutor以下方法:</p>
<ul>
<li>getTaskCount</li>
<li>getCompletedTaskCount</li>
<li>getLargestPoolSize</li>
<li>getPoolSize</li>
<li>getActiveCount</li>
</ul>
<h2 id=参考>参考</h2>
<ul>
<li><a href=https://javadoop.com/post/java-thread-pool>线程池原理</a></li>
<li><a href=https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html>线程池应用</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4b544e8d51a8d75a0f871301e03607db>3.22 - CH22-ScheduledThreadPoolExecutor</h1>
<h2 id=概览>概览</h2>
<p>继承自 ThreadPoolExecutor，为任务提供延迟或周期执行，属于线程池的一种。相比 ThreadPoolExecutor 具有以下特性：</p>
<ul>
<li>使用专门的任务类型—ScheduledFutureTask 来执行周期任务，也可以接收无需时间调度的任务(这些任务通过 ExecutorService 直接执行)。</li>
<li>使用专门的存储队列—DelayedWorkQueue 来存储任务，DelayedWorkQueue 是无界延迟队列 DelayedQueue 的一种。相比 ThreadPoolExecutor 简化了执行机制。</li>
<li>支持可选的 run-after-shutdown 参数，在池被关闭(shutdown)之后支持可选的逻辑来决定是否继续运行周期或延迟任务。并且当任务的(重新)提交操作与 shutdown 操作重叠时，复查逻辑也不相同。</li>
</ul>
<h2 id=层级结构>层级结构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429113047.png style=display:block;width:50% alt=NAME align=center> </div>
<p>ScheduledThreadPoolExecutor 内部构造了两个类：</p>
<ul>
<li>ScheduledFutureTask：
<ul>
<li>继承 FutureTask，说明是一个异步运算任务。</li>
<li>实现 Rnnable、Future、Delayed 接口，说明是一个可以延迟执行的异步运算任务。</li>
</ul>
</li>
<li>DelayedWorkQueue：
<ul>
<li>专用于存储周期或延迟任务而定义的延迟队列，继承了 AbstractQueue，为了契合 ThreadPoolExecutor 也实现了 BlockingQueue 接口。</li>
<li>内部只允许存储 RunnableScheduledFuture 类型的任务。</li>
<li>与 DelayQueue 的不同之处在于它只允许存放 RunnableScheduledFuture 对象，并且自己实现了二叉堆(DelayQueue 利用了 PriorityQueue 的二叉堆结构)。</li>
</ul>
</li>
</ul>
<h2 id=源码分析>源码分析</h2>
<h3 id=内部类scheduledfuturetask>内部类：ScheduledFutureTask</h3>
<h4 id=属性>属性：</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//为相同延时任务提供的顺序编号
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>sequenceNumber</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//任务可以执行的时间，纳秒级
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//重复任务的执行周期时间，纳秒级。
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>period</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//重新入队的任务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>outerTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//延迟队列的索引，以支持更快的取消操作
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>heapIndex</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><ul>
<li>sequenceNumber：当两个任务具有相同的延迟时间时，按照 FIFO 的顺序入队，用于给这些任务编号。</li>
<li>time：任务可以执行的时间点，纳秒单位，通过 triggerTime 方法计算得出。</li>
<li>period：任务执行的周期间隔，那秒单位。
<ul>
<li>正数表示固定速率执行(为 scheduleAtFixedRate 提供服务)</li>
<li>负数表示固定延迟执行(为 scheduleWithFixedDelay 提供服务)</li>
<li>0 表示不重复执行。</li>
</ul>
</li>
<li>outerTask：重新入队的任务，通过 reExecutePeriodic 方法入队重新排序。</li>
</ul>
<h4 id=核心方法run>核心方法：run</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>periodic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>isPeriodic</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//是否为周期任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>canRunInCurrentRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>periodic</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//当前状态是否可以执行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>periodic</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#8f5902;font-style:italic>//不是周期任务，直接执行
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ScheduledFutureTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ScheduledFutureTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runAndReset</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setNextRunTime</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//设置下一次运行时间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>reExecutePeriodic</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>outerTask</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//重排序一个周期任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ScheduledFutureTask 的 run 方法重写了 FutureTask 的版本，以便执行周期任务时重置、重排任务。任务的执行通过父类 FutureTask.run 实现。</p>
<p>内部有两个针对周期任务的方法：</p>
<ul>
<li>
<p>setNextRunTime：用于设置下一次运行的时间：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//设置下一次执行任务的时间
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setNextRunTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>period</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic>//固定速率执行，scheduleAtFixedRate
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#000>time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>triggerTime</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//固定延迟执行，scheduleWithFixedDelay
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//计算固定延迟任务的执行时间
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>triggerTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>delay</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>delay</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>overflowFree</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>));</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>reExecutePeriodic：周期任务重新入队等待下一次执行：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//重排序一个周期任务
void reExecutePeriodic(RunnableScheduledFuture&lt;?&gt; task) {
    if (canRunInCurrentRunState(true)) {//池关闭后可继续执行
        super.getQueue().add(task);//任务入列
        //重新检查run-after-shutdown参数，如果不能继续运行就移除队列任务，并取消任务的执行
        if (!canRunInCurrentRunState(true) &amp;&amp; remove(task))
            task.cancel(false);
        else
            ensurePrestart();//启动一个新的线程等待任务
    }
}
</code></pre></div></li>
</ul>
<p>reExecutePeriodic 与 delayedExecute 的执行策略一致，只不过 reExecutePeriodic 不会执行拒绝策略而是直接丢弃任务。</p>
<h4 id=cancel>cancel</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>mayInterruptIfRunning</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>cancelled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mayInterruptIfRunning</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cancelled</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>removeOnCancel</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>heapIndex</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cancelled</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ScheduledFutureTask.cancel 本质上由其父类 FutureTask.cancel 实现。取消任务成功后会根据 removeOnCancel 参数来决定是否从队列中移除该任务。</p>
<h3 id=核心属性>核心属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//关闭后继续执行已经存在的周期任务 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>continueExistingPeriodicTasksAfterShutdown</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//关闭后继续执行已经存在的延时任务 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>executeExistingDelayedTasksAfterShutdown</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//取消任务后移除 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removeOnCancel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>//为相同延时的任务提供的顺序编号，保证任务之间的FIFO顺序
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicLong</span> <span style=color:#000>sequencer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><ul>
<li>前两个参数是由 ScheduledThreadPoolExecutor 定义的 run-after-shutdown 参数，用于控制池关闭后任务的执行逻辑。</li>
<li>removeOnCancel：用于控制取消任务后是否从队列中移除。
<ul>
<li>当一个已经提交的周期或延迟任务在运行之前被取消，那么它之后将不会再被执行。</li>
<li>默认配置下，这种已经取消的任务在届期之前不会被移除。</li>
<li>通过这种机制，可以方便检查和监控线程池状态，但也可能导致已经取消的任务无线滞留。</li>
<li>为了避免无线滞留，可以通过 setRemoveOnCancelPolicy 来设置移除策略，将参数 removeOnCancel 设为 true 可以在任务取消后立即从队列中移除。</li>
<li>sequencer 是为具有相同延时时间的任务提供顺序编号，保证任务之间的 FIFO 顺序。与 ScheduledFutureTask 内部的 sequenceNumber 参数作用一致。</li>
</ul>
</li>
</ul>
<h3 id=构造函数>构造函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ScheduledThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>,</span>
                                   <span style=color:#000>ThreadFactory</span> <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span>
                                   <span style=color:#000>RejectedExecutionHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>NANOSECONDS</span><span style=color:#ce5c00;font-weight:700>,</span>
          <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DelayedWorkQueue</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>threadFactory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>核心线程数</li>
<li>线程工厂</li>
<li>拒绝策略</li>
</ul>
<h3 id=核心方法schedule>核心方法：schedule</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public &lt;V&gt; ScheduledFuture&lt;V&gt; schedule(Callable&lt;V&gt; callable,
                                       long delay,
                                       TimeUnit unit) {
    if (callable == null || unit == null)
        throw new NullPointerException();
    RunnableScheduledFuture&lt;V&gt; t = decorateTask(callable,
        new ScheduledFutureTask&lt;V&gt;(callable, triggerTime(delay, unit)));//构造ScheduledFutureTask任务
    delayedExecute(t);//任务执行主方法
    return t;
}
</code></pre></div><p>主要用于执行一次性延迟任务，执行逻辑分为两步：</p>
<ul>
<li>
<p>封装 Callable/Runnable：通过 triggerTime 计算出任务的延迟执行时加点，然后通过 ScheduledFutureTask 的构造函数将 Runnable/Callable 任务构造为 ScheduledThreadPoolExecutor 可以执行的任务类型，最后调用 decorateTask 方法执行用户自定义的任务逻辑。</p>
<ul>
<li>decorateTask 是一个用户可以自定义扩展的方法，默认实现下直接返回封装的 RunnableScheduledFuture：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>decorateTask</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#000>Runnable</span> <span style=color:#000>runnable</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>执行任务：通过 delayedExecute 实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delayedExecute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isShutdown</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#000>reject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//池已关闭，执行拒绝策略
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueue</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//任务入队
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isShutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>canRunInCurrentRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPeriodic</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span><span style=color:#8f5902;font-style:italic>//判断run-after-shutdown参数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//移除任务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>ensurePrestart</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//启动一个新的线程等待任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>如果池已经关闭(ctr &lt;= SHUTDOWN)，执行任务拒绝策略。</li>
<li>池正在运行，首先将任务入队排序，然后重新检查池的关闭状态，执行如下逻辑：
<ul>
<li>如果池正在运行，或者 run-after-shutdown 参数为 true，则调用父类方法 ensurePrestart 启动新线程等待执行任务。</li>
</ul>
</li>
<li>如果池已经关闭，并且 run-after-shutdown 参数为 false，则执行父类(ThreadPoolExecutor)方法 remove 移除队列中的指定任务，成功移除后调用 ScheduledFutureTask.cancel 取消任务。</li>
</ul>
</li>
</ul>
<p>ensurePrestart 源码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensurePrestart</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workerCountOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>corePoolSize</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>addWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>addWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>ensurePrestart是父类 ThreadPoolExecutor 的方法，用于启动一个新的工作线程等待执行任务，即使corePoolSize为0也会安排一个新线程。</p>
<h3 id=核心方法scheduleatfixedrateschedulewithfixeddelay>核心方法：scheduleAtFixedRate、scheduleWithFixedDelay</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 创建一个周期执行的任务，第一次执行延期时间为initialDelay，
</span><span style=color:#8f5902;font-style:italic> * 之后每隔period执行一次，不等待第一次执行完成就开始计时
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>scheduleAtFixedRate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span>
                                              <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>initialDelay</span><span style=color:#ce5c00;font-weight:700>,</span>
                                              <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>period</span><span style=color:#ce5c00;font-weight:700>,</span>
                                              <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>unit</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>period</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//构建RunnableScheduledFuture任务类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ScheduledFutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sft</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ScheduledFutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>triggerTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialDelay</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>),</span><span style=color:#8f5902;font-style:italic>//计算任务的延迟时间
</span><span style=color:#8f5902;font-style:italic></span>                                      <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>period</span><span style=color:#ce5c00;font-weight:700>));</span><span style=color:#8f5902;font-style:italic>//计算任务的执行周期
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>decorateTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sft</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//执行用户自定义逻辑
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>sft</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>outerTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//赋值给outerTask，准备重新入队等待下一次执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>delayedExecute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//执行任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 创建一个周期执行的任务，第一次执行延期时间为initialDelay，
</span><span style=color:#8f5902;font-style:italic> * 在第一次执行完之后延迟delay后开始下一次执行
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>scheduleWithFixedDelay</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Runnable</span> <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>initialDelay</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                 <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>unit</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>delay</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//构建RunnableScheduledFuture任务类型
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ScheduledFutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sft</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ScheduledFutureTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>triggerTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>initialDelay</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>),</span><span style=color:#8f5902;font-style:italic>//计算任务的延迟时间
</span><span style=color:#8f5902;font-style:italic></span>                                      <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toNanos</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>delay</span><span style=color:#ce5c00;font-weight:700>));</span><span style=color:#8f5902;font-style:italic>//计算任务的执行周期
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Void</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>decorateTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sft</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//执行用户自定义逻辑
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>sft</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>outerTask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//赋值给outerTask，准备重新入队等待下一次执行
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>delayedExecute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//执行任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>二者的区别在于 unit.toNanos，scheduleAtFixedRate 传的是正值，而 scheduleWithFixedDelay 传的则是负值，这个值就是 ScheduledFutureTask 的 period 属性。</p>
<h3 id=核心方法shutdown>核心方法：shutdown</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>shutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//取消并清除由于关闭策略不应该运行的所有任务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#5c35cc;font-weight:700>@Override</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onShutdown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>BlockingQueue</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getQueue</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//获取run-after-shutdown参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>keepDelayed</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#000>getExecuteExistingDelayedTasksAfterShutdownPolicy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>keepPeriodic</span> <span style=color:#ce5c00;font-weight:700>=</span>
        <span style=color:#000>getContinueExistingPeriodicTasksAfterShutdownPolicy</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>keepDelayed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>keepPeriodic</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//池关闭后不保留任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//依次取消任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>())</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span>
                <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//清除等待队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//池关闭后保留任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// Traverse snapshot to avoid iterator exceptions
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//遍历快照以避免迭代器异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RunnableScheduledFuture</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isPeriodic</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>keepPeriodic</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>keepDelayed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
                    <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isCancelled</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// also remove if already cancelled
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>//如果任务已经取消，移除队列中的任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>))</span>
                        <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>tryTerminate</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//终止线程池
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>池关闭方法调用了父类ThreadPoolExecutor的shutdown。</p>
<p>在shutdown方法中调用了关闭钩子onShutdown方法，它的主要作用是在关闭线程池后取消并清除由于关闭策略不应该运行的所有任务，这里主要是根据 run-after-shutdown 参数(continueExistingPeriodicTasksAfterShutdown和executeExistingDelayedTasksAfterShutdown)来决定线程池关闭后是否关闭已经存在的任务。</p>
<h2 id=深入理解>深入理解</h2>
<p><strong>为什么ThreadPoolExecutor 的调整策略却不适用于 ScheduledThreadPoolExecutor？</strong></p>
<p>例如: 由于 ScheduledThreadPoolExecutor 是一个固定核心线程数大小的线程池，并且使用了一个无界队列，所以调整maximumPoolSize对其没有任何影响(所以 ScheduledThreadPoolExecutor 没有提供可以调整最大线程数的构造函数，默认最大线程数固定为Integer.MAX_VALUE)。此外，设置corePoolSize为0或者设置核心线程空闲后清除(allowCoreThreadTimeOut)同样也不是一个好的策略，因为一旦周期任务到达某一次运行周期时，可能导致线程池内没有线程去处理这些任务。</p>
<p><strong>Executors 提供了哪几种方法来构造 ScheduledThreadPoolExecutor？</strong></p>
<ul>
<li>newScheduledThreadPool: 可指定核心线程数的线程池。</li>
<li>newSingleThreadScheduledExecutor: 只有一个工作线程的线程池。如果内部工作线程由于执行周期任务异常而被终止，则会新建一个线程替代它的位置。</li>
</ul>
<p>注意: newScheduledThreadPool(1, threadFactory) 不等价于newSingleThreadScheduledExecutor。newSingleThreadScheduledExecutor创建的线程池保证内部只有一个线程执行任务，并且线程数不可扩展；而通过newScheduledThreadPool(1, threadFactory)创建的线程池可以通过setCorePoolSize方法来修改核心线程数。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-531d2ce180397e0c2a4d70c4932f0d30>3.23 - CH23-ForkJoin.md</h1>
<h2 id=概览>概览</h2>
<p>ForkJoin 框架是 JUC 中一种可以将大任务拆分为多个小任务并异步执行的工具，由 JDK 1.7 引入。</p>
<h3 id=层级结构>层级结构</h3>
<p>主要包含 3 个模块：</p>
<ul>
<li>任务对象：ForkJoinTask
<ul>
<li>RecursiveTask</li>
<li>RecursiveAction</li>
<li>CountedCompleter</li>
</ul>
</li>
<li>执行线程：ForkJoinWorkerThread</li>
<li>线程池：ForkJoinPool</li>
</ul>
<p>ForkJoinPool 可以通过池中的 ForkJoinThread 来处理 ForkJoinTask。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>// from 《A Java Fork/Join Framework》Dong Lea
Result solve(Problem problem) {
	if (problem is small)
 		directly solve problem
 	else {
 		split problem into independent parts
 		fork new subtasks to solve each part
 		join all subtasks
 		compose result from subresults
	}
}
</code></pre></div><ul>
<li>ForkJoinPool 只接收 ForkJoinTask 任务(在实际使用中，也可以接收 Runnable/Callable 任务，但在真正运行时，也会把这些任务封装成 ForkJoinTask 类型的任务)。</li>
<li>RecursiveTask 是 ForkJoinTask 的子类，是一个可以递归执行的 ForkJoinTask。</li>
<li>RecursiveAction 是一个无返回值的 RecursiveTask。</li>
<li>CountedCompleter 在任务完成执行后会触发执行一个自定义的钩子函数。</li>
</ul>
<p>在实际运用中，我们一般都会继承 <code>RecursiveTask</code> 、<code>RecursiveAction</code> 或 <code>CountedCompleter</code> 来实现我们的业务需求，而不会直接继承 ForkJoinTask 类。</p>
<h3 id=核心思想分治算法>核心思想：分治算法</h3>
<p>分治算法(Divide-and-Conquer)把任务递归的拆分为各个子任务，这样可以更好的利用系统资源，尽可能的使用所有可用的计算能力来提升应用性能。首先看一下 Fork/Join 框架的任务运行机制:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429141017.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=核心思想work-stealing>核心思想：work-stealing</h3>
<p>work-stealing(工作窃取)算法: 线程池内的所有工作线程都尝试找到并执行已经提交的任务，或者是被其他活动任务创建的子任务(如果不存在就阻塞等待)。</p>
<p>这种特性使得 ForkJoinPool 在运行多个可以产生子任务的任务，或者是提交的许多小任务时效率更高。尤其是构建异步模型的 ForkJoinPool 时，对不需要合并(join)的事件类型任务也非常适用。</p>
<p>在 ForkJoinPool 中，线程池中每个工作线程(ForkJoinWorkerThread)都对应一个任务队列(WorkQueue)，工作线程优先处理来自自身队列的任务(LIFO或FIFO顺序，参数 mode 决定)，然后以FIFO的顺序随机窃取其他队列中的任务。</p>
<p>具体思路如下：</p>
<ul>
<li>每个线程都有自己的 WorkQueue，这是一个双端队列。</li>
<li>队列支持三个功能：push、pop、poll。</li>
<li>push、pop 只能被队列的拥有线程调用，而 poll 可以被其他线程调用。</li>
<li>划分的子任务调用 fork 时，都会被 push 到自己的队列中。</li>
<li>默认情况下，工作线程从自己的双端队列中获取任务并执行。</li>
<li>当工作线程自己的队列已空，会随机从另一个线程的队列的尾部调用 poll 方法窃取任务。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429141504.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=执行流程>执行流程</h3>
<p>上图可以看出任务有两类：</p>
<ul>
<li>直接通过 ForkJoinPool 提交的外部任务，存放在 workQueues 的偶数槽位。</li>
<li>通过内部 fork 分割的子任务，存放在 workQueues 的奇数槽位。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429141646.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=类层级>类层级</h2>
<h3 id=继承关系>继承关系</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429141800.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=内部类>内部类</h3>
<ul>
<li>ForkJoinWorkerThreadFactory：内部线程工厂接口，用于创建工作线程 ForkJoinWorkerThread。
<ul>
<li>DefautFaorkJoinWorkerThreadFactory：默认线程工厂。</li>
<li>InnocuousForkJoinWorkerThreadFactory：无许可线程工厂，当系统变量中存在系统安全相关的属性时，使用该线程工厂。</li>
</ul>
</li>
<li>EmptyTask：内部占位类，用户替换队列中 join 的任务。</li>
<li>ManagedBlocker：为 ForkJoinPool 中的任务提供扩展管理并行数的接口，一般用于可能会阻塞的任务。</li>
<li>WorkQueue：ForkJoinPool 的核心数据结构，本质上是 work-stealing 模式的双端任务队列，内部存放 ForkJoinTask 任务对象，使用 @Contented 注解修饰防止伪共享。
<ul>
<li>工作线程在运行中产生新的任务(通常是应为调用了 fork)时，可以把 WorkQueue 的数据结构视为一个栈，新的任务放入栈顶；工作线程在处理自己队列中的任务时，按照 LIFO 的顺序。</li>
<li>工作线程在处理自己的工作队列的同时，会尝试窃取一个任务(可能来自刚刚提交到池的任务，或是来之其他工作线程的队列任务)，此时可以把 WorkQueue 的数据结构视为一个 FIFO 队列，窃取任务唯一其他线程的工作队列的队首。</li>
</ul>
</li>
<li>伪共享状态：缓存系统中是以缓存行(cache line)为单位存储的。缓存行是 2 的整数幂个连续字节，一般为 32-256 个字节。最常见的缓存行大小是 64 字节。但多线程修改互相独立的变量时，如果这些变量共享同一个缓存行，就会无意中影响彼此的性能，即伪共享。</li>
</ul>
<h3 id=forkjointask-继承关系>ForkJoinTask 继承关系</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429142615.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>ForkJoinTask 实现了 Future 接口，说明它也是一个可取消的异步运算任务。
<ul>
<li>实际上ForkJoinTask 是 Future 的轻量级实现，主要用在纯粹是计算的函数式任务或者操作完全独立的对象计算任务。</li>
<li>fork 是主运行方法，用于异步执行；而 join 方法在任务结果计算完毕之后才会运行，用来合并或返回计算结果。</li>
</ul>
</li>
<li>其内部类都比较简单：
<ul>
<li>ExceptionNode 是用于存储任务执行期间的异常信息的单向链表；</li>
<li>其余四个类是为 Runnable/Callable 任务提供的适配器类，用于把 Runnable/Callable 转化为 ForkJoinTask 类型的任务(因为 ForkJoinPool 只可以运行 ForkJoinTask 类型的任务)。</li>
</ul>
</li>
</ul>
<h2 id=源码解析>源码解析</h2>
<ul>
<li>提交流程：外部任务提交</li>
<li>提交流程：子任务提交</li>
<li>执行过程：ForkJoinWorkerThread.run -> ForkJoinTask.doExec</li>
<li>结果获取：ForkJoinTask.join -> ForkJoinTask.invoke</li>
</ul>
<h3 id=forkjoinpool>ForkJoinPool</h3>
<h4 id=核心参数>核心参数</h4>
<blockquote>
<p>在后面的源码解析中，我们会看到大量的位运算，这些位运算都是通过我们接下来介绍的一些常量参数来计算的。</p>
<p>例如，如果要更新活跃线程数，使用公式(UC_MASK & (c + AC_UNIT)) | (SP_MASK & c)；c 代表当前 ctl，UC_MASK 和 SP_MASK 分别是高位和低位掩码，AC_UNIT 为活跃线程的增量数，使用(UC_MASK & (c + AC_UNIT))就可以计算出高32位，然后再加上低32位(SP_MASK & c)，就拼接成了一个新的ctl。</p>
</blockquote>
<p>ForkJoinPool 与 内部类 WorkQueue 共享的一些常量:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Constants shared across ForkJoinPool and WorkQueue
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// 限定参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SMASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xffff</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>//  低位掩码，也是最大索引位
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAX_CAP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x7fff</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>//  工作线程最大容量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>EVENMASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xfffe</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>//  偶数低位掩码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SQMASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x007e</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>//  workQueues 数组最多64个槽位
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// ctl 子域和 WorkQueue.scanState 的掩码和标志位
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SCANNING</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>             <span style=color:#8f5902;font-style:italic>// 标记是否正在运行任务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INACTIVE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>31</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 失活状态  负数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SS_SEQ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 版本戳，防止ABA问题
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// ForkJoinPool.config 和 WorkQueue.config 的配置信息标记
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MODE_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xffff</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 模式掩码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>LIFO_QUEUE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//LIFO队列
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>FIFO_QUEUE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//FIFO队列
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SHARED_QUEUE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>31</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 共享模式队列，负数
</span></code></pre></div><p>ForkJoinPool 中的相关常量和实例字段:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//  低位和高位掩码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>SP_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xffffffffL</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>UC_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>SP_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// 活跃线程数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>AC_SHIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>48</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>AC_UNIT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x0001L</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>AC_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//活跃线程数增量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>AC_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xffffL</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>AC_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//活跃线程数掩码
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// 工作线程数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>TC_SHIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>32</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>TC_UNIT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x0001L</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>TC_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//工作线程数增量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>TC_MASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xffffL</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>TC_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//掩码
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>ADD_WORKER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x0001L</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TC_SHIFT</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>15</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// 创建工作线程标志
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// 池状态
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>RSLOCK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>RSIGNAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>STARTED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>STOP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>29</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>TERMINATED</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>30</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SHUTDOWN</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>31</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// 实例字段
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>// 主控制参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>runState</span><span style=color:#ce5c00;font-weight:700>;</span>               <span style=color:#8f5902;font-style:italic>// 运行状态锁
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>;</span>                    <span style=color:#8f5902;font-style:italic>// 并行度|模式
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>indexSeed</span><span style=color:#ce5c00;font-weight:700>;</span>                       <span style=color:#8f5902;font-style:italic>// 用于生成工作线程索引
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>// 主对象注册信息，workQueue
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ForkJoinWorkerThreadFactory</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>// 线程工厂
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>UncaughtExceptionHandler</span> <span style=color:#000>ueh</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 每个工作线程的异常信息
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>workerNamePrefix</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// 用于创建工作线程的名称
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>AtomicLong</span> <span style=color:#000>stealCounter</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>// 偷取任务总数，也可作为同步监视器
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>/** 静态初始化字段 */</span>
<span style=color:#8f5902;font-style:italic>//线程工厂
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ForkJoinWorkerThreadFactory</span> <span style=color:#000>defaultForkJoinWorkerThreadFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//启动或杀死线程的方法调用者的权限
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>RuntimePermission</span> <span style=color:#000>modifyThreadPermission</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>// 公共静态pool
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ForkJoinPool</span> <span style=color:#000>common</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//并行度，对应内部common池
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>commonParallelism</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//备用线程数，在tryCompensate中使用
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>commonMaxSpares</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//创建workerNamePrefix(工作线程名称前缀)时的序号
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>poolNumberSequence</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//线程阻塞等待新的任务的超时值(以纳秒为单位)，默认2秒
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>IDLE_TIMEOUT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2000L</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000L</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000L</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 2sec
</span><span style=color:#8f5902;font-style:italic>//空闲超时时间，防止timer未命中
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>TIMEOUT_SLOP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20L</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000L</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1000L</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 20ms
</span><span style=color:#8f5902;font-style:italic>//默认备用线程数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DEFAULT_COMMON_MAX_SPARES</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>256</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//阻塞前自旋的次数，用在在awaitRunStateLock和awaitWork中
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SPINS</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//indexSeed的增量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SEED_INCREMENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x9e3779b9</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>ForkJoinPool 的内部状态都是通过一个64位的 long 型 变量ctl来存储，它由四个16位的子域组成:</p>
<ul>
<li>AC: 正在运行工作线程数减去目标并行度，高16位</li>
<li>TC: 总工作线程数减去目标并行度，中高16位</li>
<li>SS: 栈顶等待线程的版本计数和状态，中低16位</li>
<li>ID: 栈顶 WorkQueue 在池中的索引(poolIndex)，低16位</li>
</ul>
<p>某些地方也提取了ctl的低32位(sp=(int)ctl)来检查工作线程状态，例如，当sp不为0时说明当前还有空闲工作线程。</p>
<h4 id=forkjoinpoolworkqueue-中的相关属性>ForkJoinPool.WorkQueue 中的相关属性:</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//初始队列容量，2的幂
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INITIAL_QUEUE_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//最大队列容量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAXIMUM_QUEUE_CAPACITY</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>26</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 64M
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// 实例字段
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>scanState</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>// Woker状态, &lt;0: inactive; odd:scanning
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>stackPred</span><span style=color:#ce5c00;font-weight:700>;</span>             <span style=color:#8f5902;font-style:italic>// 记录前一个栈顶的ctl
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nsteals</span><span style=color:#ce5c00;font-weight:700>;</span>               <span style=color:#8f5902;font-style:italic>// 偷取任务数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hint</span><span style=color:#ce5c00;font-weight:700>;</span>                  <span style=color:#8f5902;font-style:italic>// 记录偷取者索引，初始为随机索引
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>config</span><span style=color:#ce5c00;font-weight:700>;</span>                <span style=color:#8f5902;font-style:italic>// 池索引和模式
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>qlock</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 1: locked, &lt; 0: terminate; else 0
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#8f5902;font-style:italic>//下一个poll操作的索引(栈底/队列头)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>top</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>//  下一个push操作的索引(栈顶/队列尾)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>// 任务数组
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ForkJoinPool</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>// the containing pool (may be null)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ForkJoinWorkerThread</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 当前工作队列的工作线程，共享模式下为null
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Thread</span> <span style=color:#000>parker</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>// 调用park阻塞期间为owner，其他情况为null
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>currentJoin</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 记录被join过来的任务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>currentSteal</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 记录从其他工作队列偷取过来的任务
</span></code></pre></div><h3 id=forkjointask>ForkJoinTask</h3>
<h4 id=核心参数-1>核心参数</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 任务运行状态 */</span>
<span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 任务运行状态
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>DONE_MASK</span>   <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xf0000000</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 任务完成状态标志位
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NORMAL</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xf0000000</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// must be negative
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>CANCELLED</span>   <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xc0000000</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// must be &lt; NORMAL
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>EXCEPTIONAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x80000000</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// must be &lt; CANCELLED
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SIGNAL</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x00010000</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// must be &gt;= 1 &lt;&lt; 16 等待信号
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SMASK</span>       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x0000ffff</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//  低位掩码
</span></code></pre></div><h3 id=forkjoinpool构造函数>ForkJoinPool：构造函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parallelism</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>ForkJoinWorkerThreadFactory</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#000>UncaughtExceptionHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span>
                    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>asyncMode</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>checkParallelism</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parallelism</span><span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>checkFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>),</span>
            <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>asyncMode</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>FIFO_QUEUE</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>LIFO_QUEUE</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;ForkJoinPool-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>nextPoolId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;-worker-&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>checkPermission</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>parallelism: 并行度，默认为CPU数，最小为1</li>
<li>factory: 工作线程工厂</li>
<li>handler: 处理工作线程运行任务时的异常情况类，默认为null</li>
<li>asyncMode: 是否为异步模式，默认为 false。
<ul>
<li>如果为true，表示子任务的执行遵循 FIFO 顺序并且任务不能被合并(join)，这种模式适用于工作线程只运行事件类型的异步任务。</li>
</ul>
</li>
</ul>
<p>在多数场景使用时，如果没有太强的业务需求，我们一般直接使用 ForkJoinPool 中的common池，在JDK1.8之后提供了ForkJoinPool.commonPool()方法可以直接使用common池，来看一下它的构造:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ForkJoinPool</span> <span style=color:#000>makeCommonPool</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parallelism</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ForkJoinWorkerThreadFactory</span> <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>UncaughtExceptionHandler</span> <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// ignore exceptions in accessing/parsing
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java.util.concurrent.ForkJoinPool.common.parallelism&#34;</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//并行度
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>fp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java.util.concurrent.ForkJoinPool.common.threadFactory&#34;</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//线程工厂
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>String</span> <span style=color:#000>hp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java.util.concurrent.ForkJoinPool.common.exceptionHandler&#34;</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//异常处理类
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>parallelism</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pp</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ForkJoinWorkerThreadFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span>
                    <span style=color:#000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fp</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hp</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>UncaughtExceptionHandler</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ClassLoader</span><span style=color:#ce5c00;font-weight:700>.</span>
                    <span style=color:#000>getSystemClassLoader</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>loadClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hp</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>newInstance</span><span style=color:#ce5c00;font-weight:700>());</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ignore</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSecurityManager</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>defaultForkJoinWorkerThreadFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#8f5902;font-style:italic>// use security-managed default
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InnocuousForkJoinWorkerThreadFactory</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parallelism</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#8f5902;font-style:italic>// default 1 less than #cores
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parallelism</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>parallelism</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//默认并行度为1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parallelism</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_CAP</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>parallelism</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MAX_CAP</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parallelism</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>LIFO_QUEUE</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#4e9a06>&#34;ForkJoinPool.commonPool-worker-&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用common pool的优点就是我们可以通过指定系统参数的方式定义“并行度、线程工厂和异常处理类”；并且它使用的是同步模式，也就是说可以支持任务合并(join)。</p>
<h3 id=forkjoinpool外部任务提交>ForkJoinPool：外部任务提交</h3>
<p>向 ForkJoinPool 提交任务有三种方式:</p>
<ul>
<li>invoke()会等待任务计算完毕并返回计算结果；</li>
<li>execute()是直接向池提交一个任务来异步执行，无返回结果；</li>
<li>submit()也是异步执行，但是会返回提交的任务，在适当的时候可通过 task.get() 获取执行结果。</li>
</ul>
<p>这三种提交方式都都是调用externalPush()方法来完成，所以接下来我们将从externalPush()方法开始逐步分析外部任务的执行过程。</p>
<h4 id=externalpush>externalPush</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//添加给定任务到submission队列中
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>externalPush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>WorkQueue</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProbe</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//探针值，用于计算WorkQueue槽位索引
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runState</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SQMASK</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#8f5902;font-style:italic>//获取随机偶数槽位的workQueue
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//锁定workQueue
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>am</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>am</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>am</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//计算任务索引位置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//任务入列
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QTOP</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//更新push slot
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putIntVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//解除锁定
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>signalWork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//任务数小于1时尝试创建或激活一个工作线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//解除锁定
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>externalSubmit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//初始化workQueues及相关属性
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>externalPush和externalSubmit两个方法的联系：</p>
<ul>
<li>它们的作用都是把任务放到队列中等待执行。</li>
<li>不同的是，externalSubmit可以说是完整版的externalPush，在任务首次提交时，需要初始化workQueues及其他相关属性，这个初始化操作就是externalSubmit来完成的；</li>
<li>而后再向池中提交的任务都是通过简化版的externalSubmit-externalPush来完成。</li>
</ul>
<p>externalPush的执行流程很简单: 首先找到一个随机偶数槽位的 workQueue，然后把任务放入这个 workQueue 的任务数组中，并更新top位。如果队列的剩余任务数小于1，则尝试创建或激活一个工作线程来运行任务(防止在externalSubmit初始化时发生异常导致工作线程创建失败)。</p>
<h4 id=externalsubmit>externalSubmit</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//任务提交
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>externalSubmit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//初始化调用线程的探针值，用于计算WorkQueue索引
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>;</span>                                    <span style=color:#8f5902;font-style:italic>// initialize caller&#39;s probe
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProbe</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>localInit</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProbe</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>WorkQueue</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>move</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>// 池已关闭
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>tryTerminate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>     <span style=color:#8f5902;font-style:italic>// help terminate
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RejectedExecutionException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//初始化workQueues
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>STARTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span>     <span style=color:#8f5902;font-style:italic>// initialize
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lockRunState</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//锁定runState
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//初始化
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>STARTED</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#8f5902;font-style:italic>//初始化stealCounter
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STEALCOUNTER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicLong</span><span style=color:#ce5c00;font-weight:700>());</span>
                    <span style=color:#8f5902;font-style:italic>//创建workQueues，容量为2的幂次方
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// create workQueues array with size a power of two
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SMASK</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// ensure at least 2 slots
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>16</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>workQueues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>];</span>
                    <span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STARTED</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>unlockRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>RSLOCK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//解锁并更新runState
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SQMASK</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//获取随机偶数槽位的workQueue
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>qlock</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//锁定 workQueue
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//当前workQueue的全部任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>submitted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// initial submission or resizing
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>                      <span style=color:#8f5902;font-style:italic>// locked version of push
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>growArray</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//扩容
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//放入给定任务
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QTOP</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//修改push slot
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>submitted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//解除锁定
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>submitted</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//任务提交成功，创建或激活工作线程
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>signalWork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//创建或激活一个工作线程来运行任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>move</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>// move on failure 操作失败，重新获取探针值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>runState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>RSLOCK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// create new queue
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>SHARED_QUEUE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>INACTIVE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lockRunState</span><span style=color:#ce5c00;font-weight:700>();</span>           <span style=color:#8f5902;font-style:italic>// publish index
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>                 <span style=color:#8f5902;font-style:italic>// 更新索引k位值的workQueue
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//else terminated
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>unlockRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>RSLOCK</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>move</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>// move if busy
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>move</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>advanceProbe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//重新获取线程探针值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>externalSubmit是externalPush的完整版本，主要用于第一次提交任务时初始化workQueues及相关属性，并且提交给定任务到队列中。具体执行步骤如下:</p>
<ol>
<li>
<p>如果池为终止状态(runState&lt;0)，调用tryTerminate来终止线程池，并抛出任务拒绝异常；</p>
</li>
<li>
<p>如果尚未初始化，就为 FJP 执行初始化操作: 初始化stealCounter、创建workerQueues，然后继续自旋；</p>
</li>
<li>
<p>初始化完成后，执行在externalPush中相同的操作: 获取 workQueue，放入指定任务。任务提交成功后调用signalWork方法创建或激活线程；</p>
</li>
<li>
<p>如果在步骤3中获取到的 workQueue 为null，会在这一步中创建一个 workQueue，创建成功继续自旋执行第三步操作；</p>
</li>
<li>
<p>如果非上述情况，或者有线程争用资源导致获取锁失败，就重新获取线程探针值继续自旋。</p>
</li>
</ol>
<h4 id=signalwork>signalWork</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>signalWork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WorkQueue</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>WorkQueue</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Thread</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                       <span style=color:#8f5902;font-style:italic>// too few active
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                  <span style=color:#8f5902;font-style:italic>// no idle workers
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>ADD_WORKER</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span>            <span style=color:#8f5902;font-style:italic>// too few workers
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>tryAddWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//工作线程太少，添加新的工作线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>                            <span style=color:#8f5902;font-style:italic>// unstarted/terminated
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SMASK</span><span style=color:#ce5c00;font-weight:700>))</span>         <span style=color:#8f5902;font-style:italic>// terminated
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>                   <span style=color:#8f5902;font-style:italic>// terminating
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//计算ctl，加上版本戳SS_SEQ避免ABA问题
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>vs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SS_SEQ</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>INACTIVE</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// next scanState
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span><span style=color:#ce5c00;font-weight:700>;</span>                  <span style=color:#8f5902;font-style:italic>// screen CAS
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SP_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stackPred</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>vs</span><span style=color:#ce5c00;font-weight:700>;</span>                      <span style=color:#8f5902;font-style:italic>// activate v
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parker</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//唤醒阻塞线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#8f5902;font-style:italic>// no more work
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>新建或唤醒一个工作线程，在externalPush、externalSubmit、workQueue.push、scan中调用。如果还有空闲线程，则尝试唤醒索引到的 WorkQueue 的parker线程；如果工作线程过少((ctl & ADD_WORKER) != 0L)，则调用tryAddWorker添加一个新的工作线程。</p>
<h4 id=tryaddworker>tryAddWorker</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>tryAddWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span>
                   <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>TC_UNIT</span><span style=color:#ce5c00;font-weight:700>)));</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctl</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stop</span><span style=color:#ce5c00;font-weight:700>;</span>                 <span style=color:#8f5902;font-style:italic>// check if terminating
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>stop</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lockRunState</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>STOP</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>add</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nc</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>unlockRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>RSLOCK</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//释放锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stop</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>createWorker</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//创建工作线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>ADD_WORKER</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0L</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>尝试添加一个新的工作线程，首先更新ctl中的工作线程数，然后调用createWorker()创建工作线程。</p>
<h4 id=createworker>createWorker</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>createWorker</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ForkJoinWorkerThreadFactory</span> <span style=color:#000>fac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>factory</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Throwable</span> <span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ForkJoinWorkerThread</span> <span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fac</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fac</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>rex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>rex</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>deregisterWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//线程创建失败处理
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>createWorker首先通过线程工厂创一个新的ForkJoinWorkerThread，然后启动这个工作线程(wt.start())。如果期间发生异常，调用deregisterWorker处理线程创建失败的逻辑(deregisterWorker在后面再详细说明)。</p>
<p>ForkJoinWorkerThread 的构造函数如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>ForkJoinWorkerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinPool</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Use a placeholder until a useful name can be set in registerWorker
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aForkJoinWorkerThread&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>workQueue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>registerWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到 ForkJoinWorkerThread 在构造时首先调用父类 Thread 的方法，然后为工作线程注册pool和workQueue，而workQueue的注册任务由ForkJoinPool.registerWorker来完成。</p>
<h4 id=registerworker>registerWorker</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>WorkQueue</span> <span style=color:#000>registerWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinWorkerThread</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>UncaughtExceptionHandler</span> <span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//设置为守护线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDaemon</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>                           <span style=color:#8f5902;font-style:italic>// configure thread
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ueh</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUncaughtExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>WorkQueue</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//构造新的WorkQueue
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                                    <span style=color:#8f5902;font-style:italic>// assign a pool index
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MODE_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lockRunState</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>                    <span style=color:#8f5902;font-style:italic>// skip if no array
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//生成新建WorkQueue的索引
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>indexSeed</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>SEED_INCREMENT</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// unlikely to collide
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>               <span style=color:#8f5902;font-style:italic>// Worker任务放在奇数索引位 odd-numbered indices
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                  <span style=color:#8f5902;font-style:italic>// collision 已存在，重新计算索引位
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>probes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>// step by approx half n
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>step</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>EVENMASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>//查找可用的索引位
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>step</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>probes</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//所有索引位都被占用，对workQueues进行扩容
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>workQueues</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//workQueues 扩容
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>probes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>                           <span style=color:#8f5902;font-style:italic>// use as random seed
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>                      <span style=color:#8f5902;font-style:italic>// publication fence
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>unlockRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>RSLOCK</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>workerNamePrefix</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>concat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)));</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>registerWorker是 ForkJoinWorkerThread 构造器的回调函数，用于创建和记录工作线程的 WorkQueue。比较简单，就不多赘述了。注意在此为工作线程创建的 WorkQueue 是放在奇数索引的(代码行: i = ((s &#171; 1) | 1) & m;)</p>
<h4 id=总结>总结</h4>
<p>在createWorker()中启动工作线程后(wt.start())，当为线程分配到CPU执行时间片之后会运行 ForkJoinWorkerThread 的run方法开启线程来执行任务。工作线程执行任务的流程我们在讲完内部任务提交之后会统一讲解。</p>
<h3 id=forkjoinpool子任务提交>ForkJoinPool：子任务提交</h3>
<p>子任务的提交相对比较简单，由任务的fork()方法完成。通过上面的流程图可以看到任务被分割(fork)之后调用了ForkJoinPool.WorkQueue.push()方法直接把任务放到队列中等待被执行。</p>
<h4 id=forkjointaskfork>ForkJoinTask.fork()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fork</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ForkJoinWorkerThread</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ForkJoinWorkerThread</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>externalPush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>如果当前线程是 Worker 线程，说明当前任务是fork分割的子任务，通过ForkJoinPool.workQueue.push()方法直接把任务放到自己的等待队列中；</li>
<li>否则调用ForkJoinPool.externalPush()提交到一个随机的等待队列中(外部任务)。</li>
</ul>
<h4 id=forkjoinpoolworkqueuepush>ForkJoinPool.WorkQueue.push()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ForkJoinPool</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>top</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#8f5902;font-style:italic>// ignore if queue removed
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>// fenced write for task visibility
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QTOP</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//首次提交，创建或唤醒一个工作线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>signalWork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>workQueues</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>growArray</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先把任务放入等待队列并更新top位；如果当前 WorkQueue 为新建的等待队列(top-base&lt;=1)，则调用signalWork方法为当前 WorkQueue 新建或唤醒一个工作线程；如果 WorkQueue 中的任务数组容量过小，则调用growArray()方法对其进行两倍扩容，growArray()方法源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>growArray</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>oldA</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//获取内部任务列表
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldA</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>oldA</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>INITIAL_QUEUE_CAPACITY</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAXIMUM_QUEUE_CAPACITY</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RejectedExecutionException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Queue capacity exceeded&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldMask</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//新建一个两倍容量的任务数组
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldA</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldMask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldA</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>top</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//从老数组中拿出数据，放到新的数组中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// emulate poll from old array, push to new array
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldj</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>oldMask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>mask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldA</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>oldj</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldA</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>oldj</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=总结-1>总结</h4>
<p>到此，两种任务的提交流程都已经解析完毕，下一节我们来一起看看任务提交之后是如何被运行的。</p>
<h3 id=forkjoinpool任务执行>ForkJoinPool：任务执行</h3>
<p>回到我们开始时的流程图，在ForkJoinPool .createWorker()方法中创建工作线程后，会启动工作线程，系统为工作线程分配到CPU执行时间片之后会执行 ForkJoinWorkerThread 的run()方法正式开始执行任务。</p>
<h4 id=forkjoinworkerthreadrun>ForkJoinWorkerThread.run()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// only run once
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Throwable</span> <span style=color:#000>exception</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>onStart</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//钩子方法，可自定义扩展
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>workQueue</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>exception</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>onTermination</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//钩子方法，可自定义扩展
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#000>exception</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deregisterWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//处理异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在工作线程运行前后会调用自定义钩子函数(onStart和onTermination)，任务的运行则是调用了ForkJoinPool.runWorker()。如果全部任务执行完毕或者期间遭遇异常，则通过ForkJoinPool.deregisterWorker关闭工作线程并处理异常信息(deregisterWorker方法我们后面会详细讲解)。</p>
<h4 id=forkjoinpoolrunworkerworkqueue-w>ForkJoinPool.runWorker(WorkQueue w)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>runWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>growArray</span><span style=color:#ce5c00;font-weight:700>();</span>                   <span style=color:#8f5902;font-style:italic>// allocate queue
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>seed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hint</span><span style=color:#ce5c00;font-weight:700>;</span>               <span style=color:#8f5902;font-style:italic>// initially holds randomization hint
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seed</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>seed</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// avoid 0 for xorShift
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//扫描任务执行
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>runTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>awaitWork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>))</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>13</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>17</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// xorshift
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>runWorker是 ForkJoinWorkerThread 的主运行方法，用来依次执行当前工作线程中的任务。函数流程很简单: 调用scan方法依次获取任务，然后调用WorkQueue .runTask运行任务；如果未扫描到任务，则调用awaitWork等待，直到工作线程/线程池终止或等待超时。</p>
<h4 id=forkjoinpoolscanworkqueue-w-int-r>ForkJoinPool.scan(WorkQueue w, int r)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span><span style=color:#ce5c00;font-weight:700>;</span>                     <span style=color:#8f5902;font-style:italic>// initially non-negative
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//初始扫描起点，自旋扫描
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>origin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>origin</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>checkSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>WorkQueue</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//获取workQueue
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#8f5902;font-style:italic>// non-empty
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>//计算偏移量
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span>
                            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#8f5902;font-style:italic>//取base位置任务
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//stable
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>//scanning
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//更新base位
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>       <span style=color:#8f5902;font-style:italic>// signal others
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#000>signalWork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//创建或唤醒工作线程来运行任务
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>   <span style=color:#8f5902;font-style:italic>// try to activate 尝试激活工作线程
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#000>tryRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//唤醒栈顶工作线程
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#8f5902;font-style:italic>//base位置任务为空或base位置偏移，随机移位重新扫描
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>                   <span style=color:#8f5902;font-style:italic>// refresh
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>origin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#8f5902;font-style:italic>// move and rescan
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>checkSum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//队列任务为空，记录base位
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//更新索引k 继续向后查找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>origin</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#8f5902;font-style:italic>// continue until stable
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//运行到这里说明已经扫描了全部的 workQueues，但并未扫描到任务
</span><span style=color:#8f5902;font-style:italic></span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkSum</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>qlock</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#8f5902;font-style:italic>// already inactive
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>// 已经被灭活或终止,跳出循环
</span><span style=color:#8f5902;font-style:italic></span>
                    <span style=color:#8f5902;font-style:italic>//对当前WorkQueue进行灭活操作
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>INACTIVE</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// try to inactivate
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SP_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>)));</span><span style=color:#8f5902;font-style:italic>//计算ctl为INACTIVE状态并减少活跃线程数
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stackPred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#8f5902;font-style:italic>// hold prev stack top
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QSCANSTATE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//修改scanState为inactive状态
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nc</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//更新scanState为灭活状态
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#8f5902;font-style:italic>// back out
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>checkSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//重置checkSum，继续循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扫描并尝试偷取一个任务。使用w.hint进行随机索引 WorkQueue，也就是说并不一定会执行当前 WorkQueue 中的任务，而是偷取别的Worker的任务来执行。</p>
<p>函数的大致流程如下：</p>
<ul>
<li>取随机位置的一个 WorkQueue；</li>
<li>获取base位的 ForkJoinTask，成功取到后更新base位并返回任务；如果取到的 WorkQueue 中任务数大于1，则调用signalWork创建或唤醒其他工作线程；</li>
<li>如果当前工作线程处于不活跃状态(INACTIVE)，则调用tryRelease尝试唤醒栈顶工作线程来执行。</li>
</ul>
<p>tryRelease源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WorkQueue</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>inc</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>vs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SS_SEQ</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>INACTIVE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Thread</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//ctl低32位等于scanState，说明可以唤醒parker线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>          <span style=color:#8f5902;font-style:italic>// v is at top of stack
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>inc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SP_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stackPred</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>vs</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parker</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//唤醒线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>如果base位任务为空或发生偏移，则对索引位进行随机移位，然后重新扫描；</li>
<li>如果扫描整个workQueues之后没有获取到任务，则设置当前工作线程为INACTIVE状态；然后重置checkSum，再次扫描一圈之后如果还没有任务则跳出循环返回null。</li>
</ul>
<h4 id=forkjoinpoolawaitworkworkqueue-w-int-r>ForkJoinPool.awaitWork(WorkQueue w, int r)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>awaitWork</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>qlock</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>                 <span style=color:#8f5902;font-style:italic>// w is terminating
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>stackPred</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//正在扫描，跳出循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>6</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>21</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>         <span style=color:#8f5902;font-style:italic>// randomize spins
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>WorkQueue</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>AtomicLong</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SMASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>        <span style=color:#8f5902;font-style:italic>// see if pred parking
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parker</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span>
                    <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS</span><span style=color:#ce5c00;font-weight:700>;</span>                <span style=color:#8f5902;font-style:italic>// continue spinning
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>qlock</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>                     <span style=color:#8f5902;font-style:italic>// 当前workQueue已经终止，返回false recheck after spins
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//判断线程是否被中断，并清除中断状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prevctl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parkTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>AC_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SMASK</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//活跃线程数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>tryTerminate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#8f5902;font-style:italic>//无active线程，尝试终止
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runState</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>STOP</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>           <span style=color:#8f5902;font-style:italic>// pool terminating
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>        <span style=color:#8f5902;font-style:italic>// is last waiter
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//计算活跃线程数(高32位)并更新为下一个栈顶的scanState(低32位)
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>prevctl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SP_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>pred</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>TC_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// shrink excess spares
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prevctl</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//总线程过量
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>                 <span style=color:#8f5902;font-style:italic>// else use timed wait
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//计算空闲超时时间
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>parkTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>IDLE_TIMEOUT</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>parkTime</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>TIMEOUT_SLOP</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>prevctl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parkTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>Thread</span> <span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PARKBLOCKER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>   <span style=color:#8f5902;font-style:italic>// emulate LockSupport
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//设置parker，准备阻塞
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ctl</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>      <span style=color:#8f5902;font-style:italic>// recheck before park
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parkTime</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//阻塞指定的时间
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QPARKER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PARKBLOCKER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//正在扫描，说明等到任务，跳出循环
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parkTime</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0L</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ctl</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0L</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prevctl</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//未等到任务，更新ctl，返回false
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>                     <span style=color:#8f5902;font-style:italic>// shrink pool
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>回到runWorker方法，如果scan方法未扫描到任务，会调用awaitWork等待获取任务。函数的具体执行流程大家看源码，这里简单说一下:</p>
<ul>
<li>在等待获取任务期间，如果工作线程或线程池已经终止则直接返回false。</li>
<li>如果当前无 active 线程，尝试终止线程池并返回false，如果终止失败并且当前是最后一个等待的 Worker，就阻塞指定的时间(IDLE_TIMEOUT)；等到届期或被唤醒后如果发现自己是scanning(scanState >= 0)状态，说明已经等到任务，跳出等待返回true继续 scan，否则的更新ctl并返回false。</li>
</ul>
<h4 id=workqueueruntask>WorkQueue.runTask()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>runTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>scanState</span> <span style=color:#ce5c00;font-weight:700>&amp;=</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>SCANNING</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// mark as busy
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentSteal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>doExec</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//更新currentSteal并执行任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QCURRENTSTEAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// release for GC
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>execLocalTasks</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//依次执行本地任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ForkJoinWorkerThread</span> <span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>owner</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(++</span><span style=color:#000>nsteals</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>      <span style=color:#8f5902;font-style:italic>// collect on overflow
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>transferStealCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//增加偷取任务数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>scanState</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>SCANNING</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thread</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>afterTopLevelExec</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//执行钩子函数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在scan方法扫描到任务之后，调用WorkQueue.runTask()来执行获取到的任务，大概流程如下:</p>
<ul>
<li>标记scanState为正在执行状态；</li>
<li>更新currentSteal为当前获取到的任务并执行它，任务的执行调用了ForkJoinTask.doExec()方法，源码如下:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//ForkJoinTask.doExec()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doExec</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>completed</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>completed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exec</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//执行我们定义的任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>rex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>setExceptionalCompletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rex</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>completed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>setCompletion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NORMAL</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>调用execLocalTasks依次执行当前WorkerQueue中的任务，源码如下:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//执行并移除所有本地任务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>execLocalTasks</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>top</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>FIFO_QUEUE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//FIFO模式
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndSetObject</span>
                        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//FIFO执行，取top任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QTOP</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doExec</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//执行
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>base</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>top</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#000>pollAndExecAll</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//LIFO模式执行，取base任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>更新窃取次数。</li>
<li>还原scanState并执行钩子函数。</li>
</ul>
<h4 id=forkjoinpoolderegisterworkerforkjoinworkerthread-wt-throwable-ex>ForkJoinPool.deregisterWorker(ForkJoinWorkerThread wt, Throwable ex)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>deregisterWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinWorkerThread</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>WorkQueue</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//1.移除workQueue
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>workQueue</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//获取ForkJoinWorkerThread的等待队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>                           <span style=color:#8f5902;font-style:italic>// remove index from array
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>config</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SMASK</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//计算workQueue索引
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lockRunState</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//获取runState锁和当前池运行状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//移除workQueue
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>unlockRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>RSLOCK</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//解除runState锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//2.减少CTL数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>                                       <span style=color:#8f5902;font-style:italic>// decrement counts
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span>
                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span>
                                       <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>TC_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span>
                                       <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SP_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>))));</span>
    <span style=color:#8f5902;font-style:italic>//3.处理被移除workQueue内部相关参数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>qlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                             <span style=color:#8f5902;font-style:italic>// ensure set
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>transferStealCount</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cancelAll</span><span style=color:#ce5c00;font-weight:700>();</span>                            <span style=color:#8f5902;font-style:italic>// cancel remaining tasks
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//4.如果线程未终止，替换被移除的workQueue并唤醒内部线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                    <span style=color:#8f5902;font-style:italic>// possibly replace
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//尝试终止线程池
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryTerminate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>runState</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>STOP</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>              <span style=color:#8f5902;font-style:italic>// already terminating
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//唤醒被替换的线程，依赖于下一步
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>         <span style=color:#8f5902;font-style:italic>// wake up replacement
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//创建工作线程替换
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>ADD_WORKER</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>tryAddWorker</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>);</span>                      <span style=color:#8f5902;font-style:italic>// create replacement
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span>                                      <span style=color:#8f5902;font-style:italic>// don&#39;t need replacement
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//5.处理异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>                               <span style=color:#8f5902;font-style:italic>// help clean on way out
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>helpExpungeStaleExceptions</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>else</span>                                          <span style=color:#8f5902;font-style:italic>// rethrow
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>rethrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>deregisterWorker方法用于工作线程运行完毕之后终止线程或处理工作线程异常，主要就是清除已关闭的工作线程或回滚创建线程之前的操作，并把传入的异常抛给 ForkJoinTask 来处理。具体步骤见源码注释。</p>
<h3 id=forkjoinpool获取结果>ForkJoinPool：获取结果</h3>
<ul>
<li>join</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//合并任务结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>V</span> <span style=color:#000>join</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doJoin</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>DONE_MASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>reportException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getRawResult</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//join, get, quietlyJoin的主实现方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doJoin</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>Thread</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>ForkJoinWorkerThread</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ForkJoinWorkerThread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinWorkerThread</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>workQueue</span><span style=color:#ce5c00;font-weight:700>).</span>
        <span style=color:#000>tryUnpush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doExec</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitJoin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>externalAwaitDone</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>invoke</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//执行任务，并等待任务完成并返回结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>V</span> <span style=color:#000>invoke</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doInvoke</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>DONE_MASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>NORMAL</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>reportException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getRawResult</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>//invoke, quietlyInvoke的主实现方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doInvoke</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>Thread</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>ForkJoinWorkerThread</span> <span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>doExec</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>ForkJoinWorkerThread</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinWorkerThread</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>pool</span><span style=color:#ce5c00;font-weight:700>.</span>
        <span style=color:#000>awaitJoin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>workQueue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
        <span style=color:#000>externalAwaitDone</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>join()方法一把是在任务fork()之后调用，用来获取(或者叫“合并”)任务的执行结果。</p>
<p>ForkJoinTask的join()和invoke()方法都可以用来获取任务的执行结果(另外还有get方法也是调用了doJoin来获取任务结果，但是会响应运行时异常)，它们对外部提交任务的执行方式一致，都是通过externalAwaitDone方法等待执行结果。</p>
<p>不同的是invoke()方法会直接执行当前任务；而join()方法则是在当前任务在队列 top 位时(通过tryUnpush方法判断)才能执行，如果当前任务不在 top 位或者任务执行失败调用ForkJoinPool.awaitJoin方法帮助执行或阻塞当前 join 任务。(所以在官方文档中建议了我们对ForkJoinTask任务的调用顺序，一对 fork-join操作一般按照如下顺序调用: a.fork(); b.fork(); b.join(); a.join();。因为任务 b 是后面进入队列，也就是说它是在栈顶的(top 位)，在它fork()之后直接调用join()就可以直接执行而不会调用ForkJoinPool.awaitJoin方法去等待。)</p>
<p>在这些方法中，join()相对比较全面，所以之后的讲解我们将从join()开始逐步向下分析，首先看一下join()的执行流程:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429151856.png style=display:block;width:50% alt=NAME align=center> </div>
<p>后面的源码分析中，我们首先讲解比较简单的外部 join 任务(externalAwaitDone)，然后再讲解内部 join 任务(从ForkJoinPool.awaitJoin()开始)。</p>
<h4 id=forkjointaskexternalawaitdone>ForkJoinTask.externalAwaitDone()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>externalAwaitDone</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//执行任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#8f5902;font-style:italic>// try helping
</span><span style=color:#8f5902;font-style:italic></span>             <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>externalHelpComplete</span><span style=color:#ce5c00;font-weight:700>(</span>  <span style=color:#8f5902;font-style:italic>// CountedCompleter任务
</span><span style=color:#8f5902;font-style:italic></span>                 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
             <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>common</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryExternalUnpush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>doExec</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// ForkJoinTask任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//执行失败，进入等待
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATUS</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>//更新state
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//SIGNAL 等待信号
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ie</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                            <span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interrupted</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果当前join为外部调用，则调用此方法执行任务，如果任务执行失败就进入等待。方法本身是很简单的，需要注意的是对不同的任务类型分两种情况:</p>
<ul>
<li>如果我们的任务为 CountedCompleter 类型的任务，则调用externalHelpComplete方法来执行任务。</li>
<li>其他类型的 ForkJoinTask 任务调用tryExternalUnpush来执行，源码如下:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//为外部提交者提供 tryUnpush 功能(给定任务在top位时弹出任务)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryExternalUnpush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ThreadLocalRandom</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProbe</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SQMASK</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//取top位任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>//加锁
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>//符合条件，弹出
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QTOP</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//更新top
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//解锁，返回true
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QLOCK</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//当前任务不在top位，解锁返回false
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>tryExternalUnpush的作用就是判断当前任务是否在top位，如果是则弹出任务，然后在externalAwaitDone中调用doExec()执行任务。</p>
<h4 id=forkjoinpoolawaitjoin>ForkJoinPool.awaitJoin()</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitJoin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>deadline</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>prevJoin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentJoin</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//获取给定Worker的join任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QCURRENTJOIN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//把currentJoin替换为给定任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//判断是否为CountedCompleter类型的任务
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>cc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountedCompleter</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic>//已经完成|取消|异常 跳出循环
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//CountedCompleter任务由helpComplete来完成join
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>helpComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>tryRemoveAndExec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#8f5902;font-style:italic>//尝试执行
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>helpStealer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>//队列为空或执行失败，任务可能被偷，帮助偷取者执行该任务
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//已经完成|取消|异常，跳出循环
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//计算任务等待时间
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>deadline</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>NANOSECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>ms</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1L</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryCompensate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//执行补偿操作
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internalWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ms</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//补偿执行成功，任务等待指定时间
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAndAddLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//更新活跃线程数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QCURRENTJOIN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>prevJoin</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//循环结束，替换为原来的join任务
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果当前 join 任务不在Worker等待队列的top位，或者任务执行失败，调用此方法来帮助执行或阻塞当前 join 的任务。函数执行流程如下:</p>
<ul>
<li>由于每次调用awaitJoin都会优先执行当前join的任务，所以首先会更新currentJoin为当前join任务；</li>
<li>进入自旋
<ul>
<li>首先检查任务是否已经完成(通过task.status &lt; 0判断)，如果给定任务执行完毕|取消|异常 则跳出循环返回执行状态s；</li>
<li>如果是 CountedCompleter 任务类型，调用helpComplete方法来完成join操作(后面笔者会开新篇来专门讲解CountedCompleter，本篇暂时不做详细解析)；</li>
<li>非 CountedCompleter 任务类型调用WorkQueue.tryRemoveAndExec尝试执行任务；</li>
<li>如果给定 WorkQueue 的等待队列为空或任务执行失败，说明任务可能被偷，调用helpStealer帮助偷取者执行任务(也就是说，偷取者帮我执行任务，我去帮偷取者执行它的任务)；</li>
<li>再次判断任务是否执行完毕(task.status &lt; 0)，如果任务执行失败，计算一个等待时间准备进行补偿操作；</li>
<li>调用tryCompensate方法为给定 WorkQueue 尝试执行补偿操作。在执行补偿期间，如果发现 资源争用|池处于unstable状态|当前Worker已终止，则调用ForkJoinTask.internalWait()方法等待指定的时间，任务唤醒之后继续自旋，ForkJoinTask.internalWait()源码如下:</li>
</ul>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>internalWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#8f5902;font-style:italic>// force completer to issue notify
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>STATUS</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//更新任务状态为SIGNAL(等待唤醒)
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ie</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在awaitJoin中，我们总共调用了三个比较复杂的方法: tryRemoveAndExec、helpStealer和tryCompensate，下面我们依次讲解。</p>
<h4 id=workqueuetryremoveandexecforkjointask-task>WorkQueue.tryRemoveAndExec(ForkJoinTask&lt;?> task)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryRemoveAndExec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>array</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>top</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//从top往下自旋查找
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#8f5902;font-style:italic>// traverse from s to b
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((--</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//计算任务索引
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//获取索引到的任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>top</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>// shorter than expected
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//给定任务为索引任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>removed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>top</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#8f5902;font-style:italic>// pop
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//弹出任务
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QTOP</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//更新top
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>removed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>base</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>      <span style=color:#8f5902;font-style:italic>// replace with proxy
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>removed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span>
                                <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>EmptyTask</span><span style=color:#ce5c00;font-weight:700>());</span> <span style=color:#8f5902;font-style:italic>//join任务已经被移除，替换为一个占位任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>removed</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doExec</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>//执行
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>top</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//给定任务不是top任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>//弹出任务
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QTOP</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//更新top
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>                  <span style=color:#8f5902;font-style:italic>// was cancelled
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//遍历结束
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//任务执行完毕
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从top位开始自旋向下找到给定任务，如果找到把它从当前 Worker 的任务队列中移除并执行它。注意返回的参数: 如果任务队列为空或者任务未执行完毕返回true；任务执行完毕返回false。</p>
<h4 id=forkjoinpoolhelpstealerworkqueue-w-forkjointask-task>ForkJoinPool.helpStealer(WorkQueue w, ForkJoinTask&lt;?> task)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>helpStealer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>checkSum</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>                                       <span style=color:#8f5902;font-style:italic>// restart point
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>checkSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                          <span style=color:#8f5902;font-style:italic>// for stability check
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>subtask</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>WorkQueue</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>                    <span style=color:#8f5902;font-style:italic>// v is subtask stealer
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>descent</span><span style=color:#ce5c00;font-weight:700>:</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subtask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>subtask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//1. 找到给定WorkQueue的偷取者v
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hint</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//跳两个索引，因为Worker在奇数索引位
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>)</span>                     <span style=color:#8f5902;font-style:italic>// can&#39;t find stealer
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>break</span> <span style=color:#000>descent</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentSteal</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>subtask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//定位到偷取者
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//更新stealer索引
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#ce5c00;font-weight:700>}</span>
                        <span style=color:#000>checkSum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>//2. 帮助偷取者v执行任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                         <span style=color:#8f5902;font-style:italic>// help v or descend
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;[]</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>//偷取者内部的任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>checkSum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentJoin</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//获取偷取者的join任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>subtask</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentJoin</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>subtask</span> <span style=color:#ce5c00;font-weight:700>||</span>
                            <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentSteal</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>subtask</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// stale
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>break</span> <span style=color:#000>descent</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// stale，跳出descent循环重来
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>array</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>subtask</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#8f5902;font-style:italic>//偷取者的join任务为null，跳出descent循环
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>break</span> <span style=color:#000>descent</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//偷取者内部任务为空，可能任务也被偷走了；跳出本次循环，查找偷取者的偷取者
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//获取base偏移地址
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;)</span>
                            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>));</span><span style=color:#8f5902;font-style:italic>//获取偷取者的base任务
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>             <span style=color:#8f5902;font-style:italic>// stale
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>break</span> <span style=color:#000>descent</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// stale，跳出descent循环重来
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//弹出任务
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#8f5902;font-style:italic>//更新偷取者的base位
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentSteal</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//获取调用者偷来的任务
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>top</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span><span style=color:#ce5c00;font-weight:700>;</span>
                            <span style=color:#8f5902;font-style:italic>//首先更新给定workQueue的currentSteal为偷取者的base任务，然后执行该任务
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#8f5902;font-style:italic>//然后通过检查top来判断给定workQueue是否有自己的任务，如果有，
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#8f5902;font-style:italic>// 则依次弹出任务(LIFO)-&gt;更新currentSteal-&gt;执行该任务(注意这里是自己偷自己的任务执行)
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
                                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QCURRENTSTEAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
                                <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doExec</span><span style=color:#ce5c00;font-weight:700>();</span>        <span style=color:#8f5902;font-style:italic>// clear local tasks too
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                                    <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>top</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#8f5902;font-style:italic>//内部有自己的任务，依次弹出执行
</span><span style=color:#8f5902;font-style:italic></span>                                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pop</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QCURRENTSTEAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//还原给定workQueue的currentSteal
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>top</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//给定workQueue有自己的任务了，帮助结束，返回
</span><span style=color:#8f5902;font-style:italic></span>                                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>// can&#39;t further help
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>status</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>oldSum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>checkSum</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果队列为空或任务执行失败，说明任务可能被偷，调用此方法来帮助偷取者执行任务。基本思想是: 偷取者帮助我执行任务，我去帮助偷取者执行它的任务。 函数执行流程如下:</p>
<p>循环定位偷取者，由于Worker是在奇数索引位，所以每次会跳两个索引位。定位到偷取者之后，更新调用者 WorkQueue 的hint为偷取者的索引，方便下次定位； 定位到偷取者后，开始帮助偷取者执行任务。从偷取者的base索引开始，每次偷取一个任务执行。在帮助偷取者执行任务后，如果调用者发现本身已经有任务(w.top != top)，则依次弹出自己的任务(LIFO顺序)并执行(也就是说自己偷自己的任务执行)。</p>
<h4 id=forkjoinpooltrycompensateworkqueue-w>ForkJoinPool.tryCompensate(WorkQueue w)</h4>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//执行补偿操作: 尝试缩减活动线程量，可能释放或创建一个补偿线程来准备阻塞
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryCompensate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>WorkQueue</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>canBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>WorkQueue</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sp</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>qlock</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span>           <span style=color:#8f5902;font-style:italic>// caller terminating
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>workQueues</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SMASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>           <span style=color:#8f5902;font-style:italic>// parallelism disabled
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>canBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//调用者已终止
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ctl</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>      <span style=color:#8f5902;font-style:italic>// release idle worker
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>canBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tryRelease</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>sp</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//唤醒等待的工作线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//没有空闲线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>AC_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pc</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//活跃线程数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>short</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>TC_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pc</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//总线程数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nbusy</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                        <span style=color:#8f5902;font-style:italic>// validate saturation
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>        <span style=color:#8f5902;font-style:italic>// two passes of odd indices
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>WorkQueue</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>[((</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//取奇数索引位
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>scanState</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>SCANNING</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>//没有正在运行任务，跳出
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>nbusy</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//正在运行任务，添加标记
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nbusy</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tc</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>ctl</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>canBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>                 <span style=color:#8f5902;font-style:italic>// unstable or stale
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tc</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>pc</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ac</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//总线程数大于并行度 &amp;&amp; 活动线程数大于1 &amp;&amp; 调用者任务队列为空，不需要补偿
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>AC_UNIT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span>
                    <span style=color:#ce5c00;font-weight:700>(~</span><span style=color:#000>AC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>));</span>       <span style=color:#8f5902;font-style:italic>// uncompensated
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>canBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nc</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//更新活跃线程数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tc</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>MAX_CAP</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>common</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>tc</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>pc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>commonMaxSpares</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//超出最大线程数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RejectedExecutionException</span><span style=color:#ce5c00;font-weight:700>(</span>
                    <span style=color:#4e9a06>&#34;Thread limit exceeded replacing blocked worker&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>                                <span style=color:#8f5902;font-style:italic>// similar to tryAddWorker
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#8f5902;font-style:italic>// CAS within lock
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>AC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span>
                    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TC_MASK</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>TC_UNIT</span><span style=color:#ce5c00;font-weight:700>)));</span><span style=color:#8f5902;font-style:italic>//计算总线程数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lockRunState</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>STOP</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>add</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CTL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nc</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//更新总线程数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>unlockRunState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rs</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>RSLOCK</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//运行到这里说明活跃工作线程数不足，需要创建一个新的工作线程来补偿
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>canBlock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>add</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>createWorker</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// throws on exception
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>canBlock</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>具体的执行看源码及注释，这里我们简单总结一下需要和不需要补偿的几种情况:</p>
<ul>
<li><strong>需要补偿</strong> :
<ul>
<li>调用者队列不为空，并且有空闲工作线程，这种情况会唤醒空闲线程(调用tryRelease方法)</li>
<li>池尚未停止，活跃线程数不足，这时会新建一个工作线程(调用createWorker方法)</li>
</ul>
</li>
<li><strong>不需要补偿</strong> :
<ul>
<li>调用者已终止或池处于不稳定状态</li>
<li>总线程数大于并行度 && 活动线程数大于1 && 调用者任务队列为空</li>
</ul>
</li>
</ul>
<h2 id=注意事项>注意事项</h2>
<h3 id=避免不必要的fork>避免不必要的fork()</h3>
<p>划分成两个子任务后，不要同时调用两个子任务的fork()方法。</p>
<p>表面上看上去两个子任务都fork()，然后join()两次似乎更自然。但事实证明，直接调用compute()效率更高。因为直接调用子任务的compute()方法实际上就是在当前的工作线程进行了计算(线程重用)，这比“将子任务提交到工作队列，线程又从工作队列中拿任务”快得多。</p>
<blockquote>
<p>当一个大任务被划分成两个以上的子任务时，尽可能使用前面说到的三个衍生的invokeAll方法，因为使用它们能避免不必要的fork()。</p>
</blockquote>
<h3 id=注意forkcomputejoin的顺序>注意fork()、compute()、join()的顺序</h3>
<p>为了两个任务并行，三个方法的调用顺序需要万分注意。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fork</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 计算右边的任务
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>leftAns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compute</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 计算左边的任务(同时右边任务也在计算)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>rightAns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// 等待右边的结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>leftAns</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>rightAns</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=选择合适的子任务粒度>选择合适的子任务粒度</h3>
<p>选择划分子任务的粒度(顺序执行的阈值)很重要，因为使用Fork/Join框架并不一定比顺序执行任务的效率高: 如果任务太大，则无法提高并行的吞吐量；如果任务太小，子任务的调度开销可能会大于并行计算的性能提升，我们还要考虑创建子任务、fork()子任务、线程调度以及合并子任务处理结果的耗时以及相应的内存消耗。</p>
<p>官方文档给出的粗略经验是: 任务应该执行<code>100~10000</code>个基本的计算步骤。决定子任务的粒度的最好办法是实践，通过实际测试结果来确定这个阈值才是“上上策”。</p>
<blockquote>
<p>和其他Java代码一样，Fork/Join框架测试时需要“预热”或者说执行几遍才会被JIT(Just-in-time)编译器优化，所以测试性能之前跑几遍程序很重要。</p>
</blockquote>
<h3 id=避免重量级任务划分与结果合并>避免重量级任务划分与结果合并</h3>
<p>Fork/Join的很多使用场景都用到数组或者List等数据结构，子任务在某个分区中运行，最典型的例子如并行排序和并行查找。拆分子任务以及合并处理结果的时候，应该尽量避免System.arraycopy这样耗时耗空间的操作，从而最小化任务的处理开销</p>
<h3 id=有哪些jdk源码中使用了forkjoin思想>有哪些JDK源码中使用了Fork/Join思想?</h3>
<p>我们常用的数组工具类 Arrays 在JDK 8之后新增的并行排序方法(parallelSort)就运用了 ForkJoinPool 的特性，还有 ConcurrentHashMap 在JDK 8之后添加的函数式方法(如forEach等)也有运用。</p>
<h3 id=使用executors工具类创建forkjoinpool>使用Executors工具类创建ForkJoinPool</h3>
<p>Java8在Executors工具类中新增了两个工厂方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// parallelism定义并行级别
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>newWorkStealingPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parallelism</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// 默认并行级别为JVM可用的处理器个数
</span><span style=color:#8f5902;font-style:italic>// Runtime.getRuntime().availableProcessors()
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>newWorkStealingPool</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=关于forkjoin异常处理>关于Fork/Join异常处理</h3>
<p>Java的受检异常机制一直饱受诟病，所以在ForkJoinTask的invoke()、join()方法及其衍生方法中都没有像get()方法那样抛出个ExecutionException的受检异常。</p>
<p>所以你可以在ForkJoinTask中看到内部把受检异常转换成了运行时异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>rethrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>.&lt;</span><span style=color:#000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>uncheckedThrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>uncheckedThrow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Throwable</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>T</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// rely on vacuous cast
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=应用实例>应用实例</h2>
<h3 id=计算12310000的结果>计算1+2+3+…+10000的结果</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SumTask</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RecursiveTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
		
		<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//开始计算的数
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//最后计算的数
</span><span style=color:#8f5902;font-style:italic></span>		
		<span style=color:#000>SumTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>;</span>
		<span style=color:#ce5c00;font-weight:700>}</span>

		<span style=color:#5c35cc;font-weight:700>@Override</span>
		<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Integer</span> <span style=color:#000>compute</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
			<span style=color:#8f5902;font-style:italic>//如果计算量小于1000，那么分配一个线程执行if中的代码块，并返回执行结果
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
				<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; 开始执行: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>);</span>
				<span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>
					<span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>;</span>
			<span style=color:#ce5c00;font-weight:700>}</span>
			<span style=color:#8f5902;font-style:italic>//如果计算量大于1000，那么拆分为两个任务
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>SumTask</span> <span style=color:#000>task1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SumTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#000>SumTask</span> <span style=color:#000>task2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SumTask</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>end</span><span style=color:#ce5c00;font-weight:700>);</span>
			<span style=color:#8f5902;font-style:italic>//执行任务
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>task1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fork</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#000>task2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fork</span><span style=color:#ce5c00;font-weight:700>();</span>
			<span style=color:#8f5902;font-style:italic>//获取任务执行的结果
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>task1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>task2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutionException</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>ForkJoinPool</span> <span style=color:#000>pool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>();</span>
		<span style=color:#000>ForkJoinTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SumTask</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10000</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>pool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>submit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>);</span>
		<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>());</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=斐波那契数列>斐波那契数列</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>ForkJoinPool</span> <span style=color:#000>forkJoinPool</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// 最大并发数4
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Fibonacci</span> <span style=color:#000>fibonacci</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>startTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Integer</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>forkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>invoke</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fibonacci</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>endTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Fork/join sum: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; in &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endTime</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startTime</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; ms.&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//以下为官方API文档示例
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span>  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Fibonacci</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RecursiveTask</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Integer</span> <span style=color:#000>compute</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>Fibonacci</span> <span style=color:#000>f1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>f1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>fork</span><span style=color:#ce5c00;font-weight:700>();</span> 
        <span style=color:#000>Fibonacci</span> <span style=color:#000>f2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Fibonacci</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>f2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compute</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>f1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>join</span><span style=color:#ce5c00;font-weight:700>();</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://segmentfault.com/a/1190000039267451>ForkJoinPool图文详解</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-03c625b3fd7b9bdaaced3bd5f37d36c8>3.24 - CH24-CountDownLatch</h1>
<h2 id=概览>概览</h2>
<p>其底层是由AQS提供支持，所以其数据结构可以参考AQS的数据结构，而AQS的数据结构核心就是两个虚拟队列: 同步队列sync queue 和条件队列condition queue，不同的条件会有不同的条件队列。</p>
<p>CountDownLatch典型的用法是将一个程序分为n个互相独立的可解决任务，并创建值为n的CountDownLatch。当每一个任务完成时，都会在这个锁存器上调用countDown，等待问题被解决的任务调用这个锁存器的await，将他们自己拦住，直至锁存器计数结束。</p>
<h2 id=源码分析>源码分析</h2>
<h3 id=层级结构>层级结构</h3>
<p>CountDownLatch没有显示继承哪个父类或者实现哪个父接口, 它底层是AQS是通过内部类Sync来实现的。</p>
<h3 id=内部类>内部类</h3>
<p>CountDownLatch类存在一个内部类Sync，继承自AbstractQueuedSynchronizer，其源代码如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Sync</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractQueuedSynchronizer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>4982264981922014374L</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Sync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 返回当前计数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getCount</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 试图在共享模式下获取对象状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 试图设置状态来反映共享模式下的一个释放
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryReleaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// Decrement count; signal when transition to zero
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 没有被线程占有
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 下一个状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 比较并且设置成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对CountDownLatch方法的调用会转发到对Sync或AQS的方法的调用，所以，AQS对CountDownLatch提供支持。</p>
<h3 id=类属性>类属性</h3>
<p>可以看到CountDownLatch类的内部只有一个Sync类型的属性:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CountDownLatch</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 同步队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sync</span> <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=构造函数>构造函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;count &lt; 0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 初始化状态数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sync</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Sync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该构造函数可以构造一个用给定计数初始化的CountDownLatch，并且构造函数内完成了sync的初始化，并设置了状态数。</p>
<h3 id=核心函数await>核心函数：await</h3>
<p>此函数将会使当前线程在锁存器倒计数至零之前一直等待，除非线程被中断。其源码如下</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 转发到sync对象上
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>acquireSharedInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对CountDownLatch对象的await的调用会转发为对Sync的acquireSharedInterruptibly(从AQS继承的方法)方法的调用。</p>
<ul>
<li>acquireSharedInterruptibly源码如下:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>acquireSharedInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>doAcquireSharedInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>acquireSharedInterruptibly又调用了CountDownLatch的内部类Sync的tryAcquireShared和AQS的doAcquireSharedInterruptibly函数。</p>
<ul>
<li>tryAcquireShared函数的源码如下:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该函数只是简单的判断AQS的state是否为0，为0则返回1，不为0则返回-1。</p>
<ul>
<li>doAcquireSharedInterruptibly函数的源码如下:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doAcquireSharedInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 添加节点至等待队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>addWaiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SHARED</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>failed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取node的前驱节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>predecessor</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 前驱节点为头结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 试图在共享模式下获取对象状态
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 获取成功
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 设置头结点并进行繁殖
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>setHeadAndPropagate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>// 设置节点next域
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// help GC
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>failed</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shouldParkAfterFailedAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#000>parkAndCheckInterrupt</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 在获取失败后是否需要禁止线程并且进行中断检查
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>cancelAcquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在AQS的doAcquireSharedInterruptibly中可能会再次调用CountDownLatch的内部类Sync的tryAcquireShared方法和AQS的setHeadAndPropagate方法。</p>
<ul>
<li>setHeadAndPropagate方法源码如下</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setHeadAndPropagate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>propagate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取头结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// Record old head for check below
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 设置头结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>setHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * Try to signal next queued node if:
</span><span style=color:#8f5902;font-style:italic>        *   Propagation was indicated by caller,
</span><span style=color:#8f5902;font-style:italic>        *     or was recorded (as h.waitStatus either before
</span><span style=color:#8f5902;font-style:italic>        *     or after setHead) by a previous operation
</span><span style=color:#8f5902;font-style:italic>        *     (note: this uses sign-check of waitStatus because
</span><span style=color:#8f5902;font-style:italic>        *      PROPAGATE status may transition to SIGNAL.)
</span><span style=color:#8f5902;font-style:italic>        * and
</span><span style=color:#8f5902;font-style:italic>        *   The next node is waiting in shared mode,
</span><span style=color:#8f5902;font-style:italic>        *     or we don&#39;t know, because it appears null
</span><span style=color:#8f5902;font-style:italic>        *
</span><span style=color:#8f5902;font-style:italic>        * The conservatism in both of these checks may cause
</span><span style=color:#8f5902;font-style:italic>        * unnecessary wake-ups, but only when there are multiple
</span><span style=color:#8f5902;font-style:italic>        * racing acquires/releases, so most need signals now or soon
</span><span style=color:#8f5902;font-style:italic>        * anyway.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 进行判断
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>propagate</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span>
        <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取节点的后继
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isShared</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 后继为空或者为共享模式
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 以共享模式进行释放
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>doReleaseShared</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法设置头结点并且释放头结点后面的满足条件的结点，该方法中可能会调用到AQS的doReleaseShared方法，其源码如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doReleaseShared</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * Ensure that a release propagates, even if there are other
</span><span style=color:#8f5902;font-style:italic>        * in-progress acquires/releases.  This proceeds in the usual
</span><span style=color:#8f5902;font-style:italic>        * way of trying to unparkSuccessor of head if it needs
</span><span style=color:#8f5902;font-style:italic>        * signal. But if it does not, status is set to PROPAGATE to
</span><span style=color:#8f5902;font-style:italic>        * ensure that upon release, propagation continues.
</span><span style=color:#8f5902;font-style:italic>        * Additionally, we must loop in case a new node is added
</span><span style=color:#8f5902;font-style:italic>        * while we are doing this. Also, unlike other uses of
</span><span style=color:#8f5902;font-style:italic>        * unparkSuccessor, we need to know if CAS to reset status
</span><span style=color:#8f5902;font-style:italic>        * fails, if so rechecking.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 头结点不为空并且头结点不为尾结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取头结点的等待状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span><span style=color:#ce5c00;font-weight:700>;</span> 
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 状态为SIGNAL
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 不成功就继续
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>// loop to recheck cases
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 释放后继结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>unparkSuccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 状态为0并且不成功，继续
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>                <span style=color:#8f5902;font-style:italic>// loop on failed CAS
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 若头结点改变，继续循环  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法在共享模式下释放，具体的流程再之后会通过一个示例给出。</p>
<p>所以，对CountDownLatch的await调用大致会有如下的调用链。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429155936.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图给出了可能会调用到的主要方法，并非一定会调用到，之后，会通过一个示例给出详细的分析。</p>
<h3 id=核心函数countdown>核心函数：countDown</h3>
<p>此函数将递减锁存器的计数，如果计数到达零，则释放所有等待的线程</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>countDown</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>releaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>对countDown的调用转换为对Sync对象的releaseShared(从AQS继承而来)方法的调用。</p>
<ul>
<li>releaseShared源码如下</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>releaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryReleaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>doReleaseShared</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数会以共享模式释放对象，并且在函数中会调用到CountDownLatch的tryReleaseShared函数，并且可能会调用AQS的doReleaseShared函数。</p>
<ul>
<li>tryReleaseShared源码如下</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryReleaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Decrement count; signal when transition to zero
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 没有被线程占有
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 下一个状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextc</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 比较并且设置成功
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数会试图设置状态来反映共享模式下的一个释放。具体的流程在下面的示例中会进行分析。</p>
<ul>
<li>AQS的doReleaseShared的源码如下</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doReleaseShared</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * Ensure that a release propagates, even if there are other
</span><span style=color:#8f5902;font-style:italic>        * in-progress acquires/releases.  This proceeds in the usual
</span><span style=color:#8f5902;font-style:italic>        * way of trying to unparkSuccessor of head if it needs
</span><span style=color:#8f5902;font-style:italic>        * signal. But if it does not, status is set to PROPAGATE to
</span><span style=color:#8f5902;font-style:italic>        * ensure that upon release, propagation continues.
</span><span style=color:#8f5902;font-style:italic>        * Additionally, we must loop in case a new node is added
</span><span style=color:#8f5902;font-style:italic>        * while we are doing this. Also, unlike other uses of
</span><span style=color:#8f5902;font-style:italic>        * unparkSuccessor, we need to know if CAS to reset status
</span><span style=color:#8f5902;font-style:italic>        * fails, if so rechecking.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存头结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 头结点不为空并且头结点不为尾结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取头结点的等待状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span><span style=color:#ce5c00;font-weight:700>;</span> 
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 状态为SIGNAL
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 不成功就继续
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>// loop to recheck cases
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 释放后继结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>unparkSuccessor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PROPAGATE</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 状态为0并且不成功，继续
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>continue</span><span style=color:#ce5c00;font-weight:700>;</span>                <span style=color:#8f5902;font-style:italic>// loop on failed CAS
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 若头结点改变，继续循环  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数在共享模式下释放资源。</p>
<p>所以，对CountDownLatch的countDown调用大致会有如下的调用链。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429160122.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图给出了可能会调用到的主要方法，并非一定会调用到，之后，会通过一个示例给出详细的分析。</p>
<h2 id=应用示例>应用示例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.CountDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; doing something&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; finish&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CountDownLatchDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Waiting for t1 thread and t2 thread to finish&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>            
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; continue&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>        
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Waiting for t1 thread and t2 thread to finish
t1 doing something
t2 doing something
t1 finish
t2 finish
main continue
</code></pre></div><p>本程序首先计数器初始化为2。根据结果，可能会存在如下的一种时序图。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429160214.png style=display:block;width:50% alt=NAME align=center> </div>
<p>首先main线程会调用await操作，此时main线程会被阻塞，等待被唤醒，之后t1线程执行了countDown操作，最后，t2线程执行了countDown操作，此时main线程就被唤醒了，可以继续运行。下面，进行详细分析。</p>
<ul>
<li>main线程执行countDownLatch.await操作，主要调用的函数如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429160243.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在最后，main线程就被park了，即禁止运行了。此时Sync queue(同步队列)中有两个节点，AQS的state为2，包含main线程的结点的nextWaiter指向SHARED结点。</p>
<ul>
<li>t1线程执行countDownLatch.countDown操作，主要调用的函数如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429160301.png style=display:block;width:50% alt=NAME align=center> </div>
<p>此时，Sync queue队列里的结点个数未发生变化，但是此时，AQS的state已经变为1了。</p>
<ul>
<li>t2线程执行countDownLatch.countDown操作，主要调用的函数如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429160319.png style=display:block;width:50% alt=NAME align=center> </div>
<p>经过调用后，AQS的state为0，并且此时，main线程会被unpark，可以继续运行。当main线程获取cpu资源后，继续运行。</p>
<ul>
<li>main线程获取cpu资源，继续运行，由于main线程是在parkAndCheckInterrupt函数中被禁止的，所以此时，继续在parkAndCheckInterrupt函数运行.</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429160345.png style=display:block;width:50% alt=NAME align=center> </div>
<p>main线程恢复，继续在parkAndCheckInterrupt函数中运行，之后又会回到最终达到的状态为AQS的state为0，并且head与tail指向同一个结点，该节点的额nextWaiter域还是指向SHARED结点。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dd4e073fa96cad559cb8dc0524a1a9de>3.25 - CH25-CyclicBarrier</h1>
<h2 id=源码解析>源码解析</h2>
<h3 id=层级结构>层级结构</h3>
<p>CyclicBarrier没有显示继承哪个父类或者实现哪个父接口, 所有AQS和重入锁不是通过继承实现的，而是通过组合实现的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CyclicBarrier</span> <span style=color:#ce5c00;font-weight:700>{}</span>
<span style=color:#a40000>​```</span>　　

<span style=color:#a40000>###</span> <span style=color:#000>类的内部类</span>

<span style=color:#000>CyclicBarrier类存在一个内部类Generation</span><span style=color:#a40000>，</span><span style=color:#000>每一次使用的CycBarrier可以当成Generation的实例</span><span style=color:#a40000>，</span><span style=color:#000>其源代码如下</span>

<span style=color:#a40000>​```</span><span style=color:#000>java</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Generation</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>broken</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Generation类有一个属性broken，用来表示当前屏障是否被损坏。</p>
<h3 id=类属性>类属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CyclicBarrier</span> <span style=color:#ce5c00;font-weight:700>{</span>
    
    <span style=color:#8f5902;font-style:italic>/** The lock for guarding barrier entry */</span>
    <span style=color:#8f5902;font-style:italic>// 可重入锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReentrantLock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>/** Condition to wait on until tripped */</span>
    <span style=color:#8f5902;font-style:italic>// 条件队列
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Condition</span> <span style=color:#000>trip</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCondition</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>/** The number of parties */</span>
    <span style=color:#8f5902;font-style:italic>// 参与的线程数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/* The command to run when tripped */</span>
    <span style=color:#8f5902;font-style:italic>// 由最后一个进入 barrier 的线程执行的操作
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Runnable</span> <span style=color:#000>barrierCommand</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>/** The current generation */</span>
    <span style=color:#8f5902;font-style:italic>// 当前代
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Generation</span> <span style=color:#000>generation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Generation</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 正在等待进入屏障的线程数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该属性有一个为ReentrantLock对象，有一个为Condition对象，而Condition对象又是基于AQS的，所以，归根到底，底层还是由AQS提供支持。</p>
<h3 id=构造函数>构造函数</h3>
<ul>
<li>CyclicBarrier(int, Runnable)型构造函数</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CyclicBarrier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Runnable</span> <span style=color:#000>barrierAction</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 参与的线程数量小于等于0，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parties</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 设置parties
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 设置count
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 设置barrierCommand
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>barrierCommand</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>barrierAction</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该构造函数可以指定关联该CyclicBarrier的线程数量，并且可以指定在所有线程都进入屏障后的执行动作，该执行动作由最后一个进行屏障的线程执行。</p>
<ul>
<li>CyclicBarrier(int)型构造函数</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>CyclicBarrier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 调用含有两个参数的构造函数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该构造函数仅仅执行了关联该CyclicBarrier的线程数量，没有设置执行动作。</p>
<h3 id=核心函数dowait>核心函数：dowait</h3>
<p>此函数为CyclicBarrier类的核心函数，CyclicBarrier类对外提供的await函数在底层都是调用该了doawait函数，其源代码如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>dowait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokenBarrierException</span><span style=color:#ce5c00;font-weight:700>,</span>
            <span style=color:#000>TimeoutException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 保存当前锁
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ReentrantLock</span> <span style=color:#000>lock</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 锁定
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 保存当前代
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Generation</span> <span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>generation</span><span style=color:#ce5c00;font-weight:700>;</span>
        
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>broken</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 屏障被破坏，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BrokenBarrierException</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 线程被中断
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 损坏当前屏障，并且唤醒所有的线程，只有拥有锁的时候才会调用
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>breakBarrier</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 抛出异常
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        
        <span style=color:#8f5902;font-style:italic>// 减少正在等待进入屏障的线程数量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// 正在等待进入屏障的线程数量为0，所有线程都已经进入
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 运行的动作标识
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>ranAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 保存运行动作
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Runnable</span> <span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>barrierCommand</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>command</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 动作不为空
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 运行
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 设置ranAction状态
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ranAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 进入下一代
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>nextGeneration</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>ranAction</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 没有运行的动作
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 损坏当前屏障
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>breakBarrier</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>// loop until tripped, broken, interrupted, or timed out
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>timed</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 没有设置等待时间
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 等待
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>trip</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span> 
                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 设置了等待时间，并且等待时间大于0
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 等待指定时长
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>trip</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>awaitNanos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nanos</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ie</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>generation</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>broken</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 等于当前代并且屏障没有被损坏
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 损坏当前屏障
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>breakBarrier</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#8f5902;font-style:italic>// 抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ie</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 不等于当前带后者是屏障被损坏
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// We&#39;re about to finish waiting even if we had not
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// been interrupted, so this interrupt is deemed to
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// &#34;belong&#34; to subsequent execution.
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// 中断当前线程
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>broken</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 屏障被损坏，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BrokenBarrierException</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>generation</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 不等于当前代
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 返回索引
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span>

            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>nanos</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 设置了等待时间，并且等待时间小于0
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 损坏屏障
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>breakBarrier</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>// 抛出异常
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>TimeoutException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 释放锁
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unlock</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法的逻辑会进行一系列的判断，大致流程如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429170720.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=核心函数nextgeneration>核心函数：nextGeneration</h3>
<p>此函数在所有线程进入屏障后会被调用，即生成下一个版本，所有线程又可以重新进入到屏障中，其源代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>nextGeneration</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// signal completion of last generation
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 唤醒所有线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>trip</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>signalAll</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// set up next generation
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 恢复正在等待进入屏障的线程数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 新生一代
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>generation</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Generation</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在此函数中会调用AQS的signalAll方法，即唤醒所有等待线程。如果所有的线程都在等待此条件，则唤醒所有线程。其源代码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>signalAll</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isHeldExclusively</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 不被当前线程独占，抛出异常
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalMonitorStateException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 保存condition队列头结点
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 头结点不为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 唤醒所有等待线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>doSignalAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数判断头结点是否为空，即条件队列是否为空，然后会调用doSignalAll函数，doSignalAll函数源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doSignalAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// condition队列的头结点尾结点都设置为空
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>lastWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>firstWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 循环
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>do</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 获取first结点的nextWaiter域结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 设置first结点的nextWaiter域为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nextWaiter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 将first结点从condition队列转移到sync队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>transferForSignal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 重新设置first
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数会依次将条件队列中的节点转移到同步队列中，会调用到transferForSignal函数，其源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>transferForSignal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * If cannot change waitStatus, the node has been cancelled.
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONDITION</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic>        * Splice onto queue and try to set waitStatus of predecessor to
</span><span style=color:#8f5902;font-style:italic>        * indicate that thread is (probably) waiting. If cancelled or
</span><span style=color:#8f5902;font-style:italic>        * attempt to set waitStatus fails, wake up to resync (in which
</span><span style=color:#8f5902;font-style:italic>        * case the waitStatus can be transiently and harmlessly wrong).
</span><span style=color:#8f5902;font-style:italic>        */</span>
    <span style=color:#000>Node</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>enq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>waitStatus</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>compareAndSetWaitStatus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SIGNAL</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#000>LockSupport</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数的作用就是将处于条件队列中的节点转移到同步队列中，并设置结点的状态信息，其中会调用到enq函数，其源代码如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Node</span> <span style=color:#000>enq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环，确保结点能够成功入队列
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 保存尾结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 尾结点为空，即还没被初始化
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetHead</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#8f5902;font-style:italic>// 头结点为空，并设置头结点为新生成的结点
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 头结点与尾结点都指向同一个新生结点
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 尾结点不为空，即已经被初始化过
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 将node结点的prev域连接到尾结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> 
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetTail</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 比较结点t是否为尾结点，若是则将尾结点设置为node
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 设置尾结点的next域为node
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span> 
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// 返回尾结点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>此函数完成了结点插入同步队列的过程，也很好理解。</p>
<p>综合上面的分析可知，newGeneration函数的主要方法的调用如下，之后会通过一个例子详细讲解:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429171214.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=核心函数breakbarrier>核心函数：breakBarrier</h3>
<p>此函数的作用是损坏当前屏障，会唤醒所有在屏障中的线程。源代码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>breakBarrier</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 设置状态
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>generation</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>broken</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 恢复正在等待进入屏障的线程数量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 唤醒所有线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>trip</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>signalAll</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以看到，此函数也调用了AQS的signalAll函数，由signal函数提供支持。</p>
<h2 id=应用示例>应用示例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.BrokenBarrierException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.CyclicBarrier</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>CyclicBarrier</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>CyclicBarrier</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>cb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; going to await&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; continue&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CyclicBarrierDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BrokenBarrierException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>CyclicBarrier</span> <span style=color:#000>cb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CyclicBarrier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;barrierAction&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; barrier action&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>});</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; going to await&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>cb</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; continue&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>t1 going to await
main going to await
t2 going to await
t2 barrier action
t2 continue
t1 continue
main continue
</code></pre></div><p>根据结果可知，可能会存在如下的调用时序。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429171338.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由上图可知，假设t1线程的cb.await是在main线程的cb.barrierAction动作是由最后一个进入屏障的线程执行的。根据时序图，进一步分析出其内部工作流程。</p>
<ul>
<li>main(主)线程执行cb.await操作，主要调用的函数如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429171356.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由于ReentrantLock的默认采用非公平策略，所以在dowait函数中调用的是ReentrantLock.NonfairSync的lock函数，由于此时AQS的状态是0，表示还没有被任何线程占用，故main线程可以占用，之后在dowait中会调用trip.await函数，最终的结果是条件队列中存放了一个包含main线程的结点，并且被禁止运行了，同时，main线程所拥有的资源也被释放了，可以供其他线程获取。</p>
<ul>
<li>t1线程执行cb.await操作，其中假设t1线程的lock.lock操作在main线程释放了资源之后，则其主要调用的函数如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429171420.png style=display:block;width:50% alt=NAME align=center> </div>
<p>可以看到，之后condition queue(条件队列)里面有两个节点，包含t1线程的结点插入在队列的尾部，并且t1线程也被禁止了，因为执行了park操作，此时两个线程都被禁止了。</p>
<ul>
<li>t2线程执行cb.await操作，其中假设t2线程的lock.lock操作在t1线程释放了资源之后，则其主要调用的函数如下。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429171435.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由上图可知，在t2线程执行await操作后，会直接执行command.run方法，不是重新开启一个线程，而是最后进入屏障的线程执行。同时，会将Condition queue中的所有节点都转移到Sync queue中，并且最后main线程会被unpark，可以继续运行。main线程获取cpu资源，继续运行。</p>
<ul>
<li>main线程获取cpu资源，继续运行，下图给出了主要的方法调用:</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429171455.png style=display:block;width:50% alt=NAME align=center> </div>
<p>其中，由于main线程是在AQS.CO的wait中被park的，所以恢复时，会继续在该方法中运行。运行过后，t1线程被unpark，它获得cpu资源可以继续运行。</p>
<ul>
<li>t1线程获取cpu资源，继续运行，下图给出了主要的方法调用。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429171510.png style=display:block;width:50% alt=NAME align=center> </div>
<p>其中，由于t1线程是在AQS.CO的wait方法中被park，所以恢复时，会继续在该方法中运行。运行过后，Sync queue中保持着一个空节点。头结点与尾节点均指向它。</p>
<p>注意: 在线程await过程中中断线程会抛出异常，所有进入屏障的线程都将被释放。至于CyclicBarrier的其他用法，读者可以自行查阅API，不再累赘。</p>
<h2 id=对比-countdownlatch>对比 CountDownLatch</h2>
<ul>
<li>
<p>CountDownLatch减计数，CyclicBarrier加计数。</p>
</li>
<li>
<p>CountDownLatch是一次性的，CyclicBarrier可以重用。</p>
</li>
<li>
<p>CountDownLatch和CyclicBarrier都有让多个线程等待同步然后再开始下一步动作的意思，但是CountDownLatch的下一步的动作实施者是主线程，具有不可重复性；</p>
</li>
<li>
<p>而CyclicBarrier的下一步动作实施者还是“其他线程”本身，具有往复多次实施动作的特点。</p>
</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b07a58fa9f4dedb54298bb2cc5da3439>3.26 - CH26-Semaphore</h1>
<h2 id=概览>概览</h2>
<p>Semaphore底层基于 AQS。Semaphore称为计数信号量，它允许n个任务同时访问某个资源，可以将信号量看做是在向外分发使用资源的许可证，只有成功获取许可证，才能使用资源。</p>
<h2 id=源码分析>源码分析</h2>
<h3 id=层级结构>层级结构</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Semaphore</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</code></pre></div><h3 id=内部类>内部类</h3>
<p>Semaphore总共有三个内部类，并且三个内部类是紧密相关的，下面先看三个类的关系。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429172753.png style=display:block;width:50% alt=NAME align=center> </div>
<p>Semaphore与ReentrantLock的内部类的结构相同，类内部总共存在Sync、NonfairSync、FairSync三个类，NonfairSync与FairSync类继承自Sync类，Sync类继承自AbstractQueuedSynchronizer抽象类。</p>
<h3 id=内部类sync>内部类：Sync</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// 内部类，继承自AQS
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Sync</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractQueuedSynchronizer</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1192457210091910933L</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造函数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Sync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置状态数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>getPermits</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 共享模式下非公平策略获取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nonfairTryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取许可数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 剩余的许可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>available</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 许可小于0或者比较并且设置状态成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>// 共享模式下进行释放
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>tryReleaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 可用的许可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>releases</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// overflow
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Maximum permit count exceeded&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 比较并进行设置成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 根据指定的缩减量减小可用许可的数目
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reducePermits</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>reductions</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#8f5902;font-style:italic>// 可用的许可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>reductions</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// underflow
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Permit count underflow&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 比较并进行设置成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 获取并返回立即可用的所有许可
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>drainPermits</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 许可为0或者比较并设置成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>current</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Sync类的属性相对简单，只有一个版本号，Sync类存在如下方法和作用如下。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429172852.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=内部类nonfairsync>内部类：NonfairSync</h3>
<p>NonfairSync类继承了Sync类，表示采用非公平策略获取资源，其只有一个tryAcquireShared方法，重写了AQS的该方法，其源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NonfairSync</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sync</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>2694183684443567898L</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#8f5902;font-style:italic>// 构造函数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>NonfairSync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 共享模式下获取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nonfairTryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从tryAcquireShared方法的源码可知，其会调用父类Sync的nonfairTryAcquireShared方法，表示按照非公平策略进行资源的获取。</p>
<h3 id=内部类fairsync>内部类：FairSync</h3>
<p>FairSync类继承了Sync类，表示采用公平策略获取资源，其只有一个tryAcquireShared方法，重写了AQS的该方法，其源码如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>tryAcquireShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// 无限循环
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasQueuedPredecessors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// 同步队列中存在其他节点
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 获取许可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// 剩余的许可
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>available</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>acquires</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#000>compareAndSetState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// 剩余的许可小于0或者比较设置成功
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>从tryAcquireShared方法的源码可知，它使用公平策略来获取资源，它会判断同步队列中是否存在其他的等待节点。</p>
<h3 id=类属性>类属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Semaphore</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 版本号
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>3222578661600680210L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 属性
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Sync</span> <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Semaphore自身只有两个属性，最重要的是sync属性，基于Semaphore对象的操作绝大多数都转移到了对sync的操作。</p>
<h3 id=构造函数>构造函数</h3>
<ul>
<li>Semaphore(int)型构造函数</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Semaphore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sync</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NonfairSync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该构造函数会创建具有给定的许可数和非公平的公平设置的Semaphore。</p>
<ul>
<li>Semaphore(int, boolean)型构造函数</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Semaphore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>fair</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sync</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fair</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FairSync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NonfairSync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该构造函数会创建具有给定的许可数和给定的公平设置的Semaphore。</p>
<h3 id=核心函数acquire>核心函数：acquire</h3>
<p>此方法从信号量获取一个(多个)许可，在提供一个许可前一直将线程阻塞，或者线程被中断，其源码如下</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>acquire</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>acquireSharedInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法中将会调用Sync对象的acquireSharedInterruptibly(从AQS继承而来的方法)方法，而acquireSharedInterruptibly方法在上一篇CountDownLatch中已经进行了分析，在此不再累赘。</p>
<p>最终可以获取大致的方法调用序列(假设使用非公平策略)。如下图所示。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173214.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图只是给出了大体会调用到的方法，和具体的示例可能会有些差别，之后会根据具体的示例进行分析。</p>
<h3 id=核心函数release>核心函数：release</h3>
<p>此方法释放一个(多个)许可，将其返回给信号量，源码如下。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>release</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>sync</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>releaseShared</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法中将会调用Sync对象的releaseShared(从AQS继承而来的方法)方法，而releaseShared方法在上一篇CountDownLatch中已经进行了分析，在此不再累赘。</p>
<p>最终可以获取大致的方法调用序列(假设使用非公平策略)。如下图所示:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173259.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=应用实例>应用实例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.Semaphore</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThread</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Semaphore</span> <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Semaphore</span> <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>semaphore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>        
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; trying to acquire&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>acquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; acquire successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; release successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SemaphoreDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SEM_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Semaphore</span> <span style=color:#000>semaphore</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Semaphore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SEM_SIZE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>MyThread</span> <span style=color:#000>t2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;t2&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>t2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>permits</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; trying to acquire&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>acquire</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>permits</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; acquire successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>semaphore</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>release</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; release successfully&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>      
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>main trying to acquire
main acquire successfully
t1 trying to acquire
t1 acquire successfully
t2 trying to acquire
t1 release successfully
main release successfully
t2 acquire successfully
t2 release successfully
</code></pre></div><p>首先，生成一个信号量，信号量有10个许可，然后，main，t1，t2三个线程获取许可运行，根据结果，可能存在如下的一种时序。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173335.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如上图所示，首先，main线程执行acquire操作，并且成功获得许可，之后t1线程执行acquire操作，成功获得许可，之后t2执行acquire操作，由于此时许可数量不够，t2线程将会阻塞，直到许可可用。之后t1线程释放许可，main线程释放许可，此时的许可数量可以满足t2线程的要求，所以，此时t2线程会成功获得许可运行，t2运行完成后释放许可。下面进行详细分析。</p>
<ul>
<li>main线程执行semaphore.acquire操作。主要的函数调用如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173358.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明: 此时，可以看到只是AQS的state变为了5，main线程并没有被阻塞，可以继续运行。</p>
<ul>
<li>t1线程执行semaphore.acquire操作。主要的函数调用如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173410.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明: 此时，可以看到只是AQS的state变为了2，t1线程并没有被阻塞，可以继续运行。</p>
<ul>
<li>t2线程执行semaphore.acquire操作。主要的函数调用如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173423.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明: 此时，t2线程获取许可不会成功，之后会导致其被禁止运行，值得注意的是，AQS的state还是为2。</p>
<ul>
<li>t1执行semaphore.release操作。主要的函数调用如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173438.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明: 此时，t2线程将会被unpark，并且AQS的state为5，t2获取cpu资源后可以继续运行。</p>
<ul>
<li>main线程执行semaphore.release操作。主要的函数调用如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173450.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明: 此时，t2线程还会被unpark，但是不会产生影响，此时，只要t2线程获得CPU资源就可以运行了。此时，AQS的state为10。</p>
<ul>
<li>t2获取CPU资源，继续运行，此时t2需要恢复现场，回到parkAndCheckInterrupt函数中，也是在should继续运行。主要的函数调用如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173506.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明: 此时，可以看到，Sync queue中只有一个结点，头结点与尾节点都指向该结点，在setHeadAndPropagate的函数中会设置头结点并且会unpark队列中的其他结点。</p>
<ul>
<li>t2线程执行semaphore.release操作。主要的函数调用如下图所示。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429173522.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明: t2线程经过release后，此时信号量的许可又变为10个了，此时Sync queue中的结点还是没有变化。</p>
<h2 id=深入理解>深入理解</h2>
<h3 id=单独使用semaphore是不会使用到aqs的条件队列的>单独使用Semaphore是不会使用到AQS的条件队列的</h3>
<p>不同于CyclicBarrier和ReentrantLock，单独使用Semaphore是不会使用到AQS的条件队列的，其实，只有进行await操作才会进入条件队列，其他的都是在同步队列中，只是当前线程会被park。</p>
<h3 id=场景问题>场景问题</h3>
<h4 id=semaphore初始化有10个令牌11个线程同时各调用1次acquire方法会发生什么>semaphore初始化有10个令牌，11个线程同时各调用1次acquire方法，会发生什么?</h4>
<p>答案：拿不到令牌的线程阻塞，不会继续往下运行。</p>
<h4 id=semaphore初始化有10个令牌一个线程重复调用11次acquire方法会发生什么>semaphore初始化有10个令牌，一个线程重复调用11次acquire方法，会发生什么?</h4>
<p>答案：线程阻塞，不会继续往下运行。可能你会考虑类似于锁的重入的问题，很好，但是，令牌没有重入的概念。你只要调用一次acquire方法，就需要有一个令牌才能继续运行。</p>
<h4 id=semaphore初始化有1个令牌1个线程调用一次acquire方法然后调用两次release方法之后另外一个线程调用acquire2方法此线程能够获取到足够的令牌并继续运行吗>semaphore初始化有1个令牌，1个线程调用一次acquire方法，然后调用两次release方法，之后另外一个线程调用acquire(2)方法，此线程能够获取到足够的令牌并继续运行吗?</h4>
<p>答案：能，原因是release方法会添加令牌，并不会以初始化的大小为准。</p>
<h4 id=semaphore初始化有2个令牌一个线程调用1次release方法然后一次性获取3个令牌会获取到吗>semaphore初始化有2个令牌，一个线程调用1次release方法，然后一次性获取3个令牌，会获取到吗?</h4>
<p>答案：能，原因是release会添加令牌，并不会以初始化的大小为准。Semaphore中release方法的调用并没有限制要在acquire后调用。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-37b34c6bdf5b51ec490dd5294c89141c>3.27 - CH27-Phaser</h1>
<h2 id=概览>概览</h2>
<p>Phaser是JDK 7新增的一个同步辅助类，它可以实现CyclicBarrier和CountDownLatch类似的功能，而且它支持对任务的动态调整，并支持分层结构来达到更高的吞吐量。</p>
<h2 id=运行机制>运行机制</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429175218.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=注册registration>注册：Registration</h3>
<p>跟其他barrier不同，在phaser上注册的parties会随着时间的变化而变化。任务可以随时注册(使用方法register,bulkRegister注册，或者由构造器确定初始parties)，并且在任何抵达点可以随意地撤销注册(方法arriveAndDeregister)。就像大多数基本的同步结构一样，注册和撤销只影响内部count；不会创建更深的内部记录，所以任务不能查询他们是否已经注册。(不过，可以通过继承来实现类似的记录)</p>
<h3 id=同步synchronization>同步：Synchronization</h3>
<p>和CyclicBarrier一样，Phaser也可以重复await。方法arriveAndAwaitAdvance的效果类似CyclicBarrier.await。phaser的每一代都有一个相关的phase number，初始值为0，当所有注册的任务都到达phaser时phase+1，到达最大值(Integer.MAX_VALUE)之后清零。使用phase number可以独立控制 到达phaser 和 等待其他线程 的动作，通过下面两种类型的方法:</p>
<h4 id=到达机制arrival>到达机制：Arrival</h4>
<p>arrive和arriveAndDeregister方法记录到达状态。这些方法不会阻塞，但是会返回一个相关的arrival phase number；也就是说，phase number用来确定到达状态。当所有任务都到达给定phase时，可以执行一个可选的函数，这个函数通过重写onAdvance方法实现，通常可以用来控制终止状态。重写此方法类似于为CyclicBarrier提供一个barrierAction，但比它更灵活。</p>
<h4 id=等待机制waiting>等待机制：Waiting</h4>
<p>awaitAdvance方法需要一个表示arrival phase number的参数，并且在phaser前进到与给定phase不同的phase时返回。和CyclicBarrier不同，即使等待线程已经被中断，awaitAdvance方法也会一直等待。中断状态和超时时间同样可用，但是当任务等待中断或超时后未改变phaser的状态时会遭遇异常。如果有必要，在方法forceTermination之后可以执行这些异常的相关的handler进行恢复操作，Phaser也可能被ForkJoinPool中的任务使用，这样在其他任务阻塞等待一个phase时可以保证足够的并行度来执行任务。</p>
<h3 id=终止termination>终止：Termination</h3>
<p>可以用isTerminated方法检查phaser的终止状态。在终止时，所有同步方法立刻返回一个负值。在终止时尝试注册也没有效果。当调用onAdvance返回true时Termination被触发。当deregistration操作使已注册的parties变为0时，onAdvance的默认实现就会返回true。也可以重写onAdvance方法来定义终止动作。forceTermination方法也可以释放等待线程并且允许它们终止。</p>
<h3 id=分层tiering>分层：Tiering</h3>
<p>Phaser支持分层结构(树状构造)来减少竞争。注册了大量parties的Phaser可能会因为同步竞争消耗很高的成本， 因此可以设置一些子Phaser来共享一个通用的parent。这样的话即使每个操作消耗了更多的开销，但是会提高整体吞吐量。 在一个分层结构的phaser里，子节点phaser的注册和取消注册都通过父节点管理。子节点phaser通过构造或方法register、bulkRegister进行首次注册时，在其父节点上注册。子节点phaser通过调用arriveAndDeregister进行最后一次取消注册时，也在其父节点上取消注册。</p>
<h3 id=监控monitoring>监控：Monitoring</h3>
<p>由于同步方法可能只被已注册的parties调用，所以phaser的当前状态也可能被任何调用者监控。在任何时候，可以通过getRegisteredParties获取parties数，其中getArrivedParties方法返回已经到达当前phase的parties数。当剩余的parties(通过方法getUnarrivedParties获取)到达时，phase进入下一代。这些方法返回的值可能只表示短暂的状态，所以一般来说在同步结构里并没有啥卵用。</p>
<h2 id=源码分析>源码分析</h2>
<h3 id=核心属性>核心属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * The parent of this phaser, or null if none
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * The root of phaser tree. Equals this if not in a tree.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>//等待线程的栈顶元素，根据phase取模定义为一个奇数header和一个偶数header
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>evenQ</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>oddQ</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>Phaser使用一个long型state值来标识内部状态:</p>
<ul>
<li>低0-15位表示未到达parties数；</li>
<li>中16-31位表示等待的parties数；</li>
<li>中32-62位表示phase当前代；</li>
<li>高63位表示当前phaser的终止状态。</li>
</ul>
<p>子Phaser的phase在没有被真正使用之前，允许滞后于它的root节点。这里在后面源码分析的reconcileState方法里会讲解。 Qnode是Phaser定义的内部等待队列，用于在阻塞时记录等待线程及相关信息。实现了ForkJoinPool的一个内部接口ManagedBlocker，上面已经说过，Phaser也可能被ForkJoinPool中的任务使用，这样在其他任务阻塞等待一个phase时可以保证足够的并行度来执行任务(通过内部实现方法isReleasable和block)。</p>
<h3 id=函数列表>函数列表</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//构造方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Phaser</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Phaser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Phaser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Phaser</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Phaser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Phaser</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>//注册一个新的party
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic>//批量注册
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bulkRegister</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>//使当前线程到达phaser，不等待其他任务到达。返回arrival phase number
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arrive</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>//使当前线程到达phaser并撤销注册，返回arrival phase number
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arriveAndDeregister</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic>/*
</span><span style=color:#8f5902;font-style:italic> * 使当前线程到达phaser并等待其他任务到达，等价于awaitAdvance(arrive())。
</span><span style=color:#8f5902;font-style:italic> * 如果需要等待中断或超时，可以使用awaitAdvance方法完成一个类似的构造。
</span><span style=color:#8f5902;font-style:italic> * 如果需要在到达后取消注册，可以使用awaitAdvance(arriveAndDeregister())。
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arriveAndAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic>//等待给定phase数，返回下一个 arrival phase number
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>//阻塞等待，直到phase前进到下一代，返回下一代的phase number
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic>//响应中断版awaitAdvance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitAdvanceInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitAdvanceInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span> <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeoutException</span>
<span style=color:#8f5902;font-style:italic>//使当前phaser进入终止状态，已注册的parties不受影响，如果是分层结构，则终止所有phaser
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>forceTermination</span><span style=color:#ce5c00;font-weight:700>()</span>
</code></pre></div><h3 id=方法register>方法：register</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//注册一个新的party
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>register</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doRegister</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doRegister</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>registrations</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// adjustment to state
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>adjust</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>registrations</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>PARTIES_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>registrations</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parent</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>reconcileState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parties</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PARTIES_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//获取已注册parties数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>UNARRIVED_MASK</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//未到达数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>registrations</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_PARTIES</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>parties</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>badRegister</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//获取当前代
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>EMPTY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                  <span style=color:#8f5902;font-style:italic>// not 1st registration
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>reconcileState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>             <span style=color:#8f5902;font-style:italic>// wait out advance
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internalAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//等待其他任务到达
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                                                   <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>adjust</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//更新注册的parties数
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>parent</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>              <span style=color:#8f5902;font-style:italic>// 1st root registration
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>adjust</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//更新phase
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//分层结构，子phaser首次注册用父节点管理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>               <span style=color:#8f5902;font-style:italic>// 1st sub registration
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>               <span style=color:#8f5902;font-style:italic>// recheck under lock
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doRegister</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//分层结构，使用父节点注册
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#8f5902;font-style:italic>// finish registration whenever parent registration
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// succeeded, even when racing with termination,
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// since these are part of the same &#34;transaction&#34;.
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>//由于在同一个事务里，即使phaser已终止，也会完成注册
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span>
                           <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span>
                            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>adjust</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//更新phase
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#8f5902;font-style:italic>// assert (int)s == EMPTY;
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span>
                    <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>register方法为phaser添加一个新的party，如果onAdvance正在运行，那么这个方法会等待它运行结束再返回结果。如果当前phaser有父节点，并且当前phaser上没有已注册的party，那么就会交给父节点注册。</p>
<p>register和bulkRegister都由doRegister实现，大概流程如下:</p>
<ul>
<li>如果当前操作不是首次注册，那么直接在当前phaser上更新注册parties数</li>
<li>如果是首次注册，并且当前phaser没有父节点，说明是root节点注册，直接更新phase</li>
<li>如果当前操作是首次注册，并且当前phaser由父节点，则注册操作交由父节点，并更新当前phaser的phase</li>
<li>上面说过，子Phaser的phase在没有被真正使用之前，允许滞后于它的root节点。非首次注册时，如果Phaser有父节点，则调用reconcileState()方法解决root节点的phase延迟传递问题， 源码如下:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>reconcileState</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// CAS to root phase with current parties, tripping unarrived
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>state</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span>
               <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
               <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span>
               <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span>
                <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span>
                     <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>COUNTS_MASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span>
                      <span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PARTIES_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>EMPTY</span> <span style=color:#ce5c00;font-weight:700>:</span>
                       <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>PARTIES_MASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>))))))</span>
            <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当root节点的phase已经advance到下一代，但是子节点phaser还没有，这种情况下它们必须通过更新未到达parties数 完成它们自己的advance操作(如果parties为0，重置为EMPTY状态)。</p>
<p>回到register方法的第一步，如果当前未到达数为0，说明上一代phase正在进行到达操作，此时调用internalAwaitAdvance()方法等待其他任务完成到达操作，源码如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//阻塞等待phase到下一代
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>internalAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>QNode</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// assert root == this;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>releaseWaiters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>          <span style=color:#8f5902;font-style:italic>// ensure old queue clean
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>queued</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#8f5902;font-style:italic>// true when node is enqueued
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lastUnarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>// to increase spins upon change
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS_PER_ARRIVAL</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#8f5902;font-style:italic>// spinning in noninterruptible mode
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>UNARRIVED_MASK</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//未到达数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>lastUnarrived</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastUnarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>unarrived</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>NCPU</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>SPINS_PER_ARRIVAL</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interrupted</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>--</span><span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// need node to record intr
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//使用node记录中断状态
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasInterrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>interrupted</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReleasable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// done or aborted
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>queued</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#8f5902;font-style:italic>// push onto queue
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>QNode</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>evenQ</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>oddQ</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>QNode</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>phase</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// avoid stale enq
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>queued</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>managedBlock</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//阻塞给定node
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ie</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasInterrupted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>thread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// avoid need for unpark()
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasInterrupted</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interruptible</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>interrupt</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>abortWait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// possibly clean up on abort
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>releaseWaiters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>简单介绍下第二个参数node，如果不为空，则说明等待线程需要追踪中断状态或超时状态。以doRegister中的调用为例，不考虑线程争用，internalAwaitAdvance大概流程如下:</p>
<ul>
<li>首先调用releaseWaiters唤醒上一代所有等待线程，确保旧队列中没有遗留的等待线程。</li>
<li>循环SPINS_PER_ARRIVAL指定的次数或者当前线程被中断，创建node记录等待线程及相关信息。</li>
<li>继续循环调用ForkJoinPool.managedBlock运行被阻塞的任务</li>
<li>继续循环，阻塞任务运行成功被释放，跳出循环</li>
<li>最后唤醒当前phase的线程</li>
</ul>
<h3 id=方法arrive>方法：arrive</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//使当前线程到达phaser，不等待其他任务到达。返回arrival phase number
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arrive</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>doArrive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ONE_ARRIVAL</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>doArrive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>adjust</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>reconcileState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//获取未到达数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>EMPTY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>UNARRIVED_MASK</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>badArrive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>-=</span><span style=color:#000>adjust</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//更新state
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//当前为最后一个未到达的任务
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>PARTIES_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// base of next state
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextUnarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PARTIES_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>onAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextUnarrived</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//检查是否需要终止phaser
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>TERMINATION_BIT</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextUnarrived</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>EMPTY</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>else</span>
                        <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>nextUnarrived</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextPhase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MAX_PHASE</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>nextPhase</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>releaseWaiters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//释放等待phase的线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>//分层结构，使用父节点管理arrive
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextUnarrived</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>//propagate deregistration
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doArrive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ONE_DEREGISTER</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span>
                                              <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>EMPTY</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>else</span>
                    <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>doArrive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ONE_ARRIVAL</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>arrive方法手动调整到达数，使当前线程到达phaser。arrive和arriveAndDeregister都调用了doArrive实现，大概流程如下:</p>
<ul>
<li>首先更新state(state - adjust)；</li>
<li>如果当前不是最后一个未到达的任务，直接返回phase</li>
<li>如果当前是最后一个未到达的任务:
<ul>
<li>如果当前是root节点，判断是否需要终止phaser，CAS更新phase，最后释放等待的线程；</li>
<li>如果是分层结构，并且已经没有下一代未到达的parties，则交由父节点处理doArrive逻辑，然后更新state为EMPTY。</li>
</ul>
</li>
</ul>
<h3 id=方法arriveandawaitadvance>方法：arriveAndAwaitAdvance</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arriveAndAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Specialization of doArrive+awaitAdvance eliminating some reads/paths
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>reconcileState</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>EMPTY</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>UNARRIVED_MASK</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//获取未到达数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>badArrive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>));</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span>
                                      <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>ONE_ARRIVAL</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#8f5902;font-style:italic>//更新state
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>unarrived</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internalAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//阻塞等待其他任务
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arriveAndAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//子Phaser交给父节点处理
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>PARTIES_MASK</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// base of next state
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextUnarrived</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PARTIES_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>onAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextUnarrived</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//全部到达，检查是否可销毁
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>TERMINATION_BIT</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextUnarrived</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>EMPTY</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#000>nextUnarrived</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextPhase</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MAX_PHASE</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//计算下一代phase
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>nextPhase</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>UNSAFE</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stateOffset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span><span style=color:#8f5902;font-style:italic>//更新state
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// terminated
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>releaseWaiters</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>//释放等待phase的线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nextPhase</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>说明: 使当前线程到达phaser并等待其他任务到达，等价于awaitAdvance(arrive())。如果需要等待中断或超时，可以使用awaitAdvance方法完成一个类似的构造。如果需要在到达后取消注册，可以使用awaitAdvance(arriveAndDeregister())。效果类似于CyclicBarrier.await。大概流程如下:</p>
<ul>
<li>更新state(state - 1)；</li>
<li>如果未到达数大于1，调用internalAwaitAdvance阻塞等待其他任务到达，返回当前phase</li>
<li>如果为分层结构，则交由父节点处理arriveAndAwaitAdvance逻辑</li>
<li>如果未到达数&lt;=1，判断phaser终止状态，CAS更新phase到下一代，最后释放等待当前phase的线程，并返回下一代phase。</li>
</ul>
<h3 id=方法awaitadvanceint-phase>方法：awaitAdvance(int phase)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>reconcileState</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internalAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>//响应中断版awaitAdvance
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>awaitAdvanceInterruptibly</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Phaser</span> <span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>root</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>reconcileState</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>PHASE_SHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>QNode</span> <span style=color:#000>node</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QNode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0L</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>internalAwaitAdvance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>phase</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wasInterrupted</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>awaitAdvance用于阻塞等待线程到达，直到phase前进到下一代，返回下一代的phase number。方法很简单，不多赘述。awaitAdvanceInterruptibly方法是响应中断版的awaitAdvance，不同之处在于，调用阻塞时会记录线程的中断状态。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-5949ad95de6afb94293992fe672e0f6d>3.28 - CH28-Exchanger</h1>
<h2 id=概览>概览</h2>
<p>Exchanger是用于线程协作的工具类, 主要用于两个线程之间的数据交换。</p>
<p>它提供一个同步点，在这个同步点，两个线程可以交换彼此的数据。这两个线程通过exchange()方法交换数据，当一个线程先执行exchange()方法后，它会一直等待第二个线程也执行exchange()方法，当这两个线程到达同步点时，这两个线程就可以交换数据了。</p>
<h2 id=实现机制>实现机制</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>slot</span> <span style=color:#000>is</span> <span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// offer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// slot为空时，将item 设置到Node 中        
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>place</span> <span style=color:#000>item</span> <span style=color:#000>in</span> <span style=color:#000>a</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>can</span> <span style=color:#000>CAS</span> <span style=color:#000>slot</span> <span style=color:#000>from</span> <span style=color:#000>empty</span> <span style=color:#000>to</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 当将node通过CAS交换到slot中时，挂起线程等待被唤醒
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>wait</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>release</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 被唤醒后返回node中匹配到的item
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>matching</span> <span style=color:#000>item</span> <span style=color:#000>in</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>can</span> <span style=color:#000>CAS</span> <span style=color:#000>slot</span> <span style=color:#000>from</span> <span style=color:#000>node</span> <span style=color:#000>to</span> <span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// release
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#8f5902;font-style:italic>// 将slot设置为空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 获取node中的item，将需要交换的数据设置到匹配的item
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>get</span> <span style=color:#000>the</span> <span style=color:#000>item</span> <span style=color:#000>in</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>set</span> <span style=color:#000>matching</span> <span style=color:#000>item</span> <span style=color:#000>in</span> <span style=color:#000>node</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 唤醒等待的线程
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>release</span> <span style=color:#000>waiting</span> <span style=color:#000>thread</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// else retry on CAS failure
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>比如有2条线程A和B，A线程交换数据时，发现slot为空，则将需要交换的数据放在slot中等待其它线程进来交换数据，等线程B进来，读取A设置的数据，然后设置线程B需要交换的数据，然后唤醒A线程，原理就是这么简单。但是当多个线程之间进行交换数据时就会出现问题，所以Exchanger加入了slot数组。</p>
<h2 id=源码解析>源码解析</h2>
<h3 id=内部类node>内部类：Node</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@sun.misc.Contended</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>// arena的下标，多个槽位的时候利用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#8f5902;font-style:italic>// 上一次记录的Exchanger.bound
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bound</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#8f5902;font-style:italic>// 在当前bound下CAS失败的次数；
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>collides</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 用于自旋；
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hash</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#8f5902;font-style:italic>// 这个线程的当前项，也就是需要交换的数据；
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#8f5902;font-style:italic>//做releasing操作的线程传递的项；
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Object</span> <span style=color:#000>match</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#8f5902;font-style:italic>//挂起时设置线程值，其他情况下为null；
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Thread</span> <span style=color:#000>parked</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在Node定义中有两个变量值得思考：bound以及collides。前面提到了数组area是为了避免竞争而产生的，如果系统不存在竞争问题，那么完全没有必要开辟一个高效的arena来徒增系统的复杂性。</p>
<p>首先通过单个slot的exchanger来交换数据，当探测到竞争时将安排不同的位置的slot来保存线程Node，并且可以确保没有slot会在同一个缓存行上。</p>
<p>如何来判断会有竞争呢? CAS替换slot失败，如果失败，则通过记录冲突次数来扩展arena的尺寸，我们在记录冲突的过程中会跟踪“bound”的值，以及会重新计算冲突次数在bound的值被改变时。</p>
<h3 id=核心属性>核心属性</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Participant</span> <span style=color:#000>participant</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>Node</span> <span style=color:#000>slot</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><ul>
<li><strong>为什么会有 <code>arena数组槽</code>?</strong></li>
</ul>
<p>slot为单个槽，arena为数组槽, 他们都是Node类型。在这里可能会感觉到疑惑，slot作为Exchanger交换数据的场景，应该只需要一个就可以了啊? 为何还多了一个Participant 和数组类型的arena呢?</p>
<p>一个slot交换场所原则上来说应该是可以的，但实际情况却不是如此，多个参与者使用同一个交换场所时，会存在严重伸缩性问题。既然单个交换场所存在问题，那么我们就安排多个，也就是数组arena。通过数组arena来安排不同的线程使用不同的slot来降低竞争问题，并且可以保证最终一定会成对交换数据。但是<strong>Exchanger不是一来就会生成arena数组来降低竞争，只有当产生竞争是才会生成arena数组</strong>。</p>
<ul>
<li><strong>那么怎么将Node与当前线程绑定呢？</strong></li>
</ul>
<p>Participant，Participant 的作用就是为每个线程保留唯一的一个Node节点，它继承ThreadLocal，同时在Node节点中记录在arena中的下标index。</p>
<h3 id=构造函数>构造函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>* Creates a new Exchanger.
</span><span style=color:#8f5902;font-style:italic>*/</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Exchanger</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>participant</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Participant</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=核心方法exchangev-x>核心方法：exchange(V x)</h3>
<p>等待另一个线程到达此交换点(除非当前线程被中断)，然后将给定的对象传送给该线程，并接收该线程的对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>V</span> <span style=color:#000>exchange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Object</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 当参数为null时需要将item设置为空的对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Object</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>NULL_ITEM</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// translate null args
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 注意到这里的这个表达式是整个方法的核心
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>arena</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>slotExchange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
        <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#8f5902;font-style:italic>// disambiguates null return
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arenaExchange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)))</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InterruptedException</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>NULL_ITEM</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方法比较好理解：arena为数组槽，如果为null，则执行slotExchange()方法，否则判断线程是否中断，如果中断值抛出InterruptedException异常，没有中断则执行arenaExchange()方法。整套逻辑就是：如果slotExchange(Object item, boolean timed, long ns)方法执行失败了就执行arenaExchange(Object item, boolean timed, long ns)方法，最后返回结果V。</p>
<p>NULL_ITEM 为一个空节点，其实就是一个Object对象而已，slotExchange()为单个slot交换。</p>
<h3 id=slotexchangeobject-item-boolean-timed-long-ns>slotExchange(Object item, boolean timed, long ns)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>slotExchange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 获取当前线程node对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>participant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>// 若果线程被中断，就直接返回null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterrupted</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// preserve interrupt status so caller can recheck
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
	<span style=color:#8f5902;font-style:italic>// 自旋
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 将slot值赋给q
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>slot</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#8f5902;font-style:italic>// slot 不为null，即表示已有线程已经把需要交换的数据设置在slot中了
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// 通过CAS将slot设置成null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SLOT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// CAS操作成功后，将slot中的item赋值给对象v，以便返回。
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 这里也是就读取之前线程要交换的数据
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Object</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 将当前线程需要交给的数据设置在q中的match
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
                 <span style=color:#8f5902;font-style:italic>// 获取被挂起的线程
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Thread</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parked</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#8f5902;font-style:italic>// 如果线程不为null，唤醒它
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>// 返回其他线程给的V
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>// create arena on contention, but continue until slot null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// CAS 操作失败，表示有其它线程竞争，在此线程之前将数据已取走
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// NCPU:CPU的核数
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// bound == 0 表示arena数组未初始化过，CAS操作bound将其增加SEQ
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>bound</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BOUND</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SEQ</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#8f5902;font-style:italic>// 初始化arena数组
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>arena</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#000>FULL</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>];</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 上面分析过，只有当arena不为空才会执行slotExchange方法的
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// 所以表示刚好已有其它线程加入进来将arena初始化
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arena</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>// 这里就需要去执行arenaExchange
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// caller must reroute to arenaExchange
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 这里表示当前线程是以第一个线程进来交换数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 或者表示之前的数据交换已进行完毕，这里可以看作是第一个线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 将需要交换的数据先存放在当前线程变量p中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 将需要交换的数据通过CAS设置到交换区slot
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SLOT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>))</span>
                <span style=color:#8f5902;font-style:italic>// 交换成功后跳出自旋
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// CAS操作失败，表示有其它线程刚好先于当前线程将数据设置到交换区slot
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 将当前线程变量中的item设置为null，然后自旋获取其它线程存放在交换区slot的数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// await release
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 执行到这里表示当前线程已将需要的交换的数据放置于交换区slot中了，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 等待其它线程交换数据然后唤醒当前线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span> <span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 自旋次数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>SPINS</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>Object</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 自旋等待直到p.match不为null，也就是说等待其它线程将需要交换的数据放置于交换区slot
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 下面的逻辑主要是自旋等待，直到spins递减到0为止
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SPINS</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>yield</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>slot</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// 此处表示未设置超时或者时间未超时
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterrupted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>arena</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
            <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 设置线程t被当前对象阻塞
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLOCKER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 给p挂机线程的值赋值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parked</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>slot</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#8f5902;font-style:italic>// 如果slot还没有被置为null，也就表示暂未有线程过来交换数据，需要将当前线程挂起
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// 线程被唤醒，将被挂起的线程设置为null
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parked</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>// 设置线程t未被任何对象阻塞
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLOCKER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 不是以上条件时(可能是arena已不为null或者超时)    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SLOT</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#8f5902;font-style:italic>// arena不为null则v为null,其它为超时则v为超市对象TIMED_OUT，并且跳出循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#000>L</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterrupted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>TIMED_OUT</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// 取走match值，并将p中的match置为null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MATCH</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>// 设置item为null
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 返回交换值
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>程序首先通过participant获取当前线程节点Node。检测是否中断，如果中断return null，等待后续抛出InterruptedException异常。</p>
<ul>
<li>如果slot不为null，则进行slot消除，成功直接返回数据V，否则失败，则创建arena消除数组。</li>
<li>如果slot为null，但arena不为null，则返回null，进入arenaExchange逻辑。</li>
<li>如果slot为null，且arena也为null，则尝试占领该slot，失败重试，成功则跳出循环进入spin+block(自旋+阻塞)模式。</li>
</ul>
<p>在自旋+阻塞模式中，首先取得结束时间和自旋次数。如果match(做releasing操作的线程传递的项)为null，其首先尝试spins+随机次自旋(改自旋使用当前节点中的hash，并改变之)和退让。当自旋数为0后，假如slot发生了改变(slot != p)则重置自旋数并重试。否则假如：当前未中断&arena为null&(当前不是限时版本或者限时版本+当前时间未结束)：阻塞或者限时阻塞。假如：当前中断或者arena不为null或者当前为限时版本+时间已经结束：不限时版本：置v为null；限时版本：如果时间结束以及未中断则TIMED_OUT；否则给出null(原因是探测到arena非空或者当前线程中断)。</p>
<p>match不为空时跳出循环。</p>
<h3 id=arenaexchangeobject-item-boolean-timed-long-ns>arenaExchange(Object item, boolean timed, long ns)</h3>
<p>此方法被执行时表示多个线程进入交换区交换数据，arena数组已被初始化，此方法中的一些处理方式和slotExchange比较类似，它是通过遍历arena数组找到需要交换的数据。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// timed 为true表示设置了超时时间，ns为&gt;0的值，反之没有设置超时时间
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Object</span> <span style=color:#000>arenaExchange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>timed</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>arena</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>// 获取当前线程中的存放的node
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>participant</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#8f5902;font-style:italic>//index初始值0
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>index</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// access slot at i
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 遍历，如果在数组中找到数据则直接交换并唤醒线程，如未找到则将需要交换给其它线程的数据放置于数组中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// j is raw array offset
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 其实这里就是向右遍历数组，只是用到了元素在内存偏移的偏移量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// q实际为arena数组偏移(i + 1) *  128个地址位上的node
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>Node</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>// 如果q不为null，并且CAS操作成功，将下标j的元素置为null
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 表示当前线程已发现有交换的数据，然后获取数据，唤醒等待的线程
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>Object</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// release
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>Thread</span> <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parked</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unpark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>// q 为null 并且 i 未超过数组边界    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bound</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>MMASK</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#8f5902;font-style:italic>// 将需要给其它线程的item赋予给p中的item
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// offer
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// 交换成功
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>0</span> <span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// wait
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 自旋直到有其它线程进入，遍历到该元素并与其交换，同时当前线程被唤醒
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS</span><span style=color:#ce5c00;font-weight:700>;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>Object</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>match</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 其它线程设置的需要交换的数据match不为null
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#8f5902;font-style:italic>// 将match设置null,item设置为null
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putOrderedObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MATCH</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// clear for next use
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>^=</span> <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// xorshift
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// initialize hash
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
                        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#8f5902;font-style:italic>// approx 50% true
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>SPINS</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>yield</span><span style=color:#ce5c00;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// two yields per wait
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#8f5902;font-style:italic>// 和slotExchange方法中的类似，arena数组中的数据已被CAS设置
</span><span style=color:#8f5902;font-style:italic></span>                       <span style=color:#8f5902;font-style:italic>// match值还未设置，让其再自旋等待match被设置
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>spins</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SPINS</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// releaser hasn&#39;t set match yet
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isInterrupted</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>||</span>
                            <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>nanoTime</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span> <span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 设置线程t被当前对象阻塞
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLOCKER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// emulate LockSupport
</span><span style=color:#8f5902;font-style:italic></span>                         <span style=color:#8f5902;font-style:italic>// 线程t赋值
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parked</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// minimize window
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#8f5902;font-style:italic>// 数组中对象还相等，表示线程还未被唤醒，唤醒线程
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>park</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>parked</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                         <span style=color:#8f5902;font-style:italic>// 设置线程t未被任何对象阻塞
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BLOCKER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
                        <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                        <span style=color:#8f5902;font-style:italic>// 这里给bound增加加一个SEQ
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// try to shrink
</span><span style=color:#8f5902;font-style:italic></span>                            <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BOUND</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SEQ</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>index</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// descend
</span><span style=color:#8f5902;font-style:italic></span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>interrupted</span><span style=color:#ce5c00;font-weight:700>())</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timed</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>ns</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span> <span style=color:#000>L</span><span style=color:#ce5c00;font-weight:700>)</span>
                            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>TIMED_OUT</span><span style=color:#ce5c00;font-weight:700>;</span>
                        <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// expired; restart
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>// 交换失败，表示有其它线程更改了arena数组中下标i的元素
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// clear offer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 此时表示下标不在bound &amp; MMASK或q不为null但CAS操作失败
</span><span style=color:#8f5902;font-style:italic></span>           <span style=color:#8f5902;font-style:italic>// 需要更新bound变化后的值
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bound</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// stale; reset
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bound</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collides</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 反向遍历
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collides</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>FULL</span> <span style=color:#ce5c00;font-weight:700>||</span>
                <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSwapInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BOUND</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>SEQ</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
                 <span style=color:#8f5902;font-style:italic>// 记录CAS失败的次数
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>collides</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#8f5902;font-style:italic>// 循环遍历
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// cyclically traverse
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span>
                <span style=color:#8f5902;font-style:italic>// 此时表示bound值增加了SEQ+1
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// grow
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 设置下标
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>首先通过participant取得当前节点Node，然后根据当前节点Node的index去取arena中相对应的节点node。</p>
<ul>
<li><strong>前面提到过arena可以确保不同的slot在arena中是不会相冲突的，那么是怎么保证的呢？</strong></li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>arena</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#000>FULL</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>];</span>
<span style=color:#8f5902;font-style:italic>// 这个arena到底有多大呢? 我们先看FULL 和ASHIFT的定义：
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>FULL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MMASK</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>MMASK</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ASHIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>NCPU</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRuntime</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>availableProcessors</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MMASK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// 255
</span><span style=color:#8f5902;font-style:italic>// 假如我的机器NCPU = 8 ，则得到的是768大小的arena数组。然后通过以下代码取得在arena中的节点：
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>Node</span> <span style=color:#000>q</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getObjectVolatile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ABASE</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// 它仍然是通过右移ASHIFT位来取得Node的，ABASE定义如下：
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>ak</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>ABASE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arrayBaseOffset</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ak</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>ASHIFT</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// U.arrayBaseOffset获取对象头长度，数组元素的大小可以通过unsafe.arrayIndexScale(T[].class) 方法获取到。这也就是说要访问类型为T的第N个元素的话，你的偏移量offset应该是arrayOffset+N*arrayScale。也就是说BASE = arrayOffset+ 128 。
</span></code></pre></div><ul>
<li><strong>用@sun.misc.Contended来规避伪共享？</strong></li>
</ul>
<p><strong>伪共享说明</strong>：假设一个类的两个相互独立的属性a和b在内存地址上是连续的(比如FIFO队列的头尾指针)，那么它们通常会被加载到相同的cpu cache line里面。并发情况下，如果一个线程修改了a，会导致整个cache line失效(包括b)，这时另一个线程来读b，就需要从内存里再次加载了，这种多线程频繁修改ab的情况下，虽然a和b看似独立，但它们会互相干扰，非常影响性能。</p>
<p>我们再看Node节点的定义, 在Java 8 中我们是可以利用sun.misc.Contended来规避伪共享的。所以说通过 &#171; ASHIFT方式加上sun.misc.Contended，所以使得任意两个可用Node不会再同一个缓存行中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#5c35cc;font-weight:700>@sun.misc.Contended</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>....</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们再次回到arenaExchange()。取得arena中的node节点后，如果定位的节点q 不为空，且CAS操作成功，则交换数据，返回交换的数据，唤醒等待的线程。</p>
<ul>
<li>如果q等于null且下标在bound & MMASK范围之内，则尝试占领该位置，如果成功，则采用自旋 + 阻塞的方式进行等待交换数据。</li>
<li>如果下标不在bound & MMASK范围之内获取由于q不为null但是竞争失败的时候：消除p。加入bound 不等于当前节点的bond(b != p.bound)，则更新p.bound = b，collides = 0 ，i = m或者m - 1。如果冲突的次数不到m 获取m 已经为最大值或者修改当前bound的值失败，则通过增加一次collides以及循环递减下标i的值；否则更新当前bound的值成功：我们令i为m+1即为此时最大的下标。最后更新当前index的值。</li>
</ul>
<h3 id=深入理解>深入理解</h3>
<ul>
<li><strong>SynchronousQueue对比？</strong></li>
</ul>
<p>Exchanger是一种线程间安全交换数据的机制。可以和之前分析过的SynchronousQueue对比一下：线程A通过SynchronousQueue将数据a交给线程B；线程A通过Exchanger和线程B交换数据，线程A把数据a交给线程B，同时线程B把数据b交给线程A。可见，SynchronousQueue是交给一个数据，Exchanger是交换两个数据。</p>
<ul>
<li><strong>不同JDK实现有何差别？</strong>
<ul>
<li>在JDK5中Exchanger被设计成一个容量为1的容器，存放一个等待线程，直到有另外线程到来就会发生数据交换，然后清空容器，等到下一个到来的线程。</li>
<li>从JDK6开始，Exchanger用了类似ConcurrentMap的分段思想，提供了多个slot，增加了并发执行时的吞吐量。</li>
</ul>
</li>
</ul>
<h2 id=应用示例>应用示例</h2>
<p>来一个非常经典的并发问题：你有相同的数据buffer，一个或多个数据生产者，和一个或多个数据消费者。只是Exchange类只能同步2个线程，所以你只能在你的生产者和消费者问题中只有一个生产者和一个消费者时使用这个类。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Test</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Producer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Exchanger</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Producer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Exchanger</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Producer-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exchanger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>5</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#4e9a06>&#34; 交换前:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exchange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#4e9a06>&#34; 交换后:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Consumer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Thread</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Exchanger</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Exchanger</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Consumer-&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exchanger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#4e9a06>&#34; 交换前:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
                    <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exchange</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()+</span><span style=color:#4e9a06>&#34; 交换后:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>InterruptedException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Exchanger</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exchanger</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exchanger</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Producer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Consumer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>exchanger</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>7</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exit</span><span style=color:#ce5c00;font-weight:700>(-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7104a341429a4837715bda5d8e0fc2ae>3.29 - CH29-ThreadLocal</h1>
<h2 id=概览>概览</h2>
<p>ThreadLocal是通过线程隔离的方式防止任务在共享资源上产生冲突, 线程本地存储是一种自动化机制，可以为使用相同变量的每个不同线程都创建不同的存储。</p>
<p>线程安全的解决思路：</p>
<ul>
<li>互斥同步: synchronized 和 ReentrantLock</li>
<li>非阻塞同步: CAS, AtomicXXXX</li>
<li>无同步方案: 栈封闭，本地存储(Thread Local)，可重入代码</li>
</ul>
<blockquote>
<p>线程安全：是指广义上的共享资源访问安全性，因为线程隔离是通过副本保证本线程访问资源安全性，它不保证线程之间还存在共享关系的狭义上的安全性。</p>
</blockquote>
<p>ThreadLocal 的官方解释：</p>
<blockquote>
<p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its {@code get} or {@code set} method) has its own, independently initialized copy of the variable. {@code ThreadLocal} instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID)</p>
<p>该类提供了线程局部 (thread-local) 变量。这些变量不同于它们的普通对应物，因为访问某个变量(通过其 get 或 set 方法)的每个线程都有自己的局部变量，它独立于变量的初始化副本。ThreadLocal 实例通常是类中的 private static 字段，它们希望将状态与某一个线程(例如，用户 ID 或事务 ID)相关联。</p>
</blockquote>
<p>ThreadLocal是一个将在多线程中为每一个线程创建单独的变量副本的类; 当使用ThreadLocal来维护变量时, ThreadLocal会为每个线程创建单独的变量副本, 避免因多线程操作共享变量而导致的数据不一致的情况。</p>
<h2 id=理解>理解</h2>
<ul>
<li>如下数据库管理类在单线程使用是没有任何问题的</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConnectionManager</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Connection</span> <span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Connection</span> <span style=color:#000>openConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>很显然，在多线程中使用会存在线程安全问题：第一，这里面的2个方法都没有进行同步，很可能在openConnection方法中会多次创建connect；第二，由于connect是共享变量，那么必然在调用connect的地方需要使用到同步来保障线程安全，因为很可能一个线程在使用connect进行数据库操作，而另外一个线程调用closeConnection关闭链接。</p>
<ul>
<li>为了解决上述线程安全的问题，第一考虑：互斥同步</li>
</ul>
<p>你可能会说，将这段代码的两个方法进行同步处理，并且在调用connect的地方需要进行同步处理，比如用Synchronized或者ReentrantLock互斥锁。</p>
<ul>
<li>这里再抛出一个问题：这地方到底需不需要将connect变量进行共享?</li>
</ul>
<p>事实上，是不需要的。假如每个线程中都有一个connect变量，各个线程之间对connect变量的访问实际上是没有依赖关系的，即一个线程不需要关心其他线程是否对这个connect进行了修改的。即改后的代码可以这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConnectionManager</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Connection</span> <span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>openConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>closeConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connect</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dao</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>insert</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ConnectionManager</span> <span style=color:#000>connectionManager</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConnectionManager</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>connectionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openConnection</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>// 使用connection进行操作
</span><span style=color:#8f5902;font-style:italic></span>
        <span style=color:#000>connectionManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>closeConnection</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样处理确实也没有任何问题，由于每次都是在方法内部创建的连接，那么线程之间自然不存在线程安全问题。但是这样会有一个致命的影响：导致服务器压力非常大，并且严重影响程序执行性能。由于在方法中需要频繁地开启和关闭数据库连接，这样不仅严重影响程序执行效率，还可能导致服务器压力巨大。</p>
<ul>
<li>这时候ThreadLocal登场了</li>
</ul>
<p>那么这种情况下使用ThreadLocal是再适合不过的了，因为ThreadLocal在每个线程中对该变量会创建一个副本，即每个线程内部都会有一个该变量，且在线程内部任何地方都可以使用，线程之间互不影响，这样一来就不存在线程安全问题，也不会严重影响程序执行性能。下面就是网上出现最多的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.sql.Connection</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.sql.DriverManager</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.sql.SQLException</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ConnectionManager</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Connection</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dbConnectionLocal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Connection</span><span style=color:#ce5c00;font-weight:700>&gt;()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#5c35cc;font-weight:700>@Override</span>
        <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Connection</span> <span style=color:#000>initialValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>};</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>dbConnectionLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>再注意下ThreadLocal的修饰符</li>
</ul>
<p>ThreaLocal的JDK文档中说明：ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread。如果我们希望通过某个类将状态(例如用户ID、事务ID)与线程关联起来，那么通常在这个类中定义private static类型的ThreadLocal 实例。</p>
<blockquote>
<p>但是要注意，虽然ThreadLocal能够解决上面说的问题，但是由于在每个线程中都创建了副本，所以要考虑它对资源的消耗，比如内存的占用会比不使用ThreadLocal要大。</p>
</blockquote>
<h2 id=原理>原理</h2>
<h3 id=如何实现线程隔离>如何实现线程隔离</h3>
<p>主要是用到了 Thread 对象中的一个 ThreadLocalMap 类型的变量 threadLocals，负责存储当前线程的关于 Connection 的对象，dbConnectionLocal 变量为 key，以新建的 Connection 对象为 value；这样的话，线程第一次读取的时候如果不存在就会调用 ThreadLocal 的 initialValue 方法创建一个 Connection 对象并返回。</p>
<p>具体关于为线程分配变量副本的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>ThreadLocalMap</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ThreadLocalMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Entry</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>T</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>setInitialValue</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>首先获取当前线程对象 t，然后从线程 t 中获取到 ThreadLocalMap 的成员属性 threadLocals</li>
<li>如果当前线程的 threadLocals 已经初始化并且存在以当前 ThreadLocal 对象为 Key 的值，则直接返回当前线程要获取的对象，比如上例中的 Connection。</li>
<li>如果当前线程的 threadLocals 已经初始化但不存在以当前 ThreadLocal 对象为 key 的对象，那么新建一个 Connection 对象，并且添加到当前线程的 threadLocals map 中，并返回。</li>
<li>如果当前线程的 threadLocals 属性尚未初始化，则重新创建一个 ThreadLocalMap 对象，并且创建一个 Connection 对象并添加到 ThreadLocalMap 中并返回。</li>
</ul>
<p>初始化逻辑：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>setInitialValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>T</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>initialValue</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>ThreadLocalMap</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#000>createMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>首先调用我们提供的 initialValue 方法，创建一个 Conneciton 对象</li>
<li>继续查看当前线程的 threadLocals 是否为空，如果 ThreadLocalMap 已经初始化，直接将产生的connection 对象添加到 ThreadLocalMap 中，如果没有初始化，则创建并添加到其中。</li>
</ul>
<p>同时，ThreadLocal 还提供了直接操作 Thread 对象中 threadLocals 的方法</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>ThreadLocalMap</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#000>createMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样我们也可以不实现initialValue, 将初始化工作放到DBConnectionFactory的getConnection方法中:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Connection</span> <span style=color:#000>getConnection</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Connection</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dbConnectionLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>DriverManager</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>dbConnectionLocal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SQLException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>connection</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>那么我们看过代码之后就很清晰的知道了为什么ThreadLocal能够实现变量的多线程隔离了; 其实就是用了Map的数据结构给当前线程缓存了, 要使用的时候就从本线程的threadLocals对象中获取就可以了, key就是当前线程;</p>
<p>当然了在当前线程下获取当前线程里面的Map里面的对象并操作肯定没有线程并发问题了, 当然能做到变量的线程间隔离了;</p>
<p>现在我们知道了ThreadLocal到底是什么了, 又知道了如何使用ThreadLocal以及其基本实现原理了是不是就可以结束了呢? 其实还有一个问题就是ThreadLocalMap是个什么对象, 为什么要用这个对象呢?</p>
<h3 id=threadlocalmap>ThreadLocalMap</h3>
<p>本质上来讲, 它就是一个Map, 但是这个ThreadLocalMap与我们平时见到的Map有点不一样：</p>
<ul>
<li>它没有实现Map接口;</li>
<li>它没有public的方法, 最多有一个default的构造方法, 因为这个ThreadLocalMap的方法仅仅在ThreadLocal类中调用, 属于静态内部类</li>
<li>ThreadLocalMap的Entry实现继承了WeakReference&lt;ThreadLocal&lt;?&#187;</li>
<li>该方法仅仅用了一个Entry数组来存储Key, Value; Entry并不是链表形式, 而是每个bucket里面仅仅放一个Entry;</li>
</ul>
<p>要了解ThreadLocalMap的实现, 我们先从入口开始, 就是往该Map中添加一个值:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>set</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>// We don&#39;t use a fast path as with get() because it is at
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// least as common to use set() to create new entries as
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// it is to replace existing ones, in which case, a fast
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// path would fail more often than not.
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadLocalHashCode</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
         <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)])</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>replaceStaleEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>cleanSomeSlots</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sz</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>sz</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>threshold</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>rehash</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>先进行简单的分析, 对该代码表层意思进行解读:</p>
<ul>
<li>看下当前threadLocal的在数组中的索引位置 比如: <code>i = 2</code>, 看 <code>i = 2</code> 位置上面的元素(Entry)的<code>Key</code>是否等于threadLocal 这个 Key, 如果等于就很好说了, 直接将该位置上面的Entry的Value替换成最新的就可以了;</li>
<li>如果当前位置上面的 Entry 的 Key为空, 说明ThreadLocal对象已经被回收了, 那么就调用replaceStaleEntry</li>
<li>如果清理完无用条目(ThreadLocal被回收的条目)、并且数组中的数据大小 > 阈值的时候对当前的Table进行重新哈希 所以, 该HashMap是处理冲突检测的机制是向后移位, 清除过期条目 最终找到合适的位置;</li>
</ul>
<p>后面就是Get方法了:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Entry</span> <span style=color:#000>getEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadLocalHashCode</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>Entry</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getEntryAfterMiss</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>先找到ThreadLocal的索引位置, 如果索引位置处的entry不为空并且键与threadLocal是同一个对象, 则直接返回; 否则去后面的索引位置继续查找。</p>
<h3 id=内存泄露>内存泄露</h3>
<p>如果用线程池来操作ThreadLocal 对象确实会造成内存泄露, 因为对于线程池里面不会销毁的线程, 里面总会存在着<code>&lt;ThreadLocal, LocalVariable></code>的强引用, 因为final static 修饰的 ThreadLocal 并不会释放, 而ThreadLocalMap 对于 Key 虽然是弱引用, 但是强引用不会释放, 弱引用当然也会一直有值, 同时创建的LocalVariable对象也不会释放, 就造成了内存泄露; 如果LocalVariable对象不是一个大对象的话, 其实泄露的并不严重, <code>泄露的内存 = 核心线程数 * LocalVariable</code>对象的大小;</p>
<p>所以, 为了避免出现内存泄露的情况, ThreadLocal提供了一个清除线程中对象的方法, 即 remove, 其实内部实现就是调用 ThreadLocalMap 的remove方法:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ThreadLocal</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Entry</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>tab</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>table</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>threadLocalHashCode</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Entry</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>];</span>
         <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
         <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tab</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nextIndex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)])</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>expungeStaleEntry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://my.oschina.net/javaroad/blog/4702711>FastThreadLocal</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d4935211dbea06024564929059669c15>3.30 - CH30-AllLocks</h1>
<h2 id=概览>概览</h2>
<table>
<thead>
<tr>
<th>序号</th>
<th>术语</th>
<th>应用</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>乐观锁</td>
<td>CAS</td>
</tr>
<tr>
<td>2</td>
<td>悲观锁</td>
<td>synchronized、vector、hashtable</td>
</tr>
<tr>
<td>3</td>
<td>自旋锁</td>
<td>CAS</td>
</tr>
<tr>
<td>4</td>
<td>可重入锁</td>
<td>synchronized、ReentrantLock、Lock</td>
</tr>
<tr>
<td>5</td>
<td>读写锁</td>
<td>ReentrantReadWriteLock、CopyOnWriteLock、CopyOnWriteArraySet</td>
</tr>
<tr>
<td>6</td>
<td>公平锁</td>
<td>ReentrantLock(true)</td>
</tr>
<tr>
<td>7</td>
<td>非公平锁</td>
<td>synchronized、ReentrantLock(false)</td>
</tr>
<tr>
<td>8</td>
<td>共享锁</td>
<td>ReentranReadWriteLock-ReadLock</td>
</tr>
<tr>
<td>9</td>
<td>独占锁</td>
<td>synchronized、vector、hashtable、ReentranReadWriteLock-WriteLock</td>
</tr>
<tr>
<td>10</td>
<td>重量级锁</td>
<td>synchronized</td>
</tr>
<tr>
<td>11</td>
<td>轻量级锁</td>
<td>锁优化技术</td>
</tr>
<tr>
<td>12</td>
<td>偏向锁</td>
<td>锁优化技术</td>
</tr>
<tr>
<td>13</td>
<td>分段锁</td>
<td>ConcurrentHashMap</td>
</tr>
<tr>
<td>14</td>
<td>互斥锁</td>
<td>synchronized</td>
</tr>
<tr>
<td>15</td>
<td>同步锁</td>
<td>synchronized</td>
</tr>
<tr>
<td>16</td>
<td>死锁</td>
<td>相互请求对方资源</td>
</tr>
<tr>
<td>17</td>
<td>锁粗化</td>
<td>锁优化技术</td>
</tr>
<tr>
<td>18</td>
<td>锁消除</td>
<td>锁优化技术</td>
</tr>
</tbody>
</table>
<h2 id=1-乐观锁>1. 乐观锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429204833.png style=display:block;width:50% alt=NAME align=center> </div>
<p>即乐观思想，假定当前场景是读多写少、遇到并发写的概览较低，读数据时认为别的线程不会正在修改数据(因此不加锁)；写数据时，判断当前与期望值是否相同，如果相同则更新(更新期间加锁，保证原子性)。</p>
<p>Java 中乐观锁的实现是 CAS——比较并交换。比较(主内存中的)当前值，与(当前线程中的)预期值是否一样，一样则更新，否则继续进行 CAS 操作。</p>
<p>可以同时进行读操作，读的时候其他线程不能执行写操作。</p>
<h2 id=2-悲观锁>2. 悲观锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429205158.png style=display:block;width:50% alt=NAME align=center> </div>
<p>即悲观思想，认为写多读少，遇到并发写的可能性高。每次读数据都认为其他线程会在同一时间修改数据，所以每次写数据都会认为其他线程会修改，因此每次都加锁。其他线程想要读写这个数据时都会被该锁阻塞，直到当前写数据的线程是否锁。</p>
<p>Java 中的悲观锁实现有 synchronized 关键字、ReentrantLock。</p>
<p>只有一个线程能够进行读操作或写操作。</p>
<h2 id=3-自旋锁>3. 自旋锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429205437.png style=display:block;width:50% alt=NAME align=center> </div>
<p>自旋指的是一种行为：为了让线程等待，我们只需让该线程循环。</p>
<p>现在绝大多数的个人电脑和服务器都是多路（核）处理器系统，如果物理机器有一个以上的处理器或者处理器核心，能让两个或以上的线程同时并行执行，就可以让后面请求锁的那个线程“稍等一会”，但不放弃处理器的执行时间，看看持有锁的线程是否很快就会释放锁。</p>
<p>优点：避免了线程切换的开销。挂起线程和恢复线程的操作都需要转入内核态中完成，这些操作给Java虚拟机的并发性能带来了很大的压力。</p>
<p>缺点：占用处理器的时间，如果占用的时间很长，会白白消耗处理器资源，而不会做任何有价值的工作，带来性能的浪费。因此自旋等待的时间必须有一定的限度，如果自旋超过了限定的次数仍然没有成功获得锁，就应当使用传统的方式去挂起线程。</p>
<p>Java 中默认的自旋次数为 10，可以通过参数 <code>-XX:PreBlockSpin</code> 来修改。</p>
<p>自适应自旋：自适应意味着自旋的时间不再是固定的，而是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定的。有了自适应自旋，随着程序运行时间的增长及性能监控信息的不断完善，虚拟机对程序锁的状态预测就会越来越精准。</p>
<p>Java 中对自旋的应用：CAS 操作中比较操作失败后会执行自旋等待。</p>
<h2 id=4-可重入锁递归锁>4. 可重入锁(递归锁)</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429205752.png style=display:block;width:50% alt=NAME align=center> </div>
<p>可重入指的是：某个线程在获取到锁之后能够再次获取该锁，而不会阻塞。</p>
<p>原理：通过组合自定义同步器来实现锁的获取与释放。</p>
<ul>
<li>再次获取锁：识别获取锁的线程是否为当前持有锁的线程，如果是则再次获取成功，并将技术 +1。</li>
<li>释放锁：释放锁并将计数 -1。</li>
</ul>
<p>作用：避免死锁。</p>
<p>Java 中的实现有：ReentrantLock、synchronized 关键字。</p>
<h2 id=5-读写锁>5. 读写锁</h2>
<p>读写锁指定是指：为了提高性能，在读的时候使用读锁，写的时候使用写锁，灵活控制。在没有写的时候，读是无阻塞的，在一定程度上提高了程序的执行效率。</p>
<p>读写锁分为读锁和写锁，多个读锁不互斥，读锁与写锁互斥。</p>
<p>读锁：允许多个线程同时访问资源。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210319.png style=display:block;width:50% alt=NAME align=center> </div>
<p>写锁：同时只允许一个线程访问资源。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210345.png style=display:block;width:50% alt=NAME align=center> </div>
<p>Java 中的实现为 ReentrantReadWriteLock。</p>
<h2 id=6-公平锁>6. 公平锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210418.png style=display:block;width:50% alt=NAME align=center> </div>
<p>公平锁的思想是：多个线程按照请求所的顺序来依次获取锁。</p>
<p>在并发环境中，每个线程会先查看此锁维护的等待队列，如果当前等待队列为空，则占有锁，如果等待队列不为空，则加入到等待队列的末尾，按照FIFO的原则从队列中拿到线程，然后占有锁。</p>
<h2 id=7-非公平锁>7. 非公平锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210515.png style=display:block;width:50% alt=NAME align=center> </div>
<p>非公平锁的思想是：线程尝试获取锁，如果获取不到，则再采用公平锁的方式。多个线程获取锁的顺序，不是按照先到先得的顺序，有可能后申请锁的线程比先申请的线程优先获取锁。</p>
<p>非公平锁的性能高于公平锁，但可能导致某个线程总是获取不到锁，即饥饿。</p>
<p>Java 中的实现：synchronized 是非公平锁，ReentrantLock 通过构造函数指定该锁是公平的还是非公平的，默认是非公平的。</p>
<h2 id=8-共享锁>8. 共享锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210709.png style=display:block;width:50% alt=NAME align=center> </div>
<p>共享锁的思想是：可以有多个线程获取读锁，以共享的方式持有锁。和乐观锁、读写锁同义。</p>
<p><strong>Java中用到的共享锁：</strong> <code>ReentrantReadWriteLock</code>。</p>
<h2 id=9-独占锁>9. 独占锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210751.png style=display:block;width:50% alt=NAME align=center> </div>
<p>独占锁的思想是：只能有一个线程获取锁，以独占的方式持有锁。和悲观锁、互斥锁同义。</p>
<p><strong>Java中用到的独占锁：</strong> synchronized，ReentrantLock</p>
<h2 id=10-重量级锁>10. 重量级锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210822.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>重量级锁是一种称谓：</strong> <code>synchronized</code>是通过对象内部的一个叫做监视器锁（<code>monitor</code>）来实现的，监视器锁本身依赖底层的操作系统的 <code>Mutex Lock</code>来实现。操作系统实现线程的切换需要从用户态切换到核心态，成本非常高。这种依赖于操作系统 <code>Mutex Lock</code>来实现的锁称为重量级锁。为了优化<code>synchonized</code>，引入了<code>轻量级锁</code>，<code>偏向锁</code>。</p>
<p><strong>Java中的重量级锁：</strong> synchronized</p>
<h2 id=11-轻量级锁>11. 轻量级锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210904.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>是JDK6时加入的一种锁优化机制：</strong> 轻量级锁是在无竞争的情况下使用CAS操作去消除同步使用的互斥量。轻量级是相对于使用操作系统互斥量来实现的重量级锁而言的。轻量级锁在没有多线程竞争的前提下，减少传统的重量级锁使用操作系统互斥量产生的性能消耗。如果出现两条以上的线程争用同一个锁的情况，那轻量级锁将不会有效，必须膨胀为重量级锁。</p>
<p><strong>优点：</strong> 如果没有竞争，通过CAS操作成功避免了使用互斥量的开销。</p>
<p><strong>缺点：</strong> 如果存在竞争，除了互斥量本身的开销外，还额外产生了CAS操作的开销，因此在有竞争的情况下，轻量级锁比传统的重量级锁更慢。</p>
<h2 id=12-偏向锁>12. 偏向锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429210945.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>是JDK6时加入的一种锁优化机制：</strong> 在无竞争的情况下把整个同步都消除掉，连CAS操作都不去做了。偏是指偏心，它的意思是这个锁会偏向于第一个获得它的线程，如果在接下来的执行过程中，该锁一直没有被其他的线程获取，则持有偏向锁的线程将永远不需要再进行同步。持有偏向锁的线程以后每次进入这个锁相关的同步块时，虚拟机都可以不再进行任何同步操作（例如加锁、解锁及对Mark Word的更新操作等）。</p>
<p><strong>优点：</strong> 把整个同步都消除掉，连CAS操作都不去做了，优于轻量级锁。</p>
<p><strong>缺点：</strong> 如果程序中大多数的锁都总是被多个不同的线程访问，那偏向锁就是多余的。</p>
<h2 id=13-分段锁>13. 分段锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429211027.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>一种机制：</strong> 最好的例子来说明分段锁是ConcurrentHashMap。**ConcurrentHashMap原理：**它内部细分了若干个小的 HashMap，称之为段(Segment)。默认情况下一个 ConcurrentHashMap 被进一步细分为 16 个段，既就是锁的并发度。如果需要在 ConcurrentHashMap 添加一项key-value，并不是将整个 HashMap 加锁，而是首先根据 hashcode 得到该key-value应该存放在哪个段中，然后对该段加锁，并完成 put 操作。在多线程环境中，如果多个线程同时进行put操作，只要被加入的key-value不存放在同一个段中，则线程间可以做到真正的并行。</p>
<p>**线程安全：**ConcurrentHashMap 是一个 Segment 数组， Segment 通过继承ReentrantLock 来进行加锁，所以每次需要加锁的操作锁住的是一个 segment，这样只要保证每个 Segment 是线程安全的，也就实现了全局的线程安全</p>
<h2 id=14-互斥锁>14. 互斥锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429211130.png style=display:block;width:50% alt=NAME align=center> </div>
<p>互斥锁与悲观锁、独占锁同义，表示某个资源只能被一个线程访问，其他线程不能访问。</p>
<ul>
<li>读-读互斥</li>
<li>读-写互斥</li>
<li>写-读互斥</li>
<li>写-写互斥</li>
</ul>
<p><strong>Java中的同步锁：</strong> synchronized</p>
<h2 id=15-同步锁>15. 同步锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429211204.png style=display:block;width:50% alt=NAME align=center> </div>
<p>同步锁与互斥锁同义，表示并发执行的多个线程，在同一时间内只允许一个线程访问共享数据。</p>
<p><strong>Java中的同步锁：</strong> synchronized</p>
<h2 id=16-死锁>16. 死锁</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429211225.png style=display:block;width:50% alt=NAME align=center> </div>
<p>**死锁是一种现象：**如线程A持有资源x，线程B持有资源y，线程A等待线程B释放资源y，线程B等待线程A释放资源x，两个线程都不释放自己持有的资源，则两个线程都获取不到对方的资源，就会造成死锁。</p>
<p>Java中的死锁不能自行打破，所以线程死锁后，线程不能进行响应。所以一定要注意程序的并发场景，避免造成死锁。</p>
<h2 id=17-锁粗化>17. 锁粗化</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429211257.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>一种优化技术：</strong> 如果一系列的连续操作都对同一个对象反复加锁和解锁，甚至加锁操作都是出现在循环体体之中，就算真的没有线程竞争，频繁地进行互斥同步操作将会导致不必要的性能损耗，所以就采取了一种方案：把加锁的范围扩展（粗化）到整个操作序列的外部，这样加锁解锁的频率就会大大降低，从而减少了性能损耗。</p>
<h2 id=18-锁消除>18. 锁消除</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210429211343.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>一种优化技术：</strong> 就是把锁干掉。当Java虚拟机运行时发现有些共享数据不会被线程竞争时就可以进行锁消除。</p>
<p>那如何判断共享数据不会被线程竞争？</p>
<p>利用<code>逃逸分析技术</code>：分析对象的作用域，如果对象在A方法中定义后，被作为参数传递到B方法中，则称为方法逃逸；如果被其他线程访问，则称为线程逃逸。</p>
<p>在堆上的某个数据不会逃逸出去被其他线程访问到，就可以把它当作栈上数据对待，认为它是线程私有的，同步加锁就不需要了。</p>
<h2 id=todo>TODO</h2>
<ul>
<li><a href=https://tech.meituan.com/2018/11/15/java-lock.html>https://tech.meituan.com/2018/11/15/java-lock.html</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6f75fdfc530ef3161ca338cc2e0bacf9>3.31 - CH31-AllQueues</h1>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>有界</th>
<th>线程安全</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Queue<e></td>
<td>接口</td>
<td>—</td>
<td>—</td>
<td>顶层队列接口</td>
</tr>
<tr>
<td>BlockingQueue<e></td>
<td>接口</td>
<td>—</td>
<td>—</td>
<td>阻塞队列接口</td>
</tr>
<tr>
<td>BlockingDeuque<e></td>
<td>接口</td>
<td>—</td>
<td>—</td>
<td>双向阻塞队列接口</td>
</tr>
<tr>
<td>Dequeu<e></td>
<td>接口</td>
<td>—</td>
<td>—</td>
<td>双向队列接口</td>
</tr>
<tr>
<td>TransferQueue<e></td>
<td>接口</td>
<td>—</td>
<td>—</td>
<td>传输队列接口</td>
</tr>
<tr>
<td>AbstractQueue</td>
<td>抽象类</td>
<td>—</td>
<td>—</td>
<td>队列抽象类</td>
</tr>
<tr>
<td>PriorityQueue</td>
<td>实现类</td>
<td>N</td>
<td>N</td>
<td>优先级队列</td>
</tr>
<tr>
<td>ArrayDeque</td>
<td>实现类</td>
<td>N</td>
<td>N</td>
<td>数组双向队列</td>
</tr>
<tr>
<td>LinkedList</td>
<td>实现类</td>
<td>N</td>
<td>N</td>
<td>链表对象类</td>
</tr>
<tr>
<td>ConcurrentLinkedQueue</td>
<td>实现类</td>
<td>N</td>
<td>Y</td>
<td>链表结构并发队列</td>
</tr>
<tr>
<td>ConcurrentLinkedDeque</td>
<td>实现类</td>
<td>N</td>
<td>Y</td>
<td>链表结构双向并发队列</td>
</tr>
<tr>
<td>ArrayBlockingQueue</td>
<td>实现类</td>
<td>Y</td>
<td>Y</td>
<td>数组结构有界阻塞队列</td>
</tr>
<tr>
<td>LinkedBlockingQueue</td>
<td>实现类</td>
<td>Y</td>
<td>Y</td>
<td>链表结构有界阻塞队列</td>
</tr>
<tr>
<td>LinkedBlockingDeque</td>
<td>实现类</td>
<td>Y</td>
<td>Y</td>
<td>链表结构双向有界阻塞队列</td>
</tr>
<tr>
<td>LinkedTransferQueue</td>
<td>实现类</td>
<td>N</td>
<td>Y</td>
<td>连接结构无界阻塞传输队列</td>
</tr>
<tr>
<td>SynchronousQueue</td>
<td>实现类</td>
<td>Y</td>
<td>Y</td>
<td>不存储元素的有界阻塞队列</td>
</tr>
<tr>
<td>PriorityBlockingQueue</td>
<td>实现类</td>
<td>N</td>
<td>Y</td>
<td>支持优先级排序的无界阻塞队列</td>
</tr>
<tr>
<td>DelayQueue</td>
<td>实现类</td>
<td>N</td>
<td>Y</td>
<td>延时无界阻塞队列</td>
</tr>
</tbody>
</table>
<h2 id=层级结构>层级结构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430134832.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=1-queue>1. Queue</h2>
<ul>
<li>Queue接口是一种Collection，被设计用于处理之前临时保存在某处的元素。</li>
<li>除了基本的Collection操作之外，队列还提供了额外的插入、提取和检查操作。每一种操作都有两种形式：如果操作失败，则抛出一个异常；如果操作失败，则返回一个特殊值（null或false，取决于是什么操作）。</li>
<li>队列通常是以FIFO（先进先出）的方式排序元素，但是这不是必须的。</li>
<li>只有优先级队列可以根据提供的比较器对元素进行排序或者是采用正常的排序。无论怎么排序，队列的头将通过调用remove()或poll()方法进行移除。在FIFO队列种，所有新的元素被插入到队尾。其他种类的队列可能使用不同的布局来存放元素。</li>
<li>每个Queue必须指定排序属性。</li>
</ul>
<h2 id=2-deque>2. Deque</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430135110.png style=display:block;width:50% alt=NAME align=center> </div>
<p>支持两端元素插入和移除的线性集合。名称<code>deque</code>是双端队列的缩写(Double-Ended queue)，通常发音为<code>deck</code>。大多数实现Deque的类，对它们包含的元素的数量没有固定的限制的，支持有界和无界。</p>
<ul>
<li>该列表包含包含访问deque两端元素的方法，提供了插入，移除和检查元素的方法。</li>
<li>这些方法种的每一种都存在两种形式：如果操作失败，则会抛出异常，另一种方法返回一个特殊值（null或false，取决于具体操作）。</li>
<li>插入操作的后一种形式专门设计用于容量限制的Deque实现，大多数实现中，插入操作不能失败，所以可以用插入操作的后一种形式。</li>
<li>Deque接口扩展了Queue接口，当使用deque作为队列时，作为FIFO。元素将添加到deque的末尾，并从头开始删除。</li>
<li>Deque也可以用作LIFO（后进先出）栈，这个接口优于传统的Stack类。当作为栈使用时，元素被push到deque队列的头，而pop也是从队列的头pop出来。</li>
</ul>
<h2 id=3-abstractqueue>3. AbstractQueue</h2>
<p>AbstractQueue是一个抽象类，继承了Queue接口，提供了一些Queue操作的骨架实现。</p>
<p>方法add、remove、element方法基于offer、poll和peek。也就是说如果不能正常操作，则抛出异常。我们来看下AbstactQueue是怎么做到的。</p>
<ul>
<li>AbstractQueue的add方法</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Queue full&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>AbstractQueue的remove方法</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>remove</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>E</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>poll</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchElementException</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ul>
<li>AbstractQueue的element方法</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>E</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>peek</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>else</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchElementException</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果继承AbstractQueue抽象类则必须保证offer方法不允许null值插入。</p>
<h2 id=4-blockingqueue>4. BlockingQueue</h2>
<ul>
<li>BlockQueue满了，PUT操作被阻塞</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430135520.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>BlockQueue为空，Take操作被阻塞</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430135535.png style=display:block;width:50% alt=NAME align=center> </div>
<p>说明：</p>
<ul>
<li>BlockingQueue（阻塞队列）也是一种队列，支持阻塞的插入和移除方法。</li>
<li>阻塞的插入：当队列满时，队列会阻塞插入元素的线程，直到队列不满。</li>
<li>阻塞的移除：当队列为空，获取元素的线程会等待队列变为非空。</li>
<li>应用场景：生产者和消费者，生产者线程向队列里添加元素，消费者线程从队列里移除元素，阻塞队列时获取和存放元素的容器。</li>
<li>为什么要用阻塞队列：生产者生产和消费者消费的速率不一样，需要用队列来解决速率差问题，当队列满了或空的时候，则需要阻塞生产或消费动作来解决队列满或空的问题。</li>
</ul>
<p>方法总结：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430135640.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=如何实现的阻塞>如何实现的阻塞</h3>
<ul>
<li>当往队列里插入一个元素时，如果队列不可用，那么阻塞生产者主要通过LockSupport. park（this）来实现。</li>
<li>park这个方法会阻塞当前线程，只有以下4种情况中的一种发生时，该方法才会返回。
<ul>
<li>与park对应的unpark执行或已经执行时。“已经执行”是指unpark先执行，然后再执行park的情况。</li>
<li>线程被中断时。</li>
<li>等待完time参数指定的毫秒数时。</li>
<li>异常现象发生时，这个异常现象没有任何原因。</li>
</ul>
</li>
</ul>
<h2 id=5-blockingdeque>5. BlockingDeque</h2>
<ul>
<li>BlockingDeque 满了，两端的 put 操作被阻塞</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430135836.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>BlockingDeque 为空，两端的Take操作被阻塞</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430135912.png style=display:block;width:50% alt=NAME align=center> </div>
<p>它是阻塞队列<code>BlockingQueue</code>和双向队列<code>Deque</code>接口的结合。有如下方法：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430135939.png style=display:block;width:50% alt=NAME align=center> </div>
<p>BlockDeque和BlockQueue的对等方法：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430140007.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=6-transferqueue>6. TransferQueue</h2>
<p>如果有消费者正在获取元素，则将队列中的元素传递给消费者。如果没有消费者，则等待消费者消费。必须将任务完成才能返回。</p>
<h4 id=transfere-e>transfer(E e)</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430140158.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>生产者线程Producer Thread尝试将元素B传给消费者线程，如果没有消费者线程，则将元素B放到尾节点。并且生产者线程等待元素B被消费。当元素B被消费后，生产者线程返回。</li>
<li>如果当前有消费者正在等待接收元素（消费者通过take方法或超时限制的poll方法时），transfer方法可以把生产者传入的元素立刻transfer（传输）给消费者。</li>
<li>如果没有消费者等待接收元素，transfer方法会将元素放在队列的tail（尾）节点，并等到该元素被消费者消费了才返回。</li>
</ul>
<h4 id=trytransfere-e>tryTransfer(E e)</h4>
<ul>
<li>试探生产者传入的元素是否能直接传给消费者。</li>
<li>如果没有消费者等待接收元素，则返回false。</li>
<li>和transfer方法的区别是，无论消费者是否接收，方法立即返回。</li>
</ul>
<h4 id=trytransfere-e-long-timeout-timeunit-unit>tryTransfer(E e, long timeout, TimeUnit unit)</h4>
<ul>
<li>带有时间限制的tryTransfer方法。</li>
<li>试图把生产者传入的元素直接传给消费者。</li>
<li>如果没有消费者消费该元素则等待指定的时间再返回。</li>
<li>如果超时了还没有消费元素，则返回false。</li>
<li>如果在超时时间内消费了元素，则返回true。</li>
</ul>
<h4 id=getwaitingconsumercount>getWaitingConsumerCount()</h4>
<ul>
<li>获取通过BlockingQueue.take()方法或超时限制poll方法等待接受元素的消费者数量。近似值。</li>
<li>返回等待接收元素的消费者数量。</li>
</ul>
<h4 id=haswaitingconsumer>hasWaitingConsumer()</h4>
<ul>
<li>获取是否有通过BlockingQueue.tabke()方法或超时限制poll方法等待接受元素的消费者。</li>
<li>返回true则表示至少有一个等待消费者。</li>
</ul>
<h2 id=7-priorityqueue>7. PriorityQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430140515.png style=display:block;width:50% alt=NAME align=center> </div>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430140507.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>PriorityQueue是一个支持优先级的无界阻塞队列。</li>
<li><strong>默认自然顺序升序排序</strong>。</li>
<li>可以通过构造参数Comparator来对元素进行排序。</li>
<li>自定义实现comapreTo()方法来指定元素排序规则。</li>
<li>不允许插入null元素。</li>
<li>实现PriorityQueue接口的类，不保证线程安全，除非是PriorityBlockingQueue。</li>
<li>PriorityQueue的迭代器不能保证以任何特定顺序遍历元素，如果需要有序遍历，请考虑使用 <code>Arrays.sort(pq.toArray)</code>。</li>
<li>进列( <code>offer</code>、 <code>add</code>)和出列（ <code>poll</code>、 <code>remove()</code>）的时间复杂度O(log(n))。</li>
<li>remove(Object) 和 contains(Object)的算法时间复杂度O(n)。</li>
<li>peek、element、size的算法时间复杂度为O(1)。</li>
</ul>
<h2 id=8-linkedlist>8. LinkedList</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430140626.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>LinkedList实现了List和Deque接口，所以是一种双链表结构，可以当作堆栈、队列、双向队列使用。</li>
<li>一个双向列表的每一个元素都有三个整数值：元素、向后的节点链接、向前的节点链接</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>E</span> <span style=color:#000>item</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//元素
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//向后的节点链接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//向前的节点链接
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>E</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>item</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>prev</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=9-concurrentlinkedqueue>9. ConcurrentLinkedQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430140725.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>ConcurrentLinked是由链表结构组成的线程安全的先进先出无界队列。</li>
<li>当多线程要共享访问集合时，ConcurrentLinkedQueue是一个比较好的选择。</li>
<li>不允许插入null元素</li>
<li>支持非阻塞地访问并发安全的队列，不会抛出ConcurrentModifiationException异常。</li>
<li>size方法不是准确的，因为在统计集合的时候，队列可能正在添加元素，导致统计不准。</li>
<li>批量操作addAll、removeAll、retainAll、containsAll、equals和toArray不保证原子性（操作不可分割）</li>
<li>添加元素happen-before其他线程移除元素。</li>
</ul>
<h2 id=10-arraydeque>10. ArrayDeque</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430141318.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>由数组组成的双端队列。</li>
<li>没有容量限制，根据需要扩容。</li>
<li>不是线程安全的。</li>
<li>禁止插入null元素。</li>
<li>当用作栈时，比栈速度快，当用作队列时，速度比LinkList快。</li>
<li>大部分方法的算法时间复杂度为O(1)。</li>
<li>remove、removeFirstOccurrence、removeLastOccurrence、contains、remove 和批量操作的算法时间复杂度O(n)</li>
</ul>
<h2 id=11-concurrentlinkeddeque>11. ConcurrentLinkedDeque</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430141422.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>由链表结构组成的双向无界阻塞队列</li>
<li>插入、删除和访问操作可以并发进行，线程安全的类</li>
<li>不允许插入null元素</li>
<li>在并发场景下，计算队列的大小是不准确的，因为计算时，可能有元素加入队列。</li>
<li>批量操作addAll、removeAll、retainAll、containsAll、equals和toArray不保证原子性（操作不可分割）</li>
</ul>
<h2 id=12-arrayblockingqueue>12. ArrayBlockingQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430141457.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>ArrayBlockingQueue是一个用数组实现的有界阻塞队列。</li>
<li>队列满时插入操作被阻塞，队列空时，移除操作被阻塞。</li>
<li>按照先进先出（FIFO）原则对元素进行排序。</li>
<li>默认不保证线程公平的访问队列。</li>
<li>公平访问队列：按照阻塞的先后顺序访问队列，即先阻塞的线程先访问队列。</li>
<li>非公平性是对先等待的线程是非公平的，当队列可用时，阻塞的线程都可以争夺访问队列的资格。有可能先阻塞的线程最后才访问访问队列。</li>
<li>公平性会降低吞吐量。</li>
</ul>
<h2 id=13-linkedblockinqueue>13. LinkedBlockinQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430141557.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>LinkedBlockingQueue具有单链表和有界阻塞队列的功能。</li>
<li>队列满时插入操作被阻塞，队列空时，移除操作被阻塞。</li>
<li>默认和最大长度为Integer.MAX_VALUE，相当于无界(值非常大：2^31-1)。</li>
<li>吞吐量通常要高于ArrayBlockingQueue。</li>
<li>创建线程池时，参数runnableTaskQueue（任务队列），用于保存等待执行的任务的阻塞队列可以选择LinkedBlockingQueue。</li>
<li>静态工厂方法Executors.newFixedThreadPool()使用了这个队列。</li>
</ul>
<h2 id=14-linkedblockingdeque>14. LinkedBlockingDeque</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430141703.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>由链LinkedBlockingDeque = 阻塞队列+链表+双端访问</li>
<li>线程安全。</li>
<li>多线程同时入队时，因多了一端访问入口，所以减少了一半的竞争。</li>
<li>默认容量大小为Integer.MAX_VALUE。可指定容量大小。</li>
<li>可以用在“工作窃取“模式中。</li>
</ul>
<h2 id=15-linkedtransferqueue>15. LinkedTransferQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430141750.png style=display:block;width:50% alt=NAME align=center> </div>
<p>LinkedTransferQueue = 阻塞队列+链表结构+TransferQueue</p>
<p>之前我们讲TransferQueue接口时<strong>已经介绍过了TransferQueue接口</strong> ，所以LinkedTransferQueue接口跟它相似，只是加入了阻塞插入和移除的功能，以及结构是链表结构。</p>
<h2 id=16-synchronousqueue>16. SynchronousQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430141858.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>我称SynchronousQueue为”传球好手“。想象一下这个场景：小明抱着一个篮球想传给小花，如果小花没有将球拿走，则小明是不能再拿其他球的。</li>
<li>SynchronousQueue负责把生产者产生的数据传递给消费者线程。</li>
<li>SynchronousQueue本身不存储数据，调用了put方法后，队列里面也是空的。</li>
<li>每一个put操作必须等待一个take操作完成，否则不能添加元素。</li>
<li>适合传递性场景。</li>
<li>性能高于ArrayBlockingQueue和LinkedBlockingQueue。</li>
<li>吞吐量通常要高于LinkedBlockingQueue。</li>
<li>创建线程池时，参数runnableTaskQueue（任务队列），用于保存等待执行的任务的阻塞队列可以选择SynchronousQueue。</li>
<li>静态工厂方法Executors.newCachedThreadPool()使用了这个队列</li>
</ul>
<h2 id=17-priorityblockqueue>17. PriorityBlockQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430142029.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>PriorityBlockQueue = PriorityQueue + BlockingQueue</li>
<li>之前我们也讲到了PriorityQueue的原理，支持对元素排序。</li>
<li>元素默认自然升序排序。</li>
<li>可以自定义CompareTo()方法来指定元素排序规则。</li>
<li>可以通过构造函数构造参数Comparator来对元素进行排序。</li>
</ul>
<h2 id=18-delayqueue>18. DelayQueue</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430142532.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>DelayQueue = Delayed + BlockingQueue。队列中的元素必须实现Delayed接口。</li>
<li>在创建元素时，可以指定多久可以从队列中获取到当前元素。只有在延时期满才能从队列中获取到当前元素。</li>
</ul>
<p>场景：</p>
<ul>
<li>缓存系统的设计：可以用DelayQueue保存缓存元素的有效期。然后用一个线程循环的查询DelayQueue队列，一旦能从DelayQueue中获取元素时，表示缓存有效期到了。</li>
<li>定时任务调度：使用DelayQueue队列保存当天将会执行的任务和执行时间，一旦从DelayQueue中获取到任务就开始执行。比如Java中的TimerQueue就是使用DelayQueue实现的。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-61244711dda16339cd68d75d5b154f5f>3.32 - CH32-AllPools</h1>
<h2 id=七大属性>七大属性</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430143504.png style=display:block;width:90% alt=NAME align=center> </div>
<ul>
<li>corePoolSize(int)：核心线程数量。默认情况下，在创建了线程池后，线程池中的线程数为0，当有任务来之后，就会创建一个线程去执行任务，当线程池中的线程数目达到corePoolSize后，就会把到达的任务放到任务队列当中。线程池将长期保证这些线程处于存活状态，即使线程已经处于闲置状态。除非配置了allowCoreThreadTimeOut=true，核心线程数的线程也将不再保证长期存活于线程池内，在空闲时间超过keepAliveTime后被销毁。</li>
<li>workQueue：阻塞队列，存放等待执行的任务，线程从workQueue中取任务，若无任务将阻塞等待。当线程池中线程数量达到corePoolSize后，就会把新任务放到该队列当中。JDK提供了四个可直接使用的队列实现，分别是：基于数组的有界队列ArrayBlockingQueue、基于链表的无界队列LinkedBlockingQueue、只有一个元素的同步队列SynchronousQueue、优先级队列PriorityBlockingQueue。在实际使用时一定要设置队列长度。</li>
<li>maximumPoolSize(int)：线程池内的最大线程数量，线程池内维护的线程不得超过该数量，大于核心线程数量小于最大线程数量的线程将在空闲时间超过keepAliveTime后被销毁。当阻塞队列存满后，将会创建新线程执行任务，线程的数量不会大于maximumPoolSize。</li>
<li>keepAliveTime(long)：线程存活时间，若线程数超过了corePoolSize，线程闲置时间超过了存活时间，该线程将被销毁。除非配置了allowCoreThreadTimeOut=true，核心线程数的线程也将不再保证长期存活于线程池内，在空闲时间超过keepAliveTime后被销毁。</li>
<li>TimeUnit unit：线程存活时间的单位，例如TimeUnit.SECONDS表示秒。</li>
<li>RejectedExecutionHandler：拒绝策略，当任务队列存满并且线程池个数达到maximunPoolSize后采取的策略。ThreadPoolExecutor中提供了四种拒绝策略，分别是：抛RejectedExecutionException异常的AbortPolicy(如果不指定的默认策略)、使用调用者所在线程来运行任务CallerRunsPolicy、丢弃一个等待执行的任务，然后尝试执行当前任务DiscardOldestPolicy、不动声色的丢弃并且不抛异常DiscardPolicy。项目中如果为了更多的用户体验，可以自定义拒绝策略。</li>
<li>threadFactory：创建线程的工厂，虽说JDK提供了线程工厂的默认实现DefaultThreadFactory，但还是建议自定义实现最好，这样可以自定义线程创建的过程，例如线程分组、自定义线程名称等。</li>
</ul>
<h2 id=工作原理>工作原理</h2>
<ol>
<li>通过execute方法提交任务时，当线程池中的线程数小于corePoolSize时，新提交的任务将通过创建一个新线程来执行，即使此时线程池中存在空闲线程。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430143621.png style=display:block;width:50% alt=NAME align=center> </div>
<ol start=2>
<li>通过execute方法提交任务时，当线程池中线程数量达到corePoolSize时，新提交的任务将被放入workQueue中，等待线程池中线程调度执行。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/640-20210430143652230.png style=display:block;width:50% alt=NAME align=center> </div>
<ol start=3>
<li>通过execute方法提交任务时，当workQueue已存满，且maximumPoolSize大于corePoolSize时，新提交的任务将通过创建新线程执行。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430143749.png style=display:block;width:50% alt=NAME align=center> </div>
<ol start=4>
<li>当线程池中的线程执行完任务空闲时，会尝试从workQueue中取头结点任务执行。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430144336.png style=display:block;width:50% alt=NAME align=center> </div>
<ol start=5>
<li>通过execute方法提交任务，当线程池中线程数达到maxmumPoolSize，并且workQueue也存满时，新提交的任务由RejectedExecutionHandler执行拒绝操作。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430144351.png style=display:block;width:50% alt=NAME align=center> </div>
<ol start=6>
<li>当线程池中线程数超过corePoolSize，并且未配置allowCoreThreadTimeOut=true，空闲时间超过keepAliveTime的线程会被销毁，保持线程池中线程数为corePoolSize。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430144406.png style=display:block;width:50% alt=NAME align=center> </div>
<ol start=7>
<li>当设置allowCoreThreadTimeOut=true时，任何空闲时间超过keepAliveTime的线程都会被销毁。</li>
</ol>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430144137.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=状态切换>状态切换</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430144520.png style=display:block;width:50% alt=NAME align=center> </div>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210430144530.png style=display:block;width:50% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d258b6789f677fa5b5591143fd8b88fc>4 - Java I/0</h1>
</div>
<div class=td-content>
<h1 id=pg-4173475665554ac72b162bd9e768d99b>4.1 - CH01-IO分类</h1>
<h2 id=基于传输方式>基于传输方式</h2>
<p>从数据传输方式或者说是运输方式角度看，可以将 IO 类分为:</p>
<ul>
<li>字节流</li>
<li>字符流</li>
</ul>
<p><code>字节</code>是个计算机看的，<code>字符</code>才是给人看的。</p>
<h3 id=字节流>字节流</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213255.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=字符流>字符流</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213310.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=二者区别>二者区别</h3>
<ul>
<li>
<p>字节流读取单个字节，字符流读取单个字符(一个字符根据编码的不同，对应的字节也不同，如 UTF-8 编码是 3 个字节，中文编码是 2 个字节。)</p>
</li>
<li>
<p>字节流用来处理二进制文件(图片、MP3、视频文件)，字符流用来处理文本文件(可以看做是特殊的二进制文件，使用了某种编码，人可以阅读)。</p>
</li>
</ul>
<h3 id=字节---字符inputoutputstreamreaderwriter>字节 -> 字符：Input/OutputStreamReader/Writer</h3>
<ul>
<li>
<p>编码就是把字符转换为字节，而解码是把字节重新组合成字符。</p>
</li>
<li>
<p>如果编码和解码过程使用不同的编码方式那么就出现了乱码。</p>
<ul>
<li>GBK 编码中，中文字符占 2 个字节，英文字符占 1 个字节；</li>
<li>UTF-8 编码中，中文字符占 3 个字节，英文字符占 1 个字节；</li>
<li>UTF-16be 编码中，中文字符和英文字符都占 2 个字节。</li>
</ul>
</li>
<li>
<p>UTF-16be 中的 be 指的是 Big Endian，也就是大端。相应地也有 UTF-16le，le 指的是 Little Endian，也就是小端。</p>
</li>
</ul>
<p>Java 使用双字节编码 UTF-16be，这不是指 Java 只支持这一种编码方式，而是说 char 这种类型使用 UTF-16be 进行编码。char 类型占 16 位，也就是两个字节，Java 使用这种双字节编码是为了让一个中文或者一个英文都能使用一个 char 来存储。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213525.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=基于数据操作>基于数据操作</h2>
<p>从数据来源或操作对象角度看，IO 又可以按如下方式分类：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213615.png style=display:block;width:50% alt=NAME align=center> </div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-132757708b0e03054ccc15b1ccda9394>4.2 - CH02-装饰模式</h1>
<h2 id=装饰模式>装饰模式</h2>
<p>装饰者(Decorator)和具体组件(ConcreteComponent)都继承自组件(Component)，具体组件的方法实现不需要依赖于其它对象，而装饰者组合了一个组件，这样它可以装饰其它装饰者或者具体组件。</p>
<p>所谓装饰，就是把这个装饰者套在被装饰者之上，从而动态扩展被装饰者的功能。装饰者的方法有一部分是自己的，这属于它的功能，然后调用被装饰者的方法实现，从而也保留了被装饰者的功能。可以看到，具体组件应当是装饰层次的最低层，因为只有具体组件的方法实现不需要依赖于其它对象。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213844.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=io-装饰模式>IO 装饰模式</h2>
<p>以 InputStream 为例，</p>
<ul>
<li>InputStream 是抽象组件；</li>
<li>FileInputStream 是 InputStream 的子类，属于具体组件，提供了字节流的输入操作；</li>
<li>FilterInputStream 属于抽象装饰者，装饰者用于装饰组件，为组件提供额外的功能。例如 BufferedInputStream 为 FileInputStream 提供缓存的功能。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501213913.png style=display:block;width:50% alt=NAME align=center> </div>
<p>实例化一个具有缓存功能的字节流对象时，只需要在 FileInputStream 对象上再套一层 BufferedInputStream 对象即可。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>FileInputStream</span> <span style=color:#000>fileInputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filePath</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>BufferedInputStream</span> <span style=color:#000>bufferedInputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileInputStream</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>DataInputStream 装饰者提供了对更多数据类型进行输入的操作，比如 int、double 等基本类型。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-747966313cf609a9b480dcb72763161b>4.3 - CH03-InputStream</h1>
<h2 id=层级结构>层级结构</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501214031.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=inputstream-抽象类>InputStream 抽象类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 读取数据
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> 
<span style=color:#8f5902;font-style:italic>// 将读取到的数据放在 byte 数组中，该方法实际上是根据下面的方法实现的，off 为 0，len 为数组的长度
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic>// 从第 off 位置读取 len 长度字节的数据放到 byte 数组中，流是以 -1 来判断是否读取结束的
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic>// 跳过指定个数的字节不读取，想想看电影跳过片头片尾
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 返回可读的字节数量
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 读取完，关闭流，释放资源
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic>// 标记读取位置，下次还可以从这里开始读取，使用前要看当前流是否支持，可以使用 markSupport() 方法判断
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 重置读取位置为上次 mark 标记的位置
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#8f5902;font-style:italic>// 判断当前流是否支持标记流，和上面两个方法配套使用
</span></code></pre></div><h2 id=源码实现>源码实现</h2>
<h3 id=inputstream>InputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InputStream</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Closeable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>SKIP_BUFFER_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2048</span><span style=color:#ce5c00;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>//用于skip方法，和skipBuffer相关
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>skipBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>// skipBuffer is initialized in skip(long), if needed.
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//从输入流中读取下一个字节，
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//正常返回0-255，到达文件的末尾返回-1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//在流中还有数据，但是没有读到时该方法会阻塞(block)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//Java IO和New IO的区别就是阻塞流和非阻塞流
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//抽象方法！不同的子类不同的实现！
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>;</span>  
    
    <span style=color:#8f5902;font-style:italic>//将流中的数据读入放在byte数组的第off个位置先后的len个位置中
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//返回值为放入字节的个数。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//这个方法在利用抽象方法read，某种意义上简单的Templete模式。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查输入是否正常。一般情况下，检查输入是方法设计的第一步
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
             <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>        
        <span style=color:#8f5902;font-style:italic>//读取下一个字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//到达文件的末端返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>   <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//返回的字节downcast                           
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//已经读取了一个字节                                                   
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                        
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//最多读取len个字节，所以要循环len次
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>//每次循环从流中读取一个字节
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//由于read方法阻塞，
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//所以read(byte[],int,int)也会阻塞
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//到达末尾，理所当然返回-1                                       
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#ce5c00;font-weight:700>}</span> 
                <span style=color:#8f5902;font-style:italic>//读到就放入byte数组中
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>ee</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

     <span style=color:#8f5902;font-style:italic>//利用上面的方法read(byte[] b)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>                          
    <span style=color:#8f5902;font-style:italic>//方法内部使用的、表示要跳过的字节数目，
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>    
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nr</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>skipBuffer</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#8f5902;font-style:italic>//初始化一个跳转的缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>skipBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>SKIP_BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>];</span>                   
        <span style=color:#8f5902;font-style:italic>//本地化的跳转缓存
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>localSkipBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>skipBuffer</span><span style=color:#ce5c00;font-weight:700>;</span>          
        <span style=color:#8f5902;font-style:italic>//检查输入参数，应该放在方法的开始                            
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>                             
        <span style=color:#8f5902;font-style:italic>//一共要跳过n个，每次跳过部分，循环       
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                      
            <span style=color:#000>nr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>localSkipBuffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SKIP_BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>));</span>
            <span style=color:#8f5902;font-style:italic>//利用上面的read(byte[],int,int)方法尽量读取n个字节  
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//读到流的末端，则返回
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nr</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#8f5902;font-style:italic>//没有完全读到需要的，则继续循环
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>remaining</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>nr</span><span style=color:#ce5c00;font-weight:700>;</span>                                       
        <span style=color:#ce5c00;font-weight:700>}</span>       
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>remaining</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//返回时要么全部读完，要么因为到达文件末端，读取了部分
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//查询流中还有多少可以读取的字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//该方法不会block。在java中抽象类方法的实现一般有以下几种方式: 
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//1.抛出异常(java.util)；2.“弱”实现。像上面这种。子类在必要的时候覆盖它。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//3.“空”实现。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭当前流、同时释放与此流相关的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//关闭当前流、同时释放与此流相关的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{}</span>
    <span style=color:#8f5902;font-style:italic>//markSupport可以查询当前流是否支持mark
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{}</span>
    <span style=color:#8f5902;font-style:italic>//对mark过的流进行复位。只有当流支持mark时才可以使用此方法。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

                   <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mark/reset not supported&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

<span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//查询是否支持mark
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//绝大部分不支持，因此提供默认实现，返回false。子类有需要可以覆盖。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=filterinputstream>FilterInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilterInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//装饰器的代码特征: 被装饰的对象一般是装饰器的成员变量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//将要被装饰的字节输入流
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>FilterInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>   <span style=color:#8f5902;font-style:italic>//通过构造方法传入此被装饰的流
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//下面这些方法，完成最小的装饰――0装饰，只是调用被装饰流的方法而已
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>available</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>);</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>reset</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>markSupported</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bytearrayinputstream>ByteArrayInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ByteArrayInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>                <span style=color:#8f5902;font-style:italic>//内部的buffer，一般通过构造器输入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>//当前位置的cursor。从0至byte数组的长度。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//byte[pos]就是read方法读取的字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>mark</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#8f5902;font-style:italic>//mark的位置。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>              <span style=color:#8f5902;font-style:italic>//流中字节的数目。
</span><span style=color:#8f5902;font-style:italic></span>
    <span style=color:#8f5902;font-style:italic>//构造器，从一个byte[]创建一个ByteArrayInputStream
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//初始化流中的各个成员变量
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>;</span>              
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//构造器
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//与上面不同
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>min</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>mark</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//与上面不同
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//从流中读取下一个字节
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#8f5902;font-style:italic>//返回下一个位置的字节//流中没有数据则返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// ByteArrayInputStream要覆盖InputStream中可以看出其提供了该方法的实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//某些时候，父类不能完全实现子类的功能，父类的实现一般比较通用。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//当子类有更有效的方法时，我们会覆盖这些方法。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//首先检查输入参数的状态是否正确
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span> 
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>             <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>             <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//java中提供数据复制的方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//出于速度的原因！他们都用到System.arraycopy方法
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span> 
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//下面这个方法，在InputStream中也已经实现了。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//但是当时是通过将字节读入一个buffer中实现的，好像效率低了一点。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//比InputStream中的方法简单、高效
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//当前位置，可以跳跃的字节数目
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#ce5c00;font-weight:700>}</span>       
        <span style=color:#8f5902;font-style:italic>//小于0，则不可以跳跃
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#ce5c00;font-weight:700>}</span>   
        <span style=color:#8f5902;font-style:italic>//跳跃后，当前位置变化                                 
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                              
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>   
    <span style=color:#8f5902;font-style:italic>//查询流中还有多少字节没有读取。                                 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//ByteArrayInputStream支持mark所以返回true
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>                   

                   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#8f5902;font-style:italic>//在流中当前位置mark。      
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readAheadLimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>            
        <span style=color:#000>mark</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
     <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//重置流。即回到mark的位置。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭ByteArrayInputStream不会产生任何动作。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>   <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bufferedinputstream>BufferedInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BufferedInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FilterInputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>defaultBufferSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8192</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>//默认缓存的大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>  <span style=color:#8f5902;font-style:italic>//内部的缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>//buffer的大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#8f5902;font-style:italic>//buffer中cursor的位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>//mark的位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic>//mark的范围
</span><span style=color:#8f5902;font-style:italic></span>    
    <span style=color:#8f5902;font-style:italic>//原子性更新。和一致性编程相关
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span>    
    <span style=color:#000>AtomicReferenceFieldUpdater</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#000>bufUpdater</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>AtomicReferenceFieldUpdater</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newUpdater</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[].</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;buf&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#8f5902;font-style:italic>//检查输入流是否关闭，同时返回被包装流
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>InputStream</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stream closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//检查buffer的状态，同时返回缓存
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                       
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic>//不太可能发生的状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stream closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>    
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//构造器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//指定默认长度的buffer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>defaultBufferSize</span><span style=color:#ce5c00;font-weight:700>);</span>                                                              
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//构造器
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InputStream</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                           
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#8f5902;font-style:italic>//检查输入参数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>&lt;=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>){</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buffer size &lt;= 0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//创建指定长度的buffer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//从流中读取数据，填充如缓存中。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//得到buffer
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>                            
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//mark位置小于0，此时pos为0
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//pos大于buffer的长度            
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> 
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>        
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>sz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>markpos</span><span style=color:#ce5c00;font-weight:700>;</span>                                                           
　　　　　　　　　 <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>markpos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sz</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sz</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                 
                <span style=color:#8f5902;font-style:italic>//buffer的长度大于marklimit时，mark失效
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span> 
                <span style=color:#8f5902;font-style:italic>//丢弃buffer中的内容                                                                  
</span><span style=color:#8f5902;font-style:italic></span>　　　　　　　　　 <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                                    
            <span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>else</span><span style=color:#ce5c00;font-weight:700>{</span>                                                                         
                <span style=color:#8f5902;font-style:italic>//buffer的长度小于marklimit时对buffer扩容
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nsz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nsz</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>)</span> 
                    <span style=color:#000>nsz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>marklimit</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>//扩容为原来的2倍，太大则为marklimit大小
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>nsz</span><span style=color:#ce5c00;font-weight:700>];</span>                   
                    <span style=color:#8f5902;font-style:italic>//将buffer中的字节拷贝如扩容后的buf中    
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>        
                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>bufUpdater</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>    
                    <span style=color:#8f5902;font-style:italic>//在buffer在被操作时，不能取代此buffer
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Stream closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#8f5902;font-style:italic>//将新buf赋值给buffer
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>nbuf</span><span style=color:#ce5c00;font-weight:700>;</span>                                                               
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//读取下一个字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#8f5902;font-style:italic>//到达buffer的末端    
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                 
            <span style=color:#8f5902;font-style:italic>//就从流中读取数据，填充buffer 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                
　　　　　　　<span style=color:#8f5902;font-style:italic>//读过一次，没有数据则返回-1
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                                
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//返回buffer中下一个位置的字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>()[</span><span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xff</span><span style=color:#ce5c00;font-weight:700>;</span>                           
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//将数据从流中读入buffer中
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                 
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//buffer中还剩的可读字符                                                                            
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//buffer中没有可以读取的数据时
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span><span style=color:#ce5c00;font-weight:700>&lt;=</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>){</span>                                                                                        
            <span style=color:#8f5902;font-style:italic>//将输入流中的字节读入b中
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>             
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//填充                                                                                               
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//从流中读取后，检查可以读取的数目
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>cnt</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>                                                  
        <span style=color:#8f5902;font-style:italic>//将当前buffer中的字节放入b的末端
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cnt</span><span style=color:#ce5c00;font-weight:700>);</span>            
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>cnt</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>cnt</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                     
　　　　　<span style=color:#8f5902;font-style:italic>// 检查buffer是否open
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//检查输入参数是否正确
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(;;)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nread</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>nread</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>nread</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 检查buffer是否关闭
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>                                        
        <span style=color:#8f5902;font-style:italic>//检查输入参数是否正确
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>                 
        <span style=color:#8f5902;font-style:italic>//buffered中可以读取字节的数目
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>                    
        <span style=color:#8f5902;font-style:italic>//可以读取的小于0，则从流中读取
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                          
            <span style=color:#8f5902;font-style:italic>//mark小于0，则mark在流中 
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>skip</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>);</span>     
            <span style=color:#8f5902;font-style:italic>// 从流中读取数据，填充缓冲区。
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>();</span>                                  
            <span style=color:#8f5902;font-style:italic>//可以读的取字节为buffer的容量减当前位置
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>                                   
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>       
        <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>skipped</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>avail</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>;</span>      
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>skipped</span><span style=color:#ce5c00;font-weight:700>;</span>                                       
　　　　　<span style=color:#8f5902;font-style:italic>//当前位置改变
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>skipped</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//该方法不会block！返回流中可以读取的字节的数目。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>//该方法的返回值为缓存中的可读字节数目加流中可读字节数目的和
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getInIfOpen</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>);</span>                 
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//当前位置处为mark位置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>mark</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
        <span style=color:#000>marklimit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>readlimit</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pos</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 缓冲去关闭了，肯定就抛出异常！程序设计中经常的手段
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>getBufIfOpen</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>markpos</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Resetting to invalid mark&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>pos</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>markpos</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//该流和ByteArrayInputStream一样都支持mark
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>markSupported</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>           
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭当前流同时释放相应的系统资源。
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bufUpdater</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>InputStream</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// Else retry in case a new buf was CASed in fill()
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=pipedinputstream>PipedInputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PipedInputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>InputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//标识有读取方或写入方关闭
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>                                                             
    <span style=color:#204a87;font-weight:700>volatile</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>closedByReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>    
    <span style=color:#8f5902;font-style:italic>//是否建立连接
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>connected</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                     
    <span style=color:#8f5902;font-style:italic>//标识哪个线程
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span> <span style=color:#000>readSide</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                                             
    <span style=color:#000>Thread</span> <span style=color:#000>writeSide</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#8f5902;font-style:italic>//缓冲区的默认大小
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>PIPE_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>                         
    <span style=color:#8f5902;font-style:italic>//缓冲区
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>PIPE_SIZE</span><span style=color:#ce5c00;font-weight:700>];</span>                 
    <span style=color:#8f5902;font-style:italic>//下一个写入字节的位置。0代表空，in==out代表满
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>               
    <span style=color:#8f5902;font-style:italic>//下一个读取字节的位置
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>    
          
    <span style=color:#8f5902;font-style:italic>//给定源的输入流
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedOutputStream</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                
        <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//默认构造器，下部一定要connect源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedInputStream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#ce5c00;font-weight:700>}</span>                                                
    <span style=color:#8f5902;font-style:italic>//连接输入源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedOutputStream</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>               
        <span style=color:#8f5902;font-style:italic>//调用源的connect方法连接当前对象
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>                                                                           
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//只被PipedOuputStream调用
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                  
        <span style=color:#8f5902;font-style:italic>//检查状态，写入
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                 
        <span style=color:#8f5902;font-style:italic>//永远是PipedOuputStream
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>                                                      
        <span style=color:#8f5902;font-style:italic>//输入和输出相等，等待空间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#000>awaitSpace</span><span style=color:#ce5c00;font-weight:700>();</span>                                                           
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//放入buffer相应的位置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xFF</span><span style=color:#ce5c00;font-weight:700>);</span>                                                             
        <span style=color:#8f5902;font-style:italic>//in为0表示buffer已空
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>      <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>         <span style=color:#ce5c00;font-weight:700>}</span>                                             
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>//从PipedOutputStream可以看出
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>                                   
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bytesToTransfer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytesToTransfer</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//满了，会通知读取的；空会通知写入
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>    <span style=color:#000>awaitSpace</span><span style=color:#ce5c00;font-weight:700>();</span>                                
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>bytesToTransfer</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bytesToTransfer</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>assert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>nextTransferAmount</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>bytesToTransfer</span> <span style=color:#ce5c00;font-weight:700>-=</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>nextTransferAmount</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//检查当前状态，等待输入
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                           
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>connected</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>closedByReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readSide</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>readSide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlive</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Read end dead&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#8f5902;font-style:italic>//Buffer已满，等待一段时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>awaitSpace</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                                              
        <span style=color:#8f5902;font-style:italic>//in==out表示满了，没有空间
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                                             
            <span style=color:#8f5902;font-style:italic>//检查接受端的状态
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>checkStateForReceive</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                       
            <span style=color:#8f5902;font-style:italic>//通知读取端
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                  
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InterruptedIOException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>//通知所有等待的线程()已经接受到最后的字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>receivedLast</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>                  
        <span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>                             <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查一些内部状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>connected</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                              
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closedByReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe closed&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>writeSide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlive</span><span style=color:#ce5c00;font-weight:700>()&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>closedByWriter</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Write end dead&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//当前线程读取
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>readSide</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentThread</span><span style=color:#ce5c00;font-weight:700>();</span>                                            
        <span style=color:#8f5902;font-style:italic>//重复两次? ? ? 
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>trials</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                               
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//输入断关闭返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>closedByWriter</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>              <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>        <span style=color:#ce5c00;font-weight:700>}</span>                 
            <span style=color:#8f5902;font-style:italic>//状态错误
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>writeSide</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>writeSide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlive</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>trials</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>         
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe broken&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>        <span style=color:#8f5902;font-style:italic>// 空了，通知写入端可以写入                                                                         try {
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>wait</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1000</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InterruptedException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>InterruptedIOException</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ret</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>0xFF</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>             <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//没有任何字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>           <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                 <span style=color:#ce5c00;font-weight:700>}</span>                             
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ret</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>//检查输入参数的正确性
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>                                                                                 
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//读取下一个
</span><span style=color:#8f5902;font-style:italic></span>         <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>();</span>                                                                                 
        <span style=color:#8f5902;font-style:italic>//已经到达末尾了，返回-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>       <span style=color:#ce5c00;font-weight:700>}</span>                                            
        <span style=color:#8f5902;font-style:italic>//放入外部buffer中
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                    
        <span style=color:#8f5902;font-style:italic>//return-len
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>rlen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                            
        <span style=color:#8f5902;font-style:italic>//下一个in存在，且没有到达len
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(--</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>                                          
            <span style=color:#8f5902;font-style:italic>//依次放入外部buffer
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>rlen</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>++];</span>                                         
            <span style=color:#000>rlen</span><span style=color:#ce5c00;font-weight:700>++;</span>
            <span style=color:#8f5902;font-style:italic>//读到buffer的末尾，返回头部
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>         <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>           <span style=color:#ce5c00;font-weight:700>}</span>        
            <span style=color:#8f5902;font-style:italic>//读、写位置一致时，表示没有数据
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>      <span style=color:#ce5c00;font-weight:700>}</span>               
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>//返回填充的长度
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>rlen</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                            
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//返回还有多少字节可以读取
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>available</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>             
        <span style=color:#8f5902;font-style:italic>//到达末端，没有字节
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                                         
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//写入的和读出的一致，表示满
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>                                                               
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#8f5902;font-style:italic>//写入的大于读出
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>                                                                                 
        <span style=color:#204a87;font-weight:700>else</span>
            <span style=color:#8f5902;font-style:italic>//写入的小于读出的
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>                                                
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>//关闭当前流，同时释放与其相关的资源
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>                
        <span style=color:#8f5902;font-style:italic>//表示由输入流关闭
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>closedByReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>                                             
        <span style=color:#8f5902;font-style:italic>//同步化当前对象，in为-1
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>     <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>    <span style=color:#ce5c00;font-weight:700>}</span>        
    <span style=color:#ce5c00;font-weight:700>}</span>
        
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4678bab34901a915f5377636d14003c8>4.4 - CH04-OutputStream</h1>
<h2 id=outputstream-抽象类>OutputStream 抽象类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// 写入一个字节，可以看到这里的参数是一个 int 类型，对应上面的读方法，int 类型的 32 位，只有低 8 位才写入，高 24 位将舍弃。
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span>
<span style=color:#8f5902;font-style:italic>// 将数组中的所有字节写入，和上面对应的 read() 方法类似，实际调用的也是下面的方法。
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// 将 byte 数组从 off 位置开始，len 长度的字节写入
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic>// 强制刷新，将缓冲中的数据写入
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic>// 关闭输出流，流被关闭后就不能再输出数据了
</span></code></pre></div><h2 id=源码实现>源码实现</h2>
<h3 id=filteroutputstream>FilterOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * This class is the superclass of all classes that filter output
</span><span style=color:#8f5902;font-style:italic> * streams. These streams sit on top of an already existing output
</span><span style=color:#8f5902;font-style:italic> * stream (the &lt;i&gt;underlying&lt;/i&gt; output stream) which it uses as its
</span><span style=color:#8f5902;font-style:italic> * basic sink of data, but possibly transforming the data along the
</span><span style=color:#8f5902;font-style:italic> * way or providing additional functionality.
</span><span style=color:#8f5902;font-style:italic> * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic> * The class &lt;code&gt;FilterOutputStream&lt;/code&gt; itself simply overrides
</span><span style=color:#8f5902;font-style:italic> * all methods of &lt;code&gt;OutputStream&lt;/code&gt; with versions that pass
</span><span style=color:#8f5902;font-style:italic> * all requests to the underlying output stream. Subclasses of
</span><span style=color:#8f5902;font-style:italic> * &lt;code&gt;FilterOutputStream&lt;/code&gt; may further override some of these
</span><span style=color:#8f5902;font-style:italic> * methods as well as provide additional methods and fields.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  Jonathan Payne
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FilterOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>OutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The underlying output stream to be filtered.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates an output stream filter built on top of the specified
</span><span style=color:#8f5902;font-style:italic>     * underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   out   the underlying output stream to be assigned to
</span><span style=color:#8f5902;font-style:italic>     *                the field &lt;tt&gt;this.out&lt;/tt&gt; for later use, or
</span><span style=color:#8f5902;font-style:italic>     *                &lt;code&gt;null&lt;/code&gt; if this instance is to be
</span><span style=color:#8f5902;font-style:italic>     *                created without an underlying stream.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FilterOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified &lt;code&gt;byte&lt;/code&gt; to this output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls the &lt;code&gt;write&lt;/code&gt; method of its underlying output stream,
</span><span style=color:#8f5902;font-style:italic>     * that is, it performs &lt;tt&gt;out.write(b)&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Implements the abstract &lt;tt&gt;write&lt;/tt&gt; method of &lt;tt&gt;OutputStream&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the &lt;code&gt;byte&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;b.length&lt;/code&gt; bytes to this output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls its &lt;code&gt;write&lt;/code&gt; method of three arguments with the
</span><span style=color:#8f5902;font-style:italic>     * arguments &lt;code&gt;b&lt;/code&gt;, &lt;code&gt;0&lt;/code&gt;, and
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;b.length&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Note that this method does not call the one-argument
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;write&lt;/code&gt; method of its underlying stream with the single
</span><span style=color:#8f5902;font-style:italic>     * argument &lt;code&gt;b&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the data to be written.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#write(byte[], int, int)
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[])</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;byte&lt;/code&gt; array starting at offset &lt;code&gt;off&lt;/code&gt; to
</span><span style=color:#8f5902;font-style:italic>     * this output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls the &lt;code&gt;write&lt;/code&gt; method of one argument on each
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;byte&lt;/code&gt; to output.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Note that this method does not call the &lt;code&gt;write&lt;/code&gt; method
</span><span style=color:#8f5902;font-style:italic>     * of its underlying input stream with the same arguments. Subclasses
</span><span style=color:#8f5902;font-style:italic>     * of &lt;code&gt;FilterOutputStream&lt;/code&gt; should provide a more efficient
</span><span style=color:#8f5902;font-style:italic>     * implementation of this method.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#write(int)
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Flushes this output stream and forces any buffered output bytes
</span><span style=color:#8f5902;font-style:italic>     * to be written out to the stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;flush&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls the &lt;code&gt;flush&lt;/code&gt; method of its underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#out
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Closes this output stream and releases any system resources
</span><span style=color:#8f5902;font-style:italic>     * associated with the stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * The &lt;code&gt;close&lt;/code&gt; method of &lt;code&gt;FilterOutputStream&lt;/code&gt;
</span><span style=color:#8f5902;font-style:italic>     * calls its &lt;code&gt;flush&lt;/code&gt; method, and then calls the
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;close&lt;/code&gt; method of its underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#flush()
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#out
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#5c35cc;font-weight:700>@SuppressWarnings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;try&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>ostream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bytearrayoutputstream>ByteArrayOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * This class implements an output stream in which the data is
</span><span style=color:#8f5902;font-style:italic> * written into a byte array. The buffer automatically grows as data
</span><span style=color:#8f5902;font-style:italic> * is written to it.
</span><span style=color:#8f5902;font-style:italic> * The data can be retrieved using &lt;code&gt;toByteArray()&lt;/code&gt; and
</span><span style=color:#8f5902;font-style:italic> * &lt;code&gt;toString()&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic> * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic> * Closing a &lt;tt&gt;ByteArrayOutputStream&lt;/tt&gt; has no effect. The methods in
</span><span style=color:#8f5902;font-style:italic> * this class can be called after the stream has been closed without
</span><span style=color:#8f5902;font-style:italic> * generating an &lt;tt&gt;IOException&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  Arthur van Hoff
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ByteArrayOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>OutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The buffer where data is stored.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The number of valid bytes in the buffer.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new byte array output stream. The buffer capacity is
</span><span style=color:#8f5902;font-style:italic>     * initially 32 bytes, though its size increases if necessary.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayOutputStream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>32</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new byte array output stream, with a buffer capacity of
</span><span style=color:#8f5902;font-style:italic>     * the specified size, in bytes.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   size   the initial size.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IllegalArgumentException if size is negative.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ByteArrayOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Negative initial size: &#34;</span>
                                               <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Increases the capacity if necessary to ensure that it can hold
</span><span style=color:#8f5902;font-style:italic>     * at least the number of elements specified by the minimum
</span><span style=color:#8f5902;font-style:italic>     * capacity argument.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param minCapacity the desired minimum capacity
</span><span style=color:#8f5902;font-style:italic>     * @throws OutOfMemoryError if {@code minCapacity &lt; 0}.  This is
</span><span style=color:#8f5902;font-style:italic>     * interpreted as a request for the unsatisfiably large capacity
</span><span style=color:#8f5902;font-style:italic>     * {@code (long) Integer.MAX_VALUE + (minCapacity - Integer.MAX_VALUE)}.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>ensureCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// overflow-conscious code
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The maximum size of array to allocate.
</span><span style=color:#8f5902;font-style:italic>     * Some VMs reserve some header words in an array.
</span><span style=color:#8f5902;font-style:italic>     * Attempts to allocate larger arrays may result in
</span><span style=color:#8f5902;font-style:italic>     * OutOfMemoryError: Requested array size exceeds VM limit
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAX_ARRAY_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Increases the capacity to ensure that it can hold at least the
</span><span style=color:#8f5902;font-style:italic>     * number of elements specified by the minimum capacity argument.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param minCapacity the desired minimum capacity
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>grow</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// overflow-conscious code
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oldCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>MAX_ARRAY_SIZE</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#000>newCapacity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hugeCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>newCapacity</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hugeCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>minCapacity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// overflow
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OutOfMemoryError</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>minCapacity</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>?</span>
            <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span> <span style=color:#ce5c00;font-weight:700>:</span>
            <span style=color:#000>MAX_ARRAY_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified byte to this byte array output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   b   the byte to be written.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ensureCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified byte array
</span><span style=color:#8f5902;font-style:italic>     * starting at offset &lt;code&gt;off&lt;/code&gt; to this byte array output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param   off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param   len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
            <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>ensureCapacity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the complete contents of this byte array output stream to
</span><span style=color:#8f5902;font-style:italic>     * the specified output stream argument, as if by calling the output
</span><span style=color:#8f5902;font-style:italic>     * stream&#39;s write method using &lt;code&gt;out.write(buf, 0, count)&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      out   the output stream to which to write the data.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>writeTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Resets the &lt;code&gt;count&lt;/code&gt; field of this byte array output
</span><span style=color:#8f5902;font-style:italic>     * stream to zero, so that all currently accumulated output in the
</span><span style=color:#8f5902;font-style:italic>     * output stream is discarded. The output stream can be used again,
</span><span style=color:#8f5902;font-style:italic>     * reusing the already allocated buffer space.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.ByteArrayInputStream#count
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a newly allocated byte array. Its size is the current
</span><span style=color:#8f5902;font-style:italic>     * size of this output stream and the valid contents of the buffer
</span><span style=color:#8f5902;font-style:italic>     * have been copied into it.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return  the current contents of this output stream, as a byte array.
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.ByteArrayOutputStream#size()
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>toByteArray</span><span style=color:#ce5c00;font-weight:700>()[]</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Returns the current size of the buffer.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return  the value of the &lt;code&gt;count&lt;/code&gt; field, which is the number
</span><span style=color:#8f5902;font-style:italic>     *          of valid bytes in this output stream.
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.ByteArrayOutputStream#count
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Converts the buffer&#39;s contents into a string decoding bytes using the
</span><span style=color:#8f5902;font-style:italic>     * platform&#39;s default character set. The length of the new &lt;tt&gt;String&lt;/tt&gt;
</span><span style=color:#8f5902;font-style:italic>     * is a function of the character set, and hence may not be equal to the
</span><span style=color:#8f5902;font-style:italic>     * size of the buffer.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt; This method always replaces malformed-input and unmappable-character
</span><span style=color:#8f5902;font-style:italic>     * sequences with the default replacement string for the platform&#39;s
</span><span style=color:#8f5902;font-style:italic>     * default character set. The {@linkplain java.nio.charset.CharsetDecoder}
</span><span style=color:#8f5902;font-style:italic>     * class should be used when more control over the decoding process is
</span><span style=color:#8f5902;font-style:italic>     * required.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @return String decoded from the buffer&#39;s contents.
</span><span style=color:#8f5902;font-style:italic>     * @since  JDK1.1
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Converts the buffer&#39;s contents into a string by decoding the bytes using
</span><span style=color:#8f5902;font-style:italic>     * the named {@link java.nio.charset.Charset charset}. The length of the new
</span><span style=color:#8f5902;font-style:italic>     * &lt;tt&gt;String&lt;/tt&gt; is a function of the charset, and hence may not be equal
</span><span style=color:#8f5902;font-style:italic>     * to the length of the byte array.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt; This method always replaces malformed-input and unmappable-character
</span><span style=color:#8f5902;font-style:italic>     * sequences with this charset&#39;s default replacement string. The {@link
</span><span style=color:#8f5902;font-style:italic>     * java.nio.charset.CharsetDecoder} class should be used when more control
</span><span style=color:#8f5902;font-style:italic>     * over the decoding process is required.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      charsetName  the name of a supported
</span><span style=color:#8f5902;font-style:italic>     *             {@link java.nio.charset.Charset charset}
</span><span style=color:#8f5902;font-style:italic>     * @return     String decoded from the buffer&#39;s contents.
</span><span style=color:#8f5902;font-style:italic>     * @exception  UnsupportedEncodingException
</span><span style=color:#8f5902;font-style:italic>     *             If the named charset is not supported
</span><span style=color:#8f5902;font-style:italic>     * @since      JDK1.1
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>charsetName</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>UnsupportedEncodingException</span>
    <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>charsetName</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a newly allocated string. Its size is the current size of
</span><span style=color:#8f5902;font-style:italic>     * the output stream and the valid contents of the buffer have been
</span><span style=color:#8f5902;font-style:italic>     * copied into it. Each character &lt;i&gt;c&lt;/i&gt; in the resulting string is
</span><span style=color:#8f5902;font-style:italic>     * constructed from the corresponding element &lt;i&gt;b&lt;/i&gt; in the byte
</span><span style=color:#8f5902;font-style:italic>     * array such that:
</span><span style=color:#8f5902;font-style:italic>     * &lt;blockquote&gt;&lt;pre&gt;
</span><span style=color:#8f5902;font-style:italic>     *     c == (char)(((hibyte &amp;amp; 0xff) &amp;lt;&amp;lt; 8) | (b &amp;amp; 0xff))
</span><span style=color:#8f5902;font-style:italic>     * &lt;/pre&gt;&lt;/blockquote&gt;
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @deprecated This method does not properly convert bytes into characters.
</span><span style=color:#8f5902;font-style:italic>     * As of JDK&amp;nbsp;1.1, the preferred way to do this is via the
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;toString(String enc)&lt;/code&gt; method, which takes an encoding-name
</span><span style=color:#8f5902;font-style:italic>     * argument, or the &lt;code&gt;toString()&lt;/code&gt; method, which uses the
</span><span style=color:#8f5902;font-style:italic>     * platform&#39;s default character encoding.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      hibyte    the high byte of each resulting Unicode character.
</span><span style=color:#8f5902;font-style:italic>     * @return     the current contents of the output stream, as a string.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.ByteArrayOutputStream#size()
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.ByteArrayOutputStream#toString(String)
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.ByteArrayOutputStream#toString()
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#5c35cc;font-weight:700>@Deprecated</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hibyte</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>hibyte</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Closing a &lt;tt&gt;ByteArrayOutputStream&lt;/tt&gt; has no effect. The methods in
</span><span style=color:#8f5902;font-style:italic>     * this class can be called after the stream has been closed without
</span><span style=color:#8f5902;font-style:italic>     * generating an &lt;tt&gt;IOException&lt;/tt&gt;.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=bufferedoutputstream>BufferedOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * The class implements a buffered output stream. By setting up such
</span><span style=color:#8f5902;font-style:italic> * an output stream, an application can write bytes to the underlying
</span><span style=color:#8f5902;font-style:italic> * output stream without necessarily causing a call to the underlying
</span><span style=color:#8f5902;font-style:italic> * system for each byte written.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  Arthur van Hoff
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BufferedOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>FilterOutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The internal buffer where data is stored.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[];</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * The number of valid bytes in the buffer. This value is always
</span><span style=color:#8f5902;font-style:italic>     * in the range &lt;tt&gt;0&lt;/tt&gt; through &lt;tt&gt;buf.length&lt;/tt&gt;; elements
</span><span style=color:#8f5902;font-style:italic>     * &lt;tt&gt;buf[0]&lt;/tt&gt; through &lt;tt&gt;buf[count-1]&lt;/tt&gt; contain valid
</span><span style=color:#8f5902;font-style:italic>     * byte data.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new buffered output stream to write data to the
</span><span style=color:#8f5902;font-style:italic>     * specified underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   out   the underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>8192</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a new buffered output stream to write data to the
</span><span style=color:#8f5902;font-style:italic>     * specified underlying output stream with the specified buffer
</span><span style=color:#8f5902;font-style:italic>     * size.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param   out    the underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     * @param   size   the buffer size.
</span><span style=color:#8f5902;font-style:italic>     * @exception IllegalArgumentException if size &amp;lt;= 0.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>BufferedOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>OutputStream</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buffer size &lt;= 0&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>];</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/** Flush the internal buffer */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified byte to this buffered output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the byte to be written.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>++]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified byte array
</span><span style=color:#8f5902;font-style:italic>     * starting at offset &lt;code&gt;off&lt;/code&gt; to this buffered output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt; Ordinarily this method stores bytes from the given array into this
</span><span style=color:#8f5902;font-style:italic>     * stream&#39;s buffer, flushing the buffer to the underlying output stream as
</span><span style=color:#8f5902;font-style:italic>     * needed.  If the requested length is at least as large as this stream&#39;s
</span><span style=color:#8f5902;font-style:italic>     * buffer, however, then this method will flush the buffer and write the
</span><span style=color:#8f5902;font-style:italic>     * bytes directly to the underlying output stream.  Thus redundant
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;BufferedOutputStream&lt;/code&gt;s will not copy data unnecessarily.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>/* If the request length exceeds the size of the output buffer,
</span><span style=color:#8f5902;font-style:italic>               flush the output buffer and then write the data directly.
</span><span style=color:#8f5902;font-style:italic>               In this way buffered streams will cascade harmlessly. */</span>
            <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>arraycopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>count</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Flushes this buffered output stream. This forces any buffered
</span><span style=color:#8f5902;font-style:italic>     * output bytes to be written out to the underlying output stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     * @see        java.io.FilterOutputStream#out
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>flushBuffer</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=pipedoutputstream>PipedOutputStream</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * A piped output stream can be connected to a piped input stream
</span><span style=color:#8f5902;font-style:italic> * to create a communications pipe. The piped output stream is the
</span><span style=color:#8f5902;font-style:italic> * sending end of the pipe. Typically, data is written to a
</span><span style=color:#8f5902;font-style:italic> * &lt;code&gt;PipedOutputStream&lt;/code&gt; object by one thread and data is
</span><span style=color:#8f5902;font-style:italic> * read from the connected &lt;code&gt;PipedInputStream&lt;/code&gt; by some
</span><span style=color:#8f5902;font-style:italic> * other thread. Attempting to use both objects from a single thread
</span><span style=color:#8f5902;font-style:italic> * is not recommended as it may deadlock the thread.
</span><span style=color:#8f5902;font-style:italic> * The pipe is said to be &lt;a name=BROKEN&gt; &lt;i&gt;broken&lt;/i&gt; &lt;/a&gt; if a
</span><span style=color:#8f5902;font-style:italic> * thread that was reading data bytes from the connected piped input
</span><span style=color:#8f5902;font-style:italic> * stream is no longer alive.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * @author  James Gosling
</span><span style=color:#8f5902;font-style:italic> * @see     java.io.PipedInputStream
</span><span style=color:#8f5902;font-style:italic> * @since   JDK1.0
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PipedOutputStream</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>OutputStream</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>/* REMIND: identification of the read and write sides needs to be
</span><span style=color:#8f5902;font-style:italic>           more sophisticated.  Either using thread groups (but what about
</span><span style=color:#8f5902;font-style:italic>           pipes within a thread?) or using finalization (but it may be a
</span><span style=color:#8f5902;font-style:italic>           long time until the next GC). */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PipedInputStream</span> <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a piped output stream connected to the specified piped
</span><span style=color:#8f5902;font-style:italic>     * input stream. Data bytes written to this stream will then be
</span><span style=color:#8f5902;font-style:italic>     * available as input from &lt;code&gt;snk&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      snk   The piped input stream to connect to.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedInputStream</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Creates a piped output stream that is not yet connected to a
</span><span style=color:#8f5902;font-style:italic>     * piped input stream. It must be connected to a piped input stream,
</span><span style=color:#8f5902;font-style:italic>     * either by the receiver or the sender, before being used.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.PipedInputStream#connect(java.io.PipedOutputStream)
</span><span style=color:#8f5902;font-style:italic>     * @see     java.io.PipedOutputStream#connect(java.io.PipedInputStream)
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PipedOutputStream</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Connects this piped output stream to a receiver. If this object
</span><span style=color:#8f5902;font-style:italic>     * is already connected to some other piped input stream, an
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;IOException&lt;/code&gt; is thrown.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * If &lt;code&gt;snk&lt;/code&gt; is an unconnected piped input stream and
</span><span style=color:#8f5902;font-style:italic>     * &lt;code&gt;src&lt;/code&gt; is an unconnected piped output stream, they may
</span><span style=color:#8f5902;font-style:italic>     * be connected by either the call:
</span><span style=color:#8f5902;font-style:italic>     * &lt;blockquote&gt;&lt;pre&gt;
</span><span style=color:#8f5902;font-style:italic>     * src.connect(snk)&lt;/pre&gt;&lt;/blockquote&gt;
</span><span style=color:#8f5902;font-style:italic>     * or the call:
</span><span style=color:#8f5902;font-style:italic>     * &lt;blockquote&gt;&lt;pre&gt;
</span><span style=color:#8f5902;font-style:italic>     * snk.connect(src)&lt;/pre&gt;&lt;/blockquote&gt;
</span><span style=color:#8f5902;font-style:italic>     * The two calls have the same effect.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      snk   the piped input stream to connect to.
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>connect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PipedInputStream</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>snk</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connected</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Already connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>snk</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>connected</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes the specified &lt;code&gt;byte&lt;/code&gt; to the piped output stream.
</span><span style=color:#8f5902;font-style:italic>     * &lt;p&gt;
</span><span style=color:#8f5902;font-style:italic>     * Implements the &lt;code&gt;write&lt;/code&gt; method of &lt;code&gt;OutputStream&lt;/code&gt;.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b   the &lt;code&gt;byte&lt;/code&gt; to be written.
</span><span style=color:#8f5902;font-style:italic>     * @exception IOException if the pipe is &lt;a href=#BROKEN&gt; broken&lt;/a&gt;,
</span><span style=color:#8f5902;font-style:italic>     *          {@link #connect(java.io.PipedInputStream) unconnected},
</span><span style=color:#8f5902;font-style:italic>     *          closed, or if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Writes &lt;code&gt;len&lt;/code&gt; bytes from the specified byte array
</span><span style=color:#8f5902;font-style:italic>     * starting at offset &lt;code&gt;off&lt;/code&gt; to this piped output stream.
</span><span style=color:#8f5902;font-style:italic>     * This method blocks until all the bytes are written to the output
</span><span style=color:#8f5902;font-style:italic>     * stream.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param      b     the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      off   the start offset in the data.
</span><span style=color:#8f5902;font-style:italic>     * @param      len   the number of bytes to write.
</span><span style=color:#8f5902;font-style:italic>     * @exception IOException if the pipe is &lt;a href=#BROKEN&gt; broken&lt;/a&gt;,
</span><span style=color:#8f5902;font-style:italic>     *          {@link #connect(java.io.PipedInputStream) unconnected},
</span><span style=color:#8f5902;font-style:italic>     *          closed, or if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>[],</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pipe not connected&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NullPointerException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span>
                   <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>off</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IndexOutOfBoundsException</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>len</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>receive</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>off</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Flushes this output stream and forces any buffered output bytes
</span><span style=color:#8f5902;font-style:italic>     * to be written out.
</span><span style=color:#8f5902;font-style:italic>     * This will notify any readers that bytes are waiting in the pipe.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception IOException if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>flush</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notifyAll</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Closes this piped output stream and releases any system resources
</span><span style=color:#8f5902;font-style:italic>     * associated with this stream. This stream may no longer be used for
</span><span style=color:#8f5902;font-style:italic>     * writing bytes.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @exception  IOException  if an I/O error occurs.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>  <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sink</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>sink</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>receivedLast</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3711fc47d4bd344e88d2c026371a33d2>4.5 - CH05-常用操作.md</h1>
<h2 id=file>File</h2>
<p>递归地列出一个目录下所有文件:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>listAllFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>File</span> <span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exists</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFile</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#204a87;font-weight:700>return</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>File</span> <span style=color:#000>file</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>dir</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>listFiles</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>listAllFiles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=字节流>字节流</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>copyFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>FileInputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>FileOutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>20</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>];</span>

    <span style=color:#8f5902;font-style:italic>// read() 最多读取 buffer.length 个字节
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 返回的是实际读取的个数
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 返回 -1 的时候表示读到 eof，即文件尾
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=逐行打印>逐行打印</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>readFileContent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>filePath</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>FileReader</span> <span style=color:#000>fileReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filePath</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>BufferedReader</span> <span style=color:#000>bufferedReader</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileReader</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>String</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bufferedReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLine</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 装饰者模式使得 BufferedReader 组合了一个 Reader 对象
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 在调用 BufferedReader 的 close() 方法时会去调用 Reader 的 close() 方法
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 因此只要一个 close() 调用即可
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bufferedReader</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=序列化>序列化</h2>
<h3 id=序列化--serializable--transient>序列化 & Serializable & transient</h3>
<p>序列化就是将一个对象转换成字节序列，方便存储和传输。</p>
<ul>
<li>序列化: ObjectOutputStream.writeObject()</li>
<li>反序列化: ObjectInputStream.readObject()</li>
</ul>
<p>不会对静态变量进行序列化，因为序列化只是保存对象的状态，静态变量属于类的状态。</p>
<h3 id=serializable><strong>Serializable</strong></h3>
<p>序列化的类需要实现 Serializable 接口，它只是一个标准，没有任何方法需要实现，但是如果不去实现它的话而进行序列化，会抛出异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ClassNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>A</span> <span style=color:#000>a1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>123</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;abc&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>String</span> <span style=color:#000>objectFile</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;file/a1&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#000>ObjectOutputStream</span> <span style=color:#000>objectOutputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objectFile</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>objectOutputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>writeObject</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#000>objectOutputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#000>ObjectInputStream</span> <span style=color:#000>objectInputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>objectFile</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#000>A</span> <span style=color:#000>a2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>objectInputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readObject</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>objectInputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a2</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Serializable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#4e9a06>&#34;x = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;  &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;y = &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=transient><strong>transient</strong></h3>
<p>transient 关键字可以使一些属性不会被序列化。</p>
<p>ArrayList 中存储数据的数组 elementData 是用 transient 修饰的，因为这个数组是动态扩展的，并不是所有的空间都被使用，因此就不需要所有的内容都被序列化。通过重写序列化和反序列化方法，使得可以只序列化数组中有内容的那部分数据。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>transient</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>elementData</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h2 id=网络>网络</h2>
<h4 id=inetaddress>InetAddress</h4>
<p>没有公有的构造函数，只能通过静态方法来创建实例。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>InetAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>host</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>InetAddress</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getByAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h4 id=url>URL</h4>
<p>可以直接从 URL 中读取字节流数据。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#000>URL</span> <span style=color:#000>url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>URL</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://www.baidu.com&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 字节流 */</span>
    <span style=color:#000>InputStream</span> <span style=color:#000>is</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openStream</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/* 字符流 */</span>
    <span style=color:#000>InputStreamReader</span> <span style=color:#000>isr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InputStreamReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>is</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;utf-8&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 提供缓存功能 */</span>
    <span style=color:#000>BufferedReader</span> <span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferedReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isr</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#000>String</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>line</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>br</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>readLine</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#000>br</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=sockets>Sockets</h4>
<ul>
<li>ServerSocket: 服务器端类</li>
<li>Socket: 客户端类</li>
<li>服务器和客户端通过 InputStream 和 OutputStream 进行输入输出。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501214845.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=datagram>Datagram</h4>
<ul>
<li>DatagramSocket: 通信类</li>
<li>DatagramPacket: 数据包类</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-dc8da535c70e975714d2f9e3a34111ac>4.6 - CH06-IO实现</h1>
<h2 id=概览>概览</h2>
<blockquote>
<p>说到 I/O，想必大家都不会陌生， I/O 英语全称：Input/Output，即<strong>输入/输出</strong>，通常<strong>指数据在内部存储器和外部存储器或其他周边设备之间的输入和输出</strong>。</p>
</blockquote>
<p>比如我们常用的 <strong>SD卡</strong>、<strong>U盘</strong>、<strong>移动硬盘</strong>等等存储文件的硬件设备，当我们将其插入电脑的 usb 硬件接口时，我们就可以从电脑中读取设备中的信息或者写入信息，这个过程就涉及到 I/O 的操作。</p>
<p>当然，涉及 I/O 的操作，不仅仅局限于硬件设备的读写，还要网络数据的传输，比如，我们在电脑上用浏览器搜索互联网上的信息，这个过程也涉及到 I/O 的操作。</p>
<p>无论是从磁盘中读写文件，还是在网络中传输数据，可以说 I/O 主要为处理<strong>人机交互</strong>、<strong>机与机交互</strong>中获取和交换信息提供的一套解决方案。</p>
<p>在 Java 的 IO 体系中，类将近有 80 个，位于<code>java.io</code>包下，感觉很复杂，但是这些类大致可以分成四组：</p>
<ul>
<li><strong>基于字节操作的 I/O 接口：InputStream 和 OutputStream</strong></li>
<li><strong>基于字符操作的 I/O 接口：Writer 和 Reader</strong></li>
<li><strong>基于磁盘操作的 I/O 接口：File</strong></li>
<li><strong>基于网络操作的 I/O 接口：Socket</strong></li>
</ul>
<p>前两组主要从<strong>传输数据的数据格式</strong>不同，进行分组；后两组主要从<strong>传输数据的方式</strong>不同，进行分组。</p>
<p>虽然 Socket 类并不在<code> java.io</code>包下，但是我们仍然把它们划分在一起，因为 I/O 的核心问题，要么是数据格式影响 I/O 操作，要么是传输方式影响 I/O 操作，<strong>也就是将什么样的数据写到什么地方的问题</strong>，I/O 只是人与机器或者机器与机器交互的手段，除了在它们能够完成这个交互功能外，我们关注的就是如何提高它的运行效率了，而<strong>数据格式</strong>和<strong>传输方式</strong>是影响效率最关键的因素。</p>
<h2 id=字节格式>字节格式</h2>
<p>基于字节的输入和输出操作接口分别是：InputStream 和 OutputStream 。</p>
<h3 id=字节输入流>字节输入流</h3>
<p>InputStream 输入流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130438.png style=display:block;width:50% alt=NAME align=center> </div>
<p>输入流根据数据节点类型和处理方式，分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130515.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=字节输出流>字节输出流</h4>
<p>OutputStream 输出流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130542.png style=display:block;width:50% alt=NAME align=center> </div>
<p>输出流根据数据节点类型和处理方式，也分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130602.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在这里就不详细的介绍各个子类的使用方法，有兴趣的朋友可以查看 JDK 的 API 说明文档，笔者也会在后期的文章会进行详细的介绍，这里只是重点想说一下，<strong>无论是输入还是输出，操作数据的方式可以组合使用，各个处理流的类并不是只操作固定的节点流</strong>，比如如下输出方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>//将文件输出流包装到序列化输出流中，再将序列化输出流包装到缓冲中 OutputStream out = new BufferedOutputStream(new ObjectOutputStream(new FileOutputStream(new File(&#34;fileName&#34;)))； 
</span></code></pre></div><p>另外，<strong>输出流最终写到什么地方必须要指定</strong>，要么是写到硬盘中，要么是写到网络中，从图中可以发现，写网络实际上也是写文件，只不过写到网络中，需要经过底层操作系统将数据发送到其他的计算机中，而不是写入到本地硬盘中。</p>
<h2 id=字符格式>字符格式</h2>
<p><strong>不管是磁盘还是网络传输，最小的存储单元都是字节，而不是字符</strong>，所以 I/O 操作的都是字节而不是字符，但是为什么要有操作字符的 I/O 接口呢？</p>
<p>这是因为我们的程序中通常操作的数据都是以字符形式，<strong>为了程序操作更方便而提供一个直接写字符的 I/O 接口，仅此而已。</strong></p>
<p>基于字符的输入和输出操作接口分别是：Reader 和 Writer ，下图是字符的 I/O 操作接口涉及到的类结构图。</p>
<h4 id=字符输入流>字符输入流</h4>
<p>Reader 输入流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130732.png style=display:block;width:50% alt=NAME align=center> </div>
<p>同样的，输入流根据数据节点类型和处理方式，分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130744.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=字符输出流>字符输出流</h4>
<p>Writer 输出流的类继承层次如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130808.png style=display:block;width:50% alt=NAME align=center> </div>
<p>同样的，输出流根据数据节点类型和处理方式分类，分别可以划分出了若干个子类，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502130821.png style=display:block;width:50% alt=NAME align=center> </div>
<p>不管是 Reader 还是 Writer 类，它们都只定义了读取或写入数据字符的方式，也就是说要么是读要么是写，但是并没有规定数据要写到哪去，写到哪去就是我们后面要讨论的基于磁盘或网络的工作机制。</p>
<h3 id=字节与字符的转化>字节与字符的转化</h3>
<p>刚刚我们说到，不管是磁盘还是网络传输，最小的存储单元都是字节，而不是字符，设计字符的原因是为了程序操作更方便，那么怎么将字符转化成字节或者将字节转化成字符呢？</p>
<p><strong>InputStreamReader 和 OutputStreamWriter 就是转化桥梁。</strong></p>
<h4 id=输入流转化过程>输入流转化过程</h4>
<p>输入流字符解码相关类结构的转化过程如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/1786534ce9b3483cb9a5914ef4a227f9.jpg style=display:block;width:50% alt=NAME align=center> </div>
<p>从图上可以看到，InputStreamReader 类是字节到字符的转化桥梁， 其中<code>StreamDecoder</code>指的是一个<strong>解码</strong>操作类，<code>Charset</code>指的是字符集。</p>
<p>InputStream 到 Reader 的过程需要指定编码字符集，否则将采用操作系统默认字符集，很可能会出现乱码问题，StreamDecoder 则是完成字节到字符的解码的实现类。</p>
<p>打开源码部分，<strong>InputStream 到 Reader 转化过程</strong>，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131002.png style=display:block;width:50% alt=NAME align=center> </div>
<h4 id=输出流转化过程>输出流转化过程</h4>
<p>输出流转化过程也是类似，如下图所示：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131023.png style=display:block;width:50% alt=NAME align=center> </div>
<p>通过 OutputStreamWriter 类完成字符到字节的编码过程，由 <code>StreamEncoder</code> 完成<strong>编码</strong>过程。</p>
<p>源码部分，<strong>Writer 到 OutputStream 转化过程</strong>，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131039.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=磁盘传输>磁盘传输</h2>
<p>前面介绍了Java I/O 的操作接口，这些接口主要定义了如何操作数据，以及介绍了操作数据格式的方式：字节流和字符流。</p>
<p><strong>还有一个关键问题就是数据写到何处，其中一个主要的处理方式就是将数据持久化到物理磁盘。</strong></p>
<p>我们知道数据在磁盘的唯一最小描述就是文件，也就是说上层应用程序只能通过文件来操作磁盘上的数据，文件也是操作系统和磁盘驱动器交互的一个最小单元。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131240.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li><strong>在 Java I/O 体系中，File 类是唯一代表磁盘文件本身的对象</strong>。</li>
<li>File 类定义了一些与平台无关的方法来操作文件，包括检查一个<strong>文件是否存在、创建、删除文件、重命名文件、判断文件的读写权限是否存在、设置和查询文件的最近修改时间</strong>等等操作。</li>
</ul>
<p>值得注意的是 Java 中通常的 File 并不代表一个真实存在的文件对象，当你通过指定一个路径描述符时，它就会返回一个代表这个路径相关联的一个<strong>虚拟对象</strong>，这个可能是一个真实存在的文件或者是一个包含多个文件的目录。</p>
<p>例如，读取一个文件内容，程序如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131318.png style=display:block;width:50% alt=NAME align=center> </div>
<p>以上面的程序为例，从硬盘中读取一段文本字符，操作流程如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131340.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当我们传入一个指定的文件名来创建 File 对象，通过 FileReader 来读取文件内容时，会自动创建一个<code>FileInputStream</code>对象来读取文件内容，也就是我们上文中所说的字节流来读取文件。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131455.png style=display:block;width:50% alt=NAME align=center> </div>
<p>紧接着，会创建一个<code>FileDescriptor</code>的对象，其实这个对象就是真正代表一个存在的文件对象的描述。可以通过<code>FileInputStream</code>对象调用<code>getFD() </code>方法获取真正与底层操作系统关联的文件描述。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502131526.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由于我们需要读取的是字符格式，所以需要 <code>StreamDecoder</code> 类将<code>byte</code>解码为<code>char</code>格式，至于如何从磁盘驱动器上读取一段数据，由操作系统帮我们完成。</p>
<h2 id=网络传输>网络传输</h2>
<p>继续来说说数据写到何处的另一种处理方式：<strong>将数据写入互联网中以供其他电脑能访问</strong>。</p>
<h3 id=socket简介>Socket简介</h3>
<p>在现实中，Socket 这个概念没有一个具体的实体，它是描述计算机之间完成相互通信一种抽象定义。</p>
<p>打个比方，可以把 Socket 比作为两个城市之间的交通工具，有了它，就可以在城市之间来回穿梭了。并且，交通工具有多种，每种交通工具也有相应的交通规则。Socket 也一样，也有多种。大部分情况下我们使用的都是基于 TCP/IP 的流套接字，它是一种稳定的通信协议。</p>
<p>典型的基于 Socket 通信的应用程序场景，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132350.png style=display:block;width:50% alt=NAME align=center> </div>
<p>主机 A 的应用程序要想和主机 B 的应用程序通信，必须通过 Socket 建立连接，而建立 Socket 连接必须需要底层 TCP/IP 协议来建立 TCP 连接。</p>
<h3 id=建立通信链路>建立通信链路</h3>
<p>我们知道网络层使用的 IP 协议可以帮助我们根据 IP 地址来找到目标主机，但是一台主机上可能运行着多个应用程序，如何才能与指定的应用程序通信就要通过 TCP 或 UPD 的地址也就是端口号来指定。这样就可以通过一个 Socket 实例代表唯一一个主机上的一个应用程序的通信链路了。</p>
<p>为了准确无误地把数据送达目标处，<strong>TCP 协议采用了三次握手策略</strong>，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132449.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>
<p>SYN 全称为 Synchronize Sequence Numbers，<strong>表示同步序列编号</strong>，是 TCP/IP 建立连接时使用的握手信号。</p>
</li>
<li>
<p>ACK 全称为 Acknowledge character，即确认字符，<strong>表示发来的数据已确认接收无误</strong>。</p>
</li>
</ul>
<p>在客户机和服务器之间建立正常的 TCP 网络连接时，客户机首先发出一个 <strong>SYN 消息</strong>，服务器使用 <strong>SYN + ACK</strong> 应答表示接收到了这个消息，最后客户机再以 <strong>ACK</strong> 消息响应。</p>
<p>这样在客户机和服务器之间才能建立起可靠的 TCP 连接，数据才可以在客户机和服务器之间传递。</p>
<ul>
<li>发送端 –（发送带有 SYN 标志的数据包 ）–> 接受端（第一次握手）；</li>
<li>接受端 –（发送带有 SYN + ACK 标志的数据包）–> 发送端（第二次握手）；</li>
<li>发送端 –（发送带有 ACK 标志的数据包） –> 接受端（第三次握手）；</li>
</ul>
<p>完成三次握手之后，客户端应用程序与服务器应用程序就可以开始传送数据了。</p>
<h3 id=传输数据>传输数据</h3>
<p>当客户端要与服务端通信时，客户端首先要创建一个 Socket 实例，默认操作系统将为这个 Socket 实例分配一个没有被使用的本地端口号，并创建一个包含本地、远程地址和端口号的套接字数据结构，这个数据结构将一直保存在系统中直到这个连接关闭。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132616.png style=display:block;width:50% alt=NAME align=center> </div>
<p>与之对应的服务端，也将创建一个 ServerSocket 实例，ServerSocket 创建比较简单，只要指定的端口号没有被占用，一般实例创建都会成功，同时操作系统也会为 ServerSocket 实例创建一个底层数据结构，这个数据结构中包含指定监听的端口号和包含监听地址的通配符，通常情况下都是<code>*</code>即监听所有地址。</p>
<p>之后当调用 accept() 方法时，将进入阻塞(等待)状态，等待客户端的请求。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502132704.png style=display:block;width:50% alt=NAME align=center> </div>
<p>我们先启动服务端程序，再运行客户端，服务端收到客户端发送的信息，服务端打印结果如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>服务端收到客户端发送的消息：Hello，我是客户端！
</code></pre></div><p>注意，客户端只有与服务端建立三次握手成功之后，才会发送数据，而 TCP/IP 握手过程，底层操作系统已经帮我们实现了！</p>
<ol>
<li>当连接已经建立成功，服务端和客户端都会拥有一个 Socket 实例，每个 Socket 实例都有一个 <strong>InputStream</strong> 和 <strong>OutputStream</strong>，正如我们前面所说的，网络 I/O 都是以字节流传输的，Socket 正是通过这两个对象来交换数据。</li>
<li>当 Socket 对象创建时，操作系统将会为 InputStream 和 OutputStream 分别分配一定大小的缓冲区，数据的写入和读取都是通过这个缓存区完成的。</li>
<li>写入端将数据写到 OutputStream 对应的 SendQ 队列中，当队列填满时，数据将被发送到另一端 InputStream 的 RecvQ 队列中，如果这时 RecvQ 已经满了，那么 OutputStream 的 write 方法将会阻塞直到 RecvQ 队列有足够的空间容纳 SendQ 发送的数据。</li>
</ol>
<p>值得特别注意的是，缓存区的大小以及写入端的速度和读取端的速度非常影响这个连接的数据传输效率，由于可能会发生阻塞，所以网络 I/O 与磁盘 I/O 在数据的写入和读取还要有一个协调的过程，如果两边同时传送数据时可能会产生死锁的问题。</p>
<p><strong>如何提高网络 IO 传输效率、保证数据传输的可靠，已经成了工程师们急需解决的问题。</strong></p>
<h3 id=io-工作方式>IO 工作方式</h3>
<p>在计算机中，IO 传输数据有三种工作方式，分别是 <strong>BIO、NIO、AIO</strong>。</p>
<p>在讲解 <strong>BIO、NIO、AIO</strong> 之前，我们先来回顾一下这几个概念：<strong>同步与异步，阻塞与非阻塞</strong>。</p>
<p><strong>同步与异步的区别</strong></p>
<ul>
<li>同步就是发起一个请求后，接受者未处理完请求之前，不返回结果。</li>
<li>异步就是发起一个请求后，立刻得到接受者的回应表示已接收到请求，但是接受者并没有处理完，接受者通常依靠事件回调等机制来通知请求者其处理结果。</li>
</ul>
<p><strong>阻塞和非阻塞的区别</strong></p>
<ul>
<li>阻塞就是请求者发起一个请求，一直等待其请求结果返回，也就是当前线程会被挂起，无法从事其他任务，只有当条件就绪才能继续。</li>
<li>非阻塞就是请求者发起一个请求，不用一直等着结果返回，可以先去干其他事情，当条件就绪的时候，就自动回来。</li>
</ul>
<p>而我们要讲的 <strong>BIO、NIO、AIO</strong> 就是<strong>同步与异步、阻塞与非阻塞</strong>的组合。</p>
<ul>
<li>BIO：同步阻塞 IO；</li>
<li>NIO：同步非阻塞 IO；</li>
<li>AIO：异步非阻塞 IO;</li>
</ul>
<h3 id=bio>BIO</h3>
<p>BIO 俗称同步阻塞 IO，一种非常传统的 IO 模型，比如我们上面所举的那个程序例子，就是一个典型的**同步阻塞 IO **的工作方式。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133132.png style=display:block;width:50% alt=NAME align=center> </div>
<p>采用 BIO 通信模型的服务端，通常由一个独立的 <strong>Acceptor</strong> 线程负责监听客户端的连接。</p>
<p>我们一般在服务端通过<code>while(true)</code>循环中会调用<code>accept() </code>方法等待监听客户端的连接，一旦接收到一个连接请求，就可以建立通信套接字进行读写操作，此时不能再接收其他客户端连接请求，只能等待同当前连接的客户端的操作执行完成， 不过可以通过多线程来支持多个客户端的连接。</p>
<p><strong>客户端多线程操作，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133226.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端多线程操作，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133258.png style=display:block;width:50% alt=NAME align=center> </div>
<p>服务端运行结果，如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>服务端收到客户端发送的消息：Hello，我是第 2 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 4 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 3 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 0 个，客户端！
服务端收到客户端发送的消息：Hello，我是第 1 个，客户端！
</code></pre></div><p>如果要让 BIO 通信模型能够同时处理多个客户端请求，就必须使用多线程，也就是说它在接收到客户端连接请求之后为每个客户端创建一个新的线程进行链路处理，处理完成之后，通过输出流返回应答给客户端，线程销毁。</p>
<p>这就是典型的<strong>一请求一应答</strong>通信模型 。</p>
<p>如果出现100、1000、甚至10000个用户同时访问服务器，这个时候，如果使用这种模型，那么服务端也会创建与之相同的线程数量，<strong>线程数急剧膨胀可能会导致线程堆栈溢出、创建新线程失败等问题，最终导致进程宕机或者僵死，不能对外提供服务</strong>。</p>
<p>当然，我们可以通过使用 Java 中 ThreadPoolExecutor 线程池机制来改善，让线程的创建和回收成本相对较低，保证了系统有限的资源的控制，<strong>实现了 N （客户端请求数量）大于 M （处理客户端请求的线程数量）的伪异步 I/O 模型。</strong></p>
<h3 id=伪异步-bio>伪异步 BIO</h3>
<p>为了解决同步阻塞 I/O 面临的一个链路需要一个线程处理的问题，后来有人对它的线程模型进行了优化，后端通过一个线程池来处理多个客户端的请求接入，形成客户端个数 M：线程池最大线程数 N 的比例关系，其中 M 可以远远大于 N，通过线程池可以灵活地调配线程资源，设置线程的最大值，防止由于海量并发接入导致资源耗尽。</p>
<p>伪异步IO模型图，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133620.png style=display:block;width:50% alt=NAME align=center> </div>
<p>采用线程池和任务队列可以实现一种叫做伪异步的 I/O 通信框架，当有新的客户端接入时，将客户端的 Socket 封装成一个 Task 投递到后端的线程池中进行处理。</p>
<p>Java 的线程池维护一个消息队列和 N 个活跃线程，对消息队列中的任务进行处理。</p>
<p><strong>客户端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133717.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133731.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>先启动服务端程序，再启动客户端程序，看看运行结果！</strong></p>
<p><strong>服务端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133834.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>客户端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502133853.png style=display:block;width:50% alt=NAME align=center> </div>
<p>本例中测试的客户端数量是 30，服务端使用 java 线程池来处理任务，线程数量为 5 个，服务端不用为每个客户端都创建一个线程，由于线程池可以设置消息队列的大小和最大线程数，因此，它的资源占用是可控的，无论多少个客户端并发访问，都不会导致资源的耗尽和宕机。</p>
<p>在活动连接数不是特别高的情况下，这种模型是还不错，可以让每一个连接专注于自己的 I/O 并且编程模型简单，也不用过多考虑系统的过载、限流等问题。</p>
<p>但是，它的底层仍然是同步阻塞的 BIO 模型，当面对十万甚至百万级连接的时候，传统的 BIO 模型真的是无能为力的，我们需要一种更高效的 I/O 处理模型来应对更高的并发量。</p>
<h3 id=nio>NIO</h3>
<ul>
<li>
<p>NIO 中的 N 可以理解为 <strong>Non-blocking</strong>，一种同步非阻塞的 I/O 模型，在 Java 1.4 中引入，对应的在<code>java.nio</code>包下。</p>
</li>
<li>
<p>NIO 新增了 <strong>Channel、Selector、Buffer</strong> 等抽象概念，支持面向缓冲、基于通道的 I/O 操作方法。</p>
</li>
<li>
<p>NIO 提供了与传统 BIO 模型中的 <code>Socket</code> 和 <code>ServerSocket</code> 相对应的 <code>SocketChannel</code> 和 <code>ServerSocketChannel</code> 两种不同的套接字通道实现。</p>
</li>
<li>
<p>NIO 这两种通道都支持<strong>阻塞和非阻塞</strong>两种模式。阻塞模式使用就像传统中的支持一样，比较简单，但是性能和可靠性都不好；<strong>非阻塞模式正好与之相反</strong>。</p>
</li>
<li>
<p>对于低负载、低并发的应用程序，可以使用同步阻塞 I/O 来提升开发效率和更好的维护性；</p>
</li>
<li>
<p>对于高负载、高并发的（<strong>网络</strong>）应用，应使用 NIO 的非阻塞模式来开发。</p>
</li>
</ul>
<p>我们先看一下 NIO 涉及到的核心关联类图，如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134125.png style=display:block;width:50% alt=NAME align=center> </div>
<p>上图中有三个关键类：<strong>Channel 、Selector 和 Buffer</strong>，它们是 NIO 中的核心概念。</p>
<ul>
<li><strong>Channel：可以理解为通道；</strong></li>
<li><strong>Selector：可以理解为选择器；</strong></li>
<li><strong>Buffer：可以理解为数据缓冲流；</strong></li>
</ul>
<p>我们还是用前面的城市交通工具来继续形容 NIO 的工作方式，这里的 <strong>Channel</strong> 要比 <strong>Socket</strong> 更加具体，它可以比作为某种具体的交通工具，如汽车或是高铁、飞机等，而 <strong>Selector</strong> 可以比作为一个车站的车辆运行调度系统，它将负责监控每辆车的当前运行状态：是已经出站还是在路上等等，也就是说它可以轮询每个 <strong>Channel</strong> 的状态。</p>
<p>还有一个 <strong>Buffer</strong> 类，你可以将它看作为 IO 中 <strong>Stream</strong>，但是它比 IO 中的 <strong>Stream</strong> 更加具体化，我们可以将它比作为车上的座位，<strong>Channel</strong> 如果是汽车的话，那么 <strong>Buffer</strong> 就是汽车上的座位，<strong>Channel</strong> 如果是高铁，那么 <strong>Buffer</strong> 就是高铁上的座位，它始终是一个具体的概念，这一点与 <strong>Stream</strong> 不同。</p>
<p><strong>Socket 中的 Stream</strong> 只能代表是一个座位，至于是什么座位由你自己去想象，也就是说你在上车之前并不知道这个车上是否还有没有座位，也不知道上的是什么车，因为你并不能选择，这些信息都已经被封装在了运输工具（<strong>Socket</strong>）里面了。</p>
<p>NIO 引入了 <strong>Channel、Buffer 和 Selector</strong> 就是想把 IO 传输过程中涉及到的<strong>信息具体化</strong>，让程序员有机会去控制它们。</p>
<p>当我们进行传统的网络 IO 操作时，比如调用 write() 往 Socket 中的 SendQ 队列写数据时，当一次写的数据超过 SendQ 长度时，操作系统会按照 SendQ 的长度进行分割的，这个过程中需要将用户空间数据和内核地址空间进行切换，而这个切换不是程序员可以控制的，由底层操作系统来帮我们处理。</p>
<p>而在 Buffer 中，我们可以控制 Buffer 的 capacity（容量），并且是否扩容以及如何扩容都可以控制。</p>
<p>还是以上面的操作为例子，为了方便观看结果，本次的客户端线程请求数改成15个。</p>
<p><strong>客户端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134512.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134546.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>先启动服务端程序，再启动客户端程序，看看运行结果！</strong></p>
<p><strong>服务端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134718.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>客户端，运行结果如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134732.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>当然，客户端也不仅仅只限制于 IO 的写法，还可以使用<code>SocketChannel </code>来操作客户端，程序如下：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134752.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>从操作上可以看到，NIO 的操作比传统的 IO 操作要复杂的多！</strong></p>
<p><strong>Selector</strong> 被称为<strong>选择器</strong> ，当然你也可以翻译为<strong>多路复用器</strong> 。它是Java NIO 核心组件中的一个，用于检查一个或多个 <strong>Channel</strong>（通道）的状态是否处于<strong>连接就绪</strong>、<strong>接受就绪</strong>、<strong>可读就绪</strong>、<strong>可写就绪</strong>。</p>
<p>如此可以实现单线程管理多个 <strong>channels</strong>，也就是可以管理多个网络连接。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502134831.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>使用 Selector 的好处在于：</strong> 相比传统方式使用多个线程来管理 IO，Selector 使用了更少的线程就可以处理通道了，并且实现网络高效传输！</p>
<p>虽然 java 中的 nio 传输比较快，为什么大家都不愿意用 JDK 原生 NIO 进行开发呢？</p>
<p>从上面的代码中大家都可以看出来，除了编程复杂、编程模型难之外，还有几个让人诟病的问题：</p>
<ul>
<li><strong>JDK 的 NIO 底层由 epoll 实现，该实现饱受诟病的空轮询 bug 会导致 cpu 飙升 100%！</strong></li>
<li><strong>项目庞大之后，自行实现的 NIO 很容易出现各类 bug，维护成本较高！</strong></li>
</ul>
<p><strong>但是，Google 的 Netty 框架的出现，很大程度上改善了 JDK 原生 NIO 所存在的一些让人难以忍受的问题</strong>。</p>
<h3 id=aio>AIO</h3>
<p>最后就是 AIO 了，全称 Asynchronous I/O，可以理解为异步 IO，也被称为 NIO 2，在 Java 7 中引入了 NIO 的改进版 NIO 2，它是异步非阻塞的 IO 模型，也就是我们现在所说的 AIO。</p>
<p>异步 IO 是<strong>基于事件和回调机制</strong>实现的，也就是应用操作之后会直接返回，不会堵塞在那里，当后台处理完成，操作系统会通知相应的线程进行后续的操作。</p>
<p><strong>客户端，程序示例：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502135052.png style=display:block;width:50% alt=NAME align=center> </div>
<p><strong>服务端，程序示例：</strong></p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502135109.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这种组合方式用起来比较复杂，只有在一些非常复杂的分布式情况下使用，像集群之间的消息同步机制一般用这种 I/O 组合方式。如 Cassandra 的 Gossip 通信机制就是采用异步非阻塞的方式。</p>
<h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=http://www.justdojava.com/2019/12/18/java-io-1/>http://www.justdojava.com/2019/12/18/java-io-1/</a></li>
<li><a href=http://ifeve.com/java-io/>http://ifeve.com/java-io/</a></li>
<li><a href=http://ifeve.com/java-nio-all/>http://ifeve.com/java-nio-all/</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-312904add31ff8ea8730fec11cef07bc>4.7 - CH07-IO模型</h1>
<h2 id=用户空间与内核空间>用户空间与内核空间</h2>
<p>我们知道现在的操作系统都是采用虚拟存储器，那么对 32 位操作系统来说，它的寻址空间即虚拟存储空间为 4G，2 的 32 次方。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限。<strong>为了保证用户进程不能直接操作内核，保证内核的的安全，操作系统将虚拟内存空间划分为两部分，一部分是内核空间，一部分是用户空间。</strong></p>
<p>针对 Linux 操作系统而言，将最高的 1G 字节，即从虚拟地址 0xC0000000 到 0xFFFFFFFF 供内核使用，称为内核空间。而较低的 3G 字节，即从虚拟地址 0x00000000 到 0xBFFFFFFF，供进程使用，称为用户空间。每个进程都可以通过系统调用进入内核，因此 Linux 内核由系统内的所有进程共享。于是，<strong>从具体进程的角度看，每个进程可以拥有 4G 字节的虚拟空间</strong>。</p>
<p>有了用户空间和内核空间，整个 Linux 内部结构可以分为三个部分，从最底层到最上层依次是：<strong>硬件、内核空间、用户空间</strong>。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225144207.png style=display:block;width:50% alt=NAME align=center> </div>
<p>需要注意的细节是，从上图可以看出内核的组成：</p>
<ul>
<li>内核空间中存放的是内核代码和数据，而进程的用户空间存放的是用户程序的代码和数据。不管是内核空间还是用户空间，都处于虚拟空间之中。</li>
<li>Linux 使用两级保护机制：0 级供内核使用，3 级供用户程序使用。</li>
</ul>
<h2 id=服务端处理网络请求的流程>服务端处理网络请求的流程</h2>
<p>为了 OS 的安全性等考虑，进程是无法直接操作 IO 设备的，其<strong>必须通过系统调用来请求内核以协助完成 IO 动作，而内核会为每个 IO 设备维护一个 buffer</strong>。</p>
<p>整个请求过程为：</p>
<ol>
<li>用户进程发起请求；</li>
<li>内核接收到请求后；</li>
<li><strong>从 IO 设备中获取数据到 buffer 中</strong>；</li>
<li><strong>再将 buffer 中的数据 copy 到用户进程的地址空间</strong>；</li>
<li>该用户进程获取到数据后再响应客户端。</li>
</ol>
<p>服务端处理网络请求的典型流程图如下：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225151943.png style=display:block;width:80% alt=NAME align=center> </div>
<p>在请求过程中，数据从 IO 设备输入至 buffer 需要时间，从 buffer 复制将数据复制到用户进程也需要时间。因此<strong>根据在这两段时间内等待方式的不同，IO 动作可以分为以下五种</strong>：</p>
<ul>
<li>阻塞 IO，Blocking IO</li>
<li>非阻塞 IO，Non-Blocking IO</li>
<li>IO 复用，IO Multiplexing</li>
<li>信号驱动的 IO，Signal Driven IO</li>
<li>异步 IO，Asynchrnous IO</li>
</ul>
<blockquote>
<p>更多细节参考 &lt;Unix 网络编程>，6.2 节 “IO Models”。</p>
</blockquote>
<p>设计服务端并发模型时，主要有如下两个关键点：</p>
<ul>
<li>服务器如何管理连接，获取请求数据。</li>
<li>服务器如何处理请求。</li>
</ul>
<p>以上两个关键点最终都与操作系统的 I/O 模型以及线程(进程)模型相关，下面详细介绍这两个模型。</p>
<h2 id=阻塞非阻塞同步异步>阻塞/非阻塞、同步/异步</h2>
<h3 id=阻塞非阻塞><strong>阻塞/非阻塞</strong>：</h3>
<ul>
<li>阻塞调用是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才会返回。</li>
<li>非阻塞调用指在不能立刻得到结果之前，该调用不会阻塞当前线程。</li>
</ul>
<p>区别：</p>
<ul>
<li>两者的最大区别在于被调用方在收到请求到返回结果之前的这段时间内，调用方是否一直在等待。</li>
<li>阻塞是指调用方一直在等待而且别的事情什么都不做；非阻塞是指调用方先去忙别的事情。</li>
</ul>
<h3 id=同步异步><strong>同步/异步</strong>：</h3>
<ul>
<li>同步处理是指被调用方得到最终结果之后才返回给调用方；</li>
<li>异步处理是指被调用方先返回应答，然后再计算调用结果，计算完最终结果后再通知并返回给调用方。</li>
</ul>
<h3 id=区别与联系>区别与联系</h3>
<p><strong>阻塞、非阻塞和同步、异步其实针对的对象是不一样的</strong>：</p>
<ul>
<li>阻塞、非阻塞的讨论对象是调用者。</li>
<li>同步、异步的讨论对象是被调用者。</li>
</ul>
<h2 id=linux-网络-io-模型>Linux 网络 I/O 模型</h2>
<h3 id=recvfrom-函数>recvfrom 函数</h3>
<p>recvfrom 函数(经 Socket 接收数据)，这里把它视为系统调用。一个输入操作通常包括两个不同的阶段：</p>
<ul>
<li>等待数据准就绪。</li>
<li>从内核向应用进程复制数据。</li>
</ul>
<p>对于一个套接字上的输入操作，第一步通常涉及等待数据从网络中到达。当所等待分组到达时，它被复制到内核中的某个缓冲区。第二步就是把数据从内核缓冲区复制到应用进程缓冲区。</p>
<p>实际应用程序在通过系统调用完成上面的 2 步操作时，调用方式的阻塞、非阻塞，操作系统在处理应用程序请求时处理方式的同步、异步，可以分为 5 种 I/O 模型。</p>
<h3 id=阻塞式-io>阻塞式 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225202244.png style=display:block;width:80% alt=NAME align=center> </div>
<p>在阻塞式 IO 模型中，应用程序从调用 recvfrom 开始到它返回有数据报准备好这段时间是阻塞的，recvfrom 返回成功后，应用程序开始处理数据报。</p>
<ul>
<li>优点：程序实现简单，在阻塞等待数据期间，进程、线程挂起，基本不会占用 CPU 资源。</li>
<li>每个连接需要独立的进程、线程单独处理，当并发请求量大时为了维护程序，内存、线程切换开销很大，这种模型在实际生产中很少使用。</li>
</ul>
<h3 id=非阻塞-io>非阻塞 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225202544.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在非阻塞 IO 模型中，应用程序把一个套接口设置为非阻塞，就是告诉内核，当所有请求的 IO 操作无法完成时，不要将进程睡眠。</p>
<p>而是返回一个错误，应用程序基于 IO 操作函数，将会不断的轮询数据是否已经准备就绪，直到数据准备就绪。</p>
<ul>
<li>优点：不会阻塞在内核的等待数据过程，每次发起的 IO 请求可以立即返回，不会阻塞等待，实时性比较好。</li>
<li>缺点：轮询将会不断的询问内核，这将占用大量的 CPU 时间，系统资源利用率较低，所以一般 Web 服务器不会使用这种 IO 模型。</li>
</ul>
<h3 id=io-多路复用>IO 多路复用</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225202916.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在 IO 复用模型中，会用到 Select、Poll、Epoll 函数，这些函数会使进程阻塞，但是和阻塞 IO 有所不同。</p>
<p>这些函数可以同时阻塞多个 IO 操作，而且可以同时对多个读、写操作的 IO 函数进行检测，直到有数据可读或可写时，才会真正调用 IO 操作函数。</p>
<ul>
<li>优点：可以基于一个阻塞对象，同时在多个描述符上等待就绪，而不是使用多个线程(每个文件描述符一个线程)，这样可以大大节省系统资源。</li>
<li>当连接数较少时效率比“多线程+阻塞IO”的模式效率低，可能延迟更大，因为单个连接处理需要 2 次系统调用，占用时间会增加。</li>
</ul>
<h3 id=信号驱动-io>信号驱动 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225203258.png style=display:block;width:50% alt=NAME align=center> </div>
<p>在信号驱动 IO 模型中，应用程序使用套接口进行信号驱动 IO，并安装一个信号处理函数，进程继续运行并不阻塞。</p>
<p>当数据准备好时，进程会收到一个 SIGIO 信号，可以在信号处理函数中调用 IO 操作函数处理数据。</p>
<ul>
<li>优点：线程没有在等待数据时被阻塞，可以提高资源利用率。</li>
<li>缺点：信号 IO 模式在大量 IO 操作时可能会因为信号队列溢出而导致无法通知。</li>
</ul>
<p>信号驱动 IO 尽管对于处理 UDP 套接字来说有用，即这种信号通知意味着到达了一个数据报，或者返回一个异步错误。</p>
<p>但是，对于 TCP 而言，信号驱动 IO 方式近乎无用。因为导致这种通知的条件为数众多，逐个进行判断会消耗很大的资源，与前几种方式相比优势尽失。</p>
<h3 id=异步-io>异步 IO</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225203813.png style=display:block;width:50% alt=NAME align=center> </div>
<p>由 POSIX 规范定义，应用程序告知内核启动某个操作，并让内核在整个操作完成后(包括将数据从内核拷贝到应用程序的缓冲区)通知应用程序。</p>
<p>这种模型与信号驱动模型的主要区别在于：信号驱动 IO 是由内核通知应用程序合适启动一个 IO 操作，而异步 IO 模型是由内核通知应用程序 IO 操作合适完成。</p>
<ul>
<li>优点：异步 IO 能够充分利用 DMA 特性，让 IO 操作与计算重叠。</li>
<li>缺点：需要实现真正的异步 IO，操作系统需要做大量的工作。当前 Windows 下通过 IOCP 实现了真正的异步 IO。</li>
</ul>
<p>而在 Linux 系统下直到 2.6 版本才引入，目前 AIO 并不完善，因此在 Linux 下实现并发网络编程时都是以 IO 复用模型为主。</p>
<h3 id=io-模型对比>IO 模型对比</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225204240.png style=display:block;width:50% alt=NAME align=center> </div>
<p>从上图可以看出，越往后，阻塞越少，理论上效率也最优。</p>
<p>这五种模型中，前四种属于同步 IO，因为其中真正的 IO 操作(recvfrom 函数调用)将阻塞进程/线程，只有异步 IO 模型才与 POSIX 定义的异步 IO 相匹配。</p>
<h2 id=进程线程模型>进程/线程模型</h2>
<p>介绍完服务器如何基于 IO 模型<strong>管理连接、获取输入数据</strong>，下面介绍服务器如何基于进程、线程模型来<strong>处理请求</strong>。</p>
<h3 id=传统阻塞-io-服务模型>传统阻塞 IO 服务模型</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225204551.png style=display:block;width:50% alt=NAME align=center> </div>
<p>特点：</p>
<ul>
<li>采用阻塞式 IO 模型获取输入数据。</li>
<li>每个连接都需要独立的线程完成数据输入的读取、业务处理、数据返回操作。</li>
</ul>
<p>存在问题：</p>
<ul>
<li>当请求的并发数较大时，需要创建大量线程来处理连接，系统资源占用较大。</li>
<li>当连接建立后，如果当前线程暂时没有数据可读，则线程就阻塞在 Read 操作上，造成线程资源浪费。</li>
</ul>
<h3 id=reactor-模式>Reactor 模式</h3>
<p>针对传统阻塞 IO 服务模型的 2 个缺点，比较常见的有如下解决方案：</p>
<ul>
<li><strong>基于 IO 复用模型</strong>，多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象上等待，无需阻塞等待所有连接。
<ul>
<li>当某条连接有新的数据可处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理。</li>
</ul>
</li>
<li><strong>基于线程池复用线程资源</strong>，不必再为每个连接创建线程，将连接完成后的业务处理任务分配给线程进行处理，一个线程可以多个连接的业务。</li>
</ul>
<p><strong>IO 复用模式结合线程池</strong>，就是 Reactor 模式的基本设计思想，如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225205123.png style=display:block;width:50% alt=NAME align=center> </div>
<p>Reactor 模式，是指通过一个或多个输入同时传递给服务器来处理服务请求的事件驱动处理模式。</p>
<p>服务端程序处理传入的多路请求，并将它们同步分派给请求对应的处理线程，Reactor 模式也叫 Dispatcher 模式。</p>
<p>即 IO 多路复用以统一的方式监听事件，收到事件后分发(Dispatch 给某线程)，是编写高性能服务器的必备技术之一。</p>
<p>Reactor 模式有两个关键组件构成：</p>
<ul>
<li>Reactor：在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序对 IO 事件做出反应。它就像公司的电话接线员，接听来自客户的电话并将线路转移给适当的联系人。</li>
<li>Handlers：处理程序执行 IO 事件需要完成的实际组件，类似于客户想要与之交谈的客服坐席。Reactor 通过调度适当的处理程序来响应 IO 事件，处理程序执行非阻塞操作。</li>
</ul>
<p>根据 Reactor 的数量和处理资源池线程的数量不同，有 3 种典型的实现：</p>
<ul>
<li>单 Reactor 单线程</li>
<li>单 Reactor 多线程</li>
<li>主从 Reactor 多线程</li>
</ul>
<h4 id=单-reactor-单线程>单 Reactor 单线程</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225205947.png style=display:block;width:50% alt=NAME align=center> </div>
<p>其中，Select 是前面 IO 复用模型介绍的标准网络编程 API，可以实现应用程序通过一个阻塞多向监听多路连接请求，其他方案的示意图也类似。</p>
<p>方案说明：</p>
<ul>
<li>
<p>Reactor 对象通过 Select 监听客户端请求事件，收到事件后通过 Dispatch 进行分发。</p>
</li>
<li>
<p>如果是“建立连接”请求事件，则由 Acceptor 通过 Accept 处理连接请求，同时创建一个 Handler 对象来处理连接完成后的后续业务处理。</p>
</li>
<li>
<p>如果不是“建立连接”事件，则 Reactor 会分发调用“连接”对应的 Handler 来响应。</p>
</li>
<li>
<p>Handler 会完成 “Read->业务处理->Send” 的完整业务流程。</p>
</li>
<li>
<p>优点：模型简单，没有多线程、进程通信、竞争的问题，全部都在一个线程中完成。</p>
</li>
<li>
<p>缺点：性能问题，只有一个线程，无法完全发挥多个 CPU 的性能。Handler 在处理某个连接上的业务时，整个进程无法处理其他连接事件，很容易导致性能瓶颈。</p>
</li>
</ul>
<p>可靠性问题、线程意外跑飞、进入死循环，或导致整个系统的通信模块不可用，不能接收或处理外部消息，造成节点故障。</p>
<p>应用场景：客户端的数量有限，业务处理非常快，比如 Redis，业务处理的时间复杂度为 O(1)。</p>
<h4 id=单-reactor-多线程>单 Reactor 多线程</h4>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225210742.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>
<p>Reactor 对象通过 Select 监控客户端请求事件，收到事件后通过 Dispatch 进行分发。</p>
</li>
<li>
<p>如果是建立连接请求事件，则由 Acceptor 通过 Accept 处理连接请求，同时创建一个 Handler 对象处理连接完成后续的各种事件。</p>
</li>
<li>
<p>如果不是建立连接事件，则 Reactor 会分发调用连接对应的 Handler 来响应。</p>
</li>
<li>
<p>Handler 只负责响应事件，不做具体业务处理，通过 Read 读取数据后，会分发给后面的 Worker 线程池进行业务处理。</p>
</li>
<li>
<p>Worker 线程池会分配独立的线程完成真正的业务处理，如何将响应结果发给 Handler 进行处理。</p>
</li>
<li>
<p>Handler 收到响应结果后通过 Send 将响应结果返回给 Client。</p>
</li>
<li>
<p>优点：可以充分利用多核 CPU 的处理能力。</p>
</li>
<li>
<p>缺点：</p>
<ul>
<li>多线程数据共享和访问比较复杂；</li>
<li>Reactor 承担所有事件的监听和响应，在单线程中运行，高并发场景下容易成为性能瓶颈。</li>
</ul>
</li>
</ul>
<h4 id=主从-reactor-多线程>主从 Reactor 多线程</h4>
<p>针对单 Reactor 多线程模型中，Reactor 在单线程中运行，高并发场景下容易成为性能瓶颈，可以让 Reactor 在多线程中运行。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225213435.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>
<p>Reactor 主线程 MainReactor 对象通过 Select 监控建立连接事件，收到事件后通过 Acceptor 接收，处理建立连接事件。</p>
</li>
<li>
<p>Acceptor 处理建立连接事件后，MainReactor 将连接分配 Reactor 子线程给 SubReactor 进行处理。</p>
</li>
<li>
<p>SubReactor 将连接加入连接队列进行监听，并创建一个 Handler 用于处理各种连接事件。</p>
</li>
<li>
<p>当有新的事件发生时，SubReactor 会调用连接对应的 Handler 进行响应。</p>
</li>
<li>
<p>Handler 通过 Read 读取数据后，会分发给后面的 Worker 线程池进行业务处理。</p>
</li>
<li>
<p>Worker 线程池会分配独立的线程完成真正的业务处理，如何将响应结果发给 Handler 进行处理。</p>
</li>
<li>
<p>Handler 收到响应结果后通过 Send 将响应结果返回给 Client。</p>
</li>
<li>
<p>优点：父线程与子线程的数据交互简单、职责明确，父线程只需要接收新连接，子线程完成后续的业务处理。</p>
</li>
</ul>
<p>父线程与子线程的数据交互简单，Reactor 主线程只需要把新连接传递给子线程即可，子线程无需返回数据。</p>
<p>这种模型在很多项目中广泛使用，包括 Nginx 主从 Reactor 多线程模型，Memcached 主从多线程。</p>
<h4 id=reactor-模式总结>Reactor 模式总结</h4>
<p>三种模式可以用一个比喻来理解：餐厅常常雇佣接待员负责迎接顾客，当顾客入座后，侍应生专门为这张桌子服务。</p>
<ul>
<li>单 Reactor 单线程：接待员和侍应生是同一个人，全程为顾客服务。</li>
<li>单 Reactor 多线程：一个接待员、多个侍应生，接待员只负责接待。</li>
<li>主从 Reactor：多个接待员，多个侍应生。</li>
</ul>
<p>Reactor 模式具有如下的优点：</p>
<ul>
<li>响应快：不必为单个同步时间所阻塞，虽然 Reactor 本身依然是同步的。</li>
<li>编程相对简单：可以最大程度的避免复杂的多线程及同步问题，并且避免了多线程的切换开销。</li>
<li>可扩展性：可以方便的通过增加 Reactor 实例个数来充分利用 CPU 资源。</li>
<li>可复用性：Reactor 模型本身与具体事件处理逻辑无关，具有很高的复用性。</li>
</ul>
<h3 id=proactor-模型>Proactor 模型</h3>
<p>在 Reactor 模式中，Reactor 等待某个事件、可应用或操作的状态发生(比如文件描述符可读、Socket 可读写)。</p>
<p>然后把该事件传递给事先注册的 Handler(事件处理函数或回调函数)，由后者来做实际的读写操作。</p>
<p>其中的读写操作都需要应用程序同步操作，所以 <strong>Reactor 是非阻塞同步网络模型</strong>。</p>
<p>如果把 IO 操作改为异步，即交给操作系统来完成 IO 操作，就能进一步提升性能，这就是异步网络模型 Proactor。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225214717.png style=display:block;width:50% alt=NAME align=center> </div>
<p>Proactor 是和异步 I/O 相关的，详细方案如下：</p>
<ul>
<li>ProactorInitiator 创建 Proactor 和 Handler 对象，并将 Proactor 和 Handler 都通过 AsyOptProcessor(Asynchronous Operation Processor) 注册到内核。</li>
<li>AsyOptProcessor 处理注册请求，并处理 I/O 操作。</li>
<li>AsyOptProcessor 完成 I/O 操作后通知 Proactor。</li>
<li>Proactor 根据不同的事件类型回调不同的 Handler 进行业务处理。</li>
<li>Handler 完成业务处理。</li>
</ul>
<p>可以看出 Proactor 和 Reactor 的区别：</p>
<ul>
<li>Reactor 是在事件发生时就通知事先注册的事件(读写在应用程序线程中处理完成)。</li>
<li>Proactor 是在事件发生时基于异步 I/O 完成读写操作(由内核完成)，待 I/O 操作完成后才回调应用程序的处理器来进行业务处理。</li>
</ul>
<p>理论上 Proactor 比 Reactor 效率更高，异步 I/O 更加充分发挥 DMA(Direct Memory Access，直接内存存取)的优势，但是有如下缺点：</p>
<ul>
<li><strong>编程复杂性</strong>：由于异步操作流程的事件的初始化和事件完成在时间和空间上都是相互分离的，因此开发异步应用程序更加复杂。应用程序还可能因为反向的流控而变得更加难以 Debug。</li>
<li><strong>内存使用</strong>：缓冲区在读或写操作的时间段内必须保持住，可能造成持续的不确定性，并且每个并发操作都要求有独立的缓存，相比 Reactor 模式，在 Socket 已经准备好读或写前，是不要求开辟缓存的。</li>
<li><strong>操作系统支持</strong>，Windows 下通过 IOCP 实现了真正的异步 I/O，而在 Linux 系统下，Linux 2.6 才引入，目前异步 I/O 还不完善。</li>
</ul>
<p>因此在 Linux 下实现高并发网络编程都是以 Reactor 模型为主。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3d6330bcf4302926c8990d2573910e68>4.8 - CH08-BIO原理</h1>
<h2 id=概览>概览</h2>
<p>BIO就是: blocking IO。最容易理解、最容易实现的IO工作方式，应用程序向操作系统请求网络IO操作，这时应用程序会一直等待；另一方面，操作系统收到请求后，也会等待，直到网络上有数据传到监听端口；操作系统在收集数据后，会把数据发送给应用程序；最后应用程序受到数据，并解除等待状态。</p>
<h2 id=概念>概念</h2>
<ul>
<li>
<p><code>阻塞IO</code> 和 <code>非阻塞IO</code></p>
<p>这两个概念是<code>程序级别</code>的。主要描述的是程序请求操作系统IO操作后，如果IO资源没有准备好，那么程序该如何处理的问题: 前者等待；后者继续执行(并且使用线程一直轮询，直到有IO资源准备好了)</p>
</li>
<li>
<p><code>同步IO</code> 和 <code>非同步IO</code></p>
<p>这两个概念是<code>操作系统级别</code>的。主要描述的是操作系统在收到程序请求IO操作后，如果IO资源没有准备好，该如何相应程序的问题: 前者不响应，直到IO资源准备好以后；后者返回一个标记(好让程序和自己知道以后的数据往哪里通知)，当IO资源准备好以后，再用事件机制返回给程序。</p>
</li>
</ul>
<h2 id=bio通信方式>BIO通信方式</h2>
<p>以前大多数网络通信方式都是阻塞模式的，即:</p>
<ul>
<li>客户端向服务器端发出请求后，客户端会一直等待(不会再做其他事情)，直到服务器端返回结果或者网络出现问题。</li>
<li>服务器端同样的，当在处理某个客户端A发来的请求时，另一个客户端B发来的请求会等待，直到服务器端的这个处理线程完成上一个处理。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501220158.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=传统的bio的问题>传统的BIO的问题</h3>
<ul>
<li>同一时间，服务器只能接受来自于客户端A的请求信息；虽然客户端A和客户端B的请求是同时进行的，但客户端B发送的请求信息只能等到服务器接受完A的请求数据后，才能被接受。</li>
<li>由于服务器一次只能处理一个客户端请求，当处理完成并返回后(或者异常时)，才能进行第二次请求的处理。很显然，这样的处理方式在高并发的情况下，是不能采用的。</li>
</ul>
<h3 id=多线程方式---伪异步方式>多线程方式 - 伪异步方式</h3>
<p>上面说的情况是服务器只有一个线程的情况，那么读者会直接提出我们可以使用多线程技术来解决这个问题:</p>
<ul>
<li>当服务器收到客户端X的请求后，(读取到所有请求数据后)将这个请求送入一个独立线程进行处理，然后主线程继续接受客户端Y的请求。</li>
<li>客户端一侧，也可以使用一个子线程和服务器端进行通信。这样客户端主线程的其他工作就不受影响了，当服务器端有响应信息的时候再由这个子线程通过 监听模式/观察模式(等其他设计模式)通知主线程。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221246.png style=display:block;width:50% alt=NAME align=center> </div>
<p>但是使用线程来解决这个问题实际上是有局限性的:</p>
<ul>
<li>虽然在服务器端，请求的处理交给了一个独立线程进行，但是操作系统通知accept()的方式还是单个的。也就是，实际上是服务器接收到数据报文后的“业务处理过程”可以多线程，但是数据报文的接受还是需要一个一个的来(下文的示例代码和debug过程我们可以明确看到这一点)</li>
<li>在linux系统中，可以创建的线程是有限的。我们可以通过cat /proc/sys/kernel/threads-max 命令查看可以创建的最大线程数。当然这个值是可以更改的，但是线程越多，CPU切换所需的时间也就越长，用来处理真正业务的需求也就越少。</li>
<li>创建一个线程是有较大的资源消耗的。JVM创建一个线程的时候，即使这个线程不做任何的工作，JVM都会分配一个堆栈空间。这个空间的大小默认为128K，您可以通过-Xss参数进行调整。当然您还可以使用ThreadPoolExecutor线程池来缓解线程的创建问题，但是又会造成BlockingQueue积压任务的持续增加，同样消耗了大量资源。</li>
<li>另外，如果您的应用程序大量使用长连接的话，线程是不会关闭的。这样系统资源的消耗更容易失控。 那么，如果你真想单纯使用线程解决阻塞的问题，那么您自己都可以算出来您一个服务器节点可以一次接受多大的并发了。看来，单纯使用线程解决这个问题不是最好的办法。</li>
</ul>
<h2 id=深入分析>深入分析</h2>
<p>BIO的问题关键不在于是否使用了多线程(包括线程池)处理这次请求，而在于accept()、read()的操作点都是被阻塞。要测试这个问题，也很简单。我们模拟了20个客户端(用20根线程模拟)，利用JAVA的同步计数器CountDownLatch，保证这20个客户都初始化完成后然后同时向服务器发送请求，然后我们来观察一下Server这边接受信息的情况。</p>
<h3 id=模拟20个客户端并发请求服务器端使用单线程>模拟20个客户端并发请求，服务器端使用单线程:</h3>
<p>客户端代码(SocketClientDaemon)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.CountDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketClientDaemon</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Integer</span> <span style=color:#000>clientNumber</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>20</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CountDownLatch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientNumber</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>//分别开始启动这20个客户端
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>index</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>clientNumber</span> <span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDown</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketClientRequestThread</span> <span style=color:#000>client</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>client</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>//这个wait不涉及到具体的实验逻辑，只是为了保证守护线程在启动所有线程后，进入等待状态
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>synchronized</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketClientDaemon</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketClientDaemon</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>wait</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>客户端代码(SocketClientRequestThread模拟请求)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.OutputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.Socket</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.CountDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.Log</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.LogFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.log4j.BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 一个SocketClientRequestThread线程模拟一个客户端请求。
</span><span style=color:#8f5902;font-style:italic> * @author yinwenjie
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketClientRequestThread</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 日志
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 这个线层的编号
</span><span style=color:#8f5902;font-style:italic>     * @param countDownLatch
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Integer</span> <span style=color:#000>clientIndex</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * countDownLatch是java提供的同步计数器。
</span><span style=color:#8f5902;font-style:italic>     * 当计数器数值减为0时，所有受其影响而等待的线程将会被激活。这样保证模拟并发请求的真实性
</span><span style=color:#8f5902;font-style:italic>     * @param countDownLatch
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CountDownLatch</span> <span style=color:#000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>clientIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDownLatch</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientIndex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clientIndex</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>OutputStream</span> <span style=color:#000>clientRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>clientResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Socket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>83</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>clientRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>clientResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//等待，直到SocketClientDaemon完成所有线程的启动，然后所有线程一起发送请求
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>countDownLatch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>await</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//发送请求信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>clientRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#4e9a06>&#34;这是第&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; 个客户端的请求。&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
            <span style=color:#000>clientRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flush</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#8f5902;font-style:italic>//在这里等待，直到服务器返回信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;第&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clientIndex</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;个客户端的请求发送完成，等待服务器返回信息&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#8f5902;font-style:italic>//程序执行到这里，会一直等待服务器返回信息(注意，前提是in和out都不能close，如果close了就收不到服务器的反馈了)
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>realLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>clientResponse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;接收到来自服务器的信息:&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientRequest</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>clientRequest</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>clientResponse</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>clientResponse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SocketClientRequestThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>服务器端(SocketServer1)单个线程</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.OutputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.ServerSocket</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.Socket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.Log</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.LogFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.log4j.BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketServer1</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 日志
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketServer1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ServerSocket</span> <span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerSocket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>83</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#8f5902;font-style:italic>//下面我们收取信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>InputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>OutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>Integer</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPort</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>2048</span><span style=color:#ce5c00;font-weight:700>;</span>
                <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>];</span>
                <span style=color:#8f5902;font-style:italic>//这里也会被阻塞，直到有数据准备好
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>realLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#8f5902;font-style:italic>//读取信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>//下面打印信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>SocketServer1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;服务器收到来自于端口: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;的信息: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>//下面开始发送信息
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;回发响应信息！&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>

                <span style=color:#8f5902;font-style:italic>//关闭
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketServer1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=多线程来优化服务器端>多线程来优化服务器端</h3>
<p>客户端代码和上文一样，最主要是更改服务器端的代码:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>testBSocket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.IOException</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.InputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.OutputStream</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.ServerSocket</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.net.Socket</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.Log</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.commons.logging.LogFactory</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.log4j.BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketServer2</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>BasicConfigurator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configure</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketServer2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>ServerSocket</span> <span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServerSocket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>83</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#8f5902;font-style:italic>//当然业务处理过程可以交给一个线程(这里可以使用线程池),并且线程的创建是很耗资源的。
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>//最终改变不了.accept()只能一个一个接受socket的情况,并且被阻塞的情况
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>SocketServerThread</span> <span style=color:#000>socketServerThread</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>socketServerThread</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>start</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketServer2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * 当然，接收到客户端的socket后，业务的处理过程可以交给一个线程来做。
</span><span style=color:#8f5902;font-style:italic> * 但还是改变不了socket被一个一个的做accept()的情况。
</span><span style=color:#8f5902;font-style:italic> * @author yinwenjie
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SocketServerThread</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>Runnable</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * 日志
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Log</span> <span style=color:#000>LOGGER</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LogFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Socket</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>SocketServerThread</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Socket</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>;</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#5c35cc;font-weight:700>@Override</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>InputStream</span> <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>OutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//下面我们收取信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getInputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Integer</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPort</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#8f5902;font-style:italic>//使用线程，同样无法解决read方法的阻塞问题，
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//也就是说read方法处同样会被阻塞，直到操作系统有数据准备好
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>realLen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>maxLen</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>//读取信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contextBytes</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span> <span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>realLen</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>//下面打印信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;服务器收到来自于端口: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sourcePort</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;的信息: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>//下面开始发送信息
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;回发响应信息！&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>//试图关闭
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>SocketServerThread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>LOGGER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=优化效果>优化效果</h3>
<p>我们主要看一看服务器使用多线程处理时的情况:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221456.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=问题根源>问题根源</h3>
<p>那么重点的问题并不是“是否使用了多线程”，而是为什么accept()、read()方法会被阻塞。即: 异步IO模式 就是为了解决这样的并发性存在的。但是为了说清楚异步IO模式，在介绍IO模式的时候，我们就要首先了解清楚，什么是 阻塞式同步、非阻塞式同步、多路复用同步模式。</p>
<p>API文档中对于 serverSocket.accept() 方法的使用描述:</p>
<blockquote>
<p>Listens for a connection to be made to this socket and accepts it. The method blocks until a connection is made.</p>
</blockquote>
<p>serverSocket.accept()会被阻塞? 这里涉及到阻塞式同步IO的工作原理:</p>
<ul>
<li>服务器线程发起一个accept动作，询问操作系统 是否有新的socket套接字信息从端口X发送过来。</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221526.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>注意，是询问操作系统。也就是说socket套接字的IO模式支持是基于操作系统的，那么自然同步IO/异步IO的支持就是需要操作系统级别的了。如下图:</li>
</ul>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221543.png style=display:block;width:50% alt=NAME align=center> </div>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221553.png style=display:block;width:50% alt=NAME align=center> </div>
<p>如果操作系统没有发现有套接字从指定的端口X来，那么操作系统就会等待。这样serverSocket.accept()方法就会一直等待。这就是为什么accept()方法为什么会阻塞: 它内部的实现是使用的操作系统级别的同步IO。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-37086be27cb4e2dc026ba972768fcb2d>4.9 - CH09-NIO基础</h1>
<p>Standard IO是对字节流的读写，在进行IO之前，首先创建一个流对象，流对象进行读写操作都是按字节 ，一个字节一个字节的来读或写。而NIO把IO抽象成块，类似磁盘的读写，每次IO操作的单位都是一个块，块被读入内存之后就是一个byte[]，NIO一次可以读或写多个字节。</p>
<h2 id=流与块>流与块</h2>
<p>I/O 与 NIO 最重要的区别是数据打包和传输的方式，I/O 以流的方式处理数据，而 NIO 以块的方式处理数据。</p>
<p>面向流的 I/O 一次处理一个字节数据: 一个输入流产生一个字节数据，一个输出流消费一个字节数据。为流式数据创建过滤器非常容易，链接几个过滤器，以便每个过滤器只负责复杂处理机制的一部分。不利的一面是，面向流的 I/O 通常相当慢。</p>
<p>面向块的 I/O 一次处理一个数据块，按块处理数据比按流处理数据要快得多。但是面向块的 I/O 缺少一些面向流的 I/O 所具有的优雅性和简单性。</p>
<p>I/O 包和 NIO 已经很好地集成了，java.io.* 已经以 NIO 为基础重新实现了，所以现在它可以利用 NIO 的一些特性。例如，java.io.* 包中的一些类包含以块的形式读写数据的方法，这使得即使在面向流的系统中，处理速度也会更快。</p>
<h2 id=通道与缓冲区>通道与缓冲区</h2>
<h3 id=通道>通道</h3>
<p>通道 Channel 是对原 I/O 包中的流的模拟，可以通过它读取和写入数据。</p>
<p>通道与流的不同之处在于，流只能在一个方向上移动(一个流必须是 InputStream 或者 OutputStream 的子类)，而通道是双向的，可以用于读、写或者同时用于读写。</p>
<p>通道包括以下类型:</p>
<ul>
<li>FileChannel: 从文件中读写数据；</li>
<li>DatagramChannel: 通过 UDP 读写网络中数据；</li>
<li>SocketChannel: 通过 TCP 读写网络中数据；</li>
<li>ServerSocketChannel: 可以监听新进来的 TCP 连接，对每一个新进来的连接都会创建一个 SocketChannel。</li>
</ul>
<h3 id=缓冲区>缓冲区</h3>
<p>发送给一个通道的所有数据都必须首先放到缓冲区中，同样地，从通道中读取的任何数据都要先读到缓冲区中。也就是说，不会直接对通道进行读写数据，而是要先经过缓冲区。</p>
<p>缓冲区实质上是一个数组，但它不仅仅是一个数组。缓冲区提供了对数据的结构化访问，而且还可以跟踪系统的读/写进程。</p>
<p>缓冲区包括以下类型:</p>
<ul>
<li>ByteBuffer</li>
<li>CharBuffer</li>
<li>ShortBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>FloatBuffer</li>
<li>DoubleBuffer</li>
</ul>
<h2 id=缓冲区状态变量>缓冲区状态变量</h2>
<ul>
<li>capacity: 最大容量；</li>
<li>position: 当前已经读写的字节数；</li>
<li>limit: 还可以读写的字节数。</li>
</ul>
<p>状态变量的改变过程举例:</p>
<p>① 新建一个大小为 8 个字节的缓冲区，此时 position 为 0，而 limit = capacity = 8。capacity 变量不会改变，下面的讨论会忽略它。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221838.png style=display:block;width:50% alt=NAME align=center> </div>
<p>② 从输入通道中读取 5 个字节数据写入缓冲区中，此时 position 移动设置为 5，limit 保持不变。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221857.png style=display:block;width:50% alt=NAME align=center> </div>
<p>③ 在将缓冲区的数据写到输出通道之前，需要先调用 flip() 方法，这个方法将 limit 设置为当前 position，并将 position 设置为 0。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221908.png style=display:block;width:50% alt=NAME align=center> </div>
<p>④ 从缓冲区中取 4 个字节到输出缓冲中，此时 position 设为 4。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221932.png style=display:block;width:50% alt=NAME align=center> </div>
<p>⑤ 最后需要调用 clear() 方法来清空缓冲区，此时 position 和 limit 都被设置为最初位置。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501221945.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=文件-nio-实例>文件 NIO 实例</h2>
<p>以下展示了使用 NIO 快速复制文件的实例:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fastCopy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#8f5902;font-style:italic>/* 获得源文件的输入字节流 */</span>
    <span style=color:#000>FileInputStream</span> <span style=color:#000>fin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 获取输入字节流的文件通道 */</span>
    <span style=color:#000>FileChannel</span> <span style=color:#000>fcin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/* 获取目标文件的输出字节流 */</span>
    <span style=color:#000>FileOutputStream</span> <span style=color:#000>fout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dist</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#8f5902;font-style:italic>/* 获取输出字节流的通道 */</span>
    <span style=color:#000>FileChannel</span> <span style=color:#000>fcout</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>();</span>

    <span style=color:#8f5902;font-style:italic>/* 为缓冲区分配 1024 个字节 */</span>
    <span style=color:#000>ByteBuffer</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocateDirect</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#8f5902;font-style:italic>/* 从输入通道中读取数据到缓冲区中 */</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fcin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#8f5902;font-style:italic>/* read() 返回 -1 表示 EOF */</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#ce5c00;font-weight:700>}</span>

        <span style=color:#8f5902;font-style:italic>/* 切换读写 */</span>
        <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#8f5902;font-style:italic>/* 把缓冲区的内容写入输出文件中 */</span>
        <span style=color:#000>fcout</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>
        
        <span style=color:#8f5902;font-style:italic>/* 清空缓冲区 */</span>
        <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=选择器>选择器</h2>
<p>NIO 常常被叫做非阻塞 IO，主要是因为 NIO 在网络通信中的非阻塞特性被广泛使用。</p>
<p>NIO 实现了 IO 多路复用中的 Reactor 模型，一个线程 Thread 使用一个选择器 Selector 通过轮询的方式去监听多个通道 Channel 上的事件，从而让一个线程就可以处理多个事件。</p>
<p>通过配置监听的通道 Channel 为非阻塞，那么当 Channel 上的 IO 事件还未到达时，就不会进入阻塞状态一直等待，而是继续轮询其它 Channel，找到 IO 事件已经到达的 Channel 执行。</p>
<p>因为创建和切换线程的开销很大，因此使用一个线程来处理多个事件而不是一个线程处理一个事件具有更好的性能。</p>
<p>应该注意的是，只有套接字 Channel 才能配置为非阻塞，而 FileChannel 不能，为 FileChannel 配置非阻塞也没有意义。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210501222022.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=1-创建选择器>1. 创建选择器</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Selector</span> <span style=color:#000>selector</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><h3 id=2-将通道注册到选择器上>2. 将通道注册到选择器上</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ssChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configureBlocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_ACCEPT</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>通道必须配置为非阻塞模式，否则使用选择器就没有任何意义了，因为如果通道在某个事件上被阻塞，那么服务器就不能响应其它事件，必须等待这个事件处理完毕才能去处理其它事件，显然这和选择器的作用背道而驰。</p>
<p>在将通道注册到选择器上时，还需要指定要注册的具体事件，主要有以下几类:</p>
<ul>
<li>SelectionKey.OP_CONNECT</li>
<li>SelectionKey.OP_ACCEPT</li>
<li>SelectionKey.OP_READ</li>
<li>SelectionKey.OP_WRITE</li>
</ul>
<p>它们在 SelectionKey 的定义如下:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_READ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_WRITE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_CONNECT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>OP_ACCEPT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>4</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><p>可以看出每个事件可以被当成一个位域，从而组成事件集整数。例如:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>interestSet</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_READ</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_WRITE</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><h3 id=监听事件>监听事件</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div><p>使用 select() 来监听到达的事件，它会一直阻塞直到有至少一个事件到达。</p>
<h3 id=4-获取到达的事件>4. 获取到达的事件</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectedKeys</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAcceptable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=5-事件循环>5. 事件循环</h3>
<p>因为一次 select() 调用不能处理完所有的事件，并且服务器端有可能需要一直监听事件，因此服务器端处理事件的代码一般会放在一个死循环内。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>num</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectedKeys</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAcceptable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=套接字-nio-实例>套接字 NIO 实例</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NIOServer</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>Selector</span> <span style=color:#000>selector</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ssChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>open</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configureBlocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_ACCEPT</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#000>ServerSocket</span> <span style=color:#000>serverSocket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ssChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>socket</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>InetSocketAddress</span> <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InetSocketAddress</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>8888</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>serverSocket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>bind</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>);</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>select</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keys</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>selectedKeys</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#000>Iterator</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>iterator</span><span style=color:#ce5c00;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                <span style=color:#000>SelectionKey</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>();</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAcceptable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                    <span style=color:#000>ServerSocketChannel</span> <span style=color:#000>ssChannel1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>();</span>

                    <span style=color:#8f5902;font-style:italic>// 服务器会为每个新连接创建一个 SocketChannel
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>SocketChannel</span> <span style=color:#000>sChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ssChannel1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>accept</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>configureBlocking</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>);</span>

                    <span style=color:#8f5902;font-style:italic>// 这个新连接主要用于从客户端读取数据
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>register</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>selector</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SelectionKey</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>OP_READ</span><span style=color:#ce5c00;font-weight:700>);</span>

                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isReadable</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>

                    <span style=color:#000>SocketChannel</span> <span style=color:#000>sChannel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>channel</span><span style=color:#ce5c00;font-weight:700>();</span>
                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readDataFromSocketChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>));</span>
                    <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
                <span style=color:#ce5c00;font-weight:700>}</span>

                <span style=color:#000>keyIterator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>remove</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>String</span> <span style=color:#000>readDataFromSocketChannel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SocketChannel</span> <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>

        <span style=color:#000>ByteBuffer</span> <span style=color:#000>buffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ByteBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>allocate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>StringBuilder</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#ce5c00;font-weight:700>();</span>

        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>

            <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>break</span><span style=color:#ce5c00;font-weight:700>;</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>flip</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>limit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>limit</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dst</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>limit</span><span style=color:#ce5c00;font-weight:700>];</span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>limit</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>);</span>
            <span style=color:#000>buffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NIOClient</span> <span style=color:#ce5c00;font-weight:700>{</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>IOException</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Socket</span> <span style=color:#000>socket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Socket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>8888</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#000>OutputStream</span> <span style=color:#000>out</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>socket</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getOutputStream</span><span style=color:#ce5c00;font-weight:700>();</span>
        <span style=color:#000>String</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;hello world&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBytes</span><span style=color:#ce5c00;font-weight:700>());</span>
        <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=内存映射文件>内存映射文件</h2>
<p>内存映射文件 I/O 是一种读和写文件数据的方法，它可以比常规的基于流或者基于通道的 I/O 快得多。</p>
<p>向内存映射文件写入可能是危险的，只是改变数组的单个元素这样的简单操作，就可能会直接修改磁盘上的文件。修改数据与将数据保存到磁盘是没有分开的。</p>
<p>下面代码行将文件的前 1024 个字节映射到内存中，map() 方法返回一个 MappedByteBuffer，它是 ByteBuffer 的子类。因此，可以像使用其他任何 ByteBuffer 一样使用新映射的缓冲区，操作系统会在需要时负责执行映射。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>MappedByteBuffer</span> <span style=color:#000>mbb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FileChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MapMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>READ_WRITE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><h2 id=对比>对比</h2>
<p>NIO 与普通 I/O 的区别主要有以下两点:</p>
<ul>
<li>NIO 是非阻塞的</li>
<li>NIO 面向块，I/O 面向流</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-da781159746dd7bd152d97f3a8350579>4.10 - CH10-NIO原理</h1>
<h2 id=现实场景>现实场景</h2>
<p>我们试想一下这样的现实场景:</p>
<p>一个餐厅同时有100位客人到店，当然到店后第一件要做的事情就是点菜。但是问题来了，餐厅老板为了节约人力成本目前只有一位大堂服务员拿着唯一的一本菜单等待客人进行服务。</p>
<ul>
<li>那么最笨(但是最简单)的方法是(方法A)，无论有多少客人等待点餐，服务员都把仅有的一份菜单递给其中一位客人，然后站在客人身旁等待这个客人完成点菜过程。在记录客人点菜内容后，把点菜记录交给后堂厨师。然后是第二位客人。。。。然后是第三位客人。很明显，只有脑袋被门夹过的老板，才会这样设置服务流程。因为随后的80位客人，再等待超时后就会离店(还会给差评)。</li>
<li>于是还有一种办法(方法B)，老板马上新雇佣99名服务员，同时印制99本新的菜单。每一名服务员手持一本菜单负责一位客人(关键不只在于服务员，还在于菜单。因为没有菜单客人也无法点菜)。在客人点完菜后，记录点菜内容交给后堂厨师(当然为了更高效，后堂厨师最好也有100名)。这样每一位客人享受的就是VIP服务咯，当然客人不会走，但是人力成本可是一个大头哦(亏死你)。</li>
<li>另外一种办法(方法C)，就是改进点菜的方式，当客人到店后，自己申请一本菜单。想好自己要点的才后，就呼叫服务员。服务员站在自己身边后记录客人的菜单内容。将菜单递给厨师的过程也要进行改进，并不是每一份菜单记录好以后，都要交给后堂厨师。服务员可以记录号多份菜单后，同时交给厨师就行了。那么这种方式，对于老板来说人力成本是最低的；对于客人来说，虽然不再享受VIP服务并且要进行一定的等待，但是这些都是可接受的；对于服务员来说，基本上她的时间都没有浪费，基本上被老板压杆了最后一滴油水。</li>
</ul>
<p>如果您是老板，您会采用哪种方式呢?</p>
<p>到店情况: 并发量。到店情况不理想时，一个服务员一本菜单，当然是足够了。所以不同的老板在不同的场合下，将会灵活选择服务员和菜单的配置。</p>
<ul>
<li>客人: 客户端请求</li>
<li>点餐内容: 客户端发送的实际数据</li>
<li>老板: 操作系统</li>
<li>人力成本: 系统资源</li>
<li>菜单: 文件状态描述符。操作系统对于一个进程能够同时持有的文件状态描述符的个数是有限制的，在linux系统中$ulimit -n查看这个限制值，当然也是可以(并且应该)进行内核参数调整的。</li>
<li>服务员: 操作系统内核用于IO操作的线程(内核线程)</li>
<li>厨师: 应用程序线程(当然厨房就是应用程序进程咯)</li>
<li>餐单传递方式: 包括了阻塞式和非阻塞式两种。
<ul>
<li>方法A: 阻塞式/非阻塞式 同步IO</li>
<li>方法B: 使用线程进行处理的 阻塞式/非阻塞式 同步IO</li>
<li>方法C: 阻塞式/非阻塞式 多路复用IO</li>
</ul>
</li>
</ul>
<h2 id=典型的多路复用io实现>典型的多路复用IO实现</h2>
<p>目前流程的多路复用IO实现主要包括四种: <code>select</code>、<code>poll</code>、<code>epoll</code>、<code>kqueue</code>。下表是他们的一些重要特性的比较:</p>
<table>
<thead>
<tr>
<th>IO模型</th>
<th>相对性能</th>
<th>关键思路</th>
<th>操作系统</th>
<th>JAVA支持情况</th>
</tr>
</thead>
<tbody>
<tr>
<td>select</td>
<td>较高</td>
<td>Reactor</td>
<td>windows/Linux</td>
<td>支持,Reactor模式(反应器设计模式)。Linux操作系统的 kernels 2.4内核版本之前，默认使用select；而目前windows下对同步IO的支持，都是select模型</td>
</tr>
<tr>
<td>poll</td>
<td>较高</td>
<td>Reactor</td>
<td>Linux</td>
<td>Linux下的JAVA NIO框架，Linux kernels 2.6内核版本之前使用poll进行支持。也是使用的Reactor模式</td>
</tr>
<tr>
<td>epoll</td>
<td>高</td>
<td>Reactor/Proactor</td>
<td>Linux</td>
<td>Linux kernels 2.6内核版本及以后使用epoll进行支持；Linux kernels 2.6内核版本之前使用poll进行支持；另外一定注意，由于Linux下没有Windows下的IOCP技术提供真正的 异步IO 支持，所以Linux下使用epoll模拟异步IO</td>
</tr>
<tr>
<td>kqueue</td>
<td>高</td>
<td>Proactor</td>
<td>Linux</td>
<td>目前JAVA的版本不支持</td>
</tr>
</tbody>
</table>
<p>多路复用IO技术最适用的是“高并发”场景，所谓高并发是指1毫秒内至少同时有上千个连接请求准备好。其他情况下多路复用IO技术发挥不出来它的优势。另一方面，使用JAVA NIO进行功能实现，相对于传统的Socket套接字实现要复杂一些，所以实际应用中，需要根据自己的业务需求进行技术选择。</p>
<h2 id=reactor模型和proactor模型>Reactor模型和Proactor模型</h2>
<h2 id=java对多路复用io的支持>JAVA对多路复用IO的支持</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140322.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=重要概念-channel>重要概念: Channel</h3>
<p>通道，被建立的一个应用程序和操作系统交互事件、传递内容的渠道(注意是连接到操作系统)。一个通道会有一个专属的文件状态描述符。那么既然是和操作系统进行内容的传递，那么说明应用程序可以通过通道读取数据，也可以通过通道向操作系统写数据。</p>
<p>JDK API中的Channel的描述是:</p>
<blockquote>
<p>A channel represents an open connection to an entity such as a hardware device, a file, a network socket, or a program component that is capable of performing one or more distinct I/O operations, for example reading or writing.</p>
</blockquote>
<blockquote>
<p>A channel is either open or closed. A channel is open upon creation, and once closed it remains closed. Once a channel is closed, any attempt to invoke an I/O operation upon it will cause a ClosedChannelException to be thrown. Whether or not a channel is open may be tested by invoking its isOpen method.</p>
</blockquote>
<p>JAVA NIO 框架中，自有的Channel通道包括:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140348.png style=display:block;width:50% alt=NAME align=center> </div>
<p>所有被Selector(选择器)注册的通道，只能是继承了SelectableChannel类的子类。如上图所示</p>
<ul>
<li>ServerSocketChannel: 应用服务器程序的监听通道。只有通过这个通道，应用程序才能向操作系统注册支持“多路复用IO”的端口监听。同时支持UDP协议和TCP协议。</li>
<li>ScoketChannel: TCP Socket套接字的监听通道，一个Socket套接字对应了一个客户端IP: 端口 到 服务器IP: 端口的通信连接。</li>
<li>DatagramChannel: UDP 数据报文的监听通道。</li>
</ul>
<h3 id=重要概念-buffer>重要概念: Buffer</h3>
<p>数据缓存区: 在JAVA NIO 框架中，为了保证每个通道的数据读写速度JAVA NIO 框架为每一种需要支持数据读写的通道集成了Buffer的支持。</p>
<p>这句话怎么理解呢? 例如ServerSocketChannel通道它只支持对OP_ACCEPT事件的监听，所以它是不能直接进行网络数据内容的读写的。所以ServerSocketChannel是没有集成Buffer的。</p>
<p>Buffer有两种工作模式: 写模式和读模式。在读模式下，应用程序只能从Buffer中读取数据，不能进行写操作。但是在写模式下，应用程序是可以进行读操作的，这就表示可能会出现脏读的情况。所以一旦您决定要从Buffer中读取数据，一定要将Buffer的状态改为读模式。</p>
<p>如下图:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140412.png style=display:block;width:50% alt=NAME align=center> </div>
<ul>
<li>position: 缓存区目前这在操作的数据块位置</li>
<li>limit: 缓存区最大可以进行操作的位置。缓存区的读写状态正式由这个属性控制的。</li>
<li>capacity: 缓存区的最大容量。这个容量是在缓存区创建时进行指定的。由于高并发时通道数量往往会很庞大，所以每一个缓存区的容量最好不要过大。</li>
</ul>
<p>在下文JAVA NIO框架的代码实例中，我们将进行Buffer缓存区操作的演示。</p>
<h3 id=重要概念-selector>重要概念: Selector</h3>
<p>Selector的英文含义是“选择器”，不过根据我们详细介绍的Selector的岗位职责，您可以把它称之为“轮询代理器”、“事件订阅器”、“channel容器管理机”都行。</p>
<ul>
<li>事件订阅和Channel管理</li>
</ul>
<p>应用程序将向Selector对象注册需要它关注的Channel，以及具体的某一个Channel会对哪些IO事件感兴趣。Selector中也会维护一个“已经注册的Channel”的容器。以下代码来自WindowsSelectorImpl实现类中，对已经注册的Channel的管理容器:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>// Initial capacity of the poll array
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>INIT_CAP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>8</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#8f5902;font-style:italic>// Maximum number of sockets for select().
</span><span style=color:#8f5902;font-style:italic>// Should be INIT_CAP times a power of 2
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>MAX_SELECTABLE_FDS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>1024</span><span style=color:#ce5c00;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>// The list of SelectableChannels serviced by this Selector. Every mod
</span><span style=color:#8f5902;font-style:italic>// MAX_SELECTABLE_FDS entry is bogus, to align this array with the poll
</span><span style=color:#8f5902;font-style:italic>// array,  where the corresponding entry is occupied by the wakeupSocket
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SelectionKeyImpl</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>channelArray</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SelectionKeyImpl</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>INIT_CAP</span><span style=color:#ce5c00;font-weight:700>];</span>
</code></pre></div><ul>
<li>轮询代理</li>
</ul>
<p>应用层不再通过阻塞模式或者非阻塞模式直接询问操作系统“事件有没有发生”，而是由Selector代其询问。</p>
<ul>
<li>实现不同操作系统的支持</li>
</ul>
<p>之前已经提到过，多路复用IO技术 是需要操作系统进行支持的，其特点就是操作系统可以同时扫描同一个端口上不同网络连接的事件。所以作为上层的JVM，必须要为 不同操作系统的多路复用IO实现 编写不同的代码。同样我使用的测试环境是Windows，它对应的实现类是sun.nio.ch.WindowsSelectorImpl:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140645.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=java-nio-框架简要设计分析>JAVA NIO 框架简要设计分析</h3>
<p>通过上文的描述，我们知道了多路复用IO技术是操作系统的内核实现。在不同的操作系统，甚至同一系列操作系统的版本中所实现的多路复用IO技术都是不一样的。那么作为跨平台的JAVA JVM来说如何适应多种多样的多路复用IO技术实现呢? 面向对象的威力就显现出来了: 无论使用哪种实现方式，他们都会有“选择器”、“通道”、“缓存”这几个操作要素，那么可以为不同的多路复用IO技术创建一个统一的抽象组，并且为不同的操作系统进行具体的实现。JAVA NIO中对各种多路复用IO的支持，主要的基础是java.nio.channels.spi.SelectorProvider抽象类，其中的几个主要抽象方法包括:</p>
<ul>
<li>public abstract DatagramChannel openDatagramChannel(): 创建和这个操作系统匹配的UDP 通道实现。</li>
<li>public abstract AbstractSelector openSelector(): 创建和这个操作系统匹配的NIO选择器，就像上文所述，不同的操作系统，不同的版本所默认支持的NIO模型是不一样的。</li>
<li>public abstract ServerSocketChannel openServerSocketChannel(): 创建和这个NIO模型匹配的服务器端通道。</li>
<li>public abstract SocketChannel openSocketChannel(): 创建和这个NIO模型匹配的TCP Socket套接字通道(用来反映客户端的TCP连接)</li>
</ul>
<p>由于JAVA NIO框架的整个设计是很大的，所以我们只能还原一部分我们关心的问题。这里我们以JAVA NIO框架中对于不同多路复用IO技术的选择器 进行实例化创建的方式作为例子，以点窥豹观全局:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502140712.png style=display:block;width:50% alt=NAME align=center> </div>
<p>很明显，不同的SelectorProvider实现对应了不同的 选择器。由具体的SelectorProvider实现进行创建。另外说明一下，实际上netty底层也是通过这个设计获得具体使用的NIO模型，我们后文讲解Netty时，会讲到这个问题。以下代码是Netty 4.0中NioServerSocketChannel进行实例化时的核心代码片段:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>ServerSocketChannel</span> <span style=color:#000>newSocket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SelectorProvider</span> <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>            *  Use the {@link SelectorProvider} to open {@link SocketChannel} and so remove condition in
</span><span style=color:#8f5902;font-style:italic>            *  {@link SelectorProvider#provider()} which is called by each ServerSocketChannel.open() otherwise.
</span><span style=color:#8f5902;font-style:italic>            *
</span><span style=color:#8f5902;font-style:italic>            *  See &lt;a href=&#34;See https://github.com/netty/netty/issues/2308&#34;&gt;#2308&lt;/a&gt;.
</span><span style=color:#8f5902;font-style:italic>            */</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>provider</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>openServerSocketChannel</span><span style=color:#ce5c00;font-weight:700>();</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ChannelException</span><span style=color:#ce5c00;font-weight:700>(</span>
                <span style=color:#4e9a06>&#34;Failed to open a server socket.&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=多路复用io的优缺点>多路复用IO的优缺点</h2>
<p>不用再使用多线程来进行IO处理了(包括操作系统内核IO管理模块和应用程序进程而言)。当然实际业务的处理中，应用程序进程还是可以引入线程池技术的</p>
<p>同一个端口可以处理多种协议，例如，使用ServerSocketChannel测测的服务器端口监听，既可以处理TCP协议又可以处理UDP协议。</p>
<p>操作系统级别的优化: 多路复用IO技术可以是操作系统级别在一个端口上能够同时接受多个客户端的IO事件。同时具有之前我们讲到的阻塞式同步IO和非阻塞式同步IO的所有特点。Selector的一部分作用更相当于“轮询代理器”。</p>
<p>都是同步IO: 目前我们介绍的 阻塞式IO、非阻塞式IO甚至包括多路复用IO，这些都是基于操作系统级别对“同步IO”的实现。我们一直在说“同步IO”，一直都没有详细说，什么叫做“同步IO”。实际上一句话就可以说清楚: 只有上层(包括上层的某种代理机制)系统询问我是否有某个事件发生了，否则我不会主动告诉上层系统事件发生了。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e8064dcc899de72ab1295366b642e4a2>4.11 - CH11-AIO原理</h1>
<h2 id=异步io>异步IO</h2>
<p>上面两篇文章中，我们分别讲解了阻塞式同步IO、非阻塞式同步IO、多路复用IO 这三种IO模型，以及JAVA对于这三种IO模型的支持。重点说明了IO模型是由操作系统提供支持，且这三种IO模型都是同步IO，都是采用的“应用程序不询问我，我绝不会主动通知”的方式。</p>
<p>异步IO则是采用“订阅-通知”模式: 即应用程序向操作系统注册IO监听，然后继续做自己的事情。当操作系统发生IO事件，并且准备好数据后，在主动通知应用程序，触发相应的函数:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141006.png style=display:block;width:50% alt=NAME align=center> </div>
<p>和同步IO一样，异步IO也是由操作系统进行支持的。微软的windows系统提供了一种异步IO技术: IOCP(I/O Completion Port，I/O完成端口)；</p>
<p>Linux下由于没有这种异步IO技术，所以使用的是epoll(上文介绍过的一种多路复用IO技术的实现)对异步IO进行模拟。</p>
<h3 id=java-aio框架简析>JAVA AIO框架简析</h3>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141030.png style=display:block;width:50% alt=NAME align=center> </div>
<p>这里通过这个结构分析要告诉各位读者JAVA AIO中类设计和操作系统的相关性</p>
<p>在文中我们一再说明JAVA AIO框架在windows下使用windows IOCP技术，在Linux下使用epoll多路复用IO技术模拟异步IO，这个从JAVA AIO框架的部分类设计上就可以看出来。例如框架中，在Windows下负责实现套接字通道的具体类是“sun.nio.ch.WindowsAsynchronousSocketChannelImpl”，其引用的IOCP类型文档注释如是:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#8f5902;font-style:italic>/** 
</span><span style=color:#8f5902;font-style:italic>* Windows implementation of AsynchronousChannelGroup encapsulating an I/O 
</span><span style=color:#8f5902;font-style:italic>* completion port. 
</span><span style=color:#8f5902;font-style:italic>*/</span>
</code></pre></div><p>如果您感兴趣，当然可以去看看全部完整代码(建议从“java.nio.channels.spi.AsynchronousChannelProvider”这个类看起)。</p>
<p>特别说明一下，请注意图中的“java.nio.channels.NetworkChannel”接口，这个接口同样被JAVA NIO框架实现了，如下图所示:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141056.png style=display:block;width:50% alt=NAME align=center> </div>
<h3 id=要点讲解>要点讲解</h3>
<p>注意在JAVA NIO框架中，我们说到了一个重要概念“selector”(选择器)。它负责代替应用查询中所有已注册的通道到操作系统中进行IO事件轮询、管理当前注册的通道集合，定位发生事件的通道等操操作；但是在JAVA AIO框架中，由于应用程序不是“轮询”方式，而是订阅-通知方式，所以不再需要“selector”(选择器)了，改由channel通道直接到操作系统注册监听。</p>
<p>JAVA AIO框架中，只实现了两种网络IO通道“AsynchronousServerSocketChannel”(服务器监听通道)、“AsynchronousSocketChannel”(socket套接字通道)。但是无论哪种通道他们都有独立的fileDescriptor(文件标识符)、attachment(附件，附件可以使任意对象，类似“通道上下文”)，并被独立的SocketChannelReadHandle类实例引用。我们通过debug操作来看看它们的引用结构:</p>
<p>在测试过程中，我们启动了两个客户端(客户端用什么语言来写都行，用阻塞或者非阻塞方式也都行，只要是支持 TCP Socket套接字的就行，然后我们观察服务器端对这两个客户端通道的处理情况:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141123.png style=display:block;width:50% alt=NAME align=center> </div>
<p>可以看到，在服务器端分别为客户端1和客户端2创建的两个WindowsAsynchronousSocketChannelImpl对象为:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141141.png style=display:block;width:50% alt=NAME align=center> </div>
<p>客户端1: WindowsAsynchronousSocketChannelImpl: 760 | FileDescriptor: 762</p>
<p>客户端2: WindowsAsynchronousSocketChannelImpl: 792 | FileDescriptor: 797</p>
<p>接下来，我们让两个客户端发送信息到服务器端，并观察服务器端的处理情况。客户端1发来的消息和客户端2发来的消息，在服务器端的处理情况如下图所示:</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20210502141156.png style=display:block;width:50% alt=NAME align=center> </div>
<p>客户端1: WindowsAsynchronousSocketChannelImpl: 760 | FileDescriptor: 762 | SocketChannelReadHandle: 803 | HeapByteBuffer: 808</p>
<p>客户端2: WindowsAsynchronousSocketChannelImpl: 792 | FileDescriptor: 797 | SocketChannelReadHandle: 828 | HeapByteBuffer: 833</p>
<p>可以明显看到，服务器端处理每一个客户端通道所使用的SocketChannelReadHandle(处理器)对象都是独立的，并且所引用的SocketChannel对象都是独立的。</p>
<p>JAVA NIO和JAVA AIO框架，除了因为操作系统的实现不一样而去掉了Selector外，其他的重要概念都是存在的，例如上文中提到的Channel的概念，还有演示代码中使用的Buffer缓存方式。实际上JAVA NIO和JAVA AIO框架您可以看成是一套完整的“高并发IO处理”的实现。</p>
<h3 id=还有改进可能>还有改进可能</h3>
<p>当然，以上代码是示例代码，目标是为了让您了解JAVA AIO框架的基本使用。所以它还有很多改造的空间，例如:</p>
<p>在生产环境下，我们需要记录这个通道上“用户的登录信息”。那么这个需求可以使用JAVA AIO中的“附件”功能进行实现。</p>
<p>记住JAVA AIO 和 JAVA NIO 框架都是要使用线程池的(当然您也可以不用)，线程池的使用原则，一定是只有业务处理部分才使用，使用后马上结束线程的执行(还回线程池或者消灭它)。JAVA AIO框架中还有一个线程池，是拿给“通知处理器”使用的，这是因为JAVA AIO框架是基于“订阅-通知”模型的，“订阅”操作可以由主线程完成，但是您总不能要求在应用程序中并发的“通知”操作也在主线程上完成吧^_^。</p>
<p>最好的改进方式，当然就是使用Netty或者Mina咯</p>
<h2 id=为什么还有netty>为什么还有Netty</h2>
<ul>
<li>那么有的读者可能就会问，既然JAVA NIO / JAVA AIO已经实现了各主流操作系统的底层支持，那么为什么现在主流的JAVA NIO技术会是Netty和MINA呢? 答案很简单: 因为更好用，这里举几个方面的例子:</li>
<li>虽然JAVA NIO 和 JAVA AIO框架提供了 多路复用IO/异步IO的支持，但是并没有提供上层“信息格式”的良好封装。例如前两者并没有提供针对 Protocol Buffer、JSON这些信息格式的封装，但是Netty框架提供了这些数据格式封装(基于责任链模式的编码和解码功能)</li>
<li>要编写一个可靠的、易维护的、高性能的(注意它们的排序)NIO/AIO 服务器应用。除了框架本身要兼容实现各类操作系统的实现外。更重要的是它应该还要处理很多上层特有服务，例如: 客户端的权限、还有上面提到的信息格式封装、简单的数据读取。这些Netty框架都提供了响应的支持。</li>
<li>JAVA NIO框架存在一个poll/epoll bug: Selector doesn’t block on Selector.select(timeout)，不能block意味着CPU的使用率会变成100%(这是底层JNI的问题，上层要处理这个异常实际上也好办)。当然这个bug只有在Linux内核上才能重现。</li>
<li>这个问题在JDK 1.7版本中还没有被完全解决: <a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=2147719">http://bugs.java.com/bugdatabase/view_bug.do?bug_id=2147719</a>。虽然Netty 4.0中也是基于JAVA NIO框架进行封装的(上文中已经给出了Netty中NioServerSocketChannel类的介绍)，但是Netty已经将这个bug进行了处理。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-48dbf55268518f9a2344d8bbc9093d0f>4.12 - CH12-零拷贝</h1>
<p>CPU 并不执行将数据从一个存储区域拷贝到另一个存储区域这样的任务。通常用于在网络传输文件时节省 CPU 周期和内存带宽。</p>
<h2 id=缓存-io>缓存 IO</h2>
<p>缓存 IO 又被称为标准 IO，大多数文件系统的默认 IO 操作都是缓存 IO。在 Linux 的缓存 IO 机制中，操作系统会将 IO 的数据缓存在文件系统的页缓存(page cache)中，也就是说，数据会先被拷贝到操作系统内核的缓冲区中，然后才会从操作系统内核的缓冲区拷贝到应用程序的地址空间。</p>
<p>缓存 IO 的缺点：数据在传输过程中需要在应用程序地址空间和内核间进行多次数据复制操作，这些数据复制所带来的 CPU 及内存开销是非常大的。</p>
<h2 id=零拷贝技术分类>零拷贝技术分类</h2>
<p>零拷贝技术的发展很多样化，现有的零拷贝技术种类也非常多，而当前并没有一个适合于所有场景的零拷贝技术出现。对于 Linux 来说，现有的零拷贝技术也比较多，这些零拷贝技术大部分存在于不同的 Linux 内核版本，有些旧的技术在不同的 Linux 内核版本间得到了很大的发展或者已经渐渐被新的技术所代替。</p>
<p>本文针对这些零拷贝技术所适用的不同场景对它们进行了划分。概括起来，Linux 中的零拷贝技术主要有下面这几种：</p>
<ul>
<li>直接 I/O：对于这种数据传输方式来说，应用程序可以直接访问硬件存储，操作系统内核只是辅助数据传输：这类零拷贝技术针对的是操作系统内核并不需要对数据进行直接处理的情况，数据可以在应用程序地址空间的缓冲区和磁盘之间直接进行传输，完全不需要 Linux 操作系统内核提供的页缓存的支持。</li>
<li>在数据传输的过程中，避免数据在操作系统内核地址空间的缓冲区和用户应用程序地址空间的缓冲区之间进行拷贝。有的时候，应用程序在数据进行传输的过程中不需要对数据进行访问，那么，将数据从 Linux 的页缓存拷贝到用户进程的缓冲区中就可以完全避免，传输的数据在页缓存中就可以得到处理。在某些特殊的情况下，这种零拷贝技术可以获得较好的性能。Linux 中提供类似的系统调用主要有 mmap()，sendfile() 以及 splice()。</li>
<li>对数据在 Linux 的页缓存和用户进程的缓冲区之间的传输过程进行优化。该零拷贝技术侧重于灵活地处理数据在用户进程的缓冲区和操作系统的页缓存之间的拷贝操作。这种方法延续了传统的通信方式，但是更加灵活。在Linux 中，该方法主要利用了写时复制技术。</li>
</ul>
<p>前两类方法的目的主要是为了避免应用程序地址空间和操作系统内核地址空间这两者之间的缓冲区拷贝操作。这两类零拷贝技术通常适用在某些特殊的情况下，比如要传送的数据不需要经过操作系统内核的处理或者不需要经过应用程序的处理。第三类方法则继承了传统的应用程序地址空间和操作系统内核地址空间之间数据传输的概念，进而针对数据传输本身进行优化。我们知道，硬件和软件之间的数据传输可以通过使用 DMA 来进行，DMA 进行数据传输的过程中几乎不需要CPU参与，这样就可以把 CPU 解放出来去做更多其他的事情，但是当数据需要在用户地址空间的缓冲区和 Linux 操作系统内核的页缓存之间进行传输的时候，并没有类似DMA 这种工具可以使用，CPU 需要全程参与到这种数据拷贝操作中，所以这第三类方法的目的是可以有效地改善数据在用户地址空间和操作系统内核地址空间之间传递的效率。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225144400.png style=display:block;width:50% alt=NAME align=center> </div>
<p>当应用程序访问某块数据时，操作系统首先会检查，是不是最近访问过此文件，文件内容是否缓存在内核缓冲区，如果是，操作系统则直接根据read系统调用提供的buf地址，将内核缓冲区的内容拷贝到buf所指定的用户空间缓冲区中去。如果不是，操作系统则首先将磁盘上的数据拷贝的内核缓冲区，这一步目前主要依靠DMA来传输，然后再把内核缓冲区上的内容拷贝到用户缓冲区中。 接下来，write系统调用再把用户缓冲区的内容拷贝到网络堆栈相关的内核缓冲区中，最后socket再把内核缓冲区的内容发送到网卡上。</p>
<p>从上图中可以看出，共产生了四次数据拷贝，即使使用了DMA来处理了与硬件的通讯，CPU仍然需要处理两次数据拷贝，与此同时，在用户态与内核态也发生了多次上下文切换，无疑也加重了CPU负担。</p>
<p>在此过程中，我们没有对文件内容做任何修改，那么在内核空间和用户空间来回拷贝数据无疑就是一种浪费，而零拷贝主要就是为了解决这种低效性。</p>
<h2 id=mmap让数据传输不需要经过user-space>mmap：让数据传输不需要经过user space</h2>
<p>我们减少拷贝次数的一种方法是调用mmap()来代替read调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#000>buf</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mmap</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>diskfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000>write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sockfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>buf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>len</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>应用程序调用 <code>mmap()</code>，磁盘上的数据会通过 DMA被拷贝的内核缓冲区，接着操作系统会把这段内核缓冲区与应用程序共享，这样就不需要把内核缓冲区的内容往用户空间拷贝。应用程序再调用 write(),操作系统直接将内核缓冲区的内容拷贝到 socket缓冲区中，这一切都发生在内核态，最后， socket缓冲区再把数据发到网卡去。</p>
<p>如下图：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225144413.png style=display:block;width:50% alt=NAME align=center> </div>
<p>使用mmap替代read很明显减少了一次拷贝，当拷贝数据量很大时，无疑提升了效率。但是使用 mmap是有代价的。当你使用 mmap时，你可能会遇到一些隐藏的陷阱。例如，当你的程序 map了一个文件，但是当这个文件被另一个进程截断(truncate)时, write系统调用会因为访问非法地址而被 SIGBUS信号终止。 SIGBUS信号默认会杀死你的进程并产生一个 coredump,如果你的服务器这样被中止了，那会产生一笔损失。</p>
<p>通常我们使用以下解决方案避免这种问题：</p>
<ul>
<li><strong>为SIGBUS信号建立信号处理程序</strong>：当遇到 SIGBUS信号时，信号处理程序简单地返回， write系统调用在被中断之前会返回已经写入的字节数，并且 errno会被设置成success,但是这是一种糟糕的处理办法，因为你并没有解决问题的实质核心。</li>
<li><strong>使用文件租借锁</strong>：通常我们使用这种方法，在文件描述符上使用租借锁，我们为文件向内核申请一个租借锁，当其它进程想要截断这个文件时，内核会向我们发送一个实时的 RT_SIGNAL_LEASE信号，告诉我们内核正在破坏你加持在文件上的读写锁。这样在程序访问非法内存并且被 SIGBUS杀死之前，你的 write系统调用会被中断。 write会返回已经写入的字节数，并且置 errno为success。 我们应该在 mmap文件之前加锁，并且在操作完文件后解锁：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fcntl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>diskfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>F_SETSIG</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>RT_SIGNAL_LEASE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>){</span>
	<span style=color:#000>perror</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;kernel lease set signal&#34;</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>/*  l_type can be F_RDLCK_F_WRLCK 加锁 */</span>
<span style=color:#8f5902;font-style:italic>/*  l_type can be F_UNLCK 解锁 */</span>
<span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fcntl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>diskfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>F_SETLEASE</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>l_type</span><span style=color:#000;font-weight:700>)){</span>
	<span style=color:#000>perror</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;kernel lease set_type&#34;</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=参考资料>参考资料</h2>
<ul>
<li><a href=https://www.ibm.com/developerworks/cn/linux/l-cn-zerocopy1/>https://www.ibm.com/developerworks/cn/linux/l-cn-zerocopy1/</a></li>
<li><a href=https://www.jianshu.com/p/fad3339e3448>https://www.jianshu.com/p/fad3339e3448</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4b8f0dd10f10472f6fce3d8242ba0444>4.13 - CH13-内存映射</h1>
<p>内存映射文件非常特别，它允许Java程序直接从内存中读取文件内容，通过将整个或部分文件映射到内存，由操作系统来处理加载请求和写入文件，应用只需要和内存打交道，这使得IO操作非常快。加载内存映射文件所使用的内存在Java堆区之外。Java编程语言支持内存映射文件，通过java.nio包和MappedByteBuffer 可以从内存直接读写文件。</p>
<h2 id=内存映射文件>内存映射文件</h2>
<p>内存映射文件，是由一个文件到一块内存的映射。Win32提供了允许应用程序把文件映射到一个进程的函数 (CreateFileMapping)。内存映射文件与虚拟内存有些类似，通过内存映射文件可以保留一个地址空间的区域，同时将物理存储器提交给此区域，内存文件映射的物理存储器来自一个已经存在于磁盘上的文件，而且在对该文件进行操作之前必须首先对文件进行映射。使用内存映射文件处理存储于磁盘上的文件时，将不必再对文件执行I/O操作，使得内存映射文件在处理大数据量的文件时能起到相当重要的作用。</p>
<h2 id=内存映射-io>内存映射 IO</h2>
<p>在传统的文件IO操作中，我们都是调用操作系统提供的底层标准IO系统调用函数 read()、write() ，此时调用此函数的进程（在JAVA中即java进程）由当前的用户态切换到内核态，然后OS的内核代码负责将相应的文件数据读取到内核的IO缓冲区，然 后再把数据从内核IO缓冲区拷贝到进程的私有地址空间中去，这样便完成了一次IO操作。这么做是为了减少磁盘的IO操作，为了提高性能而考虑的，因为我们的程序访问一般都带有局部性，也就是所谓的局部性原理，在这里主要是指的空间局部性，即我们访问了文件的某一段数据，那么接下去很可能还会访问接下去的一段数据，由于磁盘IO操作的速度比直接 访问内存慢了好几个数量级，所以OS根据局部性原理会在一次 read()系统调用过程中预读更多的文件数据缓存在内核IO缓冲区中，当继续访问的文件数据在缓冲区中时便直接拷贝数据到进程私有空间，避免了再次的低 效率磁盘IO操作。其过程如下</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225235607.png style=display:block;width:50% alt=NAME align=center> </div>
<p>内存映射文件和之前说的 标准IO操作最大的不同之处就在于它虽然最终也是要从磁盘读取数据，但是它并不需要将数据读取到OS内核缓冲区，而是直接将进程的用户私有地址空间中的一 部分区域与文件对象建立起映射关系，就好像直接从内存中读、写文件一样，速度当然快了。</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20190225235633.png style=display:block;width:50% alt=NAME align=center> </div>
<h2 id=内存映射的优缺点>内存映射的优缺点</h2>
<p>内存映射IO最大的优点可能在于性能，这对于建立高频电子交易系统尤其重要。内存映射文件通常比标准通过正常IO访问文件要快。另一个巨大的优势是内存映 射IO允许加载不能直接访问的潜在巨大文件 。经验表明，内存映射IO在大文件处理方面性能更加优异。尽管它也有不足——增加了页面错误的数目。由于操作系统只将一部分文件加载到内存，如果一个请求 页面没有在内存中，它将导致页面错误。同样它可以被用来在两个进程中共享数据。</p>
<h2 id=操作系统支持>操作系统支持</h2>
<p>大多数主流操作系统比如Windows平台，UNIX，Solaris和其他类UNIX操作系统都支持内存映射IO和64位架构，你几乎可以将所有文件映射到内存并通过JAVA编程语言直接访问。</p>
<h2 id=java-内存映射-io-的要点>Java 内存映射 IO 的要点</h2>
<ul>
<li>java通过java.nio包来支持内存映射IO。</li>
<li>内存映射文件主要用于性能敏感的应用，例如高频电子交易平台。</li>
<li>通过使用内存映射IO，你可以将大文件加载到内存。</li>
<li>内存映射文件可能导致页面请求错误，如果请求页面不在内存中的话。</li>
<li>映射文件区域的能力取决于于内存寻址的大小。在32位机器中，你不能访问超过4GB或2 ^ 32（以上的文件）。</li>
<li>内存映射IO比起Java中的IO流要快的多。</li>
<li>加载文件所使用的内存是Java堆区之外，并驻留共享内存，允许两个不同进程共享文件。</li>
<li>内存映射文件读写由操作系统完成，所以即使在将内容写入内存后java程序崩溃了，它将仍然会将它写入文件直到操作系统恢复。</li>
<li>出于性能考虑，推荐使用直接字节缓冲而不是非直接缓冲。</li>
<li>不要频繁调用MappedByteBuffer.force()方法，这个方法意味着强制操作系统将内存中的内容写入磁盘，所以如果你每次写入内存映射文件都调用force()方法，你将不会体会到使用映射字节缓冲的好处，相反，它(的性能)将类似于磁盘IO的性能。</li>
<li>万一发生了电源故障或主机故障，将会有很小的机率发生内存映射文件没有写入到磁盘，这意味着你可能会丢失关键数据。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>readFile3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>start</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//开始时间
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span>  
    <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>BUFFER_SIZE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0x300000</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#8f5902;font-style:italic>// 3M的缓冲  
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>File</span> <span style=color:#000>file</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>);</span>  
        <span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>length</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>MappedByteBuffer</span> <span style=color:#000>inputBuffer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RandomAccessFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;r&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getChannel</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FileChannel</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>MapMode</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>READ_ONLY</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fileLength</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#8f5902;font-style:italic>// 读取大文件  
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>dst</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#204a87;font-weight:700>byte</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>];</span><span style=color:#8f5902;font-style:italic>// 每次读出3M的内容  
</span><span style=color:#8f5902;font-style:italic></span>
            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>fileLength</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>BUFFER_SIZE</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>  
                        <span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inputBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>fileLength</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>offset</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++)</span>  
                        <span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>inputBuffer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#8f5902;font-style:italic>// 将得到的3M内容给Scanner，这里的XXX是指Scanner解析的分隔符  
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>Scanner</span> <span style=color:#000>scan</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Scanner</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ByteArrayInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>useDelimiter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasNext</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>  
                    <span style=color:#8f5902;font-style:italic>// 这里为对读取文本解析的方法  
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>);</span>  
                <span style=color:#ce5c00;font-weight:700>}</span>  
                <span style=color:#000>scan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>close</span><span style=color:#ce5c00;font-weight:700>();</span>  
            <span style=color:#ce5c00;font-weight:700>}</span>  
            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>();</span>
            <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>currentTimeMillis</span><span style=color:#ce5c00;font-weight:700>();</span><span style=color:#8f5902;font-style:italic>//结束时间
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;NIO 内存映射读大文件，总共耗时：&#34;</span><span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>end</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>start</span><span style=color:#ce5c00;font-weight:700>)+</span><span style=color:#4e9a06>&#34;ms&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>  
            <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>  
        <span style=color:#ce5c00;font-weight:700>}</span>  
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>