<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>异步编程 | infilos.com</title><meta property="og:title" content="异步编程">
<meta property="og:description" content="翻译自：Asynchronous Programming and Scala
现在随处可见异步性的身影，同时它也被包括在并发性之内。这篇文章解释了什么是异步处理和它面临的挑战。
1. 介绍 它作为一个比多线程更加综合的概念，但是人们往往将二者混淆。如果需要一种关系来表示，可以是这样：
Multithreadiing <: Asynchrony 我们可以将异步计算表示成一个type：
type Async[A] = (Try[A] => Unit) => Unit 如果这些Unit返回类型看起来很丑陋，那是因为异步本身就是丑陋的。一个异步计算可以是网络中拥有如下特征的任何任务(Task)、线程、进程或节点：
 在你程序的主流程之外执行，或者从调用者的角度来看，它并不在当前调用栈(call-stack)执行； 接收一个回调，并在结果处理完成之后调用； 它不能对结果在何时发送做出任何保证，甚至一点也不能保证一个结果会不被发送。  知道异步属于并发的范畴是很重要的，但多线程则没必要。要记得在 Javascript 中，大部分 I/O 操作都是异步的，甚至繁重的业务逻辑也被异步化处理(使用基于调度的 setTimeout)以保证接口是可响应的。但是并不涉及内核级别的多线程，Javascript 成了一个 N:1 的多线程化平台。
将异步化引入到程序中的同时也意味着你要面对并发问题，因为你无法知道异步计算具体何时会完成。因此，将多个异步计算的结果组合并在同一时间运行意味着你需要进行额外的同步操作，因此你也不能再依赖顺序。不能依赖顺序则会带来更多的不确定性。
 维基百科：一个不确定的算法，相对于确定性的算法来说，尽管提供了相同的输入，可能会在不同的运行过程表现出不同的行为。一个并行算法因为竟态条件会在多次运行时以不同的方式执行。
 敏锐的读者可以会注意到这些类型随处可见，基于用例和规约做一些调整：
 Observer pattern- Gang of Four Scala 中的Future，由其抽象方法onComplete定义 Java 中的ExecutorService.submit(Callable) Javascript 汇总的EventTarget.addEventListener 在 Akka 的 actor 中，尽管给出的回调被sender()替换 Monix 中的Task.Async定义 Monix 中的 Observable、Observer对 Reactive Streams的详细说明  这些抽象有什么共同点呢？他们都提供了处理异步化的方式，其中一些更为优秀。
2. 巨大的错觉 我们喜欢假装能将函数的异步结果转换为同步：
def await[A](fa: Async[A]): A 问题的实质是我们不能假装这些异步处理与普通函数相同。如果你对此需要一刻，只需要了解一下为什么 CORBA 失败了。">
<meta property="og:type" content="article">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/async-programming/"><meta property="article:section" content="编程语言">
<meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="异步编程">
<meta itemprop=description content="翻译自：Asynchronous Programming and Scala
现在随处可见异步性的身影，同时它也被包括在并发性之内。这篇文章解释了什么是异步处理和它面临的挑战。
1. 介绍 它作为一个比多线程更加综合的概念，但是人们往往将二者混淆。如果需要一种关系来表示，可以是这样：
Multithreadiing <: Asynchrony 我们可以将异步计算表示成一个type：
type Async[A] = (Try[A] => Unit) => Unit 如果这些Unit返回类型看起来很丑陋，那是因为异步本身就是丑陋的。一个异步计算可以是网络中拥有如下特征的任何任务(Task)、线程、进程或节点：
 在你程序的主流程之外执行，或者从调用者的角度来看，它并不在当前调用栈(call-stack)执行； 接收一个回调，并在结果处理完成之后调用； 它不能对结果在何时发送做出任何保证，甚至一点也不能保证一个结果会不被发送。  知道异步属于并发的范畴是很重要的，但多线程则没必要。要记得在 Javascript 中，大部分 I/O 操作都是异步的，甚至繁重的业务逻辑也被异步化处理(使用基于调度的 setTimeout)以保证接口是可响应的。但是并不涉及内核级别的多线程，Javascript 成了一个 N:1 的多线程化平台。
将异步化引入到程序中的同时也意味着你要面对并发问题，因为你无法知道异步计算具体何时会完成。因此，将多个异步计算的结果组合并在同一时间运行意味着你需要进行额外的同步操作，因此你也不能再依赖顺序。不能依赖顺序则会带来更多的不确定性。
 维基百科：一个不确定的算法，相对于确定性的算法来说，尽管提供了相同的输入，可能会在不同的运行过程表现出不同的行为。一个并行算法因为竟态条件会在多次运行时以不同的方式执行。
 敏锐的读者可以会注意到这些类型随处可见，基于用例和规约做一些调整：
 Observer pattern- Gang of Four Scala 中的Future，由其抽象方法onComplete定义 Java 中的ExecutorService.submit(Callable) Javascript 汇总的EventTarget.addEventListener 在 Akka 的 actor 中，尽管给出的回调被sender()替换 Monix 中的Task.Async定义 Monix 中的 Observable、Observer对 Reactive Streams的详细说明  这些抽象有什么共同点呢？他们都提供了处理异步化的方式，其中一些更为优秀。
2. 巨大的错觉 我们喜欢假装能将函数的异步结果转换为同步：
def await[A](fa: Async[A]): A 问题的实质是我们不能假装这些异步处理与普通函数相同。如果你对此需要一刻，只需要了解一下为什么 CORBA 失败了。">
<meta itemprop=wordCount content="2250">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="异步编程">
<meta name=twitter:description content="翻译自：Asynchronous Programming and Scala
现在随处可见异步性的身影，同时它也被包括在并发性之内。这篇文章解释了什么是异步处理和它面临的挑战。
1. 介绍 它作为一个比多线程更加综合的概念，但是人们往往将二者混淆。如果需要一种关系来表示，可以是这样：
Multithreadiing <: Asynchrony 我们可以将异步计算表示成一个type：
type Async[A] = (Try[A] => Unit) => Unit 如果这些Unit返回类型看起来很丑陋，那是因为异步本身就是丑陋的。一个异步计算可以是网络中拥有如下特征的任何任务(Task)、线程、进程或节点：
 在你程序的主流程之外执行，或者从调用者的角度来看，它并不在当前调用栈(call-stack)执行； 接收一个回调，并在结果处理完成之后调用； 它不能对结果在何时发送做出任何保证，甚至一点也不能保证一个结果会不被发送。  知道异步属于并发的范畴是很重要的，但多线程则没必要。要记得在 Javascript 中，大部分 I/O 操作都是异步的，甚至繁重的业务逻辑也被异步化处理(使用基于调度的 setTimeout)以保证接口是可响应的。但是并不涉及内核级别的多线程，Javascript 成了一个 N:1 的多线程化平台。
将异步化引入到程序中的同时也意味着你要面对并发问题，因为你无法知道异步计算具体何时会完成。因此，将多个异步计算的结果组合并在同一时间运行意味着你需要进行额外的同步操作，因此你也不能再依赖顺序。不能依赖顺序则会带来更多的不确定性。
 维基百科：一个不确定的算法，相对于确定性的算法来说，尽管提供了相同的输入，可能会在不同的运行过程表现出不同的行为。一个并行算法因为竟态条件会在多次运行时以不同的方式执行。
 敏锐的读者可以会注意到这些类型随处可见，基于用例和规约做一些调整：
 Observer pattern- Gang of Four Scala 中的Future，由其抽象方法onComplete定义 Java 中的ExecutorService.submit(Callable) Javascript 汇总的EventTarget.addEventListener 在 Akka 的 actor 中，尽管给出的回调被sender()替换 Monix 中的Task.Async定义 Monix 中的 Observable、Observer对 Reactive Streams的详细说明  这些抽象有什么共同点呢？他们都提供了处理异步化的方式，其中一些更为优秀。
2. 巨大的错觉 我们喜欢假装能将函数的异步结果转换为同步：
def await[A](fa: Async[A]): A 问题的实质是我们不能假装这些异步处理与普通函数相同。如果你对此需要一刻，只需要了解一下为什么 CORBA 失败了。">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
</div>
<div id=content-desktop></div>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e7bc96e7a88be8afade8a880-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-e7bc96e7a88be8afade8a880><span>编程语言</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880java-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880java><span>Java 编程</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-base-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-base><span>Java 基础</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech01-e99da2e59091e5afb9e8b1a1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch01-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech01-e99da2e59091e5afb9e8b1a1><span>CH01-面向对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech02-e59fbae69cace79fa5e8af86-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch02-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech02-e59fbae69cace79fa5e8af86><span>CH02-基本知识</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech03-e59fbae69cace59bbee8b0b1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch03-%E5%9F%BA%E6%9C%AC%E5%9B%BE%E8%B0%B1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech03-e59fbae69cace59bbee8b0b1><span>CH03-基本图谱</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech04-e6b39be59e8be69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch04-%E6%B3%9B%E5%9E%8B%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech04-e6b39be59e8be69cbae588b6><span>CH04-泛型机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech05-e6b3a8e8a7a3e69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch05-%E6%B3%A8%E8%A7%A3%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech05-e6b3a8e8a7a3e69cbae588b6><span>CH05-注解机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech06-e5bc82e5b8b8e69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch06-%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech06-e5bc82e5b8b8e69cbae588b6><span>CH06-异常机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech07-e58f8de5b084e69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch07-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech07-e58f8de5b084e69cbae588b6><span>CH07-反射机制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-basech08-spie69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-base/ch08-spi%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-basech08-spie69cbae588b6><span>CH08-SPI 机制</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collection-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-collection><span>Java 集合</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch01-e99b86e59088e7bb93e69e84-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch01-%E9%9B%86%E5%90%88%E7%BB%93%E6%9E%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch01-e99b86e59088e7bb93e69e84><span>CH01-集合结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch02-arraylist-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch02-arraylist/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch02-arraylist><span>CH02-ArrayList</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch03-linkedlist-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch03-linkedlist/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch03-linkedlist><span>CH03-LinkedList</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch04-stack-queue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch04-stack-queue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch04-stack-queue><span>CH04-Stack-Queue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch05-priorityqueue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch05-priorityqueue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch05-priorityqueue><span>CH05-PriorityQueue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch06-hashset-map-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch06-hashset-map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch06-hashset-map><span>CH06-HashSet-Map</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch07-linkedhashset-map-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch07-linkedhashset-map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch07-linkedhashset-map><span>CH07-LinkedHashSet-Map</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch08-treeset-map-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch08-treeset-map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch08-treeset-map><span>CH08-TreeSet-Map</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-collectionch09-weakhashmap-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-collection/ch09-weakhashmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-collectionch09-weakhashmap><span>CH09-WeakHashMap</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrent-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-concurrent><span>Java 并发</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch01-e5b9b6e58f91e4bd93e7b3bb-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch01-%E5%B9%B6%E5%8F%91%E4%BD%93%E7%B3%BB/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch01-e5b9b6e58f91e4bd93e7b3bb><span>CH01-并发体系</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch02-e79086e8aebae59fbae7a180-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch02-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch02-e79086e8aebae59fbae7a180><span>CH02-理论基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch03-e7babfe7a88be59fbae7a180-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch03-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch03-e7babfe7a88be59fbae7a180-1><span>CH03-线程基础-1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch04-e7babfe7a88be59fbae7a180-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch04-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch04-e7babfe7a88be59fbae7a180-2><span>CH04-线程基础-2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch05-synchronized-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch05-synchronized/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch05-synchronized><span>CH05-Synchronized</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch06-volatile-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch06-volatile/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch06-volatile><span>CH06-Volatile</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch07-final-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch07-final/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch07-final><span>CH07-Final</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch08-e5b9b6e58f91e6a682e8a788-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch08-%E5%B9%B6%E5%8F%91%E6%A6%82%E8%A7%88/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch08-e5b9b6e58f91e6a682e8a788><span>CH08-并发概览</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch09-e5ba95e5b182e694afe69291-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch09-%E5%BA%95%E5%B1%82%E6%94%AF%E6%92%91/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch09-e5ba95e5b182e694afe69291><span>CH09-底层支撑</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch10-locksupport-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch10-locksupport/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch10-locksupport><span>CH10-LockSupport</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch11-aqs-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch11-aqs-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch11-aqs-1><span>CH11-AQS-1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch12-aqs-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch12-aqs-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch12-aqs-2><span>CH12-AQS-2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch13-aqs-3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch13-aqs-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch13-aqs-3><span>CH13-AQS-3</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch14-aqs-4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch14-aqs-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch14-aqs-4><span>CH14-AQS-4</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch15-reentrantlock-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch15-reentrantlock/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch15-reentrantlock><span>CH15-ReentrantLock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch16-reentrantreadwritelock-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch16-reentrantreadwritelock/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch16-reentrantreadwritelock><span>CH16-ReentrantReadWriteLock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch17-concurrenthashmap-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch17-concurrenthashmap/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch17-concurrenthashmap><span>CH17-ConcurrentHashMap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch18-concurrentlinkedqueue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch18-concurrentlinkedqueue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch18-concurrentlinkedqueue><span>CH18-ConcurrentLinkedQueue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch19-blockingqueue-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch19-blockingqueue/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch19-blockingqueue><span>CH19-BlockingQueue</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch20-futuretask-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch20-futuretask/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch20-futuretask><span>CH20-FutureTask</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch21-threadpoolexecutor-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch21-threadpoolexecutor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch21-threadpoolexecutor><span>CH21-ThreadPoolExecutor</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch22-scheduledthreadpoolexecutor-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch22-scheduledthreadpoolexecutor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch22-scheduledthreadpoolexecutor><span>CH22-ScheduledThreadPoolExecutor</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch23-forkjoin-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch23-forkjoin/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch23-forkjoin><span>CH23-ForkJoin.md</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch24-countdownlatch-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch24-countdownlatch/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch24-countdownlatch><span>CH24-CountDownLatch</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch25-cyclicbarrier-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch25-cyclicbarrier/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch25-cyclicbarrier><span>CH25-CyclicBarrier</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch26-semaphore-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch26-semaphore/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch26-semaphore><span>CH26-Semaphore</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch27-phaser-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch27-phaser/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch27-phaser><span>CH27-Phaser</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch28-exchanger-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch28-exchanger/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch28-exchanger><span>CH28-Exchanger</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch29-threadlocal-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch29-threadlocal/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch29-threadlocal><span>CH29-ThreadLocal</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch30-alllocks-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch30-alllocks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch30-alllocks><span>CH30-AllLocks</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch31-allqueues-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch31-allqueues/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch31-allqueues><span>CH31-AllQueues</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch32-allpools-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-concurrent/ch32-allpools/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-concurrentch32-allpools><span>CH32-AllPools</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-io-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880javajava-io><span>Java I/0</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch01-ioe58886e7b1bb-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch01-io%E5%88%86%E7%B1%BB/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch01-ioe58886e7b1bb><span>CH01-IO分类</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch02-e8a385e9a5b0e6a8a1e5bc8f-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch02-%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch02-e8a385e9a5b0e6a8a1e5bc8f><span>CH02-装饰模式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch03-inputstream-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch03-inputstream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch03-inputstream><span>CH03-InputStream</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch04-outputstream-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch04-outputstream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch04-outputstream><span>CH04-OutputStream</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch05-e5b8b8e794a8e6938de4bd9c-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch05-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch05-e5b8b8e794a8e6938de4bd9c><span>CH05-常用操作.md</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch06-ioe5ae9ee78eb0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch06-io%E5%AE%9E%E7%8E%B0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch06-ioe5ae9ee78eb0><span>CH06-IO实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch07-ioe6a8a1e59e8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch07-io%E6%A8%A1%E5%9E%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch07-ioe6a8a1e59e8b><span>CH07-IO模型</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch08-bioe58e9fe79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch08-bio%E5%8E%9F%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch08-bioe58e9fe79086><span>CH08-BIO原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch09-nioe59fbae7a180-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch09-nio%E5%9F%BA%E7%A1%80/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch09-nioe59fbae7a180><span>CH09-NIO基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch10-nioe58e9fe79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch10-nio%E5%8E%9F%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch10-nioe58e9fe79086><span>CH10-NIO原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch11-aioe58e9fe79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch11-aio%E5%8E%9F%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch11-aioe58e9fe79086><span>CH11-AIO原理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch12-e99bb6e68bb7e8b49d-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch12-%E9%9B%B6%E6%8B%B7%E8%B4%9D/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch12-e99bb6e68bb7e8b49d><span>CH12-零拷贝</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880javajava-ioch13-e58685e5ad98e698a0e5b084-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java/java-io/ch13-%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880javajava-ioch13-e58685e5ad98e698a0e5b084><span>CH13-内存映射</span></a>
</li>
</ul>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880jvm-core-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-core><span>JVM 核心</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm><span>JVM Core</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch01-jvme6a682e8a788-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch01-jvm%E6%A6%82%E8%A7%88/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch01-jvme6a682e8a788><span>CH01-JVM概览</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch02-jvme5ad97e88a82e7a081-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch02-jvm%E5%AD%97%E8%8A%82%E7%A0%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch02-jvme5ad97e88a82e7a081><span>CH02-JVM字节码</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch03-jvme7b1bbe58aa0e8bdbd-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch03-jvm%E7%B1%BB%E5%8A%A0%E8%BD%BD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch03-jvme7b1bbe58aa0e8bdbd><span>CH03-JVM类加载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch04-jvme58685e5ad98e7bb93e69e84-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch04-jvm%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch04-jvme58685e5ad98e7bb93e69e84><span>CH04-JVM内存结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch05-jvme58685e5ad98e6a8a1e59e8b-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch05-jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch05-jvme58685e5ad98e6a8a1e59e8b-1><span>CH05-JVM内存模型-1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch06-jvme58685e5ad98e6a8a1e59e8b-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch06-jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch06-jvme58685e5ad98e6a8a1e59e8b-2><span>CH06-JVM内存模型-2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch07-jvme59e83e59cbee59b9ee694b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch07-jvm%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch07-jvme59e83e59cbee59b9ee694b6><span>CH07-JVM垃圾回收</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch08-jvm-g1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch08-jvm-g1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch08-jvm-g1><span>CH08-JVM-G1.md</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch09-jvm-zgc-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch09-jvm-zgc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch09-jvm-zgc><span>CH09-JVM-ZGC</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch10-jvme8b083e4bc98e58f82e695b0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch10-jvm%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch10-jvme8b083e4bc98e58f82e695b0><span>CH10-JVM调优参数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch11-jvm-oom-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch11-jvm-oom/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch11-jvm-oom><span>CH11-JVM-OOM</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch12-jvme7babfe7a88bdump-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch12-jvm%E7%BA%BF%E7%A8%8Bdump/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch12-jvme7babfe7a88bdump><span>CH12-JVM线程Dump</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch13-jvme8b083e8af95e591bde4bba4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch13-jvm%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch13-jvme8b083e8af95e591bde4bba4><span>CH13-JVM调试命令</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch14-jvme8b083e8af95e5b7a5e585b7-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch14-jvm%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch14-jvme8b083e8af95e5b7a5e585b7><span>CH14-JVM调试工具</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch15-jvme58aa8e68081e8b083e8af95-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm/ch15-jvm%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvmch15-jvme58aa8e68081e8b083e8af95><span>CH15-JVM动态调试</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133><span>JSR 133</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch01-e68c87e4bba4e9878de68e92-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch01-%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch01-e68c87e4bba4e9878de68e92><span>CH01-指令重排</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch02-e58685e5ad98e5b18fe99a9c-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch02-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch02-e58685e5ad98e5b18fe99a9c><span>CH02-内存屏障</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch03-e5a49ae5a484e79086e599a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch03-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch03-e5a49ae5a484e79086e599a8><span>CH03-多处理器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch04-e5bc80e58f91e68c87e58d97-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-133/ch04-%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-133ch04-e5bc80e58f91e68c87e58d97><span>CH04-开发指南</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-spec-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-spec><span>JMM 规范</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch01-jmme8a784e88c83-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch01-jmm%E8%A7%84%E8%8C%83/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch01-jmme8a784e88c83><span>CH01-JMM规范</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch02-jmme8a7a3e9878a-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch02-jmm%E8%A7%A3%E9%87%8A/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch02-jmme8a7a3e9878a><span>CH02-JMM Explain</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch03-jmme58e9fe58899-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch03-jmm%E5%8E%9F%E5%88%99/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch03-jmme58e9fe58899><span>CH03-JMM原则</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch04-jsr133-faq-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch04-jsr133-faq/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch04-jsr133-faq><span>CH04-JSR133-FAQ</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch05-jsr133-cook-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/jmm-spec/ch05-jsr133-cook/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejmm-specch05-jsr133-cook><span>CH05-JSR133-Cook</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2><span>JVM 深入理解 V2</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch01-e8b5b0e8bf9bjava-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch01-%E8%B5%B0%E8%BF%9Bjava/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch01-e8b5b0e8bf9bjava><span>CH01-走近 Java</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch02-e58685e5ad98e58cbae59f9fe4b88ee6baa2e587bae5bc82e5b8b8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch02-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E4%B8%8E%E6%BA%A2%E5%87%BA%E5%BC%82%E5%B8%B8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch02-e58685e5ad98e58cbae59f9fe4b88ee6baa2e587bae5bc82e5b8b8><span>CH02-内存区域与溢出</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch03-e59e83e59cbee694b6e99b86e4b88ee58886e9858de7ad96e795a5-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch03-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E4%B8%8E%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch03-e59e83e59cbee694b6e99b86e4b88ee58886e9858de7ad96e795a5><span>CH03-垃圾收集与分配策略</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch04-e680a7e883bde79b91e68ea7e4b88ee69585e99a9ce5a484e79086-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch04-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch04-e680a7e883bde79b91e68ea7e4b88ee69585e99a9ce5a484e79086><span>CH04-性能监控与故障处理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch05-e8b083e4bc98e6a188e4be8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch05-%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch05-e8b083e4bc98e6a188e4be8b><span>CH05-调优案例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch06-e7b1bbe69687e4bbb6e7bb93e69e84-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch06-%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch06-e7b1bbe69687e4bbb6e7bb93e69e84><span>CH06-类文件结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch07-e7b1bbe58aa0e8bdbde69cbae588b6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch07-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch07-e7b1bbe58aa0e8bdbde69cbae588b6><span>CH07-类加载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch08-e5ad97e88a82e7a081e689a7e8a18ce5bc95e6938e-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch08-e5ad97e88a82e7a081e689a7e8a18ce5bc95e6938e><span>CH08-字节码执行引擎</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch09-e6a188e4be8be4b88ee5ae9ee68898-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch09-%E6%A1%88%E4%BE%8B%E4%B8%8E%E5%AE%9E%E6%88%98/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch09-e6a188e4be8be4b88ee5ae9ee68898><span>CH09-案例与实战</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch10-e7bc96e8af91e69c9fe4bc98e58c96-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch10-%E7%BC%96%E8%AF%91%E6%9C%9F%E4%BC%98%E5%8C%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch10-e7bc96e8af91e69c9fe4bc98e58c96><span>CH10-编译期优化</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch11-e8bf90e8a18ce697b6e4bc98e58c96-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch11-%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BC%98%E5%8C%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch11-e8bf90e8a18ce697b6e4bc98e58c96><span>CH11-运行时优化</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch12-e58685e5ad98e6a8a1e59e8be4b88ee7babfe7a88b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch12-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch12-e58685e5ad98e6a8a1e59e8be4b88ee7babfe7a88b><span>CH12-内存模型与线程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch13-e7babfe7a88be5ae89e585a8e4b88ee99481e4bc98e58c96-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/ch13-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2ch13-e7babfe7a88be5ae89e585a8e4b88ee99481e4bc98e58c96><span>CH13-线程安全与锁优化</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-b-e68c87e4bba4e8a1a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/endix-b-%E6%8C%87%E4%BB%A4%E8%A1%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-b-e68c87e4bba4e8a1a8><span>Endix-B-字节码指令</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-c-e58f82e695b0e8a1a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v2/endix-c-%E5%8F%82%E6%95%B0%E8%A1%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v2endix-c-e58f82e695b0e8a1a8><span>Endix-C-虚拟机参数</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-core/java-jvm-dive-v3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-corejava-jvm-dive-v3><span>JVM 深入理解 V3</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880jvm-concurrent-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrent><span>JVM 并发</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practice-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practice><span>Java 并发实战</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech01-e7ae80e4bb8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch01-%E7%AE%80%E4%BB%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech01-e7ae80e4bb8b><span>CH01-简介</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech02-e7babfe7a88be5ae89e585a8e680a7-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch02-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech02-e7babfe7a88be5ae89e585a8e680a7><span>CH02-线程安全性</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech03-e5afb9e8b1a1e585b1e4baab-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch03-%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech03-e5afb9e8b1a1e585b1e4baab><span>CH03-对象共享</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech04-e5afb9e8b1a1e7bb84e59088-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch04-%E5%AF%B9%E8%B1%A1%E7%BB%84%E5%90%88/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech04-e5afb9e8b1a1e7bb84e59088><span>CH04-对象组合</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech05-e59fbae7a180e69e84e5bbbae59d97-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch05-%E5%9F%BA%E7%A1%80%E6%9E%84%E5%BB%BA%E5%9D%97/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech05-e59fbae7a180e69e84e5bbbae59d97><span>CH05-基础构建块</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech06-e4bbbbe58aa1e689a7e8a18c-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch06-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech06-e4bbbbe58aa1e689a7e8a18c><span>CH06-任务执行</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech07-e58f96e6b688e585b3e997ad-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch07-%E5%8F%96%E6%B6%88%E5%85%B3%E9%97%AD/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech07-e58f96e6b688e585b3e997ad><span>CH07-取消关闭</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech08-e7babfe7a88be6b1a0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch08-%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech08-e7babfe7a88be6b1a0><span>CH08-线程池</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech09-guie5ba94e794a8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch09-gui%E5%BA%94%E7%94%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech09-guie5ba94e794a8><span>CH09-GUI应用</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech10-e6b4bbe8b783e680a7e58db1e999a9-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch10-%E6%B4%BB%E8%B7%83%E6%80%A7%E5%8D%B1%E9%99%A9/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech10-e6b4bbe8b783e680a7e58db1e999a9><span>CH10-活跃性危险</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech11-e680a7e883bde4b88ee4bcb8e7bca9-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch11-%E6%80%A7%E8%83%BD%E4%B8%8E%E4%BC%B8%E7%BC%A9/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech11-e680a7e883bde4b88ee4bcb8e7bca9><span>CH11-性能与伸缩</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech12-e6b58be8af95-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch12-%E6%B5%8B%E8%AF%95/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech12-e6b58be8af95><span>CH12-测试</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech13-e698bee5bc8fe99481-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch13-%E6%98%BE%E5%BC%8F%E9%94%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech13-e698bee5bc8fe99481><span>CH13-显式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech14-e887aae5ae9ae4b989e689a9e5b195-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch14-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech14-e887aae5ae9ae4b989e689a9e5b195><span>CH14-自定义扩展</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech15-e58e9fe5ad90e4b88ee99d9ee998bbe5a19ee5908ce6ada5-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch15-%E5%8E%9F%E5%AD%90%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech15-e58e9fe5ad90e4b88ee99d9ee998bbe5a19ee5908ce6ada5><span>CH15-原子与非阻塞同步</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech16-e58685e5ad98e6a8a1e59e8b-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-practice/ch16-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-practicech16-e58685e5ad98e6a8a1e59e8b><span>CH16-内存模型</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-pattern-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/java-con-pattern/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentjava-con-pattern><span>Java 并发模式</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallel-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallel><span>深入理解并行</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch01-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch01><span>CH01-关于本书</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch02-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch02><span>CH02-简介</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch03-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch03><span>CH03-硬件特性</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch04-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch04><span>CH04-并行工具</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch05-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch05><span>CH05-计数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch06-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch06><span>CH06-分割同步设计</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch07-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch07><span>CH07-锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch08-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch08><span>CH08-数据所有权</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch09-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch09><span>CH09-延后处理</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch10-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch10/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch10><span>CH10-数据结构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch11-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch11/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch11><span>CH11-验证</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch12-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch12/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch12><span>CH12-形式验证</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch13-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch13/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch13><span>CH13-综合应用</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch14-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch14/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch14><span>CH14-高级同步</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch15-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/ch15/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelch15><span>CH15-高级同步-内存序</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelendix-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/dive-parallel/endix/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentdive-parallelendix><span>ENDIX-C-内存屏障</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-model-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-model><span>七并发模型</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch01-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch01/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch01><span>CH01-概述</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch02-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch02/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch02><span>CH02-线程与锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch03-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch03/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch03><span>CH03-函数式编程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch04-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch04/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch04><span>CH04-分离标识与状态</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch05-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch05/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch05><span>CH05-Actor</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch06-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch06/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch06><span>CH06-CSP</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch07-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch07/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch07><span>CH07-数据并行</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch08-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch08/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch08><span>CH08-Lambda 架构</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch09-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/jvm-concurrent/seven-con-model/ch09/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880jvm-concurrentseven-con-modelch09><span>CH09-未来方向</span></a>
</li>
</ul>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e7bc96e7a88be8afade8a880scala-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880scala><span>Scala 编程</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-e7bc96e7a88be8afade8a880scalascala-core-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880scalascala-core><span>Scala 精要</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corecase-class-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/case-class/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corecase-class><span>Case Class</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-system-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-system/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-system><span>类型系统</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/functional-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-1><span>函数式-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/functional-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-2><span>函数式-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-1><span>Future-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-2><span>Future-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-3><span>Future-集合</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/future-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefuture-4><span>Future-Promise</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/implicits-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-1><span>Implicits-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/implicits-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreimplicits-2><span>Implicits-进阶</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/trait-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-1><span>Trait-基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/trait-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretrait-2><span>Trait-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coretry-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/try/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretry><span>Try</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-1><span>Type-用例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-2><span>Type-进阶</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreprimitive-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/primitive/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreprimitive><span>Primitive</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corenumbers-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/numbers/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corenumbers><span>Numbers</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corestrings-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/strings/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corestrings><span>String</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corecontrol-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/control/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corecontrol><span>Control</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corepattern-match-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/pattern-match/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corepattern-match><span>Pattern Match</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-1-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-1><span>Class Object: 基础</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-2-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-2><span>Class Object: 类</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-3-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-3><span>Class Object: 方法</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-4-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-4><span>Class Object: 对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-5-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-5><span>函数式对象</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-6-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-6><span>整体类层级</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-7-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/class-object-7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreclass-object-7><span>组合继承</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corepackage-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/package/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corepackage><span>Package</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coresbt-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/sbt/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coresbt><span>SBT</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corepredef-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/predef/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corepredef><span>Predef</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreio-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/io/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreio><span>I/O</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corereserved-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/reserved/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corereserved><span>保留字</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreexception-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/exception/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreexception><span>Exception</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreannotation-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/annotation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreannotation><span>Inject Type</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-class-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/type-class/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coretype-class><span>Type Class</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coremap-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/map/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coremap><span>Map Flatmap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coregeneric-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/generic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coregeneric><span>泛型型变</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corecommon-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/common/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corecommon><span>常见问题</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreplaceholder-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/placeholder/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreplaceholder><span>占位符</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coremulti-vars-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/multi-vars/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coremulti-vars><span>多变量赋值</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coreconstructor-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/constructor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreconstructor><span>构造器</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/functional/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunctional><span>函数式入门</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-coremonoid-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/monoid/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coremonoid><span>Monoid</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corefunc-type-class-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/func-type-class/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corefunc-type-class><span>函数式与类型类</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-e7bc96e7a88be8afade8a880scalascala-coreasync-programming-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/async-programming/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-coreasync-programming><span class=td-sidebar-nav-active-item>异步编程</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-e7bc96e7a88be8afade8a880scalascala-corescala-style-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/scala-style/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-corescala-style><span>战略Scala风格</span></a>
</li>
</ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-e7bc96e7a88be8afade8a880scalascala-func-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-e7bc96e7a88be8afade8a880scalascala-func><span>Scala 函数式</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch00-e7b2bee8a681-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch00-%E7%B2%BE%E8%A6%81/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch00-e7b2bee8a681><span>CH00-精要</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch01-e5ae9ae4b989-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch01-%E5%AE%9A%E4%B9%89/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch01-e5ae9ae4b989><span>CH01-定义</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch02-e587bde695b0-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch02-%E5%87%BD%E6%95%B0/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch02-e587bde695b0><span>CH02-函数</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch03-e695b0e68dae-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch03-%E6%95%B0%E6%8D%AE/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch03-e695b0e68dae><span>CH03-数据</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-e7bc96e7a88be8afade8a880scalascala-funcch04-e5bc82e5b8b8-li>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-func/ch04-%E5%BC%82%E5%B8%B8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-e7bc96e7a88be8afade8a880scalascala-funcch04-e5bc82e5b8b8><span>CH04-异常</span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/infilos/infilos.com/edit/master/content/zh/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala/scala-core/async-programming.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/infilos/infilos.com/new/master/content/zh/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala/scala-core/async-programming.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/infilos/infilos.com/issues/new?title=%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a id=print href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/_print/><i class="fa fa-print fa-fw"></i> 整节打印</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#1-介绍>1. 介绍</a></li>
<li><a href=#2-巨大的错觉>2. 巨大的错觉</a></li>
<li><a href=#3-回调地狱>3. 回调地狱</a>
<ul>
<li><a href=#31-顺序化副作用炼狱>3.1. 顺序化(副作用炼狱)</a></li>
<li><a href=#32-并行化梦境中的不确定性>3.2. 并行化(梦境中的不确定性)</a></li>
<li><a href=#33-递归爆栈的愤怒>3.3. 递归(爆栈的愤怒)</a></li>
</ul>
</li>
<li><a href=#4-future--promise>4. Future & Promise</a>
<ul>
<li><a href=#41-顺序化>4.1. 顺序化</a></li>
<li><a href=#42-并行化>4.2. 并行化</a></li>
<li><a href=#43-递归>4.3. 递归</a></li>
<li><a href=#44-性能代价>4.4. 性能代价</a></li>
</ul>
</li>
<li><a href=#5-taskscala-的-io-monad>5. Task，Scala 的 IO Monad</a>
<ul>
<li><a href=#51-顺序化>5.1. 顺序化</a></li>
<li><a href=#52-并行化>5.2. 并行化</a></li>
<li><a href=#53-递归>5.3. 递归</a></li>
</ul>
</li>
<li><a href=#6-函数式编程和-type-class>6. 函数式编程和 Type-class</a>
<ul>
<li><a href=#61--monad顺序化和递归>6.1. Monad(顺序化和递归)</a></li>
<li><a href=#62-applicative并行化>6.2. Applicative(并行化)</a></li>
<li><a href=#63-为异步求值定义类型类>6.3. 为异步求值定义类型类？</a></li>
</ul>
</li>
<li><a href=#7-选择正确的工具>7. 选择正确的工具</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/>编程语言</a>
</li>
<li class=breadcrumb-item>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/>Scala 编程</a>
</li>
<li class=breadcrumb-item>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/>Scala 精要</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/scala-core/async-programming/>异步编程</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>异步编程</h1>
<header class=article-meta>
</header>
<p><a href=https://alexn.org/blog/2017/01/30/asynchronous-programming-scala.html>翻译自：Asynchronous Programming and Scala</a></p>
<p>现在随处可见异步性的身影，同时它也被包括在并发性之内。这篇文章解释了什么是异步处理和它面临的挑战。</p>
<h2 id=1-介绍>1. 介绍</h2>
<p>它作为一个比<em>多线程</em>更加综合的概念，但是人们往往将二者混淆。如果需要一种关系来表示，可以是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Multithreadiing</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#000>Asynchrony</span>
</code></pre></div><p>我们可以将异步计算表示成一个<code>type</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span>
</code></pre></div><p>如果这些<code>Unit</code>返回类型看起来很丑陋，那是因为异步本身就是丑陋的。一个异步计算可以是网络中拥有如下特征的任何任务(Task)、线程、进程或节点：</p>
<ul>
<li>在你程序的主流程之外执行，或者从调用者的角度来看，它并不在当前调用栈(call-stack)执行；</li>
<li>接收一个回调，并在结果处理完成之后调用；</li>
<li>它不能对结果在何时发送做出任何保证，甚至一点也不能保证一个结果会不被发送。</li>
</ul>
<p>知道异步属于<em>并发</em>的范畴是很重要的，但多线程则没必要。要记得在 Javascript 中，大部分 I/O 操作都是异步的，甚至繁重的业务逻辑也被异步化处理(使用基于调度的 setTimeout)以保证接口是可响应的。但是并不涉及内核级别的多线程，Javascript 成了一个 N:1 的多线程化平台。</p>
<p>将异步化引入到程序中的同时也意味着你要面对并发问题，因为你无法知道异步计算具体何时会完成。因此，将多个异步计算的结果组合并在同一时间运行意味着你需要进行额外的同步操作，因此你也不能再依赖顺序。不能依赖顺序则会带来更多的不确定性。</p>
<blockquote>
<p>维基百科：一个不确定的算法，相对于确定性的算法来说，尽管提供了相同的输入，可能会在不同的运行过程表现出不同的行为。一个并行算法因为竟态条件会在多次运行时以不同的方式执行。</p>
</blockquote>
<img src=nondet-3aa1c5d6.png class=max-border width=775 alt=Nondet>
<p>敏锐的读者可以会注意到这些类型随处可见，基于用例和规约做一些调整：</p>
<ul>
<li><a href=https://en.wikipedia.org/wiki/Observer_pattern>Observer pattern</a>- <a href=https://en.wikipedia.org/wiki/Design_Patterns>Gang of Four</a></li>
<li>Scala 中的<code>Future</code>，由其抽象方法<code>onComplete</code>定义</li>
<li>Java 中的<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html#submit-java.util.concurrent.Callable->ExecutorService.submit(Callable)</a></li>
<li>Javascript 汇总的<a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener>EventTarget.addEventListener</a></li>
<li>在 Akka 的 actor 中，尽管给出的回调被<code>sender()</code>替换</li>
<li>Monix 中的<a href=https://github.com/monix/monix/blob/v2.2.1/monix-eval/shared/src/main/scala/monix/eval/Task.scala#L1253>Task.Async</a>定义</li>
<li>Monix 中的 <a href=https://monix.io/api/2.2/monix/reactive/Observable.html>Observable</a>、<a href=https://monix.io/api/2.2/monix/reactive/Observer.html>Observer</a>对</li>
<li><a href=http://www.reactive-streams.org/reactive-streams-1.0.0-javadoc/>Reactive Streams</a>的详细说明</li>
</ul>
<p>这些抽象有什么共同点呢？他们都提供了处理异步化的方式，其中一些更为优秀。</p>
<h2 id=2-巨大的错觉>2. 巨大的错觉</h2>
<p>我们喜欢假装能将函数的异步结果转换为同步：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span>
</code></pre></div><p>问题的实质是我们不能假装这些异步处理与普通函数相同。如果你对此需要一刻，只需要了解一下为什么 CORBA 失败了。</p>
<p>针对异步处理，我们有以下非常常见的分布式计算谬误( <a href=https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing>fallacies of distributed computing</a>)：</p>
<ul>
<li>网络是可靠的</li>
<li>延迟为 0</li>
<li>带宽是无限的</li>
<li>网络是完全的</li>
<li>拓扑结构不会发生变化</li>
<li>拥有一位管理员</li>
<li>传输消耗为 0</li>
<li>网络是同质的(homogeneous)</li>
</ul>
<p>当然这些没有一条是真的。这意味着代码是按这些情形来编写的：极少的网络错误处理，忽略了网络延迟和丢包，忽略了带宽限制和随之而来的诸多不确定性。</p>
<p>人们尝试各种方式来对付这些问题：</p>
<ul>
<li>回调，导出都是对调，甚至忽略了基本问题。像 Javascript 中发生的一样，这导致了众所周知的<em>回调地域</em>，以程序员的汗水和鲜血为代价，甚至怀疑人生；</li>
<li>阻塞线程，基于<a href=https://en.wikipedia.org/wiki/Thread_(computing)#1:1_.28kernel-level_threading.29>1:1 (kernel-level) multithreading</a>平台</li>
<li><a href=https://en.wikipedia.org/wiki/Continuation>first-class continuations</a>，比如 Scheme 中实现的<a href=https://en.wikipedia.org/wiki/Call-with-current-continuation>call/cc</a>，在任何一点上保存执行状体并在程序的稍后点回到该点的能力；</li>
<li>来之 C# 的<code>async</code>/<code>await</code>语言扩展，同样在<a href=https://github.com/scala/async>scala-async</a>、最新的<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function>ECMAScript</a>也有实现；</li>
<li>有运行时管理的<a href=https://en.wikipedia.org/wiki/Green_threads>Green threads</a>，可能与 <a href=https://en.wikipedia.org/wiki/Thread_(computing)#M:N_.28hybrid_threading.29>M:N multithreading</a>组合，来模拟异步动作的阻塞。比如 Golang 和 Haskell；</li>
<li>Erlang 和 Akka 中实现了<a href=https://en.wikipedia.org/wiki/Actor_model>actor model</a>，或者  <a href=https://github.com/clojure/core.async>Clojure&rsquo;s core.async</a> 或 Golang 中的<a href=https://en.wikipedia.org/wiki/Communicating_sequential_processes>CSP</a>；</li>
<li>Monad 用于顺序和组合，比如 Haskell 的 <a href=https://hackage.haskell.org/package/async-2.1.1/docs/Control-Concurrent-Async.html>Async</a>类型和 <a href=https://wiki.haskell.org/IO_inside>IO</a>类型的组合，或者： <a href=https://docs.microsoft.com/en-us/dotnet/articles/fsharp/language-reference/asynchronous-workflows>F# asynchronous workflows</a>、 <a href=http://docs.scala-lang.org/overviews/core/futures.html>Scala&rsquo;s Futures and Promises</a>、<a href=https://monix.io/docs/2x/eval/task.html>Monix Task</a> 或 <a href=https://github.com/scalaz/scalaz/blob/scalaz-seven/concurrent/src/main/scala/scalaz/concurrent/Task.scala>Scalaz Task</a>, 等等。</li>
</ul>
<p>有这么多不同的实现，是因为没有任何一种是适用于通用目的的机制来处理异步。没有银弹的窘境在这里很切题，内存管理和并发成为我们开发者面临的巨大问题。</p>
<blockquote>
<p>注意 - 个人观点和一些碎碎念：人们喜欢吹嘘像 Golang 这样的 M:N 平台，然而我更偏向于 1:1 的多线程平台，比如 JVM 或 .NET。</p>
<p>因为你可以在编程语言中基于 1:1 平台搭建 M:N 的多线程来提供足够的表现力(比如：Scala 的 Future、Task、Clojure 的 core.async 等等)，但是一旦 M:N 的运行时不再适用于你的场景，你则无法修改或替换平台。是的，大多数 M:N 平台都被一种方式或另一种打破。</p>
<p>真正的学习所有可行方案或做出选择是很痛苦的，但总比做出无知的选择要痛苦的少，TOOWTDI(?) 和 “worse is better”在这种情况下害处则会更大。人们在解释难于学习一门新的或更有表现力的语言时，比如 Scala 或 Haskell，往往没有提到点上，因为如果他们不得不处理并发问题，这是学习一种新的编程语言将会使他们最小的问题。我了解到一些人因为并发问题而离开了软件行业。</p>
</blockquote>
<h2 id=3-回调地狱>3. 回调地狱</h2>
<p>让我们创建一个仿造的例子来阐明我们的疑问。比如开启两个异步处理并将他们的结果结合在一起。</p>
<p>首先定义一个异步执行的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.global</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timeTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>global</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span>
        <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>})</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 40
</span></code></pre></div><h3 id=31-顺序化副作用炼狱>3.1. 顺序化(副作用炼狱)</h3>
<p>让我们来结合两个异步结果，以平滑的顺序让一个在另一个发生之后执行：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#8f5902;font-style:italic>// Combining the two results
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 80
</span></code></pre></div><p>看起来很简单，但是我们仅结合了两个结果，一个跟在另一个之后。</p>
<p>巨大的问题仍然是<strong>它触及到的所有异步化副作用</strong>。我们假设由于参数的缘故我们以一个纯函数开始：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
</code></pre></div><p>但是这是你的企业架构师听说了这些企业 JavaBean 和 a lap dance(?)，决定让你基于这些异步的<code>timsTwo</code>函数。这时我们的<code>timesFour</code>实现从一个精确的纯函数编程一个有副作用的函数。同时伴随一个并不成熟的<code>Async</code>类型，我们需要面对在整个管道(pipeline)处理副作用。同时，阻塞结果也没有任何帮助，你只是隐藏了问题所在(第二节所述)。</p>
<p>但是等等，事情还会变得更糟。</p>
<h3 id=32-并行化梦境中的不确定性>3.2. 并行化(梦境中的不确定性)</h3>
<p>第二个调用并不基于第一个调用，因此他们可以并行运行。在 JVM 我们可以并行运行 CPU-bound 的任务，但这并不适用于 Javascript，我们可以发起 Ajax 请求或于其他网页工作者(web worker)交谈。</p>
<p>不幸的是事情会变的有点复杂。首先使用所有自然(navie)方式来做都会非常错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// REALLY BAD SAMPLE
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>cacheA</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>cacheA</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#8f5902;font-style:italic>// Combing the two results
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheA</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 80
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 40
</span></code></pre></div><p>这里的例子展示了实际中的不确定性。我们得不到顺序保证哪个会先结束，因此如果我们要并行执行，需要建模一个迷你状态机来进行同步。</p>
<p>首先，定义 ADT 来描述状态机：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// Define the state machine
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>State</span>
<span style=color:#8f5902;font-style:italic>// Initial state
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span>
<span style=color:#8f5902;font-style:italic>// We got a B, waiting for an A
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span>
<span style=color:#8f5902;font-style:italic>// We got a A, waiting for a B
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span>
</code></pre></div><p>然后以异步的方式来演化这个状态机：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// BAD SAMPLE FOR THE JVM(only works for Javascript)
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>state</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>State</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Start</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>为了更好的视觉化我们处理的问题，下图是状态机：</p>
<img src=callback-hell-stm-2cd322e2.png align=center width=300 alt="Callback hell stm">
<p>但是等等，我们还没结束，因为 JVM 拥有真实的 1:1 多线程，这表示我们要沉浸于<em>可共享内存的并行化</em>，因此对<code>state</code>的访问必须是同步的。</p>
<p>一种方案是使用<code>synchronized</code>块，或称为<em>intrinsic</em>块：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// We need a common reference to act as our monitor
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lockkk</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnyRef</span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>state</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>State</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Start</span>

<span style=color:#000>timeTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>synchronized</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// ...
</span></code></pre></div><p>这种高级别的锁保护资源(eg. state)不被多线程并行访问。但我个人更倾向于避免这种高级别的锁，因为内核的调度器可以以任何原因冻结任何线程，包括持有锁的线程。冻结一个持有锁的线程意味着如果你想保证持续前进，而其他线程无法再继续前进，这是无阻塞(<a href=https://en.wikipedia.org/wiki/Non-blocking_algorithm>non-blocking</a>)的逻辑则会更优先。</p>
<p>因此供替代的方式是使用一个<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicReference.html>AtomicReference</a>，它会更适用这个场景：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// CORRECT VERSION FOR JVM
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.annitation.tailrec</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.atomic.AtomicReference</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timeFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#ce5c00;font-weight:700>=&gt;{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>State</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>)</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onValueA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#000>onValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>onValueA</span><span style=color:#ce5c00;font-weight:700>)</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)))</span>
            <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p><strong>PRO-TIP</strong>：如果你想编写  Javascript / Scala.js 的交叉编译代码，基于性能调整和用于操作原子引用的酷炫工具类，可以尝试<a href=https://monix.io/>Monix</a>中的<a href=https://monix.io/docs/2x/execution/atomic.html>Atomic</a>。</p>
</blockquote>
<h3 id=33-递归爆栈的愤怒>3.3. 递归(爆栈的愤怒)</h3>
<p>如果我告诉你上面的<code>onFinish</code>调用并非栈安全(stack-unsafe)的，同时当你调用它时也不会强制<em>异步边界(asynchronous boundary)</em>，这时你的程序会因为一个<code>StackOverflowError</code>爆炸，又该怎么办呢？</p>
<p>你不应该相信为的话。首先让我们找些乐子，同时以更通用的方式来定义上面的操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.annotation.tailrec</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.atomic.AtomicReference</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>b</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Defines the state machine
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span>,<span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#8f5902;font-style:italic>// Initial state
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Nothing</span>, <span style=color:#204a87;font-weight:700>Nothing</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#8f5902;font-style:italic>// We got a B, waiting for an A
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Nothing</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#8f5902;font-style:italic>// We got an A, waiting for a B
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>Nothing</span><span style=color:#ce5c00;font-weight:700>]</span>
  
  <span style=color:#000>onFinish</span> <span style=color:#ce5c00;font-weight:700>=&gt;{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>)</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onVlueA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Uint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#000>onValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)))</span>
            <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinissh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>onValueA</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>fb</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在可以定义一个类似 Scala 中的<code>Future.sequence</code>操作，因为我们的意志坚强，勇气不可估量&mldr;..</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]],</span> <span style=color:#000>acc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>xs</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
        <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>update</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>vall</span> <span style=color:#000>empty</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$r</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: List(20, 40, 60)
</span></code></pre></div><p>你一定认为我们完成了？</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.</span><span style=color:#000>until</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toList</span>
<span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Sum: </span><span style=color:#4e9a06>${</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>注意看这个壮丽的内存错误，它会让你的程序在生产环境崩溃，被认为是一个致命错误，因此 Scala 的<code>NonFatal</code>也捕捉不到：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>StackOverflowError</span>
  <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>externalPush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>java</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>2414</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>java</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>2630</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ExecutionContextImpl$$anon$3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutionContextImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>scala</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>131</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ExecutionContextImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutionContextImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>scala</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>20</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$timesTwo$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>27</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$timesTwo$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>66</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>如为所说，<code>onFinish</code>作为一个没有<em>强制异步边界</em>的调用会引起栈溢出错误。在 Javascript 中可以通过调度<code>setTimeout</code>来解决，而 JVM 则需要一个线程池或 Scala 的<code>ExecutionContext</code>。</p>
<p>Are you feeling the fire yet? 🔥</p>
<h2 id=4-future--promise>4. Future & Promise</h2>
<p><code>scala.concurrent.Future</code>描述了完整的异步求值计算，和我们上面用的<code>Async</code>有点类似。</p>
<blockquote>
<p>维基百科：Future 和 Promise 是在一些并发编程语言中用于异步程序执行的结构。它描述了一个对象，该对象看做是最初并不可知的结果的代理，通常因为该结果的值尚未计算完成。</p>
</blockquote>
<blockquote>
<p>作者的碎碎念：<code>docs.scala-lang.org</code>中关于 <a href=http://docs.scala-lang.org/overviews/core/futures.html>Futures and Promises</a>是这样说的，“Future 提供了一个以并行方式执行多个操作的方法 -更加高效、无阻塞的方式。 ”这种说法容易产生误解，一个混淆的源头。</p>
<p><code>Future</code>描述的是异步化而非并行化。当然，可以以并行的方式来使用，但并不意味者仅用作并行(async != Parallelism)，或适用于那些寻找充分利用 CPU 容量的人，使用<code>Future</code>可以证明是昂贵和不明智的，因为在有些场景它会出现性能问题，参考本部分的第四小节。</p>
</blockquote>
<p><code>Future</code>是一个定义了两种主要操作的接口，同时附带一些基于这些主要操作实现的组合子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.util.Try</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// abstract
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]]</span>
  
  <span style=color:#8f5902;font-style:italic>// abstract
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
  
  <span style=color:#8f5902;font-style:italic>// Transforms values
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
  <span style=color:#8f5902;font-style:italic>// Sequencing
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>Future</code>的特性：</p>
<ul>
<li><a href=https://en.wikipedia.org/wiki/Eager_evaluation>Eagerly evaluated</a>(立即求值，strict and not lazy)，意味着一旦调用者收到一个<code>Future</code>引用，无论异步处理要完成的是什么，它都已经开始了；</li>
<li><a href=https://en.wikipedia.org/wiki/Memoization>Memoized</a>(记忆，cached)，因为会被<em>立即求值</em>，它的行为更像一个正常值而不是一个函数，同时最终的结果会对所有的监听者(listener)可用。<code>value</code>的目的是用于返回记忆结果或尚未完成时返回<code>None</code>。Goes 并未提到会返回一个不确定的值；</li>
<li>流经(stream)单个结果时它会显示，因为是记忆化起了作用。因此当监听者注册了完成时，他们最多会被调用一次。</li>
</ul>
<p><code>ExecutionContext</code>的解释性说明：</p>
<ul>
<li><code>ExecutionContext</code>管理异步执行，也可以把它视作一个线程池，但它并非必须是一个线程池(因为异步不等于多线程或并发)；</li>
<li><code>onComplete</code>和我们上面定义的<code>Async</code>类型一样，然而，它需要一个<code>ExecutionContext</code>，因为所有的完成时回调需要以异步的方式调用；</li>
<li>所有的组合子和工具类都基于<code>onComplete</code>实现，因此所有的组合子和工具类都要提供一个<code>ExecutionContext</code>参数。</li>
</ul>
<p>如果你不理解为什么这些签名都需要一个<code>ExecutionContext</code>，回到上面的“递归”部分，直到你完全理解了。</p>
<h3 id=41-顺序化>4.1. 顺序化</h3>
<p>让我们使用<code>Future</code>重新定义“回调地狱”部分的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>onComplete</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: Success(40)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>足够简单，<code>Future.apply</code>创建器使用提供的<code>ExecutionContext</code>执行给出的计算。因此在 JVM 上，假设<code>global</code>执行上下文会运行在不同的线程上。</p>
<p>然后实现顺序化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>
  <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>onComplete</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: Success(80)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>足够简单。这里的<em>for 表达式</em>魔法仅仅是会被转换为<code>flatMap</code>和<code>map</code>，在字面上等同于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]={</span>
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>=&gt;</span>
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果你在项目中导入了<a href=https://github.com/scala/async>scala-async</a>，可以像下面这样实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.async.Async.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]={</span>
  <span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扩展库<code>scala-async</code>由 macros 驱动，并将你的代码转换为<code>flatMap</code>和<code>map</code>调用。因此，<code>await</code>并不会阻塞线程，尽管它带来了这种错觉。</p>
<p>这些看起来确实不错，不幸的是拥有很多限制。当你的<code>await</code>处于匿名函数之内时，库将无法“重写”你的代码，不幸的是 Scala 代码中到处都是这种表达式。这将不会工作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// BAD SAMPLE
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]])(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
    <span style=color:#8f5902;font-style:italic>// Nope, not going to work because &#34;for&#34; is translated to &#34;foreach&#34;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>){</span>
      <span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种方式带来了拥有<em>first-class continuations</em>的幻觉，但是这种扩展并非一等类，仅仅是作为由编译器管理的重写代码。使得，这种约束在 C# 和 ECMAScript 中却应用的很好，因为<code>async</code>代码并不严重依赖于<em>函数式</em>。</p>
<p>还记得我前面的碎碎念中提到的<em>没有银弹</em>？</p>
<h3 id=42-并行化>4.2. 并行化</h3>
<p>像先前的例子中展示的，这两个函数互相独立，因此我们可以并行调用他们。使用<code>Future</code>则会更加简单，尽管求值语义对于新手来说会有点迷惑：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Future is eagerly evaluated, so this will trigger the
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// execution of both before the composition happens.
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fa</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fb</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
  <span style=color:#8f5902;font-style:italic>// fa.flatMap(a =&gt; fb.map(b =&gt; a + b))
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这会有点迷惑，领新手措手不及。因为在这种执行模型中，为了以并行的方式执行，你需要在组合发生之前初始化这些<code>Future</code>引用。</p>
<p>一种可替代的方式是使用<code>Future.sequence</code>，可以用于任意集合：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这种用法估计也会让新手吃惊，因为这些<code>Future</code>仅会当传入<code>sequence</code>的集合是精确的时候才会以并行的方式执行，不像 Scala 的<code>Stream</code>或<code>Iterator</code>。显然这个名字是个误称。</p>
<h3 id=43-递归>4.3. 递归</h3>
<p><code>Future</code>类型对于递归操作是绝对安全的，因为信心在于执行回调的<code>ExecutionContext</code>。因此重试前面的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>...</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>...</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seed</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seed</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>accl</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>l</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>
  <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>times</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#ce5c00;font-weight:700>))).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; List(20, 40, 60)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这次则不会出现<code>StackOverflowError</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.</span><span style=color:#000>until</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toList</span>
<span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Sum: </span><span style=color:#4e9a06>${</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#a40000>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><h3 id=44-性能代价>4.4. 性能代价</h3>
<p><code>Future</code>的麻烦是每次调用<code>onComplete</code>都会使用一个<code>ExecutionContext</code>来执行，通常这意味着一个<code>Runnable</code>被发送到了线程池，像这样分支(fork)一个<em>逻辑线程</em>。如果你拥有 CPU 绑定的任务，这种实现细节对性能来说是一种灾难，因为跳跃的线程意味着 <a href=https://en.wikipedia.org/wiki/Context_switch>context switches</a>，同时会带来 CPU 的<a href=https://en.wikipedia.org/wiki/Locality_of_reference>cache locality</a>被摧毁。当然，该实现拥有确定性的优化，比如<code>flatMap</code>的实现中使用一个内部的蹦床形式的(trampolined?)执行上线文，为了避免在链接这些内部回调时进行分支，但是这还不够并且基准测试也不会说谎。</p>
<p>同时基于它的记忆化，在完成之上，实现会强制每个生产者执行一个<code>AtomicReference.compareAndSet</code>，在每个<code>Future</code>完成之前又会为每个注册的监听者加上一个<code>compareAndSet</code>。这些调用是十分昂贵的，所有这些都是为了记忆化以便在多个线程之间能够良好运行。</p>
<p>换句话说，如果你想让你的 CPU 绑定任务能够充分利用 CPU，这时使用<code>Future</code>和<code>Promise</code>不是一个好注意。</p>
<p>如果你想对比 Scala 的<code>Future</code>和<code>Task</code>实现，可以看一下相关<a href=https://github.com/rossabaker/benchmarks/pull/4>benchmark</a>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[info] Benchmark                   (size)   Mode  Cnt     Score     Error  Units
[info] FlatMap.fs2Apply             10000  thrpt   20   291.459 ±   6.321  ops/s
[info] FlatMap.fs2Delay             10000  thrpt   20  2606.864 ±  26.442  ops/s
[info] FlatMap.fs2Now               10000  thrpt   20  3867.300 ± 541.241  ops/s
[info] FlatMap.futureApply          10000  thrpt   20   212.691 ±   9.508  ops/s
[info] FlatMap.futureSuccessful     10000  thrpt   20   418.736 ±  29.121  ops/s
[info] FlatMap.futureTrampolineEc   10000  thrpt   20   423.647 ±   8.543  ops/s
[info] FlatMap.monixApply           10000  thrpt   20   399.916 ±  15.858  ops/s
[info] FlatMap.monixDelay           10000  thrpt   20  4994.156 ±  40.014  ops/s
[info] FlatMap.monixNow             10000  thrpt   20  6253.182 ±  53.388  ops/s
[info] FlatMap.scalazApply          10000  thrpt   20   188.387 ±   2.989  ops/s
[info] FlatMap.scalazDelay          10000  thrpt   20  1794.680 ±  24.173  ops/s
[info] FlatMap.scalazNow            10000  thrpt   20  2041.300 ± 128.729  ops/s
</code></pre></div><p>可以看到 <a href=https://monix.io/docs/2x/eval/task.html>Monix Task</a>在 CPU 绑定的任务上击败了<code>Future</code>。</p>
<blockquote>
<p>注意：这些基准测试是有局限的，仍然有一些用例中<code>Future</code>会更快(eg. Monix <a href=https://monix.io/docs/2x/reactive/observers.html>Observer</a>使用<code>Future</code>用做背压)并且性能通常并不相关，比如执行 I/O，即那些吞吐并非 CPU 绑定的场景。</p>
</blockquote>
<h2 id=5-taskscala-的-io-monad>5. Task，Scala 的 IO Monad</h2>
<p><code>Task</code>是一种用于控制可惰性、可异步计算的数据类型，可用于控制副作用、避免非确定性和回调地狱。</p>
<p><a href=https://monix.io/>Monix</a> 库从 <a href=https://github.com/scalaz/scalaz/blob/scalaz-seven/concurrent/src/main/scala/scalaz/concurrent/Task.scala>Task in Scalaz</a> 获得灵感，提供了一种非常精致的 <a href=https://monix.io/docs/2x/eval/task.html>Task</a> 实现。相同的概念，但实现不同。</p>
<blockquote>
<p><code>Task</code>类型同样汲取了来自 <a href=https://wiki.haskell.org/IO_inside>Haskell&rsquo;s IO monad</a> 的灵感，而作者认为这是真正的 Scala <code>IO</code> 类型。</p>
<p>该问题存在争论，因为 Scalaz 同样暴漏了一个仅用于处理异步计算的<code>IO</code>类型。Scalaz 的 <code>IO</code>并非异步，这表示它的描述并不完整，因为在 JVM 之上你必须以某种方式表示异步计算。另一方面，在 Haskell 中的你拥有转换成<code>IO</code>类型的<code>Async</code>类型，或许这是由运行时管理的(green-threads and all)。</p>
<p>在 JVM 之上的 Scalaz 实现中，我们无法使用<code>IO</code>在求值过程中以不阻塞线程的方式来表达异步计算，这是要避免的，因为<a href=https://monix.io/docs/2x/best-practices/blocking.html>阻塞线程则意味着倾向于错误</a>。</p>
</blockquote>
<p>总的来说，<code>Task</code>类型：</p>
<ul>
<li>建模惰性、异步求值</li>
<li>建模一个生产者向一个或多个消费者仅发送一个值</li>
<li>它是惰性求值，因此对比<code>Future</code>它并不会触发执行，或在<code>runAsync</code>之前都不会有任何效果</li>
<li>不会被求值记忆化(memoized)，但是 Monix 的<code>Task</code>可以</li>
<li>无需再另一个逻辑线程执行</li>
</ul>
<p>而 Monix 中的实现拥有更多特别之处：</p>
<ul>
<li>允许取消一个运行中的计算</li>
<li>在其实现中永远不会阻塞任何线程</li>
<li>没有暴露任何可以阻塞线程的 API 调用</li>
<li>所有异步操作都是栈安全的(stack safe)</li>
</ul>
<p><code>Task</code>在设计上的可视化表示：</p>
<table>
<thead>
<tr>
<th></th>
<th>Eager</th>
<th>Lazy</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Synchronous</strong></td>
<td>A</td>
<td>() => A</td>
</tr>
<tr>
<td></td>
<td></td>
<td><a href=https://monix.io/docs/2x/eval/coeval.html>Coeval[A]</a>, <a href=https://github.com/scalaz/scalaz/blob/scalaz-seven/effect/src/main/scala/scalaz/effect/IO.scala>IO[A]</a></td>
</tr>
<tr>
<td><strong>Asynchronous</strong></td>
<td>(A => Unit) => Unit</td>
<td>(A => Unit) => Unit</td>
</tr>
<tr>
<td></td>
<td><code>Future[A]</code></td>
<td><a href=https://monix.io/docs/2x/eval/task.html>Task[A]</a></td>
</tr>
</tbody>
</table>
<h3 id=51-顺序化>5.1. 顺序化</h3>
<p>使用<code>Task</code>重新定义第三节中的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>monix.eval.Task</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Our ExecutionContext needed on evaluation
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.Scheduler.Implicits.global</span>
  
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: 40
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码看起来和第四节中<code>Future</code>的版本一样，唯一的区别是新的<code>timesTwo</code>函数不再接受<code>ExecutionContext</code>作为参数。这是因为<code>Task</code>引用是惰性的，和函数类似，因此在调用强制求值发生的<code>foreach</code>之前什么都不会打印。我们需要的是一个 <a href=https://monix.io/docs/2x/execution/scheduler.html>Scheduler</a>，这是 Monix 中增强的<code>ExecutionContext</code>。</p>
<p>现在实现 3.1 节中的顺序化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.Scheduler.Implicits.global</span>
  
  <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: 80
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同样是和<code>Future</code>类型一样，<em>for 表达式</em>魔法仍然是被 Scala 编译器转换成<code>flatMap</code>和<code>map</code>调用，字面值等同于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>=&gt;</span>
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=52-并行化>5.2. 并行化</h3>
<p><code>Task</code>的并行化比<code>Future</code>要好的多，因为<code>Task</code>在分支 task 时支持细粒度控制，当在当前线程和调用栈执行转换(eg. map/flatMap)时，局域性的缓存保留和避免上下文切换则等同于顺序执行。</p>
<p>但是首先，转换成<code>Future</code>的形式并不能正常工作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// BAD SAMPLE, 为了达成并行，这实质上会是顺序化
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 并不会触发执行，因为 Task 是惰性的
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fa</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fb</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// 因为惰性的缘故求值会是顺序化
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>想要达到并行化，必须显示指定：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>是不是<code>mapBoth</code>看起来很熟悉？如果这两个任务在执行时分支线程，<code>mapBoth</code>会同时启动两者，从而达到并行化。</p>
<h3 id=53-递归>5.3. 递归</h3>
<p><code>Task</code>支持递归，栈安全且十分有效，这是基于其内部的 trampoline。你可以查看这篇 Rúnar Bjarnason 的论文 <a href=http://blog.higher-order.com/assets/trampolines.pdf>Stackless Scala with Free Monads</a> 来了解其为何如此有效。</p>
<p>其<code>sequence</code>实现与<code>Future</code>非常相似，只不过你会在<code>sequence</code>的签名中发现其惰性化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seed</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seed</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>l</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>acc</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>f</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>l</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>monix.execution.Scheduler.Implicits.global</span>
  
  <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#ce5c00;font-weight:700>))).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; List(20, 40, 60)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=6-函数式编程和-type-class>6. 函数式编程和 Type-class</h2>
<p>当你使用这些众所周知的函数时，比如：<code>map</code>，<code>flatMap</code>和<code>mapBoth</code>，我们不再关心这一切的背后是一个<code>(A => Unit) => Unit</code>，因为这些函数会假设为合法、纯净、透明的。这意味着我们可以脱离其上下文来推导它们的结果。</p>
<p>这是 Haskell 中<code>IO</code>的伟大成就。Haskell 不会“伪造(fake)”副作用，因为返回<code>IO</code>函数字面意义上是纯的，副作用会被推迟到其所属程序的边缘。我们可以同样看待<code>Task</code>。不过，对于<code>Future</code>急切的本性(立即计算)来说会更加复杂，但是使用<code>Future</code>也不是一个坏的选择。</p>
<p>那么我们能够基于这些类型，比如<code>Task</code>、<code>Future</code>、<code>Coeval</code>、<code>Eval</code>、<code>IO</code>、<code>Id</code>、<code>Observable</code>或者一些其他的类型，来创建接口或抽象吗？</p>
<p>当然我们可以，我们已经见过使用<code>flatMap</code>来描述顺序化，使用<code>mapBoth</code>来描述并行化。但是我们不能使用经典的 OOP 来描述他们，其中一个原因是<code>Functional</code>参数的协变和逆变规则，这会导致我们在<code>flatMap</code>中失去类型信息(除非你使用 F-bounded 泛型类型，这样更适合实现复用或其他 OOP 语言不可用时)，同时我们要描述一个数据构造器，他不能是一个方法(比如 OOP 的子类应用到实例而不是整个类)。</p>
<p>幸运的是，Scala 是极少数支持高阶类型且能够编码类型类(type-class)的语言，这意味着我们拥有了从 Haskell 端口概念所需要的一切。</p>
<blockquote>
<p>作者的碎碎念：<code>Monad</code>，<code>Applicative</code>，<code>Functor</code>，这些可怕的单词让那些并不忠实的人心生畏惧，导致他们认为关注的是一些与现实世界脱轨的“学术”概念，书籍作者要避免大量使用这些单词，包括 Scala 的 API 文档及官方教程。</p>
<p>但这是给 Scala 和其用户帮倒忙。其他语言中仅有的设计模式主要是难于解释，因为这些不能用类型来表示。你可以用一只手输出拥有这种表达能力的语言。而用户痛苦的是当他们遇到麻烦时不知如何从现有的文献中搜索相关主题，缺失对正确术语的学习。</p>
<p>我也觉得这是一味地反智主义(<a href=https://en.wikipedia.org/wiki/Anti-intellectualism>anti-intellectualism</a>)，向往常一样对无知的恐惧。你可以发现这些都来自真正做他们的人，但我们无一幸免。比如 Java 中的<code>Optional</code>类型违反了 Functor 的规则(e.g. <code>opt.map(f).map(g) != opt.map(f andThen g)</code>)，Swift 中愚蠢的 <code>5 == Some(5)</code>，可以幸运的向人们解释<code>Some(null)</code>实际上与<code>null</code>的意义相同，是<code>AnyRef</code>的有效值，因为不然的话你不能定义一个<code>Applicative[Option]</code>。</p>
</blockquote>
<h3 id=61--monad顺序化和递归>6.1. Monad(顺序化和递归)</h3>
<p>本文并不会解释 Monad。另外有一篇文章来专门解释它。但如果你想建立一个直觉，这里有另外一个：在数据类型的上下文中，比如<code>Future</code>或<code>Task</code>，Monads 用于描述操作的顺序，并且是保证顺序的唯一有效方法。</p>
<blockquote>
<p>&ldquo;<em>Observation: programmers doing concurrency with imperative languages are tripped by the unchallenged belief that &ldquo;;&rdquo; defines sequencing.</em>&rdquo; – <a href=https://twitter.com/shipilev/status/822004316605206529>Aleksey Shipilëv</a></p>
</blockquote>
<p>Scala 中一个简单的编码<code>Monad</code>的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// we shouldn&#39;t need to do this
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.language.higherKinds</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]{</span>
  <span style=color:#8f5902;font-style:italic>/** Constructor (said to lift a value `A` in the `F[A]`
</span><span style=color:#8f5902;font-style:italic>    * monadic context). Also part of `Applicative`, see below.
</span><span style=color:#8f5902;font-style:italic>    */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

  <span style=color:#8f5902;font-style:italic>/** FTW */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同时提供一个<code>Future</code>实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent._</span>

<span style=color:#8f5902;font-style:italic>// Supplying an instance for Future isn&#39;t clean, ExecutionContext needed
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FutureMonad</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FutureMonad</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这真是一个强力的东西。现在我们可以描述一个用于<code>Task</code>、<code>Future</code>、<code>IO</code>的泛型函数，无论如何，如果<code>flatMap</code>是栈安全的话这将非常伟大：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>/** Calculates the N-th number in a Fibonacci series. */</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>fib</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>F</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BigInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BigInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage:
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Needed in scope
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>FutureMonad.instance</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>

  <span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>fib</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$r</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#8f5902;font-style:italic>//=&gt; Result: 102334155
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>注意：这只是一个玩具样例，严肃的实现参考 <a href=http://typelevel.org/cats/>Typelevel&rsquo;s Cats</a>。</p>
</blockquote>
<h3 id=62-applicative并行化>6.2. Applicative(并行化)</h3>
<p>Monad 定义了操作的顺序化，但是有时我们想组合那些互不依赖的计算的结果，他们可以同时求值，或者并行化。还有一个例子可以证明 Applicative 比 Monad 更加可组合。</p>
<p>现在扩展我们的<em>Typeclassopedia</em>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Functor</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>/** I hope we are all familiar with this one. */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Applicative</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#000>extends</span> <span style=color:#000>Functor</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>/** Constructor (lifts a value `A` in the `F[A]` applicative context). */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

  <span style=color:#8f5902;font-style:italic>/** Maps over two references at the same time.
</span><span style=color:#8f5902;font-style:italic>    *
</span><span style=color:#8f5902;font-style:italic>    * In other implementations the applicative operation is `ap`,
</span><span style=color:#8f5902;font-style:italic>    * but `map2` is easier to understand.
</span><span style=color:#8f5902;font-style:italic>    */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#000>extends</span> <span style=color:#000>Applicative</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后扩展我们的<code>Future</code>实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// Supplying an instance for Future isn&#39;t clean, ExecutionContext needed
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FutureMonad</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#8f5902;font-style:italic>// For Future there&#39;s no point in supplying an implementation that&#39;s
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// not based on flatMap, but that&#39;s not the case for Task ;-)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FutureMonad</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在可以基于<code>Applicative</code>定义泛型函数并用于<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>F</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Applicative</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seed</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seed</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>l</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>注意：同样是一个玩具样例，参考<a href=http://typelevel.org/cats/>Typelevel&rsquo;s Cats</a>。</p>
</blockquote>
<h3 id=63-为异步求值定义类型类>6.3. 为异步求值定义类型类？</h3>
<p>上面的部分缺少的是真正触发计算并获得结果值。思考 Scala 的<code>Future</code>，我们想要一种方式来抽象<code>onComplete</code>。想象 Monix 中我们想要抽象<code>runAsync</code>。想象 Haskell 和 Scalaz 的<code>IO</code>，我们想要抽象<code>unsafePerformIO</code>。</p>
<p><a href=https://github.com/functional-streams-for-scala/fs2/>FS2</a> 库中定义了一个名为 <a href=https://github.com/functional-streams-for-scala/fs2/blob/series/1.0/core/shared/src/main/scala/fs2/util/Effect.scala>Effect</a> 类型类来这样做：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Effect</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#000>extends</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unsafeRunAsync</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>cb</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这看起来向我们初始的<code>Async</code>类型，跟<code>Future.onComplete</code>、<code>Task.runAsync</code>、<code>IO.unsafePerformIO</code>很相似。</p>
<p>然而，它并非真正的类型类：</p>
<ul>
<li>它是非法的，然而也不足以取消他的资格(after all, useful lawless type-classes like <code>Show</code> exist)，但最大的问题是&mldr;.</li>
<li>如 3.3 中所示，为了避免<code>StackOverflowError</code>，我们需要某种执行上下文或线程池来执行异步任务且不会导致栈溢出。</li>
</ul>
<p>但是这样的执行上下文根据实现不同而不同。Java 使用 Executor，Scala 的<code>Future</code>时候使用<code>ExecutionContext</code>，Monix 使用增强自<code>ExecutionContext</code>的<code>Scheduler</code>。FS2 和 Scalaz 使用 包装自<code>Executor</code>的<code>Strategy</code>来 fork 线程，但是调用<code>unsafePerformIO</code>或<code>runAsync</code>时并不会注入上下文(这也是为什么很多 Scalaz 组合子实际上并不安全)。</p>
<p>我们可以采取与<code>Future</code>同样的策略，从作用域中获取一个<code>implicit whatever: Context</code>来创建实例。但这有点尴尬且效率低下。这也意味这不使用上下文的情况下我们仅仅不能为<code>Effect.unsafePerformIO</code>定义<code>flatMap</code>。如果我们不能这样做，这时也不会继承自<code>Monad</code>，因为它没有必要是一个<code>Monad</code>。</p>
<p>因此为个人也不是很确定 - 如果你对 Cats 有什么好的建议，我愿洗耳恭听。</p>
<p>我希望你喜欢这个思想试验，设计东西是很有趣的。</p>
<h2 id=7-选择正确的工具>7. 选择正确的工具</h2>
<p>一些抽象较其他会更为通用，为个人认为"为工作选择正确的工具"这样的口头禅是过度保护可怜人的选择。</p>
<p>为此，Rúnar Bjarnason 有一个非常有意思的表述，名为 <a href="https://www.youtube.com/watch?v=GqmsQeSzMdw">Constraints Liberate, </a>，而 <a href="https://www.youtube.com/watch?v=GqmsQeSzMdw">Liberties Constrain</a> 最终真正道出了并发抽象的本质。</p>
<p>如前所述，并没有银弹能够通用的解决并发问题。抽象的层次越高，能解决的问题视野也就越少。但是更少的视野和其强大的能力，模型也会更加简单更加可组合。比如 Scala 社区中很多开发者滥用 Akka Actor，这个库在不被误用时是很伟大的。就像能够使用<code>Future</code>或<code>Task</code>时不用 Actor。同样在其他的抽象中，比如 Monix 或 ReactiveX 中的<code>Observable</code>抽象。</p>
<p>同样用心学习下面两条规则：</p>
<ul>
<li>避免使用回调、线程和锁，它们易错且不可组合；</li>
<li>避免像瘟疫一样并发(avoid concurrency like the plague it is)</li>
</ul>
<p>最后让我告诉你，并发专家首先是避免并发的专家&mldr;.</p>
<style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style>
<div class=d-print-none>
<h2 class=feedback--title>Feedback</h2>
<p class=feedback--question>Was this page helpful?</p>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
Glad to hear it! Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
Sorry to hear that. Please <a href=https://github.com/infilos/infilos.com/issues/new>tell us how we can improve</a>.
</p>
</div>
<script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script>
<br>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script>
<script>docsearch({apiKey:'123',indexName:'infilos_com',inputSelector:'.td-search-input',debug:!1})</script>
</body>
</html>