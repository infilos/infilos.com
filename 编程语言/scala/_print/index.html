<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.88.1">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel=canonical type=text/html href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/>
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Scala 编程 | infilos.com</title><meta property="og:title" content="Scala 编程">
<meta property="og:description" content="Infilos Wiki Website">
<meta property="og:type" content="website">
<meta property="og:url" content="/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/"><meta property="og:site_name" content="infilos.com">
<meta itemprop=name content="Scala 编程">
<meta itemprop=description content="Infilos Wiki Website"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Scala 编程">
<meta name=twitter:description content="Infilos Wiki Website">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-123062585-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css as=style>
<link href=/scss/main.min.847464b684a6e89d7276700a5c500c17ab494dd1755b2654a7b27d8b59e3347e.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#ffc107" d="M432.384 143.616c-4.165-4.164-10.917-4.164-15.083.0l-60.352 60.352c-4.164 4.165-4.164 10.917.0 15.083 21.187 20.463 54.951 19.876 75.413-1.311 19.962-20.668 19.962-53.435.0-74.102L432.384 143.616z"/><path style="fill:#607d8b" d="M42.667 277.334c-5.891.003-10.669-4.771-10.672-10.662-.002-4.338 2.623-8.245 6.64-9.882l234.667-96c5.455-2.233 11.687.38 13.92 5.835s-.38 11.687-5.835 13.92l-234.667 96C45.433 277.069 44.056 277.337 42.667 277.334z"/><path style="fill:#546e7a" d="M391.552 56.448l-32-32C343.938 8.745 322.689-.059 300.544.0h-3.755c-46.082.024-83.432 37.374-83.456 83.456v3.755c-.053 22.138 8.75 43.377 24.448 58.987l32 32c4.165 4.164 10.917 4.164 15.083.0L391.531 71.531C395.701 67.372 395.71 60.62 391.552 56.448z"/><path style="fill:#607d8b" d="M160 469.334c-3.279.006-6.379-1.497-8.405-4.075L34.261 315.926c-3.635-4.636-2.823-11.341 1.813-14.976s11.341-2.823 14.976 1.813l117.333 149.333c3.629 4.641 2.809 11.344-1.832 14.973C164.681 468.533 162.375 469.329 160 469.334z"/><path style="fill:#455a64" d="M487.467 86.848l-3.669-3.648c-37.687-36.557-97.71-36.197-134.955.811l-51.413 51.413c-36.996 37.25-37.357 97.263-.811 134.955l3.584 3.669c1.7 2.457 4.671 3.706 7.616 3.2 2.831.005 5.548-1.115 7.552-3.115l172.181-172.181c4.189-4.143 4.226-10.896.083-15.085-.028-.028-.055-.056-.083-.083L487.467 86.848z"/><g><path style="fill:#ffc107" d="M501.333 192H480c-5.891.0-10.667-4.776-10.667-10.667s4.776-10.667 10.667-10.667h21.333c5.891.0 10.667 4.776 10.667 10.667S507.225 192 501.333 192z"/><path style="fill:#ffc107" d="M394.667 298.667c-5.891.0-10.667-4.776-10.667-10.667v-21.333c0-5.891 4.776-10.667 10.667-10.667 5.891.0 10.667 4.776 10.667 10.667V288C405.333 293.891 400.558 298.667 394.667 298.667z"/><path style="fill:#ffc107" d="M480 277.334c-2.831.005-5.548-1.115-7.552-3.115l-21.333-21.333c-4.093-4.237-3.975-10.99.262-15.083 4.134-3.993 10.687-3.993 14.821.0l21.333 21.333c4.159 4.172 4.148 10.926-.024 15.085C485.514 276.209 482.815 277.327 480 277.334z"/></g><g><path style="fill:#455a64" d="M266.667 448H96c-29.455.0-53.333 23.878-53.333 53.333.0 5.891 4.776 10.667 10.667 10.667h256c5.891.0 10.667-4.776 10.667-10.667C320 471.878 296.122 448 266.667 448z"/><circle style="fill:#455a64" cx="32" cy="288" r="32"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class=font-weight-bold>infilos.com</span>
</a>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
基础
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f>操作系统</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e6%80%a7%e8%83%bd%e4%b9%8b%e6%ae%87>性能之殇</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/io%e6%a8%a1%e5%9e%8b>IO 模型</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/%e7%bd%91%e7%bb%9c%e5%9f%ba%e7%a1%80>网络基础</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/tcp-ip>TCP-IP</a>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86/http>HTTP</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
语言
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/java>Java 编程</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-core>JVM 核心</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/jvm-concurrent>JVM 并发</a>
<a class=dropdown-item href=/%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80/scala>Scala 编程</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
框架库
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/spring>Spring</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/hikari>Hikari</a>
<a class=dropdown-item href=/%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%ba%93/parboiled>Parboiled</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
分布式
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%88%86%e5%b8%83%e5%bc%8f/base>基本构成</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
大数据
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%ad%98%e5%82%a8%e7%b3%bb%e7%bb%9f>存储系统</a>
<a class=dropdown-item href=/%e6%9f%a5%e8%af%a2%e7%b3%bb%e7%bb%9f>查询系统</a>
<a class=dropdown-item href=/%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>消息系统</a>
<a class=dropdown-item href=/%e5%a4%84%e7%90%86%e7%b3%bb%e7%bb%9f>处理系统</a>
<a class=dropdown-item href=/%e7%ae%a1%e7%90%86%e7%b3%bb%e7%bb%9f>管理系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中后台
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd>基础设施</a>
<a class=dropdown-item href=/%e4%ba%a4%e4%ba%92%e7%95%8c%e9%9d%a2>交互界面</a>
<a class=dropdown-item href=/%e4%b8%9a%e5%8a%a1%e7%b3%bb%e7%bb%9f>业务系统</a>
</div>
</li>
<li class="nav-item dropdown" style=max-width:90px;min-width:10px>
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
模式架构
<span>+</span>
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdown>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/design-pattern>设计模式</a>
<a class=dropdown-item href=/%e6%a8%a1%e5%bc%8f%e6%9e%b6%e6%9e%84/micro-service>微服务架构</a>
</div>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e9%9d%a2%e8%af%95%e9%97%ae%e7%ad%94>
<span>面试</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e7%ae%a1%e7%90%86%e8%b7%af%e5%be%84>
<span>管理</span>
</a>
</li>
<li class=nav-item style=max-width:90px;min-width:10px>
<a class=nav-link href=/%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae>
<span>开源</span>
</a>
</li>
</ul>
<div class="form-inline my-2 my-lg-0">
<div class="nav-item nav-search-item my-2 my-md-0">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</div>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/scala/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Scala 编程</h1>
<ul>
<li>1: <a href=#pg-8a76998682b34c39b6bce53f5e0da9ea>Scala 精要</a></li>
<ul>
<li>1.1: <a href=#pg-6aac5a28f123c7c37a9719735c032f09>Case Class</a></li>
<li>1.2: <a href=#pg-c2cefdb977c1b2716663085886395ffb>类型系统</a></li>
<li>1.3: <a href=#pg-00d79aa6b16e32b715022bbfabdbeb44>函数式-基础</a></li>
<li>1.4: <a href=#pg-c64e9cff53f3b069fd014504a1ab2258>函数式-用例</a></li>
<li>1.5: <a href=#pg-36fd9712565fdebd8d49b03473b986f8>Future-基础</a></li>
<li>1.6: <a href=#pg-345d7988748fae2d87d7220ff04727a1>Future-用例</a></li>
<li>1.7: <a href=#pg-03862b6752d201698ebf96b345add63e>Future-集合</a></li>
<li>1.8: <a href=#pg-53dd68b410adf48ef7846943c9c339db>Future-Promise</a></li>
<li>1.9: <a href=#pg-f6b210095ad56eccf48a41b9153855c7>Implicits-基础</a></li>
<li>1.10: <a href=#pg-b2d97cfd6483b6a64d7323c052c614bb>Implicits-进阶</a></li>
<li>1.11: <a href=#pg-ecefbffe8bedb4834db878ae3e8092c2>Trait-基础</a></li>
<li>1.12: <a href=#pg-c68623f6c04e52791d18490c82e0f4e7>Trait-用例</a></li>
<li>1.13: <a href=#pg-6e5b19415179ebbd7db6d295eda25b19>Try</a></li>
<li>1.14: <a href=#pg-9af3d72b4493fcd966a0c66a79638833>Type-用例</a></li>
<li>1.15: <a href=#pg-3dde7874d1eede924a4fff04321d0890>Type-进阶</a></li>
<li>1.16: <a href=#pg-1dcf759395394bb74b2a8d21998d2899>Primitive</a></li>
<li>1.17: <a href=#pg-f0387cb07d844a0cfdd62d257e521da0>Numbers</a></li>
<li>1.18: <a href=#pg-a1325330d53643c57b1c157d2a0ad686>String</a></li>
<li>1.19: <a href=#pg-371ad1e63fe6e6dd95b5ad200e381db6>Control</a></li>
<li>1.20: <a href=#pg-a86ccd1cd8f1f4c2e08d2323821e96c4>Pattern Match</a></li>
<li>1.21: <a href=#pg-bebf1a0e8787e229c152ca3a2c6e93de>Class Object: 基础</a></li>
<li>1.22: <a href=#pg-b368582523f0bdc79a3f91466d645971>Class Object: 类</a></li>
<li>1.23: <a href=#pg-2ba3a131bee7ffbc3f1ffd60a98472d9>Class Object: 方法</a></li>
<li>1.24: <a href=#pg-e7411240763838b4c92e7545eee27aec>Class Object: 对象</a></li>
<li>1.25: <a href=#pg-adc91192ebb2edc61dfb0014f5943d05>函数式对象</a></li>
<li>1.26: <a href=#pg-6f8b4696006dafd11c7961cf748604ea>整体类层级</a></li>
<li>1.27: <a href=#pg-f37f86d98f93453782b00741149e3fa5>组合继承</a></li>
<li>1.28: <a href=#pg-cafe4d5e20e13ac5803d9c55dde63b23>Package</a></li>
<li>1.29: <a href=#pg-0230559def7455f0a12db47614a430fb>SBT</a></li>
<li>1.30: <a href=#pg-7a328cc92d05933f3ef0838049d45196>Predef</a></li>
<li>1.31: <a href=#pg-20fbb4b0e917ad89a8e46dd0068bc15e>I/O</a></li>
<li>1.32: <a href=#pg-9d9b1281f5e793e8918b82d36ca1bb04>保留字</a></li>
<li>1.33: <a href=#pg-2232677dd194c297a300f15769a0b431>Exception</a></li>
<li>1.34: <a href=#pg-95dff9dc548069937c9f193200f1b9f3>Inject Type</a></li>
<li>1.35: <a href=#pg-737e3d6efc18de0358a85817d92cad01>Type Class</a></li>
<li>1.36: <a href=#pg-b9506bcb61f992b431f5cb2ad67ea924>Map Flatmap</a></li>
<li>1.37: <a href=#pg-d9b998701238123f5d1dd72a38243f21>泛型型变</a></li>
<li>1.38: <a href=#pg-4e77c6da5492008617d93656d181886b>常见问题</a></li>
<li>1.39: <a href=#pg-d63caab45f60227c8ca0af81e391a1e9>占位符</a></li>
<li>1.40: <a href=#pg-e7694efddd4c838bef0c4a0378a58212>多变量赋值</a></li>
<li>1.41: <a href=#pg-2d3c4f59227cb3d30510a031e3ed8e37>构造器</a></li>
<li>1.42: <a href=#pg-663f6215142e23cccd6821d6c5df6f20>函数式入门</a></li>
<li>1.43: <a href=#pg-58efa20d1b7da0d021300667f5f8e5f3>Monoid</a></li>
<li>1.44: <a href=#pg-29a2d99f28d355138d14c07506d82cc2>函数式与类型类</a></li>
<li>1.45: <a href=#pg-f379cc207e06ff8a131648c43af55ddb>异步编程</a></li>
<li>1.46: <a href=#pg-75ebf2bf41c6cd0d1369e9d43836ed13>战略Scala风格</a></li>
</ul>
<li>2: <a href=#pg-693b6f6bcc0c1c03a94a2d1cd7f5faa0>Scala 函数式</a></li>
<ul>
<li>2.1: <a href=#pg-b337e5ffeb37c04ead4da57f709c79e9>CH00-精要</a></li>
<li>2.2: <a href=#pg-2e909366e09c3d91dfac9a94ff86f763>CH01-定义</a></li>
<li>2.3: <a href=#pg-03d39ebdea9922f42538e9be1f094c81>CH02-函数</a></li>
<li>2.4: <a href=#pg-ea16a70504134b7249c95e29e5f64348>CH03-数据</a></li>
<li>2.5: <a href=#pg-6cbae87fa8d5efc949b3b87261ed10fc>CH04-异常</a></li>
</ul>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-8a76998682b34c39b6bce53f5e0da9ea>1 - Scala 精要</h1>
</div>
<div class=td-content>
<h1 id=pg-6aac5a28f123c7c37a9719735c032f09>1.1 - Case Class</h1>
<p>下面会用到的 case 类实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastname</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>firstname</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>birthYear</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=基本特性>基本特性</h2>
<p>case 类与普通类的最大区别在于，编译器会为 case 类添加更多的额外特性。</p>
<ul>
<li>
<p>创建一个类和它的伴生对象</p>
</li>
<li>
<p>创建一个名为<code>apply</code>的工厂方法。因此可以在创建实例时省略掉<code>new</code>关键字：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Lacava&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Alessandro&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1976</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Lacava&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Alessandro&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1976</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div></li>
<li>
<p>为参数列表中的所有参数添加<code>val</code>前缀，表示这些参数作为类的不可变成员，因此你会得到所有这个成员的<em>访问器</em>方法，而没有<em>修改器</em>方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lastname</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastname</span>
<span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastname</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Brown&#34;</span>		<span style=color:#8f5902;font-style:italic>// 编译失败
</span></code></pre></div></li>
<li>
<p>为<code>hashCode</code>、<code>equals</code>、<code>toString</code>方法添加原生实现。因为<code>==</code>在 Scala 中代表<code>equals</code>，因此 case 类实例之间总是以<strong>结构的方式</strong>进行比较，即<strong>比较数据而不是比较引用</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p_1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Brown&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;John&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1969</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p_2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Lacava&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Alessandro&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1976</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p_1</span> <span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>p_2</span> <span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div></li>
<li>
<p>生成一个<code>copy</code>方法，使用现有的实例并接收一些新的字段值来创建一个新的实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p_3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstname</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Michele&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>birthYear</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1972</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div></li>
<li>
<p>最重要的特性，<strong>实现一个 <code>unapply</code> 方法</strong>。因此，case 类可以支持模式匹配。这在定义 ADT 时尤为重要。<code>unapply</code>方法就是一个<strong>析构器</strong>。</p>
</li>
<li>
<p>当不需要参数列表时，可以定义为一个<code>case object</code></p>
</li>
</ul>
<h2 id=常用其他特性>常用其他特性</h2>
<ul>
<li>
<p>创建一个函数，根据提供的参数创建一个 case 类的实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>personCreator</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Person</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>apply</span> <span style=color:#204a87;font-weight:700>_</span>
<span style=color:#000>personCreator</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Brown&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;John&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1969</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// Person(Brown,John,1969)
</span></code></pre></div></li>
<li>
<p>如果需要将上面的函数<strong>柯里化</strong>，<strong>分多步</strong>提供参数来创建一个实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>curriedPerson</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>String</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Int</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Person</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>curried</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lacavaBuilder</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Int</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Person</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>curriedPerson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Lacava&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>me</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lacavaBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Alessandro&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#0000cf;font-weight:700>1976</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>myBrother</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lacavaBuilder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Michele&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#0000cf;font-weight:700>1972</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div></li>
<li>
<p>通过一个元组来创建实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>tupledPerson</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Person</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tupled</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>meAsTuple</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Lacava&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Alessandro&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1976</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>meAsPersonAgain</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tupledPerson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>meAsTuple</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div></li>
<li>
<p>将一个实例转换成一个由其参数构造的元组的<code>Option</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>toOptionOfTuple</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>unapply</span> <span style=color:#204a87;font-weight:700>_</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>toOptionOfTuple</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// Some((Lacava,Alessandro,1976))
</span></code></pre></div></li>
</ul>
<p><code>curried</code>和<code>tupled</code>方法通过伴生对象继承自<code>AbstractFunctionN</code>。<code>N</code>是参数的数量，如果<code>N = 1</code>则并不会得到这两个方法。</p>
<h3 id=以-柯里化-的方式定义-case-类>以 <em>柯里化</em> 的方式定义 case 类</h3>
<p><a href=http://www.alessandrolacava.com/blog/scala-case-classes-in-depth/>Scala Case Classes In Depth</a></p>
<h3 id=其他内建方法>其他内建方法</h3>
<p>因为所有的 case 类都会扩展<code>Product</code>特质，因此他们会得到如下方法：</p>
<ul>
<li><code>def productArity:Int</code>：获得参数的数量</li>
<li><code>def productElement(n:Int):Any</code>：从 0 开始，获得第 n 个参数的值</li>
<li><code>def productIterator: Iterator[Any]</code>：获得由所有参数构造的迭代器</li>
<li><code>def productPrefix: String</code>：获得派生类中用于<code>toString</code>方法的字符串，这里会返回类名</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c2cefdb977c1b2716663085886395ffb>1.2 - 类型系统</h1>
<p><strong>什么是类型系统(type-system)？</strong></p>
<p><em>A type system is a tractable syntactic method for proving the absence of certain program behaviors by classifying phrases according to the kinds of values the compute.</em> — Benjamin Pierce</p>
<p>一个类型系统是一种易于理解的语法方法，根据所计算的值的类别对短语进行分类，以证明某些程序行为的缺失。</p>
<p><strong>什么是类型(type)？</strong></p>
<ul>
<li>一个类型定义了一个变量可以拥有的一组值，以及一组能够应用于这些值的函数；</li>
<li>一组值可以被定义为：
<ul>
<li>笛卡尔产品类型(Cartesian product Types)，比如 <code>case</code> 类或元组；</li>
<li>总和类型(Sum Types)，比如 <code>Either</code>。</li>
</ul>
</li>
<li>类型可以是抽象的和(或)多态的。</li>
</ul>
<p><strong>为什么需要类型？</strong></p>
<ul>
<li><em>Make illegal states unrepresentable.</em> — Yaron Minsky
<ul>
<li>使非法状态无法表示</li>
</ul>
</li>
<li><em>Where static typing fits, do it every time because it has just fantastic maintenance benefits.</em> — Simon Peyton
<ul>
<li>在合适的场景总是使用静态类型，因为它具有非常好的维护优势</li>
</ul>
</li>
<li><em>Compiler can use Type informations to optimize compiled code.</em>
<ul>
<li>编译器可以使用类型信息来优化被编译的代码</li>
</ul>
</li>
</ul>
<p><strong>Scala 的类型系统？</strong></p>
<ul>
<li>Scala 是一种同时支持面向对象和函数式的多范式语言</li>
<li>Scala 拥有<strong>强大</strong>的<strong>静态</strong>类型系统
<ul>
<li>会在编译期检查类型</li>
<li>编译器能够通过推断类型</li>
<li>函数也可以作为类型：<code>A => B</code></li>
</ul>
</li>
</ul>
<p><strong>类型的用途？</strong></p>
<p>类型可以用于定义：</p>
<ul>
<li>(抽象)类</li>
<li>对象</li>
<li>特质</li>
</ul>
<p><strong><a href=http://stackoverflow.com/questions/7432146/what-is-scalas-powerful-type-system>Scala 中类型相关的特性？</a></strong></p>
<h2 id=设计目的>设计目的</h2>
<blockquote>
<p>本部分整理至 Martin Odersky 的访谈，原文地址：<a href=http://www.artima.com/scalazine/articles/scalas_type_system.html>The Purpose of Scala&rsquo;s Type System</a>，中文地址：<a href=http://www.infoq.com/cn/articles/scala-type-system>Scala类型系统的目的</a>。</p>
</blockquote>
<h3 id=可伸缩性scalability>可伸缩性(scalability)</h3>
<p>Scala 可以让你不必混用多种专用语言，无论是小型程序还是大型程序，无论是通用用途还是特定应用领域，Scala 都可以胜任。这样，可以避免你在多种语言环境中传递数据。</p>
<p>比如你想跨越数据边界传递数据，像 JDBC，从 Java 像数据库发起一次 SQL 查询，那么发出的查询最终将会是个字符串。这就意味着如果程序中只要有小小的拼写错误，在最终运行时，就会表现为一次非法查询，从而导致一系列相关错误。整个过程中编译器和类型系统不会告诉你那里写错了。</p>
<p>同时，如果仅使用一种语言，则只需要面对一套环境和工具。</p>
<h3 id=可扩展性extensibility>可扩展性(extensibility)</h3>
<p>“可伸缩性“的维度是”从小到大“。而可扩展性表示从”从通用用途到特定需求“。你可以强化 Scala 语言，使之涵盖你特别关注的领域。</p>
<p>比如数字类型，不同领域有很多不同的数字类型，密码学中的大数、商务人士用的十进制大数、科学家用的复数等等。但如果在语言中加入所有这些可能的类型，则会变得非常笨重。</p>
<p>因此我们可以留给外部库实现，但是又想像使用内置类型的代码一样干净、优雅。为此，你需要语言提供某些扩展机制，是你能够编写用起来不像库的库。</p>
<h3 id=小规模编程中的类型>小规模编程中的类型</h3>
<p>小规模编程中类型会显得不那么重要。类型的价值分布在一条长长的光谱上，一端表示超级有用，一端表示极度麻烦。通常说它麻烦是因为类型定义可能会太过冗余，要求你手动指定大量类型。有用则是因为，类型能避免运行时错误，能够提供 API 签名文档，能够为代码重构提供安全底线。</p>
<p>Scala 的类型推断，试图尽可能减少类型的麻烦之处。这意味着你编写脚本时并不需要涉及类型，系统会自动进行推断，同时编译器内部仍然会考虑类型。因此仍然能够享受类型检查带来的便利。</p>
<h3 id=单元测试与随心所欲的表达式>单元测试与随心所欲的表达式</h3>
<p>仍然需要单元测试来测试你的程序逻辑。但相比动态类型语言，不需要额外对类型进行琐碎的单元测试，因此 Scala 中的单元测试也会精练很多。</p>
<p>另一条针对类型系统的反对意见是：静态类型对表达式限制太严。比如”我想更自由的表达自己，不想要类型系统的条条框框“。我(Martin)认为这种意见不靠谱，第一，Scala 的类型系统实际上很灵活，所以通常它可以让你用非常灵活的模式排列组合，而像 Java 这种类型系统偏弱的语言则难以实现；第二，通过模式匹配，你可以通过非常灵活的方式提取类型信息，甚至根本感觉不到类型信息的损失。</p>
<h3 id=鸭子类型java-中的缺失>鸭子类型，Java 中的缺失</h3>
<p>只要它具备我需要的功能，那么就可以把它当真。比如我需要某种支持关闭操作的资源，我可以以这种方式声明”它必须有 close 方法“，因此我不用关心它是 File、Channel 等等。</p>
<p>要想在 Java 中实现的话，需要定义一个包含该方法的通用接口，然后大家都需要实现这个接口。首先为了实现这一切就会带来大量接口和样板代码。其次，如果有了即成事实之后，你才想到要提个接口，那么几乎不可能做到。如果事先就写了一个类，鉴于这些类早已存在，那么你不改代码就无法加入该接口，除非修改所有客户端代码。所以，这一切都是类型系统强加给你的限制。</p>
<p>而 Scala 中则能表达鸭子类型。你完全可以用 Scala 把某一类型定义为：”任何拥有 close 方法并且该方法返回 Unit 的类型“。同时还可以把类型定义与其他约束结合起来。则可以这样定义类型：任何继承自某个类型，且拥有某某方法签名的类型。还可以这样定义，任何继承自某某类，且拥有某某类型的内部类的类型。从本质上讲，你可以通过定义类型汇总有哪些东西将为你所用，来描绘类型的结构。</p>
<h3 id=既存类型existential-types>既存类型(existential types)</h3>
<p>既存类型已有 20 多年历史，它表示，给定某种类型，比如 List，但其内部元素是未知类型。你只知道它是由某种特定类型元素构成的 List，然而并不知道这个特定类型具体是哪种类型。这个概念在 Scala 中可以用既存类型来表达。比如：<code>List[T] forSome {type T}</code>。稍微有点笨重，这也算有意为之。因为事实证明，既存类型往往不大好处理。Scala 有更好的选择，因此不那么需要既存类型，因为 Scala 的类型可以包含其他类型作为内部成员。</p>
<p>归根结底，Scala 只有三种情况需要既存类型。</p>
<ul>
<li>Scala 需要能表示 Java 通配符的语义。</li>
<li>Scala 需要能表示 Java 的 raw 类型，因为有许多库使用类非泛型类型，会出现 raw 类型。如果有一个 Java raw 类型 <code>java.util.List</code>，那么它其实是位置元素类型的 List。</li>
<li>既存类型可以把虚拟机中的实现细节反映到上层。类似 Java ，Scala 使用的泛型模型时”擦除类型“。所以在程序运行起来以后，我们就再也找不到类型参数了。之所以要进行擦除，是为了与 Java 的对象模型进行互操作。可是，如果我们需要反射，或者需要表达虚拟机的实现细节时该怎么办呢？我们需要有能力用 Scala 中的某些类型表示虚拟机的行为。</li>
</ul>
<p>有了既存类型，即使某一类型中的某些方面尚不可知，我们仍然可以操作该类型。</p>
<p>比如，Scala 中的 List，我希望能够描述 head 方法的返回类型。在虚拟机级别，List 类型是 <code>List[T] forSome {type T}</code>。我们不知道 T 是什么。只知道 head 返回 T。既存类型理论告诉我们，该类型是”某些类型 T 中的 T“。也就相当于根类型 Object。那么我们从 head 方法中取回的就是 Object。因此 Scala 中我们要是知道更多信息，就可以直接指定具体类型而不用既存类型的限定规则。但是如果没有更多信息，我们就留着既存类型，让既存类型理论帮我们推断出返回类型。</p>
<p>如果 Java 采用的是”具现化“的泛型类型系统，不支持 raw 类型或通配符类型，那么 Scala 中的既存类型在意义不大，恐怕不会实现既存类型。</p>
<h2 id=java-与-scala-中的型变>Java 与 Scala 中的型变</h2>
<p>Java 的型变是定义在使用通配符的代码之处，而 Scala 则是在类型定义之处，当然 Scala 的既存类型一样支持通配符，支持使用 Java 的写法，但并不推荐这么做。</p>
<p>首先，什么是”类型定义之处的型变“？当你定义某个类的类型参数时，例如 <code>List[T]</code>，会有一个问题，如果你给一个苹果列表，那这个列表算不算水果列表呢？显然算，只要苹果是水果的子类型，<code>List[Appke]</code>就是<code>List[Fruit]</code>的子类型，这称为协变。</p>
<p>但某些情况下种种关系不成立，比如我有一个变量，只能用来保存 Apple，那么这个变量就是对类型 Apple 的引用。这个变量并不能当做 Fruit 类型的引用，因为我不能把任意 Fruit 赋值给这个变量，它只能是 Apple。因此可以发现，上述子类型关系在有些情况下适用，有些则不适用。</p>
<p>Scala 中的解决方案是给类型参数添加一个标志。如果 List 中的 T 支持协变，则写作<code>List[+T]</code>。这将意味着任意 List 之间的关系都可以随着其 T 的关系而协变。要想支持协变，必须遵守协变的附加条件。举例来说，只有 List 内容不可变式，List 才能支持协变，否则将会遇到刚才引用变量中类似的问题，而导致无法协变。</p>
<p>Scala 中的机制是这样的：程序员可以声明”我觉得 List 应用支持协变“，即，要求 List 必须遵守子类型关系，然后给 List 的类型参数加上加号标志，仅需一次，List 的所有用户都可以使用。然后编译器会去找出 List 内的所有定义实际上是否兼容协变，确保 List 中不存在导致冲突的成员签名。</p>
<p>相比之下，以 Java 的方式使用通配符，这就意味着库的作者对协变爱莫能助，只能草草定义成 <code>List&lt;T></code>了事。但接下来如果用户需要协变 List，却不能写作<code>List&lt;Fruit></code>，而是<code>List&lt;? extends Fruit></code>。通配符就是这样用的。问题在于这是用户代码啊，用户总不能人人都像设计库的人那么专业吧。此外，这些标注之间，只要有一处不匹配，就会导致类型错误。</p>
<p>Scala 中可以在库中处理型变，让用户感觉不到型变存在，不必手动处理型变。</p>
<h3 id=抽象类型成员>抽象类型成员</h3>
<p>抽象类型与泛型参数看似类似，但拥有更多好处。对于抽象，业界有两套不同的机制：参数化和抽象类型成员。Java 也一样支持两套抽象，只不过 Java 的两套抽象取决于对什么进行抽象。Java 支持抽象方法，但不支持把方法作为参数；Java 不支持抽象字段，但支持把值作为参数；Java 不支持抽象类型成员，但支持把类型作为参数。所以在 Java 中三者均可抽象，但是之间的原理有所区别。</p>
<p>在 Scala 中试图把这些抽象支持的更完备、更正交，即对上述三类成员都采用相同的构造原理。因此，你可以使用抽象字段，也可以使用值参数；可以把方法(函数)作为参数，也可以声明抽象方法；即可以指定类型参数也可以声明抽象类型。至少在原则上，我们可以用同一种面向对象抽象成员的形式，表达全部三类参数。</p>
<p>抽象类型能够更好的处理先前谈到的协变问题。比如，一个 Ainmal 类，其中一个 eat 方法。问题是，如果从 Animal 派生一个类，比如 Cow，那么就能吃某一种食物，比如 Grass。Cow 不可以吃 Fish 之类的其他食物。你希望有办法可以声明 Cow 拥有一个 eat 方法，且该方法只能吃 Grass。实际上，这个需求在 Java 中实现不了，因为你一定会构造出有矛盾的情形，类似之前把 Fruit 复制给 Apple 一样。</p>
<p>Scala 中则可以增加一个类型成员，比如声明一个 SuitableFood 类型，它不定义具体是什么，这就是抽象类型，直接让 Animal 的 eat 方法吃下 SuitableFood 即可。然后在 Cow 中指定其为 Grass 即可。</p>
<p>所以，抽象类型提供了一种机制：先在父类中声明未知类型，稍后再在子类中填上某种已知类型。</p>
<p>你可能会说用参数也可以实现同样功能。确实可以。你可以给 Animal 增加参数，表示能吃的食物。但实践中，当你需要支持许多不同的功能是就会导致参数爆炸。而且通常更要命的问题是参数的边界。</p>
<h2 id=相关概念>相关概念</h2>
<h3 id=类型推断>类型推断</h3>
<p>Scala 拥有类型推断，这表示我们可以省略掉类型注解。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Thing</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getThing</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thing</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// without Type Ascription, the type is infered to be `Thing`
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>infered</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>getThing</span>

<span style=color:#8f5902;font-style:italic>// with Type Ascription
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>thing</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Thing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getThing</span>
</code></pre></div><p>在这些情况下都是可以编译通过的。所以都有哪些地方不能省略类型注解呢：</p>
<ul>
<li>参数</li>
<li>公共方法返回值</li>
<li>递归或重载方法</li>
<li>需要包含类型签名来加快编译速度</li>
<li>需要类型签名来使代码更易读</li>
</ul>
<h3 id=统一的类型系统--anyanyrefanyval>统一的类型系统 — Any、AnyRef、AnyVal</h3>
<p>我们之所以称 Scala 的类型系统是统一的，是因为它拥有一个顶层类型 Any。这与 Java 不同，它有一些原始类型(int/long/float/double/byte/char/short/boolean)并非扩展自 Java 中看起来像是顶层类型的 Object。</p>
<p>Any 作为顶层类型，下面有 AnyVal 和 AnyRef 两种子类型。</p>
<p>AnyRef 相当于 Java 中 对象的世界，对应于 Object，作为所有对象的超类。而 AnyVal 表示了 Java 中的 值世界，像 int 或其他 JVM 原始类型。</p>
<p>因此我们可以定义一个接收 Any 类型的方法，同时能够处理 Int 或 String。这对类型系统来说是透明的虽然在虚拟机层 Int 实例会被打包成一个对象。通过查看字节码能够发现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Method</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>BoxesRunTime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>boxToInteger</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>I</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>Ljava/lang/Integer</span><span style=color:#ce5c00;font-weight:700>;</span>
</code></pre></div><ul>
<li>Conventional types</li>
<li>Value type classes</li>
<li>Nonnullable type</li>
<li>Monad types</li>
<li>Trait types</li>
<li>Singlton object types</li>
<li>Compound types</li>
<li>Functional Types</li>
<li>Case classes</li>
<li>Path-dependent types</li>
<li>Anonymous types</li>
<li>Self types</li>
<li>Type aliases</li>
<li>Package object</li>
<li>Generic types
<ul>
<li>类型擦除问题</li>
</ul>
</li>
<li>Pattern Match</li>
<li>Bounded generic types</li>
<li>Type Variance</li>
<li>Higher kinded types</li>
<li>Abstract types</li>
<li>Existential types</li>
<li>Implicit types</li>
<li>View bounded types</li>
<li>Structural types</li>
<li>Dotty?</li>
</ul>
<blockquote>
<p>TODO: <a href=http://ktoso.github.io/scala-types-of-types/#type-of-an-code-object-code>http://ktoso.github.io/scala-types-of-types/#type-of-an-code-object-code</a></p>
</blockquote>
<h2 id=社区评论>社区评论</h2>
<p><a href=https://www.zhihu.com/question/28573046>Scala 的语言设计有哪些缺陷？</a></p>
<p>Scala 中提供了相当多的便利，但这与<strong>类型系统</strong>的强大无关，仅仅是因为与<strong>类型</strong>有关。而类型系统的强大之处在于其强大的表现力，能够表示在其它语言中无法表示的事情。</p>
<p>事实上，类型推断是类型系统效率的直接影响因素—它并非那么强大，有些语言拥有完整的类型推断，比如 Haskell。</p>
<p>Scala 中采用局部的基于流的推导，而不是全局式的 HM 推导，导致有些情况不如 Haskell 的推导那么强大。</p>
<p><a href=https://en.wikipedia.org/wiki/Type_inference>维基百科：类型推断</a></p>
<p><a href=https://www.quora.com/Why-doesnt-every-programming-language-have-type-inference>为什么有的语言不支持类型推断？</a></p>
<p>图灵完备：http://www.tuicool.com/articles/rqUjAb</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-00d79aa6b16e32b715022bbfabdbeb44>1.3 - 函数式-基础</h1>
<h2 id=方法>方法</h2>
<p>创建函数最简单的方式就是作为对象的成员，即<strong>方法</strong>。</p>
<h2 id=本地函数>本地函数</h2>
<p>函数式编程风格的一个主要原则就是：程序应该被解构为若干小的函数块，每块实现一个完备的任务，每块都很小。</p>
<p>但是大量的小块函数会污染程序的命名空间，这时可以私有函数，或者另一种方式，<strong>本地函数</strong>，即嵌套函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.io.Source</span>
<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>LongLines</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>processFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filename</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>processLines</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>    <span style=color:#8f5902;font-style:italic>// 打印超出宽度的行, 引用外层的 width
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>width</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filename</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>source</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fromFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filename</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getLines</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>processLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=头等函数>头等函数</h2>
<p>Scala 的函数是头等函数(first-class-function)，不仅可以定义或调用函数，还可以把函数写成匿名字面量，当做值来传递。函数字面量被编译进类，并在运行期实例化为函数值。因此函数字面量与值的区别在于：函数字面量存在于源代码，而函数值作为对象存在于运行期。类似于类(源代码)和对象(运行期)之间的关系。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><p>符号<code>=></code>指：把左边的东西转换为右边的东西。</p>
<p>函数值是对象，因此可以赋给变量。同时也是函数，可以按照通常的函数调用方式，使用一个括号来调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>increase</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#000>increase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#8f5902;font-style:italic>// 3
</span></code></pre></div><p>函数可以由多条语句构成，由大括号包围，组成一个代码块。当函数执行时，所有的语句都会执行，最后一行作为返回值。</p>
<h2 id=函数字面量的短格式>函数字面量的短格式</h2>
<p>可以省略函数字面量中的参数类型来进行简化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>someNumber</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>因为使用这个函数来过滤整数列表<code>someNumber</code>，因此 Scala 可以推断出 x 肯定为整数。这种方式称为<strong>目标类型化(target typing)</strong>。</p>
<p>某些参数的类型是推断的，可以省略参数的括号：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>someNumber</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=占位符语法>占位符语法</h2>
<p>只要每个参数在函数字面量中仅出现一次，可以使用占位符<code>_</code>来代替该参数名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>someNumber</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>但是有时候把下划线当做参数的占位符，编译器可能无法推断缺失的参数类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span>
</code></pre></div><p>因为上面的<code>filter</code>调用是一个整数列表，编译器可以推断，但这里，编译器无从推断，会编译失败。这时，我们可以为参数提供类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这里需要注意的是，这里的两个占位符表示的是需要两个参数，而不是一个参数使用两次。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span>   <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>
<span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span>     <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span>
<span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span>    <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span>
<span style=color:#204a87;font-weight:700>_</span> <span style=color:#000>drop</span> <span style=color:#204a87;font-weight:700>_</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>drop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>在参数较少时，使用这种方式可以使程序更清晰，但是当参数增多，比如<code>foo(_, g(List(_ + 1), _))</code>，则会让程序变得难以理解。</p>
<h2 id=偏应用函数>偏应用函数</h2>
<p>或称为部分应用函数(Partially applied functions)。</p>
<p>可以使用占位符代替一个参数，也可以代替整个参数列表。比如<code>println(_)</code>，或者<code>println _</code>。</p>
<p>这中下划线方式的使用，实际上定义的是一个<strong>部分应用函数</strong>。它是一种表达式，不需要提供函数需要的所有参数，可以只提供部分，或者不提供。</p>
<p>比如一个普通的<code>sum</code>函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>c</span>
</code></pre></div><p>当调用函数时，传入任何需要的参数，实际是把函数应用到参数上。</p>
<p>如果通过<code>sum</code>来创建一个部分应用表达式，不需要提供所需要的参数，只需要在<code>sum</code>之后添加一个下划线，使用空格隔开，然后把得到的函数存入变量：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>_</span>
<span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Int</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>function3</span><span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#8f5902;font-style:italic>// function3 类型的实例
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic>// 6
</span></code></pre></div><p>可以看到，<code>a</code>为一个函数。变量<code>a</code>指向一个函数值对象。这个函数值是由 Scala 编译器依照部分应用函数表达式<code>sum _</code>自动产生的类的一个实例。编译器产生的类有一个<code>apply</code>方法，该方法接收 3 个参数。在通过<code>a</code>进行<code>a(1,2,3)</code>调用时，会被翻译成对函数值的<code>apply</code>方法的调用，即<code>apply(1,2,3)</code>。</p>
<p>可以看到<code>function3</code>的源码定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>/** A function of 3 parameters.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Function3</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>-T1</span>, <span style=color:#204a87;font-weight:700>-T2</span>, <span style=color:#204a87;font-weight:700>-T3</span>, <span style=color:#204a87;font-weight:700>+R</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>AnyRef</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>self</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#8f5902;font-style:italic>/** Apply the body of this function to the arguments.
</span><span style=color:#8f5902;font-style:italic>   *  @return   the result of function application.
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v1</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v2</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v3</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T3</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>R</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>偏应用函数实际上是指该函数未被应用到所有的参数，<code>sum</code>的例子是没有应用到任何参数，也可以只应用到部分参数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Int</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>function1</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><p>这时会发现<code>b</code>为一个<code>function1</code>类型的实例，它接收一个参数。</p>
<p>同时，如果定义的是一个省略所有参数的偏应用函数，比如这里的<code>sum</code>，二者在代码的某个位置需要一个相同签名的函数，这时可以省略掉占位符进行简化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>someNumbers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>someNumbers</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>需要注意的是，只有在需要一个函数的地方才可以省略占位符。比如这里，编译器知道<code>foreach</code>需要一个函数。否则会编译错误。比如：<code>val s = sum</code>，必须是：<code>val s = sum _</code>。</p>
<h2 id=闭包>闭包</h2>
<h2 id=重复参数>重复参数</h2>
<p>可以指定一个函数的最后一个参数是重复的，然后就可以传入可变长度的参数列表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String*</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seq</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;c&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seq</span><span style=color:#204a87;font-weight:700>:_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=尾递归>尾递归</h2>
<h2 id=高阶函数>高阶函数</h2>
<p><strong>函数值</strong>作为参数的函数称为<strong>高阶函数</strong>。</p>
<h3 id=减少代码重复>减少代码重复</h3>
<p>比如我们要实现一个 根据文件名查找文件的程序，首先是<strong>文件名以指定字符串结尾的文件名</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FileMatcher</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesHere</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#000>listFiles</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesEnding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>filesHere</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>file</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>filesHere</code>这里作为一个工具函数来获取所有文件名列表。</p>
<p>现在如果需要的不只是以指定字符串结尾的方式查找，只要是<strong>文件名中包含指定字符串</strong>，或者<strong>以指定的方式能够匹配指定的字符串</strong>，因此我们需要查找的方式是这样的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>filesHere</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>file</span>
</code></pre></div><p><code>method</code>表示匹配方式，但是 Scala 中不支持传入函数名的方式，因此我们可以传递一个函数值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>matcher</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>filesHere</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>file</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>mathcer</code>接收两个字符串，一个是文件名，一个是需要匹配的字符串，返回一个布尔值表示该文件名与指定的字符串是否匹配。因此，我们可以实现我们的不同匹配方式，而对<code>filesMatching</code>函数进行复用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesEnding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesContaining</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesRegex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>类似<code>_.endsWith(_)</code>的部分使用了占位符语法，前面已经提到，函数的参数只被使用一次，且参数顺序与使用顺序一致，则可以使用占位符语法简化。其完整的写法实际是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileName</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>fileName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>简化后会发现，函数<code>filesMatching</code>的参数中，<code>query</code>已经不再需要了，因为该参数只用于<code>matcher</code>函数，并且已经通过匹配方法传入，因此再次进行简化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FileMatcher</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesHere</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#000>listFiles</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>matcher</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>filesHere</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>matcher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>file</span>
    
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesEnding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>endsWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesContains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filesRegex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>filesMatching</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=简化客户端代码>简化客户端代码</h3>
<p>集合 API 提供一些列常用的方法，其中应用了大量的高阶函数，通过将高阶函数作为参数来定义 API，从而使客户端代码更加易于使用。</p>
<p>比如常用的<code>exists</code>、<code>find</code>， 在<code>scala.collection.TraversableLike</code>包中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>exists</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
    <span style=color:#000>breakable</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>break</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>result</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>find</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>None</span>
    <span style=color:#000>breakable</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>break</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#000>result</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>参数<code>p</code>是一个<code>A => Boolean</code>类型的函数，它接收一个参数并放回一个布尔值，用于判断集合中的元素是否满足条件，比如在应用时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>exists</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这里同样应用了占位符语法，使整个操作更加简便。</p>
<h2 id=柯里化>柯里化</h2>
<p>柯里化是将函数应用到<strong>多个参数列表上</strong>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>plainOldSum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>   <span style=color:#8f5902;font-style:italic>// 普通函数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>plainOldSum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>curriedSum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>    <span style=color:#8f5902;font-style:italic>// 柯里化函数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>curriedSum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>在调用柯里化函数时，如果没有一次给出所有的参数列表，比如上面的<code>curriedSum</code>，第一次只提供一个参数列表进行调用<code>curriedSum(1)</code>，这时会返回一个函数值<code>(y: Int) => x + y</code>，调用该函数值并提供另一个参数列表，即<code>(y: Int)</code>，得出最后的求和值。</p>
<p>其过程类似于以下面的方式定义函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>second</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// Int =&gt; Int = &lt;function1&gt;
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>second</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>       <span style=color:#8f5902;font-style:italic>// 3
</span></code></pre></div><p>柯里化函数也可以以下面的方式，使用一个占位符语法，来获取中间的函数值，即上面的<code>second</code>函数值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>onePlus</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>curriedSum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>_</span>    <span style=color:#8f5902;font-style:italic>// Int =&gt; Int = &lt;function1&gt;
</span></code></pre></div><p>调用时提供的占位符<code>_</code>代表第二个参数列表。</p>
<p>同样，可以定义更多个参数列表的柯里化函数，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>multiSum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>z</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>second</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>multiSum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>_</span>   <span style=color:#8f5902;font-style:italic>// Int =&gt; (Int =&gt; Int) = &lt;function1&gt;
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>third</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>second</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>     <span style=color:#8f5902;font-style:italic>// Int =&gt; Int = &lt;function1&gt;
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>third</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>            <span style=color:#8f5902;font-style:italic>// 6
</span></code></pre></div><h2 id=自定义控制结构>自定义控制结构</h2>
<p>因为函数可以作为参数值来传递，因此可以使用该特性来定义自己的控制结构，只需要定义接收函数值的方法即可。</p>
<p>比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>twice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#000>twice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>)</span>   <span style=color:#8f5902;font-style:italic>// 7
</span></code></pre></div><p>一旦发现代码中有重复的控制模式，就可以通过定义一个函数的方式来代替。</p>
<p>比如我们需要一个控制结构，<strong>操作一个文件并最终将其关闭</strong>，这就是一个控制模式，而<strong>操作</strong>部分是主要的处理：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>withPrintWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>File</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>op</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PrintWriter</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>writer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrintWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>withPrintWriter</span><span style=color:#ce5c00;font-weight:700>(</span> 
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;date.txt&#34;</span><span style=color:#ce5c00;font-weight:700>),</span> 
  <span style=color:#000>writer</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>我们可以利用这种模式来实现不同的控制，比如将<code>withPrintWriter</code>实现为一个日志打印过程或缓存更新过程，而操作部分是一次数据库查询。</p>
<p>这种模式成为<strong>借贷模式</strong>。这个例子中，控制抽象函数<code>withPrintWriter</code>打开一个资源，即<code>writer</code>，借贷给<code>op</code>函数，当<code>op</code>函数不再需要时又将其关闭。</p>
<p>但是这种模式的使用方式扛起来并不像是一个控制结构，它就是一个函数调用，然而可以通过使用大括号的方式使其更像是真正的控制结构。</p>
<p>但是在使用大括号进行函数调用时只能接收一个参数，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>println</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;Hello, world!&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#4e9a06>&#34;Hello, world!&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>substring</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#ce5c00;font-weight:700>}</span>    <span style=color:#8f5902;font-style:italic>// error，多个参数必须使用小括号包围参数列表
</span></code></pre></div><p>因此，我们可以将上面的<code>withPrintWriter</code>函数改写为柯里化的方式，每次只接收一个函数，来满足只有一个参数才能使用大括号的要求：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>withPrintWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>File</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>op</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PrintWriter</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>writer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PrintWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后，下面的调用使<code>withPrintWriter</code> 看起来更像一个控制结构：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>withPrintWriter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>writer</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#000>writer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=传名参数>传名参数</h2>
<p>但是上面的例子与内建的控制接口，比如<code>if</code>、<code>while</code>并不相似，因为在大括号中需要传入一个参数，这可以通过<strong>传名参数</strong>实现。</p>
<p>比如定义一个断言函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>assertionsEnabled</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>myAssert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>predicate</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assertionsEnabled</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AssertionError</span>
</code></pre></div><p>然后以下面的方式调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>myAssert</span><span style=color:#ce5c00;font-weight:700>(()</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或许你更希望使用<code>myAssert(5 > 3)</code>的方式来调用，在创建传名参数时可以使用<code>=></code>来代替完整的<code>() =></code>，括号部分实际是函数的参数列表，只不过该函数不接受任何参数，因此省略。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>byNameAssert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>predicate</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assertionsEnabled</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>predicate</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AssertionError</span>

<span style=color:#000>myAssert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>一个传名类型，即其参数列表为空<code>()</code>，并进行省略，这样的用法仅仅在作为参数时可行。</p>
<p>但是根据上面的定义方式，其实与<code>def byNameAssert(predicate:Boolean)</code>没有什么差别了。</p>
<p>真正的差别在于，如果是传入的值，这个值必须在调用<code>byNameAssert</code>之前完成计算，如果是传入的函数，则会在调用之后进行计算。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c64e9cff53f3b069fd014504a1ab2258>1.4 - 函数式-用例</h1>
<h2 id=匿名函数>匿名函数</h2>
<p>匿名函数，或函数字面值，可以将它传递给一个方法，或者赋值给一个变量。</p>
<p>比如过滤集合中的偶数，可以将一个匿名函数传递给集合的 filter 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>range</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>evens</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这里的匿名函数就是<code>(i: Int) => i % 2 == 0</code>。符号<code>=></code>可以认为是一个转换器，将集合中的每个整数 i ，通过符号右边的表达式<code>i % 2 == 0</code>转换为一个布尔值，filter 通过这个布尔值判断这个 i 的去留。</p>
<p>因为 Scala 可以推断类型，因此可以省略掉类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>evens</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>又因为当一个参数在函数中只出现一次时使用通配符 _ 表示，因此可以省略为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>evens</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>在更为常见的场景中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>简略为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>进一步简略：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>再次简略：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>最终，如果由一条语句组成的函数字面量仅接受一个参数，并不需要明确的名字和指定参数，因此最终可以简略为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=像变量一样使用函数>像变量一样使用函数</h2>
<p>可以向传递一个变量一样传递函数，就像是一个 String、Int 一样。</p>
<p>比如需要将一个数字转换为它的2倍，向上一节一样，将<code>=></code>当做一个转换器，这时是将一个数字转换为它的2倍，即：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后将这个函数字面量赋值给一个变量：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>double</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>变量 double 是一个实例，就像 String、Int 的实例一样，但是它是一个函数的实例，作为一个<strong>函数值</strong>，然后可以像方法调用一样使用它：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>double</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// 4
</span></code></pre></div><p>或者将它传递给一个函数或方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>double</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=如何声明一个函数>如何声明一个函数</h3>
<p>已经见过的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>Scala 编译器能够推断出该方法返回一个布尔值，因此这里省略了函数的返回值。一个包含完整类型的声明会是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span>
</code></pre></div><h2 id=将函数作为方法的参数>将函数作为方法的参数</h2>
<p>这种需求的处理过程：</p>
<ol>
<li>定义方法，定义想要接收并作为参数的函数签名</li>
<li>定义一个或多个对应该签名的函数</li>
<li>将需要的函数传入方法</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeFunction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>callback</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>callback</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>签名<code>callback:() => Unit</code>表示该函数不需要参数并返回一个空值。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sayHello</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>executeFunction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sayHello</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这里，方法中定义的函数名并没有实际意义，仅作为方法的一个参数名，就像一个 Int 常被命名为字母 i 一样，这里可以通用定义为任何形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeFunction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同时，传入的函数必须与签名完全一致，签名通用的语法为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>methodParameterName</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>functionParameterType_s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>functionReturnType</span>
</code></pre></div><h2 id=更为复杂的函数>更为复杂的函数</h2>
<p>函数参数的签名为：接收一个整形数字作为参数并返回一个空值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>exec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>callback</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>callback</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// 调用传入的函数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>plusOne</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>exec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>plusOne</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者接收更多参数的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>executeFunction</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者返回一个集合类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>exec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span>
</code></pre></div><p>或者接收函数参数并同时接受其他类型的参数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>executeAndPrint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=使用闭包>使用闭包</h2>
<p>如果需要将函数作为一个参数传递，同时又需要使函数在其声明的作用域引用以存在的变量。比如下面这个例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>exec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>ClosureExample</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>hello</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;hello&#34;</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sayHello</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$hello</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>$name</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>	<span style=color:#8f5902;font-style:italic>// 引入闭包变量 hello
</span><span style=color:#8f5902;font-style:italic></span>  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>foo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>otherscope</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Foo</span>
  <span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>exec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sayHello</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Al&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#000>hello</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hola&#34;</span>			<span style=color:#8f5902;font-style:italic>// 修改本地变量 hello
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>exec</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sayHello</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Lorenzo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Hello</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Al</span>
<span style=color:#000>Hola</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Lorenzo</span>
</code></pre></div><p>在这个例子中，函数 sayHello 在定义时除了声明了一个正式参数 name，同时引用了当前作用域的变量 hello。将 函数 sayHello 作为一个参数传入 exec 方法后，再修改本地变量 hello 的值，sayHello中仍然能够引用到改变后的 hello 的值。这里，Scala 创建了一个闭包。</p>
<p>这里为了简单只只是将 sayHello 传递给了 exec 方法，同样可以将其传递到很远的位置，即多层传递。但是变量并不在 Foo 的作用域或方法 exec 的作用域中，比如在 Foo 中或 exec 中再单独打印 hello 都不会编译通过。</p>
<p>闭包的三个要素：</p>
<ul>
<li>一段代码块可以像值一样传递</li>
<li>任何拥有这段代码块的人都可以在任何时间根据需要执行它</li>
<li>这段代码块可以在创建它的上下文中引用变量</li>
</ul>
<h3 id=创建闭包>创建闭包</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>votingAge</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>18</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>isOfVotingAge</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>votingAge</span>
</code></pre></div><p>现在可以把函数 isOfVotingAge 传递给任意作用域中的函数、方法、对象，同时 votingAge 是可变的，改变它的值同时会引起 isOfVotingAge 函数中对他引用的值的改变。</p>
<h3 id=使用其他数据结构闭包>使用其他数据结构闭包</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fruits</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ArrayBuffer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;apple&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>addToBasket</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#000>fruits</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>s</span> 
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fruits</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;, &#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这时，将 addToBasket 函数传递到其他作用域并执行时，都能够修改 fruits 的值。</p>
<h2 id=使用偏应用函数>使用偏应用函数</h2>
<p>可以定义一个需要多个参数的函数，提供部分参数并返回一个偏函数，它会携带已获得的参数，最终传递给他剩余需要的参数以完成执行：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>c</span>
</code></pre></div><p>它本身需要三个参数，当只提供两个参数时，它会返回一个偏函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>c</span>
<span style=color:#8f5902;font-style:italic>// sum: (Int, Int, Int) =&gt; Int = &lt;function3&gt;
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// f: Int =&gt; Int = &lt;function1&gt;
</span></code></pre></div><p>最后给他提供一个参数，完成整个计算：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// 6
</span></code></pre></div><h2 id=创建返回函数的函数>创建返回函数的函数</h2>
<p>可以定义一个返回函数的函数，将它传递给另一个函数，最终提供需要的参数并调用。</p>
<p>这是一个匿名函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>定义一个函数来生成这个函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>saySomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>prefix</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>s</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以将它赋值给一个变量并通过这个拥有函数值的变量来调用函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sayHello</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>saySomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>sayHello</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Alex&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者更复杂的，根据输入值的不同从而返回不同的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>greeting</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>language</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#000>language</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;english&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Hello, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;spanish&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Buenos dias, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=创建偏函数>创建偏函数</h2>
<p>可以创建一个函数，只对所有可能的输入值的一个子集有效(称为偏函数的原因)，或者一组这样的函数，最后通过组合来完成需要的功能。</p>
<p>定义一个偏函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>divide</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PartialFunction</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>x</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isDefinedAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> 	<span style=color:#8f5902;font-style:italic>// 仅对部分不等于 0 的整数有效
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>divide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isDefinedAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>  					<span style=color:#8f5902;font-style:italic>// true
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>divide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isDefinedAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#000>divide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 42
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>divide</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isDefinedAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>					<span style=color:#8f5902;font-style:italic>// false
</span></code></pre></div><p>或者更为常用的模式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>divide2</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PartialFunction</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87;font-weight:700>d</span> <span style=color:#204a87;font-weight:700>!=</span> <span style=color:#a40000>0</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>d</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>意思就是，它只能接受 Int 类型参数的一部分(d 不等于 0)进行处理并返回一个 Int 值。</strong></p>
<p>使用 case 的方式仍然能够更第一种方式一样判断它是否能够接受一个值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>divide2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isDefinedAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>divide2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isDefinedAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>同时可以使用 orElse 将多个偏函数<strong>组合</strong>，andThen 则是将多个偏函数进行<strong>链接</strong>。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-36fd9712565fdebd8d49b03473b986f8>1.5 - Future-基础</h1>
<h2 id=介绍java-与-scala-中的并发>介绍：Java 与 Scala 中的并发</h2>
<p>Java 通过内存共享和锁来提供并发支持。Scala 中通过不可变状态的转换来实现：Future。虽然 Java 中也提供了 Future，但与 Scala 中的不同。</p>
<p>二者都是通过异步计算来表示结果，但是 Java 中需要使用阻塞的<code>get</code>方法来访问结果，同时可以在调用<code>get</code>之前使用<code>isDone</code>来检查结果是否完成来避免阻塞，但是仍然需要等待结果完成以支持后续使用该结果的计算。</p>
<p>在 Scala 中，无论<code>Future</code>是否完成，都可以对他指定转换过程。每一个转换过程的结果都是一个新的<code>Future</code>，这个新的<code>Future</code>表示通过函数对原始<code>Future</code>转换后得到的结果。计算执行的线程通过一个<strong>隐式</strong>的*execution context(执行上下文)*来决定。以不可变状态串行转换的方式来描述异步计算，避免共享内存和锁带来的额外开销。</p>
<h2 id=锁机制的弊端>锁机制的弊端</h2>
<p>Java 平台中，每个对象都与一个逻辑<strong>监视器</strong>关联，以控制多线程对数据的访问。使用这种模式时需要指定哪些数据会被多线程共享并将被访问的、控制访问的和共享数据的代码段都标记为<strong>synchronized</strong>。Java 运行时使用<strong>锁</strong>的机制来确保同一时间只有一个线程能够进入被锁保护的代码段。以此协调你能够通过多线程来访问数据。</p>
<p>为了兼容性，Scala 提供了 Java 的并发原语。可以在 Scala 中调用方法<code>wait/notify/notifyAll</code>，并且意义与 Java 一致。但是并不提供关键字<code>synchronized</code>，但是预定义了一个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>counter</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#000>synchronized</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 这里同时只能有一个线程
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>counter</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>counter</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是这种模式难于编写可靠的多线程应用。死锁、竟态&mldr;</p>
<h2 id=使用-try-处理异步中的异常>使用 Try 处理异步中的异常</h2>
<p>当你调用一个 Scala 方法时，它会在你<em>等待</em>返回结果时执行一个计算，如果结果是一个<code>Future</code>，它表示另一个异步化执行的计算，通常会被一个完全不同的线程执行。在<code>Future</code>上执行的操作都需要一个<code>excution context</code>来提供异步执行的策略，通常可以使用由 Scala 自身提供的全局执行上下文，在 JVM 上，它使用一个<strong>线程池</strong>。</p>
<p>引入全局执行上下文：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>future</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当一个<code>Future</code>未完成时，可以调用两个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isComplated</span>		<span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>			<span style=color:#8f5902;font-style:italic>// Option[scala.util.Try[Int]] = None
</span></code></pre></div><p>完成后：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isComplated</span>		<span style=color:#8f5902;font-style:italic>// true
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>			<span style=color:#8f5902;font-style:italic>// Option[scala.util.Try[Int]] = Some(Success(42))
</span></code></pre></div><p><code>value</code>方法返回的<code>Option</code>包含一个<code>Try</code>，成功时包含一个类型为 T 的值，失败时包含一个异常，<code>java.lang.Throwable</code>的实例。</p>
<p><code>Try</code>支持在尝试异步计算前进行同步计算，同时支持一个可能包含异常的计算。</p>
<p><strong>同步</strong>计算时可以使用<strong>try/catch</strong>来确保新城调用方法并捕捉、处理方法抛出的异常。但是<strong>异步</strong>计算中，发起计算的线程常会移动到其他任务上，然后当计算中抛出异常时，原始的线程不再能通过<code>catch</code>子句来处理异常。因此使用<code>Future</code>进行异步操作时使用<code>Try</code>来处理可能的失败并生成一个值，而不是直接抛出异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#000>fut</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>scala.concurrent.Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>...</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span> 
<span style=color:#000>res4</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>scala.util.Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>None</span>

<span style=color:#8f5902;font-style:italic>// 10s later
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span> 
<span style=color:#000>res5</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>scala.util.Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ArithmeticException</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>/</span> <span style=color:#204a87;font-weight:700>by</span> <span style=color:#204a87;font-weight:700>zero</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><blockquote>
<p><code>Try</code>的定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Try</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>/** 通过传名参数构造一个 Try。
</span><span style=color:#8f5902;font-style:italic>   * 捕获所有 non-fatal 错误并返回一个 `Failure` 对象。
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>r</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>				<span style=color:#8f5902;font-style:italic>// 常规的 try、catch 调用
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>exception</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div></blockquote>
<h2 id=future-操作>Future 操作</h2>
<h3 id=map>map</h3>
<p>将传递给<code>map</code>方法的函数作用到原始<code>Future</code>的结果并生成一个新的<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>原始<code>Future</code>和<code>map</code>转换可能在两个不同的线程上执行。</p>
<h3 id=for>for</h3>
<p>因为<code>Future</code>声明了一个<code>flatMap</code>方法，因此可以使用<code>for</code>表达式来转换。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span>	<span style=color:#8f5902;font-style:italic>// Future[Int]
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>23</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>23</span> <span style=color:#ce5c00;font-weight:700>}</span>	<span style=color:#8f5902;font-style:italic>// Future[Int]
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fut1</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>y</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fut2</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>			<span style=color:#8f5902;font-style:italic>// Future[Int]
</span></code></pre></div><p>因为<code>for</code>表达式是对转换的<strong>串行化</strong>，如果没有在<code>for</code>之前创建<code>Future</code>并不能达到并行的目的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span> 
	<span style=color:#000>y</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>23</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>23</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>		<span style=color:#8f5902;font-style:italic>// 需要最少 20s 的时间完成计算
</span></code></pre></div><blockquote>
<p><code>for { x &lt;- fut1; y &lt;- fut2 } yield x + y</code>实际会被转化为<code>fut1.flatMap(x => fut2.map(y => x + y))</code>。</p>
<p><code>flatMap</code>的定义：将一个函数作用到<code>Future</code>成功时的结果并生成一个新的Future，如果原<code>Future</code>失败，新的<code>Future</code>将会包含同样的异常。</p>
</blockquote>
<h3 id=创建-future>创建 Future</h3>
<p>上面的例子是通过<code>Future</code>的<code>apply</code>方法来创建：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>body</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#5c35cc;font-weight:700>@deprecatedName</span><span style=color:#ce5c00;font-weight:700>(</span>&#39;execctx<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>executor</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p><code>body</code>是需要执行的异步计算。</p>
<p>创建一个<strong>成功</strong>的<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// def successful[T](result: T): Future[T] = Promise.successful(result).future
</span><span style=color:#8f5902;font-style:italic>// result 为 Future 的结果
</span></code></pre></div><p>创建一个<strong>失败</strong>的<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bummer!&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#8f5902;font-style:italic>// def failed[T](exception: Throwable): Future[T] = Promise.failed(exception).future
</span><span style=color:#8f5902;font-style:italic>// exception 为指定的异常
</span></code></pre></div><p>通过<code>Try</code>创建一个已完成的<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.util.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fromTry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Success</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>})</span>
<span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fromTry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bummer!&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span>
<span style=color:#8f5902;font-style:italic>// def fromTry[T](result: Try[T]): Future[T] = Promise.fromTry(result).future
</span></code></pre></div><p>常用的方式是通过<code>Promise</code>来创建，得到一个被这个<code>Promise</code>控制的<code>Future</code>，当这个<code>Promise</code>完成时对应的<code>Future</code>才会完成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pro</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span>			<span style=color:#8f5902;font-style:italic>// Promise[Int]
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>pro</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>future</span>			<span style=color:#8f5902;font-style:italic>// Future[Int]
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>						<span style=color:#8f5902;font-style:italic>// None
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>pro</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#ce5c00;font-weight:700>)</span>					<span style=color:#8f5902;font-style:italic>// 或者 pro.failure(exception)/pro.complete(result: Try[T])
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>						<span style=color:#8f5902;font-style:italic>// Try[Int]] = Some(Success(42))
</span></code></pre></div><p>或者调用<code>completeWith</code>方法并传入一个新的<code>Future</code>，新的<code>Future</code>一旦完成则用值赋予给这个<code>Priomise</code>。</p>
<h3 id=filter--collect>filter & collect</h3>
<p><code>filter</code>用户验证<code>Future</code>的值，如果满足则保留这个值，如果不满足则会抛出一个<code>NoSuchElementException</code>异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>valid</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>valid</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>		<span style=color:#8f5902;font-style:italic>// Some(Success(42))
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>invalid</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>invalid</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// Some(Failure(java.util.NoSuchElementException: Future.filter predicate is not satisfied))
</span></code></pre></div><p>同时提供了一个<code>withFilter</code>方法，因此可以在<code>for</code>表达式中执行相同的操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>valid</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>res</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>invalid</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>res</span>
</code></pre></div><p><code>collect</code>方法对<code>Future</code>的值进行验证并通过一个操作将其转换。如果传递给<code>collect</code>的<strong>偏函数</strong>符合<code>Future</code>的值，该<code>Future</code>会返回经过偏函数转换后的值，否则会抛出<code>NoSuchElementException</code>异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>valid</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fut</span> <span style=color:#000>collect</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>46</span> <span style=color:#ce5c00;font-weight:700>}</span>		<span style=color:#8f5902;font-style:italic>// Some(Success(88))
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>invalid</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fut</span> <span style=color:#000>collect</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>46</span> <span style=color:#ce5c00;font-weight:700>}</span>	<span style=color:#8f5902;font-style:italic>// NoSuchElementException
</span></code></pre></div><h3 id=错误处理failedfallbacktorecoverrecoverwith>错误处理：failed、fallBackTo、recover、recoverWith</h3>
<h4 id=failed>failed</h4>
<p><code>failed</code>方法将一个任何类型的、错误的<code>Future</code>转换为一个成功的<code>Future[Throwable]</code>，这个<code>Throwable</code>即引起错误的异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>failure</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>			<span style=color:#8f5902;font-style:italic>// Some(Failure(java.lang.ArithmeticException: / by zero))
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>expectedFailure</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>failed</span>
<span style=color:#000>expectedFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// Some(Success(java.lang.ArithmeticException: / by zero))
</span></code></pre></div><p>如果调用<code>failed</code>方法的<code>Future</code>最终是成功的，而调用<code>failed</code>方法返回的<code>Future</code>会以一个<code>NoSuchElementException</code>异常失败。因此，只有当你需要<code>Future</code>失败时，调用<code>failed</code>方法才是适当的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>success</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>			<span style=color:#8f5902;font-style:italic>// Some(Success(42)), 原本是一个成功的 Future
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>unexpectedSuccess</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>failed</span>
<span style=color:#000>unexpectedSuccess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// NoSuchElementException, 称为一个失败的 Future
</span></code></pre></div><h4 id=fallbackto>fallBackTo</h4>
<p><code>fallBackTo</code>方法用于提供一个可替换的<code>Future</code>，以便调用该方法的<code>Future</code>失败时作为备用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fallback</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fallbackTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>fallback</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>
</code></pre></div><p>如果调用<code>fallBackTo</code>方法的原始<code>Future</code>执行失败，传递给<code>fallBackTo</code>的错误本质上会被忽略。但是如果调用<code>fallBackTo</code>提供的<code>Future</code>也失败了，则会返回最初的错误，即原始<code>Future</code>中的错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>failedFallback</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fallbackTo</span><span style=color:#ce5c00;font-weight:700>(</span> 
	<span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>require</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic>// 这里实际是一个 require 异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>failedFallback</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// Some(Failure(java.lang.ArithmeticException: / by zero))，仍然返回了原始 Future 中的除零异常
</span></code></pre></div><h4 id=recover>recover</h4>
<p><code>recover</code>允许将一个失败的<code>Future</code>转换为一个成功的<code>Future</code>，或者原始<code>Future</code>成功时则不作处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>recovered</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failedFallback</span> <span style=color:#000>recover</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ex</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ArithmeticException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>recovered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>		<span style=color:#8f5902;font-style:italic>// Some(Success(-1)), 捕捉异常并设置成功值，返回新的 Future
</span></code></pre></div><p>如果原始<code>Future</code>成功，<code>recover</code>部分会以相同的值完成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>unrecovered</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fallback</span> <span style=color:#000>recover</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ex</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ArithmeticException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>unrecovered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// Some(Success(42))
</span></code></pre></div><p>同时，如果传递给<code>recover</code>的偏函数并不包含原始<code>Future</code>的错误类型，新的<code>Future</code>仍然会以原始<code>Future</code>中的失败完成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>alsoUnrecovered</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failedFallback</span> <span style=color:#000>recover</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ex</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>IllegalArgumentException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>alsoUnrecovered</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// Some(Failure(java.lang.ArithmeticException: / by zero))
</span></code></pre></div><h4 id=recoverwith>recoverWith</h4>
<p><code>recoverWith</code>与<code>recover</code>类似，但是使用的是一个<code>Future</code>值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>alsoRecovered</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failedFallback</span> <span style=color:#000>recoverWith</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ex</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ArithmeticException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>46</span> <span style=color:#ce5c00;font-weight:700>}</span> 	<span style=color:#8f5902;font-style:italic>// 这是一个 Future
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>其他方面的处理则于<code>recover</code>一致。</p>
<h3 id=transform对可能性的映射>transform：对可能性的映射</h3>
<p><code>transfor</code>接收两个转换<code>Future</code>的函数：一个处理原始<code>Future</code>成功的请求，一个处理失败的情况。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>first</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>transform</span><span style=color:#ce5c00;font-weight:700>(</span> 
	<span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> 						<span style=color:#8f5902;font-style:italic>// 成功
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;see cause&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// 失败
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>**注意：**现有的<code>transform</code>并不能将一个成功的<code>Future</code>转换为一个失败的<code>Future</code>，或者反向。只能对成功时的结果进行转换或失败时的异常类型进行转换。</p>
<p>Scala <em>2.12</em> 版本中提供了一种替代的方式，接收<code>Try => Try</code>的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>firstCase</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>transform</span> <span style=color:#ce5c00;font-weight:700>{</span> 		<span style=color:#8f5902;font-style:italic>// 处理成功的 Future
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;see cause&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>))</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>secondCase</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>transform</span> <span style=color:#ce5c00;font-weight:700>{</span> 		<span style=color:#8f5902;font-style:italic>// 处理失败的 Future
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;see cause&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>))</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nonNegative</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>transform</span> <span style=color:#ce5c00;font-weight:700>{</span> 		<span style=color:#8f5902;font-style:italic>// 将失败转换为成功
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>abs</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=组合-futurezipfoldreducesequencetraverse>组合 Future：zip、fold、reduce、sequence、traverse</h3>
<h4 id=zip>zip</h4>
<p><code>zip</code>方法将两个成功的<code>Future</code>转换为一个新的<code>Future</code>，其值两个<code>Future</code>值的元组。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>zippedSuccess</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>success</span> <span style=color:#000>zip</span> <span style=color:#000>recovered</span>		<span style=color:#8f5902;font-style:italic>// scala.concurrent.Future[(Int, Int)]
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>zippedSuccess</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>								<span style=color:#8f5902;font-style:italic>// Some(Success((42,-1)))
</span></code></pre></div><p>如果其中一个失败，<code>zip</code>方法的值会以同样的异常失败：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>zippedFailure</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>success</span> <span style=color:#000>zip</span> <span style=color:#000>failure</span>
<span style=color:#000>zippedFailure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>		<span style=color:#8f5902;font-style:italic>// Some(Failure(java.lang.ArithmeticException: / by zero))
</span></code></pre></div><p>如果两个都失败，结果值会包含最初的异常，即调用<code>zip</code>方法的那个<code>Future</code>的异常。</p>
<h4 id=fold>fold</h4>
<blockquote>
<p><code>trait TraversableOnce[+A] extends GenTraversableOnce[A]</code></p>
<p>可以被贯穿一次或多次的集合的模板特质。它的存在主要用于消除<code>Iterator</code>和<code>Traversable</code>之间的重复代码。包含一系列抽象方法并在<code>Iterator</code>和<code>Traversable</code>..中实现，这些方法贯穿集合中的部分或全部元素并返回根据操作生成的值。</p>
</blockquote>
<p><code>fold</code>方法通过穿过一个<code>TraversableOnce</code>的<code>Future</code>集合来累积值，生成一个<code>Future</code>结果。如果集合中的所有<code>Future</code>都成功了，结果<code>Future</code>会以累积值成功。如果集合中任何一个失败，结果<code>Future</code>就会失败。如果多个<code>Future</code>失败，结果中会包含第一个失败的错误。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fortyTwo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fortySix</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>23</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>23</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futureNums</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fortyTwo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fortySix</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>folded</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fold</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futureNums</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 	<span style=color:#8f5902;font-style:italic>// (0), 提供一个累积值的初始值
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>num</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>folded</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>								<span style=color:#8f5902;font-style:italic>// Some(Success(88))
</span></code></pre></div><h4 id=reduce>reduce</h4>
<p><code>reduce</code>方法与<code>fold</code>类似，但是不需要提供初始的默认值，它使用最初的<code>Future</code>的结果作为开始值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>reduced</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reduce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futureNums</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>num</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>reduced</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// Some(Success(88))
</span></code></pre></div><p>如果给<code>reduce</code>方法传入一个空的集合，则会以<code>NoSuchElementException</code>异常失败，因为没有初始值。</p>
<h4 id=sequence>sequence</h4>
<p><code>sequence</code>方法将一个<code>TraversableOnce</code>的<code>Future</code>集合转换为一个包含<code>TraversableOnce</code>值的Future。比如<code>List[Future[Int]] => Future[List[Int]]</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futureList</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futureNums</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>futureList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>	<span style=color:#8f5902;font-style:italic>// Some(Success(List(42, 46)))
</span></code></pre></div><h4 id=traverse>traverse</h4>
<p><code>traverse</code>方法将一个包含任意元素类型的<code>TraversableOnce</code>转换为一个<code>TraversableOnce</code>的<code>Future</code>，并且这个<em>序列</em>转换为一个<code>TraversableOnce</code>值的<code>Future</code>。比如，<code>List[Int] => Future[List[Int]]</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>traversed</span> <span style=color:#204a87;font-weight:700>=</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>traverse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>	<span style=color:#8f5902;font-style:italic>// .Future[List[Int]]
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>traversed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>		<span style=color:#8f5902;font-style:italic>// Some(Success(List(1, 2, 3)))
</span></code></pre></div><h3 id=执行副作用foreachoncompleteandthen>执行副作用：foreach、onComplete、andThen</h3>
<p>有时需要在<code>Future</code>完成时执行一些副作用，而不是通过<code>Future</code>生成一个、一些值。</p>
<h4 id=foreach>foreach</h4>
<p>最基本的<code>foreach</code>方法会在<code>Future</code><strong>成功</strong>完成时执行一些副作用。失败时将不会执行：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>))</span>		<span style=color:#8f5902;font-style:italic>// 不会执行
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>))</span>	<span style=color:#8f5902;font-style:italic>// 42
</span></code></pre></div><p>因为不带<code>yield</code>的<code>for</code>表达式会被重写为一个<code>foreach</code>执行，因此也可以使用<code>for</code>表达式来实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h4 id=oncomplete>onComplete</h4>
<p>这是<code>Future</code>的一种<strong>回调</strong>函数，无论<code>Future</code>最终成功或失败，<code>onComplete</code>方法都会执行。它需要被传入一个<code>Try</code>：<code>Success</code>用于处理成功的情况，<code>Failure</code>用于处理失败的情况：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>success</span> <span style=color:#000>onComplete</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=andthen>andThen</h4>
<p><code>Future</code>并不会保证通过<code>onComplete</code>注册的回调函数的执行顺序。如果需要保证回调函数的执行顺序，可以使用<code>andThen</code>方法代替，它是<code>Future</code>的两一个回调函数。</p>
<p><code>andThen</code>方法返回一个对原始<code>Future</code>映射(即与原始 Future 同样的方式成功或失败)的新<code>Future</code>，但是当回调完全执行后才会完成。<strong>它的功能是，既不影响原始 Future 的结果，又能在原始 Future 完成时执行一些回调。</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>newFuture</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>success</span> <span style=color:#000>andThen</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#0000cf;font-weight:700>42</span>					<span style=color:#8f5902;font-style:italic>// 在回调中打印 结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>newFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>		<span style=color:#8f5902;font-style:italic>// Some(Success(42)), 同时仍然保持了原始 Future 的值
</span></code></pre></div><p>但是需要注意的是，如果传递给<code>andThen</code>的函数如果在执行时引发异常，该异常会传递给后续的回调或者通过结果<code>Future</code>呈现。</p>
<h3 id=212-中的新方法>2.12 中的新方法</h3>
<h4 id=flatten>flatten</h4>
<p><code>flatten</code>方法将一个嵌套的<code>Future</code>转换为一个单层的<code>Future</code>，即<code>Future[Future[Int]] =>Future[Int] </code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nestedFuture</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>}</span>		<span style=color:#8f5902;font-style:italic>// Future[Future[Int]]
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>flattened</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>nestedFuture</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatten</span>			<span style=color:#8f5902;font-style:italic>// Future[Int]
</span></code></pre></div><h4 id=zipwith>zipWith</h4>
<p><code>zipWith</code>方法实质上是对两个<code>Future</code>执行<code>zip</code>方法，并将结果元组执行一个<code>map</code>调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futNum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futStr</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;ans&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;wer&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>zipped</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>futNum</span> <span style=color:#000>zip</span> <span style=color:#000>futStr</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>mapped</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>zipped</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$num</span><span style=color:#4e9a06> is the </span><span style=color:#4e9a06>$str</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用<code>zipWith</code>只需要一步：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>futNum</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zipWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futStr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Scala 2.12 
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>num</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$num</span><span style=color:#4e9a06> is the </span><span style=color:#4e9a06>$str</span><span style=color:#4e9a06>&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h4 id=transformwith>transformWith</h4>
<p><code>transformWith</code>支持通过一个<code>Try => Future</code>的函数来转换<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>flipped</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>transformWith</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Scala 2.12 
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该方法实质上是对<code>transform</code>方法的重写，它支持生成一个<code>Future</code>而不是生成一个<code>Try</code>。</p>
<h2 id=测试-future>测试 Future</h2>
<p>Future 的作用在于避免<strong>阻塞</strong>。在很多 JVM 实现上，创建上千个线程之后，线程间的上下文切换对性能的影响达到不能接受的程度。通过避免阻塞，可以繁忙时维持有限的线程数。不过，Scala 支持在需要的时候阻塞<code>Future</code>的结果，通过<code>Await</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Await</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>15.</span><span style=color:#000>seconds</span><span style=color:#ce5c00;font-weight:700>)</span> 		<span style=color:#8f5902;font-style:italic>// &lt;= blocks
</span></code></pre></div><p>然后就可以对其结果进行测试：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.scalatest.Matchers._</span>
<span style=color:#000>x</span> <span style=color:#000>should</span> <span style=color:#000>be</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者直接通过特质<code>ScalaFutures</code>提供的阻塞结构来测试。比如<code>futureValue</code>方法，它会阻塞直到<code>Future</code>完成，如果<code>Future</code>失败，则会抛出<code>TestFailedException</code>异常。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.scalatest.concurrent.ScalaFutures._</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fut</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>fut</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>futureValue</span> <span style=color:#000>should</span> <span style=color:#000>be</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#ce5c00;font-weight:700>)</span>			<span style=color:#8f5902;font-style:italic>// &lt;= futureValue 阻塞
</span></code></pre></div><p>或者使用 <strong>ScalaTest 3.0</strong> 提供的异步测试风格：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.scalatest.AsyncFunSpec</span> 
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.Future</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AddSpec</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AsyncFunSpec</span> <span style=color:#ce5c00;font-weight:700>{</span>

	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>addSoon</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addends</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#204a87;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>addends</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>}</span>

	<span style=color:#000>describe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;addSoon&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
		<span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;will eventually compute a sum of passed Ints&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
			<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futureSum</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>addSoon</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span> 
			<span style=color:#8f5902;font-style:italic>// You can map assertions onto a Future, then return 
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#8f5902;font-style:italic>// the resulting Future[Assertion] to ScalaTest: 
</span><span style=color:#8f5902;font-style:italic></span>			<span style=color:#000>futureSum</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>assert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
		<span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-345d7988748fae2d87d7220ff04727a1>1.6 - Future-用例</h1>
<h2 id=在-akka-中实现事务>在 Akka 中实现事务</h2>
<p>因为 Akka 中的<code>ask</code>模式有超时问题，这种方式不易于多重逻辑处理与 Debug，因此可以使<code>send</code>模式与<code>Promise</code>组合的方式来实现与其他 actor 的通信：在当前 actor 中创建<code>Promise</code>，通过<code>send</code>发送给其他 actor 引用，在其他 actor 中完成对<code>Promise</code>的填充，然后在当前 actor 中来处理这个被填充后的<code>Promise</code> - 即处理一个<code>Future</code>。</p>
<p>如果需要同时与多个 actor 通信，拿到所有 actor 的结果 - 即多个由<code>Promise</code>填充后生成的<code>Future</code>，才能完成后续的逻辑处理 - 即事务部分。只需要通过<code>for</code>表达式的方式来实现“所有需要的<code>Future</code>“都已完成。但是多个<code>Future</code>中任何一部分都会引发异常，包括事务部分，因此在最后的结果失败处理(事务回调)中要对所有的错误情况进行处理，比如通知其他的各个 actor 将刚才的操作分别进行回滚(比如买了一个东西，事务失败，重新将这个东西放回库存中，或者同时，将用户账户的余额扣款取消)。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Promise</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fundsPromise</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Funds</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Funds</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sharesPromise</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Shares</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Shares</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#000>buyerActor</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>GetFunds</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fundsPromise</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>sellerActor</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>GetShares</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numShares</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>stock</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>sharesPromise</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futureFunds</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fundsPromise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>future</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futureShares</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>sharesPromise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>future</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>transact</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>funds</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Funds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>shares</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Shares</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ResultType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 一些事务操作，比如更新数据库、缓存等
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 这里也可能引发一些异常
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>purchase</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>funds</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>futureFunds</span>
  <span style=color:#000>shares</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>futureShares</span>
  <span style=color:#8f5902;font-style:italic>// if ... 一些条件等等
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>transact</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>funds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>shares</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// 通过回调来处理事务结果
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>purchase</span> <span style=color:#000>onComplete</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>transcationResult</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  	<span style=color:#000>buyerActor</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>PutShares</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numShares</span><span style=color:#ce5c00;font-weight:700>)</span>
  	<span style=color:#000>sellerActor</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>PutFunds</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span>
  	<span style=color:#8f5902;font-style:italic>// 通知其他系统事务执行成功
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  	<span style=color:#8f5902;font-style:italic>// 分别检查各个操作是否成功，成功则通知其进行对应的回滚操作
</span><span style=color:#8f5902;font-style:italic></span>  	<span style=color:#000>futureFunds</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>onSuccess</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span>  <span style=color:#000>buyerActor</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>PutFunds</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  	<span style=color:#000>futureShares</span> <span style=color:#000>onSuccess</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>sellerActor</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>PutShares</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numShares</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  	<span style=color:#8f5902;font-style:italic>// 通知其他系统事务执行失败
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在处理事务结果部分，如果需要得到值而不是以通知(副作用)的方式，并对事务结果进行检查以执行其他操作(回滚等)，可以使用<code>andThen</code>方法，而不是通过<code>onComplete</code>对调：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>purchaesResult</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>purchase</span> <span style=color:#000>andThen</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>res</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>???</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// 然后再响应给客户端或其他后续的处理，而不需要在 onComplete 中编写大量嵌套很深的逻辑
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>purchaesResult</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><blockquote>
<p>另一种解决方案是创建一个临时的 actor 来保存状态。</p>
</blockquote>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-03862b6752d201698ebf96b345add63e>1.7 - Future-集合</h1>
<p>**主要解决的问题：**处理<code>Future</code>的集合，使用分组方式避免一次将过多的<code>Future</code>压入执行器队列。有效处理，每个单独<code>Future</code>可能引发的异常，同时不会丢弃<code>Future</code>的结果，对所有的<code>Future</code>结果进行累积并返回。最后抽象为一种清晰易复用的模式提供使用。</p>
<blockquote>
<p>Scala、Akka 中的<code>Future</code>并不是 lazy 的，一旦构造会立即执行。而<code>scalaz</code>中为 lazy。Lazy 性质的<code>Future</code>实际是创建一个<strong>执行计划</strong>，并被最终的调用者执行。这种技术有很多优势，而本文基于标准的<code>Future</code>。</p>
</blockquote>
<p>示例需要的所有引入：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.language.higherKinds</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.collection.generic._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.duration._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>ExecutionContext.Implicits.global</span>
</code></pre></div><h2 id=多次调用返回-future-的方法>多次调用返回 Future 的方法</h2>
<p>首先是一个返回<code>Future</code>的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>MyService</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyServiceImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MyService</span> <span style=color:#ce5c00;font-weight:700>{</span>
 <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#ce5c00;font-weight:700>);</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>有些场景下需要调用多次：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>svc</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>MyService</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyServiceImpl</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>someInts</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toList</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>someInts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>doSomething</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>然而这会创建一个<code>List[Future[Unit]]</code>，其中包含 20 个会<strong>立即执行</strong>的<code>Future</code>，20 个还好，如果是成百上千个则难以承受。</p>
<p>程序内部，执行器会将<code>Future</code>存入队列，并使用所有可用的 worker 来执行尽可能多的<code>Future</code>。一次将过多的<code>Future</code>压入队列将会使其他需要执行器的代码进入<strong>饥饿状态</strong>并引起内存溢出错误。</p>
<p>另一方面，所有<code>svc.doSomething</code>的返回值被丢弃并赋予一个<code>Unit</code>。这里不但没有正确的等待<code>Future</code>完成，而且还把<code>Future</code>分配为<code>Unit</code>，这会扔掉所有可能的异常。</p>
<h2 id=不能将-future-指派为-unit>不能将 Future 指派为 Unit</h2>
<p>为了避免将<code>Future</code>指派为<code>Unit</code>，可以使用<code>map</code>来替换<code>foreach</code>。同时，需要一种方式来等待所有的<code>Future</code>完成。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futResult</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>{</span>											<span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>someInts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>doSomething</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>							<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Await</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Duration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Inf</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 3
</span></code></pre></div><ol>
<li>使用<code>map</code>将不会丢弃<code>Future</code>的结果</li>
<li>使用<code>Future.sequence</code>将<code>List[Future[Unit]]</code>转换为<code>Future[List[Unit]]</code></li>
<li>恰当的等待所有<code>Future</code>完成，这时可以安全的丢弃<code>List[Unit]</code>，因为没有抛出任何异常</li>
</ol>
<p>当<code>svc.doSomething</code>调用过程中抛出异常时会通过<code>Await.result</code>体现。</p>
<p><code>Future.sequence</code>会等待所有内部的<code>Future</code>完成，一旦完成，外部的<code>Future</code>则会完成。</p>
<blockquote>
<p>Future.sequence 源码</p>
</blockquote>
<h2 id=控制-future-的执行流程>控制 Future 的执行流程</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#000>someInts</span>
  	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>grouped</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>										<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span>  	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toList</span>
  	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>group</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  	  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>innerFutResult</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> 		<span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>  	    <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sequence</span> <span style=color:#ce5c00;font-weight:700>{</span>
  		  <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>doSomething</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>Await</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>innerFutResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Duration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Inf</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 3
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}.</span><span style=color:#000>flatten</span>										<span style=color:#8f5902;font-style:italic>// 4
</span></code></pre></div><ol>
<li>将<code>someInts</code>每 3 个分成一组</li>
<li>每一组创建一个<code>Future[List[Unit]]</code></li>
<li>使用<code>Await.result</code>等待每一个内部分组完成</li>
<li>因为将<code>someInts</code>分割成了多个小组，这时需需要使用<code>flatten</code>将整个嵌套的分组展开</li>
</ol>
<p>这样可以很好的解决一次将大量的<code>Future</code>压入执行器队列，同时使用<code>map</code>也不会丢弃<code>Future</code>的结果。但是有个问题就是这种方式不会返回一个<code>Future</code>结果，因为<code>Await.result</code>的使用使整个执行变成了部分同步阻塞。在实际的异步编程中，这样是不可取的。</p>
<h2 id=返回-future>返回 Future</h2>
<p>为了使结果为<code>Future</code>，下面是新的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futResult</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>someInts</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>grouped</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toList</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]())){</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futAccumulator</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>	<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span>  	  <span style=color:#000>futAccumulator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>accumulator</span> <span style=color:#204a87;font-weight:700>=&gt;</span>								<span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>  		<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futInnerResult</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> 
  		  <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sequence</span> <span style=color:#ce5c00;font-weight:700>{</span>
  			<span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>doSomething</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
		  <span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#000>futInnerResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>innerResult</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>accumulator</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>innerResult</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 3
</span><span style=color:#8f5902;font-style:italic></span>	  <span style=color:#ce5c00;font-weight:700>}</span>  
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Await</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futResult</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Duration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Inf</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><ol>
<li>使用<code>foldLeft</code>替换<code>map</code>，这样可以确保一次只处理一个组，然后当每个组完成时，从左到右对每个组进行累积。累计器被初始化为一个已完成的<code>Future.successful(List[Unit]())</code>。</li>
<li>使用<code>Future.flatMap</code>替换<code>Future.map</code>，这里用于展开返回结果的类型为<code>Future[List[Unit]]</code>。如果使用<code>map</code>，返回结果将会是<code>Future[Future[List[Unit]]]</code>。</li>
<li>一旦一个分组完成，将结果进行累积。</li>
</ol>
<p>现在返回结果已经是一个<code>Future</code>了，但是这种使用模式很常见，但上面的写法难以复用，因此需要简化其复杂性。</p>
<h3 id=简化>简化</h3>
<p>这里将会使用 for 表达式，并使用值类(value class)来实现<code>pimp-my-library</code>模式，<code>pimp-my-library</code>模式将会创建一个隐式包装器类，将方法添加到已有的类上，本质上以面向对象的方式调用新的方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Future_PimpMyFuture</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AnyVal</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Await</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Duration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Inf</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Future_PimpMyTraversableOnceOfFutures</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>AA</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>TraversableOnce</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>AA</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AnyVal</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/** @return a Future of M[A] completes once all futures have completed */</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>cbf</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>CanBuildFrom</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span>, <span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]],</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span>
      <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后以下面的方式使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futResult</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>someInts</span>
      <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>grouped</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toList</span>
      <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]()))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futAccumulator</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span> 														<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#000>accumulator</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>futAccumulator</span>
          <span style=color:#000>innerResult</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>doSomething</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>sequence</span> 		<span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>accumulator</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>innerResult</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
 
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>futResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> 									<span style=color:#8f5902;font-style:italic>// 3
</span></code></pre></div><ol>
<li>将<code>Future.flatMap</code>和嵌套的<code>Future.map</code>替换为更清晰易懂的 for 表达式</li>
<li>使用上面预定义的“语法糖方法”替换<code>Future.sequence</code></li>
<li>使用上面预定义的“语法糖方法”替换<code>Await.result</code></li>
</ol>
<h3 id=再次简化>再次简化</h3>
<p>在一个新的值类<code>Future_PimpMyTraversableOnce</code>创建另一个<code> pimp-my-library</code>方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Future_PimpMyTraversableOnce</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>AA</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>TraversableOnce</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>AA</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AnyVal</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>/** @return a Future of M[B] that completes once all futures have completed */</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mapAsync</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>groupSize</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#204a87;font-weight:700>implicit</span>
      <span style=color:#000>cbf</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>CanBuildFrom</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span>, <span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]],</span>
      <span style=color:#000>cbf2</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>CanBuildFrom</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Nothing</span>, <span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]],</span>
      <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>self</span>
       <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toList</span> 		<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span>       <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>grouped</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>groupSize</span><span style=color:#ce5c00;font-weight:700>)</span>
       <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]()))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>futAccumulator</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
         <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span>
           <span style=color:#000>accumulator</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>futAccumulator</span>
           <span style=color:#000>innerResult</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>sequence</span>
         <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>accumulator</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>innerResult</span>
       <span style=color:#ce5c00;font-weight:700>}</span>
       <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>to</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li>转换为<code>List</code>以有效的进行结果累积</li>
<li>转换为预期的集合</li>
</ol>
<p>然后使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>futResult</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>someInts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mapAsync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>svc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>doSomething</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>futResult</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-53dd68b410adf48ef7846943c9c339db>1.8 - Future-Promise</h1>
<h2 id=介绍>介绍</h2>
<p><code>Promise</code>是一个可以被一个值或一个异常完成的对象。并且只能完成一次，完成后就不再可变。称为单一赋值变量，如果再次赋值则会引发异常。</p>
<p><code>Promise</code>值的类型为<code>Promise[T]</code>，可以通过其伴生对象中的<code>Promise.apply()</code>创建一个实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>调用该方法后会立即返回一个<code>Promise</code>实例，它是非阻塞的。当新的<code>Promise</code>对象被创建后，不会包含值或异常，通过<code>success</code>和<code>failure</code>方法分别赋值为<strong>值</strong>或<strong>异常</strong>。</p>
<p>通过<code>complete</code>可以提供一个<code>Try[T]</code>实例来填充<code>Promise</code>，这时<code>Promise</code>的值是一个值还是一个异常，取决于<code>Try[T]</code>最终是一个包含值的<code>Sucess</code>还是一个包含异常的<code>Failure</code>对象。</p>
<p>每个<code>Promise</code>对象都明确对应一个<code>Future</code>对象，通过<code>future</code>方法获取关联的<code>Future</code>对象，并且无论调用该方法多少次，都会放回相同的<code>Future</code>对象。</p>
<p>与<code>success/failure/complete</code>对应的方法是<code>trySuccess/tryFailure/tryCompletee</code>，这些方法会尝试对<code>Promise</code>进行赋值并返回赋值操作是否成功的布尔值。而基本的<code>success/failure/complete</code>操作返回的是则是对原<code>Promise</code>的引用。</p>
<h2 id=object-promise>object Promise</h2>
<p><code>Promise</code>的伴生对象，一共定义了四种构造器。</p>
<h3 id=apply>apply</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DefaultPromise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]()</span>
</code></pre></div><p>它不接受然和参数，创建一个能够被类型为<code>T</code>的值完成的<code>Promise</code>对象。即创建它时只需要设置预期被完成的值的类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>promise</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>User</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>User</span><span style=color:#ce5c00;font-weight:700>]()</span>
</code></pre></div><h3 id=fromtry>fromTry</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>def fromTry[T](result: Try[T]): Promise[T] = new impl.Promise.KeptPromise[T](result)
</code></pre></div><p>提供一个<code>Try[T]</code>类型的值，并返回一个被完成后的<code>Promise</code>对象。这个结果<code>Promise</code>中是一个值还是异常，取决于传入的<code>Try[T]</code>最终是一个<code>Success</code>还是一个<code>Failure</code>。</p>
<h3 id=failed>failed</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>exception</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fromTry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>通过传入一个异常创建一个被该异常完成的<code>Promise</code>对象。</p>
<h3 id=successful>successful</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>fromTry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>通过传入一个值创建一个被该值完成的<code>Promise</code>对象。</p>
<h2 id=trait-promise>trait Promise</h2>
<h3 id=iscompleted>isCompleted</h3>
<p>判断该<code>Promise</code>是否已被完成，返回一个布尔值。</p>
<h3 id=complete--trycomplete>complete & tryComplete</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>complete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tryComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>this</span> 
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Promise already completed.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tryComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span>
</code></pre></div><p><code>tryComplete</code>方法尝试通过传入的<code>Try[T]</code>来完成该<code>Promise</code>，返回一个该操作成功失败的布尔值。<strong>需要注意的是，虽然返回的是一个布尔值，但这个布尔值表示，该 Promise 之前没有被完成并且已经被当前的操作完成，或在调用该方法之间就已经被完成。</strong></p>
<p>因此，在<code>complete</code>方法中，通过传入一个<code>Try[T]</code>来完成一个<code>Promise</code>，实际上会在内部调用<code>tryComplete</code>，如果``tryComplete<code>返回</code>true<code>，表示该</code>Promise<code>还没有被完成并通过这次操作成功完成，同时返回该</code>Promise`的引用，否则则报错已经被完成过。</p>
<h3 id=completewith--trycompletewith>completeWith & tryCompleteWith</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>completeWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tryCompleteWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tryCompleteWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>other</span> <span style=color:#000>onComplete</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#000>tryComplete</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>this</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>与<code>complete</code>和<code>tryComplete</code>类似，不过他接收的是一个<code>Future[T]</code>而不是一个<code>Try[T]</code>。</p>
<h3 id=success--trysuccess>success & trySuccess</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@deprecatedName</span><span style=color:#ce5c00;font-weight:700>(</span>&#39;v<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>complete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>trySuccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tryComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p><code>success</code>方法通过一个值来完成<code>Promise</code>，而<code>trySuccess</code>则首先将传入的值包装为一个<code>Success[T ]</code>然后调用前面的<code>tryComplete</code>方法，尝试完成<code>Promise</code>并返回一个布尔值。</p>
<h3 id=failure--tryfailure>failure & tryFailure</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@deprecatedName</span><span style=color:#ce5c00;font-weight:700>(</span>&#39;t<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>cause</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>complete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tryFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@deprecatedName</span><span style=color:#ce5c00;font-weight:700>(</span>&#39;t<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>cause</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tryComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>与<code>success</code>和<code>trySuccess</code>处理过程相同，只是通过一个异常而不是一个值来完成<code>Promise</code></p>
<h3 id=future>future</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>future</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>获取该<code>Promise</code>对应的<code>Future</code>。</p>
<h2 id=总结>总结</h2>
<ul>
<li>一个<code>Promise</code>有两种构造方式，构造为未完成的、构造为已完成的</li>
<li>一个<code>Promise</code>只能调用完成方法一次，无论是哪个完成方法，再次调用将抛出已完成异常</li>
<li>一个<code>Promise</code>只与一个<code>Future</code>对应，无论调用多少次<code>future</code>方法都会返回相同的<code>Future</code></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f6b210095ad56eccf48a41b9153855c7>1.9 - Implicits-基础</h1>
<blockquote>
<p>《Programming in Scala 3rd》- Implicit Conversions And Parameters</p>
</blockquote>
<p>主要解决的问题是扩展已有的对象。</p>
<h2 id=隐式转换>隐式转换</h2>
<p>每个库对实质上相同的概念有其各自不同的编码方式，隐式转换用于减少两种类型之间的显式转换操作。</p>
<h2 id=隐式-规则>隐式-规则</h2>
<p>这些隐式定义是编译器允许的、被用于插入到程序中以用来解决类型错误问题。</p>
<ul>
<li>标记规则：只有那些被关键字<code>implicit</code>标记的定义</li>
<li>作用域规则：被插入的隐式转换在作用域中必须是一个<strong>单独的</strong>标示符，或者是在被转换对象的<strong>伴生对象</strong>中。必须直接引入该隐式定义，而不是拥有该定义的对象。比如需要<code>convert</code>，它属于一个对象<code>object</code>，只有直接通过<code>import object.convert</code>才有效。需要的隐式定义在伴生对象中时则不需要显式引入。</li>
<li>一次一个规则：只有一个隐式被插入。编译器永远不会将<code>x + y</code>重写为<code>convert1(convert2(x)) + y</code>。</li>
<li>显式优先规则：无论何时以代码编写的方式类型检查，都不会尝试隐式。编译器不会再去改变已经运行的代码。因此你可以随时使用显式定义替换隐式定义。</li>
</ul>
<h2 id=隐式转换到一个指定的类型>隐式转换到一个指定的类型</h2>
<p>如果编译器看到一个 X，但是需要的是一个 Y，这时他会寻找隐式转换函数来将 X 转换为 Y。</p>
<h2 id=隐式转换方法调用者>隐式转换方法调用者</h2>
<p>如果编译器看到如下代码<code>obj.toInt</code>，但是对象<code>obj</code>并不拥有<code>toInt</code>方法，这是会尝试查找拥有该方法的类型并尝试进行隐式转换。</p>
<h2 id=与新类型互操作>与新类型互操作</h2>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b2d97cfd6483b6a64d7323c052c614bb>1.10 - Implicits-进阶</h1>
<p>隐式转换的用途：</p>
<ul>
<li>DSL</li>
<li>Type evidence</li>
<li>减少代码冗余</li>
<li>Type class</li>
<li>编译期 DI</li>
<li>扩展现有库</li>
</ul>
<p>需要注意的地方：</p>
<ul>
<li>解决规则会变得困难</li>
<li>自动转换</li>
<li>不要过度使用</li>
</ul>
<h2 id=隐式转换>隐式转换</h2>
<p>一个普通的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>makeString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;makeString: </span><span style=color:#4e9a06>${</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</code></pre></div><p>以正常方式调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>makeString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>但是如果我们有一个其他非 Int 类型的对象需要作为该方法的参数，则需要提供一个隐式转换，将其他类型转换为需要的 Int 类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Balance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>balance</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Balance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>balance2Int</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>balance</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Balance</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>balance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>amount</span>
<span style=color:#000>makeString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>balance</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=javaconversion--javaconverters>JavaConversion & JavaConverters</h3>
<p>在与 Java 互操作时，比如我们的方法需要一个 Scala 类型的集合，而原有代码只能提供 Java 类型的集合，这时可以引入 Scala 中预定义的两种类型的隐式转换：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>javaList</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>java.util.List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>someDefUsingSeq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seq</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.collection.JavaConversions._</span>
<span style=color:#000>someDefUsingSeq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaList</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者以更好的方式，在转换时显示指定：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.collection.JavaConverters</span>
<span style=color:#000>someDefUsingSeq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>javaList</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>asScala</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=隐式视图>隐式视图</h3>
<p>如果我们需要包装或扩展一个已有的类型对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>quoted</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$s</span><span style=color:#4e9a06>&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以以下面的方式调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;string&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>quoted</span>
</code></pre></div><p>但是并不能以下面的方式调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;string&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>quoted</span>
</code></pre></div><p>这时，可以定义一个从<code>String</code>到<code>StringWrapper</code>的<strong>视图</strong>作为隐式转换：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>warpString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>StringWrapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringWrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#4e9a06>&#34;string&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>quoted</span>		<span style=color:#8f5902;font-style:italic>// &#34;string&#34; 会通过隐式转换自动转换为一个 StringWrapper 对象
</span></code></pre></div><p><strong>视图绑定</strong>：废弃。</p>
<h2 id=隐式参数>隐式参数</h2>
<p>声明一个带有隐式参数的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>giveMeAnInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>i</span>
</code></pre></div><p>可以以正常的方式调用该方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>giveMeAnInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>以隐式的方式提供参数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>someInt</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100</span>
<span style=color:#000>giveMeAnInt</span>	<span style=color:#8f5902;font-style:italic>// 100
</span></code></pre></div><p>但是如果同时提供多个隐式 Int 类型值，则会报错。</p>
<h2 id=隐式类>隐式类</h2>
<p>假如其他的库已经定义了一个类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Balance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>balacne</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100</span>
</code></pre></div><p>如果这时我们想对它做些操作，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>balance</span>
</code></pre></div><p>这时，我们可以创建一个包装类来扩展它：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RichBalance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>balance</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Balance</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unary</span><span style=color:#ce5c00;font-weight:700>-:</span> <span style=color:#000>Balance</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>balance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>copy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>amount</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>balance</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种用法主要用于扩展其他已有的库或类型。</p>
<h2 id=隐式声明>隐式声明</h2>
<h2 id=作用域>作用域</h2>
<p>查找优先级：</p>
<ul>
<li>通过名字，不使用任何前缀，当前作用域</li>
<li>在隐式作用域中：
<ul>
<li>伴生对象</li>
<li>包对象
<ul>
<li>源类型的包对象</li>
<li>参数和超类、超特质的包对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=type-class>Type class</h2>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ecefbffe8bedb4834db878ae3e8092c2>1.11 - Trait-基础</h1>
<h2 id=原理>原理</h2>
<h3 id=定义特质>定义特质</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Philosophical</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>philosophical</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I consume memory, therefore I am!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>除了使用<code>trait</code>关键字，与类的定义一样，也没有声明超类，因此只有一个默认的<code>AnyRef</code>作为超类。同时定义了一个具体的方法。</p>
<h3 id=在类中混入特质>在类中混入特质</h3>
<p>然后将特质混入到一个类中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Forg</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Philosophical</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;green&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以使用<code>extends</code>或<code>with</code>混入特质，混入特质的类同时将会隐式的继承特质的超类。</p>
<p>从特质继承的方法可以向使用超类中的方法一样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>forg</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Forg</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#000>forg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>philosophical</span><span style=color:#ce5c00;font-weight:700>()</span>		<span style=color:#8f5902;font-style:italic>// I consume mem...
</span></code></pre></div><h3 id=特质也是类型>特质也是类型</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>phil</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Philosophical</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>forg</span>
<span style=color:#000>phil</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>philosophical</span><span style=color:#ce5c00;font-weight:700>()</span>		<span style=color:#8f5902;font-style:italic>// I consume mem...
</span></code></pre></div><p><code>phil</code>变量被声明为<code>Philosophical</code>类型，因此它可以被初始化为任何继承了<code>Philosophical</code>特质的类的实例。</p>
<h3 id=混入多个特质>混入多个特质</h3>
<p>如果需要将特质混入到一个继承自超类的类里，可以使用<code>with</code>来混入特质，或者使用多个<code>with</code>混入多个特质：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Animal</span>
<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>HasLegs</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Forg</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Philosophical</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>HasLegs</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;green&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=重写特质方法>重写特质方法</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Forg</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Philosophical</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;green&#34;</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>philosophical</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;It ain&#39;t easy being $toString!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这时，类<code>Forg</code>的实例仍然可以赋值到<code>Philosophical</code>类型的变量，但是其方法已经被重写。</p>
<h3 id=特质与类的不同>特质与类的不同</h3>
<p>特质类似于带有具体方法的 Java Interface。特质能够实现类的所有功能，但是有两点差别：</p>
<ul>
<li>特质没有构造器</li>
<li>无论类的所处位置，<code>super</code>调用都是静态绑定的。但是特质中是动态绑定的。因为可以同时混入多个特质，其绑定会基于混入特质的顺序。</li>
</ul>
<h2 id=胖瘦接口>胖瘦接口</h2>
<p>特质一种主要的应用方式是更具类已有的方法自动为类添加方法。但是在 Java 的接口中，如果需要多个接口的相互继承，必须在子接口中声明所有父接口的抽象方法。而在 Scala 中，可以通过定义一个包含部分抽象方法的特质，和一个包含大量已实现方法的特质，子类在继承多个特质后只需要实现抽象方法部分，并且同时能够获得需要的所有方法。</p>
<h2 id=实例ordered-特质>实例：Ordered 特质</h2>
<p>比如一个需要比较的对象，希望使用<code>></code>或<code>&lt;</code>等操作符来进行比较：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>that</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#204a87;font-weight:700>this</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>一共定义了 4 中操作符，并且后续的 3 中都是基于第一个方法，这是一个胖接口的典型，如果是瘦接口的话，只会顶一个一个<code>&lt;</code>操作符，然后其他的功能由客户端自己实现。</p>
<p>这些用法很常见，因此 Scala 专门提供了一个<code>Ordered</code>特质，只需要定义一个<code>compare</code>方法，然后<code>Ordered</code>会自动创建所有的比较操作。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个<code>compare</code>方法通过比较两个值的差来判断大小。可以参考<code>Ordered</code>原码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>Any</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&lt;</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#000>compare</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span>  <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#000>compare</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>  <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#000>compare</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#000>compare</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>compareTo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=特质叠加>特质叠加</h2>
<p>当类同时混入多个特质时，混入的特质会从右到左依次执行。</p>
<p>如果混入特质中使用了<code>super</code>，将会调用其左侧特质中的方法。</p>
<h2 id=多重继承>多重继承</h2>
<h2 id=应用场景>应用场景</h2>
<ol>
<li>如果行为不会被复用，使用具体类</li>
<li>如果需要在多个不相关的类中使用，使用特质</li>
<li>如果需要构造参数，或者在 Java 中使用这部分代码，使用抽象类。因为 Scala 中只有那些仅包含抽象成员的特质会被翻译为 Java 的接口，否则并没有具体的模拟。</li>
<li>如果效率非常重要，使用类。大多数 Java 运行时都能让类成员的续方法调用快于接口方法调用。</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c68623f6c04e52791d18490c82e0f4e7>1.12 - Trait-用例</h1>
<h2 id=介绍>介绍</h2>
<p>特质(trait)类似于 Java 中的接口(interface)。类似 Java 类能够实现多个接口，Scala 类能够扩展多个特质。</p>
<h2 id=像-interface-一样使用-trait>像 Interface 一样使用 trait</h2>
<p>在特质中，仅<strong>声明</strong>在需要扩展的类中需要的<strong>方法</strong>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>BaseSoundPlayer</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>play</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pause</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>stop</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>whatToSay</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后在需要扩展的类中使用特质，仅有一个特质时使用 extends，多于一个时第一个使用 extends，后续的使用 with：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Mp3SoundPlayer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseSoundPlayer</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseClass</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Trait1</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Trait2</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Trait1</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Trait2</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Trait3</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Trait4</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>除非一个类被声明为抽象类(abstract)，否则需要实现特质中的所有抽象方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Mp3SoundPlayer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseSoundPlayer</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>play</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// code here ... } 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// code here ... } 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pause</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// code here ... } 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>stop</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// code here ... } 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>resume</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// code here ... } 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
    
<span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SimpleSoundPlayer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseSoundPlayer</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>play</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同时，一个特质能够扩展另一个特质：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Mp3BaseSoundFilePlayer</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseSoundFilePlayer</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getBasicPlayer</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BasicPlayer</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getBasicController</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BasicController</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setGain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>volume</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>特质中除了能够声明抽象方法，还能提供方法的实现，类似 Java 中的抽象类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>WaggingTail</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>startTail</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tail started&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>stopTail</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tail stopped&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当一个类拥有多个特质时，这些特质被称为**混入(mix)**这个类。<strong>混入</strong>同时用于使用特质来扩展一个单独的对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Foo</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Trait1</span>
</code></pre></div><h2 id=在特质中使用抽象或具体的字段>在特质中使用抽象或具体的字段</h2>
<p>可以在特质中定义抽象或具体字段，以便所有扩展他们的类型都能够使用它们。没有提供初始值的字段将会是一个抽象字段，拥有初始值的字段将会是具体字段：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>PizzaTrait</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>numToppings</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> 
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>size</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>14</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>maxNumToppings</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>类似于抽象方法，被扩展的类需要实现所有抽象字段，否则需要声明为抽象类。</p>
<p>在特质中定义字段时可以使用 var 或 val，如果是 val，在子类或子特质中需要使用 override 来覆写该字段，而 var 则不需要。</p>
<h2 id=像抽象类一样使用特质>像抽象类一样使用特质</h2>
<p>在特质中定义的方法跟普通的 Scala 方法类似，可以直接使用或重写它们。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Pet</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Yo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>  	<span style=color:#8f5902;font-style:italic>// 具体方法
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>comeToMaster</span> 				<span style=color:#8f5902;font-style:italic>// 抽象方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Pet</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#8f5902;font-style:italic>// 如果不需要则不用重写特质中的具体方法
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>comeToMaster</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I&#39;m coming!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 	<span style=color:#8f5902;font-style:italic>// 实现抽象方法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cat</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Pet</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;meow&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>		<span style=color:#8f5902;font-style:italic>// 重写具体方法 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>comeToMaster</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;That&#39;s not gonna happen.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>虽然 Scala 中有抽象类，但是一个类只能继承一个抽象类，但是可以同时扩展多个方法，除非如 Classes 章节中介绍的对抽象类有特殊需要，否则，使用特质户更加灵活。</p>
<h2 id=简单的混入>简单的混入</h2>
<p>需要将多个特质混入类以提供健康的设计。为了实现简单的还如，只需要在特质中定义需要的方法，然后在需要扩展的类中使用 extends 或 with 来进行混入。</p>
<p>下面的例子中，同时继承自一个抽象类并混入一个特质，同时实现了抽象类中的抽象方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Tail</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>wagTail</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tail is wagging&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>stopTail</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;tail is stopped&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pet</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> <span style=color:#8f5902;font-style:italic>// abstract 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>ownerIsHome</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;excited&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>jumpForJoy</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;jumping for joy&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Pet</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Tail</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;woof&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>ownerIsHome</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>wagTail</span> <span style=color:#000>speak</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=限定哪些类可以通过继承来使用特质>限定哪些类可以通过继承来使用特质</h2>
<p>如果需要对一些特质进行限制，比如，只能添加到继承了一个抽象类或扩展了一个特质的类上。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#a40000>[</span><span style=color:#000>TraitName</span><span style=color:#a40000>]</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>SuperThing</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>这种声明语法称为 TraitName，TraitName 只能被混入到哪些扩展了名为 SuperThing 的类型的类中，这里的 SuperThing 可以是 特质、类、抽象类。</p>
<p>简单的说就是，<strong>只有继承或扩展了 SuperThing，才能混入 TraitName 这个特质</strong>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StarfleetComponent</span> 
<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>StarfleetWarpCore</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>StarfleetComponent</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Starship</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>StarfleetComponent</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>StarfleetWarpCore</span>
</code></pre></div><p>这个例子中，StarfleetWarpCore 继承了 StarfleetComponent，而 Starship 也继承了 StarfleetComponent，因此，类 Starship 可以混入特质 StarfleetWarpCore。</p>
<h2 id=限定一个特质只混入到一种类型的子类>限定一个特质只混入到一种类型的子类</h2>
<p>可以为一个特质添加一个类型，只有该类型的子类才能混入该特质。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>StarfleetWarpCore</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#204a87;font-weight:700>Starship</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> 
  <span style=color:#8f5902;font-style:italic>// more code here ... 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个特质只能混入到 Starship 的子类中，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Starship</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Enterprise</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Starship</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>StarfleetWarpCore</span>
</code></pre></div><p>否则将会报错：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RomulanShip</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Warbird</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RomulanShip</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>StarfleetWarpCore</span>	<span style=color:#8f5902;font-style:italic>// 错误
</span></code></pre></div><p>详细的错误信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-basic data-lang=basic><span style=color:#f57900>error:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>illegal</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>inheritance</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>self</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Warbird</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>does</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conform</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>to</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StarfleetWarpCore</span><span style=color:#8f5902;font-style:italic>&#39;s selftype StarfleetWarpCore with Starship </span>
<span style=color:#000>class</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Warbird</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>extends</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RomulanShip</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>with</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StarfleetWarpCore</span>
</code></pre></div><p>错误中提到了 <strong>self type</strong>，关于 self type 的描述：</p>
<blockquote>
<p>&ldquo;Any concrete class that mixes in the trait must ensure that its type conforms to the trait’s self type.&rdquo;</p>
<p>任何混入特质的实现类必须确保它的类型与特质的 self type 一致。</p>
</blockquote>
<p>特质同时能够限定混入它的类型需要同时扩展其他多个类型，想要混入特质 WarpCore 的类型需要同时混入 this 关键字后面的所有类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>WarpCore</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#204a87;font-weight:700>Starship</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87;font-weight:700>WarpCoreEjector</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#204a87;font-weight:700>FireExtinguisher</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=限定特质只能混入到拥有特定方法的类型>限定特质只能混入到拥有特定方法的类型</h2>
<p>可以使用 self type 语法的变型来限制一个特质只能混入到拥有特定方法的类型(类、抽象类、特质)：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>WarpCore</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>ejectWarpCore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>password:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因此，如果想要混入特质 WarpCore，需要拥有更上述方法签名一致的方法才可以。</p>
<p>或者需要多个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>WarpCore</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>this:</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>ejectWarpCore</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>password:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> 
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>startWarpCore:</span> <span style=color:#204a87;font-weight:700>Unit</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个方式称为<strong>结构化类型</strong>。</p>
<h2 id=将特质添加到对象实例>将特质添加到对象实例</h2>
<p>不同于将特质混入到实际的类，同样能够在创建对象时，将特质扩展到一个单独的对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DavidBanner</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Angry</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You won&#39;t like me ...&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Test</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>hulk</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DavidBanner</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Angry</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者更为实际的用法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Debugger</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// do something with message 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// no debugger 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>child</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Child</span>

<span style=color:#8f5902;font-style:italic>// debugger added as the object is created 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>problemChild</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ProblemChild</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Debugger</span>
</code></pre></div><h2 id=像特质一样扩展一个-java-interface>像特质一样扩展一个 Java Interface</h2>
<p>如果想要在 Scala 中实现一个 Java 接口，可以和使用特质一样，使用 extends 和 with 来扩展。</p>
<p>首先是 Java 接口的定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>speak</span><span style=color:#ce5c00;font-weight:700>();</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Wagging</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wag</span><span style=color:#ce5c00;font-weight:700>();</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>Running</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>();</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后在 Scala 中像使用特质一样使用他们：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Wagging</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Running</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Woof&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>wag</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Tail is wagging!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I&#39;m running!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>区别在于 Java 中的接口都没有实现行为，因此要实现接口或声明为抽象类。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6e5b19415179ebbd7db6d295eda25b19>1.13 - Try</h1>
<h2 id=介绍>介绍</h2>
<p>类型<code>Try</code>表示一个计算，它的结果可能是一个异常，或者成功完成计算的值。它类似于类型<code>Either</code>但是语义上完全不同。</p>
<p><code>Try[T]</code>的实例必须是一个<code>scala.util.Success[T]</code>或<code>scala.util.Failure[T]</code>。</p>
<p>一个实例：处理用户的输入并计算，并且在可能会抛出异常的位置并不需要显式的异常处理：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.io.StdIn</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.util.</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sucess</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Failure</span> <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>divide</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>dividend</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StdIn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Enter an Int that you&#39;d like to divide:\n&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 有可能会抛出异常，比如用户输入一个不能转换为 Int 的值
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>divisor</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StdIn</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Enter an Int that you&#39;d like to divide by:\n&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>)</span>			<span style=color:#8f5902;font-style:italic>// 有可能会抛出异常
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>problem</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>dividend</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>divisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>))</span>	<span style=color:#8f5902;font-style:italic>// TIP
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>problem</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Result of &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>dividend</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>divisor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#4e9a06>&#34; is: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You must&#39;ve divided by zero or entered something that&#39;s not an Int. Try again!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Info from the exception: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#000>divide</span>		<span style=color:#8f5902;font-style:italic>// 递归调用自身，重新获取用户输入
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>TIP</strong>部分展示了<code>Try</code>的重要属性，它能够进行<em>管道、链式</em>的方式组合操作，同时进行异常的捕获。</p>
<p>**它只能捕获 non-fatal 异常，如果是系统致命异常，将会抛出。**查看<code>scala.util.control.NonFatal</code>。</p>
<h2 id=sealed-abstract-class-tryt><code>sealed abstract class Try[+T]</code></h2>
<p><code>Try</code>本身定义为一个<strong>封闭抽象类</strong>，继承它的有两个子类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>exception</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>因此，<code>Try</code>的实例有么是一个<code>Failure</code>，要么是一个<code>Success</code>，分别表示<em>失败</em>或<em>成功</em>。</p>
<p>两个子类都只有一个类成员，<code>Failure</code>为一个异常，<code>Success</code>为一个值。</p>
<h3 id=tooption>toOption</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toOption</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSuccess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>None</span>
</code></pre></div><p>如果是一个<code>Success</code>就返回它的值，是<code>Failure</code>则返回None。</p>
<p>用例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>decode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Try</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>base64</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>decode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}.</span><span style=color:#000>toOption</span>
</code></pre></div><h3 id=transform>transform</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>transform</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接收两个偏函数，一个用于处理成功的情况，一个用于处理失败的情况。根据对应偏函数的处理结果，生成一个新的<code>Try</code>实例。</p>
<h2 id=object-try>object Try</h2>
<p>这是<code>Try</code>的伴生对象，其中定义了<code>Try</code>的构造器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>r</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可见，构造器中只是进行了普通的<code>try/catch</code>处理，并且对<code>NonFatal</code>异常进行捕获。成功则返回一个<code>Success</code>实例，失败则返回一个<code>Failure</code>实例。</p>
<h2 id=failure>Failure</h2>
<h3 id=isfailure--issuccess>isFailure & isSuccess</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isFailure</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isSuccess</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</code></pre></div><p>覆写父类抽象方法，分别写死为<code>true</code>和<code>false</code>。用于判断是否成功。</p>
<h3 id=recoverwith>recoverWith</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>recoverWith</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PartialFunction</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span>, <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
   <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#000>isDefinedAt</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>this</span>
   <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接受一个<code>Throwable => Try[U]</code>类型的偏函数，如果该偏函数定义了原始<code>Try</code>抛出的异常，将异常转换为一个新的<code>Try</code>实例，否则，返回原始<code>Try</code>的异常。</p>
<p>最后，对偏函数的执行或原始异常进行<code>NonFatal</code>捕获，生成一个可能的新的<code>Failure</code>实例。</p>
<h3 id=get>get</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>exception</span>
</code></pre></div><p>直接抛出异常，即实例成员。</p>
<h3 id=flatmap>flatMap</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>asInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]]</span>
</code></pre></div><p>接收一个<code>T => Try[U]</code>类型的偏函数，将本身转换为当前偏函数返回值类型。</p>
<h3 id=flatten>flatten</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ev</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#204a87;font-weight:700>&lt;:</span><span style=color:#204a87;font-weight:700>&lt;</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>asInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]]</span>
</code></pre></div><h3 id=foreach>foreach</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>()</span>
</code></pre></div><p>接收一个<code>T => U</code>类型的偏函数，因为实例本身的成员是一个异常，因此对<code>Failure</code>调用只会返回一个<code>Unit</code>而不会真正对成员执行传入的偏函数。</p>
<h3 id=map>map</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback> def map[U](f: T =&gt; U): Try[U] = this.asInstanceOf[Try[U]]
</code></pre></div><p>接收一个<code>T => U</code>的偏函数。</p>
<h3 id=filter>filter</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span>
</code></pre></div><p>接收一个<code>T => Boolean</code>类型的偏函数，对实例成员进行过滤，直接返回实例本身，结果仍然是一个包含异常的<code>Failure</code>。</p>
<h3 id=recover>recover</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>recover</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>rescueException</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PartialFunction</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span>, <span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rescueException</span> <span style=color:#000>isDefinedAt</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rescueException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>this</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接受一个<code>Throwable => U</code>类型的偏函数，如果偏函数定义了原始异常，则通过偏函数来处理原始异常并生成一个新的<code>Try</code>实例，否则返回自身。</p>
<h3 id=failed>failed</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>failed</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>将自身转换为一个包含自身成员异常的<code>Success</code>实例。</p>
<h2 id=success>Success</h2>
<h3 id=isfailure--issuccess-1>isFailure & isSuccess</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isFailure</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isSuccess</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</code></pre></div><p>重写父类方法并分别写死为<code>false</code>和<code>true</code>。</p>
<h3 id=recoverwith-1>recoverWith</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>recoverWith</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PartialFunction</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span>, <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span>
</code></pre></div><p>接收一个<code>Throwable => Try[U]</code>类型的偏函数，因为自身成员并不是异常类型，因此直接返回自身实例，不做异常处理。</p>
<h3 id=get-1>get</h3>
<p><code>def get = value</code>，直接返回自身成员的值。</p>
<h3 id=flatmap-1>flatMap</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>接收一个<code>T => Try[U]</code>类型的偏函数，将自身成员应用到该偏函数，成功则生成一个新的<code>Try</code>，否则进行异常捕获。</p>
<h3 id=flatten-1>flatten</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatten</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ev</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#204a87;font-weight:700>&lt;:</span><span style=color:#204a87;font-weight:700>&lt;</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>value</span>
</code></pre></div><p>返回成员值。</p>
<h3 id=foreach-1>foreach</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>接收一个函数并将成员值作用到该函数。</p>
<h3 id=map-1>map</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>接收一个函数，将成员值作用到该函数并生成一个新的<code>Try</code>。</p>
<h3 id=filter-1>filter</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>this</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NoSuchElementException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Predicate does not hold for &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果成员值满足传入的函数，则返回自身，否则，返回一个包含<code>NoSuchElementException</code>异常的<code>Failure</code>实例。</p>
<h3 id=recover-1>recover</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>recover</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>rescueException</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>PartialFunction</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span>, <span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span>
</code></pre></div><p>返回自身，不做处理。</p>
<h3 id=failed-1>failed</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>failed</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UnsupportedOperationException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Success.failed&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>调用该方法时，生成一个新的包含<code>UnsupportedOperationException</code>异常的<code>Failure</code>。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9af3d72b4493fcd966a0c66a79638833>1.14 - Type-用例</h1>
<h2 id=介绍>介绍</h2>
<p>Scala 有一个强大的类型系统。然而，除非你是一个库的创建者，你可以不用深入了解类型系统。但是一旦你要为其他用户创建集合类型的 API，你就需要学习这些。</p>
<p>Scala 类型系统使用一组标示符来表示不同的泛型类型概念，包括<strong>型变、界限、限定</strong>。</p>
<h3 id=界限>界限</h3>
<p>界限(bound)用于限制类型参数。界限标示符汇总：</p>
<table>
<thead>
<tr>
<th>标示符</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>A &lt;: B</td>
<td>上界</td>
<td>A 必须是 B 的子类</td>
</tr>
<tr>
<td>A >: B</td>
<td>下界</td>
<td>A 必须是 B 的父类</td>
</tr>
<tr>
<td>A &lt;: Upper >: Lower</td>
<td>同时使用上下界</td>
<td>A 同时用于上界和下界</td>
</tr>
<tr>
<td>A &lt;% B</td>
<td>视图界限</td>
<td></td>
</tr>
<tr>
<td>T : M</td>
<td>上下文界限</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id=类型限定>类型限定</h3>
<p>Scala 允许你指定额外的类型限制：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>=:=</span> <span style=color:#000>B</span> 	<span style=color:#8f5902;font-style:italic>// A 和 B 必须相同
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>&lt;:&lt;</span> <span style=color:#000>B</span> 	<span style=color:#8f5902;font-style:italic>// A 必须是 B 的子类型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>&lt;%&lt;</span> <span style=color:#000>B</span>		<span style=color:#8f5902;font-style:italic>// A 必须是 B 的视图类型
</span></code></pre></div><h3 id=常用类型参数标示符>常用类型参数标示符</h3>
<table>
<thead>
<tr>
<th>标示符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>用于一个简单的类型时，<code>List[A]</code></td>
</tr>
<tr>
<td>B,C,D</td>
<td>用于同时需要多个类型时</td>
</tr>
<tr>
<td>K</td>
<td>在 Java 中常用于 Map 的 key，Scala 中多使用 A</td>
</tr>
<tr>
<td>N</td>
<td>用于一个数字类型</td>
</tr>
<tr>
<td>V</td>
<td>跟 V 类似，Scala 中多用 B</td>
</tr>
</tbody>
</table>
<h2 id=类型参数化>类型参数化</h2>
<p>类型参数化用于编写泛型类和特质。</p>
<h2 id=实例queues-函数式队列>实例：queues 函数式队列</h2>
<p>函数式队列是拥有以下三种操作的数据结构：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>head</span>	<span style=color:#000>返回队列的第一个元素</span>
<span style=color:#000>tail</span>	<span style=color:#000>返回除第一个元素之外的队列</span>
<span style=color:#000>append</span>	<span style=color:#000>返回尾部添加了指定元素的队列</span>
</code></pre></div><p><strong>不同于可变队列，函数式队列在添加元素时不会改变其内容，而是返回包含这个元素的新队列。</strong></p>
<p>支持的工作方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>q1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>q2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>q1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q1</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// Queue(1,2,3)
</span></code></pre></div><p>如果将 Queue 实现为可变类型，则 append 操作会改变 q1 的值，这是 q1 和 q2 都拥有新的元素 4。但是对于函数式队列来说，新添加的元素只能出现在 q1 中而不能出现在 q2 中。</p>
<p>纯函数式队列与 List 具有相似性，都被称为是<strong>完全持久的数据结构</strong>，即使在扩展或改变之后，旧的版本依然可用。但是 List 通常使用<code>::</code>操作在前端扩展，队列使用<code>append</code>在后端扩展。</p>
<p>Queue 需要保持三种操作都能在常量时间内完成，低效的实现和最后的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SlowAppendQueue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>elems</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>elems</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tail</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SlowAppendQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elems</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// append 操作的时间花费与元素的数量成正比
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SlowAppendQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elems</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>x</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SlowHeadQueue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>smele</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]){</span>
  <span style=color:#8f5902;font-style:italic>// 将 elems 元素顺序翻转
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>smele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>last</span>								<span style=color:#8f5902;font-style:italic>// 与元素个数成正比
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tail</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SlowHeadQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>smele</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>)</span>			<span style=color:#8f5902;font-style:italic>// 与元素个数成正比
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>SlowHeadQueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>smele</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 常量
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>leading</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Lit</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>trailing</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mirror</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>this</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span>  <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mirror</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span>
    
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tail</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>q</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mirror</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>trailing</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终的方案中使用两个 List，leading 和 trailing 来表达队列。leading 包含前段元素，trailing 包含了反向排序的后段元素，整个队列表示为：<code>leading :: trailing.reverse</code>。</p>
<ul>
<li>append 时，使用<code>::</code>将元素添加到 trailing，时间为常量。如果一直通过添加操作构建队列，则 leading 部分会一直为空。</li>
<li>tail 时，如果 tailing 不为空会直接返回。如果为空，需要将 tailing 翻转并复制给 leading 然后取第一个元素返回，这个操作称为 mirror，时间与元素量成正比。</li>
<li>head 与 tail 类似。</li>
</ul>
<p>这种方案基于三种操作的频率接近。</p>
<h2 id=信息隐藏>信息隐藏</h2>
<p>上面 Queue 的实现中暴露了细节实现。</p>
<h3 id=私有构造器及工厂方法>私有构造器及工厂方法</h3>
<p><strong>使用私有构造器和私有成员来隐藏类的初始化代码和表达代码。</strong></p>
<p>Java 中可以把主构造器声明为私有使其不可见，Scala 中无须明确定义。虽然它的定义可以隐含在类参数以及类方法体中，还是可以通过在类参数列表前添加 private 修饰符把主构造器隐藏起来：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>private</span> <span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>leading</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>trailing</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这个参数列表之前的 private 修饰符表示 Queue的构造器是私有的：它只能被类本身或伴生对象访问。类名 Queue 仍然是公开的，因此可以继续使用这个类，但不能调用它的构造器。</p>
<p>可以通过添加辅助构造器来创建实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>	 					<span style=color:#8f5902;font-style:italic>// 可以构建空队列
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elems</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T*</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elems</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 可以提供队列初始元素
</span></code></pre></div><p>另一种方式添加一个工厂方法，最简单的方式是定义与类同名的对象及 apply 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T*</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#a40000>，</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#a40000>，</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>同时将该对象放到 Queue 类同一个源文件，成为 Queue 类的伴生对象。</p>
<h3 id=供选方案私有类>供选方案：私有类</h3>
<p><strong>直接将类隐藏掉，仅提供能够暴露类公共接口的特质。</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tail</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Queue</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>appand</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T*</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>New</span> <span style=color:#000>QueueImpl</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>QueueImpl</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>leading</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>],</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>trailing</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>t</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mirror</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  	  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QueueImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>this</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>mirror</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span>
	
	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tail</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>QueueImpl</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>q</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mirror</span>
      <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QueueImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
	
	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>QueueImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>trailing</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=型变注解>型变注解</h2>
<p>上面定义的 Queue 是一个特质而不是类型，因为他带有类型参数。即 Queue 是特质，也可称为类型构造器(给它提供参数来构建新的类型)，<code>Queue[Int]</code> 是类型。</p>
<p><strong>带有参数的类和特质是泛型的，但是他们产生的类型已被“参数化”，不再是泛型的。</strong></p>
<p><strong>泛型：指通过一个能够广泛适用的类或特质来定义许多特定的类型。</strong></p>
<p>**型变：泛型话类型<code>(Queue[T]</code>)产生的类型家族成员(<code>Queue[String]</code>,<code>Queue[Int]</code>,&mldr;)之间具有的特定的子类型关系。**定义了参数化类型传入方法的规则。</p>
<p><strong>协变：如果 S 类型是 T 类型的子类型，同时 <code>Queue[S]</code> 也是 <code>Queue[T]</code> 的子类型，即认为，Queue 是与他的类型参数 T 保持协变的。</strong></p>
<blockquote>
<p>协变意味着，如果S 为 T 的子类型，向能够接受参数类型为 <code>Queue[T]</code> 的函数传入类型为 <code>Queue[S]</code> 的参数。比如方法签名<code>def func(arg:Queue[AnyRef])</code>,可以调用<code>func(Queue[String])</code>，因为 String 是 AnyRef 的子类型。</p>
</blockquote>
<p><strong>非型变：Scala 中默认的泛型类型是非型变的。即不泛型类型产生的类型家族成员之间没有子类型关系。</strong></p>
<blockquote>
<p>非型变意味着，即便是类型参数之间有子类型关系，比如 String 是 AnyRef 的子类型，但是泛型类型为非型变，则 <code>Queue[String]</code> 不能当做 <code>Queue[AnyRef]</code> 来使用，必须使用定义的 <code>Queue[AnyRef]</code> 类型。</p>
</blockquote>
<p><strong>逆变：如果 T 是 S 的子类型，表示 <code>Queue[T]</code> 是 <code>Queue[S]</code> 的父类型。</strong></p>
<blockquote>
<p>逆变意味着，如果 S 为 T 的子类型，向能够接受参数类型为 <code>Queue[S]</code> 的函数传入类型为 <code>Queue[T]</code> 的参数。</p>
</blockquote>
<p><strong>这里说的参数传入的例子，即：方法参数预期为父类，传入必须为子类(里氏替换原则：任何使用父类的地方都可以用子类替换掉，因为子类拥有父类所有的属性和方法，即只需要一个父类就完成的工作，传入了一个功能更多的子类当然也能完成需要的工作)。</strong></p>
<h3 id=型变参数>型变参数：</h3>
<table>
<thead>
<tr>
<th>标示符</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Array[T]</code></td>
<td>非型变类型</td>
<td>当容器中的元素是可变的即 collections.mutable。比如：预期参数为 <code>Array[String]</code> 的方法只能传入 <code>Array[String]</code></td>
</tr>
<tr>
<td><code>Seq[+A]</code></td>
<td>协变类型</td>
<td>当容器中的元素是不可变的，这使容器更灵活。比如，预期参数为 <code>Seq[Any]</code> 的方法可以传入 <code>Seq[String]</code></td>
</tr>
<tr>
<td><code>Foo[-A]</code></td>
<td>逆变类型</td>
<td>与协变相反</td>
</tr>
<tr>
<td><code>Function1[-A, +B]</code></td>
<td>组合型变</td>
<td>参考 Function1 特质的定义</td>
</tr>
</tbody>
</table>
<p>一个型变的实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 一组具体类型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Grandparent</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Parent</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Grandparent</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Child</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Parent</span>

<span style=color:#8f5902;font-style:italic>// 一组容器类型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>InvariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> 		<span style=color:#8f5902;font-style:italic>// 不变容器类型，容器中只能传入类型 A
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CovariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span> 		<span style=color:#8f5902;font-style:italic>// 协变容器类型，容器中只能传入类型 A 和 A 的子类型 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ContravariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>-A</span><span style=color:#ce5c00;font-weight:700>]</span>	<span style=color:#8f5902;font-style:italic>// 逆变容器类型，容器中只能传入类型 A 和 A 的父类型
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>VarianceExamples</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>invarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>InvariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Parent</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>covarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>CovariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Parent</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contraMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ContravariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Parent</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{}</span>

  <span style=color:#000>invarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Child</span><span style=color:#ce5c00;font-weight:700>])</span> 				<span style=color:#8f5902;font-style:italic>// 正确
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>invarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Parent</span><span style=color:#ce5c00;font-weight:700>])</span> 				<span style=color:#8f5902;font-style:italic>// 错误
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>invarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>InvariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Grandparent</span><span style=color:#ce5c00;font-weight:700>])</span>			<span style=color:#8f5902;font-style:italic>// 错误
</span><span style=color:#8f5902;font-style:italic></span>
  <span style=color:#000>covarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CovariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Child</span><span style=color:#ce5c00;font-weight:700>])</span> 				<span style=color:#8f5902;font-style:italic>// 正确
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>covarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CovariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Parent</span><span style=color:#ce5c00;font-weight:700>])</span> 				<span style=color:#8f5902;font-style:italic>// 正确
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>covarMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CovariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Grandparent</span><span style=color:#ce5c00;font-weight:700>])</span>			<span style=color:#8f5902;font-style:italic>// 错误
</span><span style=color:#8f5902;font-style:italic></span>
  <span style=color:#000>contraMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContravariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Child</span><span style=color:#ce5c00;font-weight:700>])</span> 			<span style=color:#8f5902;font-style:italic>// 错误
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>contraMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContravariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Parent</span><span style=color:#ce5c00;font-weight:700>])</span> 			<span style=color:#8f5902;font-style:italic>// 正确
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>contraMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ContravariantClass</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Grandparent</span><span style=color:#ce5c00;font-weight:700>])</span>		<span style=color:#8f5902;font-style:italic>// 正确
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>一个逆变的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>OutputChannel</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>-T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里定义 OutputChannel 是逆变的，比如：一个 <code>Channel[AnyRef]</code> 会是 <code>Channel[String]</code> 的子类型。如果用做一个方法参数：<code>def func(arg: Channel[String])</code>,可以调用为：<code>func(Channel[AnyRef])</code>。</p>
<h3 id=型变与数组>型变与数组</h3>
<p>Scala 认为 数组是<strong>非型变</strong>的。</p>
<h3 id=检查型变注解>检查型变注解</h3>
<p>只要泛型的参数类型被当做方法参数的类型，那么包含它的类或特质就有可能不与类型参数一起协变。</p>
<p>比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>类型 T 即作为泛型 Queue 的参数类型，又作为方法 append 的参数类型，这是不允许的，编译器会报错。</p>
<h2 id=下界>下界</h2>
<p>上面例子中 <code>Queue[T]</code> 不能实现对 T 的协变，因为 T 作为参数类型出现在了 append 方法中。想要解决这个问题，可以把 append 变为多态使其泛型化，并使用它的类型参数的下界：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>](...){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>trailing</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个定义指定了 append 的类型参数 U，并通过语法<code>U >: T</code>定义了 T 为 U 的下界，即 U 必须是 T 的超类。</p>
<blockquote>
<p>比如类 Fruit 及两个子类 Apple、Orange。现在可以吧 Orange 对象加入到 <code>Queue[Apple]</code>，返回个 <code>Queue[Fruit]</code> 类型。</p>
</blockquote>
<p>这个定义支持，队列类型元素类型为 T，即<code>Queue[T]</code>,允许将任意 T 的超类 U 的对象加入到队列中，结果为 <code>Queue[U]</code>。</p>
<h2 id=对象私有数据>对象私有数据</h2>
<p>为了避免 leading 一直为空导致的 mirror 不断重复的执行，下面是改进后的 Queue 定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>private</span> <span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>leading</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>trialing</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mirror</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	  <span style=color:#204a87;font-weight:700>while</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  		<span style=color:#000>leading</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>leading</span>
        <span style=color:#000>trailing</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tail</span>
	  <span style=color:#ce5c00;font-weight:700>}</span>  
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>mirror</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tail</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>mirror</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>trailing</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>append</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Queue</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>leading</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>trailing</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个版本中的 leading 和 trailing 都是可变变量。而 mirror 从 trailing 反向复制到 leading 的操作通过副作用对两段队列进行修改而不是返回队列。由于二者都是私有变量，因此这些操作对客户端是不可见的。</p>
<p>同时，leading 和 trailing 都被 <code>private[this]</code>修饰符声明对对象私有了，因此能通过类型检查。Scala 的型变检查包含了关于对象私有定义的特例。当检查到带有<code>+/-</code>符号的类型参数只出现在具有相同型变分类的位置上时，这种定义将被忽略。</p>
<h2 id=上界>上界</h2>
<p>下面是一个为自定义类实现排序的例子。通过把 Ordered 混入类中，并实现 Ordered 唯一的抽象方法 compare，就可以使用 <code>&lt;,>.&lt;=,>=</code>来做类实例的比较：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>compare</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lastNameComparison</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lastNmae</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareToIngoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>comparison</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>lastNameComparison</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>conpareToIngoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>firstName</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>lastName</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>为了让传递给你的新排序函数的列表类型混入到 Ordered 中，需要使用到上界。通过指定<code>T &lt;: Ordered[T]</code>，表示类型参数 T 具有上界 <code>Ordered[T]</code>，即传递给排序方法 orderedMergeSort 的列表元素类型必须是 Ordered 的子类型。因此，可以传递 <code>List[Person]</code> 给该方法，因为 Person 混入了 Ordered。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>orderedMergeSort</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Ordered</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>merge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>ys</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ys</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>ys</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>xs</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>xsl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ysl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>merge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>xsl</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>ysl</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>y</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>merge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>xs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>ysl</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>2</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>xs</span>
  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ys</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>zs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>xs</span> <span style=color:#000>splitAt</span> <span style=color:#000>n</span>
    <span style=color:#000>merge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>orderedMergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ys</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>orderedMergeSort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>zs</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=实例>实例</h2>
<h3 id=如何使用泛型类型创建类>如何使用泛型类型创建类</h3>
<p>创建一个能够接受泛型类型的类或方法，比如创建一个链表类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>elem</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>next</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Node</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span>
    <span style=color:#000>overrice</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>head</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Node</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elem</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>next</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>head</span>
    <span style=color:#000>head</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>n</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Node</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>){</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#000>printNoeds</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printAll</span><span style=color:#ce5c00;font-weight:700>(){</span> <span style=color:#000>printNodes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>[A]</code>是该类的参数化类型，要创建一个 Int 类型的链表实例：<code>val ints = new LinkedList[Int]()</code>,</p>
<p>此时这个链表的整体类型为<code>LinkedList[Int]</code>，可以向其添加 Int 类型的节点：<code>ints.add(1)</code>。</p>
<p>或者创建其他类型的链表：<code>val strings = new LinkedList[String]</code>或<code>val foos = new LinkedList[Foo]</code>。</p>
<p>当创建一个基本类型的泛型实例时，比如：<code>val anys = new LinkedList[Any]</code>，这是可以传入基本类型 Any 的子类型比如 Int，<code>anys.add(1)</code>。但是如果有一个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printTypes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elems</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>LinkedList</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>elems</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printAll</span><span style=color:#ce5c00;font-weight:700>()</span>
</code></pre></div><p>这时并不能传入一个<code>ListedList[Int]</code>到该方法，这需要这个链表直接<strong>协变</strong>。</p>
<p>如果同时需要多个类型参数，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Pair</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getKey</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getValue</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=如何使用泛型类型创建方法>如何使用泛型类型创建方法</h3>
<p>创建一个带有类型参数的方法能够使其用于更多的适用范围：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>randomElement</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>seq</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>randomNum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Random</span>
  <span style=color:#000>seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>randomNum</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=如何使用鸭子类型结构化类型>如何使用鸭子类型(结构化类型)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>callSpeak</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>speak</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>}](</span><span style=color:#000>obj</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>speak</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在这个定义中，方法<code>callSpeak</code>可以接受任意一种类型 A，只要该类型拥有一个类型参数中定义签名的 speak 方法。</p>
<p>类型参数语法<code>[A &lt;: { def speak(): Unit }]</code>表示，类型 A 必须是一个拥有方法<code>def speak(): Unit</code>的类型的子类型，即上界语法。同时需要注意的是，这个父类中的方法的签名必须与类型参数中定义的签名一致。</p>
<h3 id=使可变集合非型变>使可变集合非型变</h3>
<p>在定义一个元素可变的集合时，其元素类型必须是非型变的，即<code>[A]</code>。</p>
<p>使用非型变类型会有一些副作用，比如，容器可以同时接收基本类型或其子类型。同时，如果一个方法被声明为接收一个父类型的容器，比如<code>ArrayBuffer[Any]</code>，传入<code>ArrayBuffer[Int]</code>则不会通过编译。因为：</p>
<ul>
<li>ArrayBuffer 中的元素是可以改变的</li>
<li>定义的方法接收的是<code>ArrayBuffer[Any]</code>，但传入的却是<code>ArrayBuffer[Int]</code></li>
<li>如果编译器通过了，集合会使用 Any 代替普通的 Int 类型，这是不允许的</li>
</ul>
<p>如果想要一个方法技能接收父类型的集合，又能接收其子类型的集合，需要使用一个不可变的集合类型，比如 List、Set 等。</p>
<p>在 Scala 中，可变集合是非型变的，而不可变集合为协变，参考协变与飞行变的区别。</p>
<h3 id=使不可变集合协变>使不可变集合协变</h3>
<p>正如<strong>协变</strong>中的说明一样，不可变集合被定义为协变，则，使用这类集合作为参数的方法，同样能够接受其子类型的集合作为参数。</p>
<p>创建一个不可变容器，并声明其为协变：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Container</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>emel</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>makeDogsSpeak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dogHouse</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Container</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Dog</span><span style=color:#ce5c00;font-weight:700>]){</span>
  <span style=color:#000>dogHouse</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>speak</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>makeDogsSpeak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Container</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dog of Dog&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span>
<span style=color:#8f5902;font-style:italic>// SubDog is sub type of Dog
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>makeDogsSpeak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Container</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>SubDog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dog of SubDog&#34;</span><span style=color:#ce5c00;font-weight:700>)))</span> 
</code></pre></div><h3 id=限制类型参数的范围>限制类型参数的范围</h3>
<p>在一个拥有类型参数的类或方法中，如果需要限制该类型参数的范围，可以使用<strong>上界</strong>或<strong>下界</strong>来限制类型参数的可选范围。</p>
<p>比如有一些多重继承的类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Professor</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Teacher</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Professor</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Child</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Student</span>
</code></pre></div><p>假设一些场景：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>teach</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#000>Teacher</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>learn</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#000>Student</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这里，只有老师或教授能够讲课，即下界，最少为老师。只有学生或小孩能够学习，即上界。</p>
<h3 id=选择性的为封闭模型添加新行为>选择性的为封闭模型添加新行为</h3>
<p>比如想要给所有的数字类型增加一个求和方法，比如<code>Int、Double、Float</code>等。因为<code>Numeric</code>类型类已经存在，这支持你创建一个能够接受一个任意数字类型的求和方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span>  <span style=color:#000>numeric</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Numeric</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>numeric</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>plus</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>然后，这个方法就可以用于不同的数字类型求和：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.5f</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h4 id=如何创建一个类型类type-class>如何创建一个类型类(type class)</h4>
<p>创建类型类的过程有点复杂，单仍然可以总结为一个公式：</p>
<ul>
<li>通常你有一个需求，为一个封闭的模型增加新的行为</li>
<li>为了增加这个行为，你会创建一个类型类。通常的方式是，创建一个基本的特质，然后使用隐式对象对该特质创建具体的实现</li>
<li>然后回到应用中，创建一个使用该类型类的方法将新的行为添加到封闭模型，比如上面创建的 add 方法</li>
</ul>
<p>比如你有一些封闭模型，包含一个 Dog 和 Cat，你想要 Dog 能够说话而 Cat 不能。</p>
<p>首先是封闭模型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 一个已存在的封闭模型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Animal</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span>
</code></pre></div><p>为了能够给 Dog 添加说话方法，创建一个类型类并为 Dog 实现 speak 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Humanish</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 类型类，创建一个 speak 抽象方法
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>HumanLike</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>speaker</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#8f5902;font-style:italic>// 伴生对象
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>HumanLike</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 为需要的类型实现要增加的行为，这里只要为 Dog 实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>DogIsHumanLike</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>HumanLike</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Dog</span><span style=color:#ce5c00;font-weight:700>]{</span>
      <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dog</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Dog</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I&#39;m a dog, my name is ${dog.name}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>定义完新的行为后，在应用中使用该功能：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>TypeClassDemo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 创建一个方法能够使动物说话
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>makeHumanLikeThingSpeak</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>animal</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>humanLike</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>HumanLike</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]){</span>
    <span style=color:#000>humanLike</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>speak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>animal</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#8f5902;font-style:italic>// 因为 HumanLike 中实现了 Dog 类型的方法，因此可以用于 Dog 类型
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>makeHumanLikeThingSpeak</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Rover&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  
  <span style=color:#8f5902;font-style:italic>// 但是 HumanLike 中并没有 Cat 类型的实现，因此不能用于 Cat 类型
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// makeHumanLikeThingSpeak(Cat(&#34;Mimi&#34;))
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里需要注意的是：</p>
<ul>
<li>方法 makeHumanLikeThingSpeak 类似于本节开头的 add 方法</li>
<li>因为 Numeric 类型类已经由 Scala 定义，因此可以自己用来创建自己的方法。否则，需要创建自己的类型类，这里就是 HumanLike 特质</li>
<li>因为 speak 方法定义于 DogsIsHumanLike 中，该隐式对象继承于 <code>HumanLike[Dog]</code>，因此只能将一个 Dog 对象传入 makeHumanLikeThingSpeak 方法，而不能是一个 Cat 对象</li>
</ul>
<blockquote>
<p>这里的 类(class) 概念并不是来自面向对象的世界，而是函数式编程的世界。正如上面例子中演示的，一个 类型类(type class) 的益处在于能为一个已存在的(不能再进行修改的)封闭模型添加新的行为。另一个益处在于，能够为泛型类型创建方法，并且能够控制这些泛型类型，比如只有 Dog 可以说话。</p>
</blockquote>
<h3 id=与类型构建功能>与类型构建功能</h3>
<h4 id=创建一个计时器>创建一个计时器</h4>
<p>在 Unix 系统中，可以使用一下命令来查看一个执行过程花费的时间：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>time</span> find . -name <span style=color:#4e9a06>&#34;*.scala&#34;</span>
</code></pre></div><p>在 Scala 中我们可以创建一个类似的方法来查看对应执行过程消耗的时间：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>someLongRunningAlgorithm</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>, time: </span><span style=color:#4e9a06>$time</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这个方法中，timer 方法会执行传入的<code>someLongRunningAlgorithm</code>方法，返回执行结果和其消耗的时间。</p>
<p>下面是 timer 的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>blockOfCode</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>startTime</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nanoTime</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>blockOfCode</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stopTime</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nanoTime</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>delta</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>stopTime</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>startTime</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>delta</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>10000000</span><span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>timer 方法使用**按名调用(call-by-name)**的语法来接收一个代码块作为一个参数。同时声明一个泛型类型最为该代码块的返回值，而不是指定声明为一个具体的类型比如 Int。这支持你传入任意类型的方法，比如：<code>timer(println("nothing"))</code>。</p>
<h4 id=创建自己的-try-类>创建自己的 Try 类</h4>
<p>在 Scala 2.10 之前并没有 Try、Succeeded、Failed 这些类，如何自己实现以拥有以下的功能呢：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;10&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// Succeeded(10)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>y</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;10A&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// Failed(Exception)
</span></code></pre></div><p>首先需要实现一个 Attempt 类，同时为了不使用 new 关键字来创建实例，需要实现一个 apply 方法。还需要定义 Succeeded 和 Failed 类，并继承 Attempt。下面是第一个版本的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#000>object</span> <span style=color:#000>Attempt</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>f</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Succeeded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Excaption</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Failed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Failed</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>exception</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Succeeded</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>与上面的 timer 实现类似，apply 方法接收一个<strong>按名调用</strong>的参数，同时返回值是一个泛型类型。但是为了使这个类真正有用，还需要实现一个 getOrElse 方法来获取结果的信息，无论是 Failed 还是 Succeeded。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>y</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>下面我们实现这个 getOrElse 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>default</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSuccess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>default</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>isSuccess</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Attempt</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
  	  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>f</span>
  	  <span style=color:#000>Succeeded</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Exception</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Failed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Failed</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>exception</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Thorwable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>isSuccess</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>thorw</span> <span style=color:#000>exception</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>fianl</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Succeeded</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Attempt</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#000>isSuccess</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>result</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里需要注意的是方法 getOrElse 的签名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>default</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isSuccess</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>default</span>
</code></pre></div><p>它的类型签名<code>[B >: A]</code>使用了下界，同时返回值的类型为 B，即该方法的返回值类型必须是 A 或 A 的父类。因为，在预期一个返回值是父类的地方可以返回一个子类，因为对父类的需求其子类都能满足，但是如果预期返回值是一个子类，但是返回一个父类，对子类要比父类的多，父类并不能满足使用需要，比如子类有个新的方法而父类中并没有，这时候返回了一个父类，再去调用该新方法时将会报错。即任何使用父类的地方都可以使用其子类替换，反之则行不通。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3dde7874d1eede924a4fff04321d0890>1.15 - Type-进阶</h1>
<h2 id=类型别名>类型别名</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>String</span>
<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>IntList</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>MyList</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>MyList</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span>
</code></pre></div><p>为已有类型创建一个类型别名，或者同时为其半生对象创建一个别名。</p>
<h3 id=场景提高-api-可用性>场景：提高 API 可用性</h3>
<p>如果你的 API 需要引入一些外部类型，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>spray.http.ContentType</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.joda.time.DateTime</span>

<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RiakValue</span><span style=color:#ce5c00;font-weight:700>(</span>
	<span style=color:#000>contentType</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ContentType</span><span style=color:#ce5c00;font-weight:700>,</span>
	<span style=color:#000>lastModified</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>DateTime</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>当客户端在创建<code>RiakVlue</code>实例时则必须同时引入这些<strong>外部类型</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>spray.http.ContentType</span>		<span style=color:#8f5902;font-style:italic>// &lt;= 需要引入外部类型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.joda.time.DateTime</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>rv</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>RiakValue</span><span style=color:#ce5c00;font-weight:700>(</span>
	<span style=color:#000>ContentType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>`application/json`</span><span style=color:#ce5c00;font-weight:700>,</span>
	<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DateTime</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>为了避免这些多次重复且必要的引入，我们可以为需要的类型创建别名并组织在一起：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.scalapenos</span>
<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>object</span> <span style=color:#000>riak</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>ContentType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>spray</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>http</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ContentType</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ContentType</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>spray</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>http</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ContentType</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>MediaTypes</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>spray</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>http</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MediaTypes</span>
  
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>DateTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>joda</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DateTime</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后客户端就可以这样使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>com.scalapenos.rika._</span>	<span style=color:#8f5902;font-style:italic>// 引入所有使用 RiakValue 需要的外部类型
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>rv</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>RiakVaule</span><span style=color:#ce5c00;font-weight:700>(</span>
	<span style=color:#000>ContentType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>`application/json`</span><span style=color:#ce5c00;font-weight:700>,</span>
	<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DateTime</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=场景简化类型签名>场景：简化类型签名</h3>
<p>有时候类型签名比较难于理解，特别是一些函数作为参数时的类型签名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>authenticate</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>auth</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>RequestContext</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Rejection</span>, <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>我们可以为这种复杂类型创建别名以隐藏复杂性：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>object</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Authectication</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Rejection</span>, <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>ContextAuthenticator</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>RequestContext</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Authection</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终得到经过简化的类型签名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>authenticate</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>auth</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ContextAutuenticator</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><h3 id=场景任何地方都可以使用类型别名>场景：任何地方都可以使用类型别名</h3>
<p>在 Scala 标准库中的 Predef 中，为大量的常用类型定义了类型别名，以简化使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Predef</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>LowPriorityImplicits</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>String</span>        <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>String</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Class</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Function</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>-A</span>, <span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Function1</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>immutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Set</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>     <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>immutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Set</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>Map</span>         <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>immutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Map</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>Set</span>         <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>immutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Set</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=class-tag--type-tag>class Tag & type Tag</h2>
<h2 id=type-class>type class</h2>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1dcf759395394bb74b2a8d21998d2899>1.16 - Primitive</h1>
<h2 id=基本类型>基本类型</h2>
<p>Byte、Short、Int、Lont、Char称为<strong>整形类型</strong>，与 Double、Float 一起构成整个<strong>数字类型</strong>。这些都定义在<code>scala</code>包中。</p>
<p>而 String 是一个由 Char 构成的序列。</p>
<p>包<code>scala</code>与<code>java.lang</code>会被自动引入 Scala 源文件。</p>
<h2 id=字面值>字面值</h2>
<p>所有这些基本类型都可以用<strong>字面值</strong>表示，通过字面值可以在代码中显式的定义常量。</p>
<h3 id=整形字面值>整形字面值</h3>
<p>整形类型，即 Byte、Short、Int、Lont、Char，有两种表示形式：十进制和十六进制，十六进制以<code>0x</code>或<code>0X</code>开头。</p>
<p>无论以何种形式初始化整形字面值，Scala 都会以十进制打印该字面值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 以 16 进制初始化整形字面值</span>
scala&gt; val <span style=color:#000>hex</span> <span style=color:#ce5c00;font-weight:700>=</span> 0x5 			<span style=color:#8f5902;font-style:italic># hex: Int = 5</span>
scala&gt; val <span style=color:#000>hex2</span> <span style=color:#ce5c00;font-weight:700>=</span> 0x00FF 		<span style=color:#8f5902;font-style:italic># hex2: Int = 255</span>
scala&gt; val <span style=color:#000>magic</span> <span style=color:#ce5c00;font-weight:700>=</span> 0xcafebabe 	<span style=color:#8f5902;font-style:italic># magic: Int = -889275714</span>

<span style=color:#8f5902;font-style:italic># 以 10 进制初始化整形字面值</span>
scala&gt; val <span style=color:#000>dec1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>31</span> 			<span style=color:#8f5902;font-style:italic># dec1: Int = 31</span>
scala&gt; val <span style=color:#000>dec2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span> 			<span style=color:#8f5902;font-style:italic># dec2: Int = 255</span>
scala&gt; val <span style=color:#000>dec3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>20</span> 			<span style=color:#8f5902;font-style:italic># dec3: Int = 20</span>
</code></pre></div><p>如果一个整形字面值以字母<code>L</code>或<code>l</code>开头，则为类型<code>Long</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val <span style=color:#000>prog</span> <span style=color:#ce5c00;font-weight:700>=</span> 0XCAFEBABEL 	<span style=color:#8f5902;font-style:italic># prog: Long = 3405691582</span>
scala&gt; val <span style=color:#000>tower</span> <span style=color:#ce5c00;font-weight:700>=</span> 35L 			<span style=color:#8f5902;font-style:italic># tower: Long = 35</span>
scala&gt; val <span style=color:#000>of</span> <span style=color:#ce5c00;font-weight:700>=</span> 31l 			<span style=color:#8f5902;font-style:italic># of: Long = 31</span>
</code></pre></div><p>如果一个整形字面值被赋值给一个类型为<code>Short</code>或<code>Byte</code>的变量，则这个字面值为被当做<code>Short</code>或<code>Byte</code>类型，并且该字面值必须在这些类型的有效取值范围内。</p>
<h3 id=浮点数字面值>浮点数字面值</h3>
<p>浮点数字面值由 10 进制数字创建，带有可选的小数点，和一个<code>E</code>或<code>e</code>及对应的指数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val <span style=color:#000>big</span> <span style=color:#ce5c00;font-weight:700>=</span> 1.2345 		<span style=color:#8f5902;font-style:italic># big: Double = 1.2345</span>
scala&gt; val <span style=color:#000>bigger</span> <span style=color:#ce5c00;font-weight:700>=</span> 1.2345e1 	<span style=color:#8f5902;font-style:italic># bigger: Double = 12.345</span>
scala&gt; val <span style=color:#000>biggerStill</span> <span style=color:#ce5c00;font-weight:700>=</span> 123E45 <span style=color:#8f5902;font-style:italic># biggerStill: Double = 1.23E47</span>
</code></pre></div><p>同时，可以用结尾字符<code>D</code>或<code>d</code>表示双精度浮点，<code>f</code>或<code>F</code>表示单精度浮点。</p>
<h3 id=字符字面值>字符字面值</h3>
<p>字符字面量由使用单引号包围的任意 Unicode 字符构成。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;A&#39;</span> 				<span style=color:#8f5902;font-style:italic># a: Char = A</span>
</code></pre></div><p>同时可以使用以<code>\u</code>开头的 Unicode 码表示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val <span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;\u0041&#39;</span> 		<span style=color:#8f5902;font-style:italic># d: Char = A</span>
</code></pre></div><p>同时可以在任意位置使用 Unicode 字符：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val B<span style=color:#4e9a06>\u</span>0041<span style=color:#4e9a06>\u</span><span style=color:#0000cf;font-weight:700>0044</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> 	<span style=color:#8f5902;font-style:italic># BAD: Int = 1</span>
</code></pre></div><h3 id=字符串字面值>字符串字面值</h3>
<p>字符串字面值是一个由双引号包围的字符字面值序列。</p>
<p>同时，可以定义多行字符串：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;&#34;Welcome to Ultamix 3000. 
</span><span style=color:#4e9a06>			Type &#34;HELP&#34; for help.&#34;&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;&#34;|Welcome to Ultamix 3000. 
</span><span style=color:#4e9a06>		   |Type &#34;HELP&#34; for help.&#34;&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stripMargin</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=符号字面值symbol>符号字面值(Symbol)</h3>
<p>符号字面值写作<code>'indent</code>，<code>indent</code>部分可以任意字符数字标示符。这样的一个标示符被被映射为<code>scala.Symbol</code>的一个实例，编译器会将它编译为一个工厂方法调用：<code>Symbol("indent")</code>。</p>
<p>字符字面量并不能做太多操作，只能获取它的<code>name</code>属性：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;aSymbol 		# s: Symbol = &#39;</span>aSymbol
scala&gt; val <span style=color:#000>nm</span> <span style=color:#ce5c00;font-weight:700>=</span> s.name 			<span style=color:#8f5902;font-style:italic># nm: String = aSymbol</span>
</code></pre></div><p>同时需要注意的是字符字面量是<code>interned</code>，编写一个字符字面量两次，表达式会引用同一个<code>Symbol</code>对象。</p>
<h2 id=字符串插值>字符串插值</h2>
<p>可以使用<code>s</code>直接在字符串字面量中引用变量进行插值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;reader&#34;</span> 
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Hello, </span><span style=color:#4e9a06>$name</span><span style=color:#4e9a06>!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
<span style=color:#4e9a06>s&#34;The answer is </span><span style=color:#4e9a06>${</span><span style=color:#0000cf;font-weight:700>6</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.&#34;</span> 		<span style=color:#8f5902;font-style:italic>// res0: String = The answer is 42.
</span></code></pre></div><p>使用<code>raw</code>创建的字符串不会对字面值进行转义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>raw&#34;No\\\\escape!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// prints: No\\\\escape!
</span></code></pre></div><p>使用<code>f</code>创建格式化字符串：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#4e9a06>f&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Pi</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>%.5f&#34;</span> 		<span style=color:#8f5902;font-style:italic>// res1: String = 3.14159
</span></code></pre></div><h2 id=操作符都是方法>操作符都是方法</h2>
<p>基本类型的操作符实际是普通的方法调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// Scala invokes 1.+(2)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>2</span> 			<span style=color:#8f5902;font-style:italic>// sum: Int = 3
</span></code></pre></div><p><code>Int</code>同时包含一些重载方法来接收不同类型的参数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// Scala invokes 1.+(2L)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>longSum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>2L</span> 	<span style=color:#8f5902;font-style:italic>// longSum: Long = 3
</span></code></pre></div><p>所有的方法都可以作为操作符。中缀操作符(infix)接收两个运算数，一个在左边一个在右边。前缀操作符(prefix)接收一个操作数，位于操作符的右边。而后缀操作符(postfix)则是操作数位于操作符的左边。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#0000cf;font-weight:700>7</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>2</span>		<span style=color:#8f5902;font-style:italic>// infix
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>7</span>			<span style=color:#8f5902;font-style:italic>// prefix
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>toLong</span>	<span style=color:#8f5902;font-style:italic>// postfix
</span></code></pre></div><p>在前缀操作符中，会将表达式转换成对应的方法调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>2.0</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2.0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>unary_-</span>
</code></pre></div><p>可以作为前缀操作符的标示符只有<code>+、-、!、~</code>。因此只有使用这四种标示符类定义方法，比如<code>unary_!</code>，才能以<code>!param</code>这样的语法调用。</p>
<h2 id=对象相等>对象相等</h2>
<p><code>==</code>可以用于所有的对象相等性比较。该方法定义在<code>Any</code>包中，实际的意义为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#000>eq</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#000>eq</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>this</span> <span style=color:#000>equals</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span>
<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#000>eq</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>that</span> <span style=color:#000>eq</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>Java 中的<code>==</code>可以用于比较基本类型和引用类型。基本类型时会进行值比较，这与 Scala 一致。</p>
<p>但是在比较引用类型时，Java 进行引用相等性比较，即两个变量是否指向 JVM 堆中的同一个对象，Scala 会使用<code>equals</code>进行引用类型的比较，该方法由用户定义。</p>
<p>而 Scala 中的引用相等性比较则使用<code>eq</code>方法。而 Java 中的<code>equal</code>仅作为引用比较。</p>
<h3 id=创建比较方法>创建比较方法</h3>
<p>在定义<code>equals</code>方法时，有四种影响判等行为的<strong>陷阱</strong>：</p>
<ol>
<li><code>equals</code>方法签名错误</li>
<li>改变<code>equals</code>放但是没有改变<code>hashCode</code>方法</li>
<li>依据可变字段定义<code>equals</code>方法</li>
<li>没有为<code>equals</code>定义正确的等价关系</li>
</ol>
<h4 id=1方法签名错误>1、方法签名错误</h4>
<p>现在有一个简单的类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在是第一种<code>equals</code>方法的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Point</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span>
</code></pre></div><p>进行测试：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>q</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>p1</span> <span style=color:#000>equals</span> <span style=color:#000>p2</span>		<span style=color:#8f5902;font-style:italic>// Boolean = true
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p1</span> <span style=color:#000>equals</span> <span style=color:#000>q</span>			<span style=color:#8f5902;font-style:italic>// Boolean = false
</span></code></pre></div><p>看起来一切正常，但是把他们放入集合时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>coll</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>coll</span> <span style=color:#000>contains</span> <span style=color:#000>p2</span>	<span style=color:#8f5902;font-style:italic>// Boolean = false
</span></code></pre></div><p>虽然<code>p1</code>与<code>p2</code>相等，但是<code>contains</code>方法却判断失败。</p>
<p>同时，当我们把<code>p2</code>赋值给一个<code>Any</code>类型的对象时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p2a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>p2</span>
<span style=color:#000>p1</span> <span style=color:#000>equals</span> <span style=color:#000>p2a</span>		<span style=color:#8f5902;font-style:italic>// Boolean = false
</span></code></pre></div><p>比较结果任然错误。</p>
<p>下面是<code>Any</code>中的<code>equals</code>定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span>
</code></pre></div><p>在一开始我们定义的<code>equals</code>方法中，参数类型设置为<code>Point</code>而不是<code>Any</code>，同时没有对<code>Any</code>中的方法进行重写，即使用<code>override</code>关键字标识。因此，这只是一个方法重载。当前，Scala 与 Java 中的重载已经通过参数的静态类型解决，但并非运行时类型。因此，当参数的静态类型为<code>Point</code>时会调用接收<code>Poiont</code>类型参数的方法，一旦参数的静态类型为<code>Any</code>，则会调用<code>Any</code>类型的方法。</p>
<p>因此在调用<code>Set</code>的<code>contaions</code>方法时，它会调用<code>object</code>类型的泛型<code>equals</code>方法而不是<code>Point</code>类型的方法。同时也是<code>p1 equals p2a</code>失败的原因。</p>
<p>下面是正确的<code>equals</code>定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Point</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>同时以相同的签名重写<code>==</code>方法，因为他被定义为<code>final</code>。</p>
</blockquote>
<h4 id=2未重新定义-hashcode-方法>2、未重新定义 hashCode 方法</h4>
<p>现在重复测试<code>coll contains p2</code>是仍然会出现错误，但并不是 100%。因为<code>Set</code>会以元素的 hash 值来进行比较，但是<code>Point</code>并未定义新的<code>hashCode</code>方法，仍然是原始的定义：只是对已分配对象的地址的转换。</p>
<p>在调用<code>equals</code>结果为<code>true</code>后会分别调用两个对象的<code>hashCode</code>方法并对结果进行比较。</p>
<p>同时，<code>hashCode</code>只能依赖于字段的值。下面是一个正确的定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hashCode</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>).#</span><span style=color:#204a87;font-weight:700>#</span> 
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Point</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span> 
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>##</code>方法是用于计算主要类型、引用类型、null的快捷方式。</p>
<h4 id=3依据可变字段定义-equals-方法>3、依据可变字段定义 equals 方法</h4>
<p>比如下面的定义，字段被定义为<code>var</code>而不再是<code>val</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>		<span style=color:#8f5902;font-style:italic>// var
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hashCode</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>).#</span><span style=color:#204a87;font-weight:700>#</span> 
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Point</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span> 
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这是在通过<code>Set</code>的<code>contains</code>方法进行判断：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>coll</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HashSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>coll</span> <span style=color:#000>contains</span> <span style=color:#000>p</span>				<span style=color:#8f5902;font-style:italic>// true
</span><span style=color:#8f5902;font-style:italic>// 修改 p 的字段值
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#000>coll</span> <span style=color:#000>contains</span> <span style=color:#000>p</span>				<span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>coll</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>iterator</span> <span style=color:#000>contains</span> <span style=color:#000>p</span>	<span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>如果改变了<code>p</code>的字段值，将会判断失败，但是通过<code>iterator</code>方法发现<code>p</code>仍然是<code>Set</code>的元素。</p>
<p>这是因为，修改字段值后的<code>p</code>，其 hash 值也跟着改变，<code>contaions</code>方法通过 hash 值比较的结果必然失败。</p>
<h4 id=4错误的等价关系>4、错误的等价关系</h4>
<p><code>scala.Any</code>的<code>equals</code>方法约定中，指定<code>equals</code>方法必须为<code>non-null</code>对象实现正确的等价关系。</p>
<ul>
<li>反射性：<code>non-null</code>值 x，表达式<code>x.equals(x)</code>必须返回<code>true</code></li>
<li>对称性：任何<code>non-null</code>值 x 和 y，当且仅当<code>x.equals(y)</code>返回<code>true</code>时，<code>y.equals(x)</code>才会返回<code>true</code></li>
<li>传递性：任何<code>non-null</code>值 x、y、z，如果<code>x.equals(y)</code>和<code>y.equals(z)</code>都返回<code>true</code>，则<code>x.equals(z)</code>也会返回<code>true</code></li>
<li>一致性：任何<code>non-null</code>值 x 和 y，多次调用<code>x.equals(y)</code>都会一致的返回<code>true</code>或<code>false</code></li>
<li>对任何<code>non-null</code>值 x，<code>x.equals(null)</code>应该返回<code>false</code></li>
</ul>
<p>上面的<code>Point</code>类已经能够很好的工作，但是如果它有一个新的子类，并且新增了一个字段：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Color</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Enumeration</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>Red</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Orange</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Yellow</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Green</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Blue</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Indigo</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Violet</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Value</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ColoredPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>color</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Color.Value</span><span style=color:#ce5c00;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ColoredPoint</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>color</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>color</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span> 
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通常会以上面的方式实现。这个子类继承父类，并重写了<code>equals</code>方法，该方法类似父类的形式，比较新字段并利用父类的<code>equals</code>方法比较原有的字段。</p>
<p>注意当前这个例子中，并不需要重写<code>hashCode</code>方法，因为子类中的<code>equals</code>实现比父类中的实现更为<em>严谨</em>(它与更小范围内的对象相等)，因此<code>hashCode</code>的契约依然有效。？？？</p>
<p>这个子类中的实现看起来没有问题，但是当他与父类混合时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span> 		
<span style=color:#204a87;font-weight:700>#</span> <span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Point</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Point</span><span style=color:#204a87;font-weight:700>@</span><span style=color:#0000cf;font-weight:700>5428</span><span style=color:#000>bd62</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cp</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ColoredPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Color</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Red</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#204a87;font-weight:700>#</span> <span style=color:#000>cp</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ColoredPoint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ColoredPoint</span><span style=color:#204a87;font-weight:700>@</span><span style=color:#0000cf;font-weight:700>5428</span><span style=color:#000>bd62</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>p</span> <span style=color:#000>equals</span> <span style=color:#000>cp</span> 		<span style=color:#204a87;font-weight:700>#</span> <span style=color:#000>res9</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cp</span> <span style=color:#000>equals</span> <span style=color:#000>p</span> 		<span style=color:#204a87;font-weight:700>#</span> <span style=color:#000>res10</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
</code></pre></div><p><code>p equals cp</code>会调用<code>p</code>的<code>equals</code>方法，这个方法只会对对象的坐标进行比较，并返回了<code>true</code>。</p>
<p><code>cp equals p</code>会调用<code>cp</code>的<code>equals</code>方法，因为<code>p</code>并不是一个<code>ColoredPoint</code>对象，因此返回<code>false</code>。</p>
<p>因此，<code>equals</code>中定义的相等性并不是对称的。</p>
<h4 id=canequal>canEqual</h4>
<p>在继承类型的比较中，需要引入一个<code>canEqual</code>方法。这个想法是，一旦一个类重新定义了<code>equals</code>(或同时也冲定义了<code>hashCode</code>)，它也必须明确指出，这类对象永远不能等于那些实现了不同判等方法的父类对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>canEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span>
</code></pre></div><p>这个方法中，如果<code>other</code>对象是一个(重)定义了<code>canEqual</code>方法的类的实例，返回<code>true</code>，否则返回<code>false</code>。在<code>equals</code>方法中调用这个方法来确保将要比较的两个对象能够进行双向比较。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hashCode</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>).#</span><span style=color:#204a87;font-weight:700>#</span> 
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Point</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> 
			<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span> <span style=color:#000>canEqual</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span>
	<span style=color:#ce5c00;font-weight:700>}</span> 
	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>canEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Point</span><span style=color:#ce5c00;font-weight:700>]</span>	<span style=color:#8f5902;font-style:italic>// 运行时类型相同
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后是子类的定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ColoredPoint</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>color</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Color.Value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Point</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hashCode</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>color</span><span style=color:#ce5c00;font-weight:700>).#</span><span style=color:#204a87;font-weight:700>#</span> 		<span style=color:#8f5902;font-style:italic>// 重写 hashCode
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ColoredPoint</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> 							<span style=color:#8f5902;font-style:italic>// 重写 equals
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span> <span style=color:#000>canEqual</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>color</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>color</span> 
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span>
	<span style=color:#ce5c00;font-weight:700>}</span> 
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>canEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>other</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ColoredPoint</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>对象相等性的实现依赖于场景。当前场景中，两个不同的<code>Point</code>对象拥有相同的坐标即视作相等。但是两个对象拥有相同坐标，但是一个没有颜色，一个为红色，则视作不相等。</p>
</blockquote>
<p><a href=http://www.techug.com/java-language-defect-2-equals-compare-strings>拓展：Java 中的字符串相等性比较</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f0387cb07d844a0cfdd62d257e521da0>1.17 - Numbers</h1>
<h2 id=介绍>介绍</h2>
<p>Scala 中所有的数字类型都是对象，包含 Byte, Char, Double, Float, Int, Long, Short。这 7 种数字类型都继承自 AnyVal。同时，另外的 Unit 和 Boolean 作为非数字类型。</p>
<p>如果需要更复杂的数字类型，可以使用 Spire 库或 ScalaLab 库。</p>
<p>如果需要使用时间库，可以使用 Joda 或对 Joda 的封装 nscala-time。</p>
<h2 id=将-string-转换为-int>将 String 转换为 Int</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;100&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span>
<span style=color:#4e9a06>&#34;100&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toDouble</span>
<span style=color:#4e9a06>&#34;100&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toFloat</span>
<span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toLong</span>
<span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toShort</span>
<span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toByte</span>
</code></pre></div><p>如果将一个实际上并不能转换为数字的字符串进行转换，会抛出 NumberFormatException 错误。</p>
<p>如果需要在转换时使用一个基数，即转换到对应的进制：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Inter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者可以创建一个隐式类和对应的方法来是转换更易于使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringToInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>radix</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Inter</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>radix</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=数字类型之间进行转换>数字类型之间进行转换</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#0000cf;font-weight:700>19.45</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span>
<span style=color:#0000cf;font-weight:700>19.</span><span style=color:#000>toFloat</span>
<span style=color:#0000cf;font-weight:700>19.</span><span style=color:#000>toLong</span>
</code></pre></div><p>使用<code>isValid</code>方法可以检查一个数字能否转换到另一种类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#0000cf;font-weight:700>1000L</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isValidByte</span>	<span style=color:#8f5902;font-style:italic>// false
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1000L</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isValidShort</span>	<span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><h2 id=覆写默认的数字类型>覆写默认的数字类型</h2>
<p>在向一个变量赋值时，Scala 会自动设置数字类型，可以通过几种不同的方式来设置需要的类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>	<span style=color:#8f5902;font-style:italic>// Int
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>d</span>	<span style=color:#8f5902;font-style:italic>// Double
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>f</span>	<span style=color:#8f5902;font-style:italic>// Float
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span>	<span style=color:#8f5902;font-style:italic>// Long
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Byte</span>	<span style=color:#8f5902;font-style:italic>// Byte
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Long</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>	<span style=color:#8f5902;font-style:italic>// Long
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Short</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span>	<span style=color:#8f5902;font-style:italic>// 设置为默认值，并不推荐的用法
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>asInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><h2 id=使用--和--使数字自增或自减>使用 ++ 和 — 使数字自增或自减</h2>
<p>这种<code>++</code>和<code>—</code>的用法在 Scala 中并不支持。因为 val 对象是不可变的，而 var 对象能够使用<code>+=</code>和<code>-=</code>来实现。并且，这些操作符是以方法的形式实现的。</p>
<h2 id=比较浮点型数字>比较浮点型数字</h2>
<p>可以创建一个方法来设置对比浮点数需要的精度：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>~=(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Doubele</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>precision</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>abs</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>precision</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>true</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>false</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>~=(</span><span style=color:#0000cf;font-weight:700>0.3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.33333</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0.0001</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这个功能的应用场景在于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#0000cf;font-weight:700>0.1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>0.2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.30000000004</span>		<span style=color:#8f5902;font-style:italic>// 并不是等于 0.3
</span></code></pre></div><h2 id=处理大数字>处理大数字</h2>
<p>可以使用 BigInt 和 BigDecimal 来处理大的整数和浮点数。</p>
<h2 id=生成随机数字>生成随机数字</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Random</span>
<span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nextInt</span>
<span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nextInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 0(包含0) 到 100(不包含100) 之间
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nextFloat</span>
<span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nextDouble</span>
<span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nextPrintableChar</span>	<span style=color:#8f5902;font-style:italic>// 	H
</span></code></pre></div><h2 id=创建集合与-range>创建集合与 Range</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span>			<span style=color:#8f5902;font-style:italic>// Range(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000>by</span> <span style=color:#0000cf;font-weight:700>2</span>	<span style=color:#8f5902;font-style:italic>// Range(1, 3, 5, 7, 9)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>until</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000>toArray</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toList</span>
<span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000>toList</span>
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toArray</span>
</code></pre></div><h2 id=格式化输出浮点数>格式化输出浮点数</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pi</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Pi</span>		<span style=color:#8f5902;font-style:italic>// pi: Double = 3.141592653589793
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>f&#34;</span><span style=color:#4e9a06>$pi</span><span style=color:#4e9a06>%1.5f&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 3.14159
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#4e9a06>f&#34;</span><span style=color:#4e9a06>$pi</span><span style=color:#4e9a06>%1.5f&#34;</span>					<span style=color:#8f5902;font-style:italic>// 3.14159
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#4e9a06>f&#34;</span><span style=color:#4e9a06>$pi</span><span style=color:#4e9a06>%1.2f&#34;</span>					<span style=color:#8f5902;font-style:italic>// 3.14
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#4e9a06>f&#34;</span><span style=color:#4e9a06>$pi</span><span style=color:#4e9a06>%06.2f&#34;</span>				<span style=color:#8f5902;font-style:italic>// 003.14
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a1325330d53643c57b1c157d2a0ad686>1.18 - String</h1>
<h2 id=介绍>介绍</h2>
<p>Scala 中的 String 其实是 Java 中的 String，因此可以在 Scala 中使用所有 Java 中的相关 API。同时，StringOps 中定义了很多 String 相关的隐式转换，因此可以对 String 使用很多方便的操作，或者将 String 看做是一个有**字符(character)**组成的序列来操作，使其拥有序列的所有方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// Predef.scala
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>String</span>        <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>String</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getBytes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 104,101,108...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#4e9a06>&#34;hello world&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;l&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=stringops>StringOps</h3>
<p>在 Scala 中，会自动引入 Predef 对象，Predef 中定义了 String 到 StringOps 的隐式转换，根据需要，String 会被 隐式转换为 StringOps 以拥有所有<strong>有序序列</strong>的方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringOps</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AnyVal</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>StringLike</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>thisCollection</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>WrappedString</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WrappedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>repr</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>protected</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>repr</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>WrappedString</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WrappedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>repr</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>seq</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WrappedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>repr</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringOps</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>repr</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=wrappedstring>WrappedString</h3>
<p>Predef 中还定义了 String 和 WrappedString：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>wrapString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>WrappedString</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#000>ne</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WrappedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>null</span>
<span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unwrapString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>WrappedString</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ws</span> <span style=color:#000>ne</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>ws</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>self</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>null</span>
</code></pre></div><p>WrappedString 的实现是对 String 的包装容器，将 String 作为一个参数并提供所有<strong>有序序列</strong>的操作。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WrappedString</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractSeq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Char</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>IndexedSeq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Char</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>StringLike</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>WrappedString</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>WrappedString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=stringlike>StringLike</h3>
<p>WrappedString 与 StringOps 的不同是，当执行一些类似 filter、map 的转换操作时，该类生成的是一个 WrappedString 对象而不是 String，在 StringOps 中，间接使用了 WrappedString 的封装。二者都混入了 StringLike，区别在于前者的混入方式是 <code>StringLike[WrappedString]</code>，后者是<code>StringLike[String]</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>StringLike</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+Repr</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>IndexedSeqOptimized</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Char</span>, <span style=color:#204a87;font-weight:700>Repr</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>在 StringLike 特质中，实现了 String 对象的相关集合操作。</p>
<h2 id=检查相等性>检查相等性</h2>
<p>两个 String 的相等，实际上是检查两个字符集合的相等。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;world&#34;</span>
<span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;hello&#34;</span>
<span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span>		<span style=color:#8f5902;font-style:italic>// ok
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;hello&#34;</span>		<span style=color:#8f5902;font-style:italic>// ok
</span></code></pre></div><p>当对一个值为 null 的 String 进行相等性检查时并不会出现空指针异常，但是当使用一个 null 调用方法时则会出现空指针异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>test</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span>
<span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpperCace</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;HELLO&#34;</span>	<span style=color:#8f5902;font-style:italic>// java.lang.NullPointerException
</span></code></pre></div><p>忽略大小写的相等性检查：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>equalsIgnoreCase</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><blockquote>
<p>Scala 中检查对象相等使用的是<code>==</code>而不是 Java 中的<code>equal</code>。</p>
<p><code>x == y</code> 实际上是：<code>if (x eq null) x eq null else x.equals(y)</code></p>
<p>因此，使用<code>==</code>进行相等判断时不需要检查是否为<code>null</code>。</p>
</blockquote>
<h2 id=创建多行-string>创建多行 String</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>foo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;&#34;This is 
</span><span style=color:#4e9a06>a multiline 
</span><span style=color:#4e9a06>String&#34;&#34;&#34;</span>
  
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>speech</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;&#34;Four score and 
</span><span style=color:#4e9a06>|seven years ago&#34;&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>stripMargin</span>
</code></pre></div><h2 id=切分-string>切分 String</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;hello world&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// Array(hello, world)
</span></code></pre></div><h2 id=将变量带入-string>将变量带入 String</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>weight</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$name</span><span style=color:#4e9a06> is </span><span style=color:#4e9a06>$age</span><span style=color:#4e9a06> years old, and weighs </span><span style=color:#4e9a06>$weight</span><span style=color:#4e9a06> pounds.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者在 String 中使用表达式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Age next year: </span><span style=color:#4e9a06>${</span><span style=color:#000>age</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=逐个处理-string-中的每个字符>逐个处理 String 中的每个字符</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>upper</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;hello, world&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpper</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>upper</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;hello, world&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpper</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>同时可以使用集合的方法与字符串方法相结合：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>val upper = &#34;hello, world&#34;.filter(_ != &#39;l&#39;).map(_.toUpper)
</code></pre></div><h2 id=模式查找>模式查找</h2>
<p>如果需要使用正则表达式来对 String 中需要的部分进行匹配，首先使用<code>.r</code>方法创建一个<code>Regex</code>对象，然后使用<code>findFirstIn</code>或<code>findAllIn</code>查找第一个或所有匹配的结果。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>numPattern</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[0-9]+&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>r</span> 
<span style=color:#000>numPattern</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>scala.util.matching.Regex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#a40000>0</span><span style=color:#204a87;font-weight:700>-</span><span style=color:#a40000>9</span><span style=color:#ce5c00;font-weight:700>]+</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>address</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;123 Main Street Suite 101&#34;</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>match1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>numPattern</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>findFirstIn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>match1</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>123</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>matches</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>numPattern</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>findAllIn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>matches</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>scala.util.matching.Regex.MatchIterator</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>non</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>empty</span> <span style=color:#000>iterator</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>matches</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#0000cf;font-weight:700>123</span>
<span style=color:#0000cf;font-weight:700>101</span>
</code></pre></div><p>处理匹配的结果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>match1</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>???</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>None</span> <span style=color:#204a87;font-weight:700>=&gt;</span>  <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>match1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>numPattern</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>findFirstIn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>address</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;no match&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者另一种方式创建<code>Regex</code>对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.util.matching.Regex</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>numPattern</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Regex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[0-9]+&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><blockquote>
<p>对于正则表达式的使用，可以应用一个名为“JavaVerbalExpressions”的扩展库，以更 DSL 的方式构建<code>Regex</code>对象。</p>
<p>VerbalExpression.regex()</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>VerbalExpression</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>regex</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>startOfLine</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>then</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;http&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>maybe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;s&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>then</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;://&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>maybe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;www.&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>anythingBut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>endOfLine</span><span style=color:#ce5c00;font-weight:700>()</span>
                        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
</code></pre></div></blockquote>
<h2 id=模式替换>模式替换</h2>
<p>由于 String 是不可变的，不可以在原有的 String 上进行修改，可以创建一个新的 String 包含替换后的结果。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>address</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;123 Main Street&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>replaceAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[0-9]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;x&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>regex</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[0-9]&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>r</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>newAddress</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>regex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>replaceAllIn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;123 Main Street&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;x&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;123&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>replaceFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;[0-9]&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;x&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=使用正则解析多个部分>使用正则解析多个部分</h2>
<p>如果需要将 String 的多个匹配部分解析到不同的变量，可以使用<strong>正则表达式组</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pattern</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;([0-9]+) ([A-Za-z]+)&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>r</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>fruit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;100 Bananas&#34;</span>

<span style=color:#000>count</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100</span>
<span style=color:#000>fruit</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Bananas</span>
</code></pre></div><p>或者同事创建多种模式以匹配不同的预期结果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;movies near 80301&#34;</span> 
<span style=color:#4e9a06>&#34;movies 80301&#34;</span> 
<span style=color:#4e9a06>&#34;80301 movies&#34;</span> 
<span style=color:#4e9a06>&#34;movie: 80301&#34;</span> 
<span style=color:#4e9a06>&#34;movies: 80301&#34;</span> 
<span style=color:#4e9a06>&#34;movies near boulder, co&#34;</span> 
<span style=color:#4e9a06>&#34;movies near boulder, colorado&#34;</span>

<span style=color:#8f5902;font-style:italic>// match &#34;movies 80301&#34; 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>MoviesZipRE</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;movies (\\d{5})&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>r</span>

<span style=color:#8f5902;font-style:italic>// match &#34;movies near boulder, co&#34; 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>MoviesNearCityStateRE</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;movies near ([a-z]+), ([a-z]{2})&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>r</span>

<span style=color:#000>textUserTyped</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MoviesZipRE</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>zip</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>getSearchResults</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>zip</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>MoviesNearCityStateRE</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>getSearchResults</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>city</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;did not match a regex&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=访问字符串中的字符>访问字符串中的字符</h2>
<p>可以以位置索引来访问 String 中的字符：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>charAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=为-string-类添加额外的方法>为 String 类添加额外的方法</h2>
<p>如果通过给现有的 String 添加额外的方法，使 String 拥有需要的方法，而不是将 String 作为一个参数传入一个需要的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;HAL&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>increment</span>
<span style=color:#8f5902;font-style:italic>// 而不是
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>StringUtilities</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>increment</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;HAL&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>可以创建一个隐式类，然后在隐式类中添加需要的方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringImprovements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>increment</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toChar</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;HAL&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>increment</span>
</code></pre></div><p>但是在真实的应用中，隐式类必须在一个 class、object、package 中定义。</p>
<h3 id=在-object-中定义-隐式类>在 object 中定义 隐式类</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringImprovements</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>increment</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toChar</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=在-package-中定义-隐式类>在 package 中定义 隐式类</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>object</span> <span style=color:#000>utils</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringImporvemrnts</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>increment</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toChar</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=使用隐式转换的方式>使用隐式转换的方式</h3>
<p>首先定义一个类，带有一个需要的方法，然后创建一个隐式转换，将 String 转换为这个带有目的方法的对象，就可以在 String 上调用该方法了：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>StringImprovement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>increment</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toChar</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>stringToStringImpr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringImprovement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-371ad1e63fe6e6dd95b5ad200e381db6>1.19 - Control</h1>
<h2 id=使用-for-与-foreach-循环>使用 for 与 foreach 循环</h2>
<p>如果需要迭代集合中的元素，或者操作集合中的每个元素，或者是通过已有的集合创建新集合，都可以使用 for 和 foreach 来处理。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elem</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>operationOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者从循环中生成值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>newArray</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpperCase</span>
</code></pre></div><p>生成的集合类型与输入的集合类型一致，比如一个 Array 会生成一个 Array。</p>
<p>或者通过一个计数器访问集合中的元素；</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000>until</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$i</span><span style=color:#4e9a06> is </span><span style=color:#4e9a06>${</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者使用集合提供的<code>zipWithIndex</code>方法，然后访问索引与元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zipWithIndex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$count</span><span style=color:#4e9a06> is </span><span style=color:#4e9a06>$e</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者使用守卫了限制处理条件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者处理一个 Map：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>names</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fname&#34;</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Robert&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;lname&#34;</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#4e9a06>&#34;Goren&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;key: </span><span style=color:#4e9a06>$k</span><span style=color:#4e9a06>, value: </span><span style=color:#4e9a06>$v</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><blockquote>
<p>在使用 for/yield 组合时，实际上是在创建一个新的集合，如果只是使用 for 循环则不会创建新的集合。for/yield 的处理过程类似于 map 操作。还有一些别的方法，如：foreach、map、flatMap、collect、reduce等都能完成类似的工作，可以根据需求选择合适的方法。</p>
</blockquote>
<p>另外，还有一些特殊的使用方式；</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 简单的处理
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// 使用匿名函数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpperCase</span><span style=color:#ce5c00;font-weight:700>))</span>

<span style=color:#8f5902;font-style:italic>// 使用多行的代码块
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toUpperCase</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=工作原理>工作原理</h3>
<p>for 循环的工作原理：</p>
<ul>
<li>一个简单的 for 循环对整个集合的迭代转换为在该集合上 foreach 方法的调用</li>
<li>一个带有守卫的 for 循环对整个集合的迭代转换为集合上 withFilter 方法的调用后跟一个 foreach 方法调用</li>
<li>一个 for/yield 组合表达式被转换为该集合上的 map 方法调用</li>
<li>一个带有守卫的 for/yield 组合表达式被转换为该集合上的 withFilter 方法调用后跟 map 方法调用</li>
</ul>
<p>通过命令<code>scalac -Xprint:parse Main.scala</code>可以查看 Scala 对 for 循环的具体转换过程。</p>
<h2 id=在多个-for-循环中使用多个计数器>在多个 for 循环中使用多个计数器</h2>
<p>可以在 for 循环中同时使用多个计数器：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>2</span>
  <span style=color:#000>j</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>2</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;i = </span><span style=color:#4e9a06>$i</span><span style=color:#4e9a06>, j = </span><span style=color:#4e9a06>$j</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>for 循环中的<code>&lt;-</code>标示符被引用为一个<strong>生成器(generator)</strong>。</p>
<h2 id=在-for-循环中使用守卫>在 for 循环中使用守卫</h2>
<p>有多种风格可以选择：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> 
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者使用传统的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>files</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasSoundFileExtension</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>soundFileIsLong</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#000>soundFiles</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>file</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>再或者可读性更强的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>file</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>files</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>passFilter1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>passFilter2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>doSomething</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>因为 for 循环会被转换为一个 foreach 的方法调用，可以直接使用 withFilter 然后调用 foreach 方法，也能达到同样的效果。</p>
<h2 id=foryield-组合>for/yield 组合</h2>
<p>for/yield 组合可以通过在已有的集合的没有元素上应用一个新的算法(或转换等)来生成一个新的集合，并且，新的集合类型与输入集合保持一致。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>names</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;chris&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;ed&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;maurice&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>capNames</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>capitalize</span>
<span style=color:#8f5902;font-style:italic>// Array(Chris, Ed, Maurice)
</span></code></pre></div><p>如果对每个元素的应用部分需要多行，可以使用<code>{}</code>来组织代码块：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>capNames</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>names</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// multi lines
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>capitalize</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=实现-break-和-continue>实现 break 和 continue</h2>
<p>在 Scala 中并没有提供 break 和 continue 关键字，但是通过<code>scala.util.control.Breaks</code>提供了类似的功能：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>util.control.Breaks._</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>BreakAndContinueDemo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>breakable</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>){</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>break</span>	<span style=color:#8f5902;font-style:italic>// 跳出循环
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>searchMe</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;peter piper picked a peck of pickled peppers&#34;</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>numps</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000>until</span> <span style=color:#000>seachMe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#000>breakable</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>searchMe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>charAt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;p&#39;</span><span style=color:#ce5c00;font-weight:700>){</span>
  		<span style=color:#000>break</span> 		<span style=color:#8f5902;font-style:italic>// 跳出 breakable, 而外层的循环 continue
</span><span style=color:#8f5902;font-style:italic></span>	  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
   		<span style=color:#000>numps</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
	  <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Found &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>numPs</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; p&#39;s in the string.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 Breaks 源码的定义当中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>break</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Nothing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>breakException</span> <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>breakable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>op</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ex</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BreakControl</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#000>ne</span> <span style=color:#000>breakException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>ex</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>break 的调用实际是抛出一个异常，breakable 部分会对捕捉这个异常，因此也就达到了“跳出循环”的效果。</p>
<p>而在上面例子的第二部分，breakable 实际上是控制的 if/else 部分，当满足了 if 的条件，执行 break，否则执行 <code>numps += 1</code>，即在不能满足使<code>numps +=1</code>的条件时跳过了当前元素，从而达到 continue 效果。</p>
<h3 id=通用语法>通用语法</h3>
<p>break：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>breakable</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cond</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>break</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>continue:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>breakable</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cond</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>break</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>有些场景需要处理嵌套的 break：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>LabledBreakDemo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.util.control._</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>Inner</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Breaks</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>Outer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Breaks</span>
  
  <span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>breakable</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>){</span>
      <span style=color:#000>Inner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>breakable</span><span style=color:#ce5c00;font-weight:700>{</span>
  		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>j</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#4e9a06>&#39;a&#39;</span> <span style=color:#000>to</span> <span style=color:#4e9a06>&#39;e&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  		  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;c&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Inner</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>break</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;i: </span><span style=color:#4e9a06>$i</span><span style=color:#4e9a06>, j: </span><span style=color:#4e9a06>$j</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  		  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;b&#39;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Outer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>break</span>
		<span style=color:#ce5c00;font-weight:700>}</span>
	  <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=其他方式>其他方式</h3>
<p>如果不想使用 break 这样的语法，还有其他的方式可是实现。</p>
<ul>
<li>
<p>通过在外部设置一个标记，满足条件是设定该标记，而执行时检查该标记：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>barrelIsFull</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span> 
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>monkey</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>monkeyCollection</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>barrelIsFull</span><span style=color:#ce5c00;font-weight:700>){</span>   
  <span style=color:#000>addMonkeyToBarrel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>monkey</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>barrelIsFull</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>checkIfBarrelIsFull</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li>
<li>
<p>通过 return 来结束循环</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sumToMax</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arr</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>limit</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> 
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>i</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>limit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>limit</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>sum</span> 
<span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>range</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sumToMax</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div></li>
</ul>
<h2 id=使用-if-实现三目运算符>使用 if 实现三目运算符</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>absValue</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>a</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#4e9a06>&#34;a&#34;</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>hash</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>hash</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>prime</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><blockquote>
<p>if 表达式会返回一个值。</p>
</blockquote>
<h2 id=使用-match-语句>使用 match 语句</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>month</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;January&#34;</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;February&#34;</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;March&#34;</span> 
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Invalid month&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当把 match 作为一个 switch 功能使用时，推荐的做法是使用<code>@switch</code>注解。如果当前的用法不能被编译为一个 tableswitch 或 lookupswitch 时将发出警告：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.annotation.switch</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SwitchDemo</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>@switch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;One&#34;</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Two&#34;</span> 
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Other&#34;</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=在一个-case-语句中匹配多个条件>在一个 case 语句中匹配多个条件</h2>
<p>如果有些场景中，多个不同条件都属于同一个业务逻辑，这时可以在一个 case 语句中添加多个条件，使用符号<code>|</code>分割，各种条件的关系为<code>或</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span> 
<span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;odd&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;even&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=将匹配表达式的结果赋给你个变量>将匹配表达式的结果赋给你个变量</h2>
<p>匹配语句的结果可以作为一个值赋值给一个变量：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>evenOrOdd</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>someNumber</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;odd&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;even&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=访问匹配语句中默认-case-的值>访问匹配语句中默认 case 的值</h2>
<p>如果想要访问默认 case 的值，需要使用一个变量名将其绑定，而不能使用通配符<code>_</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>default</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;You gave me: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>default</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=在匹配语句中使用模式匹配>在匹配语句中使用模式匹配</h2>
<p>匹配语句中可以使用多种模式，比如：常量模式、变量模式、构造器模式、序列模式、元组模式或类型模式。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>echoWhatYouGaveMe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 常量模式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;zero&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>true</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;true&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;hello&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;an empty list&#34;</span>
  
  <span style=color:#8f5902;font-style:italic>// 序列模式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;一个长度为3的列表，且第一个元素为0&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;含有多个元素的列表，且第一个元素为1&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Vector</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;含有多个元素的 Vector，且第一个元素为1&#34;</span>
  
  <span style=color:#8f5902;font-style:italic>// 元组模式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配 2 元组模式&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配 3 元组模式&#34;</span>
  
  <span style=color:#8f5902;font-style:italic>// 构造器模式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>first</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Alexander&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配一个 Person，第二个字段为 Alexander，并绑定第一个字段到变量 first 上&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Suka&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配一个 Dog，却字段值为 Suka&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>obj</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配一个 Some 并取出构造器中的值，同时将整个对象绑定到变量 obj&#34;</span>
  
  <span style=color:#8f5902;font-style:italic>// 类型模式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;String&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Int&#34;</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Dog</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配任何 Dog 类型，并将该对象绑定到变量 d&#34;</span>
  
  <span style=color:#8f5902;font-style:italic>// 通配模式
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配所有上面没有匹配到的值&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=在匹配表达式中使用-case-类>在匹配表达式中使用 case 类</h2>
<p>匹配 case 类或 case 对象的多种方式，用法的选择取决于你要在 case 语句右边使用哪部分值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Animal</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Woodpecker</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CaseClassTest</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>determiType</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Animal</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>moniker</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;将 name 字段的值绑定到变量 moniker&#34;</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_:</span><span style=color:#204a87;font-weight:700>Cat</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;仅匹配所有的 Cat 类&#34;</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Woodpecker</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;匹配 Woodpecker 对象&#34;</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;通配&#34;</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=匹配语句中使用守卫>匹配语句中使用守卫</h2>
<p>可以给每个单独的匹配语句添加额外的一个或多个守卫：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#000>contains</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;0-9 range: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>19</span> <span style=color:#000>contains</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;10-19 range: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#0000cf;font-weight:700>20</span> <span style=color:#000>to</span> <span style=color:#0000cf;font-weight:700>29</span> <span style=color:#000>contains</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;20-29 range: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hmmm...&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者是将一个对象的不同条件分拆到多个 case 语句：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>num</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;one, a lonely number&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;some other value&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=使用匹配语句代替-isinstanceof>使用匹配语句代替 isInstanceOf</h2>
<p>如果需要匹配一个类型或多种不同的类型，虽然可以使用<code>isInstanceOf</code>来进行类型的判断，但这样并不遍历同时也不提倡这种用法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Foo</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>do</span> <span style=color:#000>something</span> <span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>更好的方式是使用匹配语句：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>SentientBeing</span> 
<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Animal</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SentientBeing</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span> 
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SentientBeing</span>

<span style=color:#8f5902;font-style:italic>// later in the code ... 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printInfo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>SentientBeing</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#8f5902;font-style:italic>// handle the Person 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#8f5902;font-style:italic>// handle the Dog 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=使用匹配语句处理-list>使用匹配语句处理 List</h2>
<p>List 结构与其他的集合结构有点不同，它以常量单元开始，以 Nil 元素结束。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>y</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#a40000>2</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#a40000>3</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>Nil</span>
</code></pre></div><p>在编写递归算法时，可以利用最后一个元素为 Nil 对象的便利。比如下面的 listToString 方法，如果当前的元素不是 Nil，则继续递归调用列表剩余的部分。一旦当前元素为 Nil，停止递归调用并返回一个空字符串：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>listToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>rest</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34; &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>listToString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rest</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以用同样的方式来递归求所有元素之和：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>1</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>rest</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rest</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者元素之积：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>multiply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>1</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>rest</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>multiply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rest</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意，这些用法必须记得要处理 Nil 元素。</p>
<h2 id=在-trycatch-中处理多种异常>在 try/catch 中处理多种异常</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>openAndReadAFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>filename</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>FileNotFoundException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Couldn&#39;t find that file.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>IOException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Had an IOException trying to read that file&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者并不关心异常的种类，可以使用一个高阶异常类型来捕获可能的异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>openAndReadAFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>()</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>try {
  val i = s.toInt 
} catch {
  case _: Throwable =&gt; println(&#34;exception ignored&#34;) 
}
</code></pre></div><p>Java 中可以在 catch 部分抛出异常，但是 Scala 中没有受检异常，不必指定一个方法会抛出的异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Exception</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果想要声明抛出的异常类型，或者要与 Java 集成，可以使用<code>@throws</code>标注方法的异常类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#5c35cc;font-weight:700>@throws</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>NumberFormatException</span><span style=color:#ce5c00;font-weight:700>])</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Exception</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>e</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=在-trycatchfinally-语句块之外声明一个变量>在 try/catch/finally 语句块之外声明一个变量</h2>
<p>如果需要在 Try 语句块内使用一个变量，并且需要在最后的 finally 块中访问，比如一个资源对象需要在 finally 中关闭：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CopyBytes</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>None</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FileInputStream</span><span style=color:#ce5c00;font-weight:700>]</span> 
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>out</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>None</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>]</span>

  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/tmp/Test.class&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
    <span style=color:#000>out</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/tmp/Test.class.copy&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> 
    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>−</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>})</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> 
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>IOException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>printStackTrace</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;entered finally ...&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isDefined</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isDefined</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者使用更简洁的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#000>in</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileInputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/tmp/Test.class&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>out</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/tmp/Test.class.copy&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#000>in</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>inputStream</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
    <span style=color:#000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>outputStream</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
      <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> 
      <span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>({</span><span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>inputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#ce5c00;font-weight:700>−</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>})</span> <span style=color:#ce5c00;font-weight:700>{</span> 
        <span style=color:#000>outputStream</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>write</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=自定义控制结构>自定义控制结构</h2>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a86ccd1cd8f1f4c2e08d2323821e96c4>1.20 - Pattern Match</h1>
<h2 id=类比-switch>类比 switch</h2>
<p>模式匹配类似于 Java 中的<code>switch</code>语句，但与它不同之处在于：</p>
<ul>
<li>它是一个表达式，有返回值</li>
<li>不会落空</li>
<li>没有任何匹配到的项则会抛出<code>MatchError</code></li>
</ul>
<h2 id=基本语法>基本语法</h2>
<p><code> case pattern => result</code>：</p>
<ul>
<li><code>case</code>后跟一个<code>pattern</code></li>
<li><code>pattern</code>必须是合法的模式类型之一</li>
<li>如果与模式匹配上了，结果会被计算并返回</li>
</ul>
<h2 id=通配符模式>通配符模式</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>matchAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>any</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>any</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;It’s a match!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>通配符<code>_</code>会对匹配所有对象，会当做一个默认的模式来使用，以避免<code>MatchError</code>。</p>
<h2 id=常量模式>常量模式</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isIt8</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>any</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>any</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;8:00&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Yes&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Yes&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;No&#34;</span>		<span style=color:#8f5902;font-style:italic>// 对其他任何情况进行匹配，设置一个默认的 No
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=变量模式>变量模式</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>matchX</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>any</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>any</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>s&#34;He said </span><span style=color:#4e9a06>$x</span><span style=color:#4e9a06>!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的<code>X</code>作为一个标示符，会对任何对象进行匹配。</p>
<h2 id=变量--常量>变量 & 常量</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>math.Pi</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pi</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Pi</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>m1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Pi</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Pi!&#34;</span>				<span style=color:#8f5902;font-style:italic>// 大写的常量模式，会引用常量 Pi 的值进行匹配
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;not Pi!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>m2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>pi</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Pi!&#34;</span>				<span style=color:#8f5902;font-style:italic>// 小写的变量模式，所有的对象都会进行匹配
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;not Pi!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pi</span><span style=color:#ce5c00;font-weight:700>))</span>		<span style=color:#8f5902;font-style:italic>// Pi!
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m1</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3.14</span><span style=color:#ce5c00;font-weight:700>))</span>	<span style=color:#8f5902;font-style:italic>// not Pi!
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pi</span><span style=color:#ce5c00;font-weight:700>))</span>		<span style=color:#8f5902;font-style:italic>// Pi!
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3.14</span><span style=color:#ce5c00;font-weight:700>))</span>	<span style=color:#8f5902;font-style:italic>// Pi!
</span></code></pre></div><p><strong>这里需要注意的地方：</strong></p>
<ul>
<li>如果标示符为<strong>大写</strong>，编译器会把它当做一个<strong>常量</strong></li>
<li>如果标示符为<strong>小写</strong>，编译器会把它当做一个<strong>变量</strong>，仅限匹配表达式内部的作用域</li>
</ul>
<p>如果需要在匹配表达式中引用一个变量的值，可以通过一下方式：</p>
<ul>
<li>使用名称限制，比如<code>this.pi</code></li>
<li>使用引号包围变量，比如 &ldquo;`pi`&rdquo;</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>math.Pi</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pi</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Pi</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>m3</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pi</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Pi!&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;not Pi!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>m4</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>`pi`</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Pi!&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;not Pi!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=构造器模式---case-类>构造器模式 - case 类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hours</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minutes</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>noon</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>morn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>))</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Time</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>t</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;twelve something&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;not twelve&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=嵌套构造器>嵌套构造器</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>House</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>street</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>number</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Address</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>city</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>house</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>House</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>address</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Address</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>peter</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Peter&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>33</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Address</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hamburg&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>House</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Reeperbahn&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>45</span><span style=color:#ce5c00;font-weight:700>)))</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>paul</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Paul&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>29</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Address</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Berlin&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>House</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Oranienstrasse&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>64</span><span style=color:#ce5c00;font-weight:700>)))</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>m45</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Address</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>House</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>45</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Must be Peter!&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Address</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>House</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Someone else&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=序列模式>序列模式</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>l1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>l2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>l3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>ml</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>l</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;starts with 1 and has 4 elements&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;starts with 5&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=另一种用法>另一种用法</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>annotation._</span>

<span style=color:#5c35cc;font-weight:700>@tailrec</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contains5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;No&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#ce5c00;font-weight:700>+:</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Yes&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+:</span> <span style=color:#000>tail</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>contains5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的符号<code>+:</code>实际上是一个序列的解析器，其源码中的定义为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>/** An extractor used to head/tail deconstruct sequences. */</span>
<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>+:</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unapply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>None</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因此上面的匹配语句实际上等同于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#5c35cc;font-weight:700>@tailrec</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contains5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;No&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>+:(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Yes&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>+:(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>contains5</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tail</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=解析器>解析器</h2>
<ul>
<li>一个解析器是一个拥有<code>unapply</code>方法的 Scala 对象</li>
<li>可以吧<code>unapply</code>理解为<code>apply</code>的反向操作</li>
<li><code>unapply</code>会将需要匹配的值当做一个参数(如果这个值与<code>unapply</code>的参数类型一致)</li>
<li>返回结果：
<ul>
<li>没有变量时返回：Boolean</li>
<li>一个变量时返回：<code>Option[A]</code></li>
<li>多个变量时返回：<code>Option[TupleN[...]]</code></li>
</ul>
</li>
<li>the returned is matched with your pattern</li>
</ul>
<h3 id=编写一个解析器>编写一个解析器</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hours</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minutes</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>noon</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>morn</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>eve</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>))</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AM</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unapply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Time</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hours</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>12</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>greet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>t</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>AM</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Good Morning!&#34;</span>	<span style=color:#8f5902;font-style:italic>// 这里调用 AM 中的 unapply 方法，t 作为其参数传入
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Good Afternoon!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=变量绑定>变量绑定</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>AM</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unapply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Time</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>Int</span>,<span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)]</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hours</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hours</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>minutes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>None</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>greet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Time</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>t</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>AM</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>f&#34;Good Morning, it&#39;s </span><span style=color:#4e9a06>$h</span><span style=color:#4e9a06>%02d:</span><span style=color:#4e9a06>$m</span><span style=color:#4e9a06>%02d!&#34;</span>	<span style=color:#8f5902;font-style:italic>// 将 t 的字段绑定到变量 h、m
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Good Afternoon!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=未知数量的变量绑定>未知数量的变量绑定</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;lightbend.com&#34;</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;www.scala-lang.org&#34;</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Domain</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unapplySeq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>split</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\\.&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// unapplySeq
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>md</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Domain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;business&#34;</span>	<span style=color:#8f5902;font-style:italic>// 将其他变量绑定到 _*
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Domain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;non-profit&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=正则表达式模式>正则表达式模式</h2>
<p><code>scala.util.matching.Regex</code>提供了一个<code>unapplySeq</code>方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pattern</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;a(b*)(c+)&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>r</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;abbbcc&#34;</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;acc&#34;</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;abb&#34;</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>s&#34;&#34;&#34;two groups &#34;</span><span style=color:#4e9a06>$a</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#4e9a06>$bs</span><span style=color:#4e9a06>&#34;&#34;&#34;&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>pattern</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>s&#34;&#34;&#34;three groups &#34;</span><span style=color:#4e9a06>$a</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#4e9a06>$bs</span><span style=color:#4e9a06>&#34; &#34;</span><span style=color:#4e9a06>$cs</span><span style=color:#4e9a06>&#34;&#34;&#34;&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span>  <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;no match&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=字符串插值器string-interpolator>字符串插值器(string interpolator)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>TimeStringContext</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sc</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>StringContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any*</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unapplySeq</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>regexp</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;&#34;(\d{1,2}):(\d{1,2})&#34;&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>r</span>
      <span style=color:#000>regexp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>unapplySeq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toInt</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isTime</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>t</span><span style=color:#4e9a06>&#34;$hours:$minutes&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Time</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hours</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minutes</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Not a time!&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=类型匹配>类型匹配</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;list of strings&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;list of ints&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.reflect._</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>print</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A:</span> <span style=color:#204a87;font-weight:700>ClassTag</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>classTag</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>runtimeClass</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;List of strings&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span>    <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;List of ints&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Integer&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;String&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=多重匹配>多重匹配</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>alt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;little&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>100</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>200</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;big&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=联合类型>联合类型</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>talt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>stringOrInt</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#204a87;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
    <span style=color:#4e9a06>s&#34;Union String | Int: </span><span style=color:#4e9a06>$stringOrInt</span><span style=color:#4e9a06>&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;unknown&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=switch>@switch</h2>
<p>用于检查匹配语句能否被编译为一个<code>tableswitch</code>或<code>lookupswitch</code>的跳转表，如果被编译成一系列连续的条件语句，将会报错。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>annotation._</span> 

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>wsw</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>@switch</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Yes&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;No&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;No&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>wosw</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Yes&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;No&#34;</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;No&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-bebf1a0e8787e229c152ca3a2c6e93de>1.21 - Class Object: 基础</h1>
<h2 id=类对象方法>类、对象、方法</h2>
<p><strong>类</strong>是<strong>对象</strong>的蓝图。在类的定义中可以放置<strong>字段</strong>和<strong>方法</strong>，称为<strong>成员</strong>。</p>
<p>字段同时称为<strong>实例变量</strong>，因为每个类的实例都会有它自己的一组变量。使用<code>val</code>定义不可变字段，<code>var</code>来定义可变字段。</p>
<blockquote>
<p><strong>不可变</strong>是指，一个变量名始终只能引用一个对象，不能再次修改为引用其他的对象。</p>
</blockquote>
<p>所有成员默认为<code>public</code>，使用<code>private</code>来指定私有成员。</p>
<p>所有方法的参数可以在方法内使用。并且这些参数为<code>val</code>。方法使用最后一行表达式的值作为返回值，不需要使用<code>return</code>语句。</p>
<h2 id=分号>分号</h2>
<p>在 Scala 中<strong>分号</strong>通常可以省略，如果一行中有多个语句，仍可以使用它作为分隔。</p>
<p>对于不明显语句，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>x</span>
<span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>
</code></pre></div><p>可以使用小括号将整个语句包围，或者将操作符放在第一行的末尾：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span>
<span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> 
<span style=color:#000>y</span>
</code></pre></div><p>语句分隔规则：</p>
<p>行尾通常会作为语句的结束，除非它属于以下情况：</p>
<ul>
<li>一行的末尾不是一个合法的单词，如：<code>.</code>、中缀操作符等</li>
<li>下一行开头的单词不能作为一个合法的语句开始</li>
<li>在小括号内或中括号内的行尾，因为这些符号内不能存在多行语句</li>
</ul>
<h2 id=单例对象>单例对象</h2>
<p>Scala 没有静态成员，但是拥有<strong>单例对象</strong>。单例对象使用关键字<code>object</code>定义。并且不能有参数列表，与其类拥有相同的 name，同时二者必须处于同一个文件内。而这个类就称为该半生对象的<strong>伴生类</strong>。二者可以互相访问对方的私有成员。</p>
<p>一个伴生对象可以作为类似 Java 中放置静态成员的地方。同时他是一个**一类(first-class)**对象。</p>
<p>定义一个单例对象时并不会定义一个类型(type)。比如定义一个<code>TimeUtil</code>的单例对象并不能创建<code>TimeUtil</code>类型的变量。名字为<code>TimeUtil</code>的类型只能通过单例对象的伴生类来定义。</p>
<p>单例对象可以扩展一个超类或超特质，是单例对象成为这些超类、超特质的一个实例。</p>
<p>单例对象会在第一次没访问时进行初始化。</p>
<p>与类不同名的单例对象称为<strong>独立对象(standalone object)</strong>。可以用来收集公用性质的方法作为 Scala 应用的入口点。</p>
<h2 id=scala-应用>Scala 应用</h2>
<p>运行一个 Scala 应用时必须提供一个独立单例对象，包括一个带有单个<code>Array[String]</code>类型的参数的<code>main</code>方法，同时返回类型为<code>Unit</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Application</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#8f5902;font-style:italic>// excutable code here
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>所有的 Scala 文件都会自动从 scala 包中自动引入<code>Predef</code>单例对象，其中包含一些常用的定义，比如常用类型别用、常用隐式转换等。</p>
</blockquote>
<p>Scala 中类名不需要与文件名一致。</p>
<p>运行一个 Scala 文件中的应用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ scalac ChecksumAccumulator.scala Summer.scala
$ fsc ChecksumAccumulator.scala Summer.scala
</code></pre></div><h2 id=app-特质>App 特质</h2>
<p>独立单例对象可以混入一个<code>App</code>特质，就不需要再编写<code>main</code>方法，来作为一个程序入口点。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Application</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// excutable code here
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=不可变对象>不可变对象</h2>
<p>使用不可变对象的优势：</p>
<ol>
<li>不可变对象没有会随着时间改变的复杂状态，易于推理。</li>
<li>可以将不可变对象自由传递，如果是可变对象则需要对他们进行<strong>深拷贝</strong>。</li>
<li>不会有多个线程并行访问并破会他们最初构造时的状态。</li>
<li>不可变对象拥有安全的 Hash 键。</li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b368582523f0bdc79a3f91466d645971>1.22 - Class Object: 类</h1>
<h2 id=创建主构造器>创建主构造器</h2>
<p>Scala 的主构造器包括：</p>
<ul>
<li>主构造器参数</li>
<li>类体中调用的方法</li>
<li>类体中执行的语句和表达式</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;the constructor begins&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#8f5902;font-style:italic>// 字段
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>HOME</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;user.home&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  
  <span style=color:#8f5902;font-style:italic>// 方法
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;</span><span style=color:#4e9a06>$firstName</span><span style=color:#4e9a06> </span><span style=color:#4e9a06>$lastName</span><span style=color:#4e9a06> is </span><span style=color:#4e9a06>$age</span><span style=color:#4e9a06> years old&#34;</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printHome</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;HOME = </span><span style=color:#4e9a06>$HOME</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printFullName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic>// uses toString
</span><span style=color:#8f5902;font-style:italic></span>  
  <span style=color:#8f5902;font-style:italic>// 方法调用
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>printHome</span>
  <span style=color:#000>printFullName</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;still in the constructor&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个例子中，整个类体中的部分都属于构造器，包括字段、表达式执行、方法、方法调用。</p>
<p>在 Java 中你可以清晰的区分是否在主构造器之中，但是 Scala 模糊了这种区分。</p>
<ul>
<li>构造器参数：这里被声明为 var，表示两个字段是可变字段，类体中的 age 字段也是一样，而 HOME 字段没声明为 val，表示为不可变字段</li>
<li>方法调用：类体中的方法调用同样属于主构造器的一部分</li>
</ul>
<h2 id=控制构造器字段可见性>控制构造器字段可见性</h2>
<p>影响字段可见性的几种因素：</p>
<ul>
<li>如果字段声明为 var，会同时生成 setter 和 getter 方法</li>
<li>如果字段声明为 val，只会生成 getter 方法</li>
<li>如果既没有 val 也没有 var，Scala 会以保守的方式不生产任何 setter 或 getter</li>
<li>如果字段声明为 private，无论是 var 还是 val，都不会生成任何 setter 或 getter</li>
</ul>
<p>而 case 类默认指定字段为 val。</p>
<h2 id=定义辅助构造器>定义辅助构造器</h2>
<p>可以同时定义多个辅助构造器，以支持使用不同的方式创建类实例。定义的方式为，使用 this 方法创建辅助构造器，并且所有的辅助构造器需要拥有不同的签名(参数列表)，并且，每个辅助构造器都必须调用以定义的上个构造器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 主构造器
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>crustSize</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>crustType</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#8f5902;font-style:italic>// 一个参数的辅助构造器
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>crustSize</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>crustSize</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#8f5902;font-style:italic>// 一个参数的辅助构造器
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>crustType</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_SIZE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>crustType</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#8f5902;font-style:italic>// 无参数辅助构造器
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_SIZE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;A </span><span style=color:#4e9a06>$crustSize</span><span style=color:#4e9a06> inch pizza with a </span><span style=color:#4e9a06>$crustType</span><span style=color:#4e9a06> crust&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Pizze</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>DEFAULT_CRUST_SIZE</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>12</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>DEFAULT_CRUST_TYPE</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;THIN&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后就可以使用不同的方式来创建实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_SIZE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_SIZE</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p3</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pizza</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>DEFAULT_CRUST_TYPE</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p4</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Pizza</span>
</code></pre></div><p><strong>辅助构造器的使用要点：</strong></p>
<ul>
<li>使用 this 方法定义</li>
<li>都必须调用在前面已定义的辅助构造器</li>
<li>都必须拥有不同的签名</li>
<li>每个构造器使用 this 调用其他的构造器</li>
</ul>
<h3 id=为-case-类创建辅助构造器>为 case 类创建辅助构造器</h3>
<p>case 类会比一般的类为你生成更多的模板代码，并且，case 类的构造器并不是真正的构造器，而是伴生对象中的 apply 方法，因此辅助构造器的定义方式也有所不同。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pserson</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// 伴生对象
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&lt;no name&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Pam&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>Persion</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Alex&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=定义私有构造器>定义私有构造器</h2>
<p>有时候需要定义一个私有构造器，比如在实现单例模式的时候：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Order</span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span> <span style=color:#204a87;font-weight:700>private</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这时只能在类的内部或半生对象中创建实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Alex&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getInstance</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>person</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>some</span> <span style=color:#000>where</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>person</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getInstance</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样就实现了单例模式。大多数时候并不需要使用私有构造器，通常只需要定义一个 object。</p>
<h2 id=为构造器参数提供默认值>为构造器参数提供默认值</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Socket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>timeout</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这种方式实际上是有两个构造器组成：一个单参数的主构造器，一个无参数的辅助构造器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Socket</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>timeout</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>s&#34;timeout: </span><span style=color:#4e9a06>$timeout</span><span style=color:#4e9a06>&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=重写默认的访问器和修改器>重写默认的访问器和修改器</h2>
<p>比如一个 Person 类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#8f5902;font-style:italic>// 实际上是创建了一个循环引用
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>name</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>name_=</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aName</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>aName</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这会导致编译错误，因为 Scala 已经自动生成了<strong>同名</strong>的 getter 和 setter 方法，如果再创建同名的方法，实际上是一个循环引用，并导致编译失败。遍历的方式是修改主构造器中的参数名，而在自定义的 setter 和 getter 方法中使用真正有用的参数名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>_name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>_name</span>								<span style=color:#8f5902;font-style:italic>// getter
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>name_=</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>aName</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>_name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>aName</span> <span style=color:#ce5c00;font-weight:700>}</span>	<span style=color:#8f5902;font-style:italic>// setter
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>注意，参数必须被声明为 private，因此只能通过 setter 和 getter 方法来设置和访问字段值。</p>
<h2 id=避免自动生成-setter-和-getter>避免自动生成 setter 和 getter</h2>
<p>Scala 会自动为主构造器参数生成 setter 和 getter 方法，如果不想生成这些方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Stock</span> <span style=color:#ce5c00;font-weight:700>{</span>
<span style=color:#8f5902;font-style:italic>// getter and setter methods are generated 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>delayedPrice</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span>

<span style=color:#8f5902;font-style:italic>// keep this field hidden from other classes 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>currentPrice</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=私有字段>私有字段</h3>
<p>如果一个字段被声明为 private，则只有类的实例能够访问该字段，或者类的实例访问该类的其他实例的这个字段：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Stock</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>price</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setPrice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>price</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isHigher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Stock</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>price</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>price</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Driver</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Stock</span> 
  <span style=color:#000>s1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setPrice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Stock</span> 
  <span style=color:#000>s2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setPrice</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isHigher</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s1</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#8f5902;font-style:italic>// s2 的 isHigher 方法访问了 s1 的私有字段 price
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=对象私有字段>对象私有字段</h3>
<p>如果使用<code>private[this]</code>来修饰字段会进一步增强该字段的私密性，被修饰的字段只能被当前对象访问，与普通的 private 不同，这种方式使相同类的不同实例也不能访问该字段。</p>
<h2 id=使用代码块或函数为字段赋值>使用代码块或函数为字段赋值</h2>
<p>类字段可以通过一段代码块或一个函数来赋值。这些操作都属于构造器的一部分，只有在该类创建新的实例时执行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>text</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>lines</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>lines</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Source</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fromFile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/etc/passwd&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>getLines</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkString</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
	  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Exception</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>lines</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Error happened&#34;</span> 
	<span style=color:#ce5c00;font-weight:700>}</span> 
	<span style=color:#000>lines</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果使用了 lazy 关键字来修饰字段，则只有该字段在第一次被访问时才会进行初始化。</p>
<h2 id=设置未初始化的可变字段类型>设置未初始化的可变字段类型</h2>
<p>通常的方式是使用 Option 并设置为 None，对于一些基本类型，可以设置为常用的默认值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>firstName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>lastName</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>address</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>None</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Address</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是，推荐的方式是设置字段为 val 类型，并在需要的时候使用 copy 方法根据原有的对象创建一个新对象而不是修改原有对象的字段值，同时，避免使用 null 和初始值，应尽量使用 Option 并设置 None 来作为默认值。</p>
<h2 id=类继承时如何处理构造器参数>类继承时如何处理构造器参数</h2>
<p>在子类继承基类时，由于 Scala 已经为基类的构造器参数自动生成了 setter(var) 和 getter 方法，因此子类在声明构造器参数时，可以省略掉参数前面的 var 或 val，以避免重新自动生成的 setter 和 getter 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Employe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>gender</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=调用父类构造器>调用父类构造器</h2>
<p>可以在子类的主构造器中调用父类构造器或不同的辅助构造器，但是不能在子类辅助构造器中调用父类构造器。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为任何类的辅助构造器都要调用类自身中已定义的其他构造器，因此也就不能调用父类的构造器了。</p>
<h2 id=何时使用抽象类>何时使用抽象类</h2>
<p>由于 Scala 中拥有特质，比抽象类更加轻量且支持线性扩展(允许混入多个特质，但是不能继承多个抽象类)，只有很少的需求来使用抽象类：</p>
<ul>
<li>对构造器参数有需求的时候，因为特质没有构造器</li>
<li>这部分代码会被 Java 调用</li>
</ul>
<p>抽象类语法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BaseController</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>db</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Database</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>save</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>db</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>save</span> <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>update</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>db</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>update</span> <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>connect</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getStatus</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setServerName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>serverName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>继承自抽象类的类要么实现所有的抽象方法，要么也声明为抽象类。</p>
<h2 id=在抽象基类或特质中定义属性>在抽象基类或特质中定义属性</h2>
<p>可以在抽象类或特质中使用 var 或 val 来定义属性，以便在所有子类中都能访问：</p>
<ul>
<li>一个抽象的 var 字段会自动生成 setter 和 getter 字段</li>
<li>一个抽象的 val 字段会自动生成 getter 字段</li>
<li>定义抽象字段时，并不会在编译后的结果代码中创建这些字段，只是自动生成对应的方法，因此在子类中仍然要使用 val 或 var 来定义这些字段，但是如果抽象类中已经提供了字段的默认值，子类中就不需要再使用 var 或 val 来修饰字段，可以根据需要直接修改字段值</li>
</ul>
<p>同时，抽象类中不应该使用 null，而应该使用 Option。</p>
<h2 id=通过-case-类生成模板代码>通过 case 类生成模板代码</h2>
<p>使用 case 类会自动创建一系列模板代码：</p>
<ul>
<li>生成一个 apply 方法，因此不需要使用 new 关键字创建实例</li>
<li>生成 getter 方法，因为 case 类的参数默认为 val，如果生命为 var，则会自动生成 setter 方法</li>
<li>生成一个好用的 toString 方法</li>
<li>生成一个 unapply 方法，以便能够很好的用于模式匹配</li>
<li>生成 equals 和 hashCode 方法</li>
<li>生成 copy 方法</li>
</ul>
<h2 id=定义一个-equal-方法对象相等性>定义一个 equal 方法(对象相等性)</h2>
<p>定义一个 equal 方法用于比较实例之间的相等性：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>canEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Person</span><span style=color:#ce5c00;font-weight:700>]</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>that</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>canEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hashCode</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hashCode</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hashCode</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>prime</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>34</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
    <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>prime</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>age</span><span style=color:#ce5c00;font-weight:700>;</span> 
    <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>prime</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>)</span> 
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为定义了 canEqual 方法，因此可以使用<code>==</code>来比较实例之间的相等性，与 Java 不同的是，<code>==</code>在 Java 中是引用的比较。</p>
<h3 id=原理>原理</h3>
<p>Scala 文档中对任何类中 equal 方法的要求：任何该方法的实现必须是<strong>值相等性关系</strong>。必须包含以下三个属性：</p>
<ul>
<li>它是反射的：任何类型的实例 x，<code>x.equals(x)</code>必须返回 true</li>
<li>它是对称的：任何类型的实例 x 和 y，当且仅当<code>y.equals(x)</code>返回 true 时，<code>x.equals(y)</code>返回 true</li>
<li>它是传递的：任何类型的实例 x、y、z，如果<code>x.equals(y)</code>和<code>y.equals(z)</code>都返回 true，<code>x.equals(z)</code>也必须返回 true</li>
</ul>
<h2 id=创建内部类>创建内部类</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PandorasBox</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Thing</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>things</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>collection</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ArrayBuffer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Thing</span><span style=color:#ce5c00;font-weight:700>]()</span> 
  <span style=color:#000>things</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>Thing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Evil Thing #1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>things</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>Thing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Evil Thing #2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>addThing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>things</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Thing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>外部对 Thing 一无所知，只能通过 addThing 方法来添加。在 Scala 中，内部类会绑定到外部对象上，而不是一个单独的类。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2ba3a131bee7ffbc3f1ffd60a98472d9>1.23 - Class Object: 方法</h1>
<h2 id=控制方法作用域>控制方法作用域</h2>
<p>Scala 方法默认为 public，可见性的控制方法与 Java 类似，但是提供比 Java 更细粒度更有力的控制方式：</p>
<ul>
<li>对象私有(object-private)</li>
<li>私有(private)</li>
<li>包(package)</li>
<li>指定包(package-specific)</li>
<li>公共(public)</li>
</ul>
<h3 id=对象私有域>对象私有域</h3>
<p>只有该对象的当前实例能够访问该方法，相同类的其他实例无法访问：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isFoo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</code></pre></div><h3 id=私有域>私有域</h3>
<p>该类或该类的所有实例都能访问该方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>isFoo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</code></pre></div><h3 id=保护域>保护域</h3>
<p>只有子类能够访问该方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>breathe</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</code></pre></div><p>在 Java 中，该域方法可以被当前包(package)的其他类访问，但是在 Scala 中不可以。</p>
<h3 id=包域>包域</h3>
<p>当前包中所有成员都可以访问：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.acme.coolapp.model</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>model</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>doX</span> <span style=color:#ce5c00;font-weight:700>{}</span> 	<span style=color:#8f5902;font-style:italic>// 定义为包域，model 包中所有成员可以访问
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>doY</span> <span style=color:#ce5c00;font-weight:700>{}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=更多级别的包控制>更多级别的包控制</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.acme.coolapp.model</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>model</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>doX</span> <span style=color:#ce5c00;font-weight:700>{}</span>		<span style=color:#8f5902;font-style:italic>// 指定到 model 级别
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>coolapp</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>doY</span> <span style=color:#ce5c00;font-weight:700>{}</span> 	<span style=color:#8f5902;font-style:italic>// 指定到 coolapp 级别
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>acme</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>doZ</span> <span style=color:#ce5c00;font-weight:700>{}</span>		<span style=color:#8f5902;font-style:italic>// 指定到 acme 级别
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=公共域>公共域</h3>
<p>如果没有任何作用域的声明，即为公共域。</p>
<h2 id=调用父类方法>调用父类方法</h2>
<p>可以在子类中调用父类或特质中已存在的方法来复用代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WelcomeActivity</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Activity</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onCreate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bundle</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Bundle</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>onCreate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bundle</span><span style=color:#ce5c00;font-weight:700>)</span> 
    <span style=color:#8f5902;font-style:italic>// more code here ... 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=指定调用不同特质中的方法>指定调用不同特质中的方法</h3>
<p>如果同时继承了多个特质，并且这些特质都实现了相同的方法，这时不但能指定调用方法名，还能指定调用的特质名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Human</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;the Human trait&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Mother</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Human</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Mother&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Father</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Human</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hello</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Father&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Child</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Human</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Mother</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>Father</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printSuper</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hello</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printMother</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Mother</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hello</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printFather</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Father</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hello</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printHuman</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Human</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hello</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是并不能跨级别的调用，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Animal</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pets</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Pets</span>
</code></pre></div><p>这时 Dog 只能指定 Pets 中的方法，不能再指定 Animal 中的方法，除非显示继承了 Animal。</p>
<h2 id=指定默认参数值>指定默认参数值</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>protocol</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;http&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;timeout = %d, protocol = %s&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>protocol</span><span style=color:#ce5c00;font-weight:700>))</span> 
  <span style=color:#8f5902;font-style:italic>// more code here 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>()</span> 			<span style=color:#8f5902;font-style:italic>// 括号不能省略，除非方法定义中没有参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>如果方法有一个参数为默认，而其他参数并没有提供默认值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5000</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>protocol</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// error: not enough arguments for method makeConnection:
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
</code></pre></div><p>这时任何只提供一个参数值的调用都会报错，可以将定义中带有默认值的参数放在后面，然后就可以通过一个参数来调用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>protocol</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5000</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>makeConnection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=调用时提供参数名>调用时提供参数名</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>param1</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>value1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>param2</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>value2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>...)</span>
</code></pre></div><p>通过参数名提供参数时，参数顺序没有影响。</p>
<h2 id=方法返回值为元组>方法返回值为元组</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getStockInfo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#8f5902;font-style:italic>// other code here ... 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;NFLX&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>100.00</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// this is a Tuple3 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>symbol</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentPrice</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bidPrice</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>getStockInfo</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>symbol</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentPrice</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bidPrice</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>getStockInfo</span>
</code></pre></div><h2 id=无括号的访问器方法调用>无括号的访问器方法调用</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pizza</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#8f5902;font-style:italic>// no parentheses after crustSize 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>crustSize</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>12</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Pizza</span>
<span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>crustSize</span>
</code></pre></div><p>推荐的策略是在调用没有副作用的方法时使用无括号的方式调用。</p>
<p>在纯的函数式编程中不存在副作用，副作用包括：</p>
<ul>
<li>写入或打印输出</li>
<li>读取输入</li>
<li>修改作为输入的变量的状态</li>
<li>抛出异常，或错误发生时终止程序</li>
<li>调用其他有副作用的函数</li>
</ul>
<h2 id=接收多变量参数>接收多变量参数</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>strings</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String*</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>strings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>printAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;c&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>printAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>如果方法拥有多个参数，其中一个是多变量，则这个参数要放在参数列表的末端：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>strings</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String*</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=声明一个能够抛出异常的方法>声明一个能够抛出异常的方法</h2>
<p>如果想要声明一个方法，该方法可能会抛出异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#5c35cc;font-weight:700>@throws</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Exception</span><span style=color:#ce5c00;font-weight:700>])</span> 
<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>play</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// exception throwing code here ... 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#5c35cc;font-weight:700>@throws</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>IOException</span><span style=color:#ce5c00;font-weight:700>])</span> 
<span style=color:#5c35cc;font-weight:700>@throws</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>LineUnavailableException</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#5c35cc;font-weight:700>@throws</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>UnsupportedAudioFileException</span><span style=color:#ce5c00;font-weight:700>])</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>playSoundFileWithJavaAudio</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// exception throwing code here ... 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>作用是用于提醒调用者或者与 Java 集成。</p>
<h2 id=支持流式风格编程>支持流式风格编程</h2>
<p>如果想要支持调用者以流式方式调用，即方法链接，如下面的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>person</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Leonard&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Nimoy&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
		<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>82</span><span style=color:#ce5c00;font-weight:700>)</span> 
		<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setCity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Los Angeles&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
		<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setState</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;California&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>为了支持这种方式，需要遵循以下原则：</p>
<ul>
<li>如果你的类会被继承，指定<code>this.type</code>作为方法返回值类型</li>
<li>如果确定你的类不会被继承，你可以直接在方法中返回<code>this</code></li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>fname</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span> 
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>lname</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#000>fname</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>firstName</span> 
    <span style=color:#204a87;font-weight:700>this</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>lname</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lastName</span> 
    <span style=color:#204a87;font-weight:700>this</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Employee</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>role</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>setRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>role</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>this.</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>role</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>role</span>
    <span style=color:#204a87;font-weight:700>this</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#4e9a06>&#34;%s, %s, %s&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fname</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lname</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后我们就可以以流式的风格调用方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Main</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>employee</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Employee</span> 
  <span style=color:#8f5902;font-style:italic>// use the fluent methods 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>employee</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setFirstName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Al&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  			<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Alexander&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  			<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Developer&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>employee</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如上面的原则所述，如果确定这个类不会被继承，并不需要在 set* 类型的方法中指定<code>this.type</code>作为返回值类型，这种情况可以省略，只需要在方法中返回 this 的引用即可。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e7411240763838b4c92e7545eee27aec>1.24 - Class Object: 对象</h1>
<h2 id=介绍>介绍</h2>
<p>object 在 Scala 中有多种意义，可以和 Java 一样当做一个类的实例，但是 object 本身在 Scala 就是一个关键字。</p>
<h2 id=对象映射>对象映射</h2>
<p>如果需要将一个类的实例从一种类型映射为另一种类型，比如动态的创建对象。可以使用 asInstanceOf 来实现这种需求：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>recognizer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>cm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;recognizer&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>asInstanceOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Recognizer</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>类似于在 Java 中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Recognizer</span> <span style=color:#000>recognizer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Recognizer</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>cm</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lookup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;recognizer&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</code></pre></div><p>该方法定于与 Any 类因此所有对象可用。需要注意的是，这种转换可能会抛出 ClassCastException 异常。</p>
<h2 id=scala-中与-java-中-class-等效的部分>Scala 中与 Java 中 .class 等效的部分</h2>
<p>如果有些 API 需要传入一个 Class，在 Java 中调用了一个 .class，但是在 Scala 中却不能工作。在 Scala 中等效的方法是 classOf 方法，定义于 Predef 对象，因此所有的类可用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// java 
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>info</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataLine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TargetDataLine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
<span style=color:#8f5902;font-style:italic>// scala
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>info</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DataLine</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>TargetDataLine</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=测定对象的-class>测定对象的 Class</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>obj</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getClass</span>
</code></pre></div><h2 id=使用-object-启动应用>使用 Object 启动应用</h2>
<p>有两种方式启动一个应用，即作为一个程序的入口点：</p>
<ul>
<li>创建一个 object 并集成 App 特质</li>
<li>创建一个 object 并实现 main 方法</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Hello</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, world&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Hello2</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, world&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>两种方式中，Scala 都是以<code>objct</code>启动应用而不是一个类。</p>
<h2 id=创建单例对象>创建单例对象</h2>
<p>创建单例对象即确保只有该类一个实例存在。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CashRegister</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>open</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;opened&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>close</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;closed&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Main</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#000>CashRegister</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>open</span> 
  <span style=color:#000>CashRegister</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>CashRegister 会以单例的形式存在，类似 Java 中的静态方法。常用语创建功能性方法。</p>
<p>或者用于创建复用的消息对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>StartMessage</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>StopMessage</span>
<span style=color:#000>actorRef</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>StartMessage</span>
</code></pre></div><h2 id=使用伴生对象创建静态成员>使用伴生对象创建静态成员</h2>
<p>如果需要一个类拥有实例方法和静态方法，只需要在类中创建实例(非静态)方法，在伴生对象中创建静态方法。伴生对象即，以 object 关键字定义，与类名相同并与类处于相同源文件。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 类定义
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pizza</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>crustType</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Crust type is &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>crustType</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 伴生对象
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Pizza</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>CRUST_TYPE_THIN</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;thin&#34;</span> 
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>CRUST_TYPE_THICK</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;thick&#34;</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getFoo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Foo&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实现步骤：</p>
<ul>
<li>在同一源文件中定义类和 object，并且拥有相同的命名</li>
<li>静态成员定义在 obejct 中</li>
<li>非静态成员定义在类中</li>
</ul>
<p>类与伴生对象可以互相访问对方的私有成员。</p>
<h2 id=将通用代码放到包package对象>将通用代码放到包(package)对象</h2>
<p>如果需要创建包级别的函数、字段或其他代码，而不需要一个类或对象，只需要将代码以 package object 的形式，放到你期望可见的包中。</p>
<p>比如你想要<code>com.alvinalexander.myapp.model</code>能够访问你的代码，只需要在<code>com/alvinalexander/myapp/model</code>目录中创建一个<code>package.scala</code>文件并进行一下定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.alvinalexander.myapp</span>

<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>object</span> <span style=color:#000>model</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// code
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=不使用-new-关键字创建对象实例>不使用 new 关键字创建对象实例</h2>
<p>实现步骤：</p>
<ul>
<li>为类创建一个伴生对象，并以预期的构造器签名创建 apply 方法</li>
<li>直接将类创建为 case 类</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Person</span> <span style=color:#ce5c00;font-weight:700>{</span> 
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Person</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Person</span> 
    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>name</span> <span style=color:#000>p</span> 
  <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>可以为类创建不同的 apply 方法，类似类的辅助构造器。</p>
<h2 id=通过-apply-实现工厂方法>通过 apply 实现工厂方法</h2>
<p>为了让子类声明创建哪种类型的对象，或者把对象的创建集中在同一个位置管理，这时候需要实现一个工厂方法。</p>
<p>比如创建一个 Animal 工厂，根据你提供的需要创建 Dog 或 Cat 的实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Dog</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;woof&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cat</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Animal</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>speak</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;meow&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#8f5902;font-style:italic>// the factory method 
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Animal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;dog&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Dog</span> 
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cat</span> 
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cat</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;cat&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>dog</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Animal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dog&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-adc91192ebb2edc61dfb0014f5943d05>1.25 - 函数式对象</h1>
<blockquote>
<p>函数式对象，即不拥有任何可变状态的对象的类。</p>
</blockquote>
<h2 id=构建一个分数类>构建一个分数类</h2>
<p>比如我们要构建一个<strong>分数</strong>类，并最终能够实现下面的操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val <span style=color:#000>oneHalf</span> <span style=color:#ce5c00;font-weight:700>=</span> new Rational<span style=color:#ce5c00;font-weight:700>(</span>1, 2<span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic># oneHalf: Rational = 1/2 scala&gt; </span>
val <span style=color:#000>twoThirds</span> <span style=color:#ce5c00;font-weight:700>=</span> new Rational<span style=color:#ce5c00;font-weight:700>(</span>2, 3<span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic># twoThirds: Rational = 2/3 </span>
scala&gt; <span style=color:#ce5c00;font-weight:700>(</span>oneHalf / 7<span style=color:#ce5c00;font-weight:700>)</span> + <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> - twoThirds<span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#8f5902;font-style:italic># res0: Rational = 17/42</span>
</code></pre></div><h2 id=设计分数类>设计分数类</h2>
<p>设计一个分数类时需要考虑客户端会如何使用该类来创建实例。同时，我们把分数类的实例设计成不可变对象，并在创建实例时提供所有需要的参数，这里指 分数和分母。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=重新实现-tostring>重新实现 toString</h2>
<p>使用上面的类创建实例时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; new Rational<span style=color:#ce5c00;font-weight:700>(</span>1, 2<span style=color:#ce5c00;font-weight:700>)</span>
res0: <span style=color:#000>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> Rational@2591e0c9
</code></pre></div><p>默认情况下，一个类会继承<code>java.String.Object</code>中的<code>toString</code>实现。然而，为了更好的使用<code>toString</code>方法，比如日志、错误追踪等，我们需要实现一个更加详细的方法，比如包含该类的字段值。通过<code>override</code>来重写：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>d</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在就可以获得更详细的信息了：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; val <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> new Rational<span style=color:#ce5c00;font-weight:700>(</span>1, 3<span style=color:#ce5c00;font-weight:700>)</span> 
x: <span style=color:#000>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> 1/3
</code></pre></div><blockquote>
<p>这里需要注意的是，Java 中的类拥有构造器，并使用构造器来接收构造参数。在 Scala 中，类可以直接接收参数，称为类参数，这些类参数能够在类体中直接使用。</p>
<p>如果类参数使用 val 或 var 声明，它们同时成为类的可变或不可变字段，但是如果不适用任何 var 或 val，这些类参数不会成为类的成员，只能在类内部引用。也即本例中的使用方式。</p>
</blockquote>
<h2 id=检查前提条件>检查前提条件</h2>
<p>事实上，分数中分母是不能为 0 的，但是我们的主构造器中没有任何处理。如果使用了 0 作为分母，后续的处理中将会出现错误。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; new Rational<span style=color:#ce5c00;font-weight:700>(</span>5, 0<span style=color:#ce5c00;font-weight:700>)</span> 
res1: <span style=color:#000>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> 5/0
</code></pre></div><p>面向对象语言的一个优势就是可以讲数据封装到一个对象，因此可以在该对象整个生命周期中确保数据的状态。在一个不可变对象中，比如这里的<code>Rational</code>，要确保它的状态，就要求在一开始构造的时间对数据做充分的验证，因为一旦创建就不会再进行改变。因此我们可以通过<code>require</code>在其主构造器中定义一个<strong>前提条件</strong>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#000>require</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>d</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这时，如果在构造时传入一个 0 作为分母，<code>require</code>则会抛出一个<code>IllegalArgumentException</code>异常。</p>
<h2 id=加法操作>加法操作</h2>
<p>现在我们实现<code>Rational</code>的加法操作，实际也就是其字段的加法操作。因为它是一个不可变类，因此不能在一个<code>Rational</code>对象本身进行操作，而应该创建一个新的对象。</p>
<p>或许我们可以这样实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// This won&#39;t compile 
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>require</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> 
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>d</span> 
	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> 
		<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是当我们尝试编译时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&lt;console&gt;:11: error: value d is not a member of Rational 
			new Rational<span style=color:#ce5c00;font-weight:700>(</span>n * that.d + that.n * d, d * that.d<span style=color:#ce5c00;font-weight:700>)</span>
								  ^
</code></pre></div><p>尽管类参数 n 和 d 在<code>add</code>方法的作用域中，但是<code>add</code>方法只能访问调用对象自身的值。因此，<code>add</code>方法中，可以访问并使用 n 和 d 的值。但是却不能使用<code>that.n</code>和<code>that.d</code>，因为<code>that</code>并不是<code>add</code>方法的调用者，只是作为<code>add</code>方法的参数。如果想要使用<code>that</code>的类参数，需要将这些参数放在字段中，以支持使用实例来引用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  	<span style=color:#000>require</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> 
  	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>numer</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span>
  	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>denom</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>d</span>
	<span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>denom</span>
	<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> 
		<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span>
			<span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span><span style=color:#ce5c00;font-weight:700>,</span>
			<span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span>
		<span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同时需要注意的时，之前使用类参数的方式来构造对象，但是并不能在外部访问这些类参数，现在可以直接访问类的字段：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scala&gt; r.numer 	<span style=color:#8f5902;font-style:italic># res3: Int = 1</span>
scala&gt; r.denom 	<span style=color:#8f5902;font-style:italic># res4: Int = 2</span>
</code></pre></div><h2 id=自引用>自引用</h2>
<p>关键字<code>this</code>指向当前执行方法被调用的对象实例，或者如果使用在构造器内时，指正在被构建的对象实例。</p>
<p>比如添加一个<code>lessThan</code>方法，测试当前分数是否小于传入的参数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>lessThan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
	<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span>
</code></pre></div><p>这里的<code>this</code>指调用<code>lessThan</code>方法的实例对象，也可以省略不写。</p>
<p>再比如添加一个<code>max</code>方法，比较当前对象与传入参数那个更大，并返回大的那一个：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>max</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> 
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lessThan</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#000>that</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>this</span>
</code></pre></div><p>这里的<code>this</code>就不能省略了。</p>
<h2 id=辅助构造器>辅助构造器</h2>
<p>Scala 中朱构造器之外的构造器称为辅助构造器。比如创建一个分母为 1 的分数，可以实现为只需要提供一个分子，分母默认为 1:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#000>require</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>numer</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>n</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>denom</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>d</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 辅助构造器
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>....</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>辅助构造器的函数体这是对朱构造器的调用。Scala 中的每个辅助构造器都是调用当前类的其他构造器，可以是主构造器，也可以使已定义的其他辅助构造器。因此最终也都是对主构造器的调用，<strong>主构造器是类的唯一入口点</strong>。</p>
<blockquote>
<p>Java 中构造器能够调用同类的其他构造器或超类构造器。Scala 中只有主构造器可以调用超类构造器。</p>
</blockquote>
<h2 id=私有字段和方法>私有字段和方法</h2>
<p>分数 66/42 并不是最简化形式，简化过程就是求最大公约数的过程，比如我们定义一个私有字段 g 表示当前分数的最大公约数，定义一个私有方法 gcd 来求最大公约数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>g</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>gcd</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>abs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>abs</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>numer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>g</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>denum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>g</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>gcd</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>==</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>gcd</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 辗转相除
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=定义操作符>定义操作符</h2>
<p>使用 + 来作为求和的方法名，而不是 add。同时定义乘法操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  	<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span>
  	  <span style=color:#000>number</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>denom</span><span style=color:#ce5c00;font-weight:700>,</span>
  	  <span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span>
  	<span style=color:#ce5c00;font-weight:700>)</span>
  	
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>*(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  	<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>以操作符来组合调用时仍然会按照运算操作符的优先级进行。</p>
<h2 id=标识符>标识符</h2>
<p><strong>字母数字下划线标识符</strong>，以字母数字或下划线开始，后跟字母数字下划线。<code>$</code>同样被当做字符，但是被保留作为编译器生成的标识符，因此不做他用。</p>
<p>遵循<strong>驼峰命名</strong>，避免使用下划线，特别是结尾使用下划线。</p>
<p>常量使用大写并用下划线分割单词。</p>
<h2 id=方法重载>方法重载</h2>
<p>比如分数和整数不能直接做除法，需要首先将整数转换为分数，<code>r * new Rational(2)</code>，这样很不美观，因此可以创建新的方法来直接接受整数来进行乘法运算：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> 
	<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>numer</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>denom</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>denom</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Rational</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>numer</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>denom</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=隐式转换>隐式转换</h2>
<p>但是如果先要以<code>2 * r</code>的方式进行运算，但是整数并没有一个接受<code>Rational</code>实例作为参数的方法，因此我们可以定义一个隐式转换，将整数在需要的时候自动转换为一个分数实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>intToRational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Rational</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6f8b4696006dafd11c7961cf748604ea>1.26 - 整体类层级</h1>
<p>Scala 中，所有的类都继承自一个共同的超类，<code>Any</code>。因此所有定义在<code>Any</code>中的方法称为通用方法，任何对象都可以调用。并且在层级的最底层定义了<code>Null</code>和<code>Nothing</code>，作为所有类的子类。</p>
<h2 id=类层级>类层级</h2>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/Scala-hierarchy.jpg style=display:block;width:50% alt=NAME align=center> </div>
<p>可以看到，顶层类型为<code>Any</code>，下面分为两个大类，<code>AnyVal</code>包含了所有<strong>值类</strong>，<code>AnyRef</code>包含了所有<strong>引用类</strong>。</p>
<p><strong>值类</strong>共包含 9 种：Byte, Short, Char, Int, Long, Float, Double, Boolean, 和 Unit。前 8 中与 Java 中的原始类型一致，在运行时都变现为 Java 原始类型。<code>Unit</code>等价于 Java 中的<code>void</code>类型，表示一个方法并没有返回值，而它的值只有一个，写作<code>()</code>。</p>
<p><strong>引用类</strong>对应于 Java 中的<code>Object</code>，<code>AnyRef</code>只是<code>java.lang.Object</code>的别名，因此所有 Scala 或 Java 中编写的类都是<code>AnyRef</code>的子类。</p>
<p><code>Any</code>中定义了一下多个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>==(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> 
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>!=(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> 
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> 
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>##</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> 
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hashCode</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> 
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span>
</code></pre></div><p>因此所有对象都能够调用这些方法。</p>
<h2 id=原始类的实现方式>原始类的实现方式</h2>
<p>Scala 与 Java 以同样的方式存储整数：以 32 位数字存放。这对在 JVM 上的效率以及与 Java 库的互操作性都很重要。标准的操作如加减乘除都被实现为基本操作。</p>
<p>但是，当整数需要被当做 Java 对象看待时，比如在整数上调用<code>toString</code>或将整数赋值给<code>Any</code>类型的变量，这时，Scala 会使用“备份”类<code>java.lang.Integer</code>。需要的时候，<code>Int</code>类型的整数能被透明转换为<code>java.lang.Integer</code>类型的<strong>装箱整数</strong>。</p>
<p>比如一个 Java 程序：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span>		<span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>但是如果将参数类型改为<code>Integer</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Integer</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>isEqual</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>))</span>		<span style=color:#8f5902;font-style:italic>// false
</span></code></pre></div><p>在调用<code>isEqual</code>时，整数 1 会被<strong>自动装箱</strong>为<code>Integer</code>类型，而<code>Integer</code>为引用类型，<code>==</code>在比较引用类型时比较的是引用相等性，因此结果为<code>false</code>。</p>
<p>但是在 Scala 中，<code>==</code>被设计为<strong>对类型表达透明</strong>。对于值类来说，就是自然(数学)的相等。对于引用类型，<code>==</code>被视为继承自<code>Objct</code>的<code>equals</code>方法的别名。而这个<code>equals</code>方法最初始被定义为引用相等，但被许多子类重写实现为自然理念上(数据值)的相等。因此，在 Scala 中使用<code>==</code>来判断引用类型的相等仍然是有效的，不会落入 Java 中关于字符串比较的陷阱。</p>
<p>而如果真的需要进行引用相等的比较，可以直接使用<code>AnyRef</code>类的<code>eq</code>方法，它被实现为引用相等并且不能被重写。其反义比较，即引用不相等的比较，可以使用<code>ne</code>方法。</p>
<h2 id=底层类型>底层类型</h2>
<p>类层级的底部有两个类型，<code>scala.Null</code>和<code>scala.Nothing</code>。他们是用统一的方式来处理 Scala 面向对象类型系统的某些<strong>边界情况</strong>的特殊类型。</p>
<p><code>Null</code>类是<code>null</code>引用对象的类型，它是每个引用类的子类。<code>Null</code>不兼容值类型，比如把<code>null</code>赋值给值类型的变量。</p>
<p><code>Nothing</code>类型在 Scala 类层级的最底端，它是<strong>任何其他类型的子类型</strong>。并且该类型没有任何值，它的一个用处是标明一个不正常的终止，比如<code>scala.sys</code>中的<code>error</code>方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Nothing</span>
</code></pre></div><p>调用该方法始终会抛出异常。因为<code>error</code>方法的返回值是<code>Nothing</code>类型，我们可以简便的利用该方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>divide</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>y</span>
  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;can&#39;t divide by zero!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 返回 Nothing，是 Int 的子类型，兼容
</span></code></pre></div><p>另外，空的列表<code>Nil</code>被定义为<code>List[Nothing]</code>，因为<code>List[+A]</code>是协变的，这使得<code>Nil</code>可以是任何<code>List[T]</code>实例，<code>T</code>为任意类型。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f37f86d98f93453782b00741149e3fa5>1.27 - 组合继承</h1>
<p>类之间的两种关系：组合、继承。组合即持有另一个类的引用，借助被引用的类完成任务。继承是超类与子类的关系。</p>
<h2 id=实例二维布局库>实例：二维布局库</h2>
<p>目标是建立一个创建和渲染二维元素的库。每个元素都将显示一个由文字填充的矩形，称为 Element。提供一个工厂方法 elem 来通过传入的数据构建新元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span>
</code></pre></div><p>可以对元素调用 above 和 beside 方法并传入第二个元素，来获取一个将二者合并后生成的新元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>column1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>above</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;***&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cloumn2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;***&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>above</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;workd&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>获得的结果为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>hello</span> <span style=color:#ce5c00;font-weight:700>***</span> 
 <span style=color:#ce5c00;font-weight:700>***</span> <span style=color:#000>world</span>
</code></pre></div><p>above 和 beside 可以称为组合操作符，或连接符，它们把某些区域的元素组合成新的元素。</p>
<h2 id=抽象类>抽象类</h2>
<p>Element 代表布局元素类型，因为元素是二维的字符矩形，因此它包含一个 content 成员表示元素内容。内容有字符串数组表示，每个字符串代表一行：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=定义无参数方法>定义无参数方法</h2>
<p>需要向 Element 添加显示高度和宽度的方法，height 返回 contents 的行数，也就表示高度，width 返回第一行的长度，没有元素则返回 0。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>height</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>length</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这三个方法都是无参方法，甚至没有空的参数列表括号。</p>
<blockquote>
<p>如果方法中不需要参数，并且，方法只能通过读取所包含的对象的属性去访问可变状态(即方法本身不能改变可变状态)，就使用无参方法。</p>
<p>这一惯例支持<strong>统一访问原则</strong>，即客户端不应由属性是通过方法实现还是通过字段实现而受影响(访问字段与调用无参方法看上去没有差别)。</p>
<p>如果是直接或间接的使用了可变对象，应该使用空的括号，以此来说明该调用触发了计算。</p>
</blockquote>
<p>比如，可以直接将 height 方法和 width 方法改成字段实现的形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>height</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>length</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>客户端不会感觉到任何差别。唯一的区别是访问字段比调用方法略快，因为字段值在类初始化的时候被预计算，而方法调用在每次调用的时候都要计算。同时，使用字段需要为每个 Element 对象分配更多的存储空间。</p>
<p>如果需要将字段改写为方法时，方法是由<strong>纯函数</strong>构成，即没有副作用也没有可变状态，那么客户端代码就不需要做出改变。</p>
<h2 id=扩展类>扩展类</h2>
<p>为了穿件 Element 对象，我们需要实现一个子类扩展抽象类 Element 并实现其抽象方法 contents。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conts</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>conts</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>关键字 extends 的作用：使 ArrayElement 类继承了 Element 的所有非私有成员，并成为其子类。</p>
<h2 id=重写方法和字段>重写方法和字段</h2>
<p>Scala 中的字段和方法属于相同的命名空间。字段可以重写无参数方法。比如父类中的 contents 是一个无参方法，可以在子类中重写为一个字段而不需要修改父类中的定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>conts</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>conts</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同时，禁止在一个类中使用相同的名称定义方法和字段。这在 Java 中是支持的，因为 Java 提供了四个命名空间：字段、方法、类型、包。但是 Scala 中仅提供两个命名空间：</p>
<ul>
<li>值（字段、方法）</li>
<li>类型（类、特质名）</li>
</ul>
<h2 id=定义参数化字段>定义参数化字段</h2>
<p>上面 ArrayElement 类的构造器参数 conts 的实际作用是将值复制给 contents 字段，这里存在了冗余，因为 conts 实际上就是 contents，只是取了一个与 contents 类似的变量名以作区分，实际上可以使用参数化字段，而不需要再进行多余的传递：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Element</span>
</code></pre></div><p>构造器中的 val，是同时定义同名的参数和字段的简写方式，同时，这个 contents 被定义为一个不可变字段，并且使用参数初始化。如果使用 var 来定义，则该字段是一个可变字段。</p>
<p>对于这样参数化的字段，同样可以进行重写，同时也能使用可见性修饰符：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cat</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>dangerous</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Tiger</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>dangerous</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Boolean</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cat</span>
</code></pre></div><p>这个例子中，子类 Tiger 通过参数化字段的方式重写了父类中的字段 dangerous，同时定义了一个私有字段 age。或者以更完整的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Tiger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>param1</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Boolean</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>param2</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Cat</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>dangerous</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pararm1</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>age</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>param2</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这两个 Tiger 的实现是等效的。</p>
<h2 id=调用超类构造器>调用超类构造器</h2>
<p>现在系统中已经有了两个类：Element 和 ArrayElement。如果客户想要创造由单行字符串构成的布局元素，我们可以实现一个子类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LineElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>width</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>height</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>因为子类 LineElement 要继承 ArrayElement，但是 ArrayElement 有一个参数，这时 LineElement 需要给超类的构造器传递一个参数。</p>
<p><strong>需要调用超类的构造器，只需要把要传递的参数列表放在超类之后的括号里即可。</strong></p>
<h2 id=使用-override-修饰符>使用 override 修饰符</h2>
<p>如果子类成员重写父类具体成员，则必须使用 override 修饰符；如果父类中是抽象成员时，可以省略；如果子类未重写或实现基类中的成员，则禁用该修饰符。</p>
<p>常用习惯是，重写或实现父类成员时均使用该修饰符。</p>
<h2 id=多态和动态绑定>多态和动态绑定</h2>
<p>前面的例子中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>elem</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;world&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>这样将一个子类的实例赋值给一个父类的变量应用，称为<strong>多态</strong>。这种情况下，Element 可以有多种形式，现在已经定义的有 ArrayElement 和 LineElement，可以通过继承 Element 来实现更多的形式。比如，下面定义一个拥有给定长度和高度并通过提供的字符进行填充的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UniformElement</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>ch</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Char</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>width</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>make</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>height</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在，Element 类型的变量可以接受多种子类的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>e1</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;world&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ae</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ArrayElement</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LineElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>e2</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ae</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>e3</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UniformmElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;x&#39;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>另一方面，变量和表达式上的方法调用是动态绑定的。被调用的实际方法取决于运行期对象基于的类，而不是变量或表达式的类型。</p>
<h2 id=定义-final-成员>定义 final 成员</h2>
<p>有时需要确保一个成员不会被子类重写，这时可以使用 final 修饰符限定。</p>
<p>或者有时候需要确保整个类都不会有子类，也可以在类的声明上添加 final 修饰符。</p>
<h2 id=使用组合与继承>使用组合与继承</h2>
<p>组合与继承是使用其他现存类定义新类的两种方法。如果追求的是根本上的代码重用，通常推荐采用组合而不是继承。组合可以避免脆基类的问题，因为在修改基类时会在无意中破换子类。</p>
<p>在使用继承时需要确定，是否建模了一种 “is-a” 的关系，同时，客户端是否想把子类型当做超类来用。</p>
<h2 id=实现-abovebesidetostring>实现 above、beside、toString</h2>
<p>在 Element 中实现 above 方法，将一个元素放在另一个上面：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>above</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>实现 beside 方法，把两个元素靠在一起生成一个新元素，新元素的每一行都来自原始元素的相应行的串联(这里先假设两个元素的长度相同)：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>beside</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>contents</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000>until</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
  	<span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者以更简洁的方式实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>beside</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>line2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span> <span style=color:#000>zip</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span>
  <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>yiied</span> <span style=color:#000>line1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>line2</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>然后实现一个 toString 方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\n&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>最后的 Element 实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>height</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>length</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>above</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>beside</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>line2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span> <span style=color:#000>zip</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span>
    <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>yiied</span> <span style=color:#000>line1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>line2</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\n&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=定义工厂对象>定义工厂对象</h2>
<p>现在已经拥有了布局元素的类层级，可以将这些层级直接暴露给用户使用，或者可以把这些层级隐藏在工厂对象之后，在工厂对象中包含构建其他对象等方法，客户使用这些工厂方法构建对象而不是直接使用 new 关键字和各层级类来构建对象。</p>
<p>比如在伴生对象中提供工厂方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chr</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Char</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UniformElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chr</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>wirdh</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>height</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LineElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>为了能够直接使用 elem 方法而不是 Element.elem，可以直接在 Element 定义文件的头部显示引入该方法，然后对 Element 的实现进行简化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Element.elem</span>

<span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>height</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>length</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>above</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>beside</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>that</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>line2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span> <span style=color:#000>zip</span> <span style=color:#000>that</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contents</span>
    <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>yiied</span> <span style=color:#000>line1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>line2</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mkString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;\n&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>既然有了工厂方法，所有的子类都可以为私有类，引文他们不再需要直接被客户端使用。可以在类和单例对象的内部定义其他的类和单例对象，因此，可以将 Element 的子类放在其单例对象中实现这些子类的私有化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Element</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>LineElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>contents</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>width</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>height</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UniformElement</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#000>ch</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Char</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Element</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ch</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>width</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>contents</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>make</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>height</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>contents</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chr</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Char</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UniformElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chr</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>width</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>height</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>elem</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Element</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>LineElement</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-cafe4d5e20e13ac5803d9c55dde63b23>1.28 - Package</h1>
<h2 id=介绍>介绍</h2>
<p>Scala 中会自动导入两个包：</p>
<ul>
<li>java.lang._</li>
<li>scala._</li>
</ul>
<p>这其中，包括 scala.Predef，预定义了一些常用的功能。</p>
<h2 id=以大括号的方式定义包>以大括号的方式定义包</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.acme.store</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;I am com.acme.store.Foo&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// 等同于
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>com.acme.store</span> 
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toString</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;I am com.acme.store.Foo&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用这种大括号的方式可以在一个文件内定义多个包，或者嵌套的包。</p>
<h2 id=引入一个或多个成员>引入一个或多个成员</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.File</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>File</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>FileNotFoundException</span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.io._</span>
</code></pre></div><ul>
<li>可以在任意位置引入成员，类中、对象中、方法或代码块中</li>
<li>可以引入任意成员，类、包、对象</li>
<li>可以隐藏或重命名引入的成员</li>
</ul>
<p>最佳实践时：除非需要引入的对象超过3个，则一般不适用通配符引入，避免不必要的冲突。</p>
<h2 id=重命名引入的成员>重命名引入的成员</h2>
<p>有时候引入的成员会和当前作用域中的成员名冲突，或者需要一个更有意义的名字，这时候可以将引入的成员重命名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>ArrayList</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>JavaList</span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>Date</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>JDate</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HashMap</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>JHashMap</span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是重命名之后，就不能再使用原有的成员名了。</p>
<h2 id=引入时隐藏部分成员>引入时隐藏部分成员</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>Random</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个语法会引入除 Random 之外的所有包，仅仅是把 Random 隐藏了。</p>
<p>或者同时隐藏多个成员，只引入剩余的其他成员：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>List</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Map</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Set</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=使用静态引入>使用静态引入</h2>
<p>如果想要以 Java 静态引入的方式引入一个成员，以便能够直接引用成员的名字：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang.Math._</span>
</code></pre></div><p>然后就可以使用 Math 中的所有成员，<code>sin(0)、cos(PI)</code>，而不再需要以<code>Match.sin(0)</code>的方式使用。</p>
<h2 id=在任何地方引入>在任何地方引入</h2>
<p>唯一需要注意的是，引入语句的位置必须处于使用的位置之前，否则会找不到使用的对象。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-0230559def7455f0a12db47614a430fb>1.29 - SBT</h1>
<h2 id=子项目构建>子项目构建</h2>
<h3 id=基本配置文件>基本配置文件</h3>
<p>首先编辑<code>project</code>目录下的<code>build.properties</code>和<code>plugins.sbt</code>文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// project/build.properties
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>sbt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>version</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.13</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>11</span>

<span style=color:#8f5902;font-style:italic>// project/plugins.sbt
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>logLevel</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Level</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Warn</span>
<span style=color:#000>addSbtPlugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.eed3si9n&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;sbt-assembly&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;0.14.2&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>addSbtPlugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.typesafe.sbt&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;sbt-native-packager&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;1.0.0&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>addSbtPlugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.typesafe.sbt&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;sbt-scalariform&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;1.3.0&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>addSbtPlugin</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com.typesafe.play&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;sbt-plugin&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;2.5.1&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=项目通用配置>项目通用配置</h3>
<p>项目配置相关的文件均位于<code>project/</code>路径，创建新的<code>CommonSettings.scala</code>，别写整个项目的基本配置，包括代码风格配置、依赖仓库配置、依赖冲突配置等：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sbt._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Keys._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sbtassembly.AssemblyPlugin.autoImport._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sbtassembly.PathList</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>com.typesafe.sbt.SbtScalariform.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>ScalariformKeys</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>scalariformSettings</span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scalariform.formatter.preferences._</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CommonSettings</span> <span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#8f5902;font-style:italic>// 代码风格配置 
</span><span style=color:#8f5902;font-style:italic></span>  	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>customeScalariformSettings</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ScalariformKeys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>preferences</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ScalariformKeys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>preferences</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span>
    	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setPreference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AlignSingleLineCaseStatements</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
    	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setPreference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AlignSingleLineCaseStatements</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MaxArrowIndent</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>200</span><span style=color:#ce5c00;font-weight:700>)</span>
    	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setPreference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AlignParameters</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
    	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setPreference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DoubleIndentClassDeclaration</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
    	<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>setPreference</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PreserveDanglingCloseParenthesis</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#8f5902;font-style:italic>// 基本配置与仓库
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>settings</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Def.Setting</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>scalariformSettings</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>customeScalariformSettings</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span>
      <span style=color:#000>organization</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.promisehook.bdp&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>scalaVersion</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2.11.8&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>scalacOptions</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;-feature&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-unchecked&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-deprecation&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-encoding&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;utf8&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
      <span style=color:#000>updateOptions</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>updateOptions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>withCachedResolution</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>),</span>
      <span style=color:#000>fork</span> <span style=color:#000>in</span> <span style=color:#000>run</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>test</span> <span style=color:#000>in</span> <span style=color:#000>assembly</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{},</span>
      <span style=color:#000>resolvers</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>Opts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>resolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mavenLocalFile</span><span style=color:#ce5c00;font-weight:700>,</span>
      <span style=color:#000>resolvers</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span>
        <span style=color:#000>DefaultMavenRepository</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Resolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>defaultLocal</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Resolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mavenLocal</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Resolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>jcenterRepo</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#000>Classpaths</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sbtPluginReleases</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;scalaz-bintray&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;http://dl.bintray.com/scalaz/releases&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;Atlassian Releases&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;https://maven.atlassian.com/public/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;Apache Staging&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;https://repository.apache.org/content/repositories/staging/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;Typesafe repository&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;https://dl.bintray.com/typesafe/maven-releases/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;Sonatype OSS Snapshots&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;https://oss.sonatype.org/content/repositories/snapshots&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;Java.net Maven2 Repository&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;http://download.java.net/maven/2/&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;softprops-maven&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;http://dl.bintray.com/content/softprops/maven&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;OpenIMAJ maven releases repository&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;http://maven.openimaj.org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;Sonatype OSS Snapshots&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;https://oss.sonatype.org/content/repositories/snapshots&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;Eclipse repositories&#34;</span> <span style=color:#000>at</span> <span style=color:#4e9a06>&#34;https://repo.eclipse.org/service/local/repositories/egit-releases/content/&#34;</span>
      <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#8f5902;font-style:italic>// 依赖冲突合并配置
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>commonAssemblyMergeStrategy</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>assemblyMergeStrategy</span> <span style=color:#000>in</span> <span style=color:#000>assembly</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;ansj&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>                   <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;joda&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>                   <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;apache&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>                 <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;nlpcn&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>                  <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;w3c&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>                    <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>                    <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;javax&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;xml&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>                  <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;edu&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;stanford&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>               <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;cyberneko&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>              <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;xmlpull&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>              <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;objenesis&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>              <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;com&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;esotericsoftware&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>        <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ps</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>last</span> <span style=color:#000>endsWith</span> <span style=color:#4e9a06>&#34;.dic&#34;</span>       <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>PathList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ps</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ps</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>last</span> <span style=color:#000>endsWith</span> <span style=color:#4e9a06>&#34;.data&#34;</span>      <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>MergeStrategy</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>first</span>
      <span style=color:#8f5902;font-style:italic>//  case &#34;application.conf&#34;                             =&gt; MergeStrategy.concat
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>//  case &#34;unwanted.txt&#34;                                 =&gt; MergeStrategy.discard
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>oldStrategy</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>assemblyMergeStrategy</span> <span style=color:#000>in</span> <span style=color:#000>assembly</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>value</span>
        <span style=color:#000>oldStrategy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=子项目依赖配置>子项目依赖配置</h3>
<p>为各个子项目编写不同的依赖配置：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// project/CommonDependencies.scala
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CommonDependencies</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>specsVersion</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;3.6.6&#34;</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>specs</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span>
    <span style=color:#4e9a06>&#34;specs2-core&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;specs2-junit&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;specs2-mock&#34;</span><span style=color:#ce5c00;font-weight:700>).</span>
    <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.specs2&#34;</span> <span style=color:#ce5c00;font-weight:700>%%</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>specsVersion</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>Test</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>jodaTime</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;joda-time&#34;</span>  <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;joda-time&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;2.8.2&#34;</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>PlayJson</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;com.typesafe.play&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;play-json_2.11&#34;</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#4e9a06>&#34;2.5.2&#34;</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>commonDependencies</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ModuleID</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>specs</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>jodaTime</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>PlayJson</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=编写主配置文件>编写主配置文件</h3>
<p>编写<code>build.sbt</code>文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Root-Project-Name&#34;</span>

<span style=color:#000>version</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;1.0&#34;</span>

<span style=color:#000>scalaVersion</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2.11.8&#34;</span>

<span style=color:#204a87;font-weight:700>lazy</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>common</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>project</span><span style=color:#ce5c00;font-weight:700>.</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Commons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>libraryDependencies</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Dependencies</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>databaseDependencies</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>libraryDependencies</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Dependencies</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>commonDependencies</span><span style=color:#ce5c00;font-weight:700>)</span>
  
<span style=color:#204a87;font-weight:700>lazy</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>webserver</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>project</span><span style=color:#ce5c00;font-weight:700>.</span>
  <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>common</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Commons</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>libraryDependencies</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>specs2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>filters</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>evolutions</span><span style=color:#ce5c00;font-weight:700>)).</span>	<span style=color:#8f5902;font-style:italic>// Play插件
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>libraryDependencies</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Dependencies</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>akkaDependencies</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>libraryDependencies</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Dependencies</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>playDependencies</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>enablePlugins</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PlayScala</span><span style=color:#ce5c00;font-weight:700>)</span>
  
<span style=color:#204a87;font-weight:700>lazy</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>proserver</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>project</span><span style=color:#ce5c00;font-weight:700>.</span>
  <span style=color:#000>dependsOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>common</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommonSettings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>settings</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>libraryDependencies</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Dependencies</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>akkaDependencies</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>libraryDependencies</span> <span style=color:#ce5c00;font-weight:700>++=</span> <span style=color:#000>Dependencies</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>processDependencies</span><span style=color:#ce5c00;font-weight:700>).</span>
  <span style=color:#000>settings</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CommonSettings</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>commonAssemblyMergeStrategy</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 合并依赖冲突
</span></code></pre></div><p>此时，在主项目路径运行<code>sbt -> compile</code>即可生成子项目目录，同样，可以在各个子项目的目录中添加需要的配置。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7a328cc92d05933f3ef0838049d45196>1.30 - Predef</h1>
<p><strong>Predef 提供了一些定义，可以在所有 Scala 的编译单元中可见且不需要明确的限制。在所有的 Scala 代码中自动引入。</strong></p>
<h2 id=最常用的类型>最常用的类型</h2>
<p>提供了一些最常用类型的类型别名(alias)。比如一些不可变集合及其构造器。</p>
<h2 id=控制台-io>控制台 I/O</h2>
<p>提供了一些用于控制台 I/O 的函数，比如：<code>print</code>、<code>println</code>等。这些函数都是<code>scala.Console</code>中提供的函数的别名。</p>
<h2 id=断言>断言</h2>
<p>一组<code>assert</code>函数用于注释和动态检查代码中的常量。</p>
<blockquote>
<p>在命令行中添加参数<code>-Xdisable-assertions</code>可以完成编译器的<code>assert</code>调用。</p>
</blockquote>
<h2 id=隐式转换>隐式转换</h2>
<p>这里和其父类型<code>scala.LowPriorityImplicits</code>提供了一组最常用的隐式转换。为一些类型提供了一些扩展功能。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-20fbb4b0e917ad89a8e46dd0068bc15e>1.31 - I/O</h1>
<p><a href="http://colobu.com/2016/05/11/better-files-Simple-safe-and-intuitive-Scala-I-O/?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io">原文链接：更好的Scala I/O: better-files</a></p>
<h2 id=添加依赖>添加依赖</h2>
<pre><code>libraryDependencies += &quot;com.github.pathikrit&quot; %% &quot;better-files&quot; % version
</code></pre>
<h2 id=实例化>实例化</h2>
<pre><code>import better.files._
import java.io.{File =&gt; JFile}
val f = File(&quot;/User/johndoe/Documents&quot;)                      // using constructor
val f1: File = file&quot;/User/johndoe/Documents&quot;                 // using string interpolator
val f2: File = &quot;/User/johndoe/Documents&quot;.toFile              // convert a string path to a file
val f3: File = new JFile(&quot;/User/johndoe/Documents&quot;).toScala  // convert a Java file to Scala
val f4: File = root/&quot;User&quot;/&quot;johndoe&quot;/&quot;Documents&quot;             // using root helper to start from root
val f5: File = `~` / &quot;Documents&quot;                             // also equivalent to `home / &quot;Documents&quot;`
val f6: File = &quot;/User&quot;/&quot;johndoe&quot;/&quot;Documents&quot;                 // using file separator DSL
val f7: File = home/&quot;Documents&quot;/&quot;presentations&quot;/`..`         // Use `..` to navigate up to parent
</code></pre>
<h2 id=文件读写>文件读写</h2>
<pre><code>val file = root/&quot;tmp&quot;/&quot;test.txt&quot;
file.overwrite(&quot;hello&quot;)
file.appendLine().append(&quot;world&quot;)
assert(file.contentAsString == &quot;hello\nworld&quot;)
</code></pre>
<p>或者类似 Shell 风格：</p>
<pre><code>file &lt; &quot;hello&quot;     // same as file.overwrite(&quot;hello&quot;)
file &lt;&lt; &quot;world&quot;    // same as file.appendLines(&quot;world&quot;)
assert(file! == &quot;hello\nworld&quot;)
</code></pre>
<p>或者：</p>
<pre><code>&quot;hello&quot; `&gt;:` file
&quot;world&quot; &gt;&gt;: file
val bytes: Array[Byte] = file.loadBytes
</code></pre>
<p>流式接口风格：</p>
<pre><code>(root/&quot;tmp&quot;/&quot;diary.txt&quot;)
 .createIfNotExists()  
 .appendLine()
 .appendLines(&quot;My name is&quot;, &quot;Inigo Montoya&quot;)
 .moveTo(home/&quot;Documents&quot;)
 .renameTo(&quot;princess_diary.txt&quot;)
 .changeExtensionTo(&quot;.md&quot;)
 .lines
</code></pre>
<h2 id=stream和编码>Stream和编码</h2>
<p>生成迭代器：</p>
<pre><code>val bytes  : Iterator[Byte]            = file.bytes
val chars  : Iterator[Char]            = file.chars
val lines  : Iterator[String]          = file.lines
val source : scala.io.BufferedSource   = file.newBufferedSource // needs to be closed, unlike the above APIs which auto closes when iterator ends
</code></pre>
<p>编解码：</p>
<pre><code>val content: String = file.contentAsString  // default codec
// custom codec:
import scala.io.Codec
file.contentAsString(Codec.ISO8859)
//or
import scala.io.Codec.string2codec
file.write(&quot;hello world&quot;)(codec = &quot;US-ASCII&quot;)
</code></pre>
<h2 id=与java交互>与Java交互</h2>
<p>转换成Java对象：</p>
<pre><code>val file: File = tmp / &quot;hello.txt&quot;
val javaFile     : java.io.File                 = file.toJava
val uri          : java.net.uri                 = file.uri
val reader       : java.io.BufferedReader       = file.newBufferedReader 
val outputstream : java.io.OutputStream         = file.newOutputStream 
val writer       : java.io.BufferedWriter       = file.newBufferedWriter 
val inputstream  : java.io.InputStream          = file.newInputStream
val path         : java.nio.file.Path           = file.path
val fs           : java.nio.file.FileSystem     = file.fileSystem
val channel      : java.nio.channel.FileChannel = file.newFileChannel
val ram          : java.io.RandomAccessFile     = file.newRandomAccess
val fr           : java.io.FileReader           = file.newFileReader
val fw           : java.io.FileWriter           = file.newFileWriter(append = true)
val printer      : java.io.PrintWriter          = file.newPrintWriter
</code></pre>
<p>以及：</p>
<pre><code>file1.reader &gt; file2.writer       // pipes a reader to a writer
System.in &gt; file2.out             // pipes an inputstream to an outputstream
src.pipeTo(sink)                  // if you don't like symbols
val bytes   : Iterator[Byte]        = inputstream.bytes
val bis     : BufferedInputStream   = inputstream.buffered  
val bos     : BufferedOutputStream  = outputstream.buffered   
val reader  : InputStreamReader     = inputstream.reader
val writer  : OutputStreamWriter    = outputstream.writer
val printer : PrintWriter           = outputstream.printWriter
val br      : BufferedReader        = reader.buffered
val bw      : BufferedWriter        = writer.buffered
val mm      : MappedByteBuffer      = fileChannel.toMappedByteBuffer
</code></pre>
<h2 id=模式匹配>模式匹配</h2>
<pre><code>/**
 * @return true if file is a directory with no children or a file with no contents
 */
def isEmpty(file: File): Boolean = file match {
  case File.Type.SymbolicLink(to) =&gt; isEmpty(to)  // this must be first case statement if you want to handle symlinks specially; else will follow link
  case File.Type.Directory(files) =&gt; files.isEmpty
  case File.Type.RegularFile(content) =&gt; content.isEmpty
  case _ =&gt; file.notExists    // a file may not be one of the above e.g. UNIX pipes, sockets, devices etc
}
// or as extractors on LHS:
val File.Type.Directory(researchDocs) = home/&quot;Downloads&quot;/&quot;research&quot;
</code></pre>
<h2 id=通配符>通配符</h2>
<pre><code>val dir = &quot;src&quot;/&quot;test&quot;
val matches: Iterator[File] = dir.glob(&quot;**/*.{java,scala}&quot;)
// above code is equivalent to:
dir.listRecursively.filter(f =&gt; f.extension == Some(&quot;.java&quot;) || f.extension == Some(&quot;.scala&quot;))
</code></pre>
<p>或者使用正则表达式：</p>
<pre><code>val matches = dir.glob(&quot;^\\w*$&quot;)(syntax = File.PathMatcherSyntax.regex
</code></pre>
<h2 id=文件系统操作>文件系统操作</h2>
<pre><code>file.touch()
file.delete()     // unlike the Java API, also works on directories as expected (deletes children recursively)
file.clear()      // If directory, deletes all children; if file clears contents
file.renameTo(newName: String)
file.moveTo(destination)
file.copyTo(destination)       // unlike the default API, also works on directories (copies recursively)
file.linkTo(destination)                     // ln file destination
file.symbolicLinkTo(destination)             // ln -s file destination
file.{checksum, md5, sha1, sha256, sha512, digest}   // also works for directories
file.setOwner(user: String)    // chown user file
file.setGroup(group: String)   // chgrp group file
Seq(file1, file2) &gt;: file3     // same as cat file1 file2 &gt; file3
Seq(file1, file2) &gt;&gt;: file3    // same as cat file1 file2 &gt;&gt; file3
file.isReadLocked / file.isWriteLocked / file.isLocked
File.newTemporaryDirectory() / File.newTemporaryFile() // create temp dir/file
</code></pre>
<h2 id=unix-dsl>UNIX DSL</h2>
<p>提供了UNIX风格的操作：</p>
<pre><code>import better.files_, Cmds._   // must import Cmds._ to bring in these utils
pwd / cwd     // current dir
cp(file1, file2)
mv(file1, file2)
rm(file) /*or*/ del(file)
ls(file) /*or*/ dir(file)
ln(file1, file2)     // hard link
ln_s(file1, file2)   // soft link
cat(file1)
cat(file1) &gt;&gt;: file
touch(file)
mkdir(file)
mkdirs(file)         // mkdir -p
chown(owner, file)
chgrp(owner, file)
chmod_+(permission, files)  // add permission
chmod_-(permission, files)  // remove permission
md5(file) / sha1(file) / sha256(file) / sha512(file)
unzip(zipFile)(targetDir)
zip(file*)(zipFile)
</code></pre>
<h2 id=文件属性>文件属性</h2>
<pre><code>file.name       // simpler than java.io.File#getName
file.extension
file.contentType
file.lastModifiedTime     // returns JSR-310 time
file.owner / file.group
file.isDirectory / file.isSymbolicLink / file.isRegularFile
file.isHidden
file.hide() / file.unhide()
file.isOwnerExecutable / file.isGroupReadable // etc. see file.permissions
file.size                 // for a directory, computes the directory size
file.posixAttributes / file.dosAttributes  // see file.attributes
file.isEmpty      // true if file has no content (or no children if directory) or does not exist
file.isParentOf / file.isChildOf / file.isSiblingOf / file.siblings
</code></pre>
<p><code>chmod</code>操作：</p>
<pre><code>import java.nio.file.attribute.PosixFilePermission
file.addPermission(PosixFilePermission.OWNER_EXECUTE)      // chmod +X file
file.removePermission(PosixFilePermission.OWNER_WRITE)     // chmod -w file
assert(file.permissionsAsString == &quot;rw-r--r--&quot;)
// The following are all equivalent:
assert(file.permissions contains PosixFilePermission.OWNER_EXECUTE)
assert(file(PosixFilePermission.OWNER_EXECUTE))
assert(file.isOwnerExecutable)
</code></pre>
<h2 id=文件比较>文件比较</h2>
<pre><code>file1 == file2    // equivalent to `file1.isSamePathAs(file2)`
file1 === file2   // equivalent to `file1.isSameContentAs(file2)` (works for regular-files and directories)
file1 != file2    // equivalent to `!file1.isSamePathAs(file2)`
file1 =!= file2   // equivalent to `!file1.isSameContentAs(file2)`
</code></pre>
<p>排序操作：</p>
<pre><code>val files = myDir.list.toSeq
files.sorted(File.Order.byName) 
files.max(File.Order.bySize) 
files.min(File.Order.byDepth) 
files.max(File.Order.byModificationTime) 
files.sorted(File.Order.byDirectoriesFirst)
</code></pre>
<h2 id=解压缩>解压缩</h2>
<p>// Unzipping:
val zipFile: File = file"path/to/research.zip"
val research: File = zipFile.unzipTo(destination = home/&ldquo;Documents&rdquo;/&ldquo;research&rdquo;)
// Zipping:
val zipFile: File = directory.zipTo(destination = home/&ldquo;Desktop&rdquo;/&ldquo;toEmail.zip&rdquo;)
// Zipping/Unzipping to temporary files/directories:
val someTempZipFile: File = directory.zip()
val someTempDir: File = zipFile.unzip()
assert(directory === someTempDir)
// Gzip handling:
File(&ldquo;countries.gz&rdquo;).newInputStream.gzipped.lines.take(10).foreach(println)</p>
<h2 id=轻量级的arm-自动化的资源管理>轻量级的ARM (自动化的资源管理)</h2>
<p>Auto-close Java closeables:</p>
<pre><code>for {
  in &lt;- file1.newInputStream.autoClosed
  out &lt;- file2.newOutputStream.autoClosed
} in.pipeTo(out)
</code></pre>
<p><code>better-files</code>提供了更加便利的管理，因此下面的代码：</p>
<pre><code>for {
 reader &lt;- file.newBufferedReader.autoClosed
} foo(reader)
</code></pre>
<p>可以改写为：</p>
<pre><code>for {
 reader &lt;- file.bufferedReader    // returns ManagedResource[BufferedReader]
} foo(reader)
// or simply:
file.bufferedReader.map(foo)
</code></pre>
<h2 id=scanner>Scanner</h2>
<pre><code>val data = t1 &lt;&lt; s&quot;&quot;&quot;
  | Hello World
  | 1 true 2 3
&quot;&quot;&quot;.stripMargin
val scanner: Scanner = data.newScanner()
assert(scanner.next[String] == &quot;Hello&quot;)
assert(scanner.lineNumber == 1)
assert(scanner.next[String] == &quot;World&quot;)
assert(scanner.next[(Int, Boolean)] == (1, true))
assert(scanner.tillEndOfLine() == &quot; 2 3&quot;)
assert(!scanner.hasNext)
</code></pre>
<p>或者可以写定制的Scanner。</p>
<h2 id=文件监控>文件监控</h2>
<p>普通的Java文件监控：</p>
<pre><code>import java.nio.file.{StandardWatchEventKinds =&gt; EventType}
val service: java.nio.file.WatchService = myDir.newWatchService
myDir.register(service, events = Seq(EventType.ENTRY_CREATE, EventType.ENTRY_DELETE))
</code></pre>
<p><code>better-files</code>抽象了一个更加简单的接口：</p>
<pre><code>val watcher = new ThreadBackedFileMonitor(myDir, recursive = true) {
  override def onCreate(file: File) = println(s&quot;$file got created&quot;)
  override def onModify(file: File) = println(s&quot;$file got modified&quot;)
  override def onDelete(file: File) = println(s&quot;$file got deleted&quot;)
}
watcher.start()
</code></pre>
<p>或者使用下面的写法：</p>
<pre><code>import java.nio.file.{Path, StandardWatchEventKinds =&gt; EventType, WatchEvent}
val watcher = new ThreadBackedFileMonitor(myDir, recursive = true) {
  override def dispatch(eventType: WatchEvent.Kind[Path], file: File) = eventType match {
    case EventType.ENTRY_CREATE =&gt; println(s&quot;$file got created&quot;)
    case EventType.ENTRY_MODIFY =&gt; println(s&quot;$file got modified&quot;)
    case EventType.ENTRY_DELETE =&gt; println(s&quot;$file got deleted&quot;)
  }
}
</code></pre>
<h2 id=使用akka进行文件监控>使用Akka进行文件监控</h2>
<pre><code>import akka.actor.{ActorRef, ActorSystem}
import better.files._, FileWatcher._
implicit val system = ActorSystem(&quot;mySystem&quot;)
val watcher: ActorRef = (home/&quot;Downloads&quot;).newWatcher(recursive = true)
// register partial function for an event
watcher ! on(EventType.ENTRY_DELETE) {    
  case file if file.isDirectory =&gt; println(s&quot;$file got deleted&quot;) 
}
// watch for multiple events
watcher ! when(events = EventType.ENTRY_CREATE, EventType.ENTRY_MODIFY) {   
  case (EventType.ENTRY_CREATE, file) =&gt; println(s&quot;$file got created&quot;)
  case (EventType.ENTRY_MODIFY, file) =&gt; println(s&quot;$file got modified&quot;)
}
</code></pre>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-9d9b1281f5e793e8918b82d36ca1bb04>1.32 - 保留字</h1>
<h2 id=关键字和保留字符>关键字和保留字符</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 关键字符
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>&lt;-</span>			<span style=color:#8f5902;font-style:italic>// 用于 for 表达式，从生成器(generator)中分离元素
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>=&gt;</span>			<span style=color:#8f5902;font-style:italic>// 用于函数类型，函数字面值和引入(import)重命名
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>#</span> <span style=color:#000>保留字符</span>
<span style=color:#ce5c00;font-weight:700>(</span> <span style=color:#ce5c00;font-weight:700>)</span>			<span style=color:#8f5902;font-style:italic>// 划界表达式和参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#ce5c00;font-weight:700>]</span>			<span style=color:#8f5902;font-style:italic>// 划界类型参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>}</span>			<span style=color:#8f5902;font-style:italic>// 划界块(block)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>.</span>			<span style=color:#8f5902;font-style:italic>// 方法调用和路径分割
</span><span style=color:#8f5902;font-style:italic>// /* */	// 注释
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>#</span> 			<span style=color:#8f5902;font-style:italic>// 用于类型标记
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>:</span>			<span style=color:#8f5902;font-style:italic>// 类型归属或上下文界限(context bounds)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>&lt;%</span>	<span style=color:#8f5902;font-style:italic>// 上界、下界或视图(view)界限
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#4e9a06>&#34; &#34;&#34;&#34;</span>		<span style=color:#8f5902;font-style:italic>// 字符串
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>&#39;</span>			<span style=color:#8f5902;font-style:italic>// 标示符号或字符
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>@</span>			<span style=color:#8f5902;font-style:italic>// 注解和模式匹配中的变量绑定
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>`</span>			<span style=color:#8f5902;font-style:italic>// 标示常量或使称为任意标示符
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>,</span>			<span style=color:#8f5902;font-style:italic>// 参数分割
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>;</span>			<span style=color:#8f5902;font-style:italic>// 语句分割
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*</span>			<span style=color:#8f5902;font-style:italic>// 可变参数展开
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>_</span>			<span style=color:#8f5902;font-style:italic>// 不同场景有多种意义
</span></code></pre></div><h3 id=下划线>下划线</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala._</span>			<span style=color:#8f5902;font-style:italic>// 通配符，引入 Scala 包中所有的资源
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Predef</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>}</span>		<span style=color:#8f5902;font-style:italic>// 排除，除了 Predef，引入其他所有
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span>				<span style=color:#8f5902;font-style:italic>// 高阶类型参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>M</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>])</span>			<span style=color:#8f5902;font-style:italic>// 存在的类型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span> 					<span style=color:#8f5902;font-style:italic>// 匿名函数参数占位符
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>m</span> <span style=color:#204a87;font-weight:700>_</span>						<span style=color:#8f5902;font-style:italic>// 将方法转换为方法的值
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>					<span style=color:#8f5902;font-style:italic>// 偏函数应用
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>5</span>					<span style=color:#8f5902;font-style:italic>// 丢弃的参数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span>				<span style=color:#8f5902;font-style:italic>// 通配符，匹配任何
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>)</span>				<span style=color:#8f5902;font-style:italic>// 序列 xs 作为多个参数传入函数 f(ys: T*)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span> <span style=color:#204a87;font-weight:700>@</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>*)</span>		<span style=color:#8f5902;font-style:italic>// 将标识符 xs 绑定到所有匹配到的值
</span></code></pre></div><h2 id=通用方法>通用方法</h2>
<p>一些标识符其实是一些类、特质、对象的方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 将右边序列的元素追加到左边序列的末尾
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>).++(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>))</span>	<span style=color:#8f5902;font-style:italic>// 同上
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#a40000>3</span><span style=color:#ce5c00;font-weight:700>)</span>				<span style=color:#8f5902;font-style:italic>// 将一个元素放到一个序列的首部
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>1</span><span style=color:#ce5c00;font-weight:700>)</span>			<span style=color:#8f5902;font-style:italic>// 同上
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+:</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>+</span> <span style=color:#a40000>4</span>		<span style=color:#8f5902;font-style:italic>// +: 绑定到右边，:+ 绑定到左边
</span></code></pre></div><p><strong>以冒号(:)结尾的方法会绑定到右边，而不是左边，作为右边对象的一个方法。</strong></p>
<p>类型和对象同样也会有象征性的名字，比如：对于有两个类型参数的类型来说，名字可以写在参数之间，<code>Int &lt;:&lt; Any</code>和<code>&lt;:&lt;[Int, Any]</code>是相同的。</p>
<h2 id=隐式转换提供的方法>隐式转换提供的方法</h2>
<p>Scala 代码会自动进行三个部分的引入：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 顺序无关
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.lang._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.Predef._</span>
</code></pre></div><p>前两者用于类和单例对象，然而 <code>Predef</code>中定义了一些象征性的名字：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>&lt;:&lt;</span>		<span style=color:#8f5902;font-style:italic>// 一个 A &lt;:&lt; B 的实例，表示类型 A 是类型 B的子类型
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>=:=</span>		<span style=color:#8f5902;font-style:italic>// 一个  A =:= B 的实例，表示类型 A 与类型 B 相同
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>=:=</span>
<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>&lt;%&lt;</span> 		<span style=color:#8f5902;font-style:italic>// removed in Scala 2.10
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>???</span>			<span style=color:#8f5902;font-style:italic>// 将一个方法为未实现
</span></code></pre></div><p>同时还有<code>::</code>，没有出现在文档中但是在注释中提到了。<code>Predef</code>通过隐式转换的方式激活一些方法。</p>
<h2 id=语法糖和语法组合>语法糖和语法组合</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Example</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arr</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>v</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>a_=</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>v</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>b_=</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>v</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>c_=</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>v</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>d</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>d_=</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>v</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>e_=</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>v</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#ce5c00;font-weight:700>+(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Example</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arr</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unapply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>indices</span> <span style=color:#000>contains</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>arr</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>None</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Example</span>
<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>))</span>  <span style=color:#8f5902;font-style:italic>// means ex.apply(0)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span>       <span style=color:#8f5902;font-style:italic>// means ex.update(0, 2)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span>        <span style=color:#8f5902;font-style:italic>// means ex.b_=(3)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span>   <span style=color:#8f5902;font-style:italic>// calls ex.unapply(2) and assigns result to c, if it&#39;s Some; throws MatchError if it&#39;s None
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>         <span style=color:#8f5902;font-style:italic>// means ex = ex + 1; if Example had a += method, it would be used instead
</span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// An expression, or parameter, that is an anonymous function with
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// two parameters, used exactly where the underscores appear, and
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// which calls the &#34;+&#34; method on the first parameter passing the
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#8f5902;font-style:italic>// second parameter as argument.
</span></code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2232677dd194c297a300f15769a0b431>1.33 - Exception</h1>
<h2 id=java-中的异常>Java 中的异常</h2>
<p>Java 中异常分为两类：受检异常、非受检异常(RuntimeException, 运行时异常)。</p>
<p>两种异常的处理方式：</p>
<ol>
<li>非受检异常
<ol>
<li>捕获</li>
<li>抛出</li>
<li>不处理</li>
</ol>
</li>
<li>受检异常(除了 RuntimeException 都是受检异常)
<ol>
<li>继续抛出，消极的方式，一致抛出到 JVM 来处理</li>
<li>使用<code>try..catch</code>块来处理</li>
</ol>
</li>
</ol>
<p><strong>受检异常必须处理，否则不能编译通过。</strong></p>
<h2 id=异常原理>异常原理</h2>
<p>异常，即程序运行期键发生的不正常事件，它会打断指令的正常流程。异常均出现在程序运行期，编译期的问题成为语法错误。</p>
<p>异常的处理机制：</p>
<ol>
<li>当程序在运行过程中出现异常，JVM 会创建一个该类型的异常对象。同时把这个异常对象交给运行时系统，即抛出异常。</li>
<li>运行时系统接收到一个异常时，它会在异常产生的代码上下文附近查找对应的处理方式。</li>
<li>异常的处理方式有两种：
<ol>
<li>捕获并处理：在抛出异常的代码附近显式使用<code>try..catch</code>进行处理，运行时系统捕获后会查询相应的<code>catch</code>处理块，在<code>catch</code>处理块中对异常进行处理。</li>
<li>查看异常发生的方法是否向上声明异常，有向上声明，向上级查询处理语句，如果没有向上声明， JVM 中断程序的运行并处理，即使用<code>throws</code>向外声明</li>
</ol>
</li>
</ol>
<h2 id=异常分类>异常分类</h2>
<p>所有的错误和异常均继承自<code>java.lang.Throwable</code>。</p>
<ol>
<li>Error：错误，JVM 内部的严重问题，无法恢复，程序人员不用处理。</li>
<li>Exception：异常，普通的问题，通过合理的处理，程序还可以回到正常的处理流程，要求编程人员进行处理。</li>
<li>RuntimeException：非受检异常，这类异常是编程人员的逻辑问题，即程序编写 BUG。Java 编译器不强制要求处理，因此这类异常在程序中可以处理也可以不处理。比如：算术异常、除零异常等。</li>
<li>非 RuntimeException：受检异常，这类异常由外部的偶然因素导致。Java 编译器强制要求处理，程序人员必须对这类异常进行处理。比如：Exception、FileNotFoundException、IOException等。</li>
</ol>
<p><strong>除了受检异常，都是非受检异常。</strong></p>
<h2 id=异常处理方式>异常处理方式</h2>
<h3 id=trycatch>try/catch</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 可能会出现异常的代码块
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>异常类型1</span> <span style=color:#000>变量名1</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#8f5902;font-style:italic>// 对该类型异常的处理代码块
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>异常类型2</span> <span style=color:#000>变量名2</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 无论是否发生异常都会执行的代码块
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 常用来释放资源，比如关闭文件
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=向上声明>向上声明</h3>
<p>即使用<code>thorws</code>关键字，将异常向上抛出，声明一个方法可能会抛出的异常列表。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>methodName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>参数列表</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>异常类型1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>异常类型2</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 方法体
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种方式通过声明，告诉本方法的调用者，在使用本方法时，应该对那些异常进行处理。</p>
<h3 id=手动抛出>手动抛出</h3>
<p>当程序逻辑不符合预期，要终止后面的代码执行时使用这种方式。</p>
<p>在方法的代码段中，可以使用<code>throw</code>关键字手动抛出一个异常。</p>
<p>如果手动抛出的是一个受检异常，那么本方法必须处理(应该采用向上抛出这个异常)，如果是非受检异常，则处理是可选的。</p>
<h3 id=自定义异常>自定义异常</h3>
<p>当需要一些跟特定业务相关的异常信息类时，可以根据实际的需求，继承<code>Exception</code>来定义<strong>受检异常</strong>，或者继承<code>RuntimeException</code>来定义<strong>非受检异常</strong>。</p>
<h3 id=最佳实践>最佳实践</h3>
<p>捕获那些已知如何处理的异常，即使用<code>try/catch</code>来处理已知类型的异常。</p>
<p>向上抛出那些不知如何处理的异常。</p>
<p>减少异常处理的嵌套。</p>
<h2 id=scala-中的异常>Scala 中的异常</h2>
<p>Scala 中定义所有的异常为<strong>非受检异常</strong>，即便是<code>SQLException</code>或<code>IOException</code>。</p>
<p>最简单的处理方式是定义一个偏函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>input</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BufferReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileReader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Iteratro</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>continually</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readLine</span><span style=color:#ce5c00;font-weight:700>()).</span><span style=color:#000>takeWhile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>IOException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>errorHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// case SomeOtherException(e) =&gt; ???
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>imput</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者使用<code> control.Exception</code>来组合需要处理的多个异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>handling</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>RuntimeException</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>classOf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>IOException</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#000>by</span> <span style=color:#000>println</span> <span style=color:#000>apply</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IOException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>更上面的最佳实践里提到的一样，不能以<strong>通配</strong>的方式捕获所有异常，这会捕获到类似内存溢出这样的异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>	
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>...</span>	<span style=color:#8f5902;font-style:italic>// Don&#39;t do this!
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果需要捕获大部分可能出现的异常，并且不是严重致命的，可以使用<code>NonFatal</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getMessage</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>NonFatal</code>意为非致命错误，不会捕获类似<code>VirtualMachineError</code>这样的虚拟机错误。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>NonFatal</span> <span style=color:#ce5c00;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>    * Returns true if the provided `Throwable` is to be considered non-fatal, or false if it is to be considered fatal
</span><span style=color:#8f5902;font-style:italic>    */</span>
   <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>t</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
     <span style=color:#8f5902;font-style:italic>// VirtualMachineError includes OutOfMemoryError and other fatal errors
</span><span style=color:#8f5902;font-style:italic></span>     <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_:</span> <span style=color:#204a87;font-weight:700>VirtualMachineError</span> <span style=color:#204a87;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ThreadDeath</span> <span style=color:#204a87;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>InterruptedException</span> <span style=color:#204a87;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>LinkageError</span> <span style=color:#204a87;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ControlThrowable</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>false</span>
     <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>true</span>
   <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>   * Returns Some(t) if NonFatal(t) == true, otherwise None
</span><span style=color:#8f5902;font-style:italic>   */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unapply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>None</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在使用<code>NonFatal</code>捕获异常时定义的偏函数<code>case NonFatal(e) => ???</code>，这类似于模式匹配的构造器模式，会调用<code>NonFatal</code>的<code>unapply</code>方法，在<code>unapply</code>中会对异常进行判断，即调用<code>apply</code>方法，如果不属于<strong>虚拟机错误</strong>则进行捕获，否则将不进行捕获。这是一种捕获异常的快捷方式。</p>
<p>通常还有一些为了逻辑处理而主动抛出的异常需要处理，比如<code>assert</code>、<code>require</code>、<code>assume</code>。</p>
<h3 id=option>Option</h3>
<p>在处理异常时，一般讲结果置为一个<code>Option</code>，成功时返回<code>Some(t)</code>，失败时返回<code>None</code>。</p>
<h3 id=either>Either</h3>
<p><code>Either</code>是一个封闭抽象类，表示两种可能的类型，它只有两个终极子类，<code>Left</code>和<code>Rright</code>，因此<code>Either</code>的实例要么是一个<code>Left</code>要么是一个<code>Right</code>。</p>
<p>类似于<code>Option</code>，通常也可以用于异常的处理，<code>Option</code>只能表示有结果或没有结果，<code>Either</code>则可以表示有结果时结果是什么，没有结果时“结果”又是什么，比如失败时的结果是一个异常信息等等。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span>, <span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span>, <span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span>, <span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>通常，<code>Left</code>表示失败，<code>Right</code>表示成功。伴生对象中提供了多种转换方法，比如<code>toOption</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 如果是 Left 实例
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toOption</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>None</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// 如果是 Right 实例
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>toOption</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>None</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>一个使用的实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FailResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>reason</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FailResult</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringTokenizer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>countTokens</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nextToken</span><span style=color:#ce5c00;font-weight:700>())</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FailResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Could not parse string: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这时如果只想要处理成功结果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>rightFoo</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>outputFoo</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>outputFoo</span>
</code></pre></div><p>或者使用<code>fold</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>fold</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#000>error</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>errorHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>),</span>
  <span style=color:#000>success</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者模式匹配：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>parse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>le</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>???</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Riggt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ri</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>并不限制于用在解析或验证，也可以用在业务场景：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserFault</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserCreatedEvent</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>createUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>User</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>UserFault</span>, <span style=color:#204a87;font-weight:700>UserCreatedEvent</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>或者二选一的时候：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>whatShape</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>shape</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Shape</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Square</span>, <span style=color:#204a87;font-weight:700>Circle</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>或者与<code>Option</code>进行嵌套，返回一个异常，或者成功时包含有值或无值两种情况：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>lookup</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FooException</span>,<span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Foo</span><span style=color:#ce5c00;font-weight:700>]]</span>
</code></pre></div><p>这种方式比较冗余，可以直接返回一个异常或结果：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>modify</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>inputFoo</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Foo</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FooException</span>,<span style=color:#204a87;font-weight:700>Foo</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>**不要在 Either 中返回异常，而是创建一个 case 类来表示异常的结果。**比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FailResult</span>,<span style=color:#204a87;font-weight:700>Foo</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><h3 id=try>Try</h3>
<p><code>Try</code>与<code>Either</code>类似，但它不像<code>Either</code>将一些结果类包装在<code>Left</code>或<code>Right</code>中，它会直接返回一个<code>Failure[Throwable]</code>或<code>Succese[T]</code>。它是<code>try/catch</code>的一种简写方式，内部仍然是对<code>NonFatal</code>的处理。</p>
<p>它实现了<code>flatMap</code>方法，因此可以使用下面的方式，任何一个<code>Try</code>失败都会返回<code>Failure</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sumTry</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>int1</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#000>int2</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>int1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>int2</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者通过模式匹配的方式对<code>Try</code>的结果进行处理：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>sumTry</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thrown</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Console</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Failure: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>thrown</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Console</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者获取失败时的异常值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sumTry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isFailure</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>thrown</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>sumTry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果是成功的结果，<code>get</code>方法会返回对应的值。</p>
<p>可以使用<code>recover</code>方法处理多个<code>Try</code>链接中任意位置的异常：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>int1</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;one&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#000>int2</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;two&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>int1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>int2</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>recover</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// or
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>int1</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;one&#34;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#000>recover</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>int2</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;two&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>int1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>int2</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用<code>toOption</code>方法将<code>Try[T]</code>转换为一个<code>Option[T]</code>。</p>
<p>或者与<code>Either</code>混合使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>either</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>parseInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#000>transform</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;FAIL&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>get</span>
<span style=color:#000>Console</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;either is &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>either</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fold</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>l</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><blockquote>
<p>将方法的返回值声明为 Try 可以告诉调用者该方法可能会抛出异常，可以达到受检异常的效果，即调用者必须要处理对应的异常，因此可以使代码更安全。虽然使用常规的 try/catch 也可以做到，但是这样更清晰。</p>
</blockquote>
<h4 id=与-future-组合使用>与 Future 组合使用</h4>
<blockquote>
<p>Try 的存在意义就是为了用于 Future，参考 Future 对应的整理记录。</p>
</blockquote>
<p>使用<code>Future</code>包装阻塞的<code>Try</code>代码块：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>blockMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Try</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// Some long operation to get an Int from network or IO
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Thread</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sleep</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#0000cf;font-weight:700>100</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tryToFuture</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>future</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>t</span>
    <span style=color:#ce5c00;font-weight:700>}.</span><span style=color:#000>flatMap</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fail</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Initiate long operation
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>tryToFuture</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>blockMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>或者如果经常需要将<code>Future</code>与<code>Try</code>进行链接：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FutureTryHelpers</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tryToFuture</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>t</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>someFuture</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>processResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>FutureTryHelpers._</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>someFuture</span>
  <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>processResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>b</span>
<span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>/* Success Block */</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#000>recover</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>/* Failure Block */</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者使用<code>Promse</code>的<code>fromTry</code>方法来构建<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>tryToFuture</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>t</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fromTry</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>future</span>
</code></pre></div><h3 id=用法总结>用法总结</h3>
<ul>
<li>在纯函数代码中将异常抛出到单独的非预期错误</li>
<li>使用<code>Option</code>返回可选的值</li>
<li>使用<code>Either</code>返回预期的错误</li>
<li>返回异常时使用<code>Try</code>而不是<code>Either</code></li>
<li>捕获非预期错误时使用<code>Try</code>而不是<code>trt/catch</code>块</li>
<li>在处理<code>Future</code>时使用<code>Try</code></li>
<li>在公共接口暴露<code>Try</code>类似于受检异常，直接使用异常替代</li>
</ul>
<h2 id=自定义异常-1>自定义异常</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PGDBException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>None</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>None</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RuntimeException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>PGDBException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>defaultMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>))</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>PGDBException</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>defaultMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>cause</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>msg</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thr</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>thr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>null</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PGDBException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>None</span><span style=color:#ce5c00;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>throwable</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Throwable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PGDBException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>None</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>throwable</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>PGDBException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Already exist.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>PGDBException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Throwable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;this is a throwable&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-95dff9dc548069937c9f193200f1b9f3>1.34 - Inject Type</h1>
<p>Scala 注解作为元数据或额外信息添加到程序源代码。类似于注释，注解可以添加到变量、方法、表达式或任何其他的程序元素。</p>
<p>注解可以添加到任何类型的定义或声明上，包括：<code>var, val, class, object, trait, def, type</code>。</p>
<p>可以同时添加多个注解，顺序无关。</p>
<p>给主构造器添加注解时需要将注解放在主构造器之前：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Credentials</span> <span style=color:#5c35cc;font-weight:700>@Inject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>username</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>password</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>给表达式添加注解时，需要在表达式之后添加冒号，然后添加注解本身：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>myMap</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>@unchecked</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{...}</span> 
</code></pre></div><p>可以为类型参数添加注解：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyContainer</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>@specialized</span> <span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>只对实际类型的注解应该放在类型名之前：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>String</span> <span style=color:#5c35cc;font-weight:700>@cps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#8f5902;font-style:italic>// @cps带一个类型参数 
</span></code></pre></div><p>声明一个注解的语法类似于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#5c35cc;font-weight:700>@annot</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exp_</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>exp_</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#ce5c00;font-weight:700>...)</span>  <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>name_</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>const_</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#ce5c00;font-weight:700>...,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>name_</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>const_</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>}}</span>
</code></pre></div><p><code>annot</code>用于指定注解的类型，所有的注解都要包含这个部分。一些注解不需要提供参数，因此圆括号可以被省略或者提供一个空的圆括号。</p>
<p>传递给注解的精确参数需要依赖于注解类的实际定义。大多数注解执行器支持直接的常量，比如<code>Hi</code>或<code>678</code>。关键字<code>this</code>可以用于在当前作用域引用的其他变量。</p>
<p>类似<code>name=const</code>这样的参数可以在比较复杂的拥有可选参数的注解中见到。这个参数是可选的，并且可以按任意顺序指定。等到右边的值建议使用一个常量。</p>
<p>Java 注解的参数类型只能是：数值型字面量、字符串、类字面量、枚举、其他注解，或上述类型的数组但不能是嵌套数组。</p>
<p>Scala 注解的参数可以是任何类型。</p>
<h2 id=scala-中的标准注解>Scala 中的标准注解</h2>
<ul>
<li><code>scala.SerialVersionUID</code>：为一个可序列化的类指定一个<code>SerialVersionUID</code>字段</li>
<li><code>scala.deprecated</code>：表示这个定义已经被移除，即废弃的定义</li>
<li><code>scala.volatile</code>：告诉开发者在并发程序中允许使用可变状态</li>
<li><code>scala.transient</code>：标记为非持久字段</li>
<li><code>scala.throws</code>：指定一个方法抛出的异常</li>
<li><code>scala.cloneable</code>：标明一个类以复制(cloneable)的方式应用(apply)</li>
<li><code>scala.native</code>：原生方法的标记</li>
<li><code>scala.inline</code>：这个方法上的注解，请求编译器需要尽力内联这个被注解的方法</li>
<li><code>scala.remote</code>：标明一个类以远程(remotable)的方式应用(apply)</li>
<li><code>scala.serializable</code>：标明一个类以序列化(serializable)的方式应用(apply)</li>
<li><code>scala.unchecked</code>：适用于匹配表达式中的选择器。如果存在，表达式的警告会被禁止</li>
<li><code>scala.reflectBeanProperty </code>：当附加到一个字段时，根据<code>JavaBean </code>的管理生成 getter 和 setter 方法</li>
</ul>
<h2 id=废弃注解deprecated>废弃注解：@deprecated</h2>
<p>有时需要写一个类或方法，后来又不再需要。可以为类或方法添加一个提醒一面他人使用，但是为了兼容性有不能直接移除。方法或类可以使用<code>@deprecated</code>标记，然后在使用时会有一个提醒。</p>
<h2 id=不稳定字段volatile>不稳定字段：@volatile</h2>
<p>有些开发者想要在并发程序中使用可变状态，这种场景中可以使用<code>@volatile</code>注解，通知编译器这个变量会被多个线程使用。</p>
<h2 id=二进制序列化serializableserialversionuidtransient>二进制序列化：@serializable/@SerialVersionUID/@transient</h2>
<p>序列化框架将对象转换为流式字节，以节省磁盘占用或网络传输。Scala 并没有自己的序列化框架。<code>@serializable</code>注解表示一个类是否可以被序列化。默认的，类是不支持序列化的，因此需要添加该注解。</p>
<p><code>@SerialVersionUID</code>用于处理可序列化的类并根据时间改变，自增数值可以以<code>@SerialVersionUID(678)</code>的方式附上当前的版本，678 即为自增 ID。</p>
<p>如果一个字段被标记为<code>@transient</code>，框架序列化相关的对象是不会保存该字段。当该对象被重新加载时，该字段会被设置为一个默认值。</p>
<h2 id=自动生成-gettersetter-方法>自动生成 getter/setter 方法</h2>
<p>一个带有<code>@scala.reflect.BeanProperty</code>注解的字段，编译器会自动为其生成 getter 和 setter 方法。</p>
<h2 id=模式匹配忽略部分用例unchecked>模式匹配忽略部分用例：Unchecked</h2>
<p><code>@unchecked</code>注解通过编译器在模式匹配时解释。告诉编译器如果匹配语句遗漏了可能的 case 时不用警告。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-737e3d6efc18de0358a85817d92cad01>1.35 - Type Class</h1>
<p><a href=http://www.cakesolutions.net/teamblogs/demystifying-implicits-and-typeclasses-in-scala>《Demystifying Implicits and Typeclasses in Scala》</a>一文的整理翻译。</p>
<p>The idea of typeclasses is that you provide evidence that a class satisfies an interface。</p>
<p><strong>类型类</strong>思想是你提供了一个<strong>类</strong>满足于一个<strong>接口</strong>的<strong>证明</strong>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>CanFoo</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Wrapper</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>wrapped</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>WrapperCanFoo</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>CanFoo</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Wrapper</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Wrapper</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>wrapped</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><strong>类型类</strong>思想是你提供了一个<strong>类</strong>(Wrapper)满足于一个<strong>接口</strong>*(CanFoo)的**证明**(WrapperCanFoo)。</p>
<p><code>Wrapper</code>不是直接的去继承一个接口，类型类让我们把类的定义和接口的实现分开。这表示，我可以为你的类实现一个接口，或者第三方可以为你的类实现我的接口，并且一切基本结束工作。</p>
<p>但是有一个明显的问题，如果你想把一个东西实现为<code>CanFoo</code>，你需要同时询问你的调用者类的实例和协议。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>thing</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>evidence</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>CanFoo</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>evidence</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foos</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>thing</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-b9506bcb61f992b431f5cb2ad67ea924>1.36 - Map Flatmap</h1>
<p><a href=http://www.brunton-spall.co.uk/post/2011/12/02/map-map-and-flatmap-in-scala/>Map, Map and flatMap in Scala</a>的翻译整理,点击查看原文.</p>
<h2 id=map>map</h2>
<p><code>map</code>操作会将集合中的每个元素作用到一个函数上:</p>
<pre><code>scala&gt; val l = List(1,2,3,4,5)

scala&gt; l.map( x =&gt; x*2 )
res60: List[Int] = List(2, 4, 6, 8, 10)
</code></pre>
<p>或者有些场景,你想让这个函数返回一个序列或列表,或者一个<code>Option</code>:</p>
<pre><code>scala&gt; def f(x: Int):Option[Int] = if (x &gt; 2) Some(x) else None

scala&gt; l.map(x =&gt; f(x))
res63: List[Option[Int]] = List(None, None, Some(3), Some(4), Some(5))
</code></pre>
<h2 id=flatmap>flatMap</h2>
<p><code>flatMap</code>的作用是,将一个函数作用的到列表中每个序列的各个元素上,<strong>注意这里是一个嵌套的序列</strong>,然后将这些元素展开到原始的列表中.使用一个实例来解释会比较清晰:</p>
<pre><code>scala&gt; def g(v:Int) = List(v-1, v, v+1)
g: (v: Int)List[Int]

scala&gt; l.map(x =&gt; g(x))
res64: List[List[Int]] = List(List(0, 1, 2), List(1, 2, 3), List(2, 3, 4), List(3, 4, 5), List(4, 5, 6))

scala&gt; l.flatMap(x =&gt; g(x))
res65: List[Int] = List(0, 1, 2, 1, 2, 3, 2, 3, 4, 3, 4, 5, 4, 5, 6)
</code></pre>
<p>这种操作对于处理<code>Option</code>类型的元素非常方便,因为<code>Option</code>同样是一种序列,只是可能包含一个元素或不包含元素:</p>
<pre><code>scala&gt; l.map(x =&gt; f(x))
res66: List[Option[Int]] = List(None, None, Some(3), Some(4), Some(5))

scala&gt; l.flatMap(x =&gt; f(x))
res67: List[Int] = List(3, 4, 5)
</code></pre>
<h2 id=使用-map-处理-map>使用 map 处理 Map</h2>
<p>让我们看一下这些概念如何作用到<code>Map</code>类型上.一个<code>Map</code>可以通过多种方式实现,事实上他是一个包含二元组键值对的序列,这个二元组的第一个值是键,第二个值是值.</p>
<pre><code>scala&gt; val m = Map(1 -&gt; 2, 2 -&gt; 4, 3 -&gt; 6)
m: scala.collection.immutable.Map[Int,Int] = Map(1 -&gt; 2, 2 -&gt; 4, 3 -&gt; 6)

scala&gt; m.toList
res69: List[(Int, Int)] = List((1,2), (2,4), (3,6))
</code></pre>
<p>然后通过<code>_1</code>和<code>_2</code>来方位元组的值:</p>
<pre><code>scala&gt; val t = (1,2)
t: (Int, Int) = (1,2)

scala&gt; t._1
res70: Int = 1

scala&gt; t._2
res71: Int = 2
</code></pre>
<p>这时如果我们要使用 map 和 flatMap 来操作<code>Map</code>,但是 map 操作在这看起来会没有意义,因为我们不会想去将我们的函数作用到一个元组,而是要将其作用到该元组的值.不过 map 提供了一种方式来处理<code>Map</code>的值,但是不包括对 key 的处理:</p>
<pre><code>scala&gt; m.mapValues(v =&gt; v*2)
res73: scala.collection.immutable.Map[Int,Int] = Map(1 -&gt; 4, 2 -&gt; 8, 3 -&gt; 12)

scala&gt; m.mapValues(v =&gt; f(v))
res74: scala.collection.immutable.Map[Int,Option[Int]] = Map(1 -&gt; None, 2 -&gt; Some(4), 3 -&gt; Some(6))
</code></pre>
<h2 id=使用-flatmap-处理-map>使用 flatMap 处理 Map</h2>
<p>但是在我的需求中我想要的处理效果更类似于 flatMap. flatMap 与 mapValues 处理<code>Map</code>的方式不同,它获取传入的元组,如果返回一个单项的<code>List</code>它会返回一个<code>List</code>; 如果返回一个元组,它会返回一个<code>Map</code>:</p>
<pre><code>scala&gt; m.flatMap(e =&gt; List(e._2))
res85: scala.collection.immutable.Iterable[Int] = List(2, 4, 6)

scala&gt; m.flatMap(e =&gt; List(e))
res86: scala.collection.immutable.Map[Int,Int] = Map(1 -&gt; 2, 2 -&gt; 4, 3 -&gt; 6)
</code></pre>
<p>这样我们可以很漂亮的使用 flatMap 来处理<code>Option</code>,我需要过滤出所有的<code>None</code>,如果仅仅使用<code>e => f(e._2)</code>会得到所有不为<code>None</code>的值并组成一个<code>List</code>返回.但是我需要的是一个<code>Option[Tuple2]</code>,如下所示:</p>
<pre><code>scala&gt; def h(k:Int, v:Int) = if (v &gt; 2) Some(k-&gt;v) else None
h: (k: Int, v: Int)Option[(Int, Int)]
</code></pre>
<p>然后调用这个函数:</p>
<pre><code>scala&gt; m.flatMap ( e =&gt; h(e._1,e._2) )
res109: scala.collection.immutable.Map[Int,Int] = Map(2 -&gt; 4, 3 -&gt; 6)
</code></pre>
<p>这已经达到了我的要求,但是这些<code>e._1,e._2</code>并不是很优雅,如果有一个更好的方式将元组解包为变量就再好不过了.如果按 Python 的方式,或许在 Scala中也能工作:</p>
<pre><code>scala&gt; m.flatMap ( (k,v) =&gt; h(k,v) )
:10: error: wrong number of parameters; expected = 1
</code></pre>
<p>报错了,这并不符合预期.原因是<code>unapply</code>只能够在<code>PartialFunction</code>中执行,在 Scala中就是一个 case 语句,即:</p>
<pre><code>scala&gt; m.flatMap { case (k,v) =&gt; h(k,v) }
res108: scala.collection.immutable.Map[Int,Int] = Map(2 -&gt; 4, 3 -&gt; 6)
</code></pre>
<p>注意这里使用了大括号而不再是小括号了,表示这里是一个函数块而不是参数,而这个函数块是一个 case 语句.这意味着我们传给 flatMap 的函数块是一个<code>partialFunction</code>,并且只有与这个 case 语句匹配时才会调用,同时 case 语句中元组的<code>unapply</code>方法被调用,以将元组的值解析为变量.</p>
<h2 id=其他方式>其他方式</h2>
<p>当然除了使用 flatMap 还有别的方式. 因为我们的目的是移除<code>Map</code>中所有不满足断言的元素,这里同样可以使用<code>filter</code>方法:</p>
<pre><code>scala&gt; m.filter( e =&gt; f(e._2) != None )
res114: scala.collection.immutable.Map[Int,Int] = Map(2 -&gt; 4, 3 -&gt; 6)

scala&gt; m.filter { case (k,v) =&gt; f(v) != None }
res115: scala.collection.immutable.Map[Int,Int] = Map(2 -&gt; 4, 3 -&gt; 6)

scala&gt; m.filter { case (k,v) =&gt; f(v).isDefined }
res116: scala.collection.immutable.Map[Int,Int] = Map(2 -&gt; 4, 3 -&gt; 6)
</code></pre>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d9b998701238123f5d1dd72a38243f21>1.37 - 泛型型变</h1>
<h2 id=里氏替换原则>里氏替换原则</h2>
<blockquote>
<p>所有引用父类型的地方必须能透明地使用其子类型的对象。</p>
</blockquote>
<p>这里面暗含了一条重要的信息：所有你想由父类完成的操作，子类都能够完成，而且子类能比父类做的更多。</p>
<h2 id=概念>概念</h2>
<ul>
<li>协变(covariance)、逆变(contravariance)、不可变(invariant) 统称为型变(variance)。</li>
<li>型变表述了：具有父子类型关系的类型经过“类型转换”后，所构造出的更复杂的对应类型之间的关系是如何变化的。</li>
<li>协变：具有父子类型关系的类型，经过“类型转换”所构造的复杂类型之间仍然保持着相同的父子类型关系。</li>
<li>逆变：具有父子类型关系的类型，经过“类型转换”所构造的复杂类型之间保持着与原类型之间相反的父子关系。</li>
<li>不变：不支持协变或逆变。</li>
</ul>
<p>型变描述的是一组类型转换规则。</p>
<h2 id=公式>公式</h2>
<p>假设两种类型 X 和 Y，<code>&lt;:</code> 表示子类型关系，<code>>:</code> 表示父类型关系，即 <code>X &lt;: Y</code> 表示 X 是 Y 的子类。<code>f</code> 表示类型转换，即一个类型构造操作，通过传入一个类型来构造一个新类型。因此 X、Y 对应的构造类型分别为 <code>f(X)</code> 和 <code>f(Y)</code>。</p>
<p>因此，型变描述的是：基于具有父子关系的 X 和 Y，通过 <code>f</code> 构造而成的 <code>f(X)</code> 和 <code>f(Y)</code>，<code>f</code> 是如何影响 <code>f(X)</code> 和 <code>f(Y)</code> 之间的父子关系的。</p>
<p>规则如下：</p>
<ul>
<li>如果 <code>X &lt;: Y</code>, 经过 <code>f</code> 构造类型之后之后 <code>f(X) &lt;: f(Y)</code>, <code>f</code> 具有协变性。</li>
<li>如果 <code>X &lt;: Y</code>, 经过 <code>f</code> 构造类型之后之后 <code>f(X) >: f(Y)</code>, <code>f</code> 具有逆变性。</li>
<li>如果以上两种情况都不符合，则类型构造、或称类型转换 <code>f</code> 具有不可变性。</li>
</ul>
<h2 id=容器类型>容器类型</h2>
<p>这里的容器类型泛指集合类型，比如 <code>Array</code>。</p>
<h3 id=协变>协变</h3>
<p>假设以下类型：<code>FujiApple &lt;: Apple &lt;: Fruit, Orange &lt;: Fruit</code>。</p>
<p>根据协变规则的定义，子类型数组可以赋值给一个类型为父类型数组的变量，这里使用的 <code>f</code> 类型构造即为 Java 中的 <code>Array</code> 类型，这是一个协变类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Fruit</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>fruits</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Apple</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>];</span>	<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>fruits</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Apple</span><span style=color:#ce5c00;font-weight:700>();</span>		<span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>fruits</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>1</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FujiApple</span><span style=color:#ce5c00;font-weight:700>();</span>	<span style=color:#8f5902;font-style:italic>// 3
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>fruits</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Fruit</span><span style=color:#ce5c00;font-weight:700>();</span>		<span style=color:#8f5902;font-style:italic>// 4
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>fruits</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>3</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Orange</span><span style=color:#ce5c00;font-weight:700>();</span>		<span style=color:#8f5902;font-style:italic>// 5
</span></code></pre></div><p>首先我们可以确认两点：</p>
<ul>
<li>从 <code>fruits</code> 中取出的元素一定是 <code>Fruit</code> 类型；</li>
<li>在编译期，编译器绝对允许我们将 <code>Fruit</code> 及其子类型的元素填充到 <code>fruits</code> 协变数组，因为 <code>fruits</code> 的类型为 <code>Fruit[]</code>，可以包含任意 <code>Fruit</code> 及其子类型的元素。</li>
</ul>
<p>从协变数组 <code>fruits</code> 中读取元素是绝对安全的，无论是编译期还是运行时，都不会出现任何问题。上面的操作中，<code>fruits</code> 实际引用的是一个 <code>Apple</code> 数组，即便取出的是 <code>Apple</code> 元素，但仍然是 <code>Fruit</code> 类型。</p>
<p>但是将 <code>Fruit</code> 类型或其 <code>Fruit</code> 类型的子类型元素填充到协变数组 <code>fruits</code> 时，可能会在运行时出现问题。这时 <code>fruits</code> 实际上引用的是一个 <code>Apple[]</code> 类型数组，填充 <code>Apple</code> 或 <code>Apple</code> 子类型之外的任意类型的元素都是不合法的，最终会引起 <code>ArrayStoreException</code>。</p>
<p>上面的代码中，如果 <code>fruits</code> 是其他接口返回的数组，我们仅知道它是一个 <code>Fruit[]</code> 类型的数组，因此可以按照里氏替换原则向其填充 <code>Fruit</code> 及其子类型元素，编译器也不会抛出错误。但如果像上面的代码中的应用一样实际上引用的是一个子类型数组，则最终会引发运行时异常。</p>
<p><strong>因此，在实际使用或定义协变容器类型时，总是将其当做一个只读容器是绝对安全的。</strong></p>
<h3 id=逆变>逆变</h3>
<p>Java 实际上是不支持逆变数组的，但这里我们可以假设一下支持逆变的情况：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>Fruit</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>fruits</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Fruit</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>]{</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Apple</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Orange</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FujiApple</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>Orange</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>oranges</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>fruits</span><span style=color:#ce5c00;font-weight:700>;</span>	<span style=color:#8f5902;font-style:italic>// 应用逆变特性
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>oranges</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Orange</span><span style=color:#ce5c00;font-weight:700>();</span>	<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Orange</span> <span style=color:#000>orange</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>oranges</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#ce5c00;font-weight:700>);</span>	<span style=color:#8f5902;font-style:italic>// 2
</span></code></pre></div><p>这里我们将父类型数组 <code>fruits</code> 赋值给类型为子类型数组的变量 <code>oranges</code>，如果这样的操作理论上成立，即支持逆变，也同样会出现问题。</p>
<p>这里假如我们从 <code>oranges</code> 数组读取一个元素，因为该数组为 <code>Orange[]</code>，则其返回的元素一定会是 <code>Orange</code> 类型，但实际上并非如此，它实际上引用的是一个 <code>Fruit[]</code> 数组，元素类型可能是 <code>Fruit</code> 的任何其他子类型。</p>
<p><strong>因此，在实际使用或定义逆变容器类型时，总是将其当做一个只写容器是绝对安全的。</strong></p>
<h3 id=scala声明点型变declaration-site-variance>Scala：声明点型变(declaration-site variance)</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#000>trait</span> <span style=color:#000>A</span>
<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>B</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>A</span>
</code></pre></div><p>这时，<code>List[A]</code> 即为 <code>List[B]</code> 的父类型。</p>
<h3 id=java使用点型变use-site-variance>Java：使用点型变(use-site variance)</h3>
<p>在 Java 中，实际上参数化类型是不可型变的，比如 <code>List&lt;String></code> 并非 <code>List&lt;Object></code> 的子类型，即便 <code>String</code> 实际是 <code>Object</code> 的子类型。但有些时候需要一些比类型型变更多的灵活性。</p>
<blockquote>
<p>Java 中的泛型并没有对协变的内建支持，因此 Java 泛型具有不可变型性。但是，为了兼容遗留代码而被保留下来的原生类型确实可以做出这样的行为，但同时我们也非常清楚使用它就像使用数组的协变性一样意味着代码变得不再安全。所以，制定Java标准的那群人想出了个法子使得泛型像数组一样具有这些特性(Java 中的数组具有协变性)，同时这种代替原生类型的方案必须是绝对安全的：他们通过给泛型增加通配符特性使得泛型在参数化后具有协变性或逆变性。</p>
</blockquote>
<p>因此提供了一种方式来实现型变：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
</code></pre></div><p>这里，将 <code>List&lt;String></code> 赋值给 <code>List&lt;Object></code>，实际上表示了他们之间的父子类型关系。</p>
<p>Java 中提供的这种特性称为“类型界限通配符”：</p>
<ul>
<li><code>? extends T</code>：T 表示类型通配符的上界。即由 <code>?</code> 表示的未知类型参数必须是 <code>T</code> 的子类，或 <code>T</code> 本身。</li>
<li><code>? super T</code>：T 表示类型通配符的下界。即由 <code>?</code> 表示的未知类型参数必须是 <code>T</code> 的父类，或 <code>T</code> 本身。</li>
</ul>
<p>但是何时使用这两种通配符呢，在 Effective Java 中(3rd, Item-31)详细解释了 PECS 原则：</p>
<blockquote>
<p><strong>P</strong>roducer use &ldquo;<strong>E</strong>xtends&rdquo; and <strong>C</strong>onsumer uses &ldquo;<strong>S</strong>uper&rdquo;.</p>
</blockquote>
<p>这里的 Extends 和 Super 对应类型边界声明符 <code>extends</code> 和 <code>super</code>。为了更大的灵活性，在方法的输入参数中使用通配符类型来表示生产者或消费者。即从一个容器(集合)类型的视角出发：</p>
<ul>
<li>如果仅需要从集合中读取元素，这时集合作为一个生产者，应该在定义集合时使用 <code>extends</code> 来声明类型上界；</li>
<li>如果仅需要向集合中填充元素，这时集合作为一个消费者，应该在定义集合时使用 <code>super</code> 来声明类型下界。</li>
<li>如果同时需要读取和填充操作，则需要制定精确的类型，不能使用上下界来修饰类型参数。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Stack</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Stack</span><span style=color:#ce5c00;font-weight:700>();</span> 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span> 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>E</span> <span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>();</span> 
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>();</span> 
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>pushAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Iterable</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>	<span style=color:#8f5902;font-style:italic>// 1
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>E</span> <span style=color:#000>e</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
			<span style=color:#000>push</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>);</span> 
	<span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>popAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>super</span> <span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>		<span style=color:#8f5902;font-style:italic>// 2
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>while</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span>
			<span style=color:#000>dst</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pop</span><span style=color:#ce5c00;font-weight:700>());</span> 
        <span style=color:#ce5c00;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><ol>
<li><code>src</code> 作为生产者集合，所包含的元素均为 E 的子类或 E，这时可以对一个 <code>Stack&lt;Number></code> 调用 <code>pushAll</code> 传入一个 <code>Iterable&lt;Int></code>。</li>
<li><code>dst</code> 作为消费者集合，所包含的元素均为 E 的父类或 E，这时可以对一个 <code>Stack&lt;Number></code> 调用 <code>popAll</code> 传入一个 <code>Iterable&lt;Object></code>。</li>
</ol>
<h2 id=返回值与参数中的型变>返回值与参数中的型变</h2>
<p>这种情况的典型应用便是 Scala 中的 <code>Function1</code> 接口：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Function1</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>-T1</span>, <span style=color:#204a87;font-weight:700>+R</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>extends</span> <span style=color:#000>AnyRef</span>
</code></pre></div><p>在 Scala 中，<code>-T</code> 表示逆变，<code>+T</code> 表示协变，<code>T</code> 表示不变。</p>
<p>假定我们拥有以下类型：<code>Garfield &lt;: Cat &lt;: Animal</code>, <code>Husky &lt;: Dog &lt;: Animal</code>。对于 <code>Function1[Cat, Dog]</code> 来说，其子类必须保证两个功能：</p>
<ol>
<li>你可以向其传入任意类型的 <code>Cat</code>，即 <code>Cat</code> 的的所有子类；</li>
<li>你可以使用其返回值调用 <code>Dog</code> 的任意方法。</li>
</ol>
<h3 id=逆变参数>逆变参数</h3>
<p>假如参数是协变的，即 <code>Function1[Garfield, _] &lt;: Function1[Cat, _]</code>，根据里氏替换原则，任何需要父类的地方都可以使用一个子类来替换，这里作为父类的 <code>Function1[Cat, _]</code> 可以接收任意类型的 <code>Cat</code>，但作为子类的 <code>Function1[Garfield, _]</code> 仅能接收 <code>Garfield</code>。因此没有意义。</p>
<p>假如参数是逆变的，即 <code>Function[Animal, _] &lt;: Function[Cat, _]</code>，根据里氏替换原则，这里作为父类的 <code>Function1[Cat, _]</code> 可以接收任意类型的 <code>Cat</code>，同样作为子类的 <code>Function[Animal, _]</code> 也可以接收更多类型的 <code>Cat</code>，而且不仅仅是 <code>Cat</code>，甚至是 <code>Dog</code> (子类能做的更多)。</p>
<p>因此对于 <code>A &lt;: B</code> 来说，要求 <code>Function1[B, _] &lt;: Function1[A, _]</code>。</p>
<h3 id=协变返回值>协变返回值</h3>
<p>假如返回值是协变的，即 <code>Function[_, Husky] &lt;: Function[_, Dog]</code>，根据里氏替换原则，这里作为父类的 <code>Function[_, Dog]</code> 可以在其返回值上调用任意 <code>Dog</code> 的方法，而作为子类的 <code>Function[_, Husky]</code> 同样可以在其返回值上调用任意 <code>Dog</code> 的方法，甚至还能调用 Husky 特有的方法 <code>destoryHouse</code>(子类能做的更多)。</p>
<p>假如返回值是逆变的，即 <code>Function[_, Animal] &lt;: Function[_, Dog]</code>，根据里氏替换原则，这里作为父类的 <code>Function[_, Dog]</code> 可以在其返回值上调用任意 <code>Dog</code> 的方法，而作为子类的 <code>Function[_, Animal]</code> 则可能无法执行 <code>Dog</code> 特有的方法，因此没有意义。</p>
<h3 id=反向推导>反向推导</h3>
<p>因此，对于一个 <code>Function1[Animal, Husky]</code>，它可以完成 <code>Function1[Cat, Dog]</code> 所能完成的所有工作：可以传入任意类型的 <code>Cat</code>, 甚至是其他 <code>Animal</code>，可以调用 <code>Dog</code> 的任意方法，甚至是 <code>Husky</code> 特有的方法。总的来说，<code>Function1[Animal, Husky] &lt;: Function1[Cat, Dog]</code>。因此对于 <code>Function1[Cat, Dog]</code> 本身来说，其参数类型可以替换为父类(逆变)，返回值类型可以替换为子类(协变)。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4e77c6da5492008617d93656d181886b>1.38 - 常见问题</h1>
<h2 id=根据类的不同属性进行排序-1>根据类的不同属性进行排序-1</h2>
<p>需要对类的集合按照不同的字段进行排序，排序的规则可以指定：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>good</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bad</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>gross</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>warn</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>BaseSort</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B:</span> <span style=color:#204a87;font-weight:700>Ordering</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>data</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>desc</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Boolean</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>measure</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>baseOrdering</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Ordering</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>measure</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ordering</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>baseOrdering</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>baseOrdering</span>
    <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sorted</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ordering</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ItemsSort</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseSort</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sortItems</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Item</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>by</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>desc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Item</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>by</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;good&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>desc</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>good</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;bad&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>desc</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>bad</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;gross&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>desc</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>gross</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#4e9a06>&#34;warn&#34;</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>desc</span><span style=color:#204a87;font-weight:700>=</span><span style=color:#000>desc</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>warn</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>items</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>items</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Item</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>),</span><span style=color:#000>Item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>),</span><span style=color:#000>Item</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;c&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;c&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;c&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#000>sortItems</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;good&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>desc</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=根据类的不同属性进行排序-2>根据类的不同属性进行排序-2</h2>
<p>另一种方式是首先预定义需要的排序规则，然后在需要的位置做为隐式参数引入：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Item2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>firstName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>lastName</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Item2</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 注意，因为`Ordering[A]`不是逆变的，如果`Item`的子类想要使用该排序方式，则必须声明为参数化类型
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>orderByName</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#204a87;font-weight:700>Item2</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Ordering</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>Ordering</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>))</span>

  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>orderingById</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Ordering</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Item2</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Ordering</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CustomClassSort2</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>App</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>items</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Item2</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Item2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;ccc&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;ddd&#34;</span><span style=color:#ce5c00;font-weight:700>),</span><span style=color:#000>Item2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;aaa&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;bbb&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>

  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>Item2.orderByName</span>						<span style=color:#8f5902;font-style:italic>// 直接引入隐式参数
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sorted</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ording</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Item2</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>orderingById</span>		<span style=color:#8f5902;font-style:italic>// 引入排序规则后定义为隐式参数
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>items</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sorted</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=隐式转换>隐式转换</h2>
<h2 id=将类自动转换为元组>将类自动转换为元组</h2>
<p>有时候需要将一些<code>case class</code>自动转换为元组以方便处理：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>asTuple</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>foo</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Foo</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>unapply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>foo</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>get</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>foo1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Foo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aa&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;bb&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>foo1</span>
</code></pre></div><h2 id=不可过度使用元组>不可过度使用元组</h2>
<p>对元组过度的使用会使代码难于理解，特别是元素特别多的元组，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>bestByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>actors</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)])</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>actors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_2</span> <span style=color:#000>contains</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sortBy</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_3</span><span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>_1</span><span style=color:#ce5c00;font-weight:700>}</span>
		<span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>take</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>而是应该讲使用频繁的元组作为一个<code>case class</code>，并且将各阶段的中间处理过程进行易于理解的命名：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Actor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>score</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>bestByName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>query</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>actors</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Actor</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>candidates</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>actors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#000>contains</span> <span style=color:#000>query</span><span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ranked</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>canditates</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sortBy</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>score</span> <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>best</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ranked</span> <span style=color:#000>take</span> <span style=color:#0000cf;font-weight:700>10</span>
  <span style=color:#000>best</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=可变数据类型的选择>可变数据类型的选择</h2>
<p>在一个函数或者私有类中时，如果一个可变的数据类型能够有效的缩减代码，这时就可以使用可变数据类型，比如<code>var</code>或者<code>colleciton.mutable</code>，因为没有外部的动作可以对他们造成改变。</p>
<h2 id=函数重复参数传入>函数重复参数传入</h2>
<p>比如定义一个方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String*</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forearh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>该函数能够接受一个或多个 String 类型的参数，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aa&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;bb&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;cc&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这个<code>String*</code>实际上是一个<code>Array[String]</code>，但是当传入一个已存在的序列时，需要先将其展开：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seq</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;aa&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;bb&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;cc&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>echo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seq</span><span style=color:#204a87;font-weight:700>:_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这个标注告诉编译器将序列的每个元素当做一个参数，而不是将整个序列做为一个单一的参数传入。直接传入序列将会报错。</p>
<h2 id=并行集合>并行集合</h2>
<h3 id=为并行集合指定线程数>为并行集合指定线程数</h3>
<p><a href=http://docs.scala-lang.org/overviews/parallel-collections/configuration.html>Configuring Parallel Collections</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.collection.parallel._</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>pc</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mutable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ParArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tasksupport</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ForkJoinTaskSupport</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newscala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>forkjoin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pc</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>res0</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>scala.collection.parallel.mutable.ParArray</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ParArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=异常>异常</h2>
<h3 id=nosuchmethoderror>NoSuchMethodError</h3>
<p>此类异常多为使用了错误版本的 JDK 或 Scala。</p>
<h2 id=获取代码运行时间>获取代码运行时间</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>t1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nanoTime</span>

<span style=color:#8f5902;font-style:italic>/* your code */</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>duration</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nanoTime</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>t1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>e9d</span>
</code></pre></div><h2 id=为future添加一个基于时间的监控器>为Future添加一个基于时间的监控器</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.duration._</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ScheduledThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>

<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>executor</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ScheduledThreadPoolExecutor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Executors</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>defaultThreadFactory</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>AbortPolicy</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>withDelay</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>operation</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>⇒</span> <span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>by</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>FiniteDuration</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>promise</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Promise</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]()</span>
  <span style=color:#000>executor</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>schedule</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>complete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>operation</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>},</span> <span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>by</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>promise</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>future</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstCompletedOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>withDelay</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;still going&#34;</span><span style=color:#ce5c00;font-weight:700>))(</span><span style=color:#0000cf;font-weight:700>30</span> <span style=color:#000>seconds</span><span style=color:#ce5c00;font-weight:700>)))</span>
<span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>firstCompletedOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Seq</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>withDelay</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;still still going&#34;</span><span style=color:#ce5c00;font-weight:700>))(</span><span style=color:#0000cf;font-weight:700>60</span> <span style=color:#000>seconds</span><span style=color:#ce5c00;font-weight:700>)))</span>
</code></pre></div><h2 id=logback-避免日志重复>logback 避免日志重复</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>logger</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;data-logger&#34;</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;info&#34;</span> <span style=color:#000>additivity</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><p>Loggers are hierarchical, and any message sent to a logger will be sent to all its ancestors by default. You can disable this behavior by setting additivity=false.</p>
<h2 id=okhttp异步请求>OkHttp异步请求</h2>
<p><strong>BUG</strong>：大量请求之后资源耗尽导致服务不可用，虽然已经关闭了<code>response</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.TimeUnit</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>okhttp3._</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>OkHttpBuilder</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>httpClient</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>OkHttpClient</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OkHttpClient</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>newBuilder</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>connectTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>writeTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readTimeout</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>SECONDS</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>retryOnConnectionFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>followSslRedirects</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>followRedirects</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>cloneHttpClient</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>httpClient</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>newBuilder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>OkHttpBuilder</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>OkHttpBuilder</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>asyncDownload</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>superior</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ActorRef</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>client</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>OkHttpClient</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>OkHttpBuilder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cloneHttpClient</span><span style=color:#ce5c00;font-weight:700>()</span>
      <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>request</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Builder</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>addHeader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;User-Agent&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>web</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>build</span><span style=color:#ce5c00;font-weight:700>()</span>
      <span style=color:#000>client</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>newCall</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>enqueue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Callback</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onFailure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>call</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Call</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>IOException</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;ImageProcessor.DownloadErr - 1: </span><span style=color:#4e9a06>$src</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>${</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getMessage</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
          <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Redownload</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>override</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onResponse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>call</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Call</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>response</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Response</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isSuccessful</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>false</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
              <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;ImageProcessor.DownloadErr - 2: </span><span style=color:#4e9a06>$src</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>${</span><span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Discard</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>true</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stream</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>InputStream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>byteStream</span><span style=color:#ce5c00;font-weight:700>()</span>
              <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>bytes</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Byte</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>IOUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toByteArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stream</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
                  <span style=color:#000>upload</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pathU</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Oss</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>pathU</span><span style=color:#ce5c00;font-weight:700>)</span>
                    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>None</span>        <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Redownload</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
                  <span style=color:#ce5c00;font-weight:700>}</span>
                <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>None</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Discard</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
              <span style=color:#ce5c00;font-weight:700>}</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
                <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;ImageProcessor.DownloadErr - 3: </span><span style=color:#4e9a06>$src</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>${</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getMessage</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Redownload</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>finally</span> <span style=color:#ce5c00;font-weight:700>{</span>
              <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>close</span><span style=color:#ce5c00;font-weight:700>()</span>
            <span style=color:#ce5c00;font-weight:700>}</span>
          <span style=color:#ce5c00;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>}</span>
      <span style=color:#ce5c00;font-weight:700>})</span>
    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ex</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>IOException</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;ImageProcessor.DownloadErr- IOException: </span><span style=color:#4e9a06>$src</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>${</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getMessage</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Redownload</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>NonFatal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;ImageProcessor.DownloadErr - 0: </span><span style=color:#4e9a06>$src</span><span style=color:#4e9a06>, </span><span style=color:#4e9a06>${</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getMessage</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>superior</span> <span style=color:#ce5c00;font-weight:700>!</span> <span style=color:#000>Redownload</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=获取系统包路径>获取系统包路径</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>java -XshowSettings:properties -version		// java <span style=color:#0000cf;font-weight:700>8</span>
</code></pre></div><p>或：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PrintLibPath</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>){</span>
        <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;java.library.path&#34;</span><span style=color:#ce5c00;font-weight:700>));</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>javac PrintLibPath.java
java -cp /path PrintLibPath
/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib	<span style=color:#8f5902;font-style:italic># centos 6.5</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d63caab45f60227c8ca0af81e391a1e9>1.39 - 占位符</h1>
<p>Scala 的匿名函数语法<code>arg => expr</code>，提供来非常简洁的方式来构造函数字面值，甚至函数中包含<strong>多个语句</strong>。</p>
<p>同时，匿名函数中可以使用占位符语法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// equivalent
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>当时，如果在上面的例子中添加一个 debug 信息，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hi&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>Hi</span> 
<span style=color:#000>Hi</span> 
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span> 

<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hi&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>Hi</span> 
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>可以发现，结果并不符合预期。</p>
<p>因为函数经常被当做参数传递，经常可以看到他们被<code>{...}</code>包围。通常会认为大括号表示一个匿名函数，但是它只是一个<strong>块表达式</strong>：一条或多条语句，最后一条决定了这个块的结果。</p>
<p>上面的例子中，两个块被解析的方式不同，决定了他们的不同行为。</p>
<p>第一条语句中，<code>{ i => println("Hi"); i + 1 }</code>被认为是一个<code>arg => expr</code>方式的<strong>一个</strong>函数字面值语句，而<code>expr</code>在这里就是<code>println("Hi"); i + 1</code>。因此，<code>println</code>语句也是函数体的一部分，每当函数被调用时，他都会被执行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>printAndAddOne</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hi&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#000>printAndAddOne</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Int</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>function1</span><span style=color:#ce5c00;font-weight:700>&gt;</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>printAndAddOne</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>Hi</span> 
<span style=color:#000>Hi</span> 
<span style=color:#000>res29</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>第二条语句中，代码块被识别为<strong>两个</strong>表达式，<code>println("Hi")</code>和<code>_ + 1</code>，<code>println</code>语句并不是函数体的一部分，它会在整个语句块<code>{ println("Hi"); _ + 1 }</code>当做参数传递给 map 方法时执行，而不是 map 方法执行的时候。而整个块的计算结果，即最后一行语句的值，<code>_ + 1</code>，作为一个<code>Int => Int</code>的匿名函数传递给 map 方法。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>printAndReturnAFunc</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hi&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#000>Hi</span> 												<span style=color:#8f5902;font-style:italic>// println 语句已经被调用
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>printAndReturnAFunc</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Int</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>function1</span><span style=color:#ce5c00;font-weight:700>&gt;</span>	<span style=color:#8f5902;font-style:italic>// 整个块已经计算完成，得到匿名函数
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>printAndReturnAFunc</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>res30</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=总结>总结</h2>
<p>这个地方的关键是：<strong>使用占位符定义的匿名函数的作用域仅延伸到包含占位符(_)的表达式</strong>；<strong>普通语法的匿名函数，其函数体包含从标示符(=>)开始直到语句块结束</strong>。</p>
<p>普通语法的匿名函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>regularFunc</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Any</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#4e9a06>&#34;baz&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>regularFunc</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>String</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>function1</span><span style=color:#ce5c00;font-weight:700>&gt;</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>regularFunc</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>foo</span>
<span style=color:#000>hello</span>
<span style=color:#000>res0</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>baz</span>
</code></pre></div><p>占位符语法的匿名函数，下面这两个函数是等效的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>anonymousFunc</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_:</span> <span style=color:#204a87;font-weight:700>Any</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#4e9a06>&#34;baz&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>foo</span> 
<span style=color:#000>anonymousFunc</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>baz</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>confinedFunc</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Any</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>};</span> <span style=color:#4e9a06>&#34;baz&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#000>foo</span> 
<span style=color:#000>confinedFunc</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>baz</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-e7694efddd4c838bef0c4a0378a58212>1.40 - 多变量赋值</h1>
<p>如果需要以简便的方式对多变量赋值，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>MONTH</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>DAY</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>24</span> 
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HOUR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>但是结果并不符合预期：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>MONTH</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>12</span>
<span style=color:#000>DAY</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>24</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>console</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>error:</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>found:</span> <span style=color:#204a87;font-weight:700>value</span> <span style=color:#204a87;font-weight:700>HOUR</span>
       <span style=color:#204a87;font-weight:700>var</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HOUR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
            <span style=color:#ce5c00;font-weight:700>^</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>console</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>error:</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>found:</span> <span style=color:#204a87;font-weight:700>value</span> <span style=color:#204a87;font-weight:700>MINUTE</span>
       <span style=color:#204a87;font-weight:700>var</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HOUR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                  <span style=color:#ce5c00;font-weight:700>^</span>
<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>console</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>error:</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#204a87;font-weight:700>found:</span> <span style=color:#204a87;font-weight:700>value</span> <span style=color:#204a87;font-weight:700>SECOND</span>
       <span style=color:#204a87;font-weight:700>var</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HOUR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
                          <span style=color:#ce5c00;font-weight:700>^</span>
</code></pre></div><p>Scala 允许使用大写字母作为普通的变量名，就和 MONTH、DAY 一样并没有报错。但是第二条语句中使用的多变量赋值方式却不同。</p>
<p>因为<strong>多变量赋值</strong>实质上基于模式匹配，但是在模式匹配中，以大写字母开头的变量代表着特殊的意义：<strong>它们是稳定标示符</strong>。</p>
<p>稳定标识符是给常量预留的，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>TheAnswer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>checkGuess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>guess</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>guess</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>TheAnswer</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Your guess is correct&#34;</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Try again&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>checkGuess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>21</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// res8: String = Try again
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>checkGuess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// res9: String = Your guess is correct
</span></code></pre></div><p>相反，小写的变量名定义为<strong>变量模式</strong>，表示对变量的赋值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>var</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hour</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>minute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>second</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// hour: Int = 12 minute: Int = 0 second: Int = 0
</span></code></pre></div><p>因此在一开始的例子中，并不是对变量的赋值，而是对常量的匹配。</p>
<h2 id=总结>总结</h2>
<p>如果想要使用大写的变量名，在极端的情况下，会对当前作用域中的值进行匹配，这个模式匹配会编译成功，并且最终的结果依赖于值是否真正匹配：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>HOUR</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HOUR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 1 - 匹配成功
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>HOUR</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>13</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>;</span>
<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>var</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HOUR</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MINUTE</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>SECOND</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>12</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// 2 - 匹配失败
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>MatchError</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>12</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#a40000>0</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>of</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Tuple3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>在上面的第一个语句中，即便是匹配成功也不会进行任何赋值操作：<strong>稳定标示符在模式匹配期间不会进行任何赋值</strong>。</p>
<p>小写的变量名同样可以使用重音符(`)包围的方式当做稳定标示符，<strong>同时它们必须是 val</strong>,因此把他们当做常量来处理：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>theAnswer</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span> 
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>checkGuess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>guess</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>guess</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>`theAnswer`</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Your guess is correct&#34;</span> 
	<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#4e9a06>&#34;Try again&#34;</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

</code></pre></div><p>大写的变量名并声明为 var ，在 Scala 中是不推荐的做法，而且要完全避免。使用大写变量名来声明常量，同时，常量声明为 final。这样避免被子类覆写，同时编译器将他们内联(inline)以提升性能。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2d3c4f59227cb3d30510a031e3ed8e37>1.41 - 构造器</h1>
<h2 id=继承中的构造器初始化顺序>继承中的构造器初始化顺序</h2>
<p>很多编程语言通过构造器参数类初始化类的成员变量：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>param2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>...)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>member1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>param1</span> 
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>member2</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>param2</span> 
	<span style=color:#ce5c00;font-weight:700>...</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>在 Scala 中，构造器参数既是成员变量，避免了重复赋值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyClass</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>member1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>member2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>...)</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#ce5c00;font-weight:700>...</span> 
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是下面的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>audience</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> 
	<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>audience</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 通过成员实现接口字段
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BMember</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;World&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>audience</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a</span> 						
	<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I repeat: Hello &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>audience</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// 通过构造器实现接口字段
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>audience</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;World&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I repeat: Hello &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>audience</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BMember</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Readers&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Readers&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>其执行结果为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BMember</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Readers&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>Hello</span> <span style=color:#204a87;font-weight:700>null</span> 					<span style=color:#8f5902;font-style:italic>// &lt;======= null
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>I</span> <span style=color:#000>repeat</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Hello</span> <span style=color:#204a87;font-weight:700>Readers</span> 
<span style=color:#000>res3</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BMember</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BMember</span><span style=color:#204a87;font-weight:700>@</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000>aa6f6eb</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BConstructor</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Readers&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>Hello</span> <span style=color:#000>Readers</span> 
<span style=color:#000>I</span> <span style=color:#000>repeat</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Hello</span> <span style=color:#204a87;font-weight:700>Readers</span> 
<span style=color:#000>res4</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BConstructor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BConstructor</span><span style=color:#204a87;font-weight:700>@</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#000>b6603a</span>
</code></pre></div><p>这表示，A 中 audience 的值，随着该成员是在构造器参数列表中声明或在构造器体重声明而不同。</p>
<p>要理解这两种成员声明方式的不同，需要了解类测初始化顺序。B 的两种构造器都是以下面的形式声明：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>param1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>superclass</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>statements</span> <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>new BMember("Readers")</code>和<code>new BConstructor("Readers")</code>的初始化会以下面的序列进行：</p>
<ol>
<li>参数值 ”Readers“ 被求值，当然这里他直接是一个字符串，不需要计算，但如果他是一个表达式，比如<code>"readers".capitalize</code>，则会首先计算</li>
<li>被构造的类以下面的模板进行计算：<code>superclass { statements }</code>
<ol>
<li>首先，是 A 的构造器，A 的构造体</li>
<li>然后，是子类构造体</li>
</ol>
</li>
</ol>
<p>因此，在 BMember 中，第一步是将 &ldquo;Readers&rdquo; 赋值给构造器参数 a，然后是 A 的构造器被调用，但是这时成员 audience 还没有被初始化，所以默认值为 null。接着，子类 BMember 的构造体被执行，变量 a 的值被赋值给成员 audience，最终打印出了 audience 的值。</p>
<p>而 BConstructor 中，”Readers“ 被计算并以直接的方式赋值给 audience，因为这是构造器参数计算的一部分。因此当 A 的构造器被调用时，audience 的值已经被初始化为 ”Readers“。</p>
<h2 id=总结>总结</h2>
<p>通常，BConstructor 的模式作为首选的方式。</p>
<p>同样可以使用**字段提前定义(early field definition)**来实现同样的结果。这样可以支持你在构造器参数上执行额外的计算，或者以正确初始化的值来创建匿名类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BEarlyDef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;World&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>audience</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>}</span> 			<span style=color:#8f5902;font-style:italic>// 字段提前定义部分
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I repeat: Hello &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>audience</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BEarlyDef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Readers&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#000>Hello</span> <span style=color:#000>Readers</span> 
<span style=color:#000>I</span> <span style=color:#000>repeat</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Hello</span> <span style=color:#204a87;font-weight:700>Readers</span> 
<span style=color:#000>res7</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BEarlyDef</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BEarlyDef</span><span style=color:#204a87;font-weight:700>@</span><span style=color:#0000cf;font-weight:700>44</span><span style=color:#000>c93da7</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>audience</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Readers&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span>
	<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I repeat: Hello &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>audience</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>}</span> 
<span style=color:#000>Hello</span> <span style=color:#000>Readers</span> 
<span style=color:#000>I</span> <span style=color:#000>repeat</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Hello</span> <span style=color:#204a87;font-weight:700>Readers</span> 
<span style=color:#000>res0</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>anon1</span><span style=color:#204a87;font-weight:700>@</span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#000>e16512</span>
</code></pre></div><p>**提前定义(Early definitions)**在超类构造器调用之前定义并赋值成员。</p>
<p>因此，加上之前顺序后的完整顺序：</p>
<ol>
<li>执行子类构造器参数求值</li>
<li>执行字段提前定义</li>
<li>执行父类、父特质构造器、构造体，被混入的特质按照出现的顺序从左到右执行</li>
<li>执行子类、子特质构造体</li>
</ol>
<p>一个完整的示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>audience</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> 
	<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>audience</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>AfterA</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>introduction</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> 
	<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>introduction</span><span style=color:#ce5c00;font-weight:700>)</span> 
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BEvery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>audience</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#ce5c00;font-weight:700>{</span> 
	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>introduction</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Evaluating early def&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#4e9a06>&#34;Are you there?&#34;</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>}</span> 		<span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>A</span> 
	<span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>AfterA</span> <span style=color:#ce5c00;font-weight:700>{</span>
		<span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;I repeat: Hello &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>audience</span><span style=color:#ce5c00;font-weight:700>)</span> 
	<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>BEvery</span><span style=color:#ce5c00;font-weight:700>({</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Evaluating param&#34;</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#4e9a06>&#34;Readers&#34;</span> <span style=color:#ce5c00;font-weight:700>})</span> 
<span style=color:#000>Evaluating</span> <span style=color:#000>param</span> 				<span style=color:#8f5902;font-style:italic>// 参数计算
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Evaluating</span> <span style=color:#000>early</span> <span style=color:#204a87;font-weight:700>def</span> 			<span style=color:#8f5902;font-style:italic>// 提前定义计算
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Hello</span> <span style=color:#000>Readers</span> 					<span style=color:#8f5902;font-style:italic>// 第一个父类构造器、构造体计算
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Are</span> <span style=color:#000>you</span> <span style=color:#000>there</span><span style=color:#ce5c00;font-weight:700>?</span> 					<span style=color:#8f5902;font-style:italic>// 第二个父类构造器、构造体计算
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>I</span> <span style=color:#000>repeat</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Hello</span> <span style=color:#204a87;font-weight:700>Readers</span> 		<span style=color:#8f5902;font-style:italic>// 第三个匿名父类构造器、构造体计算
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>res3</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BEvery</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BEvery</span><span style=color:#204a87;font-weight:700>@</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000>bcc2569</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-663f6215142e23cccd6821d6c5df6f20>1.42 - 函数式入门</h1>
<p><a href="http://degoes.net/articles/easy-monads?utm_content=buffer827ff&utm_medium=social&utm_source=twitter.com&utm_campaign=buffer">翻译自：A Beginner-Friendly Tour through Functional Programming in Scala</a></p>
<p>函数式编程的基本核心十分简单：通过组合函数(function)来构建程序。</p>
<p>这里，“function”并非指“计算机科学”中的函数，它指一段机器代码，而是一个“<em>数理函数(mathematical  function)</em>”：</p>
<ol>
<li><strong>Totality</strong>：一个函数必须为所有可能的输入生成一个值；</li>
<li><strong>Determinism</strong>：一个函数必须为相同的输入返回相同的值；</li>
<li><strong>Purity</strong>：函数唯一的副作用必须是计算它的返回值。</li>
</ol>
<p>所有这些属性，给你一种前所未有的能力来解释你的代码：调用函数并传入任何输入，你总会得到一个有效的值，而且相同的输入总是会得到相同的结果，同时函数不会再做其他任何事，比如发射核导弹&mldr;.</p>
<p>这种微小的想法对于大型软件工程有着深刻的简化作用，因为这意味着，你的大脑只需要追踪更少的东西就能理解程序的行为。事实上，你可以通过理解程序的个别部分来理解程序的整个行为 - 而无需一次在脑子中掌握一切！</p>
<p>目前，函数式编程并不总是拥有一个“简单”的声誉，但我认为是由于以下几个因素：</p>
<ol>
<li><strong>Unfamiliarity</strong>(不太常见)：函数式编程与大多数专业人员使用的编程类型有着很大的不同。因为它不太常见，看起来很难的样子。最好是将函数式编程与第一次学习编程的经验相比较(而不是学习一种你已经知道的新的编程语言的经验)。</li>
<li><strong>Jargon</strong>(术语太多)：函数式编程中有太多术语，比如：“immutability”, “recursion”, “induction”, “hylomorphism”, “transducer”, “functor”等等一大堆。这些概念并不一定很难，但拥有可怕的冠冕堂皇的名字，命令式方式的大量编程经验也不能帮助你理解任何新的术语。</li>
<li><strong>Motivation</strong>(学习动机)：从我的经验来看，人们对于学习那些可以清晰的看到如何达成个人目标的东西会感觉更容易。然而，随着越来越多的人开始学习函数式编程(并与他人分享知识)，情况也在改善，但是对于函数式编程的核心概念并没有太大积极性。</li>
</ol>
<p>有时函数式编程通常被关联为“<em>高等静态类型函数式编程(advanced statically-typed functional programming)</em>”，这时，学习“函数式编程”的人其实在一次学习两种东西：函数式编程和一个高级类型系统(多数命令式语言拥有相对简单的类型系统)。</p>
<p>然而，有些人可以用弱类型语言进行函数式编程，或者使用高级类型系统进行命令式编程，因此这二者并无关联。</p>
<p>很多函数式开发者喜欢展示我们为何对函数式编程如此兴奋。然而，我所写的大部分内容并非对函数式的好奇，甚至不是面向新手函数式开发者。相反，我写的都是我感兴趣的东西，这通常是高级函数编程的中间形式，对于那些多年来一直在进行函数式编程的人比较有用。</p>
<p>所以我在做一个实验：我将展示一些函数式编程的思想以帮助我们构建一些实际程序。但是我会以一种有助于前面提到的那些因素的方式进行。</p>
<p>这是一篇为非函数式开发者准备的文章，或者那些了解一点但想知道更多的开发者。</p>
<p>希望你发现它会有用 - 但相比有用，我更希望你发现它鼓舞人心。激发足够的投入和必要的努力，来推动你的函数式编程知识，尽管看起来似乎会有点难。</p>
<p>或者也不一定，看完这篇文章之后一切看起来都会变得很容易！</p>
<h2 id=不切实际的-fp>不切实际的 FP</h2>
<p>展示函数式编程能力的一个典型例子就是泛型排序函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A:</span> <span style=color:#204a87;font-weight:700>Orderig</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>as</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Nil</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>after</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>as</span> <span style=color:#000>partition</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>before</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>sort</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>after</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个例子很漂亮，因为它展示了函数式编程如何以如此简化的效果来表达一个程序。</p>
<p>看完代码，你自己可能会确认下面这几点：</p>
<ul>
<li>空列表排序仍会得到空列表；</li>
<li>一个首元素为 a 后很 as 的列表，经过排序后由 小于 a 的列表、a、大于 a 的列表依次构成。</li>
</ul>
<p>该函数的每个部分都可以独立推理。如果相信一段是正确的，那么就可以相信整体的正确性。</p>
<p>此外，这个<code>sort</code>函数，因为它是数学意义上的函数，更容易测试和复用。我们可以传入任何列表并预期得到一个排序后的列表。因为我们知道对于同一个输入，函数总是会返回相同的结果。</p>
<p>因此我们的测试表示起来也会非常简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>assert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>assert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#0000cf;font-weight:700>3</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#a40000>2</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#a40000>1</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#a40000>2</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#a40000>3</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>(事实上，可以以函数式编程的方式来更加有力的表示，不过这就是另外一篇文章的主题了。)</p>
<p>虽然在这个例子中解释的函数式编程的好处看起来很简单，但这是一个很大的延伸，想象如果或如何对这些好处进行扩展以超越我们的玩具样例。</p>
<p>事实上，函数式编程的头号反对者就声称它只适合这些玩具例子，在”现实世界“编程中完全失败。</p>
<p>让我们找一个我们想到的现实世界中最简单的例子：一个函数失败时并不返回一个值。</p>
<h2 id=完整性>完整性</h2>
<p>我以完整性和正确性定义了一个例子，如果丢掉完整性要求会发生什么呢？</p>
<p>好吧，这个函数不需要返回任何东西。更实际的说，函数会一直运行，或者通过宿主语言支持的其他方式来转义这个返回值的需求 - 通常是抛出一个异常。</p>
<p>一个永不返回的函数是因为没有跳出而一直运行(脱离循环的边缘条件，或类似其他原因)，但异常又是什么呢？</p>
<p>在异常出现之前，程序员使用一个返回值来表示函数的成功或失败。在 C 代码中，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>parse_config</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>config</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>cfg</span><span style=color:#000;font-weight:700>){</span>
  <span style=color:#000>FileHandle</span> <span style=color:#000>handle</span><span style=color:#000;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>bytes</span><span style=color:#000;font-weight:700>;</span>
  
  <span style=color:#000>handle</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>new</span> <span style=color:#000>Handle</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000>handle</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>file_open</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;config.cfg&#34;</span><span style=color:#000;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handle</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
  
  <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>file_read</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#000;font-weight:700>);</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bytes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>
  <span style=color:#000;font-weight:700>.....</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>在这种世界里，引入异常处理似乎不可思议。程序员可以避免混乱的错误应用逻辑处理问题，从异常的短路行为中获益。</p>
<p>异常的主要问题是，在一个支持它的语言中，你无法保证他们可能会发生的地方。这意味着他们可能在任何地方触发。这表示，如果时间够长，他们可以无处不在(甚至在 Java 中，未检异常可以随处抛出，其中经常还包含受检异常！)。</p>
<p>同时由于 null 的存在，导致激增了大量防御性、攻击性的异常处理，尽管有些并没有什么意义，但导致了更多错误的发生和怪异的边缘问题。</p>
<p>幸运的是，我们可以轻松的同时实现完整性和整洁代码，但比老旧语言需要更多设施的支持。</p>
<p>我了实现这个想法，我们定义一个函数来返回列表的第一个元素：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span>
</code></pre></div><p>这个函数并不完整，取决于你传入的是一个什么列表，可能会返回可能也不会返回列表的首元素。如果你传入一个空列表，函数永远都不会返回，而不是抛出一个异常。</p>
<p>如果想要该函数完整，仅需要引入一个数据结构来建模<em>optionality</em>的概念 - 一个东西可能有也可能没有。</p>
<p>让我们称之为<code>Maybe</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Maybe</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>There</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Maybe</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>NotThere</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Maybe</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>通过这个数据结构，我们可以把这个”伪函数“<code>head</code>转换为真的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Maybe</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>as</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>NotThere</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]()</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>There</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在当我们考虑使用该函数的代码时，不再需要考虑该函数没有返回的可能性。因为该函数总是能够返回。由于不需考虑这种可能性，使用<code>head</code>函数的代码表述起来也更为简单，包含更少需要分享的场景。</p>
<p><code>Maybe</code>数据结构并没有提供跟异常一样的能力。有一条，它不会包含任何对于<code>head</code>函数来说意味着 OK 的错误信息(因为我们知道错误是什么-空列表)，但对于其他函数来说可能并不有效。</p>
<p>为了解决这个问题，我们可以引入一个新的数据结构，称为<code>Resullt</code>，对<em>exceptionality</em>进行建模：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>error</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>这种类型支持我们创建一个<code>file_open</code>这样的完整性函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>file_open</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>path</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FileError</span>, <span style=color:#204a87;font-weight:700>FileHandle</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
</code></pre></div><p>现在我们可以拥有跟异常一行的信息。然而，如果我们需要很多操作需要执行，同时每个操作都返回一个<code>Result</code>，这看起来我们会拥有相当多的模板代码，不免让人回忆起异常之间的日子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>parse_config</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FileError</span>, <span style=color:#204a87;font-weight:700>Config</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>file_open</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;config.cfg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>file_read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bytes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>???</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>我们已经创建了<code>file_open</code>、<code>file_read</code>函数，等等，简化了我们的表述，同时也引入了不少模板代码，使代码难以阅读。</p>
<p>为了夺回之前异常的优势，我们需要识别上面代码的模式。如果你研究几分钟，则会发现下面的模式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>doX</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>doY</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>doZ</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>doW</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>...</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>你会发现，<code>doY</code>、<code>doZ</code>、<code>doW</code>都会从上一个操作产生的<code>Result[E, A]</code>那接收一个 A，然后生成一个新的<code>Result[E, A]</code>。</p>
<p>这暗示我们可以通过一个<code>chain</code>方法分解重复的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在，可以使用<code>chain</code>方法来重新实现原来的<code>parse_config</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>parse_config</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FileError</span>, <span style=color:#204a87;font-weight:700>Config</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file_open</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;config.cfg&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>handle</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
    <span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file_read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>)){</span> <span style=color:#000>bytes</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#ce5c00;font-weight:700>???</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样通过在<code>Result[E,A]</code>上调用<code>chain</code>来减少模板代码。通过这种方式，我们既可以拥有异常的短路优势，错误处理逻辑又由<code>chain</code>方法拆分，应用逻辑就无需再关注这些。</p>
<p>如果你使用<code>Result</code>这样的结构来建模异常场景，通常你会发现需要一个下面这样的工具方法：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// change the A in a Result[E, A] into a B by using the provided function f
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>change</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>result</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这是一个类 map 的函数(将列表中的元素映射为其他类型)。如果你喜欢 OO 风格，可以把<code>chain</code>、<code>change</code>方法包括在<code>Result</code>类之中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>change</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>error</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>;</span><span style=color:#000>ass</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>这样一来代码就会更可读：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>parse_config</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FileError</span>, <span style=color:#204a87;font-weight:700>Config</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>file_open</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;config.cfg&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>chanle</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
    <span style=color:#000>file_read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>chain</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>bytes</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#ce5c00;font-weight:700>???</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>更进一步，如果你把<code>change</code>、<code>chain</code>方法称作<code>map</code>、<code>flatMap</code>，Scala 则会提供更加灵巧的方式来进一步简化代码格式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>parse_config</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Result</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>FileError</span>, <span style=color:#204a87;font-weight:700>Config</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>handle</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>file_open</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;config.cfg&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>bytes</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>file_read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handle</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>最终，我们首先了函数的完整性，同时也拥有异常的短路特性和关注点分离。</p>
<p>我们所需要的也就是<code>chain</code>函数(即 flatMap)和<code>Result</code>数据结构。其余的则自然引入。</p>
<p>注意，<code>chain</code>函数接收一个函数作为参数。这个参数作为一个匿名函数(在其上下文中捕获任意引用)提供，这论证了为什么这种技术永远不会出现在 C 代码中。如果 C 拥有一类函数、垃圾回收或者引用计数，很可能这种模式会自行出现而无需函数式编程社区的任何输入。</p>
<p>函数的其他要求是<strong>确定性</strong>和<strong>纯洁性</strong>，下面的章节会讲到。</p>
<h2 id=确定性--纯洁性>确定性 & 纯洁性</h2>
<p>一个函数，如果拥有不确定性，或者所做的并非仅仅是计算一个返回值，那它就会变得非常难以推理。</p>
<p>比如我用过的一个库，会在构造器中执行 IO：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Logging</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>OutputStream</span> <span style=color:#000>ostream</span><span style=color:#ce5c00;font-weight:700>;</span>
  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>logging</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>File</span> <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>){</span>
    <span style=color:#000>ostream</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FileOutputStream</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>);</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该构造器可能会抛出异常，并且难以预料！</p>
<p>另一个例子，当你把 Java 中的<code>URL</code>类放入一个数据结构时，它会执行一个网络连接。原因是 equals 和 hash 编码方法会触发地址的识别。</p>
<p>除了不纯函数的意味性质外(谁知道他们什么时候会干些什么！)，非确定性(non-determinism)导致函数的测试和表述变得尤其困难。你可能会被迫对影响函数行为的那些状态的表述代码进行 mock。</p>
<p>纯函数，确定性函数，在现场之外不会做任何不正当的事。你可以期望他们每次都会根据相同的输入返回相同的结果，这意味着代码容易测试且易于理解。</p>
<p>但如果你尝试使所有的函数都是完整的、确定的，并且是纯的，当你执行一些输入输出或副作用操作时则会很快撞到墙上 - 一堵说明了太多函数式编程与真实软件不切实际的墙。</p>
<p>事实上，这墙早就被粉碎了，而不是沿着这条路走下去，让我们看一下一个 IO 的例子，看能不能推荐一种方案。</p>
<h3 id=console-io>Console IO</h3>
<p>假如我们正开发一个控制台程序，改程序需要从控制台读取输入，然后再会写数据到控制台上。这样的程序能解决很多有用的问题，如果我们能想出如何以确定性、纯函数的方式来构建一个控制台程序，那就能推广到其他类型的程序了。</p>
<p>如果你针对该问题思考了一会，可能会得出下面的想法：可以定义一些描述控制台副作用的数据结构来构建程序，而不是调用那些不确定或不纯的函数。</p>
<p>假如这个<code>ConsoleIo</code>是我们这个程序的说明书，首先，我们需要一种方式来描述”写入输入到控制台“这种副作用。</p>
<p>一种方式看起来可能会是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span>
</code></pre></div><p>这种方式未免也太简单了，因为这样我们只能将文本的一行写入到控制台：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>helloWorld</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello World!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这是一个完整的、确定的纯函数 &ndash; 但是并没有什么卵用。它顶多能描述一个程序将文本的一行写入到控制台。文本可能会变，当然，甚至是函数的一个参数，但最终，程序只会对控制台有一个副作用。</p>
<p>幸运的是，将该结构扩展为支持多个顺序的副作用也很简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>then</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span>
</code></pre></div><p>通过这种方式，我们可以描述更加复杂的”副作用化“程序，比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>infiniteHelloWorld</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello World&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>infiniteHelloWorld</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>如果我们引入一个”thunk“以避免在构造中压栈(blow stack)，该结构就能够描述一个向控制台写入无限个”Hello World“的程序。像这种无限制的程序并没有什么用，不过我们可以给<code>ConsoleIO</code>添加另一项，让他可以支持终止：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>then</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>End</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span>
</code></pre></div><p>现在我们可以描述一个将文本行打印指定次数到控制台的程序：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>printTextNTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>End</span>
  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>printTextNTimes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>text</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>该函数也是一个完整的、确定的纯函数。当然，他实际上不会打印任何东西到控制台，但我们很快就能做到。</p>
<p>目前，我们只能描述一个写入文本到控制台的程序。因此扩展一个从控制台读取输入的程序也相当简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>then</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>process</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>object</span> <span style=color:#000>End</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span>
</code></pre></div><p>注意构造一个<code>ReadLine</code>的值时我们需要提供一个函数，传入从控制台读到的行，返回另一个<code>ConsoleIO</code>，代表该副作用程序的剩余部分。</p>
<p>我们向<code>ReadLine</code>传入一个函数，它作为一个保证，将来的某个时间某人会通过控制台给我们一行输入，然后我们再将其返回给程序的”剩余“部分。</p>
<p>该结构有足够的能力来描述我们的交互程序。比如，下面的程序会问你的名字并向你 Say hello：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>socialProgram</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#4e9a06>&#34;hello, what is your name?&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
    <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>End</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>记得这是一个完整的、确定的纯函数。人们想象使用这个结构来描述非常复杂的副作用程序。事实上，任何仅需要控制台 IO 的程序都可以使用该结构来描述。</p>
<p>注意任何使用<code>ConsoleIO</code>描述的程序都会在某个点终止。这些程序不能返回一个值。</p>
<p>如果我们需要这样的”控制台式程序“：该程序生成的东西在其他程序又能够使用。这样我们需要泛型化<code>End</code>来接收一些类型为<code>A</code>的值，这迫使我们需要给<code>ConsoleIO</code>添加一个新的类型参数<code>A</code>，并贯穿于其他项。</p>
<p>最终的结果看起来稍微有点复杂：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>then</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>process</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EndWith</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>现在，<code>ConsoleIO[A]</code>能够描述一个读写控制台并被一个类型为<code>A</code>的值终止的程序。这支持我们构建生成值的程序，然后这些值再被其他程序消费。</p>
<p>我们能够使用该结构创建之前的”Hello, !“程序，但这次，我们能从程序中返回用户的名字：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>userNameProgram</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span>
  <span style=color:#4e9a06>&#34;Hello, what is your name?&#34;</span><span style=color:#ce5c00;font-weight:700>,</span>
  <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
    <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>EndWith</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>))</span>  
  <span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p><code>ConsoleIO</code>中我们唯一丧失的是修改返回值类型的能力。比如，你想构建另一个程序并不是返回用户名，而是名字的长度，如何复用<code>userNameProgram</code>呢？</p>
<p>当前这种方式是不可能的。我们需要一些更强大的东西来实现这个打算。如果我们拥有一个 List 则可以使用 map 来改变结果类型。而这正是<code>ConsoleIO</code>所需要的。</p>
<p>我们可以直接给他添加一个 map 函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>then</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>process</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EndWith</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A0</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>现在给出任何一个<code>ConsoleIO[A]</code>，我们都可以通过函数<code>A => B</code>将其转换为<code>ConsoleIO[B]</code>。因此现在我们可以编写一个新的<code>userNameLenProgram</code>，计算用户名字的字符长度：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>userNameLenProgram</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>userNameProgram</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>随着<code>map</code>的加入，<code>EndWith</code>的作用发生了改变：我们不再需要它从程序中返回一个值，因为我们可以把拥有的任何值转换为返回值。比如你有一个<code>ConsoleIO[String]</code>，我们可以通过一个<code>String => Int</code>函数转换为<code>Console[Int]</code>。</p>
<p>然后，<code>EndWith</code>仍然可以用于构造一个不执行任何副作用的“纯“程序(但能够与其他程序组合)。因此它仍然是有用的，虽然与其最初的目的不同。因此，我们可以将其重新命名为<code>Pure</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>then</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>process</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A0</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>通过这些封装，我们可以没有任何限制和约束的构建并复用这个控制台 IO 程序。所有这些描述都是拥有确定性、完整性的纯函数，因此也获得了函数式代码的强大优势：易于理解、易于测试、易于安全的调整，且易于组合。</p>
<p>最终 ，我们需要把一个程序的描述转换为实际的程序-一个能真正执行副作用的程序(这意味这没有确定性、也不纯)。通常这个程序会叫做<em>interpretation</em>。</p>
<p>可以写一个简单的，如果没有确定性、也不纯洁，解释器可以基于<code>ConsoleIO[A]</code>使用一下类似的代码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>program</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>program</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>process</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>process</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readLine</span><span style=color:#ce5c00;font-weight:700>()))</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>value</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>还有更好的方式，不过这里就不再过多演示了。到目前为止，我认为这已经相当有意思了，我们同时能够描述一个充满副作用的，但是又满足完整性、确定性、纯函数的要求，又能很方便的转换为一个真实执行副作用的程序。</p>
<p>注意，这种转换需要、也非常必要在程序的最后进行(将副作用尽可能推迟到最后)！在 Haskell 中，这会发生在 Haskell 运行时的主函数之外。然而在其他的语言中，背后并没有这些函数式级别的机制支持，你总是可以在程序的入口点以副作用的方式来解释你的程序。</p>
<p>这么做是为了确保你在程序中拥有最大程度的完整性、确定性以及纯洁性。在你边缘的地方，你可能有个小层很难去表示，但正是在这里来基于底层将程序转换为可执行副作用的描述。</p>
<h3 id=可扩展性>可扩展性</h3>
<p>这种方式在一个固定副作用集的世界里会运行的很多好。在我们目前的用例中，控制台 IO—从一个控制台读写文本行。但是在实际的程序中，多种原因之下的副作用要复杂的多，我们受益于使用不同的副作用组合进所有副作用来构建程序的能力。</p>
<p>第一步是识别附加结构。实质上，我们可以把对控制台程序的描述拆分成生成值(WriteLine)和接收值(ReadLine)。程序剩余的部分则是由纯模板组成：要么是通过映射(map)返回值将一个程序转换为另外一个，要么是，一个程序依赖另外一个程序的结果，将这两个程序进行链接(chain/flatMap)。</p>
<p>如果这没有任何意义，可以研究一下下面的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#000>ConsoleIP</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chis</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span>,<span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A0</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>这里只有一点不同，增加了更多令人迷惑的方式来表示同一个东西。使用这个结构，我们的交互程序会表示的更复杂一点：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>userNameProgram</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span>
    <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;What is your name?&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
    <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span>
      <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>(),</span>
      <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span>
        <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
        <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>在这个模型中，<code>ConsoleIO</code>拥有一组看上去泛型的项，chain、Map、Pure，他们不会跟我们控制台程序的副作用打交道，另外又有两个额外的项用来描述这些副作用：ReadLine、WriteLine，他们在这个模型中则被简化了。</p>
<p>这种模型构建的解释器也会有一点复杂：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>program</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>program</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#ce5c00;font-weight:700>();</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>readLine</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>value</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>interpret</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种简明的描述看起来不会完全不同，但关键点在于只有两项用来描述副作用，剩余则都是纯函数装置。这些装置可以被抽象到另一个类然后复用于其他所有的副作用类型。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Effect</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A0</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>,<span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>,<span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A0</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A0</span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>,<span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ConsoleF</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>line</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleF</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ConsoleF</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleF</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p><code>Sequential</code>来并不直接引用<code>ConsoleIO</code>，因此可以复用与其他不同的副作用类型。</p>
<p>这允许我们清晰地将副作用从计算拆分开。因此新版本的 hello world 程序看起来会是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>userNameProgram</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleF</span>, <span style=color:#204a87;font-weight:700>Unit</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span>
    <span style=color:#000>Effect</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleF</span>, <span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;What is your name?&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span>
    <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleF</span>, <span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span>
      <span style=color:#000>Effect</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleF</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>()),</span>
      <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Chain</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleF</span>, <span style=color:#204a87;font-weight:700>Unit</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>](</span>
        <span style=color:#000>Effect</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleF</span>, <span style=color:#204a87;font-weight:700>Unit</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span>
        <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果我们利用 Scala 的 for 符号，然后添加一个隐式类来更方便的将副作用包含到<code>Effect</code>的构造器中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>userNameProgram</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;What is your name?&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>effect</span>
    <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>ReadLine</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>effect</span>
    <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>WriteLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>effect</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>name</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种方式可以进一步简化，比如，为所有项添加帮助函数。这些函数使程序更加简洁：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>userNameProgram</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ConsoleIO</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>writeLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;What is your name?&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>readLine</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>writeLine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hello &#34;</span><span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>name</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这与上一种实现没有什么不同。结构也大致相同，仅有一点语法不同。在我们的例子中，我们构建了一个程序的<em>description</em>，完整、确定的纯函数，他本身对外部世界没有任何副作用(除了利用 CPU 和内存来计算结构)。</p>
<p>此外，使用这种清晰的分离，实际的副作用集也可以进行扩展。这意味着我们可以在两个程序中使用采用不同的副作用，然后组合成一个程序来同时拥有两种副作用。</p>
<p>为了达到这种效果，你仅需要一些”EitherOr“来表达这是一种副作用(控制台 IO)或是另一种副作用(文件 IO)：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>EitherOr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>G</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IsLeft</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>G</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>left</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>EitherOr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span>, <span style=color:#204a87;font-weight:700>G</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IsRight</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>G</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>right</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>G</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>EitherOr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>G</span>, <span style=color:#204a87;font-weight:700>G</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>CompositeProgram</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Sequential</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>EitherOr</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>ConsoleIO</span>, <span style=color:#204a87;font-weight:700>FileIO</span>, <span style=color:#204a87;font-weight:700>?</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>可以基于这个结构来时间简洁的解释器，并可以根据指定的副作用类型(控制台或文件)复用到其他的解释器中。</p>
<p>现在我们已经从第一个原则开发到这，而且没有任何术语，你看到的这种抽象实际上称为著名的”Free monad“，它让不知情的 Scala 程序员无处不在害怕！</p>
<p>这看起来不是太糟，对吧？</p>
<p>在我们结束整个教程之前，看一下这种抽象的其他好处。</p>
<h2 id=纯函数的能力>纯函数的能力</h2>
<p>通常对这种副作用的编码方式的反应是，”有什么意义？“</p>
<p>使用这种风格来描述副作用化程序确实有一些非常实际的好处，</p>
<ul>
<li>你的程序的类型精确描述了它到底能做什么。因为没有无处不在的大块机器代码嵌入，代码推理能做的事就变得非常简单。相反，你以声明的方式准确描述了你的程序是什么(或更进一步，你描述是了如何将一个抽象层的副作用转换为一个较低抽象层的副作用)。</li>
<li>你可以将程序的描述与其实际所做的事分开。例如，一个 Web 应用程序可以创建 HTML，但这样的描述可以解释为 HTML DOM 节点，Canvas 节点，或服务器上的 PDF。</li>
<li>你可以模拟依赖。如果你的外部依赖(文件系统、网络、API 等)都由数据结构描述，那么你可以轻松遍历这些数据结构，以确保你提供了正确的值，他们也返回了正确的响应。与 mock 库不同，这种方式是完全类型安全的，而却不需要任何运行时支持。</li>
<li>你可以在程序运行时执行检查。比如，你可以添加日志行，以打印出每个指令要做什么，以及是否成功。这些日志可以是相当详细的，可以取代手工日志的需要。或者跟多，他们可以在组合解释器时”编织(wave in)“进去，日志在被禁用时可以没有任何开销。没有模板代码也没有开销—对我来说听起来真的不错。</li>
<li>除了日志，你可以在运行时将整个切面添加到程序中。比如添加认证、授权、审计，仅通过组合解释器而无需修改代码库。就像面向切面编程，但更加类型安全且灵活。</li>
</ul>
<p>除了所有的这些好处之外，你还可以得到非常明显的好处，能够很好的推理，完整、确定、纯函数，即使是存在副作用的情况下。这些好处可以是新的开发者收益，维护已有的代码、解决 bug，引进新的团队成员等等。</p>
<h2 id=总结>总结</h2>
<p>我希望至少文章中涵盖的部分创造了一些意义。更重要的是，我希望你们看到我们是如何使用完整的、确定的纯函数编写完整程序，以及这种方式带来的好处，其中一些也是我们刚刚发现的。</p>
<p>如果没有别的，这是一个学习更多函数式编程的呼唤！尽管拥有奇怪的名字、不完整的文档、混乱的类型也要坚持下去。</p>
<p>函数式编程非常有力，拥有巨大的力量。根据我的经验，那些花时间学习函数式编程的人最终会变得对他充满热情，永远不会回到过去的老路上。函数式编程给了开发者强大的力量—以简化的方式编写软件并输出简洁代码的能力，维护成本更低，更易组合、更易推理，等等等等。</p>
<p>如果你有兴趣，我期待你坚持下去，如果你卡主了，你要知道我还有社区的其他很多成员都站在你背后。我们会帮助你达到下一个层次，从值到值，从类型到类型，从 lambda 到 lambda。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-58efa20d1b7da0d021300667f5f8e5f3>1.43 - Monoid</h1>
<blockquote>
<p>整理自《Functional Programming In Scala》第十章。</p>
</blockquote>
<p>Monoid(幺半群) 是一个代数定义，是*纯代数(purely algebraic)*的一种，它简单、普遍存在且很实用。除了满足同样的代数法则外不同 Monoid 实例之间很少有关联，但这种代数结构定义了用于实现实用的多态函数所必须的所有法则。</p>
<p>操作列表、连接字符串或在循环中累加都可以被拆解成 Monoid。下面介绍它在两个方面的使用方式：将问题拆分成小部分然后并行计算；将简单的部分组装成复杂的计算。</p>
<h2 id=1-什么是-monoid>1. 什么是 Monoid</h2>
<p>比如在字符串拼接的代数表达中，“foo” + “bar” 得到“foobar”，空串是这个操作的<em>单位元(identity)</em>(或称“幺元”)元素，即 “”+s 与 s + “” 的值都是 s。进一步，如果将三个串相加，r + s + t，由于这个操作是可结合的(associative)，因此 (r +s) +t 与 r + (s+t) 的结果是一样的。</p>
<p>该规则同样适用于整数相加，它也是可结合的。(x+y)+z 与 x +(y+z) 的结果相同，而且由一个单位元素 0，它去其他整数相加时不会影响结果。同样乘法也是一样，它的单位元元素是 1。</p>
<p>布尔操作符 || 和 && 同样是可结合的，它们的单位元元素是 true 和 false。</p>
<p>像这样的代数便成为 Monoid，结合律(associativity)和同一律(identity)则一起被称为<em>monoid法则</em>。一个 Monoid 由如下几部分构成：</p>
<ul>
<li>一个类型 A；</li>
<li>一个可结合的二元操作 OP，接收两个参数后返回相同类型的值，对于任何<code>x:A, y:A, z:A</code>来说，<code>OP(OP(x,y), z)</code>和<code>OP(x, OP(y,z))</code>是等价的；</li>
<li>一个值<code>zero:A</code>，它是一个单位元，对于任何<code>x:A</code>来说，<code>zero</code>与它的操作都等于 x 自身：<code>OP(x, zero) == x</code>或<code>OP(zero, x) == x</code>。</li>
</ul>
<p>可以使用 Scala 表示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a2</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后是 String 实例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>stringMonoid</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a2</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>a2</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>或者是 List 的连接：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// 注意这里是 def，一个返回 Monoid 实例的函数，否则将丢失类型参数 A
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>listMonoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a1</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>a2</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a1</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>a2</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Nil</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>“有”一个 Monoid，还是“是”一个 Monoid：</p>
<p>当程序员和数学家讨论：一个类型是 Monoid，或，有一个 Monoid实例，有两种不一致的表述方式。程序员易于认为一个<code>Monoid[A]</code>的实例是 Monoid，但这并不准确。Monoid 实际上是类型和定义法则的实例。更准确的说是类型 A 和 <code>Monoid[A]</code>实例定义的操作构成了一个 Monoid。</p>
</blockquote>
<p><strong>一个类型、一个此类型的二元操作(满足结合律)、一个单位元元素，这三者构成一个 Monoid。</strong></p>
<h2 id=2-使用-monoid-折叠列表>2. 使用 Monoid 折叠列表</h2>
<p>Monoid 和列表联系紧密，从 List 的<code>foldLeft</code>/<code>foldRight</code>签名中可以发现参数的类型很特别：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span>
</code></pre></div><p>当 A 和 B 类型一样时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span>
</code></pre></div><p>如果一个字符串的列表，可以传递 StringMonoid 中的 OP 和 zero，用于将字符串进行拼接：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>words</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Hic&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Est&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Index&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>words</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stringMonoid</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>stringMonoid</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// &#34;HicEstIndex&#34;
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>t</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>words</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>stringMonoid</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>stringMonoid</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// &#34;HicEstIndex&#34;
</span></code></pre></div><p>会发现两个操作的结果一样，这正是因为结合律与同一律法则，无论左右结合效果都一样。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>words</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;Hic&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;Est&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;Index&#34;</span>
<span style=color:#000>words</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;Hic&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Est&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Index&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>可以编写一个通用的 concatenate 函数，使用 Monoid 去折叠列表：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>concatenate</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>m</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>但是假如列表中的元素类型不是 Monoid 实例该如何处理呢，总是可以将列表 map 成另外的类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>m</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span>
</code></pre></div><h2 id=3-结合律与并行化>3. 结合律与并行化</h2>
<p>Monoid 操作的结合律意味着可以自由选择如何进行数据结构的折叠操作。前面展示了使用列表的 foldLeft 和 foldRight 去调用满足结合律的函数，对列表按照顺序向左或向右的 reduce。如果有个 Monoid 可以使用*平衡折叠法(balance fold)*对列表进行 reduce，这样一些操作可能更加高效或支持并行化。</p>
<p>假设一个有序集 a, b, c, d，三种不同的折叠方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>)))</span>	<span style=color:#8f5902;font-style:italic>// foldRight
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// foldLeft
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>))</span>	<span style=color:#8f5902;font-style:italic>// balance fold
</span></code></pre></div><p>在平衡折叠中，因为两个 op 是独立的，因此支持同时运行。当每个 op 的时间花费与参数的长度成正比时平衡树的结构可以变得更加高效，比如下面的表达式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lorem&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;ipsum&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;dolor&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;sit&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>其求值轨迹为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lorem&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;ipsum&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;dolor&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;sit&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;ipsum&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;dolor&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;sit&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lorem&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dolor&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;sit&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;loremipsum&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sit&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;loremipsumdolor&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;loremipsumdolorsit&#34;</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#4e9a06>&#34;loremipsumdolorsit&#34;</span>
</code></pre></div><p>每次折叠，分配一个临时的字符串(foldLeft 的第一个参数)然后丢弃，下次又要分配一个更大的字符串。字符串的值是不变的，当 a + b 时，需要分配一个字符数组然后将 a 和 b 的值复制到这个新数组。这个时间花费与 a、b 的总长度是成正比的。相比更高效的方式是对半组合顺序集，先构建“loremipsum”和“dolorsit”，然后将他们加在一起。</p>
<h2 id=4-例子并行解析>4. 例子：并行解析</h2>
<p>如果需要统计字符串中的单词数，可以按顺序扫描字符串，寻找空格然后对连续的非空格字符计数。这样按顺序解析，解析器的状态可以表达成最后一个字符是否是空格。</p>
<p>但是如果要处理一个巨大的文件，达到单机内存装不下，需要对文件进行切分才能处理。策略是将文件拆分成多个可以管理的块(chunk)，并行处理这些块，最后将结果合并起来。这时，解析器的状态可能会复杂一些，需要可以合并中间结果，无论这个部分是文件的开头、中间或结尾。这意味这合并操作需要时可结合的。</p>
<p>把下面的字符串当做一个大文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;lorem ipsum dolor sit amet&#34;</span>
</code></pre></div><p>假如对半拆分字符串，可能会将一个单词拆分。当累加这些字符串的计算结果时需要避免重复计入同一个单词。所以这里仅仅将单词作为整体来计数是不严谨的。需要一个数据结构能处理部分结果，并能记录完整的单词。单词计数的结果则可以表示成一个代数数据结构：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>WC</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Stub</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>chars</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>WC</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Part</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lStub</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>words</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>rStum</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>WC</span>
</code></pre></div><p><code>Stub</code>表示没有看到任何完整的单词，<code>Part</code>保存看到的完整的单词的个数，以及左边的部分单词和右边的部分单词。</p>
<p>比如上面的字符串，拆分成“lorem ipsum do”和“lor sit amet”，对前者计数的结果为<code>Part("lorem", 1, do)</code>，对后者的计数结果为<code>Part("lor", 2, "")</code>。</p>
<blockquote>
<p>Monoid 同态</p>
<p>可能你会发现 Monoid 的函数之间有个法则。比如字符串的连接 Monoid 和整数累加 Monoid。假如取两个字符串的长度相加，等于连接两个字符串然后取其长度：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>length</span>
</code></pre></div><p><code>length</code>是一个函数，它将 String 转化为 Int 并保存 Monoid 结构。这样的结构称为<strong>Monoid 同态(homomorphism)</strong>，一个 Monoid 同态 f 定义为在 Monoid M 和 N 之间对所有的值及 x、y 都遵守以下规则：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>M</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>N</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>当设计自己的库时这个特性很有用，加入两个类型是 Monoid 并且他们之前存在函数，好的做法是考虑这个函数是否可以保持 Monoid 结构，并且测试其是否为 Monoid 同态。</p>
<p>某些时候两个 Monoid 之间是双向同态的，**同质(isomorphic)**是在 M 和 N 之间存在的两个同态的函数 f 和 g，而且<code>f andThen g</code>和<code>g andThen f</code>是等同的函数。</p>
<p>比如， String 和 <code>List[Char]</code> monoid 的连接操作是同质的。两个 Boolean monoid (false, ||) 和 (true, &&)通过取反(!)同样也是同质的。</p>
</blockquote>
<h2 id=5-可折叠数据结构>5. 可折叠数据结构</h2>
<p>现在需要为 IndexedSeq 实现一个折叠函数。一般处理这类数据结构中的额数据时，通常不在意具体结构是什么，也不在意是否延时或者提供有效的随机读写，等等。</p>
<p>比如有个结构中是整形，需要计算他们的总和，可以使用 foldRight：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>ints</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>不需要关心 ints 的具体结构类型，他可以是 Vector、Stream 或其他列表，或者任何一个包含 foldRight 方法的类型。把这种通用性表达成下面的 trait：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Foldable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>mb</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>concatenate</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>m</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里抽象出一个类型构造器 F，就像在之前章节中构建的 Parser 类型。表示为<code>F[_]</code>，这里的下划线表示 F 不是一个类型而是一个类型构造器，它接收一个类型参数。就像接收别的函数作为参数的函数被称为高阶函数，Foldable 是<strong>高阶类型构造函数</strong>或<strong>高阶类型</strong>。</p>
<h2 id=6-monoid-组合>6. Monoid 组合</h2>
<p>Monoid 的真正强大之处在于组合。比如 类型 A、B 是 Monoid，那么 Tuple 类型 (A, B) 也是 Monoid (称 product)。</p>
<h3 id=61-组装更加复杂的-monoid>6.1. 组装更加复杂的 Monoid</h3>
<p>只需要包含的元素是 monoid，某些数据结构就能构建成 Monoid。比如当 value 类型是 Monoid 时，合并 key-value 映射的操作就能够构建 monoid：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mapMergeMonoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>K</span>, <span style=color:#204a87;font-weight:700>V</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>V</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>V</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>K</span>, <span style=color:#204a87;font-weight:700>V</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>K</span>, <span style=color:#204a87;font-weight:700>V</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>K</span>, <span style=color:#204a87;font-weight:700>V</span><span style=color:#ce5c00;font-weight:700>]()</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>K</span>,<span style=color:#204a87;font-weight:700>V</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>K</span>,<span style=color:#204a87;font-weight:700>V</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> 
      <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>keySet</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>keySet</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>updated</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>op</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>V</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>)))</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用这个简单的组合子(combinator)既可以组装出复杂的 Monoid：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>m</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Monoid</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]]]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>mapMergeMonoid</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapMergeMonoid</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>intAddition</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><h3 id=62使用组合的-monoid-融合多个遍历>6.2.使用组合的 Monoid 融合多个遍历</h3>
<p>多个 Monoid 可以被组合在一起，则折叠数据时可以同时执行多个计算。比如同时获得一个列表的总和与长度，来计算平均值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>m</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>prodocutMonoid</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>intAddition</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>intAddition</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>p</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>listFoldable</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>))(</span><span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>))(</span><span style=color:#000>m</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>mean</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>2.</span><span style=color:#000>toDouble</span>	<span style=color:#8f5902;font-style:italic>//=&gt; 2.5
</span></code></pre></div><h2 id=7-总结>7. 总结</h2>
<p>Monoid 是第一个纯抽象代数，它定义为抽象的操作和对应的法则。可以在不知道参数是什么，仅知道其类型可以构建 monoid的情况下编写可用的函数。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-29a2d99f28d355138d14c07506d82cc2>1.44 - 函数式与类型类</h1>
<p><a href=https://alexn.org/blog/2012/11/02/scala-functional-programming-type-classes.html>翻译自原文：On Scala, Functional Programming and Type-Classes</a></p>
<p>我曾经在 Coursera 上追随一个名为“ <a href=https://www.coursera.org/course/progfun>Functional Programming Principles in Scala</a>”的精彩课程，该课程由 Martin Odersky(Scala 作者) 执教。这并不是我第一次遇到 Scala，因为我已经把它用在了日常工作当中。与此同时，我感觉需要找一个 Javascript 语言的替代者，因为优秀的 ClojureScript，我也开始了对 Clojure 的学习。</p>
<p>我对这两种语言都非常喜欢，真的说不上来更喜欢哪一个。这篇文档代表了我使用 Scala 的(菜鸟)经验，完全的瞎扯，或者你可以称它为“一个傻瓜的精神自慰”。</p>
<h2 id=1-函数式编程的双赢>1. 函数式编程的双赢</h2>
<p>它并非银弹，但整体来说非常棒。你真的有必要经历一次，同时撇开那些通过多年的必要技能而建立起的成见和偏见。学生学习起函数式编程会相对容易，他们并无任何经验，否则学习的过程将会很痛苦。</p>
<p>但在过去的 20 万年里我们进化的并不多，所以我们的大脑总是能在那些吸引我们内在兽性(inner-animal)的地方找到乐趣，对繁衍、吃饭、睡觉和躲避野兽感兴趣。学习是一种乐趣，但对于陌生的领域并非如此，因此如果你已经开始，那就要坚持下去。</p>
<p>首先我们需要一些对于函数式编程的定义：</p>
<ul>
<li>通过“引用透明”对函数求值来处理计算；(引用透明：函数的行为类似数学函数，相同的输入总会得到相同的结果)</li>
<li>一个计算的最终输出是对输入的多次转换结果的组合，而非通过那些构建可变状态的方式；</li>
</ul>
<p>一个函数式编程语言：</p>
<ul>
<li>将函数当做“一类(first-class)对象”，这表示处理高阶函数不但是可能的，而且是很以很舒服的方式；</li>
<li>为你提供用于组合函数与类型的工具。</li>
</ul>
<p>根据定义，像 Ruby、Javascript 这些也可以被认为是像样的函数式语言。然而我还要加几条：</p>
<ul>
<li>拥有丰富的不可变、持久化数据结构；</li>
<li>提供有效的处理“<a href=http://en.wikipedia.org/wiki/Expression_problem>expression problem</a>”的类型系统。Rich Hickey 称之为“<em>polymorphism a la carte</em>”</li>
</ul>
<p>你也可以指定所有的副作用(side-effect)必须通过一元(monadic)类型来建模，不过这有点太清规戒律的意思(IMHO)，因为只有一种符合主流的语言 - Haskell。</p>
<h2 id=2-scala-是一个函数式语言吗>2. Scala 是一个函数式语言吗</h2>
<p>当然是。你只需要追随上面我提到的 Coursera 上的精彩<a href=https://www.coursera.org/course/progfun>课程</a>、完成作业，你就会意识到 Scala 真正是一个非常函数式的语言。该课程虽短，不过有后续计划。因此现在就行动吧&mldr;.</p>
<h2 id=3-polymorphism-à-la-carte>3. Polymorphism À la Carte</h2>
<p>这是我从 Rich Hickey 那听来的名词，当他谈论到开放式类型系统(open type-system)，主要引用了 Clojure 的 Protocol 和 Haskell 的 Type-Class。</p>
<p>这些多态机制能够很好的解决表达式问题，这与我们已知的 Java、C++ 这些面向对象语言形成鲜明对比。</p>
<p>OOP 通常是一个封闭的类型系统(closed type-system)，特别是在静态语言中使用时。将一个新类添加到层级结构、添加新函数来操作整个层级结构、给接口添加新的抽象成员、使内置类型以某种方式运转，所有这些都难以处理。</p>
<p>Haskell 通过 <a href=http://en.wikipedia.org/wiki/Type_class>Type Classes</a> 来处理。Clojure 通过  <a href=http://en.wikipedia.org/wiki/Multiple_dispatch>Multi-Methods</a> 和 Protocol 来处理，Protocol 是动态的，相当于 动态类型系统(dynamic type-system)中的 type-class。</p>
<h2 id=4-yes-virginiascala-拥有-type-class>4. Yes Virginia，Scala 拥有 Type-Class</h2>
<p>那什么又是 type-class？类似于 Java 中的接口，除了你可以使任何现有类型遵循它而不用修改该类型的实现。</p>
<p>比如，我们想要一个泛型函数能够将事物加起来&mldr;.比如一个<code>foldLeft()</code>或<code>sum()</code>，但是相较于如何 fold，你想要环境知道如何处理每个特殊的类型。</p>
<p>在 Java 或 C# 中这样做有很多问题：</p>
<ul>
<li>对于那些支持相加操作的类型，并没有为<code>+</code>定义接口，比如：Integer/BigInteger/BigDecimal/Float/String&mldr;</li>
<li>我们需要从一些"0"开始(你想要折叠的列表可能为空)</li>
</ul>
<p>或许你可以定义一个这样的类型类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>-T</span>, <span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>elem</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>R</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>R</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>但是等等，这不就是一个类 Java 的接口吗？对，他就是。这就是 Scala 最棒的地方，Scala 中任何实例都是对象，任何类型(type)都是一个类(class)。</p>
<p>那又是什么让这个接口成为了一个 type-class？当然是因为“伴生对象中带有隐式参数的对象”(<a href=http://ropas.snu.ac.kr/~bruno/papers/TypeClasses.pdf>Objects in combination with implicit parameters</a>)。我们看一下如何使用这些来实现<code>sum</code>函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Traversable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>adder</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>addr</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>zero</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>adder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>因此，如果 Scala 编译器能够在作用域中找到一个为 A 定义的 隐式<code>CanFold</code>，就会使用它生产一个 B。它的出色表现在多个级别：</p>
<ul>
<li>类型 A 的隐式定义建立在返回类型 B 之上</li>
<li>可以为任何你需要的类型定义一个<code>CanFold</code>，整数、字符串、列表等等等</li>
</ul>
<p>隐式定义是有范围的，因此需要导入。如果你需要一些类型的默认隐式定义(全局可见)，可以在<code>CanFold</code>特质的伴生对象中定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// default implementation for integers
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CanFoldInts</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>Long</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Long</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>acc</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>e</span>
    <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>使用时则和预期一样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// notice how the result of summing Integers is a Long
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#a40000>2</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#a40000>3</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>//=&gt; Long = 6
</span></code></pre></div><p>我不会骗你这些方式有多难学或者如何学，你最终会拉起头发，期盼这些都不再是问题的动态类型。然而你要分清 hard 和 complex 的区别，前者是相对的、主观上的，后者是绝对的、可观上的。</p>
<p>我们实现中的一个难题是如何为一个基本类型提供默认实现。这也是为什么在<code>CanFold[-T,R]</code>的定义中我们将类型参数 T 设为逆变(<em>contravariant</em>)。逆变性代表的意思是：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>B</span> <span style=color:#000>inherits</span> <span style=color:#000>from</span> <span style=color:#000>A</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>B</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>then</span>
<span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>inherits</span> <span style=color:#000>from</span> <span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>])</span>
</code></pre></div><p>这允许我们为任何 Traversable 定义一个 CanFold，该 CanFold 可以支持任何 Seq/Vector/List 等等。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>CanFoldSeqs</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Traversable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>Traversable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Travrsable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Travsesable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>y</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Traversable</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这可以将任何类型的<code>Traversable</code>相加。问题是会在过程中丢失类型参数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>4</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#a40000>5</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>//=&gt; Traversable[Any] = List(1,2,3,4,6)
</span></code></pre></div><p>为什么我会说它难的原因是在我把头发拉出来之后，不得不去<a href=http://stackoverflow.com/questions/13176697/problems-with-contravariance-in-scala>StackOverFlow</a>请教怎么才能够返回一个<code>Traversable[Int]</code>。因此，你可以使用一个隐式的<code>def</code>替换之前的具体隐式对象，来帮助编译器识别容器中嵌入的类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>CanFoldSeqs</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CanFold</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Traversable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>Traversable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Traversable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Traversable</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000>y</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>zero</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Traversable</span><span style=color:#ce5c00;font-weight:700>()</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#a40000>4</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#a40000>5</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>//=&gt; Traversable[Int] = List(1,2,3,4,5)
</span></code></pre></div><p>Implicit 比眼见的要灵活。显然编译器同样能够使用返回你需要的实例的函数，而不是具体的实例。作为一个旁注，我上面做的是很难的，甚至在 Haskell 中，因为子类化(sub-typing)是复杂的，但是 Clojure 中也很简单，因为你无需关注返回类型。</p>
<p><strong>NOTE：上面的实现并不严谨，可能会发生冲突。</strong></p>
<p>未完&mldr;</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f379cc207e06ff8a131648c43af55ddb>1.45 - 异步编程</h1>
<p><a href=https://alexn.org/blog/2017/01/30/asynchronous-programming-scala.html>翻译自：Asynchronous Programming and Scala</a></p>
<p>现在随处可见异步性的身影，同时它也被包括在并发性之内。这篇文章解释了什么是异步处理和它面临的挑战。</p>
<h2 id=1-介绍>1. 介绍</h2>
<p>它作为一个比<em>多线程</em>更加综合的概念，但是人们往往将二者混淆。如果需要一种关系来表示，可以是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Multithreadiing</span> <span style=color:#204a87;font-weight:700>&lt;:</span> <span style=color:#000>Asynchrony</span>
</code></pre></div><p>我们可以将异步计算表示成一个<code>type</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span>
</code></pre></div><p>如果这些<code>Unit</code>返回类型看起来很丑陋，那是因为异步本身就是丑陋的。一个异步计算可以是网络中拥有如下特征的任何任务(Task)、线程、进程或节点：</p>
<ul>
<li>在你程序的主流程之外执行，或者从调用者的角度来看，它并不在当前调用栈(call-stack)执行；</li>
<li>接收一个回调，并在结果处理完成之后调用；</li>
<li>它不能对结果在何时发送做出任何保证，甚至一点也不能保证一个结果会不被发送。</li>
</ul>
<p>知道异步属于<em>并发</em>的范畴是很重要的，但多线程则没必要。要记得在 Javascript 中，大部分 I/O 操作都是异步的，甚至繁重的业务逻辑也被异步化处理(使用基于调度的 setTimeout)以保证接口是可响应的。但是并不涉及内核级别的多线程，Javascript 成了一个 N:1 的多线程化平台。</p>
<p>将异步化引入到程序中的同时也意味着你要面对并发问题，因为你无法知道异步计算具体何时会完成。因此，将多个异步计算的结果组合并在同一时间运行意味着你需要进行额外的同步操作，因此你也不能再依赖顺序。不能依赖顺序则会带来更多的不确定性。</p>
<blockquote>
<p>维基百科：一个不确定的算法，相对于确定性的算法来说，尽管提供了相同的输入，可能会在不同的运行过程表现出不同的行为。一个并行算法因为竟态条件会在多次运行时以不同的方式执行。</p>
</blockquote>
<img src=nondet-3aa1c5d6.png class=max-border width=775 alt=Nondet>
<p>敏锐的读者可以会注意到这些类型随处可见，基于用例和规约做一些调整：</p>
<ul>
<li><a href=https://en.wikipedia.org/wiki/Observer_pattern>Observer pattern</a>- <a href=https://en.wikipedia.org/wiki/Design_Patterns>Gang of Four</a></li>
<li>Scala 中的<code>Future</code>，由其抽象方法<code>onComplete</code>定义</li>
<li>Java 中的<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html#submit-java.util.concurrent.Callable->ExecutorService.submit(Callable)</a></li>
<li>Javascript 汇总的<a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener>EventTarget.addEventListener</a></li>
<li>在 Akka 的 actor 中，尽管给出的回调被<code>sender()</code>替换</li>
<li>Monix 中的<a href=https://github.com/monix/monix/blob/v2.2.1/monix-eval/shared/src/main/scala/monix/eval/Task.scala#L1253>Task.Async</a>定义</li>
<li>Monix 中的 <a href=https://monix.io/api/2.2/monix/reactive/Observable.html>Observable</a>、<a href=https://monix.io/api/2.2/monix/reactive/Observer.html>Observer</a>对</li>
<li><a href=http://www.reactive-streams.org/reactive-streams-1.0.0-javadoc/>Reactive Streams</a>的详细说明</li>
</ul>
<p>这些抽象有什么共同点呢？他们都提供了处理异步化的方式，其中一些更为优秀。</p>
<h2 id=2-巨大的错觉>2. 巨大的错觉</h2>
<p>我们喜欢假装能将函数的异步结果转换为同步：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span>
</code></pre></div><p>问题的实质是我们不能假装这些异步处理与普通函数相同。如果你对此需要一刻，只需要了解一下为什么 CORBA 失败了。</p>
<p>针对异步处理，我们有以下非常常见的分布式计算谬误( <a href=https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing>fallacies of distributed computing</a>)：</p>
<ul>
<li>网络是可靠的</li>
<li>延迟为 0</li>
<li>带宽是无限的</li>
<li>网络是完全的</li>
<li>拓扑结构不会发生变化</li>
<li>拥有一位管理员</li>
<li>传输消耗为 0</li>
<li>网络是同质的(homogeneous)</li>
</ul>
<p>当然这些没有一条是真的。这意味着代码是按这些情形来编写的：极少的网络错误处理，忽略了网络延迟和丢包，忽略了带宽限制和随之而来的诸多不确定性。</p>
<p>人们尝试各种方式来对付这些问题：</p>
<ul>
<li>回调，导出都是对调，甚至忽略了基本问题。像 Javascript 中发生的一样，这导致了众所周知的<em>回调地域</em>，以程序员的汗水和鲜血为代价，甚至怀疑人生；</li>
<li>阻塞线程，基于<a href=https://en.wikipedia.org/wiki/Thread_(computing)#1:1_.28kernel-level_threading.29>1:1 (kernel-level) multithreading</a>平台</li>
<li><a href=https://en.wikipedia.org/wiki/Continuation>first-class continuations</a>，比如 Scheme 中实现的<a href=https://en.wikipedia.org/wiki/Call-with-current-continuation>call/cc</a>，在任何一点上保存执行状体并在程序的稍后点回到该点的能力；</li>
<li>来之 C# 的<code>async</code>/<code>await</code>语言扩展，同样在<a href=https://github.com/scala/async>scala-async</a>、最新的<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function>ECMAScript</a>也有实现；</li>
<li>有运行时管理的<a href=https://en.wikipedia.org/wiki/Green_threads>Green threads</a>，可能与 <a href=https://en.wikipedia.org/wiki/Thread_(computing)#M:N_.28hybrid_threading.29>M:N multithreading</a>组合，来模拟异步动作的阻塞。比如 Golang 和 Haskell；</li>
<li>Erlang 和 Akka 中实现了<a href=https://en.wikipedia.org/wiki/Actor_model>actor model</a>，或者  <a href=https://github.com/clojure/core.async>Clojure&rsquo;s core.async</a> 或 Golang 中的<a href=https://en.wikipedia.org/wiki/Communicating_sequential_processes>CSP</a>；</li>
<li>Monad 用于顺序和组合，比如 Haskell 的 <a href=https://hackage.haskell.org/package/async-2.1.1/docs/Control-Concurrent-Async.html>Async</a>类型和 <a href=https://wiki.haskell.org/IO_inside>IO</a>类型的组合，或者： <a href=https://docs.microsoft.com/en-us/dotnet/articles/fsharp/language-reference/asynchronous-workflows>F# asynchronous workflows</a>、 <a href=http://docs.scala-lang.org/overviews/core/futures.html>Scala&rsquo;s Futures and Promises</a>、<a href=https://monix.io/docs/2x/eval/task.html>Monix Task</a> 或 <a href=https://github.com/scalaz/scalaz/blob/scalaz-seven/concurrent/src/main/scala/scalaz/concurrent/Task.scala>Scalaz Task</a>, 等等。</li>
</ul>
<p>有这么多不同的实现，是因为没有任何一种是适用于通用目的的机制来处理异步。没有银弹的窘境在这里很切题，内存管理和并发成为我们开发者面临的巨大问题。</p>
<blockquote>
<p>注意 - 个人观点和一些碎碎念：人们喜欢吹嘘像 Golang 这样的 M:N 平台，然而我更偏向于 1:1 的多线程平台，比如 JVM 或 .NET。</p>
<p>因为你可以在编程语言中基于 1:1 平台搭建 M:N 的多线程来提供足够的表现力(比如：Scala 的 Future、Task、Clojure 的 core.async 等等)，但是一旦 M:N 的运行时不再适用于你的场景，你则无法修改或替换平台。是的，大多数 M:N 平台都被一种方式或另一种打破。</p>
<p>真正的学习所有可行方案或做出选择是很痛苦的，但总比做出无知的选择要痛苦的少，TOOWTDI(?) 和 “worse is better”在这种情况下害处则会更大。人们在解释难于学习一门新的或更有表现力的语言时，比如 Scala 或 Haskell，往往没有提到点上，因为如果他们不得不处理并发问题，这是学习一种新的编程语言将会使他们最小的问题。我了解到一些人因为并发问题而离开了软件行业。</p>
</blockquote>
<h2 id=3-回调地狱>3. 回调地狱</h2>
<p>让我们创建一个仿造的例子来阐明我们的疑问。比如开启两个异步处理并将他们的结果结合在一起。</p>
<p>首先定义一个异步执行的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.global</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timeTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>global</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Runnable</span><span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run</span><span style=color:#ce5c00;font-weight:700>()</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span>
        <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>})</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 40
</span></code></pre></div><h3 id=31-顺序化副作用炼狱>3.1. 顺序化(副作用炼狱)</h3>
<p>让我们来结合两个异步结果，以平滑的顺序让一个在另一个发生之后执行：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>){</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#8f5902;font-style:italic>// Combining the two results
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 80
</span></code></pre></div><p>看起来很简单，但是我们仅结合了两个结果，一个跟在另一个之后。</p>
<p>巨大的问题仍然是<strong>它触及到的所有异步化副作用</strong>。我们假设由于参数的缘故我们以一个纯函数开始：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
</code></pre></div><p>但是这是你的企业架构师听说了这些企业 JavaBean 和 a lap dance(?)，决定让你基于这些异步的<code>timsTwo</code>函数。这时我们的<code>timesFour</code>实现从一个精确的纯函数编程一个有副作用的函数。同时伴随一个并不成熟的<code>Async</code>类型，我们需要面对在整个管道(pipeline)处理副作用。同时，阻塞结果也没有任何帮助，你只是隐藏了问题所在(第二节所述)。</p>
<p>但是等等，事情还会变得更糟。</p>
<h3 id=32-并行化梦境中的不确定性>3.2. 并行化(梦境中的不确定性)</h3>
<p>第二个调用并不基于第一个调用，因此他们可以并行运行。在 JVM 我们可以并行运行 CPU-bound 的任务，但这并不适用于 Javascript，我们可以发起 Ajax 请求或于其他网页工作者(web worker)交谈。</p>
<p>不幸的是事情会变的有点复杂。首先使用所有自然(navie)方式来做都会非常错误：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// REALLY BAD SAMPLE
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>cacheA</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>cacheA</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#8f5902;font-style:italic>// Combing the two results
</span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheA</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 80
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: 40
</span></code></pre></div><p>这里的例子展示了实际中的不确定性。我们得不到顺序保证哪个会先结束，因此如果我们要并行执行，需要建模一个迷你状态机来进行同步。</p>
<p>首先，定义 ADT 来描述状态机：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// Define the state machine
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>State</span>
<span style=color:#8f5902;font-style:italic>// Initial state
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span>
<span style=color:#8f5902;font-style:italic>// We got a B, waiting for an A
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span>
<span style=color:#8f5902;font-style:italic>// We got a A, waiting for a B
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span>
</code></pre></div><p>然后以异步的方式来演化这个状态机：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// BAD SAMPLE FOR THE JVM(only works for Javascript)
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>state</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>State</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Start</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>为了更好的视觉化我们处理的问题，下图是状态机：</p>
<img src=callback-hell-stm-2cd322e2.png align=center width=300 alt="Callback hell stm">
<p>但是等等，我们还没结束，因为 JVM 拥有真实的 1:1 多线程，这表示我们要沉浸于<em>可共享内存的并行化</em>，因此对<code>state</code>的访问必须是同步的。</p>
<p>一种方案是使用<code>synchronized</code>块，或称为<em>intrinsic</em>块：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// We need a common reference to act as our monitor
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lockkk</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AnyRef</span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>state</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>State</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Start</span>

<span style=color:#000>timeTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#000>lock</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>synchronized</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// ...
</span></code></pre></div><p>这种高级别的锁保护资源(eg. state)不被多线程并行访问。但我个人更倾向于避免这种高级别的锁，因为内核的调度器可以以任何原因冻结任何线程，包括持有锁的线程。冻结一个持有锁的线程意味着如果你想保证持续前进，而其他线程无法再继续前进，这是无阻塞(<a href=https://en.wikipedia.org/wiki/Non-blocking_algorithm>non-blocking</a>)的逻辑则会更优先。</p>
<p>因此供替代的方式是使用一个<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicReference.html>AtomicReference</a>，它会更适用这个场景：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// CORRECT VERSION FOR JVM
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.annitation.tailrec</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.atomic.AtomicReference</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timeFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>onFinish</span> <span style=color:#ce5c00;font-weight:700>=&gt;{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>State</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>)</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onValueA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#000>onValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>onValueA</span><span style=color:#ce5c00;font-weight:700>)</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)))</span>
            <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#8f5902;font-style:italic>// Can&#39;t be caught b/c async, hopefully it gets reported
</span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p><strong>PRO-TIP</strong>：如果你想编写  Javascript / Scala.js 的交叉编译代码，基于性能调整和用于操作原子引用的酷炫工具类，可以尝试<a href=https://monix.io/>Monix</a>中的<a href=https://monix.io/docs/2x/execution/atomic.html>Atomic</a>。</p>
</blockquote>
<h3 id=33-递归爆栈的愤怒>3.3. 递归(爆栈的愤怒)</h3>
<p>如果我告诉你上面的<code>onFinish</code>调用并非栈安全(stack-unsafe)的，同时当你调用它时也不会强制<em>异步边界(asynchronous boundary)</em>，这时你的程序会因为一个<code>StackOverflowError</code>爆炸，又该怎么办呢？</p>
<p>你不应该相信为的话。首先让我们找些乐子，同时以更通用的方式来定义上面的操作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.annotation.tailrec</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java.util.concurrent.atomic.AtomicReference</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>A</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>b</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Defines the state machine
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span>,<span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#8f5902;font-style:italic>// Initial state
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Nothing</span>, <span style=color:#204a87;font-weight:700>Nothing</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#8f5902;font-style:italic>// We got a B, waiting for an A
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Nothing</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#8f5902;font-style:italic>// We got an A, waiting for a B
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>Nothing</span><span style=color:#ce5c00;font-weight:700>]</span>
  
  <span style=color:#000>onFinish</span> <span style=color:#ce5c00;font-weight:700>=&gt;{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>state</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicReference</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>State</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>)</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onVlueA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Uint</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#204a87;font-weight:700>if</span><span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#000>onValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>//retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>get</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Start</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compareAndSet</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Start</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)))</span>
            <span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// retry
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForB</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinissh</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>WaitForA</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> 
          <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>IllegalStateException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>state</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
    
    <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>onValueA</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>fb</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>onValueB</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在可以定义一个类似 Scala 中的<code>Future.sequence</code>操作，因为我们的意志坚强，勇气不可估量&mldr;..</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@tailrec</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]],</span> <span style=color:#000>acc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
        <span style=color:#000>onFinish</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>onFinish</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>))</span>
      <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>xs</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span>
        <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>update</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#000>vall</span> <span style=color:#000>empty</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Async</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#ce5c00;font-weight:700>)))</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
  <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$r</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic>// =&gt; Result: List(20, 40, 60)
</span></code></pre></div><p>你一定认为我们完成了？</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.</span><span style=color:#000>until</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toList</span>
<span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Sum: </span><span style=color:#4e9a06>${</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>注意看这个壮丽的内存错误，它会让你的程序在生产环境崩溃，被认为是一个致命错误，因此 Scala 的<code>NonFatal</code>也捕捉不到：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>lang</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>StackOverflowError</span>
  <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>externalPush</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>java</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>2414</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#000>java</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>util</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ForkJoinPool</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>java</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>2630</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ExecutionContextImpl$$anon$3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutionContextImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>scala</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>131</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#000>scala</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>concurrent</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>impl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ExecutionContextImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>execute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ExecutionContextImpl</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>scala</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#a40000>20</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$timesTwo$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>27</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$timesTwo$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>66</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1$adapted</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>$anonfun$mapBoth$1</span><span style=color:#ce5c00;font-weight:700>(&lt;</span><span style=color:#000>pastie</span><span style=color:#204a87;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>67</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>如为所说，<code>onFinish</code>作为一个没有<em>强制异步边界</em>的调用会引起栈溢出错误。在 Javascript 中可以通过调度<code>setTimeout</code>来解决，而 JVM 则需要一个线程池或 Scala 的<code>ExecutionContext</code>。</p>
<p>Are you feeling the fire yet? 🔥</p>
<h2 id=4-future--promise>4. Future & Promise</h2>
<p><code>scala.concurrent.Future</code>描述了完整的异步求值计算，和我们上面用的<code>Async</code>有点类似。</p>
<blockquote>
<p>维基百科：Future 和 Promise 是在一些并发编程语言中用于异步程序执行的结构。它描述了一个对象，该对象看做是最初并不可知的结果的代理，通常因为该结果的值尚未计算完成。</p>
</blockquote>
<blockquote>
<p>作者的碎碎念：<code>docs.scala-lang.org</code>中关于 <a href=http://docs.scala-lang.org/overviews/core/futures.html>Futures and Promises</a>是这样说的，“Future 提供了一个以并行方式执行多个操作的方法 -更加高效、无阻塞的方式。 ”这种说法容易产生误解，一个混淆的源头。</p>
<p><code>Future</code>描述的是异步化而非并行化。当然，可以以并行的方式来使用，但并不意味者仅用作并行(async != Parallelism)，或适用于那些寻找充分利用 CPU 容量的人，使用<code>Future</code>可以证明是昂贵和不明智的，因为在有些场景它会出现性能问题，参考本部分的第四小节。</p>
</blockquote>
<p><code>Future</code>是一个定义了两种主要操作的接口，同时附带一些基于这些主要操作实现的组合子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.util.Try</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// abstract
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]]</span>
  
  <span style=color:#8f5902;font-style:italic>// abstract
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>onComplete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Unit</span>
  
  <span style=color:#8f5902;font-style:italic>// Transforms values
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>U</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
  <span style=color:#8f5902;font-style:italic>// Sequencing
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>U</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>???</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>Future</code>的特性：</p>
<ul>
<li><a href=https://en.wikipedia.org/wiki/Eager_evaluation>Eagerly evaluated</a>(立即求值，strict and not lazy)，意味着一旦调用者收到一个<code>Future</code>引用，无论异步处理要完成的是什么，它都已经开始了；</li>
<li><a href=https://en.wikipedia.org/wiki/Memoization>Memoized</a>(记忆，cached)，因为会被<em>立即求值</em>，它的行为更像一个正常值而不是一个函数，同时最终的结果会对所有的监听者(listener)可用。<code>value</code>的目的是用于返回记忆结果或尚未完成时返回<code>None</code>。Goes 并未提到会返回一个不确定的值；</li>
<li>流经(stream)单个结果时它会显示，因为是记忆化起了作用。因此当监听者注册了完成时，他们最多会被调用一次。</li>
</ul>
<p><code>ExecutionContext</code>的解释性说明：</p>
<ul>
<li><code>ExecutionContext</code>管理异步执行，也可以把它视作一个线程池，但它并非必须是一个线程池(因为异步不等于多线程或并发)；</li>
<li><code>onComplete</code>和我们上面定义的<code>Async</code>类型一样，然而，它需要一个<code>ExecutionContext</code>，因为所有的完成时回调需要以异步的方式调用；</li>
<li>所有的组合子和工具类都基于<code>onComplete</code>实现，因此所有的组合子和工具类都要提供一个<code>ExecutionContext</code>参数。</li>
</ul>
<p>如果你不理解为什么这些签名都需要一个<code>ExecutionContext</code>，回到上面的“递归”部分，直到你完全理解了。</p>
<h3 id=41-顺序化>4.1. 顺序化</h3>
<p>让我们使用<code>Future</code>重新定义“回调地狱”部分的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>onComplete</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: Success(40)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>足够简单，<code>Future.apply</code>创建器使用提供的<code>ExecutionContext</code>执行给出的计算。因此在 JVM 上，假设<code>global</code>执行上下文会运行在不同的线程上。</p>
<p>然后实现顺序化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>
  <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>onComplete</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: Success(80)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>足够简单。这里的<em>for 表达式</em>魔法仅仅是会被转换为<code>flatMap</code>和<code>map</code>，在字面上等同于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]={</span>
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>=&gt;</span>
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果你在项目中导入了<a href=https://github.com/scala/async>scala-async</a>，可以像下面这样实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.async.Async.</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]={</span>
  <span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span>
    <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扩展库<code>scala-async</code>由 macros 驱动，并将你的代码转换为<code>flatMap</code>和<code>map</code>调用。因此，<code>await</code>并不会阻塞线程，尽管它带来了这种错觉。</p>
<p>这些看起来确实不错，不幸的是拥有很多限制。当你的<code>await</code>处于匿名函数之内时，库将无法“重写”你的代码，不幸的是 Scala 代码中到处都是这种表达式。这将不会工作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// BAD SAMPLE
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]])(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>async</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>sum</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
    <span style=color:#8f5902;font-style:italic>// Nope, not going to work because &#34;for&#34; is translated to &#34;foreach&#34;
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>){</span>
      <span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>await</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这种方式带来了拥有<em>first-class continuations</em>的幻觉，但是这种扩展并非一等类，仅仅是作为由编译器管理的重写代码。使得，这种约束在 C# 和 ECMAScript 中却应用的很好，因为<code>async</code>代码并不严重依赖于<em>函数式</em>。</p>
<p>还记得我前面的碎碎念中提到的<em>没有银弹</em>？</p>
<h3 id=42-并行化>4.2. 并行化</h3>
<p>像先前的例子中展示的，这两个函数互相独立，因此我们可以并行调用他们。使用<code>Future</code>则会更加简单，尽管求值语义对于新手来说会有点迷惑：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Future is eagerly evaluated, so this will trigger the
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// execution of both before the composition happens.
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fa</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fb</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
  <span style=color:#8f5902;font-style:italic>// fa.flatMap(a =&gt; fb.map(b =&gt; a + b))
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这会有点迷惑，领新手措手不及。因为在这种执行模型中，为了以并行的方式执行，你需要在组合发生之前初始化这些<code>Future</code>引用。</p>
<p>一种可替代的方式是使用<code>Future.sequence</code>，可以用于任意集合：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFourInParallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>::</span> <span style=color:#204a87;font-weight:700>Nil</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这种用法估计也会让新手吃惊，因为这些<code>Future</code>仅会当传入<code>sequence</code>的集合是精确的时候才会以并行的方式执行，不像 Scala 的<code>Stream</code>或<code>Iterator</code>。显然这个名字是个误称。</p>
<h3 id=43-递归>4.3. 递归</h3>
<p><code>Future</code>类型对于递归操作是绝对安全的，因为信心在于执行回调的<code>ExecutionContext</code>。因此重试前面的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>...</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>...</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seed</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seed</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>accl</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>l</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>
  <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>times</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#ce5c00;font-weight:700>))).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; List(20, 40, 60)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这次则不会出现<code>StackOverflowError</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>list</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0.</span><span style=color:#000>until</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>toList</span>
<span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Sum: </span><span style=color:#4e9a06>${</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#a40000>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><h3 id=44-性能代价>4.4. 性能代价</h3>
<p><code>Future</code>的麻烦是每次调用<code>onComplete</code>都会使用一个<code>ExecutionContext</code>来执行，通常这意味着一个<code>Runnable</code>被发送到了线程池，像这样分支(fork)一个<em>逻辑线程</em>。如果你拥有 CPU 绑定的任务，这种实现细节对性能来说是一种灾难，因为跳跃的线程意味着 <a href=https://en.wikipedia.org/wiki/Context_switch>context switches</a>，同时会带来 CPU 的<a href=https://en.wikipedia.org/wiki/Locality_of_reference>cache locality</a>被摧毁。当然，该实现拥有确定性的优化，比如<code>flatMap</code>的实现中使用一个内部的蹦床形式的(trampolined?)执行上线文，为了避免在链接这些内部回调时进行分支，但是这还不够并且基准测试也不会说谎。</p>
<p>同时基于它的记忆化，在完成之上，实现会强制每个生产者执行一个<code>AtomicReference.compareAndSet</code>，在每个<code>Future</code>完成之前又会为每个注册的监听者加上一个<code>compareAndSet</code>。这些调用是十分昂贵的，所有这些都是为了记忆化以便在多个线程之间能够良好运行。</p>
<p>换句话说，如果你想让你的 CPU 绑定任务能够充分利用 CPU，这时使用<code>Future</code>和<code>Promise</code>不是一个好注意。</p>
<p>如果你想对比 Scala 的<code>Future</code>和<code>Task</code>实现，可以看一下相关<a href=https://github.com/rossabaker/benchmarks/pull/4>benchmark</a>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[info] Benchmark                   (size)   Mode  Cnt     Score     Error  Units
[info] FlatMap.fs2Apply             10000  thrpt   20   291.459 ±   6.321  ops/s
[info] FlatMap.fs2Delay             10000  thrpt   20  2606.864 ±  26.442  ops/s
[info] FlatMap.fs2Now               10000  thrpt   20  3867.300 ± 541.241  ops/s
[info] FlatMap.futureApply          10000  thrpt   20   212.691 ±   9.508  ops/s
[info] FlatMap.futureSuccessful     10000  thrpt   20   418.736 ±  29.121  ops/s
[info] FlatMap.futureTrampolineEc   10000  thrpt   20   423.647 ±   8.543  ops/s
[info] FlatMap.monixApply           10000  thrpt   20   399.916 ±  15.858  ops/s
[info] FlatMap.monixDelay           10000  thrpt   20  4994.156 ±  40.014  ops/s
[info] FlatMap.monixNow             10000  thrpt   20  6253.182 ±  53.388  ops/s
[info] FlatMap.scalazApply          10000  thrpt   20   188.387 ±   2.989  ops/s
[info] FlatMap.scalazDelay          10000  thrpt   20  1794.680 ±  24.173  ops/s
[info] FlatMap.scalazNow            10000  thrpt   20  2041.300 ± 128.729  ops/s
</code></pre></div><p>可以看到 <a href=https://monix.io/docs/2x/eval/task.html>Monix Task</a>在 CPU 绑定的任务上击败了<code>Future</code>。</p>
<blockquote>
<p>注意：这些基准测试是有局限的，仍然有一些用例中<code>Future</code>会更快(eg. Monix <a href=https://monix.io/docs/2x/reactive/observers.html>Observer</a>使用<code>Future</code>用做背压)并且性能通常并不相关，比如执行 I/O，即那些吞吐并非 CPU 绑定的场景。</p>
</blockquote>
<h2 id=5-taskscala-的-io-monad>5. Task，Scala 的 IO Monad</h2>
<p><code>Task</code>是一种用于控制可惰性、可异步计算的数据类型，可用于控制副作用、避免非确定性和回调地狱。</p>
<p><a href=https://monix.io/>Monix</a> 库从 <a href=https://github.com/scalaz/scalaz/blob/scalaz-seven/concurrent/src/main/scala/scalaz/concurrent/Task.scala>Task in Scalaz</a> 获得灵感，提供了一种非常精致的 <a href=https://monix.io/docs/2x/eval/task.html>Task</a> 实现。相同的概念，但实现不同。</p>
<blockquote>
<p><code>Task</code>类型同样汲取了来自 <a href=https://wiki.haskell.org/IO_inside>Haskell&rsquo;s IO monad</a> 的灵感，而作者认为这是真正的 Scala <code>IO</code> 类型。</p>
<p>该问题存在争论，因为 Scalaz 同样暴漏了一个仅用于处理异步计算的<code>IO</code>类型。Scalaz 的 <code>IO</code>并非异步，这表示它的描述并不完整，因为在 JVM 之上你必须以某种方式表示异步计算。另一方面，在 Haskell 中的你拥有转换成<code>IO</code>类型的<code>Async</code>类型，或许这是由运行时管理的(green-threads and all)。</p>
<p>在 JVM 之上的 Scalaz 实现中，我们无法使用<code>IO</code>在求值过程中以不阻塞线程的方式来表达异步计算，这是要避免的，因为<a href=https://monix.io/docs/2x/best-practices/blocking.html>阻塞线程则意味着倾向于错误</a>。</p>
</blockquote>
<p>总的来说，<code>Task</code>类型：</p>
<ul>
<li>建模惰性、异步求值</li>
<li>建模一个生产者向一个或多个消费者仅发送一个值</li>
<li>它是惰性求值，因此对比<code>Future</code>它并不会触发执行，或在<code>runAsync</code>之前都不会有任何效果</li>
<li>不会被求值记忆化(memoized)，但是 Monix 的<code>Task</code>可以</li>
<li>无需再另一个逻辑线程执行</li>
</ul>
<p>而 Monix 中的实现拥有更多特别之处：</p>
<ul>
<li>允许取消一个运行中的计算</li>
<li>在其实现中永远不会阻塞任何线程</li>
<li>没有暴露任何可以阻塞线程的 API 调用</li>
<li>所有异步操作都是栈安全的(stack safe)</li>
</ul>
<p><code>Task</code>在设计上的可视化表示：</p>
<table>
<thead>
<tr>
<th></th>
<th>Eager</th>
<th>Lazy</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Synchronous</strong></td>
<td>A</td>
<td>() => A</td>
</tr>
<tr>
<td></td>
<td></td>
<td><a href=https://monix.io/docs/2x/eval/coeval.html>Coeval[A]</a>, <a href=https://github.com/scalaz/scalaz/blob/scalaz-seven/effect/src/main/scala/scalaz/effect/IO.scala>IO[A]</a></td>
</tr>
<tr>
<td><strong>Asynchronous</strong></td>
<td>(A => Unit) => Unit</td>
<td>(A => Unit) => Unit</td>
</tr>
<tr>
<td></td>
<td><code>Future[A]</code></td>
<td><a href=https://monix.io/docs/2x/eval/task.html>Task[A]</a></td>
</tr>
</tbody>
</table>
<h3 id=51-顺序化>5.1. 顺序化</h3>
<p>使用<code>Task</code>重新定义第三节中的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>monix.eval.Task</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Our ExecutionContext needed on evaluation
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.Scheduler.Implicits.global</span>
  
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: 40
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>代码看起来和第四节中<code>Future</code>的版本一样，唯一的区别是新的<code>timesTwo</code>函数不再接受<code>ExecutionContext</code>作为参数。这是因为<code>Task</code>引用是惰性的，和函数类似，因此在调用强制求值发生的<code>foreach</code>之前什么都不会打印。我们需要的是一个 <a href=https://monix.io/docs/2x/execution/scheduler.html>Scheduler</a>，这是 Monix 中增强的<code>ExecutionContext</code>。</p>
<p>现在实现 3.1 节中的顺序化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.Scheduler.Implicits.global</span>
  
  <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>result</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$result</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>)}</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; Result: 80
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同样是和<code>Future</code>类型一样，<em>for 表达式</em>魔法仍然是被 Scala 编译器转换成<code>flatMap</code>和<code>map</code>调用，字面值等同于：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>=&gt;</span>
    <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
    <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=52-并行化>5.2. 并行化</h3>
<p><code>Task</code>的并行化比<code>Future</code>要好的多，因为<code>Task</code>在分支 task 时支持细粒度控制，当在当前线程和调用栈执行转换(eg. map/flatMap)时，局域性的缓存保留和避免上下文切换则等同于顺序执行。</p>
<p>但是首先，转换成<code>Future</code>的形式并不能正常工作：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// BAD SAMPLE, 为了达成并行，这实质上会是顺序化
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 并不会触发执行，因为 Task 是惰性的
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fa</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>fb</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// 因为惰性的缘故求值会是顺序化
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span>
    <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>想要达到并行化，必须显示指定：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>timesFour</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>mapBoth</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>是不是<code>mapBoth</code>看起来很熟悉？如果这两个任务在执行时分支线程，<code>mapBoth</code>会同时启动两者，从而达到并行化。</p>
<h3 id=53-递归>5.3. 递归</h3>
<p><code>Task</code>支持递归，栈安全且十分有效，这是基于其内部的 trampoline。你可以查看这篇 Rúnar Bjarnason 的论文 <a href=http://blog.higher-order.com/assets/trampolines.pdf>Stackless Scala with Free Monads</a> 来了解其为何如此有效。</p>
<p>其<code>sequence</code>实现与<code>Future</code>非常相似，只不过你会在<code>sequence</code>的签名中发现其惰性化：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Task</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seed</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Task</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>now</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seed</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>for</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>l</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>acc</span>
    <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>f</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>l</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>monix.execution.Scheduler.Implicits.global</span>
  
  <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>timesTwo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#ce5c00;font-weight:700>))).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#8f5902;font-style:italic>// =&gt; List(20, 40, 60)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=6-函数式编程和-type-class>6. 函数式编程和 Type-class</h2>
<p>当你使用这些众所周知的函数时，比如：<code>map</code>，<code>flatMap</code>和<code>mapBoth</code>，我们不再关心这一切的背后是一个<code>(A => Unit) => Unit</code>，因为这些函数会假设为合法、纯净、透明的。这意味着我们可以脱离其上下文来推导它们的结果。</p>
<p>这是 Haskell 中<code>IO</code>的伟大成就。Haskell 不会“伪造(fake)”副作用，因为返回<code>IO</code>函数字面意义上是纯的，副作用会被推迟到其所属程序的边缘。我们可以同样看待<code>Task</code>。不过，对于<code>Future</code>急切的本性(立即计算)来说会更加复杂，但是使用<code>Future</code>也不是一个坏的选择。</p>
<p>那么我们能够基于这些类型，比如<code>Task</code>、<code>Future</code>、<code>Coeval</code>、<code>Eval</code>、<code>IO</code>、<code>Id</code>、<code>Observable</code>或者一些其他的类型，来创建接口或抽象吗？</p>
<p>当然我们可以，我们已经见过使用<code>flatMap</code>来描述顺序化，使用<code>mapBoth</code>来描述并行化。但是我们不能使用经典的 OOP 来描述他们，其中一个原因是<code>Functional</code>参数的协变和逆变规则，这会导致我们在<code>flatMap</code>中失去类型信息(除非你使用 F-bounded 泛型类型，这样更适合实现复用或其他 OOP 语言不可用时)，同时我们要描述一个数据构造器，他不能是一个方法(比如 OOP 的子类应用到实例而不是整个类)。</p>
<p>幸运的是，Scala 是极少数支持高阶类型且能够编码类型类(type-class)的语言，这意味着我们拥有了从 Haskell 端口概念所需要的一切。</p>
<blockquote>
<p>作者的碎碎念：<code>Monad</code>，<code>Applicative</code>，<code>Functor</code>，这些可怕的单词让那些并不忠实的人心生畏惧，导致他们认为关注的是一些与现实世界脱轨的“学术”概念，书籍作者要避免大量使用这些单词，包括 Scala 的 API 文档及官方教程。</p>
<p>但这是给 Scala 和其用户帮倒忙。其他语言中仅有的设计模式主要是难于解释，因为这些不能用类型来表示。你可以用一只手输出拥有这种表达能力的语言。而用户痛苦的是当他们遇到麻烦时不知如何从现有的文献中搜索相关主题，缺失对正确术语的学习。</p>
<p>我也觉得这是一味地反智主义(<a href=https://en.wikipedia.org/wiki/Anti-intellectualism>anti-intellectualism</a>)，向往常一样对无知的恐惧。你可以发现这些都来自真正做他们的人，但我们无一幸免。比如 Java 中的<code>Optional</code>类型违反了 Functor 的规则(e.g. <code>opt.map(f).map(g) != opt.map(f andThen g)</code>)，Swift 中愚蠢的 <code>5 == Some(5)</code>，可以幸运的向人们解释<code>Some(null)</code>实际上与<code>null</code>的意义相同，是<code>AnyRef</code>的有效值，因为不然的话你不能定义一个<code>Applicative[Option]</code>。</p>
</blockquote>
<h3 id=61--monad顺序化和递归>6.1. Monad(顺序化和递归)</h3>
<p>本文并不会解释 Monad。另外有一篇文章来专门解释它。但如果你想建立一个直觉，这里有另外一个：在数据类型的上下文中，比如<code>Future</code>或<code>Task</code>，Monads 用于描述操作的顺序，并且是保证顺序的唯一有效方法。</p>
<blockquote>
<p>&ldquo;<em>Observation: programmers doing concurrency with imperative languages are tripped by the unchallenged belief that &ldquo;;&rdquo; defines sequencing.</em>&rdquo; – <a href=https://twitter.com/shipilev/status/822004316605206529>Aleksey Shipilëv</a></p>
</blockquote>
<p>Scala 中一个简单的编码<code>Monad</code>的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// we shouldn&#39;t need to do this
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.language.higherKinds</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]{</span>
  <span style=color:#8f5902;font-style:italic>/** Constructor (said to lift a value `A` in the `F[A]`
</span><span style=color:#8f5902;font-style:italic>    * monadic context). Also part of `Applicative`, see below.
</span><span style=color:#8f5902;font-style:italic>    */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

  <span style=color:#8f5902;font-style:italic>/** FTW */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>同时提供一个<code>Future</code>实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent._</span>

<span style=color:#8f5902;font-style:italic>// Supplying an instance for Future isn&#39;t clean, ExecutionContext needed
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FutureMonad</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FutureMonad</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这真是一个强力的东西。现在我们可以描述一个用于<code>Task</code>、<code>Future</code>、<code>IO</code>的泛型函数，无论如何，如果<code>flatMap</code>是栈安全的话这将非常伟大：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>/** Calculates the N-th number in a Fibonacci series. */</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>fib</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]](</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>F</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>BigInt</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>=&gt;</span>
      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>}</span>

  <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>BigInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>BigInt</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Usage:
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// Needed in scope
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>FutureMonad.instance</span>
  <span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>scala.concurrent.ExecutionContext.Implicits.global</span>

  <span style=color:#8f5902;font-style:italic>// Invocation
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>fib</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#0000cf;font-weight:700>40</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>foreach</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>s&#34;Result: </span><span style=color:#4e9a06>$r</span><span style=color:#4e9a06>&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#8f5902;font-style:italic>//=&gt; Result: 102334155
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>注意：这只是一个玩具样例，严肃的实现参考 <a href=http://typelevel.org/cats/>Typelevel&rsquo;s Cats</a>。</p>
</blockquote>
<h3 id=62-applicative并行化>6.2. Applicative(并行化)</h3>
<p>Monad 定义了操作的顺序化，但是有时我们想组合那些互不依赖的计算的结果，他们可以同时求值，或者并行化。还有一个例子可以证明 Applicative 比 Monad 更加可组合。</p>
<p>现在扩展我们的<em>Typeclassopedia</em>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Functor</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>/** I hope we are all familiar with this one. */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Applicative</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#000>extends</span> <span style=color:#000>Functor</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>/** Constructor (lifts a value `A` in the `F[A]` applicative context). */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

  <span style=color:#8f5902;font-style:italic>/** Maps over two references at the same time.
</span><span style=color:#8f5902;font-style:italic>    *
</span><span style=color:#8f5902;font-style:italic>    * In other implementations the applicative operation is `ap`,
</span><span style=color:#8f5902;font-style:italic>    * but `map2` is easier to understand.
</span><span style=color:#8f5902;font-style:italic>    */</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#000>extends</span> <span style=color:#000>Applicative</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后扩展我们的<code>Future</code>实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#8f5902;font-style:italic>// Supplying an instance for Future isn&#39;t clean, ExecutionContext needed
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FutureMonad</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>successful</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>

  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>B</span>,<span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>fb</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>R</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Future</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>R</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span>
    <span style=color:#8f5902;font-style:italic>// For Future there&#39;s no point in supplying an implementation that&#39;s
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// not based on flatMap, but that&#39;s not the case for Task ;-)
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fa</span><span style=color:#ce5c00;font-weight:700>;</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>&lt;-</span> <span style=color:#000>fb</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>yield</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>ec</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ExecutionContext</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>FutureMonad</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FutureMonad</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在可以基于<code>Applicative</code>定义泛型函数并用于<code>Future</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sequence</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]])</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>F</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Applicative</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>

  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>seed</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>pure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>r</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>foldLeft</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>seed</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>l</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>l</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#000>F</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reverse</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><blockquote>
<p>注意：同样是一个玩具样例，参考<a href=http://typelevel.org/cats/>Typelevel&rsquo;s Cats</a>。</p>
</blockquote>
<h3 id=63-为异步求值定义类型类>6.3. 为异步求值定义类型类？</h3>
<p>上面的部分缺少的是真正触发计算并获得结果值。思考 Scala 的<code>Future</code>，我们想要一种方式来抽象<code>onComplete</code>。想象 Monix 中我们想要抽象<code>runAsync</code>。想象 Haskell 和 Scalaz 的<code>IO</code>，我们想要抽象<code>unsafePerformIO</code>。</p>
<p><a href=https://github.com/functional-streams-for-scala/fs2/>FS2</a> 库中定义了一个名为 <a href=https://github.com/functional-streams-for-scala/fs2/blob/series/1.0/core/shared/src/main/scala/fs2/util/Effect.scala>Effect</a> 类型类来这样做：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Effect</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#000>extends</span> <span style=color:#000>Monad</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>unsafeRunAsync</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>fa</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>F</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>cb</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Try</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Unit</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Unit</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这看起来向我们初始的<code>Async</code>类型，跟<code>Future.onComplete</code>、<code>Task.runAsync</code>、<code>IO.unsafePerformIO</code>很相似。</p>
<p>然而，它并非真正的类型类：</p>
<ul>
<li>它是非法的，然而也不足以取消他的资格(after all, useful lawless type-classes like <code>Show</code> exist)，但最大的问题是&mldr;.</li>
<li>如 3.3 中所示，为了避免<code>StackOverflowError</code>，我们需要某种执行上下文或线程池来执行异步任务且不会导致栈溢出。</li>
</ul>
<p>但是这样的执行上下文根据实现不同而不同。Java 使用 Executor，Scala 的<code>Future</code>时候使用<code>ExecutionContext</code>，Monix 使用增强自<code>ExecutionContext</code>的<code>Scheduler</code>。FS2 和 Scalaz 使用 包装自<code>Executor</code>的<code>Strategy</code>来 fork 线程，但是调用<code>unsafePerformIO</code>或<code>runAsync</code>时并不会注入上下文(这也是为什么很多 Scalaz 组合子实际上并不安全)。</p>
<p>我们可以采取与<code>Future</code>同样的策略，从作用域中获取一个<code>implicit whatever: Context</code>来创建实例。但这有点尴尬且效率低下。这也意味这不使用上下文的情况下我们仅仅不能为<code>Effect.unsafePerformIO</code>定义<code>flatMap</code>。如果我们不能这样做，这时也不会继承自<code>Monad</code>，因为它没有必要是一个<code>Monad</code>。</p>
<p>因此为个人也不是很确定 - 如果你对 Cats 有什么好的建议，我愿洗耳恭听。</p>
<p>我希望你喜欢这个思想试验，设计东西是很有趣的。</p>
<h2 id=7-选择正确的工具>7. 选择正确的工具</h2>
<p>一些抽象较其他会更为通用，为个人认为"为工作选择正确的工具"这样的口头禅是过度保护可怜人的选择。</p>
<p>为此，Rúnar Bjarnason 有一个非常有意思的表述，名为 <a href="https://www.youtube.com/watch?v=GqmsQeSzMdw">Constraints Liberate, </a>，而 <a href="https://www.youtube.com/watch?v=GqmsQeSzMdw">Liberties Constrain</a> 最终真正道出了并发抽象的本质。</p>
<p>如前所述，并没有银弹能够通用的解决并发问题。抽象的层次越高，能解决的问题视野也就越少。但是更少的视野和其强大的能力，模型也会更加简单更加可组合。比如 Scala 社区中很多开发者滥用 Akka Actor，这个库在不被误用时是很伟大的。就像能够使用<code>Future</code>或<code>Task</code>时不用 Actor。同样在其他的抽象中，比如 Monix 或 ReactiveX 中的<code>Observable</code>抽象。</p>
<p>同样用心学习下面两条规则：</p>
<ul>
<li>避免使用回调、线程和锁，它们易错且不可组合；</li>
<li>避免像瘟疫一样并发(avoid concurrency like the plague it is)</li>
</ul>
<p>最后让我告诉你，并发专家首先是避免并发的专家&mldr;.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-75ebf2bf41c6cd0d1369e9d43836ed13>1.46 - 战略Scala风格</h1>
<p><a href=http://www.lihaoyi.com/post/StrategicScalaStylePracticalTypeSafety.html>Strategic Scala Style: Practical Type Safety</a>一文的中文翻译，点击查看原文。</p>
<p>这篇文章探索了如何利用Scala的类型安全特性来避免在使用Scala编写程序时出错。</p>
<p>虽然Scala有一个编译器帮助你捕捉错误，或者称它为类型安全，实际上有一个全方位的方式让你能够编写更多或更少安全性的Scala。我们将会讨论多种方式让你把你的代码转变为更加安全的系列。我们将有意识地忽略那些绝对的证明和逻辑事物的理论方面，而更专注于实践的方式来使编译器帮你不做更多隐藏的BUG。</p>
<p><code>Type Safety</code>涉及面很广。你需要投入整个生涯来学习Haskell的类型系统或Scala变成语言，并且需要花费另一个周期来学习Haskell运行时的的类型实现或Java虚拟机。这里将会忽略这两个内容。</p>
<p>取而代之，本文将会以实践的方式来介绍如何以“类型安全”的方式来使用Scala，编译器的知识可以让你减轻错误的后果，并且能够把这些错误编程简单的、能够在开发期间完成修改的错误，以此来提高你代码的安全性。一个有经验的Scala开发者会发现本文的“基础“和”显而易见“，但是任何新手将会期望将这些技术添加到工具箱来解决Scala中遇到的问题。</p>
<p>这里的每一种技术描述都会做一些权衡：冗长、复杂、额外的类文件、低劣的运行时性能。本文我们会忽略这些问题而把他们当做是相当完美的。本文只会列举可能的情况，而不会去深入讨论有些取舍是否值得。而且，本文仅作用域纯粹的Scala，不会涉及类似Scalaz、Cats、Shapeless这样的第三方扩展库。如果属性该类技术的人愿意去写的话，这些库应该有他们自己的风格或技术并在他们自己的文章中展示。</p>
<h2 id=原理>原理</h2>
<p>在我们讨论具体的技术和围绕类型安全的取舍之前，停下来思考一下问题本质是有意义的。什么是一个类型？”安全“一词有意味这什么？</p>
<h3 id=什么是类型type>什么是类型(Type)</h3>
<p><strong>在一个程序的运行时，你对一个值的了解就是Type。</strong></p>
<p>基本上所有的编程语言都有一个不同的类型系统。一些有泛型，一些有具体化的泛型。例如Java，有具体化的泛型，一个值的类型总是与一个类护着接口符合并能在运行时检查。其他的，比如C就不能。Python这样的动态语言没有静态类型，因此类型仅存在于运行时。</p>
<p>本文所讲的Scala语言，拥有它自己的相对复杂的特定的类型系统。也有一些尝试将其正式化，比如<a href=https://github.com/lampepfl/dotty>Dotty</a>项目。本文将会忽略这些。</p>
<p>本文中将会依照上面的释义。在一个程序的运行时，你对一个值的了解就是Type。比如：</p>
<ol>
<li>一个<code>Int</code>定义为包含了从<code>-2147483648</code>到<code>2147483647</code>的32位整数；</li>
<li>一个<code>Option[T]</code>定义为要么是一个<code>Some[T]</code>，要么是一个<code>None</code>；</li>
<li>一个<code>CharSequence</code>定义为包含了一些<code>Char</code>并支持我们调用<code>.length、.chatAt、.subsequence</code>等方法，但是我并不知道它是一个<code>String</code>、<code>String</code>或别的什么。你并不知道它是否可变(mutable/immutable)，它如何保存它的内容，或者性能规格如何；</li>
<li>一个<code>String</code>同样拥有一些字符，但你知道它是不可变的，使用一个内部的字符数组来保存内容，通过索引来查找<code>Char</code>的时间复杂度我<code>O(1)</code>。</li>
</ol>
<p>一个值的类似告诉你某些东西是什么和它不能是什么。<code>Option[String]</code>可能是<code>Some</code>或<code>None</code>，但它绝不会是一个32位的整数！在Scala中，这些是你不需要检查的：这些是你可以依赖的正确事物，编译器会在编译器为你检查。</p>
<p>这个知识点确切的指出了一个值的类型包含了什么。</p>
<h3 id=类型不是什么>类型不是什么</h3>
<h4 id=a-class>A Class</h4>
<p>这个定义中，类型不是一个类(Class)。对，在基于JVM之上的Java和Scala，所有的类型被描述为类(class)或接口(interface)，这在<code>Scala.js</code>中并不有效，你可以定义一个假的类型(<code>trait</code>继承自<code>js.Any</code>)，在编译之后不会留下任何残留，或在其他编程语言中。</p>
<p>虽然类型被类所支持是一个事实，这只是一个实现细节并且与本位无关。</p>
<h4 id=scala类型系统>Scala类型系统</h4>
<p>这里讨论的类型概念是含糊的、宽泛的，基于所有语言而不仅仅是Scala。Scala自身的类型系统是复杂的，有类，抽象类型，细化类型，特质，类型界限，上下文界限，和一些其他更加晦涩的东西。</p>
<p>纵观本文，这些细节都是为了服务一个目的：在你程序中将你对值的了解描述给编译器，然后让他检查你现在做的，与你说的和想要做的是否一致。</p>
<h3 id=什么是安全>什么是安全</h3>
<p><strong>类型安全意味着一点你出错，后果的影响比较小。</strong></p>
<p>相比类型，可能有其他更多对”安全“的定义。上面的定义比类型有宽泛：它作用于安全实践、隔离、分布式系统中的健壮性和恢复性，还有其他一些事情。</p>
<p>人们会犯各种错误：代码排版、可怜的负荷估算、复制粘贴错误的命令。当你出错时发生了什么？</p>
<ul>
<li>你会看到编辑器中红色表示然后5s内修复了它；</li>
<li>你想完整的编译，花费了10s，然后修复了它；</li>
<li>你运行测试用例，花费了10s，然后修复了它；</li>
<li>你部署了这个错误，然后几个小时以后才发现它，然后修复后再部署；</li>
<li>你部署了这个错误，这个错误几周内都没有被提醒，但是在提醒后修复它需要花费几周的时间来清理它遗留的错误数据；</li>
<li>你部署了错误，然后发现你的公司45分钟后破产了。你的工作、团队、你的组织和计划，都没了。</li>
</ul>
<p>忽略类型和运行时的概念，很明显不同的环境有不同的安全级别。只要捕捉够早或异步debug，甚至运行时错误都会造成更小的影响，Python中的习惯，当不匹配时在运行时抛出<code>TypeError</code>，似乎必Php中当不匹配时进行强制执行要安全的多。</p>
<h3 id=什么是类型安全>什么是类型安全</h3>
<p><strong>类型安全是利用我们在运行时对一个值的了解来尽量降低大部分错误的后果。</strong></p>
<p>比如，一个”较小的后果“可以被看做是开发期间就能够发现的易于理解的编译错误，然后花费30s完成修复。</p>
<p>这个定义直接准照上面我们对”类型“和”安全“的定义。这比很多类型安全的定义都要宽泛，特别是：</p>
<ul>
<li>类型安全不是编写Haskell，这个概念要更为宽泛；</li>
<li>类型安全不是避免可变状态，除非它有助于我们的目标；</li>
<li>类型安全不是一个绝对的目标，是一个尽量和优化的属性；</li>
<li>类型安全对每个人都不同；如果不同的人犯不同的错，这些错都有不同的危害级别，他们需要完善不同的事情来尽力优化这些错误的危害；</li>
<li>如果错误消息不可理解并难于解决，编译器甚至也会有严重的影响。一个能在10s内修复的优雅的编译器消息和一个需要半小时才能理解的巨大的编译器错误消息是完全不同的。</li>
</ul>
<p>类型安全的定义多种多样；如果你问一个C++开发者、一个Python的网站开发者或者一个研究编程语言的教授，他们会给出各自截然不同的定义。本文中，我们会使用上面宽泛的定义。</p>
<h3 id=scalazzi-scala>Scalazzi Scala</h3>
<p>很多人思考了很多关于若何以类型安全的方式编写Scala。所谓的Scala语言的“Scalazzi Subset”是其中一个哲学：</p>
<div align=center> <img src=https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/Scalazzi.jpg style=display:block;width:50% alt=NAME align=center> </div>
<p>当然这些指导方针有很多地方需要讨论，我们会花一些时间浏览其中一部分，同时我发现了一些有意思的地方：</p>
<ul>
<li>避免空值</li>
<li>避免异常</li>
<li>避免副作用</li>
</ul>
<h4 id=避免空值>避免空值</h4>
<p>使用<code>null</code>来描述一些空的、未初始化或不可用的值会很吸引人，比如，一个未初始化的值：</p>
<pre><code>class Foo{
	val name: String = null // override this with something useful if you want
}
</code></pre>
<p>或者是传入到函数的一个”没有值“的参数：</p>
<pre><code>def listFiles(path: String) = ...

listFiles(&quot;/usr/local/bin/&quot;)
listFiles(null) // no argument, default to current working directory
</code></pre>
<p>“Scalazzi Scala”告诉我们要避免这样做，并给了一个很好的理由：</p>
<ul>
<li><code>null</code>会出现在程序的各个角落，任何一个变量或值，没有办法控制那些变量是<code>null</code>而哪些不是；</li>
<li><code>null</code>在你的程序中到处传播：可以将<code>null</code>传入函数，赋给其他变量，或存入集合。</li>
</ul>
<p>最终，这意味着<code>null</code>值会在原理他们初始化的地方一起错误，然后就很难被追踪。当有些地方被<code>NullPointerException </code>终止，你需要首先找到那些可疑的变量(每行代码或许会有很多变量)，然后进行追踪，比如函数的传入和传出，集合的存储和检索，直到你找到<code>null</code>的来源。</p>
<p>在Python这样的动态语言中，这种类型的错误值传播很普通，寻常不会贯穿整个程序来进行追踪，然后到处添加<code>print</code>语句，尝试去找到初始值的来源。通常有人简单的将参数混入到一个函数，传入一个<code>user_id</code>而不是<code>user_email</code>或其他不重要的值，但是会照成很大的后果来追踪和调试。</p>
<p>在一个带有类型检查器的编译型语言，比如Scala，许多这样的错误会在你运行编译器之前就能捕获：在于其为一个<code>String</code>的地方传入<code>Int</code>或<code>Seq[Double]</code>会得到一个类型错误。并不是所有的错误都会被捕捉，但是会捕捉大部分严重的错误。预期为不是<code>null</code>的地方传入一个<code>null</code>除外。</p>
<p>这里有一些<code>null</code>的备选方案：</p>
<p><strong>如果想要表达一个可能存在的值，一个函数参数或者一个需要被覆写的类属性：</strong></p>
<pre><code>class Foo{
	val name: String = null // override this with something useful if you want
}
</code></pre>
<p>考虑使用<code>Option[T]</code>替换：</p>
<pre><code>class Foo{
	val name: Option[String] = None // override this with something useful if you want
}
</code></pre>
<p><code>"foo"</code>和<code>null</code>取而代之为<code>Some("foo")</code>和<code>None</code>看起来很相似，但是这样做的话所有人都会知道它可能为<code>None</code>，而不会像如果将一个<code>Some[String]</code>放到预期为<code>String</code>的地方然后跟<code>null</code>得到一个编译错误。</p>
<p><strong>如果使用<code>null</code>作为一个未初始化<code>var</code>值的占位符：</strong></p>
<pre><code>def findHaoyiEmail(items: Seq[(String, String)]) = {
	var email: String = null // override this with something useful if you want

	for((name, value) &lt;- items){
        if (name == &quot;Haoyi&quot;) email = value
	}

	if (email == null) email = &quot;Not Found&quot;
	doSomething(email)
}
</code></pre>
<p>考虑替换为<code>val</code>并一次完成声明和初始化：</p>
<pre><code>def findHaoyiEmail(items: Seq[(String, String)]) = {
  val email = 
    items.collect{case (name, value) if name == &quot;Haoyi&quot; =&gt; value} 
         .headOption
         .getOrElse(&quot;Not Found&quot;)
  doSomething(email)
</code></pre>
<p>如果你不能够在一行代码内初始化<code>email</code>的值，Scala支持你将片段的代码放到柯里化的<code>{}</code>中同时将其赋给一个<code>val</code>, 因此, 大部分你需要稍后初始化为<code>var</code>的代码都可以放到一个<code>{}</code>中然后声明并初始化为一个<code>{}</code>.</p>
<pre><code>def findHaoyiEmail(items: Seq[(String, String)]) = {
  val email = {
    ...
  }
  doSomething(email)
}
</code></pre>
<p>这样做的话,我们就能控制<code>email</code>永远不会是一个<code>null</code>.</p>
<p>通过简单的在程序中避免<code>null</code>,你并没有改变理论状况, 理论上有人可以传入一个<code>null</code>,你会在同样的地方追踪那些难于调试的问题.但是你改变了实践环境: 不会花费更少的实践来追踪难于调试的<code>NullPointerException</code>问题.</p>
<h4 id=避免异常>避免异常</h4>
<p>异常基本上是一段代码的额外返回值.任何你写的代码都可以通过<code>return</code>关键字以正常的方式返回,或者简单的返回最后一个代码块的表达式,或者是抛出一个异常. 这些异常会包含任意的数据.</p>
<p>虽然一些其他语言比如Java,用编译器来检查你可以确定的能够抛出的异常,它的"受检异常"也并不是很成功: 它的不便之处在于必须要声明你抛出的需要检查的异常,以至于人们只是给他们的方法都使用一个<code>throws Exception</code>,或者捕获受检异常后重新作为未检查的运行时异常抛出.后期的语言比如C#和Scala完全抛弃了这种受检异常的思想.</p>
<p>为什么你不可以使用异常:</p>
<ul>
<li>你没有办法静态的知道一段代码都能抛出哪些种类的异常. 即你不知道是否处理了代码所有可能的返回类型.</li>
<li>你抛出的异常的注解是可选的,and trivially fall out of sync with reality as development happens and refactorings occur.</li>
<li>他们是传播的,so even if a library you&rsquo;re using has gone through the discipline of annotating all its methods with the exceptions they throw, the chances are in your own code you&rsquo;ll get sloppy and won&rsquo;t.</li>
</ul>
<p>与其返回一个异常,在只有一种失败模式的函数中,你可以返回一个<code>Option[T]</code>来表示结果,或者<code>Either[T, V]</code>,再或者是你自己定义的密闭trait来表示有多重失败模式的返回结果.</p>
<pre><code>sealed trait Result
case class Success(value: String) extends Result
case class InvalidInput(value: String, msg: String) extends Result
case class SubprocessFailed(returncode: Int, stderr: String) extends Result
case object TimedOut extends Result

def doThing(cmd: String): Result = ???
</code></pre>
<p>使用密闭trait方式,你可以更易于与用户沟通存在的准确错误,在每种场景可用的数据,同时当用户对<code>doThing</code>的结果进行<code>match</code>时,如果少了一个场景,编译器则会给出一个警告.</p>
<p>通常,你并不能去除所有异常:</p>
<ul>
<li>任何非一般的程序都很难去列出它所有可能的失败模式</li>
<li>许多都是非常罕见的,你实际上是想捕获他们的大部分然后通过一些通用的方式处理,比如: 写入日志或上报,或重试逻辑,你甚至不知道是什么引起的</li>
<li>对这些罕见的错误模式,可以吧错误信息写入日志,然后进行详细的手动检查,这也你能做的最好方式了</li>
</ul>
<p>然而,尽管有堆栈追踪(stack trace),找出这些预期之外异常的真正原因仍然要比使用<code>Option[T]</code>在编译器就发现错误要花费的时间更多.</p>
<p>Scala编程中涉及的异常:</p>
<ul>
<li>NullPointerExceptions</li>
<li>MatchError: 来自不健全的模式匹配</li>
<li>IOExceptions: 来自文件系统的各种问题或网络错误</li>
<li>ArithmeticException: 除0时的错误</li>
<li>IndexOutOfBoundsException: 搞砸数组的时候</li>
<li>IllegalArgumentException: 滥用第三方代码的时候</li>
</ul>
<p>仍然还有更多,但是并不需要完全去管,尽量在代码中使用<code>Option[T], Either[T, V], sealed trait</code>来使编译器能有更多的机会帮你进行错误检查.</p>
<h4 id=避免副作用>避免副作用</h4>
<p>至少在Scala中,编译器不会提供副作用的追踪.</p>
<p>下面是一个例子:</p>
<pre><code>var result = 0

for (i &lt;- 0 until 10){
  result += 1
}

if (result &gt; 10) result = result + 5 

println(result) // 50
makeUseOfResult(result)
</code></pre>
<p>我们将<code>value</code>初始化为一个占位值,然后利用副作用来修改<code>result</code>的值,然后为<code>makeUseOfResult</code>函数使用.</p>
<p>这里有很多地方会出错,你可能会意外的得到有一个突变:</p>
<pre><code>var result = 0

for (i &lt;- 0 until 10){
  results += 1
} 

println(result) // 45
makeUseOfResult(result) // getting invalid input!
</code></pre>
<p>这些可以看做是很明显的错误,但如果这个片段有1000行而不是10行,在重构中很容易出错.他以为着<code>makeUseOfResult</code>得到一个无效的输入并处理错误.这里有另一个常见的错误模式:</p>
<pre><code>var result = 0

foo()

for (i &lt;- 0 until 10){
  results += 1
}

if (result &gt; 10) result = result + 5 

println(result) // 50
makeUseOfResult(result)

...

def foo() = {
  ...
  makeUseOfResult(result)
  ...
}
</code></pre>
<p>这里甚至在<code>result</code>被初始化之前就开始使用它了.</p>
<p>下面的方式可以避免副作用:</p>
<pre><code>val summed = (0 until 10).sum

val result = if (summed &gt; 10) summed + 5 else summed

println(result) // 50
makeUseOfResult(result)
</code></pre>
<h4 id=scalazzi-scala的局限>Scalazzi Scala的局限</h4>
<p>下面的代码完全符合上面定义的<code>Scalazzi Scala</code>,但会让人感到很乱:</p>
<pre><code>def fibonacci(n: Double, count: Double = 0, chain: String = &quot;1 1&quot;): Int = {
  if (count &gt;= n - 2) chain.takeWhile(_ != ' ').length
  else{
    val parts = chain.split(&quot; &quot;, 3)
    fibonacci(n, count+1, parts(0) + parts(1) + &quot; &quot; + chain)
  }
}
for(i &lt;- 0 until 10) println(fibonacci(i))
1
1
1
2
3
5
8
13
21
34
</code></pre>
<p>这个代码是正确的,完全遵守了"Scalazzi Scala"的指导方针:</p>
<ul>
<li>没有Null</li>
<li>没有异常</li>
<li>没有<code>isInstanceOf</code>或<code>asInstanceOf</code></li>
<li>没有副作用并且所有值是不可变的</li>
<li>没有<code>classOf</code>和<code>getClass</code></li>
<li>没有反射</li>
</ul>
<p>但是人们会认为他是可怕的不安全的代码,原因在于下面的"Structured Data".</p>
<h4 id=结构化数据>结构化数据</h4>
<p>并非所有的数据都有相同的"形状",如果一些数据包含<code>(name, phone-number)</code>这样的对,有多重方式可以存储他们:</p>
<ul>
<li><code>Array[Byte]</code>: 这是文件系统存储他们的方式,如果你把他们存到磁盘,这就是他们的形式.</li>
<li><code>String</code>: 在编辑器中打开,会看到这样的形式.</li>
<li><code>Seq[(String, String)]</code></li>
<li><code>Set[(String, String)]</code></li>
<li><code>Map[String, String]</code></li>
</ul>
<p>这些都是有效的方式,如何来选择呢?</p>
<h5 id=避免字符串有利于结构化数据>避免字符串有利于结构化数据</h5>
<p>有时候会将数据存为<code>String</code>,然后在使用时在使用切片取出其中的不同数据,这样做会带来意外的问题.</p>
<h5 id=encode-invariants-in-types>Encode Invariants in Types</h5>
<h5 id=自描述数据>自描述数据</h5>
<h5 id=避免整数枚举>避免整数枚举</h5>
<pre><code>val UNIT_TYPE_UNKNOWN = 0
val UNIT_TYPE_USERSPACEONUSE = 1
val UNIT_TYPE_OBJECTBOUNDINGBOX = 2
</code></pre>
<p>这个代码中有一些好处:</p>
<ul>
<li><code>Int</code>类型消耗廉价,需要很少的内存来存储和传递</li>
<li>避免各种数字这样的魔术代码到处都是,最终难以分辨</li>
</ul>
<p>但是这种方式并不安全,更安全的方式会是这样:</p>
<pre><code>sealed trait UnitType  
object UnitType{
  case object Unknown extends UnitType
  case object UserSpaceOnUse extends UnitType
  case object ObjectBoundingBox extends UnitType
}
</code></pre>
<p>或者:</p>
<pre><code>// You can also make it take a `name: String` param to give it a nice toString 
case class UnitType private () 
object UnitType{
  val Unknown = new UnitType
  val UserSpaceOnUse = new UnitType
  val ObjectBoundingBox = new UnitType
}
</code></pre>
<p>这两种方式都是讲<code>UnitType</code>标记为一个实际的值,而不会想仅仅一个数字一样能够修改.</p>
<h5 id=避免字符串标记>避免字符串标记</h5>
<pre><code>val UNIT_TYPE_UNKNOWN = &quot;unknown&quot;
val UNIT_TYPE_USERSPACEONUSE = &quot;user-space-on-use&quot;
val UNIT_TYPE_OBJECTBOUNDINGBOX = &quot;object-bounding-box&quot;
</code></pre>
<p>这样做仍然不安全,可以对<code>UNIT_TYPE</code>调用任何字符串的方法,并且能够使用任何字符串替换,更好的方式是这样:</p>
<pre><code>sealed trait UnitType
object UnitType{
  case object Unknown extends UnitType
  case object UserSpaceOnUse extends UnitType
  case object ObjectBoundingBox extends UnitType
}

// Or perhaps

class UnitType private ()
object UnitType{
  val Unknown = new UnitType
  val UserSpaceOnUse = new UnitType
  val ObjectBoundingBox = new UnitType
}
</code></pre>
<h4 id=包装整数id>包装整数ID</h4>
<p>自增的ID经常是<code>Int</code>或<code>Long</code>,UUID可能是<code>String</code>或<code>java.util.UUID</code>,与<code>Int</code>或<code>Long</code>不同的是,ID都有一个唯一属性:</p>
<ul>
<li>所有的算术运算一般都没有意义</li>
<li>不同的ID不能交换:比如一个<code>userId: Int</code>和一个函数<code>def deploy(machineId: Int)</code>,<code>deploy(userId)</code>这样的调用是不希望出现的</li>
</ul>
<p>最好的方式是使用不同的类将这些ID进行包装:</p>
<pre><code>case class UserId(id: Int)
case class MachineId(id: Int)
case class EventId(id: Int)
...
</code></pre>
<p>或者自定义类型:</p>
<pre><code>type UID = Int
</code></pre>
<p>然后使用:</p>
<pre><code>val userId: UID = 2</code></pre>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-693b6f6bcc0c1c03a94a2d1cd7f5faa0>2 - Scala 函数式</h1>
</div>
<div class=td-content>
<h1 id=pg-b337e5ffeb37c04ead4da57f709c79e9>2.1 - CH00-精要</h1>
<h1 id=函数>函数</h1>
<p>一个函数是一个从“领域”到“代码域”的映射。函数将领域中的每个元素与代码域中的对应元素进行联结。在 Scala 中，领域和代码域都可以表示为<code>type</code>(类型)。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>square</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Int</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>x</span>
<span style=color:#000>square</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// 4
</span></code></pre></div><h2 id=高阶函数>高阶函数</h2>
<p>高阶函数是 接收一个函数作为参数 或 返回一个函数作为结果 的函数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这个例子中，函数<code>filter</code>接收一个类型为<code>A => Boolean</code>的函数作为参数。</p>
<h3 id=组合子>组合子</h3>
<p>函数组合子是同时接收、返回函数的高阶函数。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Conf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ConfigReader</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>A</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Conf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>readString</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>both</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Conf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>right</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Conf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Conf</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>c</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p>函数<code>both</code>即为一个接收函数并返回函数的高阶函数。</p>
<h3 id=多态函数>多态函数</h3>
<p>多态函数通常拥有一个或多个<strong>类型参数</strong>。Scala 本身对多态函数没有支持，但是可以通过<strong>特质的多态方法</strong>来实现。构造多态函数的特质通常拥有<code>apply</code>方法，因此，可以像普通的函数应用语法一样使用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>identity</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>T</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#000>identity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 3
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>indentity</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;3&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// &#34;3&#34;
</span></code></pre></div><p>这样，通过<code>apply</code>方法的便利，就可以实现多态函数。</p>
<h1 id=类型>类型</h1>
<p>一个<strong>类型</strong>是<strong>一组值</strong>的<strong>运行时描述</strong>。比如<code>Int</code>表示从<code>-2147483648</code>到<code>2147483647</code>这样的一组整数集。值都拥有类型，或者说，每个值都表示一组值的一个成员。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#0000cf;font-weight:700>2</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span>
</code></pre></div><p>例子中，<code>2</code>是<code>Int</code>集合的一个成员，也即，<code>2</code>的类型为<code>Int</code>。</p>
<h2 id=代数数据类型adt>代数数据类型(ADT)</h2>
<p>一个 ADT 是由<strong>产品</strong>和<strong>类型</strong>自合而成的类型。</p>
<h3 id=乘积类型product>乘积类型(product)</h3>
<p>乘积类型是由两个或多个类型的笛卡尔积组合构造而成的。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Point2D</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>例子中，一个二维点是一个数字与另一个数字的积。即每个该类型的值都有一个 x 轴坐标和 y 轴坐标。</p>
<h3 id=样例类>样例类</h3>
<p>在 Scala 中，样例类是更符合语言习惯的乘积类型表示。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>age</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h3 id=总和类型sum>总和类型(sum)</h3>
<p>总和类型通过两个或多个类型的<strong>不相交</strong>形式来定义。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>RequestResponse</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Error</span>, <span style=color:#204a87;font-weight:700>HttpResponse</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>例子中，定义的类型<code>RequestResponse</code>是<code>Error</code>和<code>HttpResponse</code>的总和构成，一个<code>RequestResponse</code>类型的值要么是一个 error，要么是一个 HTTP 响应。</p>
<h4 id=密闭特质>密闭特质</h4>
<p>在 Scala 中，密闭特质是更符合语言习惯的总和类型表示。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>AddressType</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Home</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AddressType</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Business</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AddressType</span>
</code></pre></div><p>例子中，一个<code>AddressType</code>要么是一个<code>Home</code>，要么是一个<code>Buiness</code>，而不能同时是两者。</p>
<h3 id=子类型>子类型</h3>
<p>如果<code>A</code>是<code>B</code>的子集，<code>A</code>即为<code>B</code>的子类型。在 Scala 中，<code>A</code>必须继承自<code>B</code>。编译器允许在任何需要的地方使用子类型。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Shape</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Rectangle</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>corner</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Point2D</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>width</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>height</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Shape</span>
</code></pre></div><h3 id=超类型>超类型</h3>
<p>如果<code>B</code>是<code>A</code>的子集，<code>A</code>即为<code>B</code>的超类型，<code>B</code>必须继承自<code>A</code>。编译器支持无论在何处定义子类型，均可以使用超类型。</p>
<p>同样还是上面的例子，<code>Shape</code>即为<code>Rectangle</code>的超类。</p>
<h3 id=universals>Universals</h3>
<p>一个通用(universally)量化类型定义了一个“由一些任意类型参数化的类型”的类别。在 Scala 中，类型构造器(比如特质)和方法必须是通用量化类型，尽管方法并不拥有一个类型，它只是类型的一部分。</p>
<h3 id=类型构造器>类型构造器</h3>
<p>一个类型构造器是一个通用量化类型，用于构造类型。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>head</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>例子中，<code>List</code>是一个类型构造器，定义了一组<code>List-</code>类似的类型。因此可以认为，<code>List</code>是针对类型<code>A</code>的通用类型量化。</p>
<h2 id=高阶类型>高阶类型</h2>
<h3 id=类型级别函数type-level>类型级别函数(Type-Level)</h3>
<p>类型构造器可以看做一个类型级别函数，它接收类型并返回类型。这种解释对于理解高阶类型很有用。</p>
<p>比如，<code>List</code>是一个接收类型<code>A</code>并返回类型<code>List[A]</code>的类型级别函数。</p>
<h3 id=类别kind>类别(Kind)</h3>
<p>类别可以认为是“类型的类型”。</p>
<ul>
<li><code>*</code>：类型的类别，所有类型的集合。</li>
<li><code>* => *</code>：类型级别函数的类别(接收一个类型，返回一个类型)。</li>
<li><code>[*, *] => *</code>：接收两个类型并返回一个类型的类型级别函数 的类别。比如类型构造器<code>Either</code>的类别是<code>[*, *] => *</code>，Scala 语法表示成<code>_[_, _]</code>。</li>
</ul>
<blockquote>
<p>可以与函数的类型进行对比：<code>A => B</code>，<code>A => B => C</code></p>
</blockquote>
<h3 id=高阶类别higher-order-kinds>高阶类别(Higher-Order Kinds)</h3>
<p>就像函数能够是高阶函数一样，类型构造器也可以是高阶的。Scala 中使用下划线编码(encode)高阶类型构造器。<code>trait CollectionModule[Collection[_]]</code>表示<code>CollectionModule</code>的类型构造器需要提供一个<code>* -> *</code>类别的类型构造器，比如<code>List</code>。</p>
<ul>
<li><code>(* => *) => *</code>：类型构造器的类别，它接收一个<code>* => *</code> 类别的类型构造器。比如：<code>trait Functor[F[_]] {...}</code>或<code>trait Monad[F[_]] {...}</code>。</li>
</ul>
<h2 id=existentials>Existentials</h2>
<p>一个“存在量化类型”定义一个基于一些明确但又未知的类型 的类型。“存在判断的类型”用于隐藏一些并非全局相关的类型信息。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ListMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]{</span>
  <span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>B</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>mapf</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>run</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>mapf</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>例子中，类型<code>ListMap[A]#B</code>是一些明确类型，但是有不能知道其真正类型，它可能是任何类型。</p>
<h3 id=skolemization>Skolemization</h3>
<p>每个“存在判断的类型”都可以被编码为一个通用(universal)类型。这个过程称为<strong>Skolemization</strong>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ListMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>list</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>mapf</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>A</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ListMapInspector</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>,<span style=color:#204a87;font-weight:700>Z</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ListMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Z</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AnyListMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Z</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ListMapInspector</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>Z</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Z</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>例子中，除了我们直接使用<code>ListMap</code>，还可以使用<code>AnyListMap</code>，仅当能够为<code>B</code>处理任何类型参数时允许我们对<code>ListMap</code>进行检查。</p>
<h2 id=type-lambdas>Type Lambdas</h2>
<p>函数可以通过使用下划线操作符编程“偏应用型(partially apply)”。比如，<code>zip(a, _)</code>。一个类型匿名函数是偏应用“高阶类别”类型的一种方式，使用较少的类型参数来生成一个新的类型构造器。</p>
<p>类型匿名函数之于类型构造器，相当于匿名函数之于函数。一个是类型、值的表达式，一个声明：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>λ</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>α</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>α</span><span style=color:#ce5c00;font-weight:700>]})</span><span style=color:#204a87;font-weight:700>#</span><span style=color:#000>λ</span>
</code></pre></div><p>例子中，<code>Either</code>通过偏应用一个<code>String</code>作为第一个类型参数。</p>
<p>较多场景中，会使用**类型别名(type aliase)**替代类型匿名函数，比如：<code>type EitherString[A] = Either[String, A]</code>。</p>
<h3 id=类别投影器projector>类别投影器(Projector)</h3>
<p>类别投影器是一个常用的 Scala 编译器插件，提供了更易用的语法来创建类型匿名函数。比如，<code>({type λ[α] = Either[String, α]})#λ</code>可以表示为<code>Either[String, ?]</code>这样的语法。另外有更多语法来创建更复杂的类型匿名函数。</p>
<p><a href=https://github.com/non/kind-projector>https://github.com/non/kind-projector</a></p>
<h1 id=类型类>类型类</h1>
<p>一个类型类是对类型和定义在该类上操作的收集。很多类型类会定义一些规则需要实现来遵守。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>ShowRead</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>ShowRead</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ShowRead</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>ShowRead</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>v</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>例子中，类型类<code>ShowRead[A]</code>定义了通过渲染字符串来显示类型<code>A</code>，并通过读取字符串来读取它，或是生成一个错误消息。</p>
<ul>
<li>
<p>Right Identity</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div></li>
<li>
<p>Left Partial Identity</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#000>fold</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div></li>
</ul>
<h2 id=实例>实例</h2>
<p>一个类型类的实例就是通过提供一组类型来定义一个该类型类的实现。一般这些事例会被标记为<code>imolicit</code>，以便编译器能够自动为需要的函数提供这些实现。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ShowReadString</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>ShowRead</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ShowRead</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h2 id=语法>语法</h2>
<p>便利的语法，或称为扩展方法，添加给类型以便这些类型类更加易用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ShowOps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A:ShowRead</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>show</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ShowRead</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>show</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>implicit</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ReadOps</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A:ShowRead</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>ShowRead</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>read</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>self</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h1 id=函数式模式>函数式模式</h1>
<h2 id=optioneithervalidation>Option、Either、Validation</h2>
<p>这些类型均用来表示可选性和偏应用性：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>seald</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Maybe</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Just</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Maybe</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Empty</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]()</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Maybe</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>\/</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>-\/</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>\</span><span style=color:#ce5c00;font-weight:700>/[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>fianl</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>\/-</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>\</span><span style=color:#ce5c00;font-weight:700>/[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>A</span> <span style=color:#000>\</span><span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>B</span>

<span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Validation</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Failure</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Validation</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Success</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Validation</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><h2 id=半群幺半群semigroup-monoid>半群、幺半群(Semigroup, Monoid)</h2>
<p>半群支持将两个相同类型的东西组合成另一个新的相同类型的东西。比如，加法操作构成一个基于整数的半群。幺半群怎加一个额外的拥有“零”元素的属性，比如添加给一个值而不改变该值。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>trait Semigroup[A]
</code></pre></div><p><a href=https://gist.github.com/jdegoes/97459c0045f373f4eaf126998d8f65dc>未完。。。</a></p>
<p><a href=https://wiki.scala-lang.org/display/SW/Parser+Combinators--Getting+Started>https://wiki.scala-lang.org/display/SW/Parser+Combinators&ndash;Getting+Started</a></p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2e909366e09c3d91dfac9a94ff86f763>2.2 - CH01-定义</h1>
<h2 id=介绍>介绍</h2>
<p>函数式编程，只是用<strong>纯函数</strong>来构造程序，即函数是没有副作用的。</p>
<p>函数的副作用大致包括：</p>
<ul>
<li>修改一个变量</li>
<li>直接修改数据结构</li>
<li>设置一个对象的成员</li>
<li>抛出一个异常或以一个错误停止</li>
<li>打印到终端或者接收用户的输入</li>
<li>读取或写入一个文件</li>
<li>在屏幕上绘图</li>
<li>&mldr;</li>
</ul>
<h2 id=函数式编程的益处>函数式编程的益处</h2>
<h3 id=副作用函数的实例>副作用函数的实例</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cafe</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>buyCoffee</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>CreditCard</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Coffee</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cup</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Coffee</span><span style=color:#ce5c00;font-weight:700>()</span>
  	<span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>charge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>price</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 副作用，对信用卡进行扣费
</span><span style=color:#8f5902;font-style:italic></span>  	<span style=color:#000>cup</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>扣费过程涉及与整个交易系统的交互，而这个方法的主要用途是为了得到一杯咖啡，因此，<em>扣费</em>动作在获取咖啡的过程中<strong>额外</strong>完成了，即副作用。</p>
<p>但是如果要测试这段程序，我们并不真的需要与交易系统进行交互，或者将交易信息进行持久。同时信用卡本身也不应该知道交易的细节，我们可以传递一个<code>Payments</code>对象给<code>buyCoffe</code>方法，让<code>CreditCard</code>忽略掉交易的细节，整个交易过程由<code>Payments</code>对象来完成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cafe</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>buyCoffe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>CreditCard</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Payments</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  	<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cup</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Coffe</span><span style=color:#ce5c00;font-weight:700>()</span>
    <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>charge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>price</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 副作用，有交易对象来完成扣费
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>cup</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在可以使用 mock 来对交易细节进行测试。但是真个程序很难被复用，比如我们要订购 12 杯咖啡。</p>
<h3 id=去除副作用>去除副作用</h3>
<p>在上面的例子中，我们可以在购买咖啡的过程中同时返回咖啡和对应的费用，而根据费用进行的交易过程则后续进行处理，这样，这个程序就不再存在副作用：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>buyCoffe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>CreditCard</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>Coffe</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>Change</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>cup</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Cup</span><span style=color:#ce5c00;font-weight:700>()</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cup</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Charge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cup</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>price</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这样通过将费用的创建与执行分离，购买咖啡的过程就不再有副作用，而真正的扣费可以在后续的事务中进行。</p>
<p>现在我们对相同信用卡的计费进行合并，以便支持同时购买多杯咖啡：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Charge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>CreditCard</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>){</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>combine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ohter</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Charge</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Charge</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Charge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>amount</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>other</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>amount</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;Can&#39;t combine charges to different cards.&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>然后实现<code>buyCoffes</code>来购买多杯咖啡，一次返回对应数量的咖啡和一个合并后的计费值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>buyCoffes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>CreditCard</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Coffe</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>Charge</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>purchases</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[(</span><span style=color:#204a87;font-weight:700>Coffe</span>, <span style=color:#204a87;font-weight:700>Charge</span><span style=color:#ce5c00;font-weight:700>)]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>fill</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>buyCoffe</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>coffes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>charges</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>purchases</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>unzip</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>coffes</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>chargs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reduce</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>c1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>c2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>c1</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>combine</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>c2</span><span style=color:#ce5c00;font-weight:700>)))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>如果需要将不同信用卡的不同消费记录合并成一个计费列表，即将相同的信用卡计费合并：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>coalesce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>charges</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Charge</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Charge</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>charges</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>groupBy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>cc</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#000>values</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reduce</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#000>combine</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#000>toList</span>
</code></pre></div><blockquote>
<p>如何消除副作用？</p>
<p>通过把副作用推到程序的最外层，来转换带有副作用的函数。对于很多必须的副作用都存在对应的函数式实现，如果没有对应的实现，也可以通过找到一种方式来构造代码，让副作用发生但不可见。</p>
</blockquote>
<h2 id=什么是纯函数>什么是纯函数</h2>
<p>纯函数是没有副作用的，<strong>更易推理</strong>。</p>
<p>一个函数在执行过程中，除了根据给定的参数给出运算结果之外没有任何其他影响，即为无副作用。</p>
<p><strong>引用透明</strong>：对于一个函数，无论何时调用，相同的参数都会返回一致的结果。同样也适用于表达式。</p>
<p>任何程序中符合引用透明的表达式都可以由它的结果替代，而不会改变程序的含义。</p>
<p><strong>纯函数</strong>：当调用一个函数时，传入的参数是引用透明的，并且函数调用也是引用透明的，那么他就是一个纯函数。</p>
<blockquote>
<p>引用透明与纯粹度</p>
<p>对于程序 p，如果它包含的表达式 e 满足引用透明，所有的 e 都能替换为它的计算结果而不会改变程序 p 的含义。假设存在一个函数 f，若表达式 f(x) 对所有引用透明的表达式 x 也是引用透明的，那么 f 是一个纯函数。</p>
</blockquote>
<h2 id=引用透明纯粹度及替代模型>引用透明、纯粹度及替代模型</h2>
<p>引用透明要求函数不论进行了何种操作都可以用它的返回值来代替。</p>
<p>比如一开始的咖啡例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>def buyCoffee(cc:CreditCard):Coffee = {
  	val cup = new Coffee()
  	cc.charge(cup.price)		// 副作用，对信用卡进行扣费
  	cup
  }
</code></pre></div><p>它的返回值为<code>cup</code>，实际上就是<code>new Coffe()</code>。对于任何一个函数<code>p(buyCoffee(cc:CreditCard))</code>与<code>p(new Coffe())</code>显然不能进行替换，因为<code>buyCoffee</code>除了返回一杯咖啡，还进行了交易过程。</p>
<p>引用透明的限制使得推导一个程序的求值变得简单，称为<strong>替代模型</strong>。如果表达式是引用透明的，可以想象计算过程就像是在解代数方程。展开表达式的每一部分，使用指示对象代替变量，然后归约到最简单的形式。在这一过程中，每一项都可以被等价的值替代，计算的过程就像是被一个又一个等价的值替代的过程。引用透明使得程序具备了等式推理的能力。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-03d39ebdea9922f42538e9be1f094c81>2.3 - CH02-函数</h1>
<h2 id=高阶函数-把函数传递给函数>高阶函数-把函数传递给函数</h2>
<p><strong>函数也是值，也可以赋值给一个变量、存储在一个数据结构里、像参数一样传递给另一个函数</strong>。</p>
<h3 id=循环调用>循环调用</h3>
<p>使用循环方式实现阶乘：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>factirial</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>go</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>acc</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>	<span style=color:#8f5902;font-style:italic>// 内部函数，跟一个函数内的变量含义相同
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>acc</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>go</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>acc</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>go</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>想不通过修改一个循环变量而实现循环功能，可以借助递归函数。这样的递归函数一般没命名为 go 或 loop。</p>
<p>上面的例子中，内部函数<code>go</code>实现循环，接收下一个<code>n</code>和和累积值<code>acc</code>。要退出循环时，返回一个不继续递归的值，即<code>n &lt;= 0</code>。</p>
<p>编译器会检测到这种<strong>自递归</strong>，只要递归调用发生在尾部，即递归调用后面没有其他的调用，编译器会优化成类似<code>while</code>循环的字节码。</p>
<blockquote>
<p>尾调用</p>
<p>指调用者在一个递归调用之后不做其他事，只是返回这个调用结果。</p>
<p>比如<code>else go(n-1, n * acc)</code>部分，是直接返回了<code>go</code>的递归调用，没有再做其他计算。如果是<code>1 + go(n-1, n * acc)</code>，则不再是尾调用，因为又进行了计算。</p>
<p>如果递归调用在尾部位置，则会自动编译为循环迭代，即不会每次进行栈的操作。可以通过<code>@annotation.tailrec</code>告诉编译器当没有成功编译成循环迭代时发出警告。</p>
</blockquote>
<h3 id=高阶函数>高阶函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>formatResult</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>msg</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;The %s of %d is %d.&#34;</span>
  <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这里的参数<code>f</code>，其类型为<code>Int => Int</code>，表示接受一个整数并返回一个整数的函数。</p>
<blockquote>
<p>因为高阶函数一般不能通过函数名来准确表示函数的功能，因此使用较短的函数命名，比如 g、h、f 等。</p>
</blockquote>
<h2 id=多态函数-基于类型的抽象>多态函数-基于类型的抽象</h2>
<p>这里的多态跟继承中所说的“父类-子类继承”不同，这里是指类型的多态。</p>
<p>之前见到的函数都是<strong>单态</strong>的，因为函数只操作一种数据类型。适用于多种数据类型的函数，称为<strong>多态函数</strong>，或<strong>泛型函数</strong>。</p>
<p>多态函数的构建，一般是发现多个单态函数有相似的结构，这时，可以封装为一个多态函数。</p>
<h3 id=实例>实例</h3>
<p>比如一个函数，返回数组中第一个匹配到 key 的索引，否则返回 -1:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>findFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>key</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@annotatin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tailrec</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>		<span style=color:#8f5902;font-style:italic>// 到达数组尾部仍未匹配到 key，返回 -1
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ss</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>n</span>	<span style=color:#8f5902;font-style:italic>// 匹配到 key，返回索引
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>			<span style=color:#8f5902;font-style:italic>// 递归调用
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这是从 String 数组中匹配，如果是从 Int 数组查找匹配，也是类似的结构，因此我们就可以将它改写为一个从 A 类型数组中查找对应索引的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>findFirst</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Array</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>p</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#5c35cc;font-weight:700>@annotatin</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tailrec</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>p</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#000>n</span>			<span style=color:#8f5902;font-style:italic>// 使用传入的 测试函数 p 对当前元素进行判断
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>loop</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>函数名后跟的是<strong>类型参数</strong>，由中括号包围，多个参数使用逗号分隔，一般使用单个大写字母表示一个类型参数。这些类型参数作为<strong>类型变量</strong>，可以在其他类型签名中引用，比如上面的<code>as</code>参数类型。</p>
<h3 id=向高阶函数传入匿名函数>向高阶函数传入匿名函数</h3>
<p>在调用高阶函数时，并没有必要提前定义一个有名函数然后再传入，可以在调用时直接定义一个函数值作为高阶函数的参数，这被称为<strong>匿名函数</strong>或<strong>函数字面量</strong>。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>findFirst</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Array</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p><code>(x:Int) => x == 9</code>即为一个匿名函数，或称为函数字面量。</p>
<p>匿名函数中，<code>=></code>左边为该函数的参数列表，右边则会函数体。如果 Scala 可以推断参数的类型，则可以省略掉。</p>
<blockquote>
<p>函数也是值</p>
<p>当定义一个函数字面量时，实际上是定义了一个包含一个<code>apply</code>方法的 Scala 对象。而当一个对象拥有<code>apply</code>方法，则可以把该对象当做方法一样调用。</p>
<p>比如我们定义一个函数字面量<code>(a, b) => a &lt; b</code>，它事实上是创建函数对象的语法糖：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>lessThan</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Function2</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>Int</span>, <span style=color:#204a87;font-weight:700>Boolean</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>b</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>lessThan</code>的类型为<code>Function2[Int, Int, Boolean]</code>，通常会写成<code>(a, b) => Boolean</code>。<code>Function2</code>特质拥有一个<code>apply</code>方法，在调用<code>lessThan(10, 20)</code>时实际上是对<code>apply</code>方法调用的语法糖：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>lessThan</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#ce5c00;font-weight:700>)</span> 		<span style=color:#8f5902;font-style:italic>// true
</span></code></pre></div><p>这些类似<code>Function2</code>的特质，实际是由 Scala 标准库提供的普通特质，比如<code>Function1</code>、<code>Funciton3</code>等等。其中的数字是指接收的参数个数。</p>
<p>因为这些函数在 Scala 中是普通对象，因此他们也是一等值。</p>
</blockquote>
<h2 id=通过类型实现多态>通过类型实现多态</h2>
<p>在实现多态函数时，各种可能的实现方式明显比普通函数减少了。比如针对类型 A 的多态函数，唯一能够对 A 进行操作的方式是传入一个函数作为参数，通过这个传入的函数来操作 A。</p>
<p>比如一个例子，这个函数签名表示它只有一种实现方式。它是一个执行<strong>部分应用</strong>的高阶函数。函数<code>partial1</code>接收一个值和一个带有两个参数的函数，并返回一个带有一个参数的函数。</p>
<blockquote>
<p><strong>部分应用函数</strong>，表示函数被应用的参数并不是它需要的完整参数，即只提供了参数列表中的部分参数。</p>
</blockquote>
<p><code>def partial1[A, B, C](a:A, f: (A, B) => c): B => C</code></p>
<p>我们该如何实现这个高阶函数呢。根据它的返回值类型，是接收一个类型 B 的参数并返回一个类型 C 的值的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>partial1</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>C</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>C</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#ce5c00;font-weight:700>???</span>			<span style=color:#8f5902;font-style:italic>// 根据返回值类型 B =&gt; C ，定义一个该返回值类型的函数
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在如何来实现方法体部分呢，根据声明，这个函数必须返回一个 C 类型的值。而在<code>partial1</code>的参数列表中，正好有一个函数<code>f</code>能够返回一个 C 类型的值。除此之外，我们没有其他方式来实现该函数体。因此：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>partial1</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span>, <span style=color:#204a87;font-weight:700>C</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>a</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>C</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>)</span>		<span style=color:#8f5902;font-style:italic>// 调用参数中的函数，实现符合返回类型的函数体
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这也就是<strong>部分应用函数</strong>的实现过程，一个函数，接收两个参数，返回一个值。当我们只提供一个参数值时，在这个例子中，是<code>a</code>，这时会得到一个 “接收一个参数并返回一个值的” 函数。然后在提供原始函数需要的第二个参数，即<code>b</code>，就能得到最终的结果， 即<code>c</code>。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-ea16a70504134b7249c95e29e5f64348>2.4 - CH03-数据</h1>
<h2 id=定义函数式数据结构>定义函数式数据结构</h2>
<p>函数式数据结构只能被纯函数操作，纯函数一定不能修改原始数据或产生副作用。因此，<strong>函数式数据结构被定义为不可变的</strong>。</p>
<p>比如单链表的实现：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Nothing</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>head</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>tail</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>	<span style=color:#8f5902;font-style:italic>// 递归引用自身类型
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ints</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ints</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>0</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>product</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ds</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ds</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>1.0</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0.0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>0.0</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>product</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A*</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Nil</span>
    <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>apply</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>as</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>tail</span><span style=color:#204a87;font-weight:700>:_</span><span style=color:#204a87;font-weight:700>*</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p><code>List[+A]</code>表示它是一个泛型数据类型。同时拥有两种实现，或者说是两种构造器，每种都由<code>case</code>关键字定义，表示它的两种可能的形式。如果<code>List</code>为空，则用<code>Nil</code>表示，如果非空，则用构造器<code>Cons</code>表示。一个非空列表由初始元素<code>head</code>和后续紧跟的也是<code>List</code>结构的<code>tail</code>构成，并且，这个<code>tail</code>可能为空，即他可能是一个<code>Nil</code>。</p>
<p>这就是一个典型的数据构造器声明，为我们提供了一个函数来构造该类型数据的不同形式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ex1</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Nil</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ex2</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ex3</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><h2 id=模式匹配>模式匹配</h2>
<p>在<code>List</code>的伴生对象中定义了两个方法，<code>sum</code>和<code>product</code>，他们都使用了模式匹配。同时他们都是以递归的方式定义，这在编写操作递归数据类型的函数时很常见。</p>
<p>模式匹配类似于<code>switch</code>，他可以侵入到表达式的数据结构内部，对这个结构进行检验和提取子表达式。符号<code>=></code>左边为<strong>模式</strong>，右边为<strong>结果</strong>。</p>
<p>如果将模式中的变量分配给目标子表达式，使得它在<strong>结构</strong>上与<strong>目标</strong>一致，模式与目标就是一致的。匹配上的话，结果表达式就可以访问这些模式中定义的局部变量。</p>
<h2 id=函数式数据结构的数据共享>函数式数据结构的数据共享</h2>
<p>当一个新的元素添加到已有的列表时返回一个新的列表。<strong>既然列表是不可变的</strong>，并不需要真的去复制一份原有列表，而是直接去复用它，比如向原有的列表 xs 添加一个数字 1，返回一个<code>Cons(1, xs)</code>。</p>
<p>同样，删除列表的第一个元素，比如<code>myList = Cons(x, xs)</code>，这时只需要返回尾部的<code>xs</code>。并没有真的删除任何元素。原始的<code>myList</code>依然可用，不会受到任何影响。</p>
<p>这被称为<strong>数据共享</strong>。</p>
<p>“函数式数据结构是持久的”，是指：已存在的引用不会因数据结构的操作而改变。</p>
<h2 id=数据共享的效率>数据共享的效率</h2>
<p>？？？</p>
<h2 id=高阶函数的类型推导>高阶函数的类型推导</h2>
<p>当向一个高阶函数传递函数类型的参数时，需要标识该函数的类型。比如高阶函数<code>dropWhile</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>dropWhile</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>l</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p>当调用该函数时，参数函数<code>f</code>必须制定它的参数类型：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>ex1</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>dropWhile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// (x:Int) 指定参数类型为 Int
</span></code></pre></div><p>因为<code>dropWhile</code>的两个参数都使用类型参数<code>A</code>，前一个参数<code>l</code>的类型为<code>Int</code>，因此第二个参数的类型也必须是<code>Int</code>。</p>
<p><strong>当函数定义包含多个参数组时，参数组里的类型信息从左到右进行传递。</strong></p>
<p>因此我们把<code>dropWhile</code>的参数列表分开，让他成为一个柯里化函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>dropWhile</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#000>as</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>h</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>dropWhile</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>as</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>现在可以这样调用<code>dropWhile</code>，<code>dropWhile(xs)(x => x &lt; 4)</code>。当调用<code>dropWhile(xs)</code>时他会返回一个函数，这时已经确定第一个参数的类型为<code>A</code>，因此第二个参数时就不再需要进行类型标注了，它的类型只能为<code>A</code>。</p>
<p>通过将函数参数分组排序成多个参数列表(将函数柯里化)，来最大化的利用类型推导。</p>
<h2 id=基于-list-的递归并泛化为高阶函数>基于 List 的递归并泛化为高阶函数</h2>
<p>回顾前面的<code>sum</code>和<code>product</code>函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ints</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ints</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>sum</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>product</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ds</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ds</span> <span style=color:#204a87;font-weight:700>match</span><span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>1.0</span>
  <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>product</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>这两个函数的结构类似，不同在于他们操作的数据类型(Int/Double)、<code>Nil</code>时返回的值(0/1.0)、以及对结果的组合操作(+/*)。</p>
<p>对于这两个函数的抽象，首先将<code>Int/Double</code>泛化为类型参数<code>A</code>，而<code>Nil</code>的返回值，可以作为一个函数参数由客户端提供。</p>
<p><strong>如果一个子表达式引用了任何局部变量，把子表达式放入一个接收这些局部变量作为参数的函数</strong>。</p>
<p>比如上面这两个函数中的<code>x + sum(xs)</code>和<code>x * product(xs)</code>部分，都是对局部变量的引用，因此可以抽象为函数<code>f: (A, B) => B</code>。最终，把上面两个函数改写成下面的方式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>as</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>z</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#000>as</span> <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Nil</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>z</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#000>f</span><span style=color:#ce5c00;font-weight:700>))</span>
  <span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>sum2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ns</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>product2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ns</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#ce5c00;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>_</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87;font-weight:700>_</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>这里需要注意的是，与之前遇到的泛化不同，该函数的最终计算结果类型与传入的列表类型并不相同，如函数签名<code>foldRight[A, B](as: List[A], z: B)(f: (A, B) => B): B</code>所示，它的最终计算结果与传入的参数<code>z</code>类型一致，即类型<code>B</code>。</p>
<p>因为整个函数的计算过程就是对列表进行循环，一直遍历到列表末尾，这个过程中不断压栈，直至列表的末尾，即<code>Nil</code>。而遇到<code>Nil</code>时返回的值为传入的参数<code>z</code>，套用传入的函数<code>f</code>，也就是通过传入列表的最后一个元素(Nil 之前的元素)与<code>z</code>来调用函数<code>f</code>，得到栈顶的值。然后依次出栈，完成整个计算过程。</p>
<p>可以函数的调用使用传入的函数<code>f</code>进行替换：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#000>f</span>	<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>f</span>   <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>z</span>  <span style=color:#ce5c00;font-weight:700>))</span>
</code></pre></div><p><code>foldRight</code>函数为 Scala 标准库中<code>List</code>的内置函数，上面的替换过程也就是它的计算过程。</p>
<p>比如我们调用<code>sum2(List(1,2,3), 0)((x, y) => x + y)</code>，跟踪其运算过程：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>))),</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Cons</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>foldRight</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Nil</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>)((</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>))))</span> <span style=color:#8f5902;font-style:italic>// Nil, 终止递归，替换为(0 + 0)
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>))</span>
<span style=color:#0000cf;font-weight:700>6</span>
</code></pre></div><h2 id=树>树</h2>
<p>List 是<strong>代数数据类型(ADT)<strong>的一种，有些场景或称为</strong>抽象数据类型</strong>。</p>
<p>ADT 是由一个或多个数据构造器所定义的数据类型，每个构造器可以包含零个或多个参数。数据构造器通过累加(sum)或联合(union)构成数据类型，而每个数据构造器又是其参数的<strong>乘积(product)</strong>。因此称为<strong>代数</strong>数据类型。</p>
<p>ADT 用于构造其他数据结构。定义一个二叉树数据结构：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Tree</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Leaf</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Tree</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Branch</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>left</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Tree</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>right</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Tree</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Tree</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-6cbae87fa8d5efc949b3b87261ed10fc>2.5 - CH04-异常</h1>
<p>抛出异常会产生副作用，在函数式解决方案中，以值的方式返回错误更安全，符合引用透明，并且可以通过高阶函数保存异常的优点 - 统一错误处理逻辑。核心思想就是使用普票值来表现异常。</p>
<h2 id=异常的优点与劣势>异常的优点与劣势</h2>
<p>一个抛出异常的例子：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>failingFn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fail!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> 	<span style=color:#8f5902;font-style:italic>// 抛出异常
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>5</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span>
  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Exception</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>43</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>调用该函数会抛出预期的异常，为了证明异常会破坏引用透明，我们可以将<code>y</code>进行替换：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>failingFn2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>i</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span><span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#0000cf;font-weight:700>5</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;fail!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span>	<span style=color:#8f5902;font-style:italic>// 抛出异常的表达式可以声明为任何类型
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Exception</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#0000cf;font-weight:700>43</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>运行结果会得到 43 而不是像替换前一样排除预期的异常，因此，异常并不是引用透明的。</p>
<p>引用透明的表达式<strong>不依赖上下文</strong>，可以本地推导，而那些非引用透明的表达式是<strong>依赖上下文的</strong>，并且需要全局推导。比如把<code>42 + 5</code>这个表达式嵌入到一个更大的表达式中，他不会受这个更大的表达式的影响，即对更大的表达式产生依赖，它永远等于 47。但是把<code>throw new...</code>嵌入到一个更大的表达式，比如嵌入到一个<code>try/catch</code>结构中，它的值取决于<code>catch</code>部分的处理，因此对更大的表达式产生了依赖。</p>
<p>异常的问题：</p>
<ul>
<li>异常破坏了引用透明并且引入了上下文依赖。</li>
<li>异常不是类型安全的。函数<code>failing</code>，<code>Int => Int</code>并不会告诉我们会发生什么样的异常。因为没有受检异常，直到运行时才会发现异常。</li>
</ul>
<p>我们希望其他选择能够排除异常的这些缺点，但是又不想失去异常最主要的好处：<strong>整合集中的错误处理逻辑</strong>，而不是在整个代码库发布这个逻辑。</p>
<h2 id=异常的其他选择>异常的其他选择</h2>
<p>比如一个计算列表平均值的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArithmeticException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mean of empty list!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
</code></pre></div><p>这是一个典型的<strong>偏函数</strong>，他对一些输入没有做定义。如果一个函数对那些非隐式的输入类型做了一些假设，那它就是一个典型的偏函数。</p>
<p>除了选择抛出异常，还有其他的选择。</p>
<p>第一种是返回某个伪造的 Double 类型的值。比如为空时返回<code>Double.NaN</code>，或者其他报警值，或者<code>null</code>。但是以下理由使我们放弃这种方案：</p>
<ul>
<li>它允许错误<strong>无声</strong>的传播，如果忘了对这样的值进行检查也不会得到警告，会使后面的代码出错。</li>
<li>使用显式的<code>if</code>来检查是否得到了正确的结果会导致大量的模板代码，特别是调用多个函数时。</li>
<li>不适用与多态代码。比如一个查找最大值的泛型函数<code>def max[A](xs:List[A])</code>，当传入为空时无法发明一个 A 类型的值。也不能是<code>null</code>，因为<code>null</code>只对非基础类型有效，但是这里的 A 可能是<code>Int</code>或<code>Double</code>。</li>
<li>需要一个特定的策略或调用约定 - 告诉调用者如何合理的使用<code>mean</code>函数。这导致它不能传递给高阶函数，因为高阶函数对待所有参数都是一致的。</li>
</ul>
<p>第二种是强迫调用者提供一个参数告诉我们该如何处理。比如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Seq</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>],</span> <span style=color:#000>onEmpty</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Double</span> <span style=color:#ce5c00;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>onEmpty</span>
  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span>
</code></pre></div><p>这使<code>mean</code>函数称为一个<strong>完全函数</strong>。调用者必须知道如何处理未定义的情况。</p>
<h2 id=option-数据类型>Option 数据类型</h2>
<p>解决方案是在返回值类型明确表示该函数并不总是有结果。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>get</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>object</span> <span style=color:#000>None</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p><code>Option</code>是一个最多只包含一个元素的<code>List</code>。</p>
<h3 id=基础-option-函数>基础 Option 函数</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>map</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>					<span style=color:#8f5902;font-style:italic>// 如果 Option 不为 None，对其应用 f
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>flatMap</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> 		<span style=color:#8f5902;font-style:italic>// 如果 Option 不为 None，对其应用 f，可能会失败
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>getOrElse</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>default</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>B</span>				<span style=color:#8f5902;font-style:italic>// 默认值类型 B 必须是 A 的父类
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>orElse</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span> <span style=color:#204a87;font-weight:700>&gt;:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>ob</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span>	<span style=color:#8f5902;font-style:italic>// 不对 ob 求值，除非需要
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>filter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> 			<span style=color:#8f5902;font-style:italic>// 如果值不满足，转换 Some 为 None
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><h3 id=基础函数使用场景>基础函数使用场景</h3>
<p>???</p>
<h3 id=option-组合提升面向异常的-api-封装>Option 组合、提升、面向异常的 API 封装</h3>
<p>可能会认为，一旦开始使用<code>Option</code>，整个库都会受影响，因为一些方法必须改变为接收或返回<code>Option</code>。但是，我们可以把一个普通函数**提升(lift)**为一个对<code>Option</code>操作的函数。</p>
<p>比如，<code>map</code>函数支持我们用一个类型为<code>A => B</code>的函数来操作一个<code>Option</code>。从另一个角度看，<code>map</code>可以把一个<code>A => B</code>的函数转换为<code>Option[A] => Option[B]</code>类型的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>lift</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span>, <span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>f</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>B</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>B</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>_</span> <span style=color:#000>map</span> <span style=color:#000>f</span>
</code></pre></div><p>现在，可以把普通的<code>abs</code>函数转换为处理<code>Option</code>的函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>absOpt</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=&gt;</span> <span style=color:#000>Option</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>lift</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>math</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>abs</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>而<code>Try</code>函数是一个通用目的的函数，用于将一个基于异常的 API 转换成一个面向<code>Option</code>的 API。</p>
<h2 id=either-数据类型>Either 数据类型</h2>
<p><code>Option</code>只能用来表示可能不存在的值，并不能表示异常条件下发生了什么错误。如果除了需要获取异常时可能的值，还需要知道异常时的错误信息，可以使用<code>Either</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>sealed</span> <span style=color:#204a87;font-weight:700>trait</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+E</span>, <span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+E</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>E</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>E</span>, <span style=color:#204a87;font-weight:700>Nothing</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>case</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>+A</span><span style=color:#ce5c00;font-weight:700>](</span><span style=color:#000>value</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Nothing</span>, <span style=color:#204a87;font-weight:700>A</span><span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><p><code>Either</code>在两种情况都有值，它的值只能是两种情况中的一种，称他是两个类型的<strong>互斥并集</strong>。一般使用<code>Left</code>表示失败，而<code>Right</code>表示成功。</p>
<p>使用<code>Either</code>改写前面的<code>mean</code>函数：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>mean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>List</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>])</span><span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>String</span>, <span style=color:#204a87;font-weight:700>Double</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>isEmpty</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;mean of empty list!&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>sum</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>xs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>length</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>或者在<code>Left</code>中包含处理的异常以获取详细的调用栈信息：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>safeDiv</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Either</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>Exception</span>, <span style=color:#204a87;font-weight:700>Int</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#204a87;font-weight:700>=</span> 
  <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000>Right</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>e</span><span style=color:#204a87;font-weight:700>:</span><span style=color:#204a87;font-weight:700>Exception</span> <span style=color:#ce5c00;font-weight:700>=&gt;</span> <span style=color:#000>Left</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)}</span>
</code></pre></div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Weibo aria-label=Weibo>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://weibo.com/u/3848950217>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/zhange_zzg>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://stackoverflow.com>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/infilos/infilos.com>
<i class="fab fa-github"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 infilos.com All Rights Reserved</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script>
</body>
</html>