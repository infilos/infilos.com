
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Infilos's persional workspace.">
      
      
      
        <meta name="author" content="infilos">
      
      
        <link rel="canonical" href="https://www.infilos.com/tcpip/CH04-%E7%90%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E6%A0%88/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>CH04-理解网络栈 - Infilos Workspace</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Ubuntu";--md-code-font-family:"Ubuntu Mono"}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-123062585-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  
  
    
  
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Infilos Workspace - CH04-理解网络栈">
  <meta property="og:description" content="Infilos's persional workspace.">
  <meta property="og:url" content="https://www.infilos.com/tcpip/CH04-%E7%90%86%E8%A7%A3%E7%BD%91%E7%BB%9C%E6%A0%88/">
  <meta property="og:image" content="https://www.infilos.comassets/images/banner.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1080">
  <meta property="og:image:height" content="568">
  <link rel="stylesheet" href="../../assets/stylesheets/main.4ea92eb1.min.css">

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ch04-" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-announce">
          <div class="md-announce__inner md-grid md-typeset">
            

          </div>
        </aside>
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Infilos Workspace" class="md-header__button md-logo" aria-label="Infilos Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Infilos Workspace
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              CH04-理解网络栈
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/infilos/infilos.com" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    infilos/infilos.com
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../os/" class="md-tabs__link md-tabs__link--active">
        Basic
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../java-base/CH01-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="md-tabs__link">
        Language
      </a>
    </li>
  

  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../spring/CH01-IOC/" class="md-tabs__link">
        Project
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../rdbms/CH01-%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F/" class="md-tabs__link">
        Architect
      </a>
    </li>
  

  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../ds/CH01-%E6%95%B0%E7%BB%84-%E9%93%BE%E8%A1%A8/" class="md-tabs__link">
        Interview
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../open-source/" class="md-tabs__link">
      Open Source
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../wip/" class="md-tabs__link">
      Blog
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../wip/" class="md-tabs__link">
      About
    </a>
  </li>

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Infilos Workspace" class="md-nav__button md-logo" aria-label="Infilos Workspace" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Infilos Workspace
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/infilos/infilos.com" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
  </div>
  <div class="md-source__repository">
    infilos/infilos.com
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Basic
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Basic" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Basic
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        操作系统
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="操作系统" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          操作系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/" class="md-nav__link">
        CH00-概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH02-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D/" class="md-nav__link">
        CH02-操作系统介绍
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH04-%E6%8A%BD%E8%B1%A1-%E8%BF%9B%E7%A8%8B/" class="md-nav__link">
        CH04-抽象-进程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH05-%E6%8F%92%E5%8F%99-%E8%BF%9B%E7%A8%8B%20API/" class="md-nav__link">
        CH05-插叙-进程 API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH06-%E6%9C%BA%E5%88%B6-%E5%8F%97%E9%99%90%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C/" class="md-nav__link">
        CH06-机制-受限直接执行
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH07-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/" class="md-nav__link">
        CH07-进程调度
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH08-%E8%B0%83%E5%BA%A6-%E5%A4%9A%E7%BA%A7%E5%8F%8D%E9%A6%88%E9%98%9F%E5%88%97/" class="md-nav__link">
        CH08-调度-多级反馈队列
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH09-%E8%B0%83%E5%BA%A6-%E6%AF%94%E4%BE%8B%E4%BB%BD%E9%A2%9D/" class="md-nav__link">
        CH09-调度-比例份额
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH10-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E8%B0%83%E5%BA%A6/" class="md-nav__link">
        CH10-多处理器调度
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH13-%E6%8A%BD%E8%B1%A1-%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" class="md-nav__link">
        CH13-抽象-地址空间
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH14-%E5%86%85%E5%AD%98%E6%8E%A5%E5%8F%A3/" class="md-nav__link">
        CH14-内存接口
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH15-%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2/" class="md-nav__link">
        CH15-地址转换
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os/CH16-%E5%88%86%E6%AE%B5/" class="md-nav__link">
        CH16-分段
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        操作系统-性能之殇
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="操作系统-性能之殇" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          操作系统-性能之殇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/" class="md-nav__link">
        CH00-概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH01-%E5%86%AF%E8%AF%BA%E4%BE%9D%E6%9B%BC%E7%93%B6%E9%A2%88/" class="md-nav__link">
        CH01-冯诺依曼瓶颈
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH02-CPU%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        CH02-CPU实现
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH03-%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8/" class="md-nav__link">
        CH03-事件驱动
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH04-Unix%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH04-Unix进程模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH05-DPDK-SDN-%E5%A4%A7%E9%A1%B5%E5%86%85%E5%AD%98/" class="md-nav__link">
        CH05-DPDK-SDN-大页内存
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH06-%E5%B1%80%E9%83%A8%E6%80%A7%E4%B8%8E%E4%B9%90%E8%A7%82/" class="md-nav__link">
        CH06-局部性与乐观
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../os-perf/CH07-%E5%85%B1%E5%90%8C%E7%9A%84%E7%93%B6%E9%A2%88/" class="md-nav__link">
        CH07-共同的瓶颈
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      <label class="md-nav__link" for="__nav_2_3">
        I/O 模型
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="I/O 模型" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          I/O 模型
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH01-IO%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH01-Linux IO/线程 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH02-IO%E9%9B%B6%E6%8B%B7%E8%B4%9D/" class="md-nav__link">
        CH02-Linux IO 零拷贝
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH03-Netty%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH03-Netty IO 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH04-Redis%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH04-Redis IO 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH05-Nginx%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH05-Nginx IO 模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../io-model/CH06-MySQL%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH06-MySQL模型
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      <label class="md-nav__link" for="__nav_2_4">
        Network
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Network" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Network
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH01-%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82/" class="md-nav__link">
        CH01-网络分层
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH02-IP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH02-IP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH03-TCP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH03-TCP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH04-UDP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH04-UDP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH05-HTTP%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        CH05-HTTP协议
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH06-WebSocket/" class="md-nav__link">
        CH06-WebSocket
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH07-DNS%E6%9C%8D%E5%8A%A1/" class="md-nav__link">
        CH07-DNS服务
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../network/CH08-%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%87%E7%A8%8B/" class="md-nav__link">
        CH08-浏览器过程
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" checked>
      
      <label class="md-nav__link" for="__nav_2_5">
        TCP/IP
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="TCP/IP" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          TCP/IP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH01-%E6%8F%A1%E6%89%8B%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH01-握手机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH02-%E5%8D%8F%E8%AE%AE%E6%A0%88%E7%B2%BE%E8%A6%81/" class="md-nav__link">
        CH02-协议栈精要
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH03-%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/" class="md-nav__link">
        CH03-调优参数
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          CH04-理解网络栈
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        CH04-理解网络栈
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcpip" class="md-nav__link">
    TCP/IP 的关键特性
  </a>
  
    <nav class="md-nav" aria-label="TCP/IP 的关键特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、面向连接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、双向字节流
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、有序抵达
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-ack" class="md-nav__link">
    4、通过 ACK 确保可靠性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5flow-control" class="md-nav__link">
    5、流控(Flow Control)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6congestion-control" class="md-nav__link">
    6、拥堵控制(Congestion Control)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    数据传输
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    数据接收
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    网络栈开发指南
  </a>
  
    <nav class="md-nav" aria-label="网络栈开发指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manipulation" class="md-nav__link">
    数据包处理步骤控制(Manipulation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    协议性能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    数据包处理效率
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    网络栈中的控制流程
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    如何处理中断、接收数据包
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    数据结构
  </a>
  
    <nav class="md-nav" aria-label="数据结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sk_buff" class="md-nav__link">
    sk_buff 结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    包数据与元数据
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    如何添加或删除头部
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    如何合并或拆分数据包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    快速分配与释放
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcp-tcb" class="md-nav__link">
    TCP 控制块(TCB)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    跟随代码：如何传输数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    跟随代码：如何接收数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nic" class="md-nav__link">
    驱动设备与 NIC 之间如何通信
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    栈缓冲区与流控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH05-RFC-1180/" class="md-nav__link">
        CH05-RFC-1180
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../CH06-%E5%8F%AF%E9%9D%A0%E6%80%A7%E7%96%91%E9%97%AE/" class="md-nav__link">
        CH06-可靠性疑问
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      <label class="md-nav__link" for="__nav_2_6">
        HTTP
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="HTTP" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          HTTP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH01-%E6%A6%82%E8%BF%B0/" class="md-nav__link">
        CH01-HTTP 概述
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH02-URL%E4%B8%8E%E8%B5%84%E6%BA%90/" class="md-nav__link">
        CH02-URL与资源
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH03-HTTP%E6%8A%A5%E6%96%87/" class="md-nav__link">
        CH03-HTTP报文
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH04-%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/" class="md-nav__link">
        CH04-连接管理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../http/CH99-%E6%80%A7%E8%83%BD%E6%8E%A2%E7%B4%A2/" class="md-nav__link">
        CH99-性能探索
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Language
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Language" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Language
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Java
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_1" type="checkbox" id="__nav_3_1_1" >
      
      <label class="md-nav__link" for="__nav_3_1_1">
        Java 基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 基础" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_1">
          <span class="md-nav__icon md-icon"></span>
          Java 基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH01-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="md-nav__link">
        CH01-面向对象
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH02-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" class="md-nav__link">
        CH02-基本知识
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH03-%E5%9F%BA%E6%9C%AC%E5%9B%BE%E8%B0%B1/" class="md-nav__link">
        CH03-基本图谱
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH04-%E6%B3%9B%E5%9E%8B%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH04-泛型机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH05-%E6%B3%A8%E8%A7%A3%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH05-注解机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH06-%E5%BC%82%E5%B8%B8%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH06-异常机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH07-%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH07-反射机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-base/CH08-SPI%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH08-SPI机制
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_2" type="checkbox" id="__nav_3_1_2" >
      
      <label class="md-nav__link" for="__nav_3_1_2">
        Java 集合
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 集合" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_2">
          <span class="md-nav__icon md-icon"></span>
          Java 集合
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH01-%E9%9B%86%E5%90%88%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH01-集合结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH02-ArrayList/" class="md-nav__link">
        CH02-ArrayList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH03-LinkedList/" class="md-nav__link">
        CH03-LinkedList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH04-Stack-Queue/" class="md-nav__link">
        CH04-Stack-Queue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH05-PriorityQueue/" class="md-nav__link">
        CH05-PriorityQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH06-HashSet-Map/" class="md-nav__link">
        CH06-HashSet-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH07-LinkedHashSet-Map/" class="md-nav__link">
        CH07-LinkedHashSet-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH08-TreeSet-Map/" class="md-nav__link">
        CH08-TreeSet-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-collection/CH09-WeakHashMap/" class="md-nav__link">
        CH09-WeakHashMap
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3" type="checkbox" id="__nav_3_1_3" >
      
      <label class="md-nav__link" for="__nav_3_1_3">
        Java 并发
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 并发" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_3">
          <span class="md-nav__icon md-icon"></span>
          Java 并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_1" type="checkbox" id="__nav_3_1_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1_3_1">
        基础
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="基础" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_1">
          <span class="md-nav__icon md-icon"></span>
          基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH01-%E5%B9%B6%E5%8F%91%E4%BD%93%E7%B3%BB/" class="md-nav__link">
        CH01-并发体系
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH02-%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        CH02-理论基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH03-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-1/" class="md-nav__link">
        CH03-线程基础-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH04-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80-2/" class="md-nav__link">
        CH04-线程基础-2
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_2" type="checkbox" id="__nav_3_1_3_2" >
      
      <label class="md-nav__link" for="__nav_3_1_3_2">
        关键字
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="关键字" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_2">
          <span class="md-nav__icon md-icon"></span>
          关键字
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH05-Synchronized/" class="md-nav__link">
        CH05-Synchronized
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH06-Volatile/" class="md-nav__link">
        CH06-Volatile
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH07-Final/" class="md-nav__link">
        CH07-Final
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_3" type="checkbox" id="__nav_3_1_3_3" >
      
      <label class="md-nav__link" for="__nav_3_1_3_3">
        锁
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="锁" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_3">
          <span class="md-nav__icon md-icon"></span>
          锁
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH08-%E5%B9%B6%E5%8F%91%E6%A6%82%E8%A7%88/" class="md-nav__link">
        CH08-并发概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH09-%E5%BA%95%E5%B1%82%E6%94%AF%E6%92%91/" class="md-nav__link">
        CH09-底层支撑
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH10-LockSupport/" class="md-nav__link">
        CH10-LockSupport
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH11-AQS-1/" class="md-nav__link">
        CH11-AQS-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH12-AQS-2/" class="md-nav__link">
        CH12-AQS-2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH13-AQS-3/" class="md-nav__link">
        CH13-AQS-3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH14-AQS-4/" class="md-nav__link">
        CH14-AQS-4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH15-ReentrantLock/" class="md-nav__link">
        CH15-ReentrantLock
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH16-ReentrantReadWriteLock/" class="md-nav__link">
        CH16-ReentrantReadWriteLock
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_4" type="checkbox" id="__nav_3_1_3_4" >
      
      <label class="md-nav__link" for="__nav_3_1_3_4">
        集合
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="集合" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_4">
          <span class="md-nav__icon md-icon"></span>
          集合
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH17-ConcurrentHashMap/" class="md-nav__link">
        CH17-ConcurrentHashMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH18-ConcurrentLinkedQueue/" class="md-nav__link">
        CH18-ConcurrentLinkedQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH19-BlockingQueue/" class="md-nav__link">
        CH19-BlockingQueue
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_5" type="checkbox" id="__nav_3_1_3_5" >
      
      <label class="md-nav__link" for="__nav_3_1_3_5">
        线程池
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="线程池" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_5">
          <span class="md-nav__icon md-icon"></span>
          线程池
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH20-FutureTask/" class="md-nav__link">
        CH20-FutureTask
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH21-ThreadPoolExecutor/" class="md-nav__link">
        CH21-ThreadPoolExecutor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH22-ScheduledThreadPoolExecutor/" class="md-nav__link">
        CH22-ScheduledThreadPoolExecutor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH23-ForkJoin/" class="md-nav__link">
        CH23-ForkJoin.md
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_6" type="checkbox" id="__nav_3_1_3_6" >
      
      <label class="md-nav__link" for="__nav_3_1_3_6">
        工具
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="工具" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_6">
          <span class="md-nav__icon md-icon"></span>
          工具
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH24-CountDownLatch/" class="md-nav__link">
        CH24-CountDownLatch
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH25-CyclicBarrier/" class="md-nav__link">
        CH25-CyclicBarrier
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH26-Semaphore/" class="md-nav__link">
        CH26-Semaphore
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH27-Phaser/" class="md-nav__link">
        CH27-Phaser
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH28-Exchanger/" class="md-nav__link">
        CH28-Exchanger
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH29-ThreadLocal/" class="md-nav__link">
        CH29-ThreadLocal
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_3_7" type="checkbox" id="__nav_3_1_3_7" >
      
      <label class="md-nav__link" for="__nav_3_1_3_7">
        汇总
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="汇总" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_1_3_7">
          <span class="md-nav__icon md-icon"></span>
          汇总
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH30-AllLocks/" class="md-nav__link">
        CH30-AllLocks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH31-AllQueues/" class="md-nav__link">
        CH31-AllQueues
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-concurrent/CH32-AllPools/" class="md-nav__link">
        CH32-AllPools
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_4" type="checkbox" id="__nav_3_1_4" >
      
      <label class="md-nav__link" for="__nav_3_1_4">
        Java I/O
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java I/O" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_4">
          <span class="md-nav__icon md-icon"></span>
          Java I/O
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH01-IO%E5%88%86%E7%B1%BB/" class="md-nav__link">
        CH01-IO分类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH02-%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH02-装饰模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH03-InputStream/" class="md-nav__link">
        CH03-InputStream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH04-OutputStream/" class="md-nav__link">
        CH04-OutputStream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH05-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/" class="md-nav__link">
        CH05-常用操作.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH06-IO%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        CH06-IO实现
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH07-IO%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH07-IO模型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH08-BIO%E5%8E%9F%E7%90%86/" class="md-nav__link">
        CH08-BIO原理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH09-NIO%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        CH09-NIO基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH10-NIO%E5%8E%9F%E7%90%86/" class="md-nav__link">
        CH10-NIO原理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH11-AIO%E5%8E%9F%E7%90%86/" class="md-nav__link">
        CH11-AIO原理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH12-%E9%9B%B6%E6%8B%B7%E8%B4%9D/" class="md-nav__link">
        CH12-零拷贝
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-io/CH13-%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84/" class="md-nav__link">
        CH13-内存映射
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_5" type="checkbox" id="__nav_3_1_5" >
      
      <label class="md-nav__link" for="__nav_3_1_5">
        Java JVM
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JVM" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_5">
          <span class="md-nav__icon md-icon"></span>
          Java JVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH01-JVM%E6%A6%82%E8%A7%88/" class="md-nav__link">
        CH01-JVM概览
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH02-JVM%E5%AD%97%E8%8A%82%E7%A0%81/" class="md-nav__link">
        CH02-JVM字节码
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH03-JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD/" class="md-nav__link">
        CH03-JVM类加载
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH04-JVM%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH04-JVM内存结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH05-JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-1/" class="md-nav__link">
        CH05-JVM内存模型-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH06-JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-2/" class="md-nav__link">
        CH06-JVM内存模型-2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH07-JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="md-nav__link">
        CH07-JVM垃圾回收
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH08-JVM-G1/" class="md-nav__link">
        CH08-JVM-G1.md
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH09-JVM-ZGC/" class="md-nav__link">
        CH09-JVM-ZGC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH10-JVM%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/" class="md-nav__link">
        CH10-JVM调优参数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH11-JVM-OOM/" class="md-nav__link">
        CH11-JVM-OOM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH12-JVM%E7%BA%BF%E7%A8%8BDump/" class="md-nav__link">
        CH12-JVM线程Dump
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH13-JVM%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        CH13-JVM调试命令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH14-JVM%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        CH14-JVM调试工具
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm/CH15-JVM%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95/" class="md-nav__link">
        CH15-JVM动态调试
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        JVM
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="JVM" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          JVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_1" type="checkbox" id="__nav_3_2_1" >
      
      <label class="md-nav__link" for="__nav_3_2_1">
        Java JSR-133
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JSR-133" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_1">
          <span class="md-nav__icon md-icon"></span>
          Java JSR-133
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH01-%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92/" class="md-nav__link">
        CH01-指令重排
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH02-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C/" class="md-nav__link">
        CH02-内存屏障
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH03-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8/" class="md-nav__link">
        CH03-多处理器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-133/CH04-%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" class="md-nav__link">
        CH04-开发指南
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_2" type="checkbox" id="__nav_3_2_2" >
      
      <label class="md-nav__link" for="__nav_3_2_2">
        Java JMM 规范
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JMM 规范" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_2">
          <span class="md-nav__icon md-icon"></span>
          Java JMM 规范
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH01-JMM%E8%A7%84%E8%8C%83/" class="md-nav__link">
        CH01-JMM规范
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH02-JMM%E8%A7%A3%E9%87%8A/" class="md-nav__link">
        CH02-JMM Explain
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH03-JMM%E5%8E%9F%E5%88%99/" class="md-nav__link">
        CH03-JMM原则
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH04-JSR133-FAQ/" class="md-nav__link">
        CH04-JSR133-FAQ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../jmm-spec/CH05-JSR133-Cook/" class="md-nav__link">
        CH05-JSR133-Cook
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3" type="checkbox" id="__nav_3_2_3" >
      
      <label class="md-nav__link" for="__nav_3_2_3">
        Java JVM 深入理解 V2
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java JVM 深入理解 V2" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_3">
          <span class="md-nav__icon md-icon"></span>
          Java JVM 深入理解 V2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_1" type="checkbox" id="__nav_3_2_3_1" >
      
      <label class="md-nav__link" for="__nav_3_2_3_1">
        开始
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="开始" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_1">
          <span class="md-nav__icon md-icon"></span>
          开始
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH01-%E8%B5%B0%E8%BF%9BJava/" class="md-nav__link">
        CH01-走近 Java
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_2" type="checkbox" id="__nav_3_2_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2_3_2">
        内存管理
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="内存管理" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_2">
          <span class="md-nav__icon md-icon"></span>
          内存管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH02-%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E4%B8%8E%E6%BA%A2%E5%87%BA%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        CH02-内存区域与溢出
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH03-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E4%B8%8E%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/" class="md-nav__link">
        CH03-垃圾收集与分配策略
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH04-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/" class="md-nav__link">
        CH04-性能监控与故障处理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH05-%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B/" class="md-nav__link">
        CH05-调优案例
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_3" type="checkbox" id="__nav_3_2_3_3" >
      
      <label class="md-nav__link" for="__nav_3_2_3_3">
        执行子系统
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="执行子系统" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_3">
          <span class="md-nav__icon md-icon"></span>
          执行子系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH06-%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH06-类文件结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH07-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH07-类加载
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH08-%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/" class="md-nav__link">
        CH08-字节码执行引擎
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH09-%E6%A1%88%E4%BE%8B%E4%B8%8E%E5%AE%9E%E6%88%98/" class="md-nav__link">
        CH09-案例与实战
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_4" type="checkbox" id="__nav_3_2_3_4" >
      
      <label class="md-nav__link" for="__nav_3_2_3_4">
        编译与优化
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="编译与优化" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_4">
          <span class="md-nav__icon md-icon"></span>
          编译与优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH10-%E7%BC%96%E8%AF%91%E6%9C%9F%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH10-编译期优化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH11-%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH11-运行时优化
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_5" type="checkbox" id="__nav_3_2_3_5" >
      
      <label class="md-nav__link" for="__nav_3_2_3_5">
        高效并发
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="高效并发" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_5">
          <span class="md-nav__icon md-icon"></span>
          高效并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH12-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" class="md-nav__link">
        CH12-内存模型与线程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/CH13-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH13-线程安全与锁优化
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_3_6" type="checkbox" id="__nav_3_2_3_6" >
      
      <label class="md-nav__link" for="__nav_3_2_3_6">
        附录
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="附录" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_3_6">
          <span class="md-nav__icon md-icon"></span>
          附录
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/Endix-B-%E6%8C%87%E4%BB%A4%E8%A1%A8/" class="md-nav__link">
        Endix-B-字节码指令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-jvm-dive-v2/Endix-C-%E5%8F%82%E6%95%B0%E8%A1%A8/" class="md-nav__link">
        Endix-C-虚拟机参数
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        Java JVM 深入理解 V3
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3">
        并发
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="并发" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          并发
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_1" type="checkbox" id="__nav_3_3_1" >
      
      <label class="md-nav__link" for="__nav_3_3_1">
        Java 并发实战
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 并发实战" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_1">
          <span class="md-nav__icon md-icon"></span>
          Java 并发实战
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH01-%E7%AE%80%E4%BB%8B/" class="md-nav__link">
        CH01-简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH02-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7/" class="md-nav__link">
        CH02-线程安全性
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH03-%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB/" class="md-nav__link">
        CH03-对象共享
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH04-%E5%AF%B9%E8%B1%A1%E7%BB%84%E5%90%88/" class="md-nav__link">
        CH04-对象组合
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH05-%E5%9F%BA%E7%A1%80%E6%9E%84%E5%BB%BA%E5%9D%97/" class="md-nav__link">
        CH05-基础构建块
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH06-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C/" class="md-nav__link">
        CH06-任务执行
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH07-%E5%8F%96%E6%B6%88%E5%85%B3%E9%97%AD/" class="md-nav__link">
        CH07-取消关闭
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH08-%E7%BA%BF%E7%A8%8B%E6%B1%A0/" class="md-nav__link">
        CH08-线程池
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH09-GUI%E5%BA%94%E7%94%A8/" class="md-nav__link">
        CH09-GUI应用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH10-%E6%B4%BB%E8%B7%83%E6%80%A7%E5%8D%B1%E9%99%A9/" class="md-nav__link">
        CH10-活跃性危险
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH11-%E6%80%A7%E8%83%BD%E4%B8%8E%E4%BC%B8%E7%BC%A9/" class="md-nav__link">
        CH11-性能与伸缩
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH12-%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        CH12-测试
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH13-%E6%98%BE%E5%BC%8F%E9%94%81/" class="md-nav__link">
        CH13-显式锁
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH14-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95/" class="md-nav__link">
        CH14-自定义扩展
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH15-%E5%8E%9F%E5%AD%90%E4%B8%8E%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5/" class="md-nav__link">
        CH15-原子与非阻塞同步
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-con-practice/CH16-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        CH16-内存模型
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        Java 并发模式
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_3" type="checkbox" id="__nav_3_3_3" >
      
      <label class="md-nav__link" for="__nav_3_3_3">
        深入理解并行
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="深入理解并行" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_3">
          <span class="md-nav__icon md-icon"></span>
          深入理解并行
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH01/" class="md-nav__link">
        CH01-关于本书
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH02/" class="md-nav__link">
        CH02-简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH03/" class="md-nav__link">
        CH03-硬件特性
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH04/" class="md-nav__link">
        CH04-并行工具
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH05/" class="md-nav__link">
        CH05-计数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH06/" class="md-nav__link">
        CH06-分割同步设计
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH07/" class="md-nav__link">
        CH07-锁
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH08/" class="md-nav__link">
        CH08-数据所有权
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH09/" class="md-nav__link">
        CH09-延后处理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH10/" class="md-nav__link">
        CH10-数据结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH11/" class="md-nav__link">
        CH11-验证
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH12/" class="md-nav__link">
        CH12-形式验证
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH13/" class="md-nav__link">
        CH13-综合应用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH14/" class="md-nav__link">
        CH14-高级同步
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/CH15/" class="md-nav__link">
        CH15-高级同步-内存序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../dive-parallel/Endix/" class="md-nav__link">
        ENDIX-C-内存屏障
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3_4" type="checkbox" id="__nav_3_3_4" >
      
      <label class="md-nav__link" for="__nav_3_3_4">
        七周七并发模型
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="七周七并发模型" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_3_4">
          <span class="md-nav__icon md-icon"></span>
          七周七并发模型
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH01/" class="md-nav__link">
        CH01-概述
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH02/" class="md-nav__link">
        CH02-线程与锁
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH03/" class="md-nav__link">
        CH03-函数式编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH04/" class="md-nav__link">
        CH04-分离标识与状态
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH05/" class="md-nav__link">
        CH05-Actor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH06/" class="md-nav__link">
        CH06-CSP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH07/" class="md-nav__link">
        CH07-数据并行
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH08/" class="md-nav__link">
        CH08-Lambda 架构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../seven-con-model/CH09/" class="md-nav__link">
        CH09-未来方向
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      <label class="md-nav__link" for="__nav_3_4">
        Scala
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Scala
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_1" type="checkbox" id="__nav_3_4_1" >
      
      <label class="md-nav__link" for="__nav_3_4_1">
        Scala 精要
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala 精要" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_1">
          <span class="md-nav__icon md-icon"></span>
          Scala 精要
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/case-class/" class="md-nav__link">
        Case Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/functional-1/" class="md-nav__link">
        函数式-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/functional-2/" class="md-nav__link">
        函数式-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-1/" class="md-nav__link">
        Future-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-2/" class="md-nav__link">
        Future-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-3/" class="md-nav__link">
        Future-集合
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/future-4/" class="md-nav__link">
        Future-Promise
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/implicits-1/" class="md-nav__link">
        Implicits-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/implicits-2/" class="md-nav__link">
        Implicits-进阶
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/trait-1/" class="md-nav__link">
        Trait-基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/trait-2/" class="md-nav__link">
        Trait-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/try/" class="md-nav__link">
        Try
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-1/" class="md-nav__link">
        Type-用例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-2/" class="md-nav__link">
        None
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-2/" class="md-nav__link">
        Type-进阶
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/primitive/" class="md-nav__link">
        Primitive
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/numbers/" class="md-nav__link">
        Numbers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/strings/" class="md-nav__link">
        String
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/control/" class="md-nav__link">
        Control
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/pattern-match/" class="md-nav__link">
        Pattern Match
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-1/" class="md-nav__link">
        Class Object: 基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-2/" class="md-nav__link">
        Class Object: 类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-3/" class="md-nav__link">
        Class Object: 方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-4/" class="md-nav__link">
        Class Object: 对象
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-5/" class="md-nav__link">
        函数式对象
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-6/" class="md-nav__link">
        整体类层级
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/class-object-7/" class="md-nav__link">
        组合继承
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/package/" class="md-nav__link">
        Package
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/sbt/" class="md-nav__link">
        SBT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/predef/" class="md-nav__link">
        Predef
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/io/" class="md-nav__link">
        I/O
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/reserved/" class="md-nav__link">
        保留字
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/exception/" class="md-nav__link">
        Exception
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/annotation/" class="md-nav__link">
        Inject Type
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-class/" class="md-nav__link">
        Type Class
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/map/" class="md-nav__link">
        Map Flatmap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/generic/" class="md-nav__link">
        泛型型变
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/common/" class="md-nav__link">
        常见问题
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/placeholder/" class="md-nav__link">
        占位符
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/multi-vars/" class="md-nav__link">
        多变量赋值
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/constructor/" class="md-nav__link">
        构造器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/type-system/" class="md-nav__link">
        类型系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/functional/" class="md-nav__link">
        函数式入门
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/monoid/" class="md-nav__link">
        Monoid
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/func-type-class/" class="md-nav__link">
        函数式与类型类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/async-programming/" class="md-nav__link">
        异步编程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala/scala-style/" class="md-nav__link">
        战略Scala风格：最小功率的原理
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4_2" type="checkbox" id="__nav_3_4_2" >
      
      <label class="md-nav__link" for="__nav_3_4_2">
        Scala 函数式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala 函数式" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_4_2">
          <span class="md-nav__icon md-icon"></span>
          Scala 函数式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH00-%E7%B2%BE%E8%A6%81/" class="md-nav__link">
        CH00-精要
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH01-%E5%AE%9A%E4%B9%89/" class="md-nav__link">
        CH01-定义
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH02-%E5%87%BD%E6%95%B0/" class="md-nav__link">
        CH02-函数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH03-%E6%95%B0%E6%8D%AE/" class="md-nav__link">
        CH03-数据
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-func/CH04-%E5%BC%82%E5%B8%B8/" class="md-nav__link">
        CH04-异常
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" type="checkbox" id="__nav_3_5" >
      
      <label class="md-nav__link" for="__nav_3_5">
        设计模式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="设计模式" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          设计模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5_1" type="checkbox" id="__nav_3_5_1" >
      
      <label class="md-nav__link" for="__nav_3_5_1">
        Java 模式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Java 模式" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_5_1">
          <span class="md-nav__icon md-icon"></span>
          Java 模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH01/" class="md-nav__link">
        CH01-创建型-简单工厂
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH02/" class="md-nav__link">
        CH02-创建型-工厂方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH03/" class="md-nav__link">
        CH03-创建型-抽象工厂
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH04/" class="md-nav__link">
        CH04-创建型-建造者
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH05/" class="md-nav__link">
        CH05-创建型-单例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH06/" class="md-nav__link">
        CH06-结构型-适配器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH07/" class="md-nav__link">
        CH07-结构型-桥接
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH08/" class="md-nav__link">
        CH08-结构型-装饰器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH09/" class="md-nav__link">
        CH09-结构型-外观
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH10/" class="md-nav__link">
        CH10-结构型-享元
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH11/" class="md-nav__link">
        CH11-结构型-代理
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH12/" class="md-nav__link">
        CH12-行为型-命令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH13/" class="md-nav__link">
        CH13-行为型-中介者
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH14/" class="md-nav__link">
        CH14-行为型-观察者
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH15/" class="md-nav__link">
        CH15-行为型-状态
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../java-pattern/CH16/" class="md-nav__link">
        CH16-行为型-策略
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5_2" type="checkbox" id="__nav_3_5_2" >
      
      <label class="md-nav__link" for="__nav_3_5_2">
        Scala 模式
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scala 模式" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_5_2">
          <span class="md-nav__icon md-icon"></span>
          Scala 模式
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH01-%E6%A8%A1%E5%BC%8F%E5%88%86%E7%B1%BB/" class="md-nav__link">
        CH01-模式分类
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH02-%E7%89%B9%E8%B4%A8%E4%B8%8E%E6%B7%B7%E5%85%A5%E7%BB%84%E5%90%88/" class="md-nav__link">
        CH02-特质与混入组合
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH03-%E7%BB%9F%E4%B8%80%E5%8C%96/" class="md-nav__link">
        CH03-统一化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH04-%E6%8A%BD%E8%B1%A1%E4%B8%8E%E8%87%AA%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH04-抽象与自类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH05-AOP%20%E4%B8%8E%E7%BB%84%E4%BB%B6/" class="md-nav__link">
        CH05-AOP 与组件
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-创建型模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-1-%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95/" class="md-nav__link">
        CH06-1-工厂方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-2-%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82/" class="md-nav__link">
        CH06-2-抽象工厂
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-3-%E5%85%B6%E4%BB%96%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-3-其他工厂模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-4-%E6%87%92%E5%88%9D%E5%A7%8B%E5%8C%96/" class="md-nav__link">
        CH06-4-懒初始化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-5-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-5-单例模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-6-%E6%9E%84%E5%BB%BA%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-6-构建器模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH06-7-%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH06-7-原型模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-结构型模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-1-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-1-适配器模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-2-%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-2-装饰器模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-3-%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-3-桥接模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-4-%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-4-组合模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-5-%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-5-外观模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-6-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-6-享元模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH07-7-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        CH07-7-代理模式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH08-%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F-1/" class="md-nav__link">
        CH08-行为型模式-1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH09-%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F-2/" class="md-nav__link">
        CH09-行为型模式-2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH10-%E5%87%BD%E6%95%B0%E5%BC%8F%E6%A8%A1%E5%BC%8F%E7%90%86%E8%AE%BA/" class="md-nav__link">
        CH10-函数式模式理论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH11-%E5%87%BD%E6%95%B0%E5%BC%8F%E6%A8%A1%E5%BC%8F%E5%BA%94%E7%94%A8/" class="md-nav__link">
        CH11-函数式模式应用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../scala-pattern/CH12-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/" class="md-nav__link">
        CH12-实际应用
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Project
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Project" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Project
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      <label class="md-nav__link" for="__nav_4_1">
        Spring
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Spring" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Spring
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../spring/CH01-IOC/" class="md-nav__link">
        CH01-IOC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../spring/CH02-SpringIOC/" class="md-nav__link">
        CH02-SpringIOC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../spring/CH03-Bean%E5%8A%A0%E8%BD%BD/" class="md-nav__link">
        CH03-Bean加载
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../spring/CH04-IOC%E6%BA%90%E7%A0%81/" class="md-nav__link">
        CH04-IOC源码
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../spring/CH05-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/" class="md-nav__link">
        CH05-循环依赖
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../spring/CH06-AOP/" class="md-nav__link">
        CH06-AOP
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Architect
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Architect" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Architect
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      <label class="md-nav__link" for="__nav_5_1">
        存储系统
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="存储系统" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          存储系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_1" type="checkbox" id="__nav_5_1_1" >
      
      <label class="md-nav__link" for="__nav_5_1_1">
        RDBMS
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="RDBMS" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_1">
          <span class="md-nav__icon md-icon"></span>
          RDBMS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH01-%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F/" class="md-nav__link">
        CH01-工作方式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH02-%E8%AE%BE%E8%AE%A1%E7%90%86%E8%AE%BA/" class="md-nav__link">
        CH02-设计理论
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH03-%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B/" class="md-nav__link">
        CH03-设计流程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../rdbms/CH04-%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/" class="md-nav__link">
        CH04-核心知识
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_2" type="checkbox" id="__nav_5_1_2" >
      
      <label class="md-nav__link" for="__nav_5_1_2">
        SQL
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="SQL" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_2">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH01-%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        CH01-语法基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH02-%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0/" class="md-nav__link">
        CH02-语句联系
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH03-%E6%9F%A5%E8%AF%A2%E8%BF%9B%E9%98%B6/" class="md-nav__link">
        CH03-查询进阶
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../sql/CH04-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH04-查询优化
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_3" type="checkbox" id="__nav_5_1_3" >
      
      <label class="md-nav__link" for="__nav_5_1_3">
        MySQL
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="MySQL" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_3">
          <span class="md-nav__icon md-icon"></span>
          MySQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH01-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH01-数据类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH02-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/" class="md-nav__link">
        CH02-存储引擎
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH03-%E7%B4%A2%E5%BC%95B%2B%E6%A0%91/" class="md-nav__link">
        CH03-索引B+树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH04-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="md-nav__link">
        CH04-性能优化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH05-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" class="md-nav__link">
        CH05-分库分表
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH06-%E5%A4%8D%E5%88%B6%E5%88%86%E7%A6%BB/" class="md-nav__link">
        CH06-复制分离
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/CH07-%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/" class="md-nav__link">
        CH07-执行过程
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_4" type="checkbox" id="__nav_5_1_4" >
      
      <label class="md-nav__link" for="__nav_5_1_4">
        Redis
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Redis" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_4">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH01-%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH01-基本类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH02-%E9%AB%98%E7%BA%A7%E7%B1%BB%E5%9E%8B/" class="md-nav__link">
        CH02-高级类型
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH03-Stream/" class="md-nav__link">
        CH03-Stream
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH04-%E5%AF%B9%E8%B1%A1%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        CH04-对象机制
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/CH05-%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84/" class="md-nav__link">
        CH05-底层结构
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        微服务
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        分布式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        反应式
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        数据密集
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        流式系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        消息系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        计算系统
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        运维交付
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        用户界面
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Interview
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Interview" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Interview
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      <label class="md-nav__link" for="__nav_6_1">
        数据结构
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="数据结构" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          数据结构
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH01-%E6%95%B0%E7%BB%84-%E9%93%BE%E8%A1%A8/" class="md-nav__link">
        CH01-数组/链表
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH02-%E5%93%88%E5%B8%8C%E8%A1%A8/" class="md-nav__link">
        CH02-哈希表
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH03-%E6%A0%91-%E4%BA%8C%E5%8F%89%E6%A0%91/" class="md-nav__link">
        CH03-树/二叉树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH04-%E6%8E%92%E5%BA%8F%E4%BA%8C%E5%8F%89%E6%A0%91/" class="md-nav__link">
        CH04-排序二叉树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH05-%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91/" class="md-nav__link">
        CH05-平衡二叉树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH06-%E7%BA%A2%E9%BB%91%E6%A0%91/" class="md-nav__link">
        CH06-红黑树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH07-%E5%93%88%E5%A4%AB%E6%9B%BC%E6%A0%91/" class="md-nav__link">
        CH07-哈夫曼树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH08-%E5%89%8D%E7%BC%80%E6%A0%91/" class="md-nav__link">
        CH08-前缀树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH09-%E5%9B%BE%E6%A6%82%E5%BF%B5/" class="md-nav__link">
        CH09-图概念
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH10-%E9%81%8D%E5%8E%86/" class="md-nav__link">
        CH10-遍历
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH11-%E6%9C%80%E5%B0%8F%E7%94%9F%E6%88%90%E6%A0%91/" class="md-nav__link">
        CH11-最小生成树
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH12-%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84/" class="md-nav__link">
        CH12-最短路径
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH13-%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH13-拓扑排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH14-AOE-%E5%85%B3%E9%94%AE%E8%B7%AF%E5%BE%84/" class="md-nav__link">
        CH14-AOE-关键路径
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH15-Iterable/" class="md-nav__link">
        CH07-Iterable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH16-Collection/" class="md-nav__link">
        CH16-Collection
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH17-List/" class="md-nav__link">
        CH17-List
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH18-ArrayList/" class="md-nav__link">
        CH18-ArrayList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH19-Queue/" class="md-nav__link">
        CH19-Queue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH20-Deque/" class="md-nav__link">
        CH20-Deque
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH21-ArrayQueue/" class="md-nav__link">
        CH21-ArrayQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH22-PriorityQueue/" class="md-nav__link">
        CH22-PriorityQueue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH23-LinkedList/" class="md-nav__link">
        CH23-LinkedList
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH24-Vector/" class="md-nav__link">
        CH24-Vector
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH25-Stack/" class="md-nav__link">
        CH25-Stack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH26-Map/" class="md-nav__link">
        CH26-Map
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH27-SortedMap/" class="md-nav__link">
        CH27-SortedMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH28-NavigableMap/" class="md-nav__link">
        CH28-NavigableMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH29-TreeMap/" class="md-nav__link">
        CH29-TreeMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH30-HashMap/" class="md-nav__link">
        CH30-HashMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH31-LinkedHashMap/" class="md-nav__link">
        CH31-LinkedHashMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH32-EnumMap/" class="md-nav__link">
        CH32-EnumMap
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH33-HashTable/" class="md-nav__link">
        CH33-HashTable
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH34-Set/" class="md-nav__link">
        CH34-Set
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH35-EnumSet/" class="md-nav__link">
        CH35-EnumSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH36-HashSet/" class="md-nav__link">
        CH36-HashSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH37-LinkedHashSet/" class="md-nav__link">
        CH37-LinkedHashSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH38-TreeSet/" class="md-nav__link">
        CH38-TreeSet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ds/CH39-FailFast/" class="md-nav__link">
        CH39-FailFast
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      <label class="md-nav__link" for="__nav_6_2">
        排序算法
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="排序算法" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          排序算法
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH01-%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH01-冒泡排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH02-%E9%80%89%E6%8B%A9%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH02-选择排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH03-%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH03-插入排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH04-%E5%B8%8C%E5%B0%94%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH04-希尔排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH05-%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH05-归并排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH06-%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH06-快速排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH07-%E5%A0%86%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH07-堆排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH08-%E8%AE%A1%E6%95%B0%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH08-计数排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH09-%E6%A1%B6%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH09-桶排序
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../algo/CH10-%E5%9F%BA%E6%95%B0%E6%8E%92%E5%BA%8F/" class="md-nav__link">
        CH10-基数排序
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      <label class="md-nav__link" for="__nav_6_3">
        剑指 Offer
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="剑指 Offer" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          剑指 Offer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      <label class="md-nav__link" for="__nav_6_4">
        面试指南
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试指南" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          面试指南
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      <label class="md-nav__link" for="__nav_6_5">
        面试宝典
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试宝典" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          面试宝典
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_6" type="checkbox" id="__nav_6_6" >
      
      <label class="md-nav__link" for="__nav_6_6">
        面试金典
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试金典" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_6">
          <span class="md-nav__icon md-icon"></span>
          面试金典
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_7" type="checkbox" id="__nav_6_7" >
      
      <label class="md-nav__link" for="__nav_6_7">
        Leet Code
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Leet Code" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_7">
          <span class="md-nav__icon md-icon"></span>
          Leet Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        None
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../open-source/" class="md-nav__link">
        Open Source
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        Blog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../wip/" class="md-nav__link">
        About
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcpip" class="md-nav__link">
    TCP/IP 的关键特性
  </a>
  
    <nav class="md-nav" aria-label="TCP/IP 的关键特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、面向连接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、双向字节流
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、有序抵达
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-ack" class="md-nav__link">
    4、通过 ACK 确保可靠性
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5flow-control" class="md-nav__link">
    5、流控(Flow Control)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6congestion-control" class="md-nav__link">
    6、拥堵控制(Congestion Control)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    数据传输
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    数据接收
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    网络栈开发指南
  </a>
  
    <nav class="md-nav" aria-label="网络栈开发指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manipulation" class="md-nav__link">
    数据包处理步骤控制(Manipulation)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    协议性能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    数据包处理效率
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    网络栈中的控制流程
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    如何处理中断、接收数据包
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    数据结构
  </a>
  
    <nav class="md-nav" aria-label="数据结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sk_buff" class="md-nav__link">
    sk_buff 结构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    包数据与元数据
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    如何添加或删除头部
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    如何合并或拆分数据包
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    快速分配与释放
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcp-tcb" class="md-nav__link">
    TCP 控制块(TCB)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    跟随代码：如何传输数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    跟随代码：如何接收数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nic" class="md-nav__link">
    驱动设备与 NIC 之间如何通信
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    栈缓冲区与流控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    总结
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="ch04-">CH04-理解网络栈<a class="headerlink" href="#ch04-" title="Permanent link">&para;</a></h1>
<p>我们不敢想象离开了 TCP/IP 互联网服务会变成什么样子。所有我们在 <a href="https://en.wikipedia.org/wiki/NHN_Entertainment">NHN</a> 上开发和使用的互联网服务都基于一个一致的基础，TCP/IP。理解数据是如何在网络上传输的，能够帮助你通过调优来提升性能、排除故障，或者是将其引入到新的技术中去。</p>
<p>本文将基于 Linux OS 和硬件层中的数据流及控制流来介绍网络栈的整体操作方案。</p>
<h2 id="tcpip">TCP/IP 的关键特性<a class="headerlink" href="#tcpip" title="Permanent link">&para;</a></h2>
<p><strong>怎样才能设计一个用来快速传输数据的网络协议，同时能够保证数据顺序又不丢失数据？</strong></p>
<p>TCP/IP 就是以这样的初衷来设计的。以下是理解网络栈所必须的 TCP/IP 的关键特性。</p>
<blockquote>
<p>TCP 与 IP
从技术上讲，由于 TCP 和 IP 拥有不同的层次结构，正确的方式是将它们分开来介绍。然而，这里我们会将其看做一个整体。</p>
</blockquote>
<h3 id="1">1、面向连接<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>首先，一个连接在两个端点之间(local and remote)被创建，然后数据才会被传输。这里的 "TCP 连接标识符" 是两个端点的地址的结合体，其结构如下：</p>
<div class="highlight"><pre><span></span><code>&lt;local IP address, local port number, remote IP address, remote port number&gt;
</code></pre></div>
<h3 id="2">2、双向字节流<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>双向的数据通信通过字节流(byte stream)来完成。</p>
<h3 id="3">3、有序抵达<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>一个接收者以发送者发送的顺序来接收数据。为此，必须确保数据的顺序。为了标记顺序，使用了一个 32 位的整形数据类型。</p>
<h3 id="4-ack">4、通过 ACK 确保可靠性<a class="headerlink" href="#4-ack" title="Permanent link">&para;</a></h3>
<p>当一个发送者在将数据发送给一个接收者之后没能收到一个 ACK(确认应答) 时，发送者 TCP 将会重新发送该数据给接收者。因此，发送方将会缓存那些没有得到接收者返回 ACK 的数据。</p>
<h3 id="5flow-control">5、流控(Flow Control)<a class="headerlink" href="#5flow-control" title="Permanent link">&para;</a></h3>
<p>发送者竟会根据接收者的承受能力发送尽可能多的数据。接收者会将其能够接收的数据的最大字节数(unused buffer size, receive window)发送给发送者。发送者将会根据接收者的接收窗口所能支持的大小，尽可能发送更多的数据。</p>
<h3 id="6congestion-control">6、拥堵控制(Congestion Control)<a class="headerlink" href="#6congestion-control" title="Permanent link">&para;</a></h3>
<p><a href="https://en.wikipedia.org/wiki/TCP_congestion_control#Congestion_window">拥堵窗口</a> 以独立于接收窗口的方式来使用，通过限制网络上的数据流量来避免网络拥堵。与接收窗口一样，发送者通过一些算法来根据接收者拥堵窗口所能支持的最大字节数来发送尽可能多的数据，这些算法有 TCP Vegas、Westwood、BIC、CUBIC。与流控不同，拥堵控制仅由发送方实现。</p>
<h2 id="_1">数据传输<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>就像其名字中的提示一样，一个网络“栈”拥有很多层。下面的图示中展示了各层的类型：</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171205151248368796434.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>可见有多个不同的层，并且归类为三种不同的空间：</p>
<ul>
<li>用户空间</li>
<li>内核空间</li>
<li>设备空间</li>
</ul>
<p>用户与内核空间的任务会由 CPU 来完成执行。用户与内核空间又被称为 “<strong>Host</strong>” 以与设备空间加以区分。这里的设备是*网络适配器(Network Interface Card, NIC)*，它会发送或接收数据包。这比通常称呼的 “网卡(LAN Card)” 更为准确。</p>
<p>让我们看一下用户空间。首先，应用会创建用来发送的数据(User Data)并通过 <code>write()</code> 系统调用来发送数据。这里假定 socket(fd) 已经被创建过了。当执行了系统调用，则会切换到内核空间。</p>
<p>POSIX 系列的操作系统，包括 Linux 和 Unix，通过一个文件描述符将 socket 保留给应用。在 POSIX 系列的操作系统中，socket 只是文件的一种。文件层会执行一个简单的检查，并通过连接到文件构造体的 socket 构造体来调用 socket 函数。</p>
<p>内核 socket 拥有两个缓冲区：</p>
<ul>
<li>一个是用于发送的 socket 发送缓冲区</li>
<li>一个是用于接收的 socket 接收缓冲区</li>
</ul>
<p>当“系统写”被调用，处于用户空间的数据会被**复制**到内核内存并被添加到“socket 发送缓冲区”的末端，以按照数据添加的顺序进行发送。就像上图中浅灰色的方块引用着 socket 缓冲区中的数据。然后 TCP 被调用。</p>
<p>这里有一个关联到 socket 的 TCP 控制块(TCP Control Block, TCB) 结构，TCB 包含着用于处理 TCP 连接的必要信息。TCP 中的数据包括：连接状态(<code>LISTEN</code>, <code>ESTABLISHED</code>, <code>TIME_WAIT</code>)，接收窗口，拥堵窗口，序列号，重发计时器，等等。</p>
<p>如果 TCP 的当前状态运行数据传输，一个新的 TCP 段(segment, 即数据包) 会被创建。如果因为流控或类似的原因不能进行数据传输，系统调用就此终止并将模式(mode)返回给用户模式，即将控制权交给应用。</p>
<p>下面是两个 TCP 段，其结构如下图所示：</p>
<ul>
<li>TCP 头</li>
<li>负荷(payload)</li>
</ul>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171205151248627629673.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>负荷中包含了保存在未进行应答确认的 socket 发送缓冲区中的数据。负荷的最大长度即为接收窗口、拥堵窗口、最大分段值(MSS)，这三者中的最大值。</p>
<p>然后，TCP 的校验和(checksum)被计算。在这个校验和计算中，包含了虚拟(pseudo)头信息，如 IP 地址、分段长度、协议号。根据 TCP 的状态，可以传输一个或更多的数据包。</p>
<p>事实上，由于现在的网络栈采用无负载(offload)的校验和，因此 TCP 校验和是由 NIC 计算的，而非内核。然而我们为了方便，这里假设是由内核完成的 TCP 校验和计算。</p>
<p>被创建的 TCP 分段会进入到 IP 层。IP 层将 IP 头添加到 TCP 分段，并执行 IP 路由。<strong>IP 路由</strong> 是为了搜索下一个跳板 IP 以最终能够抵达目的 IP。</p>
<p>在 IP 层计算并添加了 IP 头校验和之后，它会将数据发送到以太网(Ethernet)层。以太网层将会根据**地址解析协议(Address Resolution Protocol，ARP)**搜索下一个跳板 IP 的 MAC 地址。让后将以太网头添加到数据包。以太网数据包的添加则完成了主机(host)数据包的创建。</p>
<p>在 IP 路由执行之后，传输接口会得到 IP 路由的结果。该接口用于将数据包发送给下一个跳板 IP 或直接 IP。因此，网络适配器(NIC) 设备被调用。</p>
<p>这时，如果运行了一个数据包捕获程序，比如 tcpdump 或 Wireshark，内核将会把数据包数据复制到这些程序使用的内存中。这样，直接就能在设备上捕获接收到的数据包。通常来说，流量整形器(shaper)功能会被时限为运行在这一层上。</p>
<p>设备通过由 NIC 厂商定义的设备 NIC 通信协议来请求数据包的传输。</p>
<p>在接收到数据包传输请求之后，NIC 会将数据包从主内存复制到其自身的内存，然后发送给网线。这时，为了遵循以太网标准，会在数据包中添加 IFG(InterFrame Gap)、报头、CRC。IFG 和报头用于识别数据包的开始，CRC 则与 TCP 和 IP 的校验和一样用于保护数据。数据包的传输会基于以太网的速度和以太网的流控被启动。</p>
<p>当 NIC 发送一个数据包时，NIC 会使主机 CPU 中断。每次中断都拥有自己的中断号，然后 OS 通过该中断号查找合适的设备来处理该中断。在设备启动时会注册一个函数(中断处理器)来处理该中断。OS 调用该中断处理器，然后中断处理器将被传输的数据包返回给 OS。</p>
<p>到目前为止，我们已经讨论了当应用执行一次写入时贯穿内核与设备的整个数据传输过程。然而，再没有一个来自应用的直接写请求的情况下，内核可以直接通过调用 TCP 来传输一个数据包。比如，当接收了一个 ACK 且接收窗口被扩充，内核创建一个包含 socket 缓冲区中剩余数据的 TCP 分段，并将其发送给接收者。</p>
<h2 id="_2">数据接收<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>现在让我们看一下数据是如何被接收的。数据接收是网络栈用来处理传入的数据包的步骤。下图展示了网络栈如何处理一个接收到的数据包：</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171206151256780635162.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>首先，NIC 将数据包写人到它的内存。它通过执行 CRC 检查来验证其有效性，然后将其发送给主机(host)的内存缓冲区。该缓冲区是一块已经由驱动程序向内核请求过的专门用于接收数据包的内存。一旦该内存被分配，驱动程序则会将其地址和大小发送给 NIC。如果是 NIC 已经接收到一个数据包但又没有分配可用的主机内存缓冲区，则 NIC 会将该数据包丢弃。</p>
<p>将数据包发送给主机内存缓冲区之后，NIC 会向主机 OS 发送一个中断(interrupt)。</p>
<p>然后，驱动器会检查它是否能够继续处理新的数据包。截止目前，驱动器与 NIC 使用的的通信协议由厂商定义。</p>
<p>当驱动器需要向上层发送数据包时，该数据包的结构必须被包装为一个 OS 使用的数据包结构，以便 OS 能够理解该数据包。比如，Linux 中的 <strong>sk_buff</strong>，BSD 系列内核中的 <strong>mbuf</strong>，微软 Windows 中的 <strong>NET_BUFFER_LIST</strong>，这些均是对应到各个 OS 的数据包结构。然后，驱动程序将被包装过的数据包发送给上层。</p>
<p>以太网层会检查该数据包的有效性，然后根据以太网头部中的以太网类型(ethertype)的值多路分解(de-multiplexes)上层协议(网络协议)。 比如 IPv4 的以太网类型协议是 <strong>0x0800</strong>。然后移除掉数据包的以太网头部并将其发送被 IP 层。</p>
<p>IP 层同样会检查数据包的有效性，或者说是检查 IP 头部的校验和。它将逻辑性的检测是否需要执行 IP 路由并使本机系统来处理该数据包，还是将其发送给其他的系统。如果该数据包必须由本机系统来处理，IP 层会通过查阅 IP 头部的原始值来多路分解上层协议(传输协议)。TCP 的原始值是 6。然后移除掉数据包的 IP 头部并将其发送给 TCP 层。</p>
<p>向下层一样，TCP 层会通过检查 TCP 校验和来验证数据包的有效性。如前面提到的，由于当前的网络栈使用的是无负载(offload)校验和，因此 TCP 的校验和由 NIC 完成计算，而非内核。</p>
<p>然后开始搜索数据包关联的 TCP 控制块(TCB)。这时，<code>&lt;source IP, source port, target IP, target port&gt;</code> 会作为数据包的标示符。在搜索连接之后，它会执行协议来处理数据包。如果接收到的是新的数据包，会将其数据添加到 socket 接收缓冲区。根据 TCP 的状态，它可以发送一个新的 TCP 数据包，比如一个 ACK 数据包。现在，TCP/IP 对数据包的接收已经处理完成。</p>
<p>Socket 接收缓冲区的大小是 TCP 的接收窗口大小。确定的一点是，当接收窗口很大的时候 TCP 的吞吐会随之增长。在过去，socket 的缓冲区的大小会由应用或 OS 的配置来调整。最新的网络栈会拥有自动调整 socket 接收缓冲区大小的功能，比如调整接收窗口。</p>
<p>当应用调用了系统读(system read)调用，空间会被切换到**内核空间**，socket 缓冲区中的数据则会被复制到**用户空间**的内存。然后被复制过的数据会被从 socket 缓冲区移除。然后 TCP 被调用。因为 socket 缓冲区中出现了新的空间，TCP 则会增长接收窗口的大小。然后根据协议的状态发送一个数据包。如果没有需要传输的数据包，系统调用则会被终止。</p>
<h2 id="_3">网络栈开发指南<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>目前已经介绍的网络栈层次的功能都是非常基础的功能。上世纪 90 年代初的网络栈功能并没有比上面所介绍的功能多。然而，最新的网络栈则拥有更多的功能，因为网络栈的实现也变得更加高级，所以也更加复杂。</p>
<p>最新的网络栈按用途分类如下。</p>
<h3 id="manipulation">数据包处理步骤控制(Manipulation)<a class="headerlink" href="#manipulation" title="Permanent link">&para;</a></h3>
<p>这是一个类似网络过滤器(NetFilter, NAT, 防火墙)或流量控制的功能。通过在基本的处理流程中插入用户可控的代码，基于用户的配置，该功能能够完成不同的工作。</p>
<h3 id="_4">协议性能<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>其目的在于提升 TCP 协议在给定网络环境下的吞吐量、延迟和稳定性。通过一些拥堵控制算法和额外的 TCP 功能来实现，比如经典的 SACK。协议的提升在这里不会做过多讨论，因为已经超出了本文的范围。</p>
<h3 id="_5">数据包处理效率<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>数据包处理效率的目的在于，通过减少系统处理数据包时的 CPU 周期、内存使用、内存访问，来提高每秒能够处理的数据包的最大数量。已经有多种尝试来减少系统中的延迟。这些尝试包括栈并行处理、头部预测、zero-copy、single-copy、无负载校验和、TSO、LRO、RSS 等等。</p>
<h2 id="_6">网络栈中的控制流程<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>现在让我们更加详细的看一下 Linux 网络栈的内部流程。网络栈更像是一个子系统，一个网络栈根本上来说是以时间驱动的方式运行，并对发生的事件做出相应。因此，并没有单独的线程来执行网络栈。上面在对网络栈层次的讨论中展示了其简化版的流程，下图中阐述了更加准确的控制流程。</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171206151257403356450.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p><strong>Flow(1)</strong>，一个应用调用了系统调用来执行(使用) TCP。比如，调用了系统读或系统写，然后执行 TCP。然而，这里并没有数据包传输。</p>
<p><strong>Flow(2)</strong> 与 Flow(1)类似，但它在执行 TCP 之后需要对数据包进行传输。它会创建一个数据包并将其向下发送给驱动设备。驱动设备之前会有一个队列。数据包首先会进入到队列，然后队列的实现结构决定了将数据包发送给驱动设备的时机。这便是 Linux 的排队机制(<strong>qdisc</strong>)。Linux 的流量控制功能便是对 qdisc 的控制。默认的 qdisc 是一个简单的先进先出(FIFO)队列。通过使用一个另外的 qdisc，操作者可以实现多种效果，比如人造丢包、包延迟、传输速度控制等等。在 Flow(1) 和 Flow(2) 中，应用的处理线程同样会用来执行驱动设备。</p>
<p><strong>Flow(3)</strong> 展示了 TCP 所使用的计时器(timer)过期的场景。比如，当 <strong>TIME_WAIT</strong> 计时器过期时，TCP 会被调用以删除连接。</p>
<p><strong>Flow(4)</strong> 与 Flow(3) 类似，即 TCP 使用的计时器过期，且 TCP 执行结果的数据包需要被传输。比如，当重复计时器(retransmit timer)过期时，为得到 ACK 的数据包将会被重新传输。</p>
<p>Flow(3) 和 Flow(4) 展示了执行计时器软中断请求(softiq)的步骤，它处理了计时器中断。</p>
<p>当 NIC 驱动设备接收到一个中断，它会释放已传输的数据包。大多数情况下，驱动设备的执行会在这里终止。<strong>Flow(5)</strong> 展示的是数据包在传输队列中的累积。驱动设备会请求软中断(softiq)，软中断处理器会执行传输队列来将累积的数据包发送给驱动设备。</p>
<p>当 NIC 驱动设备收到了一个中断并发现了一个新接收到的数据包，它会请求软中断。软中断会调用驱动是被来处理数据包并将其发送给上层。在 Linux 中，向上面展示的对接收到的数据包的处理被称为 New API(NAPI)。这个过程类似于轮询，因为驱动设备并未直接将数据包发送给上层，但是上层会直接得到该数据报。这里实际的代码会被称为 NAPI poll 或 poll。</p>
<p><strong>Flow(6)</strong> 展示了 TCP 的执行完成，而 <strong>Flow(7)</strong> 展示了仍需要处理额外的数据包。Flow(5,6,7) 都是由处理了 NIC 中断的软中断请求执行。</p>
<h2 id="_7">如何处理中断、接收数据包<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>中断的处理是相当复杂的；然而，你需要了解与数据包接收处理相关的性能问题。下图展示了中断的处理步骤：</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171208151273809467498.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>假如 CPU 0 正在处理一个应用程序(用户程序)。这时，NIC 收到一个数据包并为 CPU 0 生成一个中断。然后 CPU 执行了内核的中断处理器(irq)。这个处理器会引用该中断的序号，然后调用驱动设备的中断处理器。驱动设备首先会释放掉已经传输过的数据包，然后调用<code>napi_schedule()</code>来处理接收到数据包。该函数会请求 softirq(软中断)。</p>
<p>在驱动设备的中断处理器的执行终止后，控制权会传递给内核处理器。内核处理器会为 softirq 执行中断处理器。</p>
<p>在中断上下文被处理之后，softirq(软中断)上线文会被执行。中断上下文与软中断上下文会被同一个线程处理，但是，两个上下文使用不同的栈。同时，中断上下文会阻塞硬件中断，但软中断上下文则允许硬件中断。</p>
<p>处理接收到的数据包的软终端处理器为 <code>net_rx_action()</code> 函数。该函数会对驱动设备调用 <code>poll()</code> 函数。然后 <code>poll()</code> 函数会调用 <code>netif_receive_skb()</code> 函数将接收到的数据包一个接一个的发送给上层。在处理完软中断之后，应用会中停止点重启执行，以便能够请求一个系统调用。</p>
<p>然而，接收到中断的 CPU 会从头到尾的处理接收到的数据。在 Linux、BSD、微软中的处理步骤基本如此。</p>
<p>如果你检查服务器的 CPU 利用率，有时你会发现服务器的众多 CPU 中仅有一个 CPU 在艰难的处理软中断。这种现象的发生则是因为目前我们已经解释过的对接收到的数据包的处理方式。为了解决这个问题，出现了多队列 NIC、RSS、RPS。</p>
<h2 id="_8">数据结构<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>下面是一些关键的数据结构。</p>
<h3 id="sk_buff">sk_buff 结构<a class="headerlink" href="#sk_buff" title="Permanent link">&para;</a></h3>
<p>首先是表述数据包的 <strong>sk_buff</strong> 或 <strong>skb</strong>。下图展示了 <strong>sk_buff</strong> 的一部分结构。由于函数已经发生了进化因此变得更加复杂。然而其基本功能则十分简单，任何人都能理解。</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171208151274038140624.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<h3 id="_9">包数据与元数据<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>该结构直接包含了包数据或者通过一个指针来引用包数据。上图中，一些(由以太网至缓冲区)数据包通过数据指针引用，一些额外的数据(frags)则引用了实际的数据页(page)。</p>
<p>一些必要的信息比如头部、荷载长度则被保存在元数据区。比如上图中，mac_header、network_header、transport_header 拥有相同的指针数据，并分别指向以太网头、IP 头、TCP 头的起始位置。这种方式使得 TCP 协议的处理变得简单。</p>
<h3 id="_10">如何添加或删除头部<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>头部在经过各个网络栈的层时会被添加或删除。指针的使用则为了更加高效的处理。比如，想要移除以太网头部，仅需要递增对应的头部指针。</p>
<h3 id="_11">如何合并或拆分数据包<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>链接列表用于高效的处理类似从 socket 缓冲区、数据包链中添加或删除数据包的荷载数据这样的任务。next 指针、prev 指针则用于此目的。</p>
<h3 id="_12">快速分配与释放<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>因为数据包一旦创建就需要分配该结构，所以使用了快速分配器(allocator)。比如，如果数据在 10GB 带宽的以太网中传输，每秒则会有多余 1 百万的数据包被创建和删除。</p>
<h2 id="tcp-tcb">TCP 控制块(TCB)<a class="headerlink" href="#tcp-tcb" title="Permanent link">&para;</a></h2>
<p>然后，是一个用于表示 TCP 连接的结构，前面我们笼统的称之为 TCB。Linux 使用 <strong>tcp_sock</strong> 来表示该结构。在下图中，你可以看到文件、socket、<strong>tcp_sock</strong> 之间的关系。</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171208151274235133679.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>当触发了一个系统调用时，它会在文件描述符中搜索该应用使用的触发了该调用的文件。对于 Unix 系列的 OS 来说，文件以及用于通用文件系统存储的驱动设备均被抽象为文件。因此，该结构仅包含了最少的信息。对于一个 socket，一个单独的 socket 结构保存了 socket 相关的信息，然后文件以指针的形式引用该 socket。然后 socket 又以同样的方式引用了 <strong>tcp_sock</strong>。<strong>tcp_sock</strong> 又被划分为 into_sock、inet_sock 等等，以支持不同类型的特定 TCP 协议。可以被看做是一种多态。</p>
<p>所有被 TCP 协议使用的状态信息均被保存在 <strong>tcp_sock</strong> 中。比如，序列号、接收窗口、阻塞控制、重发计时器。</p>
<p>Socket 发送缓存区、socket接收缓冲区实际上是 <strong>sk_buff</strong> 列表，其中包含的是 <strong>tcp_sock</strong>。同时引用了 dst_entry、IP 路由结构，以避免过度频繁的路由。dst_entry 支持对 ARP 结构的简单搜索，比如目的地的 MAC 地址。dst_entry 是路由表的一部分。而路由表的结构则太过复杂了，本文不再讨论。用于数据包传输的 NIC 则通过 dst_entry 进行搜索。而 NIC 则被表示为 net_device 结构。</p>
<p>因此通过搜索文件，可以使用指针非常容易的找到用于处理 TCP 连接所必须的所有结构(从文件到驱动设备)。结构的大小则是 TCP 连接所使用的内存大小，仅占用很少的几个 KB(包含包数据)。随着功能的增加，内存占用也会逐渐增加。</p>
<p>最后，让我们看一下 TCP 连接的查找表。这是一个用于搜索数据包所归属的 TCP 连接的哈希表。哈希值使用数据包的 <code>&lt;source IP, target IP, source port, target port&gt;</code> 作为输入，基于 Jenkins 哈希算法来计算。据说哈希算法的选择是基于对防御哈希表攻击的考虑。</p>
<h2 id="_13">跟随代码：如何传输数据<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<p>我们将通过跟随实际的 Linux 内核源码来检查网络栈中所执行的关键任务。这里我们将遵循两个常用的路径。</p>
<p>首先，这个路径用于在应用调用一个系统写调用时传输数据。</p>
<div class="highlight"><pre><span></span><code><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">{</span>

<span class="k">struct</span> <span class="nc">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">file</span> <span class="o">=</span> <span class="n">fget_light</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fput_needed</span><span class="p">);</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">aio_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kiocb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kiocb</span><span class="p">.</span><span class="n">ki_pos</span><span class="p">);</span>



<span class="k">struct</span> <span class="nc">file_operations</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">aio_read</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">kiocb</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">iovec</span> <span class="o">*</span><span class="p">,</span> <span class="p">...)</span>

<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">aio_write</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">kiocb</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">iovec</span> <span class="o">*</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">[...]</span>

<span class="p">};</span>



<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">file_operations</span> <span class="n">socket_file_ops</span> <span class="o">=</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="p">.</span><span class="n">aio_read</span> <span class="o">=</span> <span class="n">sock_aio_read</span><span class="p">,</span>

<span class="p">.</span><span class="n">aio_write</span> <span class="o">=</span> <span class="n">sock_aio_write</span><span class="p">,</span>

<span class="p">[...]</span>

<span class="p">};</span>
</code></pre></div>
<p>当系统调用系统写时，内核会执行文件层的 <code>write()</code> 函数。首先，文件描述符 fd 的实际文件结构会被取到。然后 <strong>aio_wirte</strong> 被调用。这是一个函数指针。在文件结构中，你会看到 <strong>file_operattions</strong> 结构体。该结构通常被称为函数表，包含了 aio_read 和 <strong>aio_write</strong> 这样的函数指针。socket 的实际函数表是 <strong>socket_file_ops</strong>。socket 使用的 aio_write 函数实际是 sock_aio_write。函数表的目的与 Java 中的接口类似。它被普遍的用于内核对代码的抽象或重构。</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">sock_aio_write</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="p">..)</span>

<span class="p">{</span>

<span class="p">[...]</span>

<span class="k">struct</span> <span class="nc">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="k">return</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">(</span><span class="n">iocb</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>



<span class="k">struct</span> <span class="nc">socket</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="k">struct</span> <span class="nc">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

<span class="k">const</span> <span class="k">struct</span> <span class="nc">proto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

<span class="p">};</span>



<span class="k">const</span> <span class="k">struct</span> <span class="nc">proto_ops</span> <span class="n">inet_stream_ops</span> <span class="o">=</span> <span class="p">{</span>

<span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">,</span>

<span class="p">[...]</span>

<span class="p">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">inet_stream_connect</span><span class="p">,</span>

<span class="p">.</span><span class="n">accept</span> <span class="o">=</span> <span class="n">inet_accept</span><span class="p">,</span>

<span class="p">.</span><span class="n">listen</span> <span class="o">=</span> <span class="n">inet_listen</span><span class="p">,</span> <span class="p">.</span><span class="n">sendmsg</span> <span class="o">=</span> <span class="n">tcp_sendmsg</span><span class="p">,</span>

<span class="p">.</span><span class="n">recvmsg</span> <span class="o">=</span> <span class="n">inet_recvmsg</span><span class="p">,</span>

<span class="p">[...]</span>

<span class="p">};</span>



<span class="k">struct</span> <span class="nc">proto_ops</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">connect</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="p">...)</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">accept</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="p">...)</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">listen</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">sendmsg</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="p">...)</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">recvmsg</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">[...]</span>

<span class="p">};</span>
</code></pre></div>
<p><code>socket_aio_write()</code> 函数重文件得到 socket 结构体并调用 <strong>sendmsg</strong>。它同样是一个函数指针。socket 结构体包含了 <strong>proto_ops</strong> 函数表。IPV4 TCP 对 proto_ops 的实现是 inet_stream_ops，对 sendmsg 函数的实现是 <strong>tcp_sendmsg</strong>。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">tcp_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>

<span class="k">struct</span> <span class="nc">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">mss_now</span> <span class="o">=</span> <span class="n">tcp_send_mss</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size_goal</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>



<span class="cm">/* Ok commence sending. */</span>

<span class="n">iovlen</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iovlen</span><span class="p">;</span>

<span class="n">iov</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iov</span><span class="p">;</span>

<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">iovlen</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">seglen</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>



<span class="n">iov</span><span class="o">++</span><span class="p">;</span>

<span class="k">while</span> <span class="p">(</span><span class="n">seglen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

<span class="kt">int</span> <span class="n">copy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">size_goal</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">skb</span> <span class="o">=</span> <span class="n">sk_stream_alloc_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span>

<span class="n">select_size</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sg</span><span class="p">),</span>

<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>

<span class="k">goto</span> <span class="n">wait_for_memory</span><span class="p">;</span>

<span class="cm">/*</span>

<span class="cm">* Check whether we can use HW checksum.</span>

<span class="cm">*/</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_route_caps</span> <span class="o">&amp;</span> <span class="n">NETIF_F_ALL_CSUM</span><span class="p">)</span>

<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">skb_entail</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="cm">/* Where to copy to? */</span>

<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

<span class="cm">/* We have some space in skb head. Superb! */</span>

<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>

<span class="n">copy</span> <span class="o">=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">skb_add_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">copy</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">goto</span> <span class="n">do_fault</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span>

<span class="n">tcp_push</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mss_now</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nonagle</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="p">}</span>
</code></pre></div>
<p><strong>tcp_sendmsg</strong> 从 socket 得到 tcp_sock(i.e. TCB)，并将应用请求用来传输的数据复制到 socket 发送缓冲区。当把数据复制到 sk_buff 时，一个 sk_buff 又会包含多少字节呢？一个 sk_buff 复制并包含 MSS(tcp_send_mss) 个字节以帮助实际创建数据包的代码。Maximum Segment Size(MSS) 实际表示了一个 TCP 包能够包含的最大荷载大小。通过使用 TSO 和 GSO，sk_buff 能够保存比 MSS 更多的数据。这些将会在后续详细讨论，而非在本文。</p>
<p><strong>sk_stream_alloc_skb</strong> 函数创建了一个新的 <strong>sk_buff</strong>， <strong>skb_entail</strong> 将新创建的 <strong>sk_buff</strong> 添加到 <strong>send_socket_buffer</strong> 的头部。<strong>skb_add_data</strong> 函数会将实际的应用数据复制到 <strong>sk_buff</strong> 的数据缓冲区。通过几次这样的重复(创建 <strong>skb_buff</strong> 并添加到 socket 发送缓冲区)，所有数据都会被复制。因此，以 MSS 为大小的 <strong>sk_buffs</strong> 会以列表的形式保存在 socket 发送缓冲区中。最终，<strong>tcp_push</strong> 被调用以使得这些数据能够以一个数据包的形式被传输，然后数据包被发送。</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">tcp_push</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mss_now</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tcp_write_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mss_now</span><span class="p">,</span> <span class="p">...)</span>

<span class="kt">int</span> <span class="n">nonagle</span><span class="p">,</span>

<span class="p">{</span>

<span class="k">struct</span> <span class="nc">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tcp_send_head</span><span class="p">(</span><span class="n">sk</span><span class="p">)))</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="n">cwnd_quota</span> <span class="o">=</span> <span class="n">tcp_cwnd_test</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cwnd_quota</span><span class="p">)</span>

<span class="k">break</span><span class="p">;</span>



<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">tcp_snd_wnd_test</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">mss_now</span><span class="p">)))</span>

<span class="k">break</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tcp_transmit_skb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gfp</span><span class="p">)))</span>

<span class="k">break</span><span class="p">;</span>



<span class="cm">/* Advance the send_head. This one is sent out.</span>

<span class="cm">* This call will increment packets_out.</span>

<span class="cm">*/</span>

<span class="n">tcp_event_new_data_sent</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="p">[...]</span>
</code></pre></div>
<p><strong>tcp_push</strong> 函数会基于 TCP 允许的范围尽可能多的传输 socket 发送缓冲区中的 <strong>sk_buffs</strong>。首先，<strong>tcp_send_head</strong> 被调用以得到 socket 发送缓冲区中的第一个 <strong>sk_buff</strong>，然后执行 <strong>tcp_cwnd_test</strong> 和 <strong>tcp_snd_wnd_test</strong> 来检查正在接收的 TCP 的阻塞窗口和接收窗口是否允许新数据包的传输。然后，<strong>tcp_transmit_skb</strong> 函数被调用以创建一个数据包。</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span> <span class="n">tcp_transmit_skb</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>

<span class="kt">int</span> <span class="n">clone_it</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">const</span> <span class="k">struct</span> <span class="nc">inet_connection_sock</span> <span class="o">*</span><span class="n">icsk</span> <span class="o">=</span> <span class="n">inet_csk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">inet_sock</span> <span class="o">*</span><span class="n">inet</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">tcp_sock</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

<span class="p">[...]</span>





<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">clone_it</span><span class="p">))</span> <span class="p">{</span>

<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span>

<span class="n">skb</span> <span class="o">=</span> <span class="n">pskb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>

<span class="k">else</span>

<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>

<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

<span class="p">}</span>



<span class="p">[...]</span>

<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tcp_header_size</span><span class="p">);</span>

<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="n">skb_set_owner_w</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>



<span class="cm">/* Build TCP header and checksum it. */</span>

<span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_sport</span><span class="p">;</span>

<span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">inet</span><span class="o">-&gt;</span><span class="n">inet_dport</span><span class="p">;</span>

<span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">tcb</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>

<span class="n">th</span><span class="o">-&gt;</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_af_ops</span><span class="o">-&gt;</span><span class="n">send_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="n">err</span> <span class="o">=</span> <span class="n">icsk</span><span class="o">-&gt;</span><span class="n">icsk_af_ops</span><span class="o">-&gt;</span><span class="n">queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>

<span class="k">return</span> <span class="n">err</span><span class="p">;</span>



<span class="n">tcp_enter_cwr</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>



<span class="k">return</span> <span class="nf">net_xmit_eval</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div>
<p><strong>tcp_transmit_skb</strong> 创建了对应 <strong>sk_buff</strong> 的副本(pskb_copy)。这次，并未复制应用的完整数据，而仅仅是元数据。然后调用 <strong>skb_push</strong> 来保护头部数据空间并记录头部数据值。<strong>send_check</strong> 计算了 TCP 的校验和。基于无负载(offload)校验和，荷载数据并未被计算。最终，<strong>queue_xmit</strong> 被调用以将数据包发送给 IP 层。IPV4 的 <strong>queue_xmit</strong> 由 <strong>ip_queue_xmit</strong> 函数实现。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">ip_queue_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span>

<span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">rtable</span> <span class="o">*</span><span class="p">)</span><span class="n">__sk_dst_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="cm">/* OK, we know where to send it, allocate and build IP header. */</span>

<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">iphdr</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">opt</span> <span class="o">?</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="nl">optlen</span> <span class="p">:</span> <span class="mi">0</span><span class="p">));</span>

<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="o">*</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">)</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inet</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ip_dont_fragment</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">local_df</span><span class="p">)</span>

<span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">IP_DF</span><span class="p">);</span>

<span class="k">else</span>

<span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ip_select_ttl</span><span class="p">(</span><span class="n">inet</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">dst</span><span class="p">);</span>

<span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_protocol</span><span class="p">;</span>

<span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_src</span><span class="p">;</span>

<span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">rt_dst</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">ip_local_out</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="kt">int</span> <span class="n">__ip_local_out</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span>

<span class="n">ip_send_check</span><span class="p">(</span><span class="n">iph</span><span class="p">);</span>

<span class="k">return</span> <span class="nf">nf_hook</span><span class="p">(</span><span class="n">NFPROTO_IPV4</span><span class="p">,</span> <span class="n">NF_INET_LOCAL_OUT</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>

<span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dst_output</span><span class="p">);</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="kt">int</span> <span class="n">ip_output</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">struct</span> <span class="nc">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">skb_dst</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>



<span class="k">return</span> <span class="nf">NF_HOOK_COND</span><span class="p">(</span><span class="n">NFPROTO_IPV4</span><span class="p">,</span> <span class="n">NF_INET_POST_ROUTING</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>

<span class="n">ip_finish_output</span><span class="p">,</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_finish_output</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ip_skb_dst_mtu</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>

<span class="k">return</span> <span class="n">ip_fragment</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ip_finish_output2</span><span class="p">);</span>

<span class="k">else</span>

<span class="k">return</span> <span class="n">ip_finish_output2</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</code></pre></div>
<p><strong>ip_queue_xmit</strong> 函数会执行一些 IP 层要求的函数。<strong>__sk_dst_check</strong> 检查被缓存的路由是否有效。如果没有缓存的路由或者缓存的路由无效，它会执行 IP 路由。然后调用 <strong>skb_push</strong> 来保护 IP 头部空间并记录 IP 头部字段值。之后，随着函数的调用，<strong>ip_send_check</strong> 会计算 IP 头部的校验和并调用网络过滤器(netfilter)函数。如果 <strong>ip_finish_output</strong> 函数需要 IP 分片则会创建 IP 片段。当使用 TCP 时并不需要 IP 分片。因此，<strong>ip_finish_output2</strong> 会被调用，它添加了以太网(Ethernet)头部。最终，一个数据包完成。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">dev_queue_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__dev_xmit_skb</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">Qdisc</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(...)</span> <span class="p">{</span>

<span class="p">....</span>

<span class="p">}</span> <span class="k">else</span>

<span class="nf">if</span> <span class="p">((</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCQ_F_CAN_BYPASS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">qdisc_qlen</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&amp;&amp;</span>



<span class="n">qdisc_run_begin</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sch_direct_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">root_lock</span><span class="p">))</span> <span class="p">{</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="kt">int</span> <span class="n">sch_direct_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">Qdisc</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">[...]</span>

<span class="n">HARD_TX_LOCK</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_tx_queue_frozen_or_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>



<span class="n">HARD_TX_UNLOCK</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="p">}</span>



<span class="kt">int</span> <span class="n">dev_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptype_all</span><span class="p">))</span>

<span class="n">dev_queue_xmit_nit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="n">rc</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">ndo_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="p">}</span>
</code></pre></div>
<p>已完成的数据包由 <strong>dev_queue_xmit</strong> 函数来传输。首先，数据包通过 qdisc(队列规则) 来传递。如果使用的是默认的 qdisc 且队列为空，<strong>sch_direct_xmit</strong> 函数被调用以将数据包直接下发给驱动设备，从而跳过队列。<strong>dev_hard_start_xmit</strong> 函数会调用实际的驱动设备。在调用驱动设备之前，首先对驱动设备的 TX 加锁。这么做是为了避免多个线程对驱动设备的同时访问。由于内核锁住了驱动设备的 TX，驱动设备的传输代码则无需再进行加锁。这些与并行编程紧密相关，我们下次再进行讨论。</p>
<p><strong>ndo_start_xmit</strong> 函数调用了驱动设备代码。就在之前，你会看到 <strong>ptype_all</strong> 和 <strong>dev_queue_xmit_nit</strong>。ptype_all 是一个包含了一些模块的列表，比如数据包捕获。如果捕获程序正在运行，数据包则会被 ptype_all 复制到另外的程序。因此，tcpdump 所展示的数据包正式要传输给驱动设备的数据包。如果使用了无负载校验和或 TSO，NIC 会篡改数据包。因此 tcpdump 得到的数据包会与传输到网线上的数据包有所不同。在完成数据包的传输之后，驱动设备中断处理器会返回 <strong>sk_buff</strong>。</p>
<h2 id="_14">跟随代码：如何接收数据<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<p>大体的执行路线为接收一个数据包，然后将数据添加到 socket 接收缓冲区。在执行完驱动设备处理器之后，紧接着会首先执行 napi 拉取处理。</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="n">net_rx_action</span><span class="p">(</span><span class="k">struct</span> <span class="nc">softirq_action</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">struct</span> <span class="nc">softnet_data</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">softnet_data</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time_limit</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">budget</span> <span class="o">=</span> <span class="n">netdev_budget</span><span class="p">;</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">have</span><span class="p">;</span>



<span class="n">local_irq_disable</span><span class="p">();</span>



<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">poll_list</span><span class="p">))</span> <span class="p">{</span>

<span class="k">struct</span> <span class="nc">napi_struct</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">poll_list</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">napi_struct</span><span class="p">,</span>

<span class="n">poll_list</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NAPI_STATE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>

<span class="n">work</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">weight</span><span class="p">);</span>

<span class="n">trace_napi_poll</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

<span class="p">}</span>

<span class="p">[...]</span>

<span class="p">}</span>



<span class="kt">int</span> <span class="n">netif_receive_skb</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__netif_receive_skb</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">struct</span> <span class="nc">packet_type</span> <span class="o">*</span><span class="n">ptype</span><span class="p">,</span> <span class="o">*</span><span class="n">pt_prev</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">__be16</span> <span class="n">type</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptype_all</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptype</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">||</span> <span class="n">ptype</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>

<span class="k">if</span> <span class="p">(</span><span class="n">pt_prev</span><span class="p">)</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">deliver_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pt_prev</span><span class="p">,</span> <span class="n">orig_dev</span><span class="p">);</span>

<span class="n">pt_prev</span> <span class="o">=</span> <span class="n">ptype</span><span class="p">;</span>

<span class="p">}</span>

<span class="p">}</span>

<span class="p">[...]</span>

<span class="n">type</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span>

<span class="o">&amp;</span><span class="n">ptype_base</span><span class="p">[</span><span class="n">ntohs</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PTYPE_HASH_MASK</span><span class="p">],</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ptype</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span> <span class="o">&amp;&amp;</span>



<span class="p">(</span><span class="n">ptype</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">null_or_dev</span> <span class="o">||</span> <span class="n">ptype</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">||</span>

<span class="n">ptype</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">orig_dev</span><span class="p">))</span> <span class="p">{</span>

<span class="k">if</span> <span class="p">(</span><span class="n">pt_prev</span><span class="p">)</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">deliver_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pt_prev</span><span class="p">,</span> <span class="n">orig_dev</span><span class="p">);</span>

<span class="n">pt_prev</span> <span class="o">=</span> <span class="n">ptype</span><span class="p">;</span>

<span class="p">}</span>

<span class="p">}</span>



<span class="k">if</span> <span class="p">(</span><span class="n">pt_prev</span><span class="p">)</span> <span class="p">{</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">pt_prev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pt_prev</span><span class="p">,</span> <span class="n">orig_dev</span><span class="p">);</span>



<span class="k">static</span> <span class="k">struct</span> <span class="nc">packet_type</span> <span class="n">ip_packet_type</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="p">{</span>

<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">),</span>

<span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">ip_rcv</span><span class="p">,</span>

<span class="p">[...]</span>

<span class="p">};</span>
</code></pre></div>
<p>前面已经提到过，<strong>net_rx_action</strong> 是接收数据包的软中断处理器。首先，请求过 napi 拉取的驱动设备从 <strong>poll_list</strong> 中被找到，然后驱动设备的拉取处理器被调用。驱动设备使用 <strong>sk_buff</strong> 包装接收到的数据包，然后调用 <strong>netif_receive_skb</strong>。</p>
<p>如果有一个请求所有数据包的模块，<strong>netif_receive_skb</strong> 会将所有的数据包发送给该模块。像数据包传输中一样，数据包会被传输给注册到 ptype_all 列表的模块。数据包在这里被捕获。</p>
<p>然后，会基于数据包的类型将其传输给上层。以太网(Ethernet)数据包的头部中拥用 2-byte 的以太网类型字段，其值表示了数据包的类型。驱动设备会将该值记录到 <strong>sk_buff(sk-&gt;protocol)</strong> 中。每种协议都拥有各自的 packet_type 结构体，并将该结构体的指针注册到名为 ptype_base 的哈希表。IPV4 使用 <strong>ip_packet_type</strong>，其 Type 字段的值是 IPV4 以太网类型(ETH_P_IP)。因此，IPV4 数据包会调用 <strong>ip_rcv</strong> 函数。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">ip_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="p">...)</span>

<span class="p">{</span>

<span class="k">struct</span> <span class="nc">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>

<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>



<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>

<span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>



<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>



<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ip_fast_csum</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">iph</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">)))</span>

<span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>



<span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>

<span class="n">IP_INC_STATS_BH</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">IPSTATS_MIB_INTRUNCATEDPKTS</span><span class="p">);</span>

<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>

<span class="k">goto</span> <span class="n">inhdr_error</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="k">return</span> <span class="n">NF_HOOK</span><span class="p">(</span><span class="n">NFPROTO_IPV4</span><span class="p">,</span> <span class="n">NF_INET_PRE_ROUTING</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>

<span class="n">ip_rcv_finish</span><span class="p">);</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="kt">int</span> <span class="n">ip_local_deliver</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">&amp;</span> <span class="n">htons</span><span class="p">(</span><span class="n">IP_MF</span> <span class="o">|</span> <span class="n">IP_OFFSET</span><span class="p">))</span> <span class="p">{</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ip_defrag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IP_DEFRAG_LOCAL_DELIVER</span><span class="p">))</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>



<span class="k">return</span> <span class="n">NF_HOOK</span><span class="p">(</span><span class="n">NFPROTO_IPV4</span><span class="p">,</span> <span class="n">NF_INET_LOCAL_IN</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>

<span class="n">ip_local_deliver_finish</span><span class="p">);</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>





<span class="k">static</span> <span class="kt">int</span> <span class="n">ip_local_deliver_finish</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span>

<span class="n">__skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ip_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

<span class="p">[...]</span>

<span class="kt">int</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">hash</span><span class="p">,</span> <span class="n">raw</span><span class="p">;</span>

<span class="k">const</span> <span class="k">struct</span> <span class="nc">net_protocol</span> <span class="o">*</span><span class="n">ipprot</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">hash</span> <span class="o">=</span> <span class="n">protocol</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAX_INET_PROTOS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

<span class="n">ipprot</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">inet_protos</span><span class="p">[</span><span class="n">hash</span><span class="p">]);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ipprot</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">ipprot</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>



<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">net_protocol</span> <span class="n">tcp_protocol</span> <span class="o">=</span> <span class="p">{</span>

<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">tcp_v4_rcv</span><span class="p">,</span>

<span class="p">[...]</span>

<span class="p">};</span>
</code></pre></div>
<p><strong>ip_rcv</strong> 函数会执行 IP 层所必须的一些任务。它会检验数据包，比如长度和头部校验和。在流经网络过滤器码时，它会执行 <strong>ip_local_deliver</strong> 函数。如有必要，它会装配 IP 分段。然后，通过网络过滤器码调用 <strong>ip_local_deliver_finish</strong>。<strong>ip_local_deliver_finish</strong> 函数会通过 <strong>__skb_pull</strong> 移除掉 IP 头部，然后搜索协议值与 IP 头部的协议值一样的上层协议。类似于 ptype_base，每个传输协议都会将其各自的 <strong>net_protocol</strong> 结构体注册到 <strong>inet_protos</strong>。IPV4 TCP 使用 <strong>tcp_protocol</strong> 并调用注册为一个处理器的 <strong>tcp_v4_rcv</strong>。</p>
<p>当数据包来到 TCP 层，数据包处理流程会基于 TCP 状态和数据包类型变化。这里，我们将会看到这样的数据包处理步骤：预期的下一个数据包已经以 <strong>ESTABLISHED</strong> 的 TCP 连接状态被接收到。当没有丢失的或乱序抵达的数据包时，接收数据的服务端将会频繁执行这样的路线。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">tcp_v4_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">const</span> <span class="k">struct</span> <span class="nc">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>



<span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">tcphdr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">goto</span> <span class="n">bad_packet</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pskb_may_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>

<span class="k">goto</span> <span class="n">discard_it</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="n">th</span> <span class="o">=</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>

<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">+</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">+</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">+</span>

<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">);</span>

<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">tos</span><span class="p">;</span>

<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sacked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>



<span class="n">sk</span> <span class="o">=</span> <span class="n">__inet_lookup_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_hashinfo</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">tcp_v4_do_rcv</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</code></pre></div>
<p>首先，<strong>tcp_v4_rcv</strong> 函数首先会验证接收到的数据包。如果头部大小大于数据偏移，即 <code>th-&gt;doff &lt; sizeof(struct tcphdr) / 4</code>，则出现头部错误。然后，<strong>__inet_lookup_skb</strong> 会从 TCP 连接哈希表中查找数据包对应的 TCP 连接。基于找到的 sock 结构体，所有必要的结构体和 sock 都会被找到，比如 <strong>tcp_sock</strong>。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">tcp_v4_do_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_ESTABLISHED</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Fast path */</span>

<span class="n">sock_rps_save_rxhash</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">tcp_rcv_established</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>

<span class="p">[...]</span> <span class="o">===&gt;</span>

<span class="kt">int</span> <span class="n">tcp_rcv_established</span><span class="p">(</span><span class="k">struct</span> <span class="nc">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>

<span class="p">[...]</span>

<span class="cm">/*</span>

<span class="cm">* Header prediction.</span>

<span class="cm">*/</span>

<span class="k">if</span> <span class="p">((</span><span class="n">tcp_flag_word</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TCP_HP_BITS</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pred_flags</span> <span class="o">&amp;&amp;</span>



<span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">&amp;&amp;</span>



<span class="o">!</span><span class="n">after</span><span class="p">(</span><span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_nxt</span><span class="p">)))</span> <span class="p">{</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">&gt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_forward_alloc</span><span class="p">)</span>

<span class="k">goto</span> <span class="n">step5</span><span class="p">;</span>



<span class="n">NET_INC_STATS_BH</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="n">LINUX_MIB_TCPHPHITS</span><span class="p">);</span>



<span class="cm">/* Bulk data transfer: receiver */</span>

<span class="n">__skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tcp_header_len</span><span class="p">);</span>

<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="n">skb_set_owner_r</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>

<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">=</span> <span class="n">TCP_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">end_seq</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copied_early</span> <span class="o">||</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcv_nxt</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rcv_wup</span><span class="p">)</span>

<span class="n">__tcp_ack_snd_check</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">[...]</span>

<span class="nl">step5</span><span class="p">:</span>

<span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">&amp;&amp;</span> <span class="n">tcp_ack</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">FLAG_SLOWPATH</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>



<span class="n">tcp_rcv_rtt_measure_ts</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>



<span class="cm">/* Process urgent data. */</span>

<span class="n">tcp_urg</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">th</span><span class="p">);</span>



<span class="cm">/* step 7: process the segment text */</span>

<span class="n">tcp_data_queue</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>



<span class="n">tcp_data_snd_check</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="n">tcp_ack_snd_check</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">[...]</span>

<span class="p">}</span>
</code></pre></div>
<p>实际的协议会从 <strong>tcp_v4_do_rcv</strong> 函数执行。如果 TCP 处于 ESTABLISHED 状态，则调用 <strong>tcp_rcv_esablished</strong> 函数。<strong>ESTABLISHED</strong> 状态会被单独的处理和优化，因为这是最常见的状态。<strong>tcp_rcv_esablished</strong> 函数首先会执行头部预测代码，在通常场景中，头部预测也会被快速地执行以进行检测。这里的通常场景指的是没有需要传输的数据，而已接收到的数据包其实是需要下次被接收的数据包，比如，序列号是正在接收的 TCP 所预期的序列号。这时，通过将数据添加到 socket 缓冲区并发送 ACK 类完成该步骤。</p>
<p>接着你会看到实际大小(truesize)与 sk_forward_alloc 的比较语句，用来检查 socket 接收缓冲区中是否有自由空间来添加新的数据包数据。如果有，则“命中”头部预测(预测成功)。然后调用 <strong>__skb_pull</strong> 来移除 TCP 头部。之后，调用 <strong>__skb_queue_tail</strong> 将数据包添加到 socket 接收缓冲区。最终，<strong>__tcp_ack_snd_check</strong> 会被调用以发送 ACK，如果需要的话。通过以上方式，数据包的处理完成。</p>
<p>如果没有足够的自由空间，会执行一个较慢的路线。<strong>tcp_data_queue</strong> 会重新申请缓冲空间并将数据包添加到 socket 缓冲区。这时，如果可能的话，socket 接收缓冲区大大小会被自动增长。与快速路线不同的是，如果可能的话，<strong>tcp_data_snd_check</strong> 会被调用以传输一个新的数据包。最终，<strong>__tcp_ack_snd_check</strong> 会被调用以发送 ACK，如果需要的话。</p>
<p>这两种执行路线的代码规模并不大，这是基于对常见场景的优化实现的。换句话说，这意味着不常见的场景的处理会显著变慢。乱系抵达就是非常见场景的一种。</p>
<h2 id="nic">驱动设备与 NIC 之间如何通信<a class="headerlink" href="#nic" title="Permanent link">&para;</a></h2>
<p>驱动设备与 NIC 之间的通信是网络栈的底层部分，多数人并不关心这一块。然而，NIC 正在执行越来越多的任务以解决性能问题。理解基本的操作模式将有助于你理解额外的技术。</p>
<p>驱动设备与 NIC 之间进行的是 <strong>异步</strong> 通信。首先，驱动设备会请求一个数据包传输调用，然后 CPU 并不等待响应，而是执行另一个任务。然后，NIC 发送数据包并提醒 CPU，驱动设备返回接收到的数据包结果。数据包接收与传输一样，也是异步的。首先，驱动设备数据包接收调用，CPU 则会去指定别的任务。然后，NIC 接收数据包并提醒 CPU，驱动设备会处理接收到的数据包并返回结果。</p>
<p>因此，需要一个地方来保存请求和响应。大多数情况下，NIC 会使用 <strong>环(ring)</strong> 结构体，ring 类似于普通的队列结构，带有固定的条目数量，一个条目保存一个请求或响应数据。这些条目会按顺序依次被使用。固定的数量以及按顺序的复用，因此称此结构为 ring。</p>
<p>下图展示了数据包的传输步骤，你可以看到 ring 是如何被使用的。</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/2017121115130077162560.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>驱动设备从上层接收数据包并穿件 NIC 能够理解的发送描述符。发送描述不默认会包含数据包大小及其内存地址。因为 NIC 需要物理地址来访问内存，驱动设备需要将虚拟地址转换为物理地址。然后，驱动设备将发送描述符添加到 TX ring(1)。TX ring 是一个发送描述符 ring。</p>
<p>接着，驱动设备会通知 NIC 新的请求(2)。驱动设备直接将注册数据写入到指定的 NIC 内存地址。这样，程序化(programmed) IO(PIO) 则成为 CPU 直接将数据发送给驱动设备的传输方法。</p>
<p>被通知的 NIC 从主机内存中获得 TX ring 的发送描述符(3)。由于驱动设备直接访问内存而无需 CPU 的干预，这种访问被称为 Direct Memory Acess(DMA)。</p>
<p>在得到发送描述符之后，NIC 会检测数据包地址、大小，然后从主机内存中得到实际额的数据包(4)。基于无负载校验和(offload checksum)，NIC 会在从内存得到数据包时计算校验和。因此，很少会出现开销。</p>
<p>NIC 发送数据(5) 并将发送的数据包的需要写入到内存(6)。然后，它会发送一个中断(7)。驱动设备读取所发送的数据包的序号，然后返回到目前为止已发送的数据包。</p>
<p>下图展示了接收数据包的步骤。</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171212151300871440622.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>首先，驱动设备会分配主机内存缓冲以接收数据包，然后创建一个接收描述符。接收描述符默认会包含缓存大小及内存地址。像发送描述符一样，它会在接收描述符中保存 DMA 需要使用的物理地址。然后，将接收描述符添加到 TX ring(1)。描述符作为一个接收请求，RX ring 作为一个接收请求 ring。</p>
<p>通过 PIO，驱动设备会通知 NIC 有一个新的描述符(2)。NIC 从 RX ring 中得到新的描述符，并将描述符中的缓冲带下、位置保存到 NIC 内存(3)。</p>
<p>在数据被接收到之后(4)，NIC 会将接收到的数据包发送给主机内存缓冲区(5)。如果存在无负载校验和函数，NIC 会在此刻计算校验和。所接收数据包的实际大小、校验和结果以及其他一些信息会被保存到另一个单独的 ring(6)，即“接收返回 ring”。接收返回 ring 中包含了接收请求处理的结果，比如响应。然后 NIC 发送一个中断(7)。驱动设备从接收返回 ring 中获得数据包信息并处理接收到的数据包。如有必要，它会分配新的内存并重复步骤 (1)、(2)。</p>
<p>为了调优网络栈，很多人指出对 ring 和中断的设置进行调整。当 TX ring 很大时，大量发送请求可以被一次处理完成。当 RX ring 很大时，大量数据包的接收可以被一次处理完成。对于带有较大爆发的数据包传输、接收来说，一个大的 ring 将会有助于负载。在大多数情况下，NIC 会使用一个计时器来减少中断的数量，因为 CPU 可能需要遭受大量处理中断的开销。为了避免主机系统中大量中断的泛滥，中断可以被收集并在发送或接收数据包时定期发送(中断合并)。</p>
<h2 id="_15">栈缓冲区与流控<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<p>流控会在网络栈的多个阶段中执行，下图中展示了用于发送数据的缓冲区。</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/20171212151300998885799.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>首先，一个应用创建数据并将其添加到 socket 发送缓冲区。如果缓冲区中没有自由空间，系统调用则会失败，或者应用线程会发生阻塞。因此，必须使用 socket 缓冲区大小限制来控制数据流入内核的速度。</p>
<p>TCP 创建并通过传输数据队列(qdisc) 将其发送到驱动设备。这是一个典型的 FIFO 队列类型，队列的最大长度是 txqueuelen 的值，该值可以通过 ifconfig 命令来检查。通常它可以承载数千个数据包。</p>
<p>TX ring 介于驱动设备和 NIC 之间。如前面提到的，它被认为是一个传输请求队列。如果队列中没有可用的自由空间，没有传输请求会被创建，数据包也会被累积到传输队列中。如果基类了太多数据包，多余的数据包则会被丢弃。</p>
<p>NIC 将需要发送的数据包保存到内部缓冲。来自该缓冲的数据包速度受物理速度的影响，比如 1 Gb/s 的 NIC 无法提供 10 GB/s 的性能。同时基于以太网的流控，如果 NIC 接收缓冲中没有可用的自由空间，数据包传输将会被停止。</p>
<p>下图展示了接收数据所流经的缓冲。数据包首先被保存到 NIC 的接收缓冲。基于流控的视角，驱动设备与 NIC 之间的 RX ring 被认为是一个数据包 缓冲。驱动设备从 RX ring 获取传入的数据包并将其发送给上层。由于被服务系统使用的 NIC 驱动设备默认使用 NAPI，驱动设备与上层之间没有缓冲。因此，可以认为是上层直接从 RX ring 直接获得数据包。荷载数据被保存的 socket 接收缓冲区。然后应用从 socket 接收缓冲区获取这些数据。</p>
<div align="center"> <img src="https://infi-img.oss-cn-hangzhou.aliyuncs.com/img/2017121215130110417032.png" style="display:block;width:50%;" alt="NAME" align=center /> </div>

<p>不支持 NAPI 的驱动设备会将数据包保存的后备(backlog)队列。然后，NAPI 来获取这些数据包。因此，后备队列可以被看做是上层和驱动设备间的缓冲。</p>
<p>如果内核对数据包的处理速度慢于 NIC 中数据包流的速度， RX ring 会变满。然后 NIC 的缓冲变满。当使用了以太网流控时，NIC 会发送一个请求给传输 NIC 以停止传输，或者丢去数据包。</p>
<p>在 socket 接收缓冲区中不会出现因为空间不足而丢弃数据包，因为 TCP 支持端到端的流控。对于大多数工作而言吞吐量是重中之重，提升 ring 和 socket 缓冲区大小将大有帮助。增加大小能够在快速传输或接收大量数据包时减少因为空间不足引起的错误。</p>
<h2 id="_16">总结<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<p>一开始，我计划仅向大家介绍有助于开发网络程序、执行性能测试、故障排除相关的内容。尽管我有初步计划，但本文件中的描述数量并不小。我希望本文能帮助您开发网络应用程序并监视他们的性能。TCP/IP协议本身很复杂，有很多例外。不过，您不必了解 OS 中 TCP/IP 相关的每一行代码以了解性能并分析这些现象。仅了解它的上下文就会对你很有帮助。</p>
<p>随着系统性能和 OS 网络栈实现的不断进化，最新的服务能够为任意程序提供 10-20 Gb/s 的 TCP 吞吐。这些时间以来，已经有太多性能相关的技术类型，比如 TSO, LRO, RSS, GSO, GRO, UFO, XPS, IOAT, DDIO, TOE，就像字母汤(alphabet soup)，让我们变得困惑。</p>
<p>在下一篇文章中，我将从性能的角度解释网络堆栈，并讨论该技术的问题和影响。</p>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.cubrid.org/blog/understanding-tcp-ip-network-stack">Understanding TCP/IP Network Stack &amp; Writing Network Apps</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../CH03-%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              CH03-调优参数
            </div>
          </div>
        </a>
      
      
        <a href="../CH05-RFC-1180/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              CH05-RFC-1180
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2013 - 2021 Infilos
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/squidfunk" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://github.com/infilow/relax-authentic" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.top", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  <script src="../../assets/javascripts/bundle.3b3ca511.min.js"></script>

  </body>
</html>